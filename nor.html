<!-- NEED TO REMOVE -->
<script>
	console.log('[SSOData.UserAttribute]');

	function dbg(m) {
			console.log("Info: " + m + ".");
	}

	function err(m) {
			console.log("Error: " + m + ".");
	}

	function wrn(m) {
			console.log("Warning: " + m + ".");
	}

	function prp(p) {
			if (typeof(p) === "undefined" || p == null || p == false) return false;
			else return true;
	}
	var global = {
			langauge: "en_US"
	}
</script>

<!-- FUTURE LIBRARIES? -->
<script>
	const arr = {
			removeKey: function(arr, key) {
					var index = arr.indexOf(key);
					arr.splice(index, 1);
					return arr;
			},
			joinByKey: function(arr, brr, akey, bkey, prefix) {
					if (arr.length > 0 && brr.length > 0) {
							var secondaryKeys = Object.keys(brr[0]);
							for (i = 0; i < arr.length; i++) {
									if (arr[i].ReferralId != null && arr[i].ReferralId.length > 0) {
											for (j = 0; j < brr.length; j++) {
													if (arr[i][akey] == brr[j][bkey]) {
															for (k = 0; k < secondaryKeys.length; k++) {
																	arr[i][prefix + secondaryKeys[k]] = brr[j][secondaryKeys[k]];
															}
															break;
													}
													if (j == brr.length - 1) {
															for (k = 0; k < secondaryKeys.length; k++)
																	arr[i][prefix + secondaryKeys[k]] = null;
													}
											}
									} else {
											for (k = 0; k < secondaryKeys.length; k++)
													arr[i][prefix + secondaryKeys[k]] = null;
									}
							}
							return arr;
					} else return false;
			}
	};
	const time = {
			timestamp: function(callback) {
					var xhr = new XMLHttpRequest();
					xhr.withCredentials = true;
					xhr.addEventListener("readystatechange", function() {
							if (this.readyState === 4) {
									if (typeof(callback) === "function") return callback(this.responseText);
									else return this.responseText;
							}
					});
					xhr.open("GET", "https://hpe-rfb.it.hpe.com/resources/rs/custom/onb/timestamp.php");
					xhr.send();
			},
			dhm: function(t) {
					var cd = 24 * 60 * 60 * 1000,
							ch = 60 * 60 * 1000,
							d = Math.floor(t / cd),
							h = Math.floor((t - d * cd) / ch),
							m = Math.round((t - d * cd - h * ch) / 60000),
							pad = function(n) {
									return n < 10 ? '0' + n : n;
							};
					if (m === 60) {
							h++;
							m = 0;
					}
					if (h === 24) {
							d++;
							h = 0;
					}
					return d + " day(s), " + pad(h) + " hr(s), " + pad(m) + " min(s)";
			}
	};
</script>

<!-- RFB API v3 DATA MANAGEMENT -->
<script>
	const bigd = {
			f: {
					done: {
							logic: "and",
							filters: [{
											field: "Submitted",
											operator: "eq",
											value: "Y"
									},
									{
											field: "Status",
											operator: "eq",
											value: "3"
									}
							]
					},
					fail: {
							logic: "and",
							filters: [{
											field: "Submitted",
											operator: "eq",
											value: "Y"
									},
									{
											field: "Status",
											operator: "eq",
											value: "4"
									}
							]
					},
					exst: {
							logic: "and",
							filters: [{
											field: "ContractReviewStatus",
											operator: "eq",
											value: "Declined"
									},
									{
											field: "ContractReviewReason",
											operator: "contains",
											value: "Existing"
									}
							]
					},
					pend: {
							logic: "and",
							filters: [{
											field: "Submitted",
											operator: "eq",
											value: "Y"
									},
									{
											logic: "or",
											filters: [{
															field: "Status",
															operator: "eq",
															value: "1"
													},
													{
															field: "Status",
															operator: "eq",
															value: "2"
													},
													{
															field: "Status",
															operator: "eq",
															value: "4"
													}
											]
									}
							]
					},
					drft: {
							logic: "and",
							filters: [{
									field: "Submitted",
									operator: "neq",
									value: "Y"
							}]
					},
					rept: {
							logic: "or",
							filters: [{
									field: "Status",
									operator: "neq",
									value: "3"
							}]
					}
			},
			q: {
					abac: 0,
					add: function(cb) {
							bigd.q.abac = bigd.q.abac + 1;
							return bigd.q.abac;
					},
					rem: function(cb) {
							bigd.q.abac = bigd.q.abac - 1;
							return bigd.q.abac;
					},
					chk: function(callback) {
							if (bigd.q.abac == 0) return true;
							else return false;
					},
					stop: function(callback) {
							var startLoop = setInterval(function(callback) {
									if (bigd.q.chk()) {
											clearInterval(startLoop);
											callback();
									}
							}, 100, callback);
					}
			},
			r: {
					app: {
							all: function(cb, ...args) {
									bigd.r.custom("nor", "0", applet.user.Email, JSON.stringify(bigd.f.rept), function(d) {
											if (typeof(cb) === "function") return cb(d);
											else return d;
									}, args);
							},
							done: function(cb, ...args) {
									bigd.r.custom("nor", "0", applet.user.Email, JSON.stringify(bigd.f.done), function(d) {
											if (typeof(cb) === "function") return cb(d);
											else return d;
									}, args);
							},
							fail: function(cb, ...args) {
									bigd.r.custom("nor", "0", applet.user.Email, JSON.stringify(bigd.f.fail), function(d) {
											if (typeof(cb) === "function") return cb(d);
											else return d;
									}, args);
							},
							exst: function(cb, ...args) {
									bigd.r.custom("nor", "0", applet.user.Email, JSON.stringify(bigd.f.exst), function(d) {
											if (typeof(cb) === "function") return cb(d);
											else return d;
									}, args);
							},
							pend: function(cb, ...args) {
									bigd.r.custom("nor", "0", applet.user.Email, JSON.stringify(bigd.f.pend), function(d) {
											if (typeof(cb) === "function") return cb(d);
											else return d;
									}, args);
							}
					},
					cnt: {
							all: function(cb, ...args) {
									bigd.r.custom("cnt", "0", applet.user.Email, JSON.stringify({
											field: "EntryId",
											operator: "isnotnull",
											value: ""
									}), function(d) {
											if (typeof(cb) === "function") return cb(d);
											else return d;
									}, args);
							}
					},
					lng: {
							all: function(cb, ...args) {
									bigd.r.custom("lng", "0", applet.user.Email, JSON.stringify({
											field: "EntryId",
											operator: "isnotnull",
											value: ""
									}), function(d) {
											if (typeof(cb) === "function") return cb(d);
											else return d;
									}, args);
							}
					},
					usr: {
							all: function(cb, ...args) {
									bigd.r.custom("usr", "0", applet.user.Email, JSON.stringify({
											field: "Source",
											operator: "eq",
											value: "NOR"
									}), function(d) {
											if (typeof(cb) === "function") return cb(d);
											else return d;
									}, args);
							}
					},
					count: {
							app: {
									all: function(cb, ...args) {
											bigd.r.custom("nor", "0", applet.user.Email, JSON.stringify(bigd.f.rept), function(d) {
													if (typeof(cb) === "function") return cb(d);
													else return d;
											}, args);
									}
							},
							ref: {
									all: function(cb, ...args) {
											bigd.r.custom("nor", "0", applet.user.Email, JSON.stringify(bigd.f.rept), function(d) {
													if (typeof(cb) === "function") return cb(d);
													else return d;
											}, args);
									}
							}
					},
					custom: function(a, b, c, d, cb, ...args) {
							bigd.q.add();
							var response = null;
							var xhr = new XMLHttpRequest();
							xhr.addEventListener("readystatechange", function() {
									if (this.readyState === 4) {
											var response;
											try {
													response = JSON.parse(this.responseText);
											} catch (err) {
													response = this.responseText;
											}
											bigd.q.rem();
											if (typeof(cb) === "function") return cb(response, args);
											else return response;
									}
							});
							xhr.open("POST", "https://hpe-rfb.it.hpe.com/resources/rs/custom/mor/int/data.php?type=" + a + "&page=" + b + "&email=" + c);
							xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
							xhr.send("filter=" + d);
					}
			}
	}
</script>

<!-- USER & GENERAL UI -->
<script>
	const applet = {
			_init: function(callback) {
					mo.fn.overlay.show({
							loading: true,
							close: false
					});
					applet.user = {
							Email: document.querySelector("#sso input[name=Email]").value,
							Name: document.querySelector("#sso input[name=FirstName]").value + ", " + document.querySelector("#sso input[name=LastName]").value
					};
					applet._initUser(function() {
							applet._initAccess(function() {
									if (typeof(callback) === "function") callback();
							});
					});
			},
			_initUser: function(callback) {
					applet._getUserData(applet.user.Email, function(data) {
							if (data.Rows.length == 0)
									mo.fn.modal.show({
											ctaLabel: "OK",
											ctaDisabled: true,
											id: 'request-access-modal',
											title: "User account error",
											content: "<p>You donâ€™t seem to have access.</p><div id='request-access-nbsf'></div>",
											contentCallback: function() {
													const config = {
															dom: document.querySelector("#request-access-nbsf"),
															dataset: {
																	email: '[SSOdata.Email]',
																	justification: '',
															},
															pages: [{
																	title: "",
																	subtitle: "",
																	description: "If you want to request access, please specify the reason and click the Request access button to notify the manager.",
																	nav: true,
																	structure: [{
																			header: "",
																			description: "",
																			group: [
																					[{
																									label: "Email",
																									data: "email",
																									required: true,
																									type: "text",
																									disabled: true,
																									validation: ['minLen|1'],
																							},
																							{
																									label: "Justification/Reason",
																									data: "justification",
																									required: true,
																									type: "textarea",
																									validation: ['minLen|1'],
																							}
																					]
																			]
																	}, ],
																	callback: function() {},
																	validation: function() {
																			var result = {
																					fail: [],
																					pass: []
																			};
																			return result;
																	}
															}],
															onSubmit: function() {
																	document.querySelector("#request-access-nbsf .btn.continue").classList.add('disabled');

																	mail.send({
																			ID: "NOR_RequestAccess",
																			To: "pramod.a@hpe.com",
																			Subject: "NOR Request Access",
																			Col1: this.dataset.email,
																			Big1: this.dataset.justification,
																	}, function() {
																			mo.fn.modal.msg('You successfully requested access. HPEâ€™s manager will review it and make the decision.', 1);
																			document.querySelector("#request-access-nbsf [data-name='justification']").value = '';
																	});
															},
													};
													nbsf.init(config, 0);
													document.querySelector("#request-access-nbsf .btn.continue").innerText = 'Request Access';
													document.querySelector("#request-access-nbsf [data-name='email']").disabled = true;
											},
									});
							else if (data.Rows.length > 1)
									mo.fn.modal.show({
											ctaLabel: "OK",
											title: "User account error",
											content: "<p>Multiple user records matching your account were identified. Please raise a support ticket for further assistance.<br><a href='https://partner.hpe.com'>Go back to PRP</a></p>"
									});
							else {
									data = data.Rows[0];
									applet.user.EntryId = data.EntryId;
									applet.user.UserRole = JSON.parse(data.UserRole);
									applet.user.UserVisits = parseInt(data.UserVisits) || 0;
									applet.user.UserVisits = applet.user.UserVisits + 1;
									try {
											applet.user.UserData = JSON.parse(data.UserData);
									} catch (err) {
											applet.user.UserData = {
													total: 0,
													opened: [],
													updated: 0
											}
									}
									if (applet.user.UserRole.length == 0)
											mo.fn.modal.show({
													ctaLabel: "OK",
													title: "User account error",
													content: "<p>No valid permissions assigned to the user account.<br><a href='https://partner.hpe.com'>Go back to PRP</a></p>"
											});
									else if (typeof(callback) === "function") {
											/*applet._putUserData(applet.user.EntryId,{UserVisits:applet.user.UserVisits,LastLogin:applet.user.LastLogin},function() {
					console.log("User account updated successfully");
				});*/
											callback();
									}
							}
					});
					time.timestamp(function(time) {
							applet.user.LastLogin = time;
					});
			},
			_initAccess: function(callback) {
					if (applet.user.UserRole["ADMIN"]) {
							// ENABLE ALL PERMISSIONS FOR ADMIN
							applet.user.UserRole = {
									"ADMIN": true,
									"USER": true,
									"LANG": true,
									"STAT": true,
									"OPS": {
											"EMEA": true,
											"AMS": true,
											"APJ": true
									},
									"SRP": {
											"EMEA": true,
											"AMS": true,
											"APJ": true
									}
							}
							// ENABLE ACCESS TO ALL FEATURES
							var navLi = document.querySelectorAll("nav li");
							var tiles = document.querySelectorAll("#tiles .tile");
							for (i = 0; i < navLi.length; i++) navLi[i].classList.remove("inactive");
							for (i = 0; i < tiles.length; i++) tiles[i].classList.remove("inactive");
					} else if (applet && applet.user && applet.user.UserRole && !applet.user.UserRole.OPS.AMS && !applet.user.UserRole.OPS.APJ && !applet.user.UserRole.OPS.EMEA && (applet.user.UserRole.SRP.AMS || applet.user.UserRole.SRP.APJ || applet.user.UserRole.SRP.EMEA)) {

							$('body').addClass('srp');
							$('.srp section#nav #icons ul li[icon-id=search]').remove();
							$('.srp section#nav #icons ul li[icon-id=bugs]').remove();
							$('.srp section#nav #burger').remove();
							$('#container').html('<iframe id="norSec" style="height:2000px;width: calc(100% - 4px); overflow: hidden;border: none;display: block;padding-bottom: 90px; background: #fff;" src="https://hpe-rfb.it.hpe.com/form/989/nor-sfdc-sr"></iframe>');
							window.addEventListener("message", (event) => {
									try {
											var rfbmsg = JSON.parse(event.data);
											if (typeof(rfbmsg.h) !== "undefined") {
													var ifrh = rfbmsg.h;
													console.log(ifrh)
													document.getElementById("norSec").setAttribute("style", "height:calc(" + ifrh + "px + 68px);width: calc(100% - 4px); overflow: hidden;border: none;display: block;padding-bottom: 90px; background: #fff;");
											}
									} catch (err) {
											console.error('Error while reading iframe messages', err);
									}
							}, false);
					} else {
							var cur = applet.user.UserRole;
							// OPERATIONS
							if (cur.OPS.EMEA || cur.OPS.APJ || cur.OPS.AMS) {
									document.querySelector("div.tile[section-id=pending]").classList.remove("inactive");
									document.querySelector("div.tile[section-id=closed]").classList.remove("inactive");
									document.querySelector("nav ul li[section-id=pending]").classList.remove("inactive");
									document.querySelector("nav ul li[section-id=closed]").classList.remove("inactive");
							}
							// TO DO SALES REP
							/*if (cur.SRP.EMEA || cur.SRP.APJ || cur.SRP.AMS) {
									document.querySelector("div.tile[section-id=invitations]").classList.remove("inactive");
									document.querySelector("nav ul li[section-id=invitations]").classList.remove("inactive");
							}*/
							// CURRENCY ADMIN
							if (cur.CNT) {
									document.querySelector("div.tile[section-id=countries]").classList.remove("inactive");
									document.querySelector("nav ul li[section-id=countries]").classList.remove("inactive");
							}
							// USER ADMINS
							if (cur.USER) {
									document.querySelector("div.tile[section-id=users]").classList.remove("inactive");
									document.querySelector("nav ul li[section-id=users]").classList.remove("inactive");
							}
							// LOCALIZATION ADMIN
							if (cur.LANG) {
									document.querySelector("div.tile[section-id=localization]").classList.remove("inactive");
									document.querySelector("nav ul li[section-id=localization]").classList.remove("inactive");
							}
							// REPORTING ADMIN
							if (cur.STAT) {
									document.querySelector("div.tile[section-id=reporting]").classList.remove("inactive");
									//document.querySelector("div.tile[section-id=analytics]").classList.remove("inactive");
									document.querySelector("nav ul li[section-id=reporting]").classList.remove("inactive");
									//document.querySelector("nav ul li[section-id=analytics]").classList.remove("inactive");
							}
							// ON BEHALF TILE
							if (cur.SRP.EMEA || cur.SRP.APJ || cur.SRP.AMS) {
									document.querySelector("div.tile[section-id=oob]").classList.remove("inactive");
									document.querySelector("nav ul li[section-id=oob]").classList.remove("inactive");
							}
							// TIBCO ERROR
							if (cur.TIBCOERROR) {
									document.querySelector("div.tile[section-id=tibcoErrors]").classList.remove("inactive");
									document.querySelector("nav ul li[section-id=tibcoErrors]").classList.remove("inactive");
							}
				// ACCOUNT VIEW
							if (cur.ACCOUNTVIEW) {
									document.querySelector("div.tile[section-id=accountView]").classList.remove("inactive");
									document.querySelector("nav ul li[section-id=accountView]").classList.remove("inactive");
							}
					}
					if (typeof(callback) === "function") callback();
			},
			_getUserData: function(email, callback) {
					crud.read("2493", "Email=" + email + "&Source=NOR", function(d) {
							if (typeof(callback) === "function") return callback(d);
							else return d;
					});
			},
			_putUserData: function(id, data, callback) {
					crud.update("3255", id, data, function(d) {
							if (typeof(callback) === "function") return callback(d);
							else return d;
					});
			},
			_updUserStat: function(eid) {
					/*if(applet.user.UserData.opened.indexOf(eid) == -1) {
			applet.user.UserData.opened.push(eid);
		applet.user.UserData.total = applet.user.UserData.opened.length;
			onbd.r.usr.app(function(d) {
			applet.user.UserData.updated = d.Total;
				applet._putUserData(applet.user.EntryId,{UserData:JSON.stringify(applet.user.UserData)},function() {
				console.log("Internal user statistics updated successfully");
			});
		})
	}*/
			},
			_getAuth: function(role) {
					var role = applet.user.UserRole[role.toUpperCase()];
					if (typeof(role) === "boolean") return role;
					else {
							var arr = [];
							for (i = 0; i < Object.keys(role).length; i++)
									if (role[Object.keys(role)[i]])
											arr.push(Object.keys(role)[i]);
							if (arr.length == 0) return false;
							else return arr;
					}
			}
	};
	const ui = {
			dom: {
					burger: document.querySelector("#burger"),
					nav: document.querySelector("nav"),
					logo: document.querySelector("#logo"),
					message: document.querySelector("#message"),
					menu: document.querySelectorAll("*[section-id]:not(.inactive)"),
					icons: document.querySelectorAll('#icons li:not([icon-id="bugs"])'),
					iconsClose: document.querySelectorAll("#icons li span"),
					components: document.querySelectorAll("#container section.wrapper")
			},
			burger: {
					init: function() {
							ui.dom.burger.addEventListener("click", ui.burger.toggle);
					},
					show: function() {
							ui.dom.burger.classList.add("open");
							ui.dom.nav.classList.add("open");
					},
					hide: function() {
							ui.dom.burger.classList.remove("open");
							ui.dom.nav.classList.remove("open");
					},
					toggle: function() {
							if (ui.dom.burger.getAttribute("class") == null || ui.dom.burger.getAttribute("class").indexOf("open") == -1) ui.burger.show();
							else ui.burger.hide();
					},
					escape: function(e) {
							if (e.target.closest("#burger") == null && (e.target.closest("nav") == null || (e.target.closest("nav") != null && e.target.closest("li") != null)))
									ui.burger.hide();
					}
			},
			nav: {
					init: function() {
							ui.dom.menu = document.querySelectorAll("*[section-id]:not(.inactive)");
							for (i = 0; i < ui.dom.menu.length; i++)
									ui.dom.menu[i].addEventListener("click", function(e) {
											var target = e.target.closest("[section-id]").getAttribute("section-id");
											if (document.getElementById(target)) {
													ui.nav.reset();
													document.getElementById(target).classList.add("active");
													ui._component(target);
											}
									});
					},
					reset: function() {
							var wrpEl = document.querySelectorAll("section.screen section.wrapper");
							for (i = 0; i < wrpEl.length; i++) wrpEl[i].classList.remove("active");
					}
			},
			icons: {
					init: function() {
							for (i = 0; i < ui.dom.icons.length; i++)
									ui.dom.icons[i].addEventListener("click", function(e) {
											var target = e.target.closest("[icon-id]").getAttribute("icon-id");
											if (e.srcElement.nodeName != "SPAN" && e.target.closest("span") == null) {
													ui.icons.reset();
													e.target.closest("[icon-id]").classList.add("open");
													document.getElementById(target).classList.add("open");
													ui._component(target);
											}
									});
							for (i = 0; i < ui.dom.iconsClose.length; i++)
									ui.dom.iconsClose[i].addEventListener("click", function(e) {
											e.preventDefault();
											var target = e.target.closest("[icon-id]").getAttribute("icon-id");
											if (e.srcElement.nodeName == "SPAN" || e.target.closest("span") != null) {
													ui.icons.reset();
													document.getElementById(target).classList.remove("open");
											}
									});
					},
					reset: function() {
							for (i = 0; i < ui.dom.icons.length; i++)
									ui.dom.icons[i].classList.remove("open");
					},
					escape: function(e) {
							if (e.target.closest("#profile") == null && (e.target.closest("[icon-id]") == null || e.target.closest("[icon-id]").getAttribute("icon-id") != "profile")) {
									//ui.icons.reset()
									document.querySelector("li[icon-id=profile]").classList.remove("open");
									document.getElementById("profile").classList.remove("open");
							}
							if (e.target.closest("#search") == null && (e.target.closest("[icon-id]") == null || e.target.closest("[icon-id]").getAttribute("icon-id") != "search")) {
									//ui.icons.reset()
									if (document.getElementById("search"))
											document.getElementById("search").classList.remove("open");
							}
					}
			},
			message: {
					open: function(message, state, timer) {
							ui.dom.message.innerHTML = message;
							if (typeof(state) !== "undefined") {
									if (state == 1 || state == "scs" || state == "success")
											ui.dom.message.classList.add("success");
									else if (state == 2 || state == "wrn" || state == "warning")
											ui.dom.message.classList.add("warning");
									else if (state == 3 || state == "err" || state == "error")
											ui.dom.message.classList.add("error");
							}
							ui.dom.message.classList.add("active");
							window.scrollTo({
									top: 0,
									behavior: 'smooth'
							});
							timer = parseInt(timer) || 10;
							ui.message.wait(timer);
					},
					reset: function() {
							var arr = ["active", "success", "warning", "error"];
							for (i = 0; i < arr.length; i++)
									ui.dom.message.classList.remove(arr[i]);
					},
					wait: function(timer) {
							setTimeout(function() {
									ui.message.reset();
							}, timer * 1000);
					},
					escape: function(e) {
							if (e.target.closest("#message") == null)
									ui.message.reset();
					}
			},
			_init: function() {
					ui.burger.init();
					ui.nav.init();
					ui.icons.init();
					ui._logo();
					// DOCUMENT LEVEL EVENTS
					document.addEventListener("click", function(e) {
							ui.burger.escape(e);
							ui.icons.escape(e);
							ui.message.escape(e);
					});
					mo.fn.overlay.hide();
			},
			_dashboard: function() {
					for (i = 0; i < ui.dom.components.length; i++)
							ui.dom.components[i].classList.remove("active");
					if (document.querySelector("#tiles"))
							document.querySelector("#tiles").classList.add("active");
			},
			_logo: function() {
					document.querySelector("#logo").addEventListener("click", ui._dashboard);
			},
			_overview: function() {
					var target = document.querySelector("div[section-id=graph]");
					var totalpending = pending.grid._datasource({
							logic: "and",
							filters: [{
											field: "Submitted",
											operator: "eq",
											value: "Y"
									},
									{
											logic: "or",
											filters: [{
															field: "Status",
															operator: "eq",
															value: "1"
													},
													{
															field: "Status",
															operator: "eq",
															value: "2"
													},
													{
															field: "Status",
															operator: "eq",
															value: "4"
													}
											]
									}
							]
					});
					totalpending.fetch(function() {
							target.querySelector("strong").innerHTML = totalpending.total() + ' Pending';
							target.querySelector("em").innerHTML = 'Pending order requests to be managed by operations';
					});
			},
			_component: function(component) {
					switch (component) {
							case "admin":
									admin._init();
									break;
							case "reporting":
									reporting._init();
									break;
							case "closed": // lol
									closed._init();
									break;
							case "pending":
									pending._init();
									break;
							case "profile":
									profile._init();
									break;
							case "localization":
									localization._init();
									break;
							case "countries":
									countries._init();
									break;
							case "users":
									users._init();
									break;
							case "search":
									search.init();
									break;
							case "caching":
									caching.init();
									break;
							case "demo":
									demoAccounts.init();
									break;
							case "oob":
									oob.init();
									break;
							case "tibcoErrors":
									tibcoErrors.init();
									break;
							case "drafts":
									drafts._init();
									break;
			case "accountView":
									accountView._init();
									break;
			case "inProgress":
									inProgress._init();
									break;
			case "completed":
									completed._init();
									break; 
			case "cancelled":
									cancelled._init();
									break; 
							default:
									console.log("No application component requested");
									break;
					}
			}
	};
	const grid = {
			load: function(selector, datasource, config) {
					// BUILD GRID
					$(selector).kendoGrid({
							dataSource: {
									data: datasource,
									sort: {
											field: "EntryId",
											dir: "desc"
									},
									pageSize: 5
							},
							columns: config,
							dataBound: function(e) {},
							pageable: {
									buttonCount: 4,
									pageSize: 20,
									pageSizes: [5, 10, 20, 50],
									messages: {
											itemsPerPage: ""
									}
							},
							scrollable: true,
							sortable: true,
							filterable: true
					});
			}
	};
</script>

<!-- TIER 1 COMPONENTS -->
<!-- COMPONENT PENDING -->
<script>
	const pending = {
			ready: false,
			data: {},
			_init: function() {
					if (!pending.ready) {
							mo.fn.overlay.show({
									loading: true,
									close: false
							});
							let self = this
							crud.read("3180", "eid=5415", function(d) {
									self.sample = d.Rows[0];
									pending.ui();
									//    pending._getCount();
									pending._loadGrids();
									pending.ready = true;
									mo.fn.overlay.hide();
							});

					}
			},
			ui: function(cb) {
					if (document.querySelector("#pending .tabs") == null)
							document.querySelector("#pending").innerHTML += '<section class="tabs"></div>';
					if (document.querySelector("#pending .container") == null)
							document.querySelector("#pending").innerHTML += '<section class="container"></div>';

					document.querySelector("#pending .tabs").innerHTML += '<span tab-id="ops">In progress (<em>0</em>)</span>';
					document.querySelector("#pending .container").innerHTML += '<section tab-id="ops"><div class="grid"></div><div class="toolbar"></div></section>';
					document.querySelector("#pending .tabs").innerHTML += '<span tab-id="fallout">Fallout (<em>0</em>)</span>';
					document.querySelector("#pending .container").innerHTML += '<section tab-id="fallout"><div class="grid"></div><div class="toolbar"></div></section>';
					// ADD REFRESH
					document.querySelector("#pending").innerHTML += '<span class="refresh"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="refresh" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M20,8 C18.5974037,5.04031171 15.536972,3 12,3 C7.02943725,3 3,7.02943725 3,12 C3,16.9705627 7.02943725,21 12,21 L12,21 C16.9705627,21 21,16.9705627 21,12 M21,3 L21,9 L15,9"></path></svg></span>';
					// ADD TAB ON CLICK
					var tabs = document.querySelectorAll("#pending .tabs span");
					var sections = document.querySelectorAll("#pending .container section");
					for (i = 0; i < tabs.length; i++) {
							tabs[i].addEventListener("click", function(e) {
									// RESET ALL TABS
									for (i = 0; i < tabs.length; i++)
											tabs[i].setAttribute("class", "");
									// RESET ALL SECTIONS
									for (i = 0; i < sections.length; i++)
											sections[i].setAttribute("class", "");
									// ENABLE REQUESTED SECTION
									var cid = e.target.getAttribute("tab-id") || e.target.closest("span").getAttribute("tab-id");
									document.querySelector("#pending span[tab-id=" + cid + "]").classList.add("active");
									document.querySelector("#pending section[tab-id=" + cid + "]").classList.add("active");
									var activeSection = document.querySelector("#pending section[tab-id=" + cid + "]");
									var kendoGrids = activeSection.querySelectorAll(".k-grid");

									kendoGrids.forEach(function(gridElement) {
											var kendoGridInstance = $(gridElement).data("kendoGrid");

											if (kendoGridInstance) {
													kendoGridInstance.resize();
											}
									});

							});
					}
					// DEFAULT TO FIRST TAB
					document.querySelector("#pending .tabs span").click();
					// ADD REFRESH EVENT
					document.querySelector("#pending span.refresh").addEventListener("click", pending._refresh);
					// CALLBACK
					if (typeof(cb) === "function") return cb();
					else return true;
			},
			_getCount: function() {
					var pend = pending.grid._datasource({
							logic: "and",
							filters: [{
											field: "Submitted",
											operator: "eq",
											value: "Y"
									},
									{
											logic: "or",
											filters: [{
															field: "SFDC_Status",
															operator: "neq",
															value: "ERROR"
													},
													{
															field: "SFDC_Status",
															operator: "isempty",
															value: ""
													}
											]
									},
									{
											logic: "or",
											filters: [{
															field: "Status",
															operator: "eq",
															value: "1"
													},
													{
															field: "Status",
															operator: "eq",
															value: "2"
													}
											]
									}
							]
					});
					pend.fetch(function() {
							document.querySelector("#pending .tabs span[tab-id=ops] em").innerText = pend.total();
					});
					var fallout = pending.grid._datasource({
							logic: "and",
							filters: [{
											field: "Submitted",
											operator: "eq",
											value: "Y"
									},
									{
											logic: "or",
											filters: [{
															field: "SFDC_Status",
															operator: "neq",
															value: "ERROR"
													},
													{
															field: "SFDC_Status",
															operator: "isempty",
															value: ""
													}
											]
									},
									{
											logic: "or",
											filters: [{
													field: "Status",
													operator: "eq",
													value: "4"
											}]
									}
							]
					});
					fallout.fetch(function() {
							document.querySelector("#pending .tabs span[tab-id=fallout] em").innerText = fallout.total();
					});
			},
			_refresh: function() {
					mo.fn.overlay.show({
							loading: true,
							close: false
					});
					var grids = document.querySelectorAll("#pending .grid , #pending .toolbar");
					for (i = 0; i < grids.length; i++)
							grids[i].innerHTML = "";
					let self = this
					crud.read("3180", "eid=5415", function(d) {
							self.sample = d.Rows[0];
							//pending.ui();
							//    pending._getCount();
							pending._loadGrids();
							pending.ready = true;
							mo.fn.overlay.hide();
					});
			},
			_loadGrids: function() {
					// KENDO GRID HAS SOME ITERATION IN IT AND IT CONFLICTS WITH I,J,K AS INDEX VARIABLE; USE INDEX AS VARIABLE
					pending.grid._load("#pending section[tab-id=ops] .grid", pending.grid._datasource({
							logic: "and",
							filters: [{
											field: "Submitted",
											operator: "eq",
											value: "Y"
									},
									{
											logic: "or",
											filters: [{
															field: "SFDC_Status",
															operator: "neq",
															value: "ERROR"
													},
													{
															field: "SFDC_Status",
															operator: "isempty",
															value: ""
													}
											]
									},
									{
											logic: "or",
											filters: [{
															field: "Status",
															operator: "eq",
															value: "1"
													},
													{
															field: "Status",
															operator: "eq",
															value: "2"
													}
											]
									}
							]
					}));
					pending.grid._load("#pending section[tab-id=fallout] .grid", pending.grid._datasource({
							logic: "and",
							filters: [{
											field: "Submitted",
											operator: "eq",
											value: "Y"
									},
									{
											logic: "or",
											filters: [{
															field: "SFDC_Status",
															operator: "neq",
															value: "ERROR"
													},
													{
															field: "SFDC_Status",
															operator: "isempty",
															value: ""
													}
											]
									},
									{
											logic: "or",
											filters: [{
													field: "Status",
													operator: "eq",
													value: "4"
											}]
									}
							]
					}));
			},
			_modal: function(data) {
					mo.fn.overlay.show({
							loading: true,
							close: false
					});

					var ctalabel = "OK";
					var modtitle = "Viewing Onboarding request #" + data.EntryId;
					mo.fn.modal.show({
							ctaLabel: ctalabel,
							title: modtitle,
							content: '<div class="nbsf" style="overflow:hidden;padding-bottom:10px;max-width:100%"><div class="tabs"></div><div class="container"></div></div>',
							contentCallback: function() {
									var target = document.querySelector(".dxpModalContent .nbsf");
									var tabs = target.querySelector(".tabs");
									var container = target.querySelector(".container");
									container.innerHTML += '<iframe></iframe>';
									container.innerHTML += '<style>html .dxpModal {height: 100vh;box-sizing: border-box;width: 1200px!important;max-width: none!important;}.dxpModal .dxpModalFooter {display:none!important;}.dxpModal iframe {width:100%;height:100%;border:0;}html .dxpModal .dxpModalContainer,html .dxpModal .dxpModalContainer .dxpModalContent, html .dxpModal .dxpModalContainer .dxpModalContent .nbsf {height:100%;margin-bottom:0;padding-bottom:0;}</style>';
									container.querySelector("iframe").setAttribute("src", "https://hpe-rfb.it.hpe.com/form/681/072267d4-1434-420c-b241-1f366816ddcf?EntryId=" + data.EntryId);

									//// FUNCTIONALITY
									// TABS
									var allt = tabs.querySelectorAll("span");
									var allc = container.querySelectorAll("div[tab-id]");

									function hideAll() {
											for (i = 0; i < allt.length; i++)
													allt[i].setAttribute("class", "");
											for (i = 0; i < allc.length; i++)
													allc[i].setAttribute("class", "");
									}
									for (i = 0; i < allt.length; i++) {
											allt[i].addEventListener("click", function(e) {
													var tabid = e.target.getAttribute("tab-id");
													hideAll();
													e.target.classList.add("active");
													container.querySelector("div[tab-id=" + tabid + "]").classList.add("active");
											});
									}
									// TOGGLES
									var alltog = container.querySelectorAll("div.toggle");
									for (i = 0; i < alltog.length; i++) {
											alltog[i].addEventListener("click", function(e) {
													var el = e.target.closest("label");
													el.classList.toggle("active");
													if (el.getAttribute("class") == "active") el.querySelector("input").value = "Y";
													else el.querySelector("input").value = "N";
											});
									}

									//// CLOSE MODAL
									mo.fn.overlay.show({
											close: false
									})
							},
							ctaCallback: function() {
									// HELPERS
									var sel = document.querySelector(".dxpModalContent");
							}
					});
			},
			grid: {
					_custom: function() {
							var cusConfig = [{
											field: "EntryId",
											title: "ID",
											filterable: true,
											width: "85px",
											locked: true
									},
									{
											title: "",
											width: "60px",
											attributes: {
													"class": "cta"
											},
											locked: true,
											template: function(d) {
													//var icons = '<a class="clone"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="clone"><path fill="none" stroke="#666" stroke-width="2" d="M9,15 L17,15 L9,15 Z M9,11 L19,11 L9,11 Z M9,7 L13,7 L9,7 Z M16,1 L16,7 L22,7 M6,5 L2,5 L2,23 L18,23 L18,19 M22,19 L6,19 L6,1 L17,1 L22,6 L22,19 L22,19 Z"></path></svg></a>';
													//icons += '<a class="edit"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="copy"><path fill="none" stroke="#666" stroke-width="2" d="M14,4 L20,10 L14,4 Z M22.2942268,5.29422684 C22.6840146,5.68401459 22.6812861,6.3187139 22.2864907,6.71350932 L9,20 L2,22 L4,15 L17.2864907,1.71350932 C17.680551,1.319449 18.3127724,1.31277239 18.7057732,1.70577316 L22.2942268,5.29422684 Z M3,19 L5,21 M7,17 L15,9"></path></svg></a>';
													//var icons = '<a class="task"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="task"><path fill="none" stroke="#666" stroke-width="2" d="M12,20 L24,20 M12,12 L24,12 M12,4 L24,4 M1,19 L4,22 L9,17 M1,11 L4,14 L9,9 M9,1 L4,6 L1,3"></path></svg></a>';
													var icons = `<a class="sfdc" style="display: none;">
							<svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="ticket" width="24px" height="24px">
								<path fill="none" stroke="#666" stroke-width="2" d="M7,16 L17,16 L17,8 L7,8 L7,16 Z M20,12 C20,14 21,15 23,15 L23,20 L1,20 L1,15 C3,15 4,14 4,12 C4,10 3,9 1,9 L1,4 L23,4 L23,9 C21,9 20,10 20,12 Z">
								</path>
							</svg>
						</a>
						<a class="view"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path></a>`;
													return icons;
											}
									},
									{
											field: "PO_BackgroundGroup",
											title: "BG",
											filterable: true,
											width: 90,
											locked: false
									},
									{
											field: "Region",
											title: "Region",
											filterable: true,
											width: 115,
											locked: false
									},
									{
											field: "Geo",
											title: "Geo",
											filterable: true,
											width: 115,
									},
									{
											field: "SoldTo_Address_Country",
											title: "Country",
											filterable: true,
											width: 125,
									},
									{
											field: "SoldTo_CompanyName",
											title: "SoldTo CompanyName",
											filterable: true,
											width: 215,
									},
									{
											field: "PartyId",
											title: "PartyId",
											filterable: true,
											width: 115,


									},
									{
											field: "PO_Number",
											title: "PO",
											filterable: true,
											width: 115,
									},
									/*{
											field: "PO_Value",
											title: "Value",
											filterable: false,
											template: function(d) {
													return d.PO_Value + " " + d.PO_Currency;
											}
									},*/
									{
											field: "SubmittedTimestamp",
											title: "Date",
											filterable: false,
											width: 100,
											template: function(d) {
													try {
															return d.SubmittedTimestamp.split("T")[0];
													} catch (err) {
															return d.SubmittedTimestamp;
													}
											}
									},
									{
											field: "SubmitterEmail",
											title: "Submitter",
											filterable: true,
											width: 255
									},
									{
											field: "CaseNumber",
											title: "Case Number",
											filterable: true,
											width: 155,
									},
							];
							return cusConfig;
					},
					_default: function() {
							var defConfig = [];
							if (pending.data.length > 0)
									for (i = 0; i < Object.keys(pending.data[0]).length; i++) {
											var key = Object.keys(pending.data[0])[i];
											var obj = {};
											obj.field = key;
											obj.title = key;
											obj.hidden = true;
											defConfig.push(obj);
									}
							return defConfig;
					},
					_config: function() {
							var cusConfig = pending.grid._custom();
							var defConfig = pending.grid._default();
							for (j = cusConfig.length - 1; j >= 0; j--) {
									for (i = 0; i < defConfig.length; i++) {
											if (defConfig[i].field == cusConfig[j].field) {
													defConfig.splice(i, 1);
													break;
											}
									}
							}
							for (i = cusConfig.length - 1; i >= 0; i--) {
									defConfig.unshift(cusConfig[i]);
							}
							return defConfig;
					},
					_load: function(selector, datasource) {
							var parent = document.querySelector(selector.split(" .grid")[0]);
							let config = this._config();
							$(selector).kendoGrid({
									toolbar: [{
											name: "excel",
											text: "Download"
									}],
									excel: {
											fileName: "Onboarding_Pending_" + parent.getAttribute("tab-id") + "_" + new Date().getTime() + ".xlsx",
											filterable: true,
											allPages: true
									},
									dataSource: datasource,
									columns: config,
									dataBound: function(e) {
											document.querySelector("#pending .tabs span[tab-id=" + parent.getAttribute("tab-id") + "] em").innerText = this.dataSource.total();
									},
									pageable: {
											buttonCount: 4,
											pageSize: 10,
											pageSizes: [10, 25, 50, 100],
											messages: {
													itemsPerPage: ""
											}
									},
									scrollable: true,
									sortable: true,
									filterable: true
							});
							$(selector).delegate(".view", "click", function(e) {
									var grid = $(selector).data("kendoGrid");
									var row = grid.dataItem($(this).closest("tr"));
									review._init(row.EntryId);
							});
							$(selector).delegate(".sfdc", "click", function(e) {
									var grid = $(selector).data("kendoGrid");
									var row = grid.dataItem($(this).closest("tr"));
									sfdc.init(row.EntryId);
							});
							$(selector + ' .k-grid-toolbar').appendTo(selector.split(" .grid")[0] + ' .toolbar');
							var exportFlag = false;
							$(selector).data("kendoGrid").bind("excelExport", function(e) {
									if (!exportFlag) {
											e.preventDefault();
											exportFlag = true;
											mo.fn.overlay.show({
													loading: true,
													close: false
											});
											setTimeout(function() {
													e.sender.saveAsExcel();
											}, 1500);
									} else {
											exportFlag = false;
											setTimeout(function() {
													mo.fn.overlay.hide();
											}, 500);
									}
							});
					},
					_datasource: function(filter) {
							return new kendo.data.DataSource({
									type: "rfb-v2",
									transport: {
											read: {
													//   url: "/form/data-set-provider/v2/989/NOR_Full/kendo/data"
													url: "/form/data-set-provider/v2/989/NOR_Data_List/kendo/data"
											}
									},
									schema: {
											model: {
													id: "EntryId",
											}
									},
									filter: filter,
									serverPaging: true,
									pageSize: 10,
									serverFiltering: true,
									serverSorting: true,
							});
					}
			}
	}
</script>
<!-- COMPONENT REVIEW -->
<script>
	const review = {
			ready: false,
			data: {},
			_init: function(eid, legacy) {
					review.data = {
							app: {},
							ref: {},
							his: {}
					};
					review._getData(eid, legacy, function() {
							mo.fn.overlay.show({
									loading: true,
									close: false
							});
							review.ui._init();
							review.ready = true;
					});
					// UPDATE USER ANALYTICS
					//applet._updUserStat(eid);
			},
			ui: {
					_init: function() {
							review.ui._dom();
							review.ui._events();
							fullscreen.classList.add("active");
					},
					_dom: function() {
							var fullscreen = document.querySelector("#fullscreen");
							//// RESET INNER HTML
							fullscreen.innerHTML = '<h1><span>Reviewing order request no. ' + review.data.EntryId + '</span><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="close" width="24px" height="24px" class="close"><path fill="none" stroke="#666" stroke-width="2" d="M3,3 L21,21 M3,21 L21,3" class="close"></path></svg></h1>';
							fullscreen.innerHTML += '<div class="timeline"><p class="na">Order request not yet submitted</p></div>';
							fullscreen.innerHTML += '<div class="container"><div class="tabs"></div></div><div class="history"></div><div class="cfix"></div>';
							//// ADD TABS
							var cont = fullscreen.querySelector(".container");
							var tabs = fullscreen.querySelector(".tabs");

							var tabsHTML = "";
							var contHTML = "";

							tabsHTML += '<span tab-id="app" class="active">Details</span>';
							contHTML += '<section tab-id="app" class="active"></section>';

							tabsHTML += '<span tab-id="tasks">Tasks</span>';
							contHTML += '<section tab-id="tasks"></section>';

							tabs.innerHTML = tabsHTML;
							cont.innerHTML += contHTML;

							// RUN DATA COMPONENTS
							review.ui._timeline();
							review.ui._history();
							review.ui._application();
							review.ui._tasks();
					},
					_application: function() {
							var selector = document.querySelector("#fullscreen .container section[tab-id=app]");

							// DATASET TO DISPLAY
							var config = [{
											title: "System information",
											data: [{
															ttl: "Request ID",
															col: "EntryId"
													},
													{
															ttl: "Submitter Email",
															col: "Email"
													},
													{
															ttl: "Submitter First name",
															col: "FirstName"
													},
													{
															ttl: "Submitter Last name",
															col: "LastName"
													},
													{
															ttl: "PartnerProId",
															col: "PartnerProId"
													},
													{
															ttl: "PartyId",
															col: "PartyId"
													},
													{
															ttl: "Agreements",
															col: "AgreementNos"
													},
													{
															ttl: "Submitted at",
															col: "SubmittedTimestamp"
													},
													{
															ttl: "Created at",
															col: "Created"
													}
											]
									},
									{
											title: "Order information",
											data: [{
															ttl: "Select the Type of product your ordering",
															col: "PO_BackgroundGroup"
													},
													{
															ttl: "HPE Entity",
															col: "PO_HPEEntity"
													},
													{
															ttl: "Purchase order",
															col: "PO_Number"
													},
													{
															ttl: "Currency",
															col: "PO_Currency"
													},
													{
															ttl: "Value",
															col: "PO_Value"
													},
													{
															ttl: "Business Model",
															col: "PO_BusinessModel"
													},
													{
															ttl: "PO Category",
															col: "PO_Category"
													},
													{
															ttl: "Delivery Date",
															col: "PO_DeliveryDate"
													},
													{
															ttl: "Delivery incoterms",
															col: "PO_DeliveryIncoterms"
													},
													{
															ttl: "Purchase agreement",
															col: "PA_Number"
													},
													{
															ttl: "Payment terms",
															col: "Payment_Terms"
													},
													{
															ttl: "Reseller PO",
															col: "Rs_PO_Number"
													},
													{
															ttl: "End customer PO",
															col: "Cx_PO_Number"
													},
													{
															ttl: "Are you ordering an as-a-service (aaS) order ?",
															col: "Config_aaS"
													},
													{
															ttl: "Quote",
															col: "Requestor_PO_Quote_ID"
													},
													{
															ttl: "UCID",
															col: "Config_UCID"
													},
													{
															ttl: "UCID Quantity",
															col: "Config_UCIDQ"
													},
													{
															ttl: "UCID Config",
															col: "Config_ConfigId"
													},
													{
															ttl: "Deal",
															col: "Requestor_PO_Deal_ID"
													},
													{
															ttl: "Opportunity ID",
															col: "Requestor_PO_Opp_ID"
													},
													{
															ttl: "Complete delivery",
															col: "PO_CompleteDelivery"
													},
													{
															ttl: "Carbon copy",
															col: "Notification_CC"
													}
											]
									},
									{
											title: "Configuration",
											data: [{
															ttl: "Sold to on PO",
															col: "Config_SoldToDetails"
													},
													{
															ttl: "Sold to contact",
															col: "Config_SoldToDetails_Contact"
													},
													{
															ttl: "Bill to contact",
															col: "Config_BillToDetails"
													}
											]
									},
									{
											title: "Configuration (Non-Stock orders)",
											data: [{
															ttl: "Shipping address",
															col: "Config_ShipToDetails"
													},
													{
															ttl: "Shipping contact",
															col: "Config_ShipToDetails_Contact"
													},
													{
															ttl: "Bill to contact",
															col: "Config_BillToDetails"
													},
													{
															ttl: "Reseller address",
															col: "Config_ResellerDetails"
													},
													{
															ttl: "Reseller contact",
															col: "Config_ResellerDetails_Contact"
													},
													{
															ttl: "End customer address",
															col: "Config_EndCxDetails"
													},
													{
															ttl: "End customer contact",
															col: "Config_EndCxDetails_Contact"
													}
											]
									},
									{
											title: "Configuration (India Requirement)",
											data: [{
															ttl: "Is your total NGQ value/Tier 1 PO value â‰¤ the End customer value ?",
															col: "Config_Tier1"
													},
													{
															ttl: "Business Justification",
															col: "Config_Business_Justification"
													},
													{
															ttl: "Is your order having only one Tier 2 partner ? (In case of multiple Tier 2 partners in the deal please attach R2R approval in the following page)",
															col: "Config_Tier2"
													},
													{
															ttl: "Shipment within India ?",
															col: "Config_Shipment_India"
													},
													{
															ttl: "Is your end customer company an OEM ? (If not please attach SOT approval in the following page)",
															col: "Config_OEM"
													}
											]
									},
									{
											title: "Configuration (Stock orders)",
											data: [{
															ttl: "Asset location",
															col: "Config_LocationDetails"
													},
													{
															ttl: "Entitled party",
															col: "Config_EntitledDetails"
													}
											]
									},
									// SOLD TO CONTACT INFORMATION
									{
											title: "Sold to contact information",
											data: [{
															ttl: "Sold to contact configuration",
															col: "Config_SoldToDetails_Contact"
													},
													{
															ttl: "First name",
															col: "SoldTo_Contact_FirstName"
													},
													{
															ttl: "Last name / Surname",
															col: "SoldTo_Contact_LastName"
													},
													{
															ttl: "Phone",
															col: "SoldTo_Contact_Phone"
													},
													{
															ttl: "Email",
															col: "SoldTo_Contact_Email"
													},
													{
															ttl: "Country",
															col: "SoldTo_Contact_Country"
													}
											]
									},
									// SOLD TO ADDRESS INFORMATION
									{
											title: "Sold to address information",
											data: [{
															ttl: "Sold to configuration",
															col: "SoldTo_SoldToDetails"
													},
													{
															ttl: "Party Id",
															col: "SoldTo_PartyId"
													},
													{
															ttl: "Company name",
															col: "SoldTo_CompanyName"
													},
													{
															ttl: "Address",
															col: "SoldTo_Address_Street"
													},
													{
															ttl: "Address line 2 (optional)",
															col: "SoldTo_Address_Street2"
													},
													{
															ttl: "City",
															col: "SoldTo_Address_City"
													},
													{
															ttl: "State or province",
															col: "SoldTo_Address_State"
													},
													{
															ttl: "Postal code",
															col: "SoldTo_Address_Postal"
													},
													{
															ttl: "Country",
															col: "SoldTo_Address_Country"
													},
													{
															ttl: "Tax ID",
															col: "SoldTo_NationalID"
													}
											]
									},
									// PAYER INFORMATION
									{
											title: "Payer contact information",
											data: [{
															ttl: "Payer configuration",
															col: "Config_PayerDetails"
													},
													{
															ttl: "First name",
															col: "Payer_Contact_FirstName"
													},
													{
															ttl: "Last name / Surname",
															col: "Payer_Contact_LastName"
													},
													{
															ttl: "Phone",
															col: "Payer_Contact_Phone"
													},
													{
															ttl: "Email",
															col: "Payer_Contact_Email"
													},
													{
															ttl: "Country of residence",
															col: "Payer_Contact_Country"
													}
											]
									},
									{
											title: "Payer address information",
											data: [{
															ttl: "Payer configuration",
															col: "Config_PayerDetails"
													},
													{
															ttl: "Party Id",
															col: "Payer_PartyId"
													},
													{
															ttl: "Company name",
															col: "Payer_CompanyName"
													},
													{
															ttl: "Address",
															col: "Payer_Address_Street"
													},
													{
															ttl: "Address line 2 (optional)",
															col: "Payer_Address_Street2"
													},
													{
															ttl: "City",
															col: "Payer_Address_City"
													},
													{
															ttl: "State or province",
															col: "Payer_Address_State"
													},
													{
															ttl: "Postal code",
															col: "Payer_Address_Postal"
													},
													{
															ttl: "Country",
															col: "Payer_Address_Country"
													}
											]
									},
									// BILLING INFORMATION
									{
											title: "Billing contact information",
											data: [{
															ttl: "Billing configuration",
															col: "Config_BillToDetails"
													},
													{
															ttl: "First name",
															col: "BillTo_Contact_FirstName"
													},
													{
															ttl: "Last name / Surname",
															col: "BillTo_Contact_LastName"
													},
													{
															ttl: "Phone",
															col: "BillTo_Contact_Phone"
													},
													{
															ttl: "Email",
															col: "BillTo_Contact_Email"
													},
													{
															ttl: "Country of residence",
															col: "BillTo_Contact_Country"
													}
											]
									},
									{
											title: "Billing address information",
											data: [{
															ttl: "Billing configuration",
															col: "Config_BillToDetails"
													},
													{
															ttl: "Party Id",
															col: "BillTo_PartyId"
													},
													{
															ttl: "Company name",
															col: "BillTo_CompanyName"
													},
													{
															ttl: "Address",
															col: "BillTo_Address_Street"
													},
													{
															ttl: "Address line 2 (optional)",
															col: "BillTo_Address_Street2"
													},
													{
															ttl: "City",
															col: "BillTo_Address_City"
													},
													{
															ttl: "State or province",
															col: "BillTo_Address_State"
													},
													{
															ttl: "Postal code",
															col: "BillTo_Address_Postal"
													},
													{
															ttl: "Country",
															col: "BillTo_Address_Country"
													}
											]
									},
									// SHIPPING INFORMATION
									{
											title: "Shipping contact information",
											data: [{
															ttl: "Shipping contact configuration",
															col: "Config_ShipToDetails_Contact"
													},
													{
															ttl: "First name",
															col: "ShipTo_Contact_FirstName"
													},
													{
															ttl: "Last name / Surname",
															col: "ShipTo_Contact_LastName"
													},
													{
															ttl: "Phone",
															col: "ShipTo_Contact_Phone"
													},
													{
															ttl: "Email",
															col: "ShipTo_Contact_Email"
													},
													{
															ttl: "Country of residence",
															col: "ShipTo_Contact_Country"
													}
											]
									},
									{
											title: "Shipping address information",
											data: [{
															ttl: "Shipping party configuration",
															col: "Config_ShipToDetails"
													},
													{
															ttl: "Party Id",
															col: "ShipTo_PartyId"
													},
													{
															ttl: "Company name",
															col: "ShipTo_CompanyName"
													},
													{
															ttl: "Address",
															col: "ShipTo_Address_Street"
													},
													{
															ttl: "Address line 2 (optional)",
															col: "ShipTo_Address_Street2"
													},
													{
															ttl: "City",
															col: "ShipTo_Address_City"
													},
													{
															ttl: "State or province",
															col: "ShipTo_Address_State"
													},
													{
															ttl: "Postal code",
															col: "ShipTo_Address_Postal"
													},
													{
															ttl: "Country",
															col: "ShipTo_Address_Country"
													},
													{
															ttl: "Tax ID",
															col: "ShipTo_NationalID"
													}
											]
									},
									// RESELLER INFORMATION
									{
											title: "Reseller contact information",
											data: [{
															ttl: "Reseller contact configuration",
															col: "Config_ResellerDetails_Contact"
													},
													{
															ttl: "First name",
															col: "Reseller_Contact_FirstName"
													},
													{
															ttl: "Last name / Surname",
															col: "Reseller_Contact_LastName"
													},
													{
															ttl: "Phone",
															col: "Reseller_Contact_Phone"
													},
													{
															ttl: "Email",
															col: "Reseller_Contact_Email"
													},
													{
															ttl: "Country of residence",
															col: "Reseller_Contact_Country"
													}
											]
									},
									{
											title: "Reseller party information",
											data: [{
															ttl: "Reseller party configuration",
															col: "Config_ResellerDetails"
													},
													{
															ttl: "Party Id",
															col: "Reseller_PartyId"
													},
													{
															ttl: "Company name",
															col: "Reseller_CompanyName"
													},
													{
															ttl: "Address",
															col: "Reseller_Address_Street"
													},
													{
															ttl: "Address line 2 (optional)",
															col: "Reseller_Address_Street2"
													},
													{
															ttl: "City",
															col: "Reseller_Address_City"
													},
													{
															ttl: "State or province",
															col: "Reseller_Address_State"
													},
													{
															ttl: "Postal code",
															col: "Reseller_Address_Postal"
													},
													{
															ttl: "Country",
															col: "Reseller_Address_Country"
													},
													{
															ttl: "Tax ID",
															col: "Reseller_NationalID"
													}
											]
									},
									// CUSTOMER INFORMATION
									{
											title: "End Customer contact information",
											data: [{
															ttl: "Customer contact configuration",
															col: "Config_EndCxDetails_Contact"
													},
													{
															ttl: "First name",
															col: "EndCx_Contact_FirstName"
													},
													{
															ttl: "Last name / Surname",
															col: "EndCx_Contact_LastName"
													},
													{
															ttl: "Phone",
															col: "EndCx_Contact_Phone"
													},
													{
															ttl: "Email",
															col: "EndCx_Contact_Email"
													},
													{
															ttl: "Country of residence",
															col: "EndCx_Contact_Country"
													}
											]
									},
									{
											title: "End Customer address information",
											data: [{
															ttl: "Customer party configuration",
															col: "Config_EndCxDetails"
													},
													{
															ttl: "Party Id",
															col: "EndCx_PartyId"
													},
													{
															ttl: "Company name",
															col: "EndCx_CompanyName"
													},
													{
															ttl: "Address",
															col: "EndCx_Address_Street"
													},
													{
															ttl: "Address line 2 (optional)",
															col: "EndCx_Address_Street2"
													},
													{
															ttl: "City",
															col: "EndCx_Address_City"
													},
													{
															ttl: "State or province",
															col: "EndCx_Address_State"
													},
													{
															ttl: "Postal code",
															col: "EndCx_Address_Postal"
													},
													{
															ttl: "Country",
															col: "EndCx_Address_Country"
													},
													{
															ttl: "Tax ID",
															col: "EndCx_NationalID"
													}
											]
									},
									//Customs Ship to party Address information
									{
											title: "Customs Ship to party",
											data: [{
															ttl: "Party Id",
															col: "CustomShipTo_PartyId"
													},
													{
															ttl: "Company name",
															col: "CustomShipTo_CompanyName"
													},
													{
															ttl: "Address",
															col: "CustomShipTo_Address"
													},
													{
															ttl: "Address line 2 (optional)",
															col: "CustomShipTo_Address_Street2"
													},
													{
															ttl: "City",
															col: "CustomShipTo_Address_City"
													},
													{
															ttl: "State or province",
															col: "CustomShipTo_Address_State"
													},
													{
															ttl: "Postal code",
															col: "CustomShipTo_Address_Postal"
													},
													{
															ttl: "Country",
															col: "CustomShipTo_Address_Country"
													}
											]
									},
									//Agent Program Address information
									{
											title: "Agent Program",
											data: [{
															ttl: "Party Id",
															col: "AgentProgram_PartyId"
													},
													{
															ttl: "Company name",
															col: "AgentProgram_CompanyName"
													},
													{
															ttl: "Address",
															col: "AgentProgram_Address"
													},
													{
															ttl: "Address line 2 (optional)",
															col: "AgentProgram_Address_Street2"
													},
													{
															ttl: "City",
															col: "AgentProgram_Address_City"
													},
													{
															ttl: "State or province",
															col: "AgentProgram_Address_State"
													},
													{
															ttl: "Postal code",
															col: "AgentProgram_Address_Postal"
													},
													{
															ttl: "Country",
															col: "AgentProgram_Address_Country"
													}
											]
									},
									// SYSTEM MANAGER
									{
											title: "System manager information",
											data: [{
															ttl: "Same as end customer contact?",
															col: "Config_SystemManager"
													},
													{
															ttl: "First name",
															col: "EndCx_SysMng_FirstName"
													},
													{
															ttl: "Last name / Surname",
															col: "EndCx_SysMng_LastName"
													},
													{
															ttl: "Phone",
															col: "EndCx_SysMng_Phone"
													},
													{
															ttl: "Email",
															col: "EndCx_SysMng_Email"
													},
													{
															ttl: "Country of residence",
															col: "EndCx_SysMng_Country"
													}
											]
									},
									// Prefered Service Provider
									{
											title: "Prefered Service Provider information",
											data: [{
															ttl: "Do you have a Preferred Service Provider (PSP)?",
															col: "Config_PSP"
													},
													{
															ttl: "Party Id",
															col: "PSP_PartyId"
													},
													{
															ttl: "Company name",
															col: "PSP_CompanyName"
													},
													{
															ttl: "Address",
															col: "PSP_Address_Street"
													},
													{
															ttl: "Address line 2 (optional)",
															col: "PSP_Address_Street2"
													},
													{
															ttl: "City",
															col: "PSP_Address_City"
													},
													{
															ttl: "State or province",
															col: "PSP_Address_State"
													},
													{
															ttl: "Postal code",
															col: "PSP_Address_Postal"
													},
													{
															ttl: "Country",
															col: "PSP_Address_Country"
													}
											]
									},
									// ASSET LOCATION
									{
											title: "Asset location company",
											data: [{
															ttl: "Asset location configuration",
															col: "Config_LocationDetails"
													},
													{
															ttl: "Party Id",
															col: "AssLoc_PartyId"
													},
													{
															ttl: "Company name",
															col: "AssLoc_CompanyName"
													},
													{
															ttl: "Address",
															col: "AssLoc_Address_Street"
													},
													{
															ttl: "Address line 2 (optional)",
															col: "AssLoc_Address_Street2"
													},
													{
															ttl: "City",
															col: "AssLoc_Address_City"
													},
													{
															ttl: "State or province",
															col: "AssLoc_Address_State"
													},
													{
															ttl: "Postal code",
															col: "AssLoc_Address_Postal"
													},
													{
															ttl: "Country",
															col: "AssLoc_Address_Country"
													}
											]
									},
									// ENTITLED PARTY
									{
											title: "Entitled party contact information",
											data: [{
															ttl: "Entitled party configuration",
															col: "Config_EntitledDetails"
													},
													{
															ttl: "First name",
															col: "EntPrty_Contact_FirstName"
													},
													{
															ttl: "Last name / Surname",
															col: "EntPrty_Contact_LastName"
													},
													{
															ttl: "Phone",
															col: "EntPrty_Contact_Phone"
													},
													{
															ttl: "Email",
															col: "EntPrty_Contact_Email"
													},
													{
															ttl: "Country of residence",
															col: "EntPrty_Contact_Country"
													}
											]
									},
									{
											title: "Entitled party information",
											data: [{
															ttl: "Entitled party configuration",
															col: "Config_EntitledDetails"
													},
													{
															ttl: "Party Id",
															col: "EntPrty_PartyId"
													},
													{
															ttl: "Company name",
															col: "EntPrty_CompanyName"
													},
													{
															ttl: "Address",
															col: "EntPrty_Address_Street"
													},
													{
															ttl: "Address line 2 (optional)",
															col: "EntPrty_Address_Street2"
													},
													{
															ttl: "City",
															col: "EntPrty_Address_City"
													},
													{
															ttl: "State or province",
															col: "EntPrty_Address_State"
													},
													{
															ttl: "Postal code",
															col: "EntPrty_Address_Postal"
													},
													{
															ttl: "Country",
															col: "EntPrty_Address_Country"
													}
											]
									},
									// OPTIONAL PRODUCT & REMARKETING
									{
											title: "Optional, Product, Remarketing",
											data: [{
															ttl: "Optional attachment",
															col: "Optional_Attachment"
													},
													{
															ttl: "Reservation ID",
															col: "Config_ResId"
													},
													{
															ttl: "Label order ID",
															col: "Config_LOID"
													},
													{
															ttl: "Logistics codes",
															col: "Config_LogCode"
													},
													{
															ttl: "Do you belong to Public sector entity?",
															col: "Config_PublicSectionPartner"
													},
													{
															ttl: "CIG",
															col: "Config_CIG"
													},
													{
															ttl: "CUP",
															col: "Config_CUP"
													},
													{
															ttl: "Ordering Care Pack, Installation services or Software licenses?",
															col: "Config_PI"
													}
											]
									},
									// COMMENTS
									{
											title: "Submitter comments",
											data: [{
															ttl: "Tax details",
															col: "Comment_Tax"
													},
													{
															ttl: "Invoice comments",
															col: "Comment_Invoice"
													},
													{
															ttl: "Delivery comments",
															col: "Comment_Delivery"
													},
													{
															ttl: "Packing list comments",
															col: "Comment_Packing"
													},
													{
															ttl: "Additional comments",
															col: "Comment_Extra"
													}
											]
									}
							];

							var region = review.data["Region"];
							var subregion = review.data["SubRegion"];
							var geo = "";
							if (review.data["Geo"] == null)
									geo = review.data["SubRegion"];
							else
							if (review.data["Geo"] != "")
									geo = review.data["Geo"];
							else
									geo = review.data["SubRegion"];

							var country = "";
							if (review.data["SoldTo_Address_Country"] == "India")
									country = review.data["SoldTo_Address_Country"];
							else {
									crud.read("2601", false, function(d) {
											for (i = 0; i < d.Rows.length; i++) {
													if (d.Rows[i].Country_ISO2 == review.data.Country_Code) {
															country = d.Rows[i].Country;
															break;
													}
											}
									});
							}
							if (country == "")
									country = review.data["SoldTo_Address_Country"];

							// ADD DATA TO PAGE
							for (i = 0; i < config.length; i++) {
									//console.log("config # :" + i + " config title : " + config[i].title);
									selector.innerHTML += '<div class="row collapsed"><h4>' + config[i].title + '<div class="drop"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="down" width="24px" height="24px"><polyline fill="none" stroke="#666" stroke-width="2" points="7.086 3.174 17.086 13.174 7.086 23.174" transform="scale(1 -1) rotate(-89 -1.32 0)"></polyline></svg></div></h4></div>';
									var row = selector.querySelectorAll(".row")[i];
									for (j = 0; j < config[i].data.length; j++) {
											var val = "N/A";
											if (typeof(review.data[config[i].data[j].col]) !== "undefined" && review.data[config[i].data[j].col] != null && review.data[config[i].data[j].col].toString().length > 0 && review.data[config[i].data[j].col] != "Select one") val = review.data[config[i].data[j].col];
											if (val == "Y") val = "Yes";
											else if (val == "N") val = "No";
											if (config[i].data[j].col == "PO_Number" && val != "N/A") {
													if (review.data["PO_Attachment"] != null && review.data["PO_Attachment"].length > 0) val = '<a href="https://hpe-rfb.it.hpe.com/form/989/attachments/' + review.data.EntryId + '/PO_Attachment?name=' + review.data["PO_Attachment"] + '" target="_blank">' + review.data["PO_Number"] + '</a>';
													else val = review.data["PO_Number"];
											}
											if (config[i].data[j].col == "Optional_Attachment" && val != "N/A")
													val = '<a href="https://hpe-rfb.it.hpe.com/form/989/attachments/' + review.data.EntryId + '/Optional_Attachment?name=' + review.data["Optional_Attachment"] + '" target="_blank">' + review.data["Optional_Attachment"] + '</a>';

											if (config[i].data[j].col == "Requestor_PO_Opp_ID" && val == "OPE-")
													val = "N/A";
											/*if(config[i].data[j].col == "Contact_PreferredLanguage" && val == "N/A") val = "en_US";
					else if(config[i].data[j].col == "Contract_ScannedCopy" && val != "N/A") val = '<a href="https://hpe-rfb.it.hpe.com/form/681/attachments/'+review.data.app.EntryId+'/Contract_ScannedCopy?name='+val+'" target="_blank">'+val+'</a>';
					switch(config[i].data[j].col) {
						case "Company_URL":
						val = '<a href="'+val+'" target="_blank">'+val+'</a>';
						break;
						case "Company_LegalDocs":
						val = '<a href="https://hpe-rfb.it.hpe.com/form/681/attachments/'+review.data.app.EntryId+'/Company_LegalDocs?name='+val+'" target="_blank">'+val+'</a>';
						break;
						case "Business_GMFirstName":
						val = review.data.app.Business_GMSalutation + " " + review.data.app.Business_GMFirstName + " " + review.data.app.Business_GMLastName;
						break;
				}*/
											//console.log("Column: "+ config[i].data[j].col);
											if (["N/A", "NA", "Select one", "+1000000000", "NA@IGNOREME.COM", " "].indexOf(val) == -1) {
													if (config[i].data[j].ttl == "Carbon copy") {
															if (val.length > 33)
																	row.innerHTML += '<div class="item1"><p><strong>' + config[i].data[j].ttl + '</strong>' + val + '</p></div>';
															else
																	row.innerHTML += '<div class="item"><p><strong>' + config[i].data[j].ttl + '</strong>' + val + '</p></div>';
													} else {
															if (["PO_BusinessModel", "PO_DeliveryIncoterms"].indexOf(config[i].data[j].col) > -1) {
																	if (["Latin America", "North America"].indexOf(subregion) > -1 || ["Latin America", "North America"].indexOf(geo) > -1)
																			row.innerHTML += '<div class="item"><p><strong>' + config[i].data[j].ttl + '</strong>' + val + '</p></div>';
															} else if (["Config_LogCode"].indexOf(config[i].data[j].col) > -1) {
																	if (region == "EMEA")
																			row.innerHTML += '<div class="item"><p><strong>' + config[i].data[j].ttl + '</strong>' + val + '</p></div>';
															} else if (["PO_CompleteDelivery"].indexOf(config[i].data[j].col) > -1) {
																	var checkcondition = [];
																	if (["Latin America", "North America"].indexOf(subregion) > -1 || ["Latin America", "North America"].indexOf(geo) > -1)
																			checkcondition.push(true);
																	if (["APJ"].indexOf(region) > -1)
																			checkcondition.push(true);

																	if (checkcondition.indexOf(true) > -1)
																			row.innerHTML += '<div class="item"><p><strong>' + config[i].data[j].ttl + '</strong>' + val + '</p></div>';
															} else if (["Payment_Terms"].indexOf(config[i].data[j].col) > -1) {
																	var PayetermsValidArray = ["Latin America", "Central Europe", "MESA", "CERTA", "UKIMESA", "North America"];
																	if (PayetermsValidArray.indexOf(subregion) > -1 || PayetermsValidArray.indexOf(geo) > -1) {
																			row.innerHTML += '<div class="item"><p><strong>' + config[i].data[j].ttl + '</strong>' + val + '</p></div>';
																	}
															} else if (["Requestor_PO_Opp_ID"].indexOf(config[i].data[j].col) > -1) {
																	if (["Latin America", "North America"].indexOf(subregion) > -1 || ["Latin America", "North America"].indexOf(geo) > -1)
																			row.innerHTML += '<div class="item"><p><strong>' + config[i].data[j].ttl + '</strong>' + val + '</p></div>';
															} else if (["PO_Value", "PO_Currency"].indexOf(config[i].data[j].col) > -1) {
																	if (["APJ"].indexOf(region) == -1 || ["UKI"].indexOf(subregion) == -1 || ["DACH", "Europe South", "North West Europe"].indexOf(geo) == -1) {
																			row.innerHTML += '<div class="item"><p><strong>' + config[i].data[j].ttl + '</strong>' + val + '</p></div>';
																	}
															} else if (config[i].data[j].col.endsWith("_NationalID")) {
																	if (["EndCx_NationalID"].indexOf(config[i].data[j].col) > -1) {
																			if (["Turkey", "Argentina", "Brazil", "Chile", "Colombia", "Mexico", "Peru", "Puerto Rico"].indexOf(country) > -1)
																					row.innerHTML += '<div class="item"><p><strong>' + config[i].data[j].ttl + '</strong>' + val + '</p></div>';
																	} else if (["ShipTo_NationalID"].indexOf(config[i].data[j].col) > -1) {
																			if (["Turkey", "Mexico"].indexOf(country) > -1)
																					row.innerHTML += '<div class="item"><p><strong>' + config[i].data[j].ttl + '</strong>' + val + '</p></div>';
																	} else {
																			var NationalIDValidCountryArray = ["Argentina", "Brazil", "Chile", "Colombia", "Mexico", "Peru", "Puerto Rico"];
																			if (NationalIDValidCountryArray.indexOf(country) > -1)
																					row.innerHTML += '<div class="item"><p><strong>' + config[i].data[j].ttl + '</strong>' + val + '</p></div>';
																	}
															} else if (["Config_CIG", "Config_CUP"].indexOf(config[i].data[j].col) > -1) {
																	if (["Italy"].indexOf(country) > -1)
																			row.innerHTML += '<div class="item"><p><strong>' + config[i].data[j].ttl + '</strong>' + val + '</p></div>';
															} else if (["PO_HPEEntity"].indexOf(config[i].data[j].col) > -1) {
																	if (["Czech Republic", "Poland", "Hungary", "Turkey", "Romania", "Kazakhstan"].indexOf(country) > -1)
																			row.innerHTML += '<div class="item"><p><strong>' + config[i].data[j].ttl + '</strong>' + val + '</p></div>';
															} else if (["Config_Tier1", "Config_Business_Justification", "Config_Tier2", "Config_Shipment_India", "Config_OEM"].indexOf(config[i].data[j].col) > -1) {
																	if (["India"].indexOf(country) > -1) {
																			if (["Config_Business_Justification"].indexOf(config[i].data[j].col) > -1) {
																					if (review.data["Config_Tier1"] == "N")
																							row.innerHTML += '<div class="item"><p><strong>' + config[i].data[j].ttl + '</strong>' + val + '</p></div>';
																			} else if (["Config_OEM"].indexOf(config[i].data[j].col) > -1) {
																					if (review.data["Config_Shipment_India"] == "N")
																							row.innerHTML += '<div class="item"><p><strong>' + config[i].data[j].ttl + '</strong>' + val + '</p></div>';
																			} else
																					row.innerHTML += '<div class="item"><p><strong>' + config[i].data[j].ttl + '</strong>' + val + '</p></div>';
																	}
															} else if (["Config_aaS"].indexOf(config[i].data[j].col) > -1) {
																	if (["North America"].indexOf(geo) > -1) {
																			row.innerHTML += '<div class="item"><p><strong>' + config[i].data[j].ttl + '</strong>' + val + '</p></div>';
																	}
															} else
																	row.innerHTML += '<div class="item"><p><strong>' + config[i].data[j].ttl + '</strong>' + val + '</p></div>';

													}
											}
									}
									if (selector.querySelectorAll(".row")[i].querySelectorAll(".item").length == 0 && selector.querySelectorAll(".row")[i].querySelectorAll(".item1").length == 0) {
											selector.querySelectorAll(".row")[i].setAttribute("style", "display:none;");
									} else
											row.innerHTML += '<div class="cfix"></div>';

							}
							// Filters apply as per Region,SubRegion,Geo & country
							var POOptionalValidArray = ["Latin America", "Central Europe", "UKIMESA", "CERTA", "MESA", "North America"];
							if (["Latin America", "North America"].indexOf(subregion) == -1 || ["Latin America", "North America"].indexOf(geo) == -1) {
									selector.querySelectorAll(".row")[18].innerHTML = '';
									selector.querySelectorAll(".row")[19].innerHTML = '';
							} else {
									if (review.data["PO_DeliveryIncoterms"] == "DDP") {
											selector.querySelectorAll(".row")[19].innerHTML = '';
									}
									if (review.data["PartnerBRT"] == "Distributor") {
											if (["Agent Model", "HPFS & Agent Model"].indexOf(review.data["PO_BusinessModel"]) == -1) {
													selector.querySelectorAll(".row")[19].innerHTML = '';
											}
									} else {
											selector.querySelectorAll(".row")[19].innerHTML = '';
									}
							}

							if (POOptionalValidArray.indexOf(subregion) > -1 || POOptionalValidArray.indexOf(geo) > -1) {
									if (review.data["PartnerBRT"] == "Distributor") {
											if (["Agent Model", "HPFS & Agent Model"].indexOf(review.data["PO_BusinessModel"]) > -1 || review.data["PO_Category"] == "Stock") {
													selector.querySelectorAll(".row")[14].innerHTML = '';
													selector.querySelectorAll(".row")[15].innerHTML = '';
											}
									} else {
											selector.querySelectorAll(".row")[14].innerHTML = '';
											selector.querySelectorAll(".row")[15].innerHTML = '';

									}
									if (review.data["PO_Category"] == "Stock") {
											selector.querySelectorAll(".row")[14].innerHTML = '';
											selector.querySelectorAll(".row")[15].innerHTML = '';
									}
							}
							//Sold To Address Details
							if (review.data["Config_SoldToDetails"] == "Y")
									selector.querySelectorAll(".row")[7].innerHTML = '';
							//Sold To Contact Details
							if (review.data["Config_SoldToDetails_Contact"] == "Y")
									selector.querySelectorAll(".row")[6].innerHTML = '';
							//Ship To Address Details
							if (review.data["Config_ShipToDetails"] == "Y")
									selector.querySelectorAll(".row")[13].innerHTML = '';
							//Ship To Contact Details
							if (review.data["Config_ShipToDetails_Contact"] == "Y")
									selector.querySelectorAll(".row")[12].innerHTML = '';
							//Reseller Address Details
							if (review.data["Config_ResellerDetails"] == "Y")
									selector.querySelectorAll(".row")[15].innerHTML = '';
							//Reseller Contact Details
							if (review.data["Config_ResellerDetails_Contact"] == "Y")
									selector.querySelectorAll(".row")[14].innerHTML = '';
							//End Customer Address Details
							if (review.data["Config_EndCxDetails"] == "Y")
									selector.querySelectorAll(".row")[17].innerHTML = '';
							//End Customer Contact Details
							if (review.data["Config_EndCxDetails_Contact"] == "Y")
									selector.querySelectorAll(".row")[18].innerHTML = '';
							//Asso Location Details
							if (review.data["Config_LocationDetails"] == "Y")
									selector.querySelectorAll(".row")[22].innerHTML = '';
							//Entitled Address & Contact Details
							if (review.data["Config_EntitledDetails"] == "Y") {
									selector.querySelectorAll(".row")[23].innerHTML = '';
									selector.querySelectorAll(".row")[24].innerHTML = '';
							}
							//Bill To Address & Contact Details
							if (review.data["Config_BillToDetails"] == "Y") {
									selector.querySelectorAll(".row")[10].innerHTML = '';
									selector.querySelectorAll(".row")[11].innerHTML = '';
							}
							//Payer Address & Contact Details
							if (review.data["Config_PayerDetails"] == "Y") {
									selector.querySelectorAll(".row")[8].innerHTML = '';
									selector.querySelectorAll(".row")[9].innerHTML = '';
							}
					},
					_timeline: function() {
							var fullscreen = document.querySelector("#fullscreen");
							//// ADD TIMELINE
							if (review.data.Submitted == "Y")
									fullscreen.querySelector(".timeline").innerHTML = '<div class="tat"><em>TAT</em><strong>N/A</strong></div><div class="status"><em>STATUS</em><strong>N/A</strong></div><div class="order"><em>HPE ORDER #</em><strong>N/A</strong></div>';
							// UPDATE TIMELINE
							if (review.data.Status == "4") {
									fullscreen.querySelector(".timeline .status strong").innerText = "Fallout";
									try {
											var ops = JSON.parse(review.data.Operations);
											var tme = ops[ops.length - 1].Created;
											fullscreen.querySelector(".timeline .tat strong").innerText = time.dhm(new Date(tme).getTime() - new Date(review.data.SubmittedTimestamp).getTime());
									} catch (err) {}
							} else if (review.data.Status == "5") {
									fullscreen.querySelector(".timeline .status strong").innerText = "Cancelled";
									try {
											var ops = JSON.parse(review.data.Operations);
											var tme = ops[ops.length - 1].Created;
											fullscreen.querySelector(".timeline .tat strong").innerText = time.dhm(new Date(tme).getTime() - new Date(review.data.SubmittedTimestamp).getTime());
									} catch (err) {}
							} else if (review.data.Status == "3") {
									fullscreen.querySelector(".timeline .status strong").innerText = "Completed";
									fullscreen.querySelector(".timeline .order strong").innerText = review.data.PO_Order_ID || review.data.PO_AAS_ID;
									try {
											var ops = JSON.parse(review.data.Operations);
											var tme = ops[ops.length - 1].Created;
											fullscreen.querySelector(".timeline .tat strong").innerText = time.dhm(new Date(tme).getTime() - new Date(review.data.SubmittedTimestamp).getTime());
									} catch (err) {}
							} else if (review.data.Status == "2" || review.data.Status == "1") {
									fullscreen.querySelector(".timeline .status strong").innerText = "Pending";
									fullscreen.querySelector(".timeline .tat strong").innerText = time.dhm(new Date(applet.user.LastLogin).getTime() - new Date(review.data.SubmittedTimestamp).getTime());
							} else {
									//console.log(document.querySelector("#fullscreen"));
									var selection = fullscreen.querySelector(".timeline .status strong") !== null;
									if (selection)
											fullscreen.querySelector(".timeline .status strong").innerText = "Draft";
							}
					},
					_history: function() {
							var selector = document.querySelector("#fullscreen .history");
							var history = [];
							var creation = {
									Email: review.data.Email,
									Status: "0",
									Created: review.data.Created
							};
							history.push(creation);
							var submission = {
									Email: review.data.Email,
									Status: "1",
									Created: review.data.SubmittedTimestamp
							};
							try {
									var ops = JSON.parse(review.data.Operations);
									history = history.concat(ops);
									if (review.data.Submitted == "Y") {
											var submission = {
													Email: review.data.Email,
													Status: "1",
													Created: review.data.SubmittedTimestamp
											};
											//console.log(history);
											/*for(i=0;i<history.length;i++) {
					console.log("thefor");
					if(new Date(history[i].Created).getTime() > new Date(review.data.SubmittedTimestamp).getTime()) {
						if(i==0) history.unshift(submission);
						else history.splice(i, 0, submission);
							break;
					}
						else if(i == history.length-1) history.push(submission);
				}*/
									}
							} catch (err) {
									if (review.data.Submitted == "Y") {
											var submission = {
													Email: review.data.Email,
													Status: "1",
													Created: review.data.SubmittedTimestamp
											};
											history.push(submission);
									}
							}
							if (history.length == 0) selector.innerHTML = 'We have not found any history. It is kind of strange to say the least. Going right now to grab all history books and confirm.';
							else {
									selector.innerHTML = '<ul></ul>';
									selector = selector.querySelector("ul");
									for (i = history.length - 1; i >= 0; i--) {
											//console.log("loop");
											var cls = "collapsed";
											if (["0", "1", "3"].indexOf(history[i].Status) > -1) cls = cls + " done";
											else if (history[i].Status == "2") cls = cls + " pend";
											else if (history[i].Status == "4") cls = cls + " fail";
											var ttl = "N/A";
											if (history[i].oldStatus == history[i].Status) {
													ttl = "Record updated";
											} else {
													if (history[i].Status == "0") ttl = "Record created";
													else if (history[i].Status == "1") ttl = "Request submitted";
													else if (history[i].Status == "2") ttl = "Request moved to pending";
													else if (history[i].Status == "3") ttl = "HPE Order # created";
													else if (history[i].Status == "4") ttl = "Request fallout";
													else if (history[i].Status == "5") ttl = "Request cancelled";
											}
											selector.innerHTML += '<li class="' + cls + '" li-id="' + i + '"><span></span><h4>' + ttl + '<em>' + history[i].Created + '</em></h4><div class="drop"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="down" width="24px" height="24px"><polyline fill="none" stroke="#666" stroke-width="2" points="7.086 3.174 17.086 13.174 7.086 23.174" transform="scale(1 -1) rotate(-89 -1.32 0)"></polyline></svg></div><div class="details"></div></li>';
											var details = document.querySelector("li[li-id='" + i + "'] .details");
											details.innerHTML += '<p><strong>User: </strong>' + history[i].Email + '</p>';
											if (typeof(history[i].SubStatus) !== "undefined" && history[i].SubStatus != null) {
													var reason = "Other";
													if (history[i].SubStatus == "0") reason = "Order already exists";
													else if (history[i].SubStatus == "1") reason = "Order cancelled and replaced with new PO and Order";
													else if (history[i].SubStatus == "2") reason = "HPE cannot do business with one or more of the Parties involved in the PO";
													else if (history[i].SubStatus == "3") reason = "Other";
													details.innerHTML += '<p><strong>Reason: </strong>' + reason + '</p>';
											}
											if (typeof(history[i].Comment) !== "undefined" && history[i].Comment != null)
													details.innerHTML += '<p><strong>Comment: </strong>' + history[i].Comment + '</p>';
									}
							}
					},
					_events: function() {
							//// EVENTS
							// TABS
							// ADD TAB ON CLICK
							var tabs = document.querySelectorAll("#fullscreen .tabs span");
							var sections = document.querySelectorAll("#fullscreen .container section");
							for (i = 0; i < tabs.length; i++) {
									tabs[i].addEventListener("click", function(e) {
											// RESET ALL TABS
											for (i = 0; i < tabs.length; i++)
													tabs[i].setAttribute("class", "");
											// RESET ALL SECTIONS
											for (i = 0; i < sections.length; i++)
													sections[i].setAttribute("class", "");
											// CURRENT SECTION
											var cid = e.target.getAttribute("tab-id") || e.target.closest("span").getAttribute("tab-id");
											document.querySelector("#fullscreen span[tab-id=" + cid + "]").classList.add("active");
											document.querySelector("#fullscreen section[tab-id=" + cid + "]").classList.add("active");
									});
							}
							// DEFAULT TO FIRST TAB
							document.querySelector("#fullscreen .tabs span").click();
							// CLOSE
							fullscreen.querySelector("h1 .close").addEventListener("click", function() {
									fullscreen.classList.remove("active");
									mo.fn.overlay.hide();
							});
							// COLLAPSABLE HISTORY ITEM
							function toggleHistoryItem(node) {
									var li = node.closest("li");
									if (li != null) {
											if (li.getAttribute("class").indexOf("collapsed") > -1) {
													li.classList.remove("collapsed");
													li.classList.add("expanded");
											} else {
													li.classList.remove("expanded");
													li.classList.add("collapsed");
											}
									}
							}
							var theExpandables = document.querySelectorAll("#fullscreen .history li .drop");
							for (i = 0; i < theExpandables.length; i++)
									theExpandables[i].addEventListener("click", function(e) {
											toggleHistoryItem(e.target);
									});
							theExpandables[0].click();
							// COLLAPSABLE APPLICATION ITEM
							function toggleAppItem(node) {
									var row = node.closest(".row");
									if (row != null) {
											if (row.getAttribute("class").indexOf("collapsed") > -1) {
													row.classList.remove("collapsed");
													row.classList.add("expanded");
											} else {
													row.classList.remove("expanded");
													row.classList.add("collapsed");
											}
									}
							}
							var theExpandables = document.querySelectorAll("#fullscreen section[tab-id=app] .drop");
							for (i = 0; i < theExpandables.length; i++)
									theExpandables[i].addEventListener("click", function(e) {
											toggleAppItem(e.target);
									});
							theExpandables[0].click();
							/*
			//// TASKS
			// HIDE ALL FORMS
			function hideAllTaskForms() {
			var allf = document.querySelectorAll("#fullscreen div.row[form-id]");
				for(i=0;i<allf.length;i++)
					allf[i].classList.remove("active");
		}
			function showTaskForm() {
				var rola = document.querySelector("#fullscreen select#role").value;
			document.querySelector("#fullscreen div.row[form-id="+rola+"]").classList.add("active");
		}
			// CHANGE TASK FORM
			document.querySelector("#fullscreen select#role").addEventListener("change",function(e){
			var formid = e.target.value;
				hideAllTaskForms();
				showTaskForm(formid);
		});
			// HIDE ALL REASONS
			function hideAllTaskReasons() {
			var actf = document.querySelector("#fullscreen div.row.active[form-id] select.reasons");
				if(actf != null) {
				var acto = actf.querySelectorAll("option");
					for(i=0;i<acto.length;i++)
						acto[i].hidden = true;
			}
		}
			function showMatchingTaskReasons() {
				var acts = document.querySelector("#fullscreen div.row.active[form-id] select.status").value;
			var actr = document.querySelectorAll("#fullscreen div.row.active[form-id] select.reasons option[data-group="+acts+"]");
				if(actr != null) 
					for(i=0;i<actr.length;i++)
						actr[i].hidden = false;
		}
			var allstatus = document.querySelectorAll("#fullscreen div.row select.status");
			for(i=0;i<allstatus.length;i++) {
			allstatus[i].addEventListener("change",function(e) {
				hideAllTaskReasons();
					showMatchingTaskReasons();
			});
		}
		
			// DEFAULT SHOW FIRST TASK FORM & MATCHING REASONS
			hideAllTaskForms();
			showTaskForm();
			hideAllTaskReasons();
			showMatchingTaskReasons();*/
					},
					_tasks: function() {
							var user = applet.user.UserRole;
							var regn = review.data.Region;
							var slct = document.querySelector("#fullscreen section[tab-id=tasks]");
							var rols = ["OPS"];

							// DEFAULT REGION TO EMEA FOR OLD CASES
							if (["EMEA", "APJ", "AMS"].indexOf(regn) == -1) regn = "EMEA";
							// DEFAULT NO AVAILABLE TASKS
							slct.innerHTML = '<p class="na">There no available tasks for this case.</p>';
							// CHECK MATCHING ROLES
							var match = false;
							let matchAdmin = false;
							for (i = 0; i < rols.length; i++)
									if (user[rols[i]][regn] && ["0", "3"].indexOf(review.data.Status) == -1) {
											match = true;
											break;
									}
							if (user.ADMIN && (review.data.Status === '3')) {
									match = true;
									matchAdmin = true;
							}

							// ADD TASKS
							if (match) {
									slct.innerHTML = '<div class="nbsf"></div>';
									slct = slct.querySelector(".nbsf");
									slct.innerHTML = '<h4>HPE Operational Order Request review</h4><p class="description">Provide case update and/or resolution.</p>';
									slct.innerHTML += '<fieldset></fieldset>';
									slct = slct.querySelector("fieldset");
									slct.innerHTML = '<label class="wrapper select" style="display:block;">' +
											'<span class="name">Case status</span><span class="required">*</span>' +
											'<div class="fmmcosmin">' +
											'<select name="Operations_Status" data-name="Operations_Status" data-type="select">' +
											//'<option value="0">Return</option>'+
											'<option value="2" selected>Pending</option>' +
											'<option value="3">Completed</option>' +
											'<option value="4">Fallout</option>' +
											'<option value="5">Cancelled</option>' +
											'</select>' +
											'</div>' +
											'</label>';
									/*slct.innerHTML += '<label class="wrapper select" style="display:none;">' +
											'<span class="name">Failure reason</span><span class="required">*</span>' +
											'<div class="fmmcosmin">' +
											'<select name="Operations_SubStatus" data-name="Operations_SubStatus" data-type="select">' +
											'<option value="0">Order already exists</option>' +
											'<option value="1">Order cancelled and replaced with new PO and Order</option>' +
											'<option value="2">HPE cannot do business with one or more of the Parties involved in the PO</option>' +
											'<option value="3">Other</option>' +
											'</select>' +
											'</div>' +
											'</label>';*/
									slct.innerHTML += '<label class="wrapper text" style="display:' + (matchAdmin ? 'block' : 'none') + ';">' +
											'<span class="name">S4 Order ID</span>' + (matchAdmin ? '' : '<span class="required">*</span>') +
											'<div class="fmmcosmin">' +
											'<input type="text" placeholder="Provide the S4 Order ID" name="Operations_OrderID" data-name="Operations_OrderID" data-type="text" maxlength="77" value="">' +
											'</div>' +
											'</label>';
									slct.innerHTML += '<label class="wrapper text" style="display:' + (matchAdmin ? 'block' : 'none') + ';">' +
											'<span class="name">Legacy Order ID</span>' + (matchAdmin ? '' : '<span class="required">*</span>') +
											'<div class="fmmcosmin">' +
											'<input type="text" placeholder="Provide the Legacy Order ID" name="Operations_Legacy_OrderID" data-name="Operations_Legacy_OrderID" data-type="text" maxlength="39" value="">' +
											'</div>' +
											'</label>';
									slct.innerHTML += '<label class="wrapper text" style="display:' + (matchAdmin ? 'block' : 'none') + ';">' +
											'<span class="name">aaS order ID</span>' + (matchAdmin ? '' : '<span class="required">*</span>') +
											'<div class="fmmcosmin">' +
											'<input type="text" placeholder="Provide the aaS Order ID" name="Operations_aaS_OrderID" data-name="Operations_aaS_OrderID" data-type="text" maxlength="27" value="">' +
											'</div>' +
											'</label>';
									slct.innerHTML += '<label class="wrapper textarea" style="display:block;">' +
											'<span class="name">Comment</span>' +
											'<div class="fmmcosmin">' +
											'<textarea placeholder="Provide additional comments if required" name="Operations_Comment" data-name="Operations_Comment" data-type="textarea"></textarea>' +
											'</div>' +
											'</label>';
									slct.innerHTML += '<span class="btn continue disabled" style="margin: 40px 0 0 0!important;padding: 10px 40px;width: auto;">Submit</span>';

									var status = slct.querySelector("select[name=Operations_Status]");
									//var subStatus = slct.querySelector("select[name=Operations_SubStatus]");
									var orderId = slct.querySelector("input[name=Operations_OrderID]");
									var comment = slct.querySelector("textarea[name=Operations_Comment]");
									var legacyorderid = slct.querySelector("input[name=Operations_Legacy_OrderID]");
									var aasid = slct.querySelector("input[name=Operations_aaS_OrderID]");
									var submit = slct.querySelector("span.btn.continue");
									var orderIdRequiredSpan = orderId.closest('.wrapper.text').querySelector('.required');
									var aasidRequiredSpan = aasid.closest('.wrapper.text').querySelector('.required');

									function toggleSubmit() {
											if (status.value == "3" || status.value == "4" || status.value == "5" || (status.value == "2" && matchAdmin)) {
													if (status.value == "3") {
															if (
																	(legacyorderid.value.length > 0 && legacyorderid.value.length <= 39 && /^[a-zA-Z0-9;]*$/.test(legacyorderid.value) && orderId.value === 'N/A' && aasid.value === 'N/A') ||
																	(orderId.value.length >= 10 && orderId.value.length <= 77 && /^(7\d{9};){0,7}(7\d{9})?$/.test(orderId.value) && legacyorderid.value === 'N/A' && (aasid.value === 'N/A' || (aasid.value.length >= 8 && aasid.value.length <= 27 && /^5[0-9]{7}(;5[0-9]{7})*$/.test(aasid.value)))) ||
																	(aasid.value.length >= 8 && aasid.value.length <= 27 && /^5[0-9]{7}(;5[0-9]{7})*$/.test(aasid.value) && legacyorderid.value === 'N/A' && (orderId.value === 'N/A' || (orderId.value.length >= 10 && orderId.value.length <= 77 && /^(7\d{9};){0,7}(7\d{9})?$/.test(orderId.value)))) ||
																	(legacyorderid.value === 'N/A' && orderId.value === 'N/A' && aasid.value === 'N/A')
															) {
																	submit.classList.remove("disabled");
																	submit.addEventListener("click", submitUpdate);
															} else {
																	submit.classList.add("disabled");
																	submit.removeEventListener("click", submitUpdate);
															}
													} else {
															submit.classList.remove("disabled");
															submit.addEventListener("click", submitUpdate);
													}
											} else {
													submit.classList.add("disabled");
													submit.removeEventListener("click", submitUpdate);
											}
									}

									toggleSubmit();

									function submitUpdate() {
											slct.setAttribute("style", "opacity:0.5;pointer-events:none;");
											try {
													var ops = JSON.parse(review.data.Operations);
											} catch (err) {
													var ops = [];
											}
											if (ops == null) ops = [];
											var obj = null;
											if (status.value == "3" || matchAdmin) {
													obj = {
															Email: applet.user.Email,
															Status: status.value,
															oldStatus: review.data.Status,
															Order: orderId.value,
															LegacyOrder: legacyorderid.value,
															aasid: aasid.value,
															Comment: comment.value
													}
											} else {
													obj = {
															Email: applet.user.Email,
															Status: status.value,
															Order: "N/A",
															Comment: comment.value
													}
											}
											/*if (obj.Status == "3") obj.SubStatus = "N/A";
											else obj.SubStatus = subStatus.value;*/
											var poorderid = "";
											if (orderId.value != "N/A"){
													poorderid = orderId.value;
					}
					else if (orderId.value == "N/A" && aasid.value == "N/A") {
													poorderid = legacyorderid.value;
											}
											var data = {
													Status: status.value,
													PO_Order_ID: poorderid,
							PO_AAS_ID: aasid.value
											};
											time.timestamp(function(t) {
													obj.Created = t;
													ops.push(obj);
													data.Operations = JSON.stringify(ops);
													crud.update("3158", review.data.EntryId, data, function(d) {
															// UPDATE CONSOLE
															crud.c.i("Order record " + d.EntryId + " was successfully updated");
															crud.c.l(d);
															slct.setAttribute("style", "");
															// IF COMPLETE REFRESH
															if (d.Status == "2" || d.Status == "3" || d.Status == "4" || d.Status == "5") review._init(d.EntryId);
															else alert("Update saved successfully");
													});
											});
									}

									if (matchAdmin || (user.ADMIN && review.data.Status === '2')) {
											status.value = review.data.Status;
											if (review.data.Operations) {
													const dataOperations = JSON.parse(review.data.Operations);
													const opData = dataOperations[dataOperations.length - 1];

													orderId.value = opData.Order === undefined ? '' : opData.Order;
													legacyorderid.value = opData.LegacyOrder === undefined ? 'N/A' : opData.LegacyOrder;
													aasid.value = opData.aasid === undefined ? 'N/A' : opData.aasid;
													toggleSubmit();
											}
									}

									status.addEventListener("change", function(e) {
											var val = e.target.value;
											if (val == "3" || matchAdmin) {
													orderId.closest("label").style.display = "block";
													legacyorderid.closest("label").style.display = "block";
													aasid.closest("label").style.display = "block";
													if (!matchAdmin && !(user.ADMIN && review.data.Status === '2')) {
															orderId.value = "";
															legacyorderid.value = "";
															aasid.value = "";
													}
											} else {
													document.getElementsByName('Operations_OrderID')[0].parentElement.parentElement.getElementsByClassName('name')[0].innerText = "Order ID";
													legacyorderid.closest("label").style.display = "none";
													legacyorderid.value = "N/A";
													orderId.closest("label").style.display = "none";
													orderId.value = "N/A";
													aasid.closest("label").style.display = "none";
													aasid.value = "N/A";
											}

											if (!matchAdmin && !(user.ADMIN && review.data.Status === '2')) {
													if (val == "4" || val == "3" || val == "5") {
															orderId.value = "";
															orderId.disabled = false;
													} else {
															orderId.value = "N/A";
															orderId.disabled = true;
													}
											}
											toggleSubmit();
									});
									/*subStatus.addEventListener("change", function(e) {
											var val = e.target.value;
											if (val == "0") {
													orderId.value = "";
													orderId.disabled = false;
											} else {
													orderId.value = "N/A";
													orderId.disabled = true;
											}
											toggleSubmit();
									});*/
									orderId.addEventListener("input", function(e) {
											if ((legacyorderid.value == "" || legacyorderid.value == "N/A") && (orderId.value != "" && orderId.value != "N/A")) {
													legacyorderid.value = "N/A";
													if (aasidRequiredSpan) {
															aasidRequiredSpan.style.display = 'none';
													}
													aasid.removeAttribute('required');

											} else {
													//orderId.value = "N/A";
													aasid.setAttribute('required', 'required');
													aasidRequiredSpan.style.display = 'inline';
											}
											toggleSubmit();
									});
									orderId.addEventListener("focusout", function(e) {
											if ((legacyorderid.value == "" || legacyorderid.value == "N/A") && (orderId.value != "" && orderId.value != "N/A")) {
													legacyorderid.value = "N/A";
													aasid.removeAttribute('required');
													if (aasidRequiredSpan) {
															aasidRequiredSpan.style.display = 'none';
													}
											} else {
													orderId.value = "N/A";
													aasid.setAttribute('required', 'required');
													aasidRequiredSpan.style.display = 'inline';
											}
											toggleSubmit();
									});
									legacyorderid.addEventListener("focusout", function(e) {
											if ((legacyorderid.value != "" && legacyorderid.value != "N/A") && (orderId.value == "" || orderId.value == "N/A")) {
													orderId.value = "N/A";
													aasid.value = "N/A";
											} else
													legacyorderid.value = "N/A";

											toggleSubmit();
									});
									legacyorderid.addEventListener("input", function(e) {
											if ((legacyorderid.value != "" && legacyorderid.value != "N/A") && (orderId.value == "" || orderId.value == "N/A")) {
													orderId.value = "N/A";
													aasid.value = "N/A";
											}

											toggleSubmit();
									});
									aasid.addEventListener("focusout", function(e) {
											if ((aasid.value != "" && aasid.value != "N/A") && (legacyorderid.value == "" || legacyorderid.value == "N/A")) {
													legacyorderid.value = "N/A";
													orderId.removeAttribute('required');
													if (orderIdRequiredSpan) {

															orderIdRequiredSpan.style.display = 'none';
													}
											} else {
													orderId.value = "N/A";
													aasid.value = "N/A";
											}


											toggleSubmit();
									});
									aasid.addEventListener("input", function(e) {
											if ((aasid.value != "" && aasid.value != "N/A") && (legacyorderid.value == "" || legacyorderid.value == "N/A")) {
													legacyorderid.value = "N/A";
													orderId.removeAttribute('required');
													if (orderIdRequiredSpan) {

															orderIdRequiredSpan.style.display = 'none';
													}
											} else {
													orderId.value = "N/A";
													//aasid.value = "N/A";
													if (orderIdRequiredSpan) {
															orderIdRequiredSpan.style.display = 'inline';
													}
													orderId.setAttribute('required', 'required');


											}


											toggleSubmit();
									});
							}
					}
			},
			_getData: function(eid, legacy, callback) {
					if (legacy === undefined) {
							crud.read("3180", "eid=" + eid, function(d) {
									//console.log(d);
									if (typeof(d.Rows) === "undefined" || d.Rows.length == 0 || typeof(d.Rows[0].EntryId) === "undefined" || d.Rows[0].EntryId == null) alert("Record not found. A big bear ate it.");
									else {
											review.data = d.Rows[0];
											if (typeof(callback) === "function") return callback();
											else return true;
									}
							});
					} else {
							if (document.querySelector("select[id=searchoptions]").value == "AppID") {
									//console.log("AppID");
									crud.read("3180", "eid=" + eid, function(d) {
											//console.log(d);
											if (typeof(d.Rows) === "undefined" || d.Rows.length == 0 || typeof(d.Rows[0].EntryId) === "undefined" || d.Rows[0].EntryId == null) alert("Record not found. A big bear ate it.");
											else {
													review.data = d.Rows[0];
													if (typeof(callback) === "function") return callback();
													else return true;
											}
									});
							} else {
									//console.log("PO");
									crud.read("3795", "pon=" + eid, function(d) {
											//console.log(d);
											if (typeof(d.Rows) === "undefined" || d.Rows.length == 0 || typeof(d.Rows[0].EntryId) === "undefined" || d.Rows[0].EntryId == null) alert("Record not found. A big bear ate it.");
											else {
													review.data = d.Rows[0];
													if (typeof(callback) === "function") return callback();
													else return true;
											}
									});
							}
					}
			},
			_getStatus: function() {
					var def = {
							referral: 0,
							submitted: 0,
							global: 0,
							CL1: 0,
							PL1: 0,
							LRC: 0,
							ARUBA: 0,
							HIT: 0,
							PL2: 0,
							CL2: 0
					}
					if (review.data.app.Submitted == "Y") def.submitted = 1;
					if (Object.keys(review.data.ref).length > 0) def.referral = 1;
					else {
							if (review.data.app.BusinessReviewStatus == "Approved") def.HIT = 1;
							else if (review.data.app.BusinessReviewStatus == "Declined") def.HIT = 3;
							else if (review.data.app.ArubaReviewStatus != "Approved" && (review.data.app.BusinessReviewStatus == "Pending" || review.data.app.ContractReviewStatus == "Approved")) def.HIT = 2;
							if (review.data.app.ArubaReviewStatus == "Approved") def.ARUBA = 1;
							else if (review.data.app.ArubaReviewStatus == "Declined") def.ARUBA = 3;
							else if (review.data.app.BusinessReviewStatus != "Approved" && (review.data.app.ArubaReviewStatus == "Pending" || review.data.app.ContractReviewStatus == "Approved")) def.ARUBA = 2;
					}
					if (review.data.app.ContractReviewStatus == "Approved") def.CL1 = 1;
					else if (review.data.app.ContractReviewStatus == "Declined") def.CL1 = 3;
					else if (review.data.app.ContractReviewStatus == "Pending" || review.data.app.Submitted == "Y") def.CL1 = 2;
					if (
							review.data.app.DataReviewStatus == "Approved" ||
							(review.data.app.PartyId != null && review.data.app.PartyId.length == 10) ||
							(review.data.app.LocationId != null && review.data.app.LocationId.length == 8) ||
							(review.data.app.PartnerProId != null && review.data.app.PartnerProId.indexOf("-") > -1)
					) def.PL1 = 1;
					else if (review.data.app.DataReviewStatus == "Declined") def.PL1 = 3;
					else if (review.data.app.DataReviewStatus == "Pending" || review.data.app.ContractReviewStatus == "Approved") def.PL1 = 2;
					if (review.data.app.LegalReviewStatus == "Approved") def.LRC = 1;
					else if (review.data.app.LegalReviewStatus == "Declined") def.LRC = 3;
					else if (review.data.app.LegalReviewStatus == "Pending" || review.data.app.ContractReviewStatus == "Approved") def.LRC = 2;
					if (review.data.app.ProfilingSetupStatus == "Approved") def.PL2 = 1;
					else if (review.data.app.ProfilingSetupStatus == "Declined") def.PL2 = 3;
					else if (review.data.app.ProfilingSetupStatus == "Pending" || (def.PL1 == 1 && def.LRC == 1 && (def.referral == 1 || def.ARUBA == 1 || def.HIT == 1))) def.PL2 = 2;
					if (review.data.app.ContractActivationStatus == "Approved") def.CL2 = 1;
					else if (review.data.app.ContractActivationStatus == "Declined") def.CL2 = 3;
					else if (review.data.app.ContractActivationStatus == "Pending" || review.data.app.ProfilingSetupStatus == "Approved") def.CL2 = 2;

					if (def.CL2 == 1) def.global = 1;
					else if (
							def.CL1 == 3 ||
							def.PL1 == 3 ||
							def.LRC == 3 ||
							def.PL2 == 3 ||
							def.CL2 == 3 ||
							(def.ARUBA == 3 && def.HIT == 3 && referral == 0)
					) def.global = 3;
					else if (def.submitted == 1) global = 2;
					return def;
			},
			_getTAT: function() {
					time.timestamp(function(t) {
							var now = t;
							var status = review._getStatus();
							if (status.submitted == 0) return 0;
							else {
									if (status.global == 1) {
											return Date.parse(review.data.app.ContractActivationDate) - Date.parse(review.data.app.SubmittedTimestamp);
									} else if (status.global == 3) {
											if (status.CL2 == 3) {
													return Date.parse(review.data.app.ContractActivationDate) - Date.parse(review.data.app.SubmittedTimestamp);
											} else if (status.PL2 == 3) {
													return Date.parse(review.data.app.ProfilingSetupDate) - Date.parse(review.data.app.SubmittedTimestamp);
											} else if (status.HIT == 3 && status.ARUBA == 3) {
													if (Date.parse(review.data.app.BusinessReviewDate) > Date.parse(review.data.app.ArubaReviewDate))
															return Date.parse(review.data.app.BusinessReviewDate) - Date.parse(review.data.app.SubmittedTimestamp);
													else
															return Date.parse(review.data.app.ArubaReviewDate) - Date.parse(review.data.app.SubmittedTimestamp);
											} else if (status.LRC == 3) {
													return Date.parse(review.data.app.LegalReviewDate) - Date.parse(review.data.app.SubmittedTimestamp);
											} else if (status.PL1 == 3) {
													return Date.parse(review.data.app.DataReviewDate) - Date.parse(review.data.app.SubmittedTimestamp);
											} else if (status.CL1 == 3) {
													return Date.parse(review.data.app.ContractReviewDate) - Date.parse(review.data.app.SubmittedTimestamp);
											}
									} else {
											return Date.parse(now) - Date.parse(review.data.app.SubmittedTimestamp);
									}
							}
					});
			},
			_getHistory: function() {
					var hist = {};
					var stat = review._getStatus();

					function tsToMS(timestamp) {
							return Date.parse(timestamp);
					}
					// REFERRAL
					if (stat.referral == 1) {
							hist[tsToMS(review.data.ref.Created)] = {
									email: review.data.ref.Email,
									title: "Referred (Distributor)",
									timestamp: review.data.ref.Created
							}
							if (review.data.ref.Email.indexOf("@hpe.com") > -1)
									hist[tsToMS(review.data.ref.Created)].title = "Referred (HPE)";
					}
					// HIT & ARUBA
					else {
							if (review.data.app.BusinessReviewHistory != null && review.data.app.BusinessReviewHistory.length > 0) {
									var ops = JSON.parse(review.data.app.BusinessReviewHistory);
									for (i = 0; i < ops.length; i++) {
											hist[tsToMS(ops[i].BusinessReviewDate)] = {
													status: ops[i].BusinessReviewStatus,
													comment: ops[i].BusinessReviewComment,
													email: ops[i].BusinessReviewUser,
													title: ops[i].BusinessReviewStatus + " (Hybrid IT)",
													timestamp: ops[i].BusinessReviewDate
											}
									}
							}
							if (review.data.app.ArubaReviewHistory != null && review.data.app.ArubaReviewHistory.length > 0) {
									var ops = JSON.parse(review.data.app.ArubaReviewHistory);
									for (i = 0; i < ops.length; i++) {
											hist[tsToMS(ops[i].ArubaReviewDate)] = {
													status: ops[i].ArubaReviewStatus,
													comment: ops[i].ArubaReviewComment,
													email: ops[i].ArubaReviewUser,
													title: ops[i].ArubaReviewStatus + " (Aruba)",
													timestamp: ops[i].ArubaReviewDate
											}
									}
							}
					}
					// CREATED
					hist[tsToMS(review.data.app.Created)] = {
							email: review.data.app.Contact_BusinessEmail,
							title: "Created record",
							timestamp: review.data.app.Created
					}
					// SUBMITTED
					if (review.data.app.SubmittedTimestamp != null && review.data.app.SubmittedTimestamp.indexOf("T") > -1) {
							hist[tsToMS(review.data.app.SubmittedTimestamp)] = {
									email: review.data.app.Contact_BusinessEmail,
									title: "Submitted application",
									timestamp: review.data.app.SubmittedTimestamp
							}
					}
					// CL1
					if (review.data.app.ContractReviewHistory != null && review.data.app.ContractReviewHistory.length > 0) {
							var ops = JSON.parse(review.data.app.ContractReviewHistory);
							for (i = 0; i < ops.length; i++) {
									hist[tsToMS(ops[i].ContractReviewDate)] = {
											status: ops[i].ContractReviewStatus,
											reason: ops[i].ContractReviewReason,
											comment: ops[i].ContractReviewComment,
											email: ops[i].ContractReviewUser,
											title: ops[i].ContractReviewStatus + " (Contracts review)",
											timestamp: ops[i].ContractReviewDate
									}
							}
					}
					// PL1
					if (review.data.app.DataReviewHistory != null && review.data.app.DataReviewHistory.length > 0) {
							var ops = JSON.parse(review.data.app.DataReviewHistory);
							for (i = 0; i < ops.length; i++) {
									hist[tsToMS(ops[i].DataReviewDate)] = {
											status: ops[i].DataReviewStatus,
											reason: ops[i].DataReviewReason,
											comment: ops[i].DataReviewComment,
											email: ops[i].DataReviewUser,
											title: ops[i].DataReviewStatus + " (Record creation)",
											timestamp: ops[i].DataReviewDate
									}
							}
					}
					// LRC
					if (review.data.app.LegalReviewHistory != null && review.data.app.LegalReviewHistory.length > 0) {
							var ops = JSON.parse(review.data.app.LegalReviewHistory);
							for (i = 0; i < ops.length; i++) {
									hist[tsToMS(ops[i].LegalReviewDate)] = {
											status: ops[i].LegalReviewStatus,
											reason: ops[i].LegalReviewReason,
											comment: ops[i].LegalReviewComment,
											email: ops[i].LegalReviewUser,
											title: ops[i].LegalReviewStatus + " (L&R review)",
											timestamp: ops[i].LegalReviewDate
									}
							}
					}
					// PL2
					if (review.data.app.ProfilingSetupHistory != null && review.data.app.ProfilingSetupHistory.length > 0) {
							var ops = JSON.parse(review.data.app.ProfilingSetupHistory);
							for (i = 0; i < ops.length; i++) {
									hist[tsToMS(ops[i].ProfilingSetupDate)] = {
											status: ops[i].ProfilingSetupStatus,
											reason: ops[i].ProfilingSetupReason,
											comment: ops[i].ProfilingSetupComment,
											email: ops[i].ProfilingSetupUser,
											title: ops[i].ProfilingSetupStatus + " (Record profiling)",
											timestamp: ops[i].ProfilingSetupDate
									}
							}
					}
					// CL2
					if (review.data.app.ContractActivationHistory != null && review.data.app.ContractActivationHistory.length > 0) {
							var ops = JSON.parse(review.data.app.ContractActivationHistory);
							for (i = 0; i < ops.length; i++) {
									hist[tsToMS(ops[i].ContractActivationDate)] = {
											status: ops[i].ContractActivationStatus,
											reason: ops[i].ContractActivationReason,
											comment: ops[i].ContractActivationComment,
											email: ops[i].ContractActivationUser,
											title: ops[i].ContractActivationStatus + " (Contract activation)",
											timestamp: ops[i].ContractActivationDate
									}
							}
					}
					return hist;
			}
	}
</script>
<!-- COMPONENT COUNTRIES -->
<script>
	const countries = {
			ready: false,
			data: {},
			_init: function() {
					if (!countries.ready) {
							mo.fn.overlay.show({
									loading: true,
									close: false
							});
							countries._ui();
							countries._getData(function() {
									countries.grid._load("#countries .grid", countries.data, countries.grid._config());
									countries.ready = true;
									mo.fn.overlay.hide();
							});
					}
			},
			_ui: function() {
					// TABS
					if (document.querySelector("#countries .tabs") == null)
							document.querySelector("#countries").innerHTML += '<section class="tabs"></div>';
					if (document.querySelector("#countries .container") == null)
							document.querySelector("#countries").innerHTML += '<section class="container"></div>';
					document.querySelector("#countries .tabs").innerHTML += '<span tab-id="country" class="active">Countries</span>';
					document.querySelector("#countries .container").innerHTML += '<section tab-id="country" class="active"><div class="grid"></div></section>';
					// ADD REFRESH
					document.querySelector("#countries").innerHTML += '<span class="refresh"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="refresh" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M20,8 C18.5974037,5.04031171 15.536972,3 12,3 C7.02943725,3 3,7.02943725 3,12 C3,16.9705627 7.02943725,21 12,21 L12,21 C16.9705627,21 21,16.9705627 21,12 M21,3 L21,9 L15,9"></path></svg></span>';
					document.querySelector("#countries span.refresh").addEventListener("click", countries._refresh);
			},
			_refresh: function() {
					var g = $("#countries .grid").data("kendoGrid");
					var s = g.dataSource.pageSize();
					var p = g.dataSource.page();
					document.querySelector("#countries").innerHTML = "";
					countries.ready = false;
					countries._init();
					g = $("#countries .grid").data("kendoGrid");
					g.dataSource.pageSize(s);
					g.dataSource.page(p);
			},
			_softRefresh: function() {
					var g = $("#countries .grid").data("kendoGrid");
					var s = g.dataSource.pageSize();
					var p = g.dataSource.page();
					document.querySelector("#countries").innerHTML = "";
					countries._ui();
					countries.grid._load("#countries .grid", countries.data, countries.grid._config());
					g = $("#countries .grid").data("kendoGrid");
					g.dataSource.pageSize(s);
					g.dataSource.page(p);
			},
			_getData: function(callback) {
					bigd.r.cnt.all(function(d) {
							countries.data = d.Data;
							if (typeof(callback) === "function") callback();
					});
			},
			_modal: function(data) {
					var ctalabel = "SAVE";
					var modtitle = "Edit country configuration";
					mo.fn.modal.show({
							ctaLabel: ctalabel,
							title: modtitle,
							content: '<div class="nbsf" style="overflow:hidden;padding-bottom:10px;max-width:100%"><div class="tabs"></div><div class="container"></div></div>',
							contentCallback: function() {
									var target = document.querySelector(".dxpModalContent .nbsf");
									var tabs = target.querySelector(".tabs");
									var container = target.querySelector(".container");

									//// ADD TABS
									tabs.innerHTML += '<span tab-id="geography" class="active">Country setup</span>';
									container.innerHTML += '<div tab-id="geography" class="active"></div>';

									//// ADD FIELDSETS
									container.querySelector("div[tab-id=geography]").innerHTML = '<div class="row">' +
											'<fieldset>' +
											'<label class="wrapper text" style="display:block;">' +
											'<span class="name">Country</span><span class="required">*</span>' +
											'<div class="fmmcosmin">' +
											'<input type="text" value="" placeholder="" data-name="Country" disabled>' +
											'</div>' +
											'</label>' +
											'<label class="wrapper text" style="display:block;">' +
											'<span class="name">Region</span><span class="required">*</span>' +
											'<div class="fmmcosmin">' +
											'<select data-name="Region" disabled>' +
											'</select>' +
											'</div>' +
											'</label>' +
											'<label class="wrapper text" style="display:block;">' +
											'<span class="name">Sub-Region</span><span class="required">*</span>' +
											'<div class="fmmcosmin">' +
											'<select data-name="SubRegion" disabled>' +
											'</select>' +
											'</div>' +
											'</label>' +
											'<label class="wrapper text" style="display:block;">' +
											'<span class="name">GEO</span><span class="required">*</span>' +
											'<div class="fmmcosmin">' +
											'<select data-name="Country_GEO" disabled>' +
											'</select>' +
											'</div>' +
											'</label>' +
											'<label class="wrapper text" style="display:block;">' +
											'<span class="name">Accepted currencies (comma delimited)</span>' +
											'<div class="fmmcosmin">' +
											'<input type="text" value="" placeholder="" data-name="Country_Currencies">' +
											'</div>' +
											'</label>' +
											'</fieldset>' +
											'</div>';

									//// POPULATE AVAILABLE OPTIONS
									var regArr = [],
											srgArr = [],
											geoArr = [];
									for (i = 0; i < countries.data.length; i++) {
											var row = countries.data[i];
											if (regArr.indexOf(row.Region) == -1) regArr.push(row.Region);
											if (srgArr.indexOf(row.SubRegion) == -1) srgArr.push(row.SubRegion);
											if (geoArr.indexOf(row.Country_GEO) == -1) geoArr.push(row.Country_GEO);
									}
									for (i = 0; i < regArr.length; i++)
											container.querySelector("select[data-name=Region]").innerHTML += '<option value="' + regArr[i] + '">' + regArr[i] + '</option>';
									for (i = 0; i < srgArr.length; i++)
											container.querySelector("select[data-name=SubRegion]").innerHTML += '<option value="' + srgArr[i] + '">' + srgArr[i] + '</option>';
									for (i = 0; i < geoArr.length; i++)
											container.querySelector("select[data-name=Country_GEO]").innerHTML += '<option value="' + geoArr[i] + '">' + geoArr[i] + '</option>';

									//// CURRENT VALUES
									container.querySelector("input[data-name=Country]").value = data.Country;
									container.querySelector("select[data-name=Region]").value = data.Region;
									container.querySelector("select[data-name=SubRegion]").value = data.SubRegion;
									container.querySelector("select[data-name=Country_GEO]").value = data.Country_GEO;
									container.querySelector("input[data-name=Country_Currencies]").value = data.Country_Currencies;

									//// FUNCTIONALITY
									// TABS
									var allt = tabs.querySelectorAll("span");
									var allc = container.querySelectorAll("div[tab-id]");

									function hideAll() {
											for (i = 0; i < allt.length; i++)
													allt[i].setAttribute("class", "");
											for (i = 0; i < allc.length; i++)
													allc[i].setAttribute("class", "");
									}
									for (i = 0; i < allt.length; i++) {
											allt[i].addEventListener("click", function(e) {
													var tabid = e.target.getAttribute("tab-id");
													hideAll();
													e.target.classList.add("active");
													container.querySelector("div[tab-id=" + tabid + "]").classList.add("active");
											});
									}
									// TOGGLES
									var alltog = container.querySelectorAll("div.toggle");
									for (i = 0; i < alltog.length; i++) {
											alltog[i].addEventListener("click", function(e) {
													var el = e.target.closest("label");
													el.classList.toggle("active");
													if (el.getAttribute("class") == "active") el.querySelector("input").value = "Y";
													else el.querySelector("input").value = "N";
											});
									}

									//// CLOSE MODAL
									mo.fn.overlay.show({
											close: false
									})
							},
							ctaCallback: function() {
									// HELPERS
									var sel = document.querySelector(".dxpModalContent");
									var def = {
											Country_Currencies: ""
									}
									var iss = [];
									var all = ["Country_Currencies"];
									for (i = 0; i < Object.keys(def).length; i++) {
											var key = Object.keys(def)[i];
											var input = sel.querySelector("*[data-name=" + key + "]");
											def[key] = input.value;
									}

									//// SUBMIT
									if (iss.length > 0) {
											for (i = 0; i < iss.length; i++)
													sel.querySelector("*[data-name=" + iss[i] + "]").closest("label.wrapper").setAttribute("data-state", "error");
											mo.fn.modal.msg("Invalid configuration. Please check the highlighted fields and attempt to submit again after resolving the issues or conflicts.", 3);
									} else {
											// UPDATE DATABASE
											mo.fn.modal.lock();
											var eid = data.EntryId;
											crud.update("3347", eid, def, function(d) {
													if (typeof(d.EntryId) !== "undefined") {
															mo.fn.modal.msg("Country configuration was updated successfully.", 1);
															// PUSH TO DATA AND REFRESH
															for (i = 0; i < countries.data.length; i++) {
																	if (countries.data[i].EntryId == d.EntryId) {
																			countries.data[i] = d;
																			countries._softRefresh();
																			break;
																	}
															}
															mo.fn.modal.unlock();
													} else {
															mo.fn.modal.msg("An error occured when writing to the database. Please try again later.", 3);
															mo.fn.modal.unlock();
													}
											});
									}
							}
					});
			},
			grid: {
					_custom: function() {
							var cusConfig = [{
											field: "Country",
											title: "Country",
											hidden: false,
											filterable: true
									},
									{
											field: "Region",
											title: "Key groups",
											hidden: false,
											filterable: true
									},
									{
											field: "SubRegion",
											title: "Sub-region",
											hidden: false,
											filterable: true
									},
									{
											field: "Country_GEO",
											title: "Geography",
											hidden: false,
											filterable: true
									},
									{
											field: "Country_Eligible",
											title: "Eligibility",
											hidden: false,
											filterable: true
									},
									{
											field: "Country_MAP",
											title: "MAP",
											hidden: false,
											filterable: true
									},
									{
											field: "Country_Currencies",
											title: "Currency",
											hidden: false,
											filterable: false
									},
									{
											title: "",
											width: "40px",
											locked: true,
											attributes: {
													"class": "cta"
											},
											template: function(d) {
													var icons = '<a class="edit"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="copy"><path fill="none" stroke="#666" stroke-width="2" d="M14,4 L20,10 L14,4 Z M22.2942268,5.29422684 C22.6840146,5.68401459 22.6812861,6.3187139 22.2864907,6.71350932 L9,20 L2,22 L4,15 L17.2864907,1.71350932 C17.680551,1.319449 18.3127724,1.31277239 18.7057732,1.70577316 L22.2942268,5.29422684 Z M3,19 L5,21 M7,17 L15,9"></path></svg></a>';
													return icons;
											}
									}
							];
							return cusConfig;
					},
					_default: function() {
							var defConfig = [];
							for (i = 0; i < Object.keys(countries.data[0]).length; i++) {
									var key = Object.keys(countries.data[0])[i];
									var obj = {};
									obj.field = key;
									obj.title = key;
									obj.hidden = true;
									defConfig.push(obj);
							}
							return defConfig;
					},
					_config: function() {
							var cusConfig = countries.grid._custom();
							var defConfig = countries.grid._default();
							for (j = cusConfig.length - 1; j >= 0; j--) {
									for (i = 0; i < defConfig.length; i++) {
											if (defConfig[i].field == cusConfig[j].field) {
													defConfig.splice(i, 1);
													break;
											}
									}
							}
							for (i = cusConfig.length - 1; i >= 0; i--) {
									defConfig.unshift(cusConfig[i]);
							}
							return defConfig;
					},
					_load: function(selector, datasource, config) {
							$(selector).kendoGrid({
									dataSource: {
											data: datasource,
											sort: {
													field: "EntryId",
													dir: "asc"
											}
									},
									columns: config,
									dataBound: function(e) {},
									pageable: {
											buttonCount: 4,
											pageSize: 10,
											pageSizes: [10, 25, 50, 100],
											messages: {
													itemsPerPage: ""
											}
									},
									scrollable: false,
									sortable: true,
									filterable: true
							});
							$(selector).delegate(".edit", "click", function(e) {
									var grid = $(selector).data("kendoGrid");
									var row = grid.dataItem($(this).closest("tr"));
									countries._modal(row);
							});
					}
			}
	}
</script>
<!-- COMPONENT CLOSED -->
<script>
	const closed = {
			ready: false,
			rejectedReady: false,
			data: {},
			_init: function() {
					// if (!closed.ready) {
					mo.fn.overlay.show({
							loading: true,
							close: false
					});
					let self = this;
					closed.rejectedReady = false;
					crud.read("3180", "eid=5415", function(d) {
							self.sample = d.Rows[0];
							closed._ui();
							closed._getCount();
							closed._loadGrids();
							closed.ready = true;
							mo.fn.overlay.hide();
					});

					// }
			},
			_ui: function(cb) {
					// CLEAR IF ANY EXISTING
					document.querySelector("#closed").innerHTML = "";
					// ADD WRAPPERS
					document.querySelector("#closed").innerHTML += '<section class="tabs"></div>';
					document.querySelector("#closed").innerHTML += '<section class="container"></div>';
					// ADD TABS AND CONTAINERS
					document.querySelector("#closed .tabs").innerHTML += '<span tab-id="approved">Completed (<em>0</em>)</span>';
					document.querySelector("#closed .container").innerHTML += '<section tab-id="approved"><div class="grid"></div><div class="toolbar"></div></section>';
					document.querySelector("#closed .tabs").innerHTML += '<span tab-id="rejected">Cancelled (<em>0</em>)</span>';
					document.querySelector("#closed .container").innerHTML += '<section tab-id="rejected"><div class="grid"></div><div class="toolbar"></div></section>';
					// ADD REFRESH
					document.querySelector("#closed").innerHTML += '<span class="refresh"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="refresh" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M20,8 C18.5974037,5.04031171 15.536972,3 12,3 C7.02943725,3 3,7.02943725 3,12 C3,16.9705627 7.02943725,21 12,21 L12,21 C16.9705627,21 21,16.9705627 21,12 M21,3 L21,9 L15,9"></path></svg></span>';
					// ADD TAB ON CLICK
					var tabs = document.querySelectorAll("#closed .tabs span");
					var sections = document.querySelectorAll("#closed .container section");
					for (i = 0; i < tabs.length; i++) {
							tabs[i].addEventListener("click", function(e) {
									// RESET ALL TABS
									for (i = 0; i < tabs.length; i++)
											tabs[i].setAttribute("class", "");
									// RESET ALL SECTIONS
									for (i = 0; i < sections.length; i++)
											sections[i].setAttribute("class", "");
									// ENABLE REQUESTED SECTION
									var cid = e.target.getAttribute("tab-id") || e.target.closest("span").getAttribute("tab-id");
									document.querySelector("#closed span[tab-id=" + cid + "]").classList.add("active");
									document.querySelector("#closed section[tab-id=" + cid + "]").classList.add("active");

									if (cid === 'rejected' && !closed.rejectedReady) {
											const rejectedGrid = document.querySelector("#closed section[tab-id=rejected] .grid");
											rejectedGrid.innerHTML = "";

											closed.grid._load("#closed section[tab-id=rejected] .grid", closed.grid._datasource({
													field: "Status",
													operator: "eq",
													value: "5"
											}));
											closed.rejectedReady = true;
									}
							});
					}
					// DEFAULT TO FIRST TAB
					document.querySelector("#closed .tabs span").click();
					// ADD REFRESH EVENT
					document.querySelector("#closed span.refresh").addEventListener("click", closed._refresh);
					// CALLBACK
					if (typeof(cb) === "function") return cb();
					else return true;
			},
			_getCount: function() {
					var approveds = closed.grid._datasource({
							field: "Status",
							operator: "eq",
							value: "3"
					})
					approveds.fetch(function() {
							document.querySelector("#closed .tabs span[tab-id=approved] em").innerText = approveds.total();
					});
					var rejectds = closed.grid._datasource({
							field: "Status",
							operator: "eq",
							value: "5"
					})
					rejectds.fetch(function() {
							document.querySelector("#closed .tabs span[tab-id=rejected] em").innerText = rejectds.total();
					});
			},
			_refresh: function() {
					mo.fn.overlay.show({
							loading: true,
							close: false
					});
					var grids = document.querySelectorAll("#closed .grid , #closed .toolbar");
					for (i = 0; i < grids.length; i++)
							grids[i].innerHTML = "";
					let self = this
					crud.read("3180", "eid=5415", function(d) {
							self.sample = d.Rows[0];
							closed._ui();
							closed._getCount();
							closed._loadGrids();
							closed.ready = true;
							closed.rejectedReady = false;
							mo.fn.overlay.hide();
					});

			},
			_loadGrids: function() {
					// KENDO GRID HAS SOME ITERATION IN IT AND IT CONFLICTS WITH I,J,K AS INDEX VARIABLE; USE INDEX AS VARIABLE
					closed.grid._load("#closed section[tab-id=approved] .grid", closed.grid._datasource({
							field: "Status",
							operator: "eq",
							value: "3"
					}));
					closed.grid._load("#closed section[tab-id=rejected] .grid", closed.grid._datasource({
							field: "Status",
							operator: "eq",
							value: "5"
					}));
					/*for (index = 0; index < Object.keys(closed.data).length; index++) {
							var key = Object.keys(closed.data)[index];
							
					}*/
			},
			grid: {
					_custom: function() {
							var cusConfig = [{
											field: "EntryId",
											title: "ID",
											filterable: true,
											locked: true,
											width: "100px"
									},
									{
											field: "PO_BackgroundGroup",
											title: "BG",
											filterable: true,
											width: 90,
									},
									{
											field: "Region",
											title: "Region",
											filterable: true,
											width: 115,
									},
									{
											field: "Geo",
											title: "Geo",
											filterable: true,
											width: 110,
									},
									{
											field: "SoldTo_Address_Country",
											title: "Country",
											filterable: true,
											width: 120,
									},
									{
											field: "SoldTo_CompanyName",
											title: "SoldTo CompanyName",
											filterable: true,
											width: 215,
									},
									{
											field: "PartyId",
											title: "PartyId",
											filterable: true,
											width: 120,
									},
									{
											field: "PO_Number",
											title: "PO",
											filterable: true,
											width: 110,
									},
									/*{
											field: "PO_Value",
											title: "Value",
											filterable: false,
											template: function(d) {
													return d.PO_Value + " " + d.PO_Currency;
											}
									},*/
									{
											field: "PO_Order_ID",
											title: "Order #",
											filterable: true,
											width: 120,
											template: function(d) {
													if (d.PO_Order_ID == null || d.PO_Order_ID == "NA" || d.PO_Order_ID.length == 0) {
							if (d.PO_AAS_ID == null || d.PO_AAS_ID == "NA" || d.PO_AAS_ID.length == 0) {
															return "N/A";
							} else {
															return d.PO_AAS_ID;
							}
						}
													else
															return d.PO_Order_ID;
											}
									},
									{
											field: "SubmittedTimestamp",
											title: "Date",
											filterable: false,
											width: 100,
											template: function(d) {
													try {
															return d.SubmittedTimestamp.split("T")[0];
													} catch (err) {
															return d.SubmittedTimestamp;
													}
											}
									},
									{
											field: "CaseNumber",
											title: "Case Number",
											filterable: true,
											width: 155,
									},
									{
											title: "",
											width: "60px",
											attributes: {
													"class": "cta"
											},
											locked: true,
											template: function(d) {
													var icons = `<a class="sfdc" style="display: none;">
							<svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="ticket" width="24px" height="24px">
								<path fill="none" stroke="#666" stroke-width="2" d="M7,16 L17,16 L17,8 L7,8 L7,16 Z M20,12 C20,14 21,15 23,15 L23,20 L1,20 L1,15 C3,15 4,14 4,12 C4,10 3,9 1,9 L1,4 L23,4 L23,9 C21,9 20,10 20,12 Z">
								</path>
							</svg>
						</a>
						<a class="view">
							<svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit">
									<path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z">
									</path>
							</svg>
							</a>`;
													return icons;
											}
									}
							];
							return cusConfig;
					},
					_default: function() {
							var defConfig = [];
							var sampleRow = closed.sample;
							for (i = 0; i < Object.keys(sampleRow).length; i++) {
									var key = Object.keys(sampleRow)[i];
									var obj = {};
									obj.field = key;
									obj.title = key;
									obj.hidden = false;
									obj.filterable = false;
									obj.attributes = {
											style: "display:none!important"
									};
									obj.headerAttributes = {
											style: "display:none!important"
									};
									defConfig.push(obj);
							}
							return defConfig;
					},
					_config: function() {
							var cusConfig = closed.grid._custom();
							var defConfig = closed.grid._default();
							for (j = cusConfig.length - 1; j >= 0; j--) {
									for (i = 0; i < defConfig.length; i++) {
											if (defConfig[i].field == cusConfig[j].field) {
													defConfig.splice(i, 1);
													break;
											}
									}
							}
							for (i = cusConfig.length - 1; i >= 0; i--) {
									defConfig.unshift(cusConfig[i]);
							}
							return defConfig;
					},
					_load: function(selector, datasource) {
							var parent = document.querySelector(selector.split(" .grid")[0]);
							let config = this._config();
							//console.log(config.sort());
							$(selector).kendoGrid({
									toolbar: [{
											name: "excel",
											text: "Download"
									}],
									excel: {
											fileName: "NOR_Closed_" + parent.getAttribute("tab-id") + "_" + new Date().getTime() + ".xlsx",
											filterable: true,
											allPages: true
									},
									dataSource: datasource,
									columns: config,
									dataBound: function(e) {},
									pageable: {
											buttonCount: 4,
											pageSize: 10,
											pageSizes: [10, 25, 50, 100],
											messages: {
													itemsPerPage: ""
											}
									},
									scrollable: true,
									sortable: true,
									filterable: true
							});
							$(selector).delegate(".view", "click", function(e) {
									var grid = $(selector).data("kendoGrid");
									var row = grid.dataItem($(this).closest("tr"));
									review._init(row.EntryId);
							});
							$(selector).delegate(".sfdc", "click", function(e) {
									var grid = $(selector).data("kendoGrid");
									var row = grid.dataItem($(this).closest("tr"));
									sfdc.init(row.EntryId);
							});

							if (parent.getAttribute("tab-id") === 'rejected' && document.querySelector(selector.split(" .grid")[0] + ' .toolbar .k-grid-toolbar')) {
									$(selector + ' .k-grid-toolbar').hide();
							} else {
									$(selector + ' .k-grid-toolbar').appendTo(selector.split(" .grid")[0] + ' .toolbar');
									var exportFlag = false;
									$(selector).data("kendoGrid").bind("excelExport", function(e) {
											if (!exportFlag) {
													e.preventDefault();
													exportFlag = true;
													mo.fn.overlay.show({
															loading: true,
															close: false
													});
													setTimeout(function() {
															e.sender.saveAsExcel();
													}, 1500);
											} else {
													exportFlag = false;
													setTimeout(function() {
															mo.fn.overlay.hide();
													}, 500);
											}
									});
							}
					},
					_datasource: function(filter) {
							return new kendo.data.DataSource({
									type: "rfb-v2",
									transport: {
											read: {
													//   url: "/form/data-set-provider/v2/989/NOR_Full/kendo/data"
													url: "/form/data-set-provider/v2/989/NOR_Data_List/kendo/data"
											}
									},
									schema: {
											model: {
													id: "EntryId",
											}
									},
									filter: filter,
									serverPaging: true,
									pageSize: 10,
									serverFiltering: true,
									serverSorting: true,
							});
					}

			}
	}
</script>
<!-- COMPONENT SFDC MODAL -->
<script>
	const sfdc = {
			init: function(eid, component) {
					this.modal(eid);
					this.grid.init(document.querySelector(".sfdc-grid"), eid, component);
			},
			modal: function(eid) {
					mo.fn.modal.show({
							title: "Showing SFDC executions for NOR ID " + eid,
							content: "<div class='sfdc-grid'></div><div class='sfdc-toolbar'></div><style></style>",
							ctaLabel: "OK",
							width: 70
					});
			},
			grid: {
					init: function(node, eid, component) {
							$(node).kendoGrid({
									toolbar: (component === 'tibcoErrors') ? "<button class='k-button' onclick='sfdc.retrigger(" + eid + ")'>Retrigger SFDC</button>" : null,
									dataSource: this.dataset(eid),
									columns: this.columns(),
									dataBound: function(e) {},
									pageable: {
											buttonCount: 4,
											pageSize: 15,
											pageSizes: [15, 25, 50, 100],
											messages: {
													itemsPerPage: ""
											}
									},
									scrollable: false,
									sortable: true,
									filterable: true
							});

							$(node).find(".k-grid-toolbar").appendTo($(document.querySelector(".sfdc-toolbar")));
					},
					columns: function() {
							return [{
											field: "Status",
											title: "Status",
											filter: true
									},
									{
											field: "SendingAttempts",
											title: "Attempts",
											filter: true
									},
									{
											field: "CreatedAt",
											title: "Created",
											template: function(d) {
													const date = d.CreatedAt;
													if (date) {
															let formatedDate = date.getFullYear() + '-' + ("00" + (date.getMonth() + 1)).slice(-2) + '-' + ("00" + date.getDate()).slice(-2);
															let h = ("00" + date.getHours()).slice(-2);
															let m = ("00" + date.getMinutes()).slice(-2);
															let timeOfDay = [h, m].join(':');

															return `${formatedDate} ${timeOfDay}`;
													}
													return '';
											},
									},
									{
											field: "CompletedAt",
											title: "Completed",
											template: function(d) {
													const date = d.CompletedAt;
													if (date) {
															let formatedDate = date.getFullYear() + '-' + ("00" + (date.getMonth() + 1)).slice(-2) + '-' + ("00" + date.getDate()).slice(-2);
															let h = ("00" + date.getHours()).slice(-2);
															let m = ("00" + date.getMinutes()).slice(-2);
															let timeOfDay = [h, m].join(':');

															return `${formatedDate} ${timeOfDay}`;
													}
													return '';
											},
									},
									{
											//   field: "SuccessResult",
											field: "Response",
											title: "Response",
											filter: true
									}
							]
					},
					dataset: function(eid) {
							return new kendo.data.DataSource({
									type: "rfb-v2",
									transport: {
											read: {
													//   url: "/form/data-set-provider/v2/989/SFDC_Queue/kendo/data/search",
													url: "/form/data-set-provider/v2/989/Modified_Response_SFDC_Queue/kendo/data/search",
													type: "POST"
											}
									},
									schema: {
											model: {
													id: "EntryId",
													fields: {
															CreatedAt: {
																	type: "date"
															},
															CompletedAt: {
																	type: "date"
															},
													}
											}
									},
									serverPaging: true,
									pageSize: 15,
									/* set page size*/
									serverFiltering: true,
									filter: {
											logic: "and",
											filters: [{
															field: "SourceFormId",
															operator: "eq",
															value: "989"
													},
													{
															field: "SourceEntryId",
															operator: "eq",
															value: eid
													}
											]
									},
									serverSorting: true,
									sort: {
											field: "CreatedAt",
											dir: "desc"
									}
							});
					}
			},
			retrigger: function(eid) {
					let self = this;
					mo.fn.modal.lock();
					crud.update('3158', eid, {
							Workflow: "1"
					}, function(d) {
							mo.fn.modal.unlock();
							if (!d || !d.EntryId)
									return mo.fn.modal.msg('Failed to execute update to retrigger SFDC case', 3);
							return self.init(eid);
					});
			}
	}
</script>
<!-- COMPONENT REPORTING -->
<script>
	const reporting = {
			ready: false,
			node: null,
			changed: false,
			dragging: null,
			public: false,
			draftQuery: null,
			//  groupList: [],
			useGrouping: false,
			data: {},
			_auth: function() {
					var arr = ["ADMIN", "STAT"];
					for (i = 0; i < arr.length; i++) {
							if (applet._getAuth(arr[i])) {
									return true;
									break;
							} else if (i == arr.length - 1) return false;
					}
			},
			_init: function() {
					if (!reporting.ready) {
							mo.fn.overlay.show({
									loading: true,
									close: false
							});
							//	const self = this;

							reporting.selectorSection.queryList.selectedQuery = null;
							reporting.fieldSection.scEditor.selectedTable = null;
							const selector = document.querySelector("#reporting");
							reporting.node = selector;
							reporting.changed = false;
							reporting.dragging = null;
							reporting.public = false;
							reporting.draftQuery = null;
							reporting.selectorSection.queryList.useFilter = false;
							//	reporting.groupList = [];
							reporting.useGrouping = false;


							if (!reporting._auth()) {
									selector.setAttribute("data-loaded", "true");
									ui.message.open("You do not have permission to access this section. Please request additional access if required or reach out to someone that has access to this functionality.", 3, 10);
									mo.fn.overlay.hide();
							} else {
									//	reporting.grid._load("#reporting .grid");
									reporting.ready = true;



									selector.innerHTML = "<div id='query-selector'>" +
											"<div id='query-selector-options'>" +
											"<span>Show only my queries</span>" +
											"<label class='switch'>" +
											"<input type='checkbox' id='query-filter-toggle'>" +
											"<span class='slider'></span>" +
											"</label>" +
											"<div id='query-selector-buttons'>" +
											"<button id='query-selector-create'>Create a new one</button>" +
											"</div>" +
											"</div>" +
											"<div id='query-selctor-dropdown'>" +
											"<div id='query-selector-table'></div>" +
											"</div>" +
											"</div>" +
											"<div id='query-builder' class='hidden'>" +
											"<div id='query-filter-block'>" +
											"<div id='query-builder-query-info' style='visibility:hidden'>" +
											"<div id='query-builder-query-block'>" +
											"<span>Public</span>" +
											"<label class='switch'>" +
											"<input type='checkbox' id='query-public-toggle'>" +
											"<span class='slider'></span>" +
											"</label>" +
											"</div>" +
											"</div>" +
											"<div id='query-builder-save-section'>" +
											"<label>" +
											"Query name" +
											"<input type='text' id='query-name' placeholder='please input the query name'>" +
											"</label>" +
											"<div id='query-builder-save-buttons'></div>" +
											"</div>" +
											"</div>" +
											"<div id='query-column-selector'></div>" +
											"<h3>Filter</h3>" +
											"<div id='query-filter-section' class='query-filter-builder'></div>" +
											"<div class='query-preview'>" +
											"</div>" +
											"</div>";
									reporting.reference.init(function() {
											mo.fn.overlay.hide();
											reporting.selectorSection.init();
									});

							}
							//	mo.fn.overlay.hide();

					}
			},
			selectorSection: {
					init: function() {
							reporting.selectorSection.queryList.init(false);
							reporting.selectorSection.createButtonInit();
							reporting.selectorSection.filterToggleInit();
							reporting.selectorSection.publicToggleInit();
					},
					reload: function() {
							var holder = document.getElementById('query-builder');
							holder.className = 'visible';
							reporting.fieldSection.init();
							reporting.filterSection.init();
							reporting.previewSection.init();
							reporting.changed = false;
					},
					queryList: {
							data: [],
							useFilter: false,
							selectedQuery: null,
							init: function(preventReset) {
									var input = document.getElementById("query-name");
									if (!preventReset) {
											input.value = "";
											reporting.public = false;
											document.getElementById("query-public-toggle").checked = false;
											document.getElementById("query-builder-query-info").style = 'visibility:hidden';
									}
									var table = document.getElementById("query-selector-table");
									table.innerHTML = '';
									$(table).kendoGrid({
											height: 350,
											noRecords: {
													template: "<div style='margin-top:100px; text-align: center'> No data available </div>"
											},
											dataSource: reporting.selectorSection.queryList.dataSet(),
											columns: [{
															field: "EntryId",
															title: "ID",
															hidden: false,
															width: "110px",
															filterable: true,
													},
													{
															field: "QueryName",
															title: "Query Name",
															hidden: false,
															width: "200px",
															filterable: true,
													},
													{
															field: "Public",
															title: "Public",
															hidden: false,
															width: "100px",
															template: function(data) {
																	return data.Public == 1 ? "Y" : "N";
															},
															filterable: false,
													},
													{
															field: "Email",
															title: "Author",
															hidden: false,
															width: "180px",
															filterable: false,
													},
													{
															field: "Modified",
															title: "Last Update",
															hidden: false,
															template: function(data) {
																	if (!data.Modified)
																			return "";
																	var d = new Date();
																	var date = new Date(new Date(data.Modified) - new Date(d.getTimezoneOffset() * 60 * 1000)).toLocaleString();
																	date = date.replace(",", "") || "-";
																	return date;
															},
															width: "170px",
															filterable: true,
													},
													{
															title: "Actions",
															width: "100px",
															attributes: {
																	"class": "cta"
															},
															template: function(d) {
																	var icons = '';
																	if (d.Email === "[SSOData.Email]" || d.Public === 1)
																			icons += '<a style="margin-right: 5px" class="query-selector-table-view"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path></svg></a>';
																	if (d.Email === "[SSOData.Email]")
																			icons += '<a style="margin-right: 5px" class="query-selector-table-remove"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="form-trash" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M7.5,9 L16.5,9 L16.5,19 L7.5,19 L7.5,9 Z M5,9 L19,9 M9.36363636,6 L14.3636364,6 L14.3636364,9 L9.36363636,9 L9.36363636,6 Z M10.5455,11 L10.5455,17 M13.5455,11 L13.5455,17"></path></svg><a>';

																	const expirationDate = new Date(d.Expire);
																	const currentDate = new Date();
																	if (d.Path && currentDate < expirationDate && (d.Email === "[SSOData.Email]" || d.Public === 1))
																			icons += '<a style="margin-right: 5px" class="query-selector-table-download"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="download" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M1,17 L1,23 L23,23 L23,17 M12,2 L12,19 M5,12 L12,19 L19,12"></path></svg><a>';
																	return icons;
															},
															sortable: false,
													}
											],
											pageable: {
													buttonCount: 3,
													pageSize: 5,
													pageSizes: [5, 10, 20],
													messages: {
															itemsPerPage: ""
													},
													refresh: true
											},
											filterable: true,
											scrollable: true,
											resizable: true,
											selectable: true,
											sortable: true,
									});

									$(table).delegate('.query-selector-table-download', 'click', function(ev) {
											var grid = $(table).data("kendoGrid");
											var el = grid.dataItem($(this).closest("tr"));

											if (!!el) {
													const aLink = document.createElement("a");
													aLink.setAttribute("target", "_self");
													aLink.innerHTML = el.Filename;
													aLink.setAttribute("href", el.Path);
													aLink.click();
											}
									});

									$(table).delegate('.query-selector-table-view', 'click', function(ev) {
											var grid = $(table).data("kendoGrid");
											var el = grid.dataItem($(this).closest("tr"));
											var fn = function() {
													if (!!el) {
															reporting.selectorSection.queryList.selectedQuery = el;
															var name = document.getElementById('query-name');
															name.value = el.QueryName;
															reporting.public = !!el.Public;
															reporting.dragging = null;
															reporting.draftQuery = null;
															//	reporting.groupList = [];
															reporting.useGrouping = false;
															document.getElementById("query-public-toggle").checked = !!el.Public;
															document.getElementById("query-builder-query-info").style = '';
															reporting.selectorSection.buttonListInit(false);
															reporting.selectorSection.reload();
															reporting.changed = false;

															var btn = document.getElementById('query-selector-update');
															btn.disabled = "[SSOData.Email]" !== el.Email;
															var scrollDiv = document.getElementById("query-filter-block").offsetTop;
															window.scrollTo({
																	top: scrollDiv,
																	behavior: 'smooth'
															});
													}
											};
											console.log('reporting.changed', reporting.changed);
											if (!!reporting.draftQuery || reporting.changed) {
													reporting.unsavedProgress.init(fn);
											} else {
													fn();
											}
									});

									$(table).delegate('.query-selector-table-remove', 'click', function(ev) {
											var grid = $(table).data("kendoGrid");
											var el = grid.dataItem($(this).closest("tr"));

											var callback = function() {
													var fn = function() {
															if (!!el) {
																	if ("[SSOData.Email]" !== el.Email) {
																			mo.fn.modal.show({
																					ctaLabel: "Close",
																					class: "query-error-window",
																					title: "Error",
																					content: "<div>Unable to delete a query, created by another user!</div>",
																			});
																			return;
																	}
																	var cb = function() {
																			if (!!reporting.selectorSection.queryList.selectedQuery && reporting.selectorSection.queryList.selectedQuery.EntryId === el.EntryId) {
																					reporting.selectorSection.queryList.selectedQuery = null;
																			}
																			mo.fn.overlay.show({
																					loading: true,
																					close: false
																			});
																			var holder = document.getElementById('query-builder');
																			holder.className = 'hidden';

																			crud.destroy("5052", el.EntryId, function(d) {
																					mo.fn.overlay.hide();
																					reporting.selectorSection.queryList.init(false);
																					reporting.changed = false;
																			});
																	};
																	reporting.checkReport(el.EntryId, cb);
															}
													};
													if (!!reporting.draftQuery || reporting.changed) {
															reporting.unsavedProgress.init(fn);
													} else {
															fn();
													}
											};
											mo.fn.modal.show({
													close: true,
													ctaLabel: "Yes",
													closeLabel: "No",
													title: "Warning",
													content: '<div>Query ' + el.QueryName + ' will be deleted permanently. Are you sure?</div>',
													ctaCallback: function() {
															mo.fn.modal.hide();
															callback();
													}
											});
									});

									if (!!reporting.selectorSection.queryList.selectedQuery) {
											var el = reporting.selectorSection.queryList.selectedQuery;
											var name = document.getElementById('query-name');
											name.value = el.QueryName;
											reporting.public = !!el.Public;
											reporting.dragging = null;
											reporting.draftQuery = null;
											reporting.useGrouping = false;
											document.getElementById("query-public-toggle").checked = !!el.Public;
											document.getElementById("query-builder-query-info").style = '';
											reporting.selectorSection.buttonListInit(false);
											reporting.selectorSection.reload();
											reporting.changed = false;

											var btn = document.getElementById('query-selector-update');
											btn.disabled = "[SSOData.Email]" !== el.Email;
									}
							},
							loadData: function(callback) {
									var ds = reporting.selectorSection.queryList.dataSet();

									ds.read().then(function() {
											var data = ds.view();
											reporting.selectorSection.queryList.data = data;
											callback();
									});
							},
							dataSet: function() {
									var filter = {};
									if (reporting.selectorSection.queryList.useFilter) {
											filter = {
													logic: "and",
													filters: [{
																	field: 'Email',
																	operator: 'eq',
																	value: "[SSOData.Email]"
															},
															{
																	field: 'Draft',
																	operator: 'neq',
																	value: 1
															}
													]
											};
									} else {
											filter = {
													logic: "and",
													filters: [{
																	logic: "or",
																	filters: [{
																					field: 'Email',
																					operator: 'eq',
																					value: "[SSOData.Email]"
																			},
																			{
																					field: 'Public',
																					operator: 'eq',
																					value: 1
																			}
																	]
															},
															{
																	field: 'Draft',
																	operator: 'neq',
																	value: 1
															}
													]
											};
									}
									var ds = new kendo.data.DataSource({
											type: "rfb-v2",
											transport: {
													read: {
															url: "https://hpe-rfb.it.hpe.com/form/data-set-provider/v2/1676/NOR_Report_Templates_View/kendo/data/search",
															type: 'POST'
													},
											},
											schema: {
													model: {
															id: "EntryId",
															fields: {
																	//  Modified: { type: "date" },
															}
													}
											},
											serverFiltering: true,
											filter: filter,
											serverSorting: true,
											sort: {
													field: "EntryId",
													dir: "desc"
											},
											serverPaging: true,
											pageSize: 5
									});
									return ds;
							},
					},
					createButtonInit: function() {
							var button = document.getElementById('query-selector-create');
							button.addEventListener('click', function() {
									var fn = function() {
											reporting.selectorSection.queryList.selectedQuery = null;
											var name = document.getElementById('query-name');
											name.value = '';
											reporting.public = false;
											reporting.dragging = null;
											reporting.draftQuery = null;
											//	reporting.groupList = [];
											reporting.useGrouping = false;
											document.getElementById("query-public-toggle").checked = false;
											document.getElementById("query-builder-query-info").style = '';
											reporting.selectorSection.buttonListInit(true);
											reporting.selectorSection.reload();
											reporting.changed = false;
									};

									if (!!reporting.draftQuery || reporting.changed) {
											reporting.unsavedProgress.init(fn);
									} else {
											fn();
									}
							});
					},
					buttonListInit: function(isNew) {
							var container = document.getElementById("query-builder-save-buttons");
							if (isNew) {
									container.innerHTML = "<button id='query-selector-save' class='query-selector-save'>Save</button>";
									reporting.selectorSection.saveButtonInit('query-selector-save', 'create');
							} else {
									container.innerHTML = "<button id='query-selector-clone' class='query-selector-save'>Clone</button><button id='query-selector-update' class='query-selector-save'>Update</button>";
									reporting.selectorSection.saveButtonInit('query-selector-clone', 'clone');
									reporting.selectorSection.saveButtonInit('query-selector-update', 'update');
							}
					},
					filterToggleInit: function() {
							var toggle = document.getElementById('query-filter-toggle');
							toggle.addEventListener('change', function(e) {
									reporting.selectorSection.queryList.useFilter = e.currentTarget.checked;

									var table = document.getElementById("query-selector-table");
									var grid = $(table).data("kendoGrid");
									grid.setDataSource(reporting.selectorSection.queryList.dataSet());
							});
					},
					publicToggleInit: function() {
							var toggle = document.getElementById('query-public-toggle');
							toggle.addEventListener('change', function(e) {
									var newVal = e.currentTarget.checked;
									reporting.public = newVal;
									reporting.changed = true;
							});
					},
					saveButtonInit: function(id, type) {
							var button = document.getElementById(id);
							button.addEventListener('click', function() {
									var unpdateFn = function() {
											if (!reporting.fieldSection.scEditor.selectedFieldsArray.length) {
													mo.fn.modal.show({
															ctaLabel: "Close",
															class: "query-error-window",
															title: "Error. Empty field list",
															content: "<div>Please, select fields</div>",
													});
													return;
											}
											var el = document.getElementById('query-name');
											var name = el.value;
											if (!name) {
													mo.fn.modal.show({
															ctaLabel: "Close",
															class: "query-error-window",
															title: "Error. Empty name",
															content: "<div>Please, enter a query name</div>",
													});
											}
											if (!/^[\w\(\)\-\,\.\ ]+$/.test(name)) {
													mo.fn.modal.show({
															ctaLabel: "Close",
															class: "query-error-window",
															title: "Error. Invalid name",
															content: "<div>Please, enter a valid name<br>Use letters, digits, whitespaces and those symbols ()_-,.</div>",
													});
											} else {
													var cb = function() {
															mo.fn.overlay.show({
																	loading: true,
																	close: false
															});
															reporting.selectorSection.saveQuery(name, type == "update", false, undefined, function() {
																	reporting.selectorSection.queryList.init(true);
																	mo.fn.overlay.hide();
															});
													};
													if (type !== "update") {
															reporting.selectorSection.checkName(name, cb);
													} else {
															cb();
													}
											}
									};
									if (type === "update") {
											reporting.checkReport(reporting.selectorSection.queryList.selectedQuery.EntryId, unpdateFn);
									} else {
											unpdateFn();
									}
							});
					},
					checkName: function(name, cb) {
							var filter = {
									logic: "and",
									filters: [{
													field: 'Email',
													operator: 'eq',
													value: "[SSOData.Email]"
											},
											{
													field: 'QueryName',
													operator: 'eq',
													value: name
											}
									]
							};
							var ds = new kendo.data.DataSource({
									type: "rfb-v2",
									transport: {
											read: {
													url: "https://hpe-rfb.it.hpe.com/form/data-set-provider/v2/1676/NOR_Report_Templates_View/kendo/data/search",
													type: 'POST'
											},
									},
									schema: {
											model: {
													id: "EntryId",
													fields: {}
											}
									},
									serverFiltering: true,
									filter: filter,
									serverSorting: true,
									sort: {
											field: "EntryId",
											dir: "asc"
									}
							});

							ds.read().then(function() {
									var data = ds.view();
									if (!!data && !!data.length) {
											mo.fn.modal.show({
													ctaLabel: "Close",
													class: "query-error-window",
													title: "Error. Query with this name already exists",
													content: "<div>Please, enter a different query name</div>",
											});
									} else {
											cb();
									}
							});
					},
					saveQuery: function(name, isUpdate, draft, draftObj, callback) {
							var newObj = {};
							newObj.EntryId = reporting.selectorSection.queryList.selectedQuery != null ? reporting.selectorSection.queryList.selectedQuery.EntryId : 0;
							newObj.QueryName = name;
							newObj.Public = reporting.public ? 1 : 0;

							var fields = [];
							console.log('reporting.reference.countryMappingInfo.countryAliases', reporting.reference.countryMappingInfo.countryAliases);
							(reporting.fieldSection.scEditor.selectedFieldsArray).map(f => {
									console.log('f', f);
									const fieldObj = {
											field: f.cId,
											title: f.ColumnAlias
									};
									if (f.Aliases) {
											fieldObj.valueAliases = JSON.parse(f.Aliases);
									}
									if (f.UseCountryMapping) {
											fieldObj.valueAliases = reporting.reference.countryMappingInfo.countryAliases;
									}
									fields.push(fieldObj);
							});

							const idObj = fields.find(o => o.field === "NOR_Data_Converted$EntryId");
							if (!idObj) {
									fields.push({
											field: "NOR_Data_Converted$EntryId",
											title: "NOR. Id"
									});
							}

							newObj.ColumnList = JSON.stringify(fields);
							newObj.Email = isUpdate ? reporting.selectorSection.queryList.selectedQuery.Email : "[SSOData.Email]";
							newObj.FilterConfig = JSON.stringify(reporting.filterSection.filter.config);
							newObj.Filter = JSON.stringify(reporting.previewSection.prepareFilter());
							newObj.GroupColumns = reporting.useGrouping ? JSON.stringify(["NOR_Data_Converted$EntryId"]) : null;
							newObj.GroupFlag = reporting.useGrouping ? 1 : null;
							newObj.Draft = draft ? 1 : 0;

							const c = function(data) {
									reporting.changed = false;
									if (draft) {
											reporting.draftQuery = { ...data
											};
									} else {
											reporting.selectorSection.queryList.selectedQuery = { ...data
											};
											reporting.draftQuery = null;
									}
									callback(data.EntryId);
							};
							const cb = function(data) {
									$.ajax({
											type: 'GET',
											url: 'https://hpe-rfb.itcs.hpe.com/resources/rs/custom/php/pdl/queryBuilder.php?eid=' + data.EntryId + '&formId=1676',
											success: function() {
													c(data);
											},
											error: function(err) {
													mo.fn.modal.show({
															ctaLabel: ui.translate("OK"),
															title: ui.translate("Error"),
															content: "<p>" + "Could not save query data" + "</p>",
															ctaCallback: function() {
																	c(data);
															}
													});
											}
									});
							}
							if (isUpdate && newObj.EntryId) {
									if (draft) {
											if (!!reporting.draftQuery) {
													crud.update("5051", reporting.draftQuery.EntryId, newObj, cb);
											} else {
													crud.create("5050", newObj, cb);
											}
									} else {
											crud.update("5051", newObj.EntryId, newObj, cb);
											if (!!reporting.draftQuery) {
													crud.destroy("5052", reporting.draftQuery.EntryId, function(d) {});
											}
									}
							} else {
									if (!!reporting.draftQuery) {
											crud.update("5051", reporting.draftQuery.EntryId, newObj, cb);
									} else {
											crud.create("5050", newObj, cb);
									}
							}
					},
			},
			fieldSection: {
					init: function() {
							var holder = document.querySelector("#query-builder #query-column-selector");
							holder.innerHTML = "<div class='query-column-selector-sceditor'></div>";
							reporting.fieldSection.scEditor.availableTables = [...reporting.reference.queryTables.data];
							reporting.fieldSection.scEditor.sourceFields = reporting.reference.queryColumns.data;

							reporting.fieldSection.scEditor.init(document.querySelector("#query-builder .query-column-selector-sceditor"), function() {});

							$(".scEditor__left__panel .columnSelect").change(function() {
									$('.scEditor__left__panel .columnSelect option').removeClass('selected');
									$(".scEditor__left__panel .columnSelect option:selected").addClass("selected");
							});

							$(".scEditor__right__panel .columnSelect").change(function() {
									$('.scEditor__right__panel .columnSelect option').removeClass('selected');
									$(".scEditor__right__panel .columnSelect option:selected").addClass("selected");
							});
							$('.scEditor__table__panel .columnSelect').change(function() {
									$('.scEditor__table__panel .columnSelect option').removeClass('selected');
									$('.scEditor__table__panel .columnSelect option[value="' + $(this).val() + '"]').addClass('selected');

									$(".scEditor__left__panel .columnSelect").change(function() {
											$('.scEditor__left__panel .columnSelect option').removeClass('selected');
											$(".scEditor__left__panel .columnSelect option:selected").addClass("selected");

											$(".scEditor__right__panel .columnSelect").change(function() {
													$('.scEditor__right__panel .columnSelect option').removeClass('selected');
													$(".scEditor__right__panel .columnSelect option:selected").addClass("selected");
											});
									});
							});
					},
					scEditor: {
							selectedTable: '',
							availableTables: [],
							sourceFields: [],
							availableFields: [],
							selectedFields: [],
							selectedFieldsArray: [],
							activeAvailable: [],
							activeSelected: [],
							tablePanel: '',
							leftPanel: '',
							rightPanel: '',
							reset: function() {
									reporting.fieldSection.scEditor.availableFields = reporting.fieldSection.scEditor.sourceFields;
									reporting.fieldSection.scEditor.selectedFields = [];
									reporting.fieldSection.scEditor.selectedFieldsArray = [];
									reporting.fieldSection.scEditor.activeAvailable = [];
									reporting.fieldSection.scEditor.activeSelected = [];
									reporting.fieldSection.scEditor.selectedTable = null;
							},
							init: function(node, callback) {
									reporting.fieldSection.scEditor.reset();

									node.innerHTML = reporting.fieldSection.scEditor.template();

									reporting.fieldSection.scEditor.tablePanel = node.querySelector('.scEditor__table__panel select');
									reporting.fieldSection.scEditor.leftPanel = node.querySelector('.scEditor__left__panel select');
									reporting.fieldSection.scEditor.rightPanel = node.querySelector('.scEditor__right__panel select');
									reporting.fieldSection.scEditor.filterInput = node.querySelector('.available_fields-filter');

									node.querySelector('.scEditor__leftArr').addEventListener('click', function(ev) {
											reporting.fieldSection.scEditor.arrowLeft(node, function(d) {
													callback(d);
											});
									});

									node.querySelector('.scEditor__rightArr').addEventListener('click', function() {
											reporting.fieldSection.scEditor.arrowRight(node, function(d) {
													callback(d);
											});
									});

									node.querySelector('.scEditor__upArr').addEventListener('click', function(ev) {
											reporting.fieldSection.scEditor.arrowUp(node, function(d) {
													callback(d);
											});
									});

									node.querySelector('.scEditor__downArr').addEventListener('click', function() {
											reporting.fieldSection.scEditor.arrowDown(node, function(d) {
													callback(d);
											});
									});

									reporting.fieldSection.scEditor.filterInput.addEventListener('input', function(e) {
											reporting.fieldSection.scEditor.updateFieldList(reporting.fieldSection.scEditor.selectedTable);
									});

									reporting.fieldSection.scEditor.filterInput.addEventListener('paste', function(e) {
											e.preventDefault();
											var pastedText = '';
											if (e.clipboardData && e.clipboardData.getData) { // Standards Compliant FIRST!
													pastedText = e.clipboardData.getData('text/plain');
											} else if (window.clipboardData && window.clipboardData.getData) { // IE
													pastedText = window.clipboardData.getData('Text');
											}
											this.value = pastedText.trim();
											reporting.fieldSection.scEditor.updateFieldList(reporting.fieldSection.scEditor.selectedTable);
									});

									const toggle = node.querySelector('#unique-apps-toggle');
									const itm = reporting.selectorSection.queryList.selectedQuery;

									toggle.addEventListener('click', function() {
											reporting.useGrouping = !reporting.useGrouping;

											reporting.changed = reporting.changed ||
													((!!itm && !!itm.GroupColumns) ? (reporting.useGrouping != !!itm.GroupColumns) : (reporting.useGrouping != false));

											if (toggle.checked) {
													const norIdNode = document.querySelector('[value="NOR_Data_Converted$EntryId"]');
													const isIdAdded = Array.from(reporting.fieldSection.scEditor.rightPanel.childNodes).find(node => node.isEqualNode(norIdNode));

													if (!isIdAdded) {
															const opt = document.createElement('option');
															opt.value = norIdNode.value;
															opt.innerHTML = norIdNode.innerHTML;
															reporting.fieldSection.scEditor.rightPanel.appendChild(opt);

															let idx = -1;
															for (let j = 0; j < reporting.fieldSection.scEditor.leftPanel.options.length; j++) {
																	if (reporting.fieldSection.scEditor.leftPanel.options[j].value == norIdNode.value) {
																			idx = j;
																			break;
																	}
															}

															reporting.fieldSection.scEditor.leftPanel.remove(idx);
															reporting.fieldSection.scEditor.updateSelectedArray();
													}

													document.querySelector('[value="NOR_Data_Converted$EntryId"]').disabled = true;
											} else {
													document.querySelector('[value="NOR_Data_Converted$EntryId"]').disabled = false;
											}

									});

									reporting.fieldSection.scEditor.addOptions();
									reporting.fieldSection.scEditor.addTableOptions();
									reporting.fieldSection.scEditor.updateFieldList(reporting.fieldSection.scEditor.selectedTable);
									reporting.fieldSection.scEditor.loadFields();

									if (!!itm) {
											toggle.checked = !!itm.GroupColumns;
											reporting.useGrouping = toggle.checked;

											if (toggle.checked) {
													document.querySelector('[value="NOR_Data_Converted$EntryId"]').disabled = true;
											} else {
													document.querySelector('[value="NOR_Data_Converted$EntryId"]').disabled = false;
											}
									}

									reporting.fieldSection.scEditor.tablePanel.addEventListener('change', (event) => {
											var table = event.target.value
											reporting.fieldSection.scEditor.selectedTable = table;
											reporting.fieldSection.scEditor.updateFieldList(table);
									});
							},
							template: function(node) {
									return '<section class="scEditor__wrapper">' +
											'<div class="scEditor__table">' +
											'<div class="header"><h4>Available tables</h4></div>' +
											'<div class="scEditor__table__panel">' +
											'<select class="columnSelect" size="1000"></select>' +
											'</div>' +
											'</div>' +
											'<div class="scEditor__left">' +
											'<div class="header"><h4>Available fields</h4>' +
											'<input placeholder="Quick filter" class="available_fields-filter"> </div>' +
											'<div class="scEditor__left__panel">' +
											'<select class="columnSelect" multiple="true"></select>' +
											'</div>' +
											'</div>' +
											'<div class="scEditor__arrows">' +
											'<svg class="scEditor__rightArr" version="1.1" viewBox="0 0 24 24" role="img" aria-label="form-next" width="40px" height="40px"><polyline fill="none" stroke="#666" stroke-width="2" points="9 6 15 12 9 18"></polyline></svg>' +
											'<svg class="scEditor__leftArr" version="1.1" viewBox="0 0 24 24" role="img" aria-label="form-previous" width="40px" height="40px"><polyline fill="none" stroke="#666" stroke-width="2" points="9 6 15 12 9 18" transform="matrix(-1 0 0 1 24 0)"></polyline></svg>' +
											'</div>' +
											'<div class="scEditor__right">' +
											'<div class="header"><h4>Fields in report</h4>' +
											'<span>Unique apps</span><label class="switch"><input type="checkbox" id="unique-apps-toggle"><span class="slider"></span></label></div>' +
											//	'<button id="scEditor_distinct" hidden>Select unique fields</button>' +
											'<div class="scEditor__right__panel">' +
											'<select class="columnSelect" multiple="true"></select>' +
											'</div>' +
											'</div>' +
											'<div class="scEditor__arrows" style="margin-left: 10px;">' +
											'<svg class="scEditor__upArr" version="1.1" viewBox="0 0 24 24" role="img" aria-label="form-next" width="40px" height="40px"><polyline fill="none" stroke="#666" stroke-width="2" points="9 6 15 12 9 18"></polyline></svg>' +
											'<svg class="scEditor__downArr" version="1.1" viewBox="0 0 24 24" role="img" aria-label="form-previous" width="40px" height="40px"><polyline fill="none" stroke="#666" stroke-width="2" points="9 6 15 12 9 18" transform="matrix(-1 0 0 1 24 0)"></polyline></svg>' +
											'</div>' +
											'</section>';
							},
							arrowLeft: function(node, callback) {
									var toDelete = [];
									var length = reporting.fieldSection.scEditor.rightPanel.selectedOptions.length;
									for (var i = 0; i < length; i++) {
											var table = reporting.fieldSection.scEditor.tablePanel.value;
											var x = reporting.fieldSection.scEditor.rightPanel.selectedOptions[i];
											var selectedTable = x.value.split("$")[0];

											var opt = document.createElement('option');
											opt.value = x.value;
											opt.innerHTML = x.innerHTML;
											if (table !== "" && selectedTable != table) {
													opt.hidden = 'hidden';
											}
											reporting.fieldSection.scEditor.leftPanel.appendChild(opt);

											toDelete.push(x);
									}
									reporting.changed = true;
									toDelete.forEach(option => {

											var idx = -1;
											for (var j = 0; j < reporting.fieldSection.scEditor.rightPanel.options.length; j++) {
													if (!reporting.fieldSection.scEditor.rightPanel.options[j])
															debugger;
													if (reporting.fieldSection.scEditor.rightPanel.options[j].value == option.value) {
															idx = j;
															break;
													}
											}

											reporting.fieldSection.scEditor.rightPanel.remove(idx);
									});

									reporting.fieldSection.scEditor.updateSelectedArray();

									if (callback && typeof callback == 'function') callback(reporting.fieldSection.scEditor.selectedFields);
							},
							arrowRight: function(node, callback) {
									var toDelete = [];
									var lenght = reporting.fieldSection.scEditor.leftPanel.selectedOptions.length;
									for (var i = 0; i < lenght; i++) {
											var x = reporting.fieldSection.scEditor.leftPanel.selectedOptions[i];

											var opt = document.createElement('option');
											opt.value = x.value;
											opt.innerHTML = x.innerHTML;
											reporting.fieldSection.scEditor.rightPanel.appendChild(opt);

											toDelete.push(x);
									}
									reporting.changed = true;
									toDelete.forEach(option => {

											var idx = -1;
											for (var j = 0; j < reporting.fieldSection.scEditor.leftPanel.options.length; j++) {
													if (reporting.fieldSection.scEditor.leftPanel.options[j].value == option.value) {
															idx = j;
															break;
													}
											}

											reporting.fieldSection.scEditor.leftPanel.remove(idx);
									});

									reporting.fieldSection.scEditor.updateSelectedArray();

									if (callback && typeof callback == 'function') callback(reporting.fieldSection.scEditor.selectedFields);

							},
							arrowUp: function() {
									var select = reporting.fieldSection.scEditor.rightPanel;
									var length = select.selectedOptions.length;
									if (length == 0)
											return;

									reporting.changed = true;

									for (var i = 0; i < length; i++) {
											var x = select.selectedOptions[i];

											for (var j = 0; j < select.options.length; j++) {
													if (select.options[j].value == x.value) {
															var idx = j;
															if (j - 1 >= 0)
																	select.insertBefore(select.options[j], select.options[j - 1])
															break;
													}
											}

									}

									reporting.fieldSection.scEditor.updateSelectedArray();

							},
							arrowDown: function() {
									var select = reporting.fieldSection.scEditor.rightPanel;
									var length = select.selectedOptions.length;
									if (length == 0)
											return;

									reporting.changed = true;
									for (var i = 0; i < length; i++) {
											var x = select.selectedOptions[i];

											for (var j = 0; j < select.options.length; j++) {
													if (select.options[j].value == x.value) {
															var idx = j;
															if (j + 2 == select.options.length)
																	select.appendChild(select.options[j]);
															else select.insertBefore(select.options[j], select.options[j + 2])
															break;
													}
											}

									}

									reporting.fieldSection.scEditor.updateSelectedArray();
							},
							onFilter: function(text) {
									var options = reporting.fieldSection.scEditor.leftPanel.options;
									for (var i = 0; i < options.length; i++) {
											if (!text)
													options[i].removeAttribute("hidden");
											else {
													if (options[i].innerHTML.toLowerCase().includes(text.toLowerCase()))
															options[i].removeAttribute("hidden");
													else options[i].hidden = "hidden";
											}
									}
							},
							updateSelectedArray: function() {
									var opts = reporting.fieldSection.scEditor.rightPanel.options;

									reporting.fieldSection.scEditor.selectedFields = {};
									reporting.fieldSection.scEditor.selectedFieldsArray = [];

									for (var i = 0; i < opts.length; i++) {
											reporting.fieldSection.scEditor.selectedFields[opts[i].value] = opts[i].innerHTML;
											var c = reporting.fieldSection.scEditor.sourceFields.find(c => c.cId === opts[i].value);
											if (!!c) {
													reporting.fieldSection.scEditor.selectedFieldsArray.push(c);
											}
									}

									var btn = document.querySelector("#query-builder .query-column-selector-sceditor #scEditor_distinct");
							},
							updateFieldList: function(table) {
									var options = reporting.fieldSection.scEditor.leftPanel.options;
									var tables = reporting.fieldSection.scEditor.availableTables;
									var filterValue = reporting.fieldSection.scEditor.filterInput.value;
									for (var i = 0; i < options.length; i++) {
											if (!table) {
													if (!!tables.find(t => t.TableName == options[i].value.split('$')[0]) && (!filterValue || options[i].innerHTML.toLowerCase().includes(filterValue.toLowerCase())))
															options[i].removeAttribute("hidden");
													else options[i].hidden = "hidden";
											} else {
													if (table == options[i].value.split('$')[0] && (!filterValue || options[i].innerHTML.toLowerCase().includes(filterValue.toLowerCase())))
															options[i].removeAttribute("hidden");
													else options[i].hidden = "hidden";
											}
									}
							},
							addTableOptions: function() {
									const val = reporting.fieldSection.scEditor.tablePanel.value;
									reporting.fieldSection.scEditor.tablePanel.innerHTML = '';
									var needChange = true;
									var tData = [{
											TableName: '',
											TableAlias: 'All'
									}, ...reporting.fieldSection.scEditor.availableTables];
									tData.forEach(x => {
											var opt = document.createElement('option');
											opt.value = x.TableName;
											opt.innerHTML = x.TableAlias;
											if (x.TableName === val) {
													needChange = false;
													opt.selected = "selected";
											}
											reporting.fieldSection.scEditor.tablePanel.appendChild(opt);
									});
									if (needChange) {
											reporting.fieldSection.scEditor.tablePanel.value = '';
											reporting.fieldSection.scEditor.tablePanel.dispatchEvent(new Event('change'));
									}
							},
							addOptions: function(node) {
									var colData = [...reporting.fieldSection.scEditor.availableFields];
									colData.forEach(x => {
											var opt = document.createElement('option');
											opt.value = x.cId;
											opt.innerHTML = x.ColumnAlias;
											reporting.fieldSection.scEditor.leftPanel.appendChild(opt);
									});
							},
							removeEMDM: function() {
									for (var i = 0; i < reporting.fieldSection.scEditor.rightPanel.options.length; i++) {
											if (reporting.fieldSection.scEditor.rightPanel.options[i].value.includes("_emdm_")) {
													var x = reporting.fieldSection.scEditor.rightPanel.options[i];
													x.selected = true;
													continue;
											}
									}
									reporting.fieldSection.scEditor.arrowLeft(null);
							},
							loadFields: function() {
									var itm = reporting.selectorSection.queryList.selectedQuery;
									if (!!itm && !!itm.ColumnList) {
											var cols = JSON.parse(itm.ColumnList);
											reporting.groupList = !!itm.GroupColumns ? true : false;
											if (Array.isArray(cols)) {
													cols.map(c => {
															var lenght = reporting.fieldSection.scEditor.leftPanel.options.length;
															for (var i = 0; i < lenght; i++) {
																	var x = reporting.fieldSection.scEditor.leftPanel.options[i];
																	if (x.value === c.field) {
																			x.selected = "selected";
																			reporting.fieldSection.scEditor.arrowRight();
																			break;
																	}
															}
													});
											}
									}
							},
					},
			},
			reference: {
					init: function(callback) {
							reporting.reference.queryTables.data = [];
							reporting.reference.queryColumns.data = [];
							reporting.reference.queryTables.init(function() {
									reporting.reference.queryColumns.init(function() {
											reporting.reference.countryMappingInfo.init(callback);
									});
							});
					},
					queryTables: {
							data: [],
							init: function(callback) {
									var ds = new kendo.data.DataSource({
											type: "rfb-v2",
											transport: {
													read: {
															url: "https://hpe-rfb.it.hpe.com/form/data-set-provider/v2/1677/NOR_Reporting_Tables/kendo/data/search",
															type: 'POST'
													},
											},
											serverSorting: true,
											sort: {
													field: "TableAlias",
													dir: "asc"
											}
									});

									ds.read().then(function() {
											var data = ds.view();
											data.forEach(function(el, idx) {
													reporting.reference.queryTables.data.push({
															...el,
															tId: 't' + (idx + 1),
													})
											});
											callback();
									});
							},
					},
					queryColumns: {
							data: [],
							init: function(callback) {
									var ds = new kendo.data.DataSource({
											type: "rfb-v2",
											transport: {
													read: {
															url: "https://hpe-rfb.it.hpe.com/form/data-set-provider/v2/1677/NOR_Reporting_Columns/kendo/data/search",
															type: 'POST'
													},
											},
									});

									ds.read().then(function() {
											var data = ds.view();
											data.forEach(function(el, idx) {
													var t = reporting.reference.queryTables.data.find(t => t.TableName === el.TableName);
													if (!!t) {
															reporting.reference.queryColumns.data.push({
																	...el,
																	cId: t.TableName + '$' + el.ColumnName,
															})
													}
											});
											callback();
									});
							},
					},
					countryMappingInfo: {
							countryValues: [],
							countryAliases: [],
							init: function(callback) {
									var ds = new kendo.data.DataSource({
											type: "rfb-v2",
											transport: {
													read: {
															url: "https://hpe-rfb.it.hpe.com/form/data-set-provider/v2/1269/Country_Mapping/kendo/data/search",
															type: 'POST'
													},
											},
											serverSorting: true,
											sort: {
													field: "Name",
													dir: "asc"
											}
									});
									ds.read().then(function() {
											var data = ds.view();
											data.forEach(function(el, idx) {
													reporting.reference.countryMappingInfo.countryValues.push({
															value: el.ISO2,
															label: el.Name,
													});
													reporting.reference.countryMappingInfo.countryAliases.push({
															value: el.ISO2,
															alias: el.Name.replace("'", "''"),
													});
											});
											callback();
									});
							},
					},
			},
			defaultFilter: function() {
					return {
							isGroup: true,
							guid: uuid.v4(),
							logic: "and",
							conditions: [],
							root: true,
					};
			},
			filterSection: {
					config: {},
					filter: {},
					init: function() {
							var itm = reporting.selectorSection.queryList.selectedQuery;
							var config = !!itm && !!itm.FilterConfig ? JSON.parse(itm.FilterConfig) : reporting.defaultFilter();
							var holder = document.querySelector("#query-filter-section");
							holder.innerHTML = '';
							reporting.filterSection.filter = getFilter();
							reporting.filterSection.filter.init(holder, config, reporting.fieldSection.scEditor.availableTables, "");
					},
			},
			previewSection: {
					init: function() {
							var holder = document.querySelector(".query-preview");
							holder.innerHTML =
									"<div class='query-preview-buttons'>" +
									"<button id='query-build-preview'>Build preview</button>" +
									'<button id="create-report-btn" class="query-selector-save">Generate report</button>' +
									"</div>" +
									"<div class='query-preview-table'></div>";
							var table = document.querySelector(".query-preview-table");
							table.innerHTML = "";
							var generateBtn = document.querySelector("#query-build-preview");
							generateBtn.addEventListener("click", function(e) {
									if (reporting.selectorSection.queryList.selectedQuery == null || reporting.selectorSection.queryList.selectedQuery.Draft == 1) {
											mo.fn.overlay.show({
													loading: true,
													close: false
											});
											reporting.selectorSection.saveQuery(uuid.v4(), false, true, undefined, function() {
													mo.fn.overlay.hide();
													reporting.previewSection.grid.load(table, true);
											});
									} else {
											if (reporting.changed) {
													mo.fn.overlay.show({
															loading: true,
															close: false
													});
													reporting.selectorSection.saveQuery(uuid.v4(), true, true, undefined, function() {
															mo.fn.overlay.hide();
															reporting.previewSection.grid.load(table, true);
													});
											} else {
													reporting.previewSection.grid.load(table, !!reporting.draftQuery);
											}
									}
									reporting.changed = false;
							});
							reporting.previewSection.reportButtonInit();
					},
					reportButtonInit: function() {
							const button = document.getElementById('create-report-btn');

							button.addEventListener('click', function() {

									const doReport = function(EntryId) {
											if (!EntryId) {
													console.log('No EntryId provided to generate report.');
											}

											var fields = [];
											(reporting.fieldSection.scEditor.selectedFieldsArray).map(f => {
													fields.push({
															field: f.cId,
															title: f.ColumnAlias
													});
											});

											generateReport(
													"[SSOData.Email]",
													"NOR",
													1677,
													JSON.stringify(fields),
													'',
													JSON.stringify(reporting.previewSection.prepareFilter()),
													(document.getElementById('query-name').value ? document.getElementById('query-name').value : 'new_order_request_report') + '_' + new Date().getTime(),
													EntryId,
													"NOR",
													null,
													false,
													null,
													function(id, rcb, success) {
															rcb();
													},
													function(name) {
															return name;
													},
													"&formId=1676",
													null,
													function(response) {
															if (response.Success && (response.Pass != 0 || response.Fail != 0)) {
																	document.querySelector(".dxpModal .dxpModalContent").innerHTML =
																			'Your report is downloading. We have completed generating your report. Thank you for your patience.';
																	reporting.previewSection.loadReport(response.Report.EntryId);
															}
													}
											);
									};


									if (reporting.selectorSection.queryList.selectedQuery == null || reporting.selectorSection.queryList.selectedQuery.Draft == 1) {
											mo.fn.overlay.show({
													loading: true,
													close: false
											});
											reporting.selectorSection.saveQuery(uuid.v4(), false, true, undefined, function(EntryId) {
													mo.fn.overlay.hide();
													doReport(EntryId);
											});
									} else {
											if (reporting.changed) {
													mo.fn.overlay.show({
															loading: true,
															close: false
													});
													reporting.selectorSection.saveQuery(uuid.v4(), true, true, undefined, function(EntryId) {
															mo.fn.overlay.hide();
															doReport(EntryId);
													});
											} else {
													let eid = null;
													if (!!reporting.draftQuery) eid = reporting.draftQuery.EntryId;
													else eid = reporting.selectorSection.queryList.selectedQuery.EntryId;
													doReport(eid);
											}
									}
							});

					},
					loadReport: function(id) {
							const ds = new kendo.data.DataSource({
									type: "rfb-v2",
									transport: {
											read: {
													url: "https://hpe-rfb.it.hpe.com/form/data-set-provider/v2/1424/ReportsView/kendo/data/search",
													type: 'POST'
											},
									},
									schema: {
											model: {
													id: "EntryId",
													fields: {}
											}
									},
									serverFiltering: true,
									filter: [{
											field: 'EntryId',
											operator: 'eq',
											value: id
									}, ],
									serverPaging: true,
									pageSize: 1,
									serverSorting: true,
									page: 1,
							});

							ds.read().then(function() {
									const view = ds.view();
									const modalText = document.querySelector(".dxpModal .dxpModalContent");

									if (view && view.length > 0 && view[0].EntryId) {
											const expirationDate = new Date(view[0].Expire);
											const currentDate = new Date();

											if (view[0].Path) {
													if (currentDate < expirationDate) {
															const aLink = document.createElement("a");
															aLink.setAttribute("target", "_self");
															aLink.innerHTML = view[0].Filename;
															aLink.setAttribute("href", view[0].Path);
															aLink.click();
													} else {
															if (!!modalText) {
																	modalText.innerHTML = 'The report is expired.';
															} else {
																	mo.fn.modal.show({
																			ctaLabel: "Close",
																			class: "query-error-window",
																			title: "Error",
																			content: "<div>The report is expired.</div>",
																	});
															}
													}
											} else {
													if (!!modalText) {
															modalText.innerHTML = 'Error downloading the report.';
													} else {
															mo.fn.modal.show({
																	ctaLabel: "Close",
																	class: "query-error-window",
																	title: "Error",
																	content: "<div>Error downloading the report.</div>",
															});
													}
											}
									} else {
											if (!!modalText) {
													modalText.innerHTML = 'Error loading the report.';
											} else {
													mo.fn.modal.show({
															ctaLabel: "Close",
															class: "query-error-window",
															title: "Error",
															content: "<div>Error loading the report.</div>",
													});
											}
									}
							});
					},
					prepareFilter: function() {
							return reporting.previewSection.buildFilter(reporting.filterSection.filter.config);
					},
					buildFilter: function(conf) {
							var filter = {};
							if (conf.isGroup) {
									if (!!conf.conditions && !!conf.conditions.length) {
											filter.logic = conf.logic;
											filter.filters = [];
											conf.conditions.map(c => {
													var res = reporting.previewSection.buildFilter(c);
													if (res && !(Object.keys(res).length === 0 && Object.getPrototypeOf(res) === Object.prototype)) {
															filter.filters.push(res);
													}
											});
									}
							} else {
									var value = conf.type.includes("int") || conf.type.includes("float") || conf.type.includes("decimal") || conf.type.includes("numeric") ? parseFloat(conf.value.replace(',', '.')) : conf.value;
									if (conf.operator == 'iscontainedin') {
											filter = {
													field: conf.field,
													operator: conf.operator,
													value: value.split(/\,\s*/)
											};
									} else {
											filter = {
													field: (conf.FilterField ? (conf.FilterField.includes('$') ? conf.FilterField : `${conf.table}$${conf.FilterField}`) : conf.field),
													operator: conf.operator,
													value: value
											};
									}
							}
							return filter;
					},
					grid: {
							searchField: "",
							columns: function() {
									var tables = [...reporting.fieldSection.scEditor.availableTables];
									var fields = [...(!!reporting.fieldSection.scEditor.selectedFieldsArray.length ? reporting.fieldSection.scEditor.selectedFieldsArray : reporting.fieldSection.scEditor.sourceFields)];
									var columns = [];
									columns.push({
											title: "Actions",
											width: "100px",
											template: function(d) {
													var icons = '<a style="margin-right: 5px" class="qb-row-details"><svg version="1.1" draggable="false"  viewBox="0 0 24 24" role="img" aria-label="search" width="16px" height="16px"><path fill="none" stroke="#666" stroke-width="2" d="M15,15 L22,22 L15,15 Z M9.5,17 C13.6421356,17 17,13.6421356 17,9.5 C17,5.35786438 13.6421356,2 9.5,2 C5.35786438,2 2,5.35786438 2,9.5 C2,13.6421356 5.35786438,17 9.5,17 Z"></path></svg></a>';
													return icons;
											}
									});
									fields.map(f => {
											if (!!tables.find(t => t.TableName === f.TableName)) {
													columns.push({
															field: f.TableName + '$' + f.ColumnName,
															title: f.ColumnAlias,
															hidden: false,
															width: "200px",
															type: f.Type === 'datetime2' ? 'date' : undefined,
															template: function(dataItem) {
																	var val = '';
																	if (dataItem[f.TableName + '$' + f.ColumnName] == null)
																			val = '';
																	else
																			val = dataItem[f.TableName + '$' + f.ColumnName];
																	return "<div style='height: 20px; overflow:hidden;'>" + val + "</div>";
															}
													});
											}
									});
									return columns;
							},
							load: function(selector, draft) {
									var filter = reporting.previewSection.prepareFilter();
									selector.innerHTML = '';
									var cols = reporting.previewSection.grid.columns();
									$(selector).kendoGrid({
											height: 500,
											noRecords: {
													template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
											},
											dataSource: reporting.previewSection.dataSource(filter, draft),
											columns: cols,
											pageable: {
													buttonCount: 5,
													pageSize: 10,
													pageSizes: [10, 25, 50, 100],
													messages: {
															itemsPerPage: ""
													},
													refresh: true
											},
											scrollable: true,
											resizable: true,
											dataBound: function(e) {
													if (this.dataSource.view().length == 0) {
															//insert empty row
															var colspan = this.thead.find("th").length;
															var emptyRow = "<tr><td colspan='" + colspan + "'></td></tr>";
															this.tbody.html(emptyRow);
															return;
													}
											},
									});
									$(selector).delegate('.qb-row-details', 'click', function(ev) {
											var grid = $(selector).data("kendoGrid");
											var row = grid.dataItem($(this).closest("tr"));
											var itm = {};
											cols.map(c => {
													if (c.title !== 'Actions') {
															itm[c.title] = row[c.field];
													}
											});
											detailsSection.init("Row details", itm);
									});
							}
					},
					dataSource: function(filter, draft) {
							return new kendo.data.DataSource({
									type: "rfb-v2",
									transport: {
											read: {
													url: "https://hpe-rfb.it.hpe.com/form/1166/sp/spPDLQueryBuilder/call",
													type: 'POST',
													data: {
															'p.eid': draft ? reporting.draftQuery.EntryId : reporting.selectorSection.queryList.selectedQuery.EntryId,
															'p.formId': 1676,
													},
											},
									},
									schema: {
											data: "Rows",
											total: "Total",
											parse: function(response) {
													if (response.sucess === false || response.message) {
															mo.fn.modal.show({
																	ctaLabel: "Close",
																	class: "query-error-window",
																	title: "Failed to process query",
																	content: "<div>We were unable to successfully use the query to fetch data. Please try again later. If the issue persists, please raise a support ticket</div>",
															});
															return {
																	Rows: [],
																	Total: 0
															};
													}
													return response;
											},
									},
									serverPaging: true,
									pageSize: 10,
							});
					},
					preprocessData: function(filter, cb) {
							mo.fn.overlay.show({
									loading: true,
									close: false
							});
							var dataSource = reporting.previewSection.dataSource(filter);
							dataSource.read().then(function() {
									var dt = dataSource.data();
									var arr = [];
									dt.map(el => {
											arr.push(el.items[0]);
									});
									cb(new kendo.data.DataSource({
											data: arr,
											pageSize: 10,
											total: arr.length,
									}))
									return;
							});
					},
			},
			fixNames: function() {
					var data = reporting.selectorSection.queryList.data;
					data.map(el => {
							if (!/^[\w\(\)\-\,\.\ ]+$/.test(el.QueryName)) {
									var val = el.QueryName.replaceAll(/[^\w\(\)\-\,\.\ ]+/g, ' ');
									crud.update("5051", el.EntryId, {
											QueryName: val
									}, function() {});
							}
					});
			},
			fixGroups: function() {
					var data = reporting.selectorSection.queryList.data;
					data.map(el => {
							if (el.GroupColumns) {
									crud.update("5051", el.EntryId, {
											GroupColumns: null
									}, function() {});
							}
					});
			},
			updateAll: {
					start: function(idx = 0) {
							reporting.updateAll.getData(function(data) {
									reporting.updateAll.updateNext(data, idx, data.length);
							});
					},
					updateNext: function(data, idx, total) {
							var cb = function() {
									if (idx < total - 1) {
											console.log("qb update next ", idx);
											reporting.updateAll.updateNext(data, idx + 1, data.length);
									} else {
											console.log("qb update done");
									}
							};
							$.ajax({
									type: 'GET',
									url: 'https://hpe-rfb.itcs.hpe.com/resources/rs/custom/php/pdl/queryBuilder.php?eid=' + data[idx].EntryId + '&formId=1676',
									success: function() {
											cb();
									},
									error: function(err) {
											console.log(err);
											cb();
									}
							});
					},
					getData: function(cb) {
							var filter = {
									logic: "and",
									filters: [{
											field: 'Draft',
											operator: 'neq',
											value: 1
									}]
							};
							var ds = new kendo.data.DataSource({
									type: "rfb-v2",
									transport: {
											read: {
													url: "https://hpe-rfb.it.hpe.com/form/data-set-provider/v2/1676/NOR_Report_Templates_View/kendo/data/search",
													type: 'POST'
											},
									},
									schema: {
											model: {
													id: "EntryId",
													fields: {}
											}
									},
									serverFiltering: true,
									filter: filter,
									serverSorting: true,
									sort: {
											field: "EntryId",
											dir: "desc"
									},
									serverPaging: true,
									pageSize: 1000
							});
							ds.read().then(function() {
									var data = ds.view();
									cb(data);
							});
					},
			},
			checkReport: function(eid, cb) {
					mo.fn.overlay.show({
							loading: true,
							close: false
					});
					var ds = new kendo.data.DataSource({
							type: "rfb-v2",
							transport: {
									read: {
											url: "https://hpe-rfb.it.hpe.com/form/data-set-provider/v2/1424/ReportsView/kendo/data/search",
											type: 'POST'
									},
							},
							pageSize: 10,
							serverPaging: true,
							serverFiltering: true,
							serverSorting: true,
							filter: [{
											field: "ReportStatus",
											operator: "eq",
											value: "In Progress"
									},
									{
											field: "Source",
											operator: "eq",
											value: "NOR"
									},
									{
											field: "DataFK",
											operator: "eq",
											value: eid
									},
							],
							sort: {
									field: "EntryId",
									dir: "desc"
							}
					});

					ds.read().then(function() {
							var view = ds.view();
							mo.fn.overlay.hide();
							if (view.length > 0) {
									mo.fn.modal.show({
											ctaLabel: "Close",
											class: "query-error-window",
											title: "Error",
											content: "<div>Action is blocked, because this query is used by report #" + view[0].EntryId + " and it is in progress. Please, try it again later</div>",
									});
									return;
							} else {
									cb();
							}
					});
			},
			unsavedProgress: {
					init: function(cb) {
							mo.fn.modal.show({
									close: true,
									ctaLabel: "Yes",
									closeLabel: "No",
									title: "Warning",
									content: '<div>You have an unsaved progress. Do you want to continue?</div>',
									ctaCallback: function() {
											if (!!!cb) {
													cb = function() {};
											}
											mo.fn.modal.hide();
											debugger;
											if (!!reporting.draftQuery) {
													crud.destroy("5052", reporting.draftQuery.EntryId, function(d) {
															reporting.draftQuery = null;
															cb();
													});
											} else {
													cb();
											}
									}
							});
					},
			},
	}

	const detailsSection = {
			init: function(text, obj, props) {
					mo.fn.modal.show({
							close: true,
							ctaLabel: "Close",
							title: text,
							content: '<div id="qb-details"></div>',
							contentCallback: function() {
									detailsSection.renderItem(obj, props);
							}
					});
			},
			renderItem: function(obj, props) {
					var node = document.querySelector('#qb-details');
					var keys = !!props ? props : Object.keys(obj);
					keys.map(key => {
							node.innerHTML += "<div><b>" + key + "</b>: " + (obj[key] ? obj[key] : '') + "</div><br>";
					});
			},
	};

	const filterSection = {
			config: {},
			holder: '',
			tables: [],
			removeNode: function(guid, node) {
					if (node.guid === guid) {
							return null;
					}
					if (!!node.conditions && !!node.conditions.length) {
							var conditions = [];
							node.conditions.map(el => {
									var val = this.removeNode(guid, el);
									if (val !== null) {
											conditions.push(val);
									}
							});
							node.conditions = [...conditions];
					}
					return node;
			},
			init: function(holder, config, tables, type) {
					this.holder = holder;
					this.config = config;
					this.tables = tables;
					this.renderConfig(holder, config);
					this.addEventListeners(holder, config);
			},
			reload: function() {
					this.holder.innerHTML = '';
					this.renderConfig(this.holder, this.config);
					this.addEventListeners(this.holder, this.config);
			},
			renderConfig: function(node, conf) {
					if (!!conf.isGroup) {
							this.renderGroup(node, conf);
					} else {
							this.renderCondition(node, conf);
					}
					return;
			},
			renderGroup: function(node, conf) {
					var content =
							"<div id='group-" + conf.guid + "' " + (conf.root ? "data-root='true'" : "draggable='true'") +
							" class='query-filter-group" + (conf.root ? '-root' : '') + "'><div class='query-filter-group-options' id='query-filter-group-options-" + conf.guid + "'></div>" +
							"<div class='query-filter-group-conditions' id='query-filter-group-conditions-" + conf.guid + "' draggable='false'>" +
							"</div></div>";
					node.innerHTML = (node.innerHTML || '') + content;
					this.renderGroupOptions(node.querySelector("#query-filter-group-options-" + conf.guid), conf);
					var childNode = node.querySelector(`#group-${conf.guid} #query-filter-group-conditions-${conf.guid}`);
					conf.conditions.map(el => {
							this.renderConfig(childNode, el);
					});
					return;
			},
			renderGroupOptions: function(node, conf) {
					var content = "<div class='query-filter-group-select' draggable='false'><label>Logic" +
							"<select class='query-group-logic' id='group-logic-" + conf.guid + "' draggable='false'>" +
							"<option value='AND' " + ((conf.logic || "").toLowerCase() == "and" ? "selected" : '') + " >AND</option>" +
							"<option value='OR' " + ((conf.logic || "").toLowerCase() == "or" ? "selected" : '') + " >OR</option>" +
							"</select>" +
							"</label></div>" +
							"<button id='group-add-group-" + conf.guid + "' draggable='false'>Add group</button>" +
							"<button id='group-add-content-" + conf.guid + "' draggable='false'>Add conditions</button>" +
							(conf.root ? "" : '<svg draggable="false" id="group-remove-' + conf.guid + '" class="closeHPE" version="1.1" viewBox="0 0 24 24" role="img" aria-label="close" width="16px" height="16px"><path fill="none" stroke="#666" stroke-width="2" d="M3,3 L21,21 M3,21 L21,3"></path></svg>');
					node.innerHTML = (node.innerHTML || '') + content;
			},
			renderCondition: function(node, conf) {
					var tableOpts = '';
					[{
							TableName: '',
							TableAlias: 'All'
					}, ...this.tables].map(f => {
							tableOpts += "<option value='" + f.TableName + "' " + (conf.table == f.TableName ? " selected " : '') + ">" + f.TableAlias + "</option>";
					});
					var fieldOpts = '';
					reporting.fieldSection.scEditor.sourceFields.filter(f => !!this.tables.find(t => t.TableName === f.TableName)).map((f, idx) => {
							var selectedTable = conf.table || "";
							fieldOpts += "<option value='" + f.cId + "' " + (conf.field == f.cId || selectedTable == "" && idx == 0 ? " selected " : '') +
									(selectedTable !== "" && selectedTable !== f.TableName ? " hidden " : '') + ">" + f.ColumnAlias + "</option>";
					});
					var valueOpts = '';
					if (conf.FilterField) {
							if (conf.UseCountryMapping) {
									reporting.reference.countryMappingInfo.countryValues.map(el => {
											valueOpts += "<option value='" + el.value + "' " + (conf.value == el.value ? " selected " : '') + ">" + el.label + "</option>";
									});
							} else if (!!conf.Values) {
									const vals = conf.Values.replaceAll("'", "\"");
									JSON.parse(vals).map(el => {
											valueOpts += "<option value='" + el.value + "' " + (conf.value == el.value ? " selected " : '') + ">" + el.label + "</option>";
									});
							}
					}
					var drOpts = '';
					filterSection.dateRangeArray.map(el => {
							drOpts += "<option value='" + el.value + "' " + ((conf.range || '') == el.value ? " selected " : '') + ">" + el.option + "</option>";
					});
					var content =
							"<div id='query-condition-" + conf.guid + "' draggable='true' class='query-filter-condition'>" +
							"<div class='query-filter-group-select' draggable='false'><label>Table" +
							"<select class='query-group-logic' id='condition-table-" + conf.guid + "' >" +
							tableOpts +
							"</select>" +
							"</label></div>" +
							"<div class='query-filter-group-select' draggable='false'><label>Field" +
							"<select class='query-group-logic' id='condition-field-" + conf.guid + "'>" +
							fieldOpts +
							"</select>" +
							"</label></div>" +
							"<div class='query-filter-group-select' draggable='false'><label>Operator" +
							"<select class='query-group-logic' id='condition-operator-" + conf.guid + "'>" +
							"<option value='eq' " + (conf.operator == "eq" ? " selected " : '') + " " + (conf.Merged === 1 ? " hidden " : "") + ">EQUAL</option>" +
							"<option value='neq' " + (conf.operator == "neq" ? " selected " : '') + " " + (conf.Merged === 1 ? " hidden " : "") + ">NOT EQUAL</option>" +
							"<option value='gt' " + (conf.operator == "gt" ? " selected " : '') + " " + (conf.Merged === 1 || !!conf.FilterField ? " hidden " : "") + ">GREATER</option>" +
							"<option value='lt' " + (conf.operator == "lt" ? " selected " : '') + " " + (conf.Merged === 1 || !!conf.FilterField ? " hidden " : "") + ">LOWER</option>" +
							"<option value='gte' " + (conf.operator == "gte" ? " selected " : '') + " " + (conf.Merged === 1 || !!conf.FilterField ? " hidden " : "") + ">GREATER OR EQUAL</option>" +
							"<option value='lte' " + (conf.operator == "lte" ? " selected " : '') + " " + (conf.Merged === 1 || !!conf.FilterField ? " hidden " : "") + ">LOWER OR EQUAL</option>" +
							"<option value='contains' " + (conf.operator == "contains" ? " selected " : '') + " " + (!!conf.FilterField || conf.type == 'datetime2' ? " hidden " : "") + ">CONTAINS</option>" +
							"<option value='doesnotcontain' " + (conf.operator == "doesnotcontain" ? " selected " : '') + " " + (!!conf.FilterField || conf.type == 'datetime2' ? " hidden " : "") + ">DOESN'T CONTAIN</option>" +
							"<option value='startswith' " + (conf.operator == "startswith" ? " selected " : '') + " " + (conf.Merged === 1 || !!conf.FilterField || conf.type == 'datetime2' ? " hidden " : "") + ">STARTS WITH</option>" +
							"<option value='endswith' " + (conf.operator == "endswith" ? " selected " : '') + " " + (conf.Merged === 1 || !!conf.FilterField || conf.type == 'datetime2' ? " hidden " : "") + ">ENDS WITH</option>" +
							"<option value='doesnotstartwith' " + (conf.operator == "doesnotstartwith" ? " selected " : '') + " " + (conf.Merged === 1 || !!conf.FilterField || conf.type == 'datetime2' ? " hidden " : "") + ">DOESN'T START WITH</option>" +
							"<option value='doesnotendwith' " + (conf.operator == "doesnotendwith" ? " selected " : '') + " " + (conf.Merged === 1 || !!conf.FilterField || conf.type == 'datetime2' ? " hidden " : "") + ">DOESN'T END WITH</option>" +
							"<option value='iscontainedin' " + (conf.operator == "iscontainedin" ? " selected " : '') + " " + (conf.Merged === 1 || !!conf.FilterField || conf.type == 'datetime2' ? " hidden " : "") + ">IN</option>" +
							"<option value='isempty' " + (conf.operator == "isempty" ? " selected " : '') + " " + (conf.Merged === 1 || !!conf.FilterField ? " hidden " : "") + ">IS EMPTY</option>" +
							"<option value='isnotempty' " + (conf.operator == "isnotempty" ? " selected " : '') + " " + (conf.Merged === 1 || !!conf.FilterField ? " hidden " : "") + ">IS NOT EMPTY</option>" +
							"</select>" +
							"</label></div>" +
							'<svg version="1.1" draggable="false" id="condition-details-' + conf.guid + '" ' + (conf.FilterField ? 'style="visibility:hidden"' : "") + ' class="closeHPE" viewBox="0 0 24 24" role="img" aria-label="search" width="16px" height="16px"><path fill="none" stroke="#666" stroke-width="2" d="M15,15 L22,22 L15,15 Z M9.5,17 C13.6421356,17 17,13.6421356 17,9.5 C17,5.35786438 13.6421356,2 9.5,2 C5.35786438,2 2,5.35786438 2,9.5 C2,13.6421356 5.35786438,17 9.5,17 Z"></path></svg>' +
							"<div class='query-filter-group-select' draggable='false'><label for='condition-value-" + conf.guid + "'>Value</label>" +
							"<select class='query-filter-daterange-select' id='condition-daterange-" + conf.guid + "' " + (conf.type == 'datetime2' ? "" : " hidden ") + ">" +
							drOpts +
							"</select>" +
							"<select class='query-group-logic' id='condition-select-value-" + conf.guid + "' draggable='true' " + (conf.FilterField ? "" : " hidden ") + ">" +
							valueOpts +
							"</select>" +
							"</div>" +
							'<svg draggable="false" id="condition-remove-' + conf.guid + '" class="closeHPE" version="1.1" viewBox="0 0 24 24" role="img" aria-label="close" width="16px" height="16px"><path fill="none" stroke="#666" stroke-width="2" d="M3,3 L21,21 M3,21 L21,3"></path></svg>' +
							"</div>";
					node.innerHTML = (node.innerHTML || '') + content;
					var valueContainer = node.querySelector('#query-condition-' + conf.guid).querySelector("#condition-select-value-" + conf.guid).parentElement;
					console.log(valueContainer.innerHTML);
					var input = document.createElement('input');

					input.setAttribute('type', conf.type == 'datetime2' ? 'date' : 'text');
					input.setAttribute('id', "condition-value-" + conf.guid);
					input.setAttribute('draggable', true);
					input.setAttribute('value', conf.value);
					if (conf.FilterField) {
							input.hidden = true;
					}

					valueContainer.appendChild(input);
					return;
			},
			addEventListeners: function(holder, conf) {
					if (conf.isGroup) {
							holder.querySelector("#group-logic-" + conf.guid).addEventListener('change', (e) => {
									e.preventDefault();
									e.stopPropagation();
									reporting.changed = true;
									conf.logic = e.target.value;
							});
							holder.querySelector("#group-add-group-" + conf.guid).addEventListener('click', (e) => {
									e.preventDefault();
									e.stopPropagation();
									reporting.changed = true;
									conf.conditions.push({
											isGroup: true,
											guid: uuid.v4(),
											logic: "and",
											conditions: []
									});
									this.reload();
							});
							holder.querySelector("#group-add-content-" + conf.guid).addEventListener('click', (e) => {
									e.preventDefault();
									e.stopPropagation();
									reporting.changed = true;
									const defaultTable = reporting.fieldSection.scEditor.availableTables[0].TableName;
									const defaultField = reporting.fieldSection.scEditor.sourceFields.find(f => f.TableName === defaultTable);
									conf.conditions.push({
											guid: uuid.v4(),
											field: defaultField.cId,
											operator: defaultField.Merged ? "contains" : "eq",
											value: defaultField.FilterField ? defaultField.Type === 'datetime2' ? new Date().toISOString().split('T')[0] : 1 : "",
											type: defaultField.Type,
											Merged: defaultField.Merged,
											FilterField: defaultField.FilterField,
											Values: defaultField.Values,
											table: defaultField.TableName,
											UseCountryMapping: defaultField.UseCountryMapping,
									});
									this.reload();
							});
							holder.querySelector("#group-add-group-" + conf.guid).addEventListener('mousedown', (e) => {
									e.preventDefault();
									e.stopPropagation();
									return false;
							});
							holder.querySelector("#group-add-content-" + conf.guid).addEventListener('mousedown', (e) => {
									e.preventDefault();
									e.stopPropagation();
									return false;
							});
							if (!conf.root) {
									holder.querySelector("#group-remove-" + conf.guid).addEventListener('click', (e) => {
											e.preventDefault();
											e.stopPropagation();
											reporting.changed = true;
											var newConf = this.removeNode(conf.guid, this.config);
											this.config = { ...newConf
											};
											this.reload();
									});
									holder.querySelector("#group-remove-" + conf.guid).addEventListener('mousedown', (e) => {
											e.preventDefault();
											e.stopPropagation();
											return false;
									});
									filterSection.addDragNDropListeners(holder.querySelector("#group-" + conf.guid), this.config);
							}
					} else {
							const proceesFieldChange = function(old, conf) {
									// json of values for dropdown not equal to previous one
									conf.range = '';
									var valueInput = holder.querySelector("#condition-value-" + conf.guid);
									var dr = holder.querySelector("#condition-daterange-" + conf.guid);
									if (old.Values != conf.Values || old.UseCountryMapping != conf.UseCountryMapping) {
											var valueSelect = holder.querySelector("#condition-select-value-" + conf.guid);
											if (conf.FilterField) {
													// currently it is not empty, we have a field to filter by
													if (!old.FilterField) {
															valueInput.hidden = true;
															valueSelect.hidden = false;
													}
													// change dropdown options, select 1st
													var newOpts = '';
													var newVal = 0;
													if (conf.UseCountryMapping) {
															reporting.reference.countryMappingInfo.countryValues.map((el, idx) => {
																	newVal = idx == 0 ? el.value : newVal;
																	newOpts += "<option value='" + el.value + "' " + (idx == 0 ? " selected " : '') + ">" + el.label + "</option>";
															});
													} else if (!!conf.Values) {
															JSON.parse(conf.Values).map((el, idx) => {
																	newVal = idx == 0 ? el.value : newVal;
																	newOpts += "<option value='" + el.value + "' " + (idx == 0 ? " selected " : '') + ">" + el.label + "</option>";
															});
													}
													valueSelect.innerHTML = newOpts;
													conf.value = newVal;
											} else {
													// it is empty now, return input and show all operators
													valueInput.hidden = false;
													valueSelect.hidden = true;
													conf.value = valueInput.value;
											}
									}
									valueInput.type = conf.type === 'datetime2' ? 'date' : 'text';
									dr.hidden = conf.type !== 'datetime2';
									dr.value = '';
									var operators = holder.querySelector("#condition-operator-" + conf.guid);
									var changeFlag = 0;
									for (var opt of operators.options) {
											if (
													(conf.Merged === 1 && opt.value !== 'contains' && opt.value !== 'doesnotcontain') ||
													((!!conf.Values || conf.UseCountryMapping) && opt.value !== 'eq' && opt.value !== 'neq') ||
													(conf.type == 'datetime2' && !['eq', 'neq', 'gt', 'lt', 'gte', 'lte', 'isempty', 'isnotempty'].includes(opt.value))
											) {
													opt.hidden = true;
													if (opt.selected) {
															opt.selected = false;
															changeFlag = 1;
													}
											} else {
													opt.hidden = false;
											}
									}
									if (changeFlag) {
											for (var opt of operators.options) {
													if (
															(conf.Merged === 1 && opt.value == 'contains') ||
															((!!conf.Values || conf.UseCountryMapping) && opt.value == 'eq') ||
															(conf.type == 'datetime2' && ['eq', 'neq', 'gt', 'lt', 'gte', 'lte', 'isempty', 'isnotempty'].includes(opt.value))
													) {
															opt.selected = true;
															conf.operator = opt.value;
															break;
													}
											}
									}
							};
							filterSection.addDragNDropListeners(holder.querySelector("#query-condition-" + conf.guid), this.config);
							holder.querySelector("#condition-field-" + conf.guid).addEventListener('change', (e) => {
									reporting.changed = true;
									var old = { ...conf
									};
									var field = reporting.fieldSection.scEditor.sourceFields.find(f => f.cId === e.target.value);
									if (!!field) {
											conf.field = field.cId;
											conf.type = field.Type;
											conf.Merged = field.Merged;
											conf.FilterField = field.FilterField;
											conf.Values = field.Values;
											conf.table = field.TableName;
											conf.UseCountryMapping = field.UseCountryMapping;
									}
									var det = holder.querySelector('#condition-details-' + conf.guid);
									det.style.visibility = conf.FilterField ? "hidden" : "visible";
									proceesFieldChange(old, conf);
							});
							holder.querySelector("#condition-table-" + conf.guid).addEventListener('change', (e) => {
									reporting.changed = true;
									var table = this.tables.find(f => f.TableName === e.target.value);
									if (!!table) {
											conf.table = table.TableName;
									}
									var options = holder.querySelector("#condition-field-" + conf.guid).options;
									var changeSelected = false;
									var firstIdx = -1;
									for (var i = 0; i < options.length; i++) {
											if (!!!table)
													options[i].removeAttribute("hidden");
											else {
													if (table.TableName == options[i].value.split('$')[0]) {
															if (firstIdx == -1) {
																	firstIdx = i;
															}
															options[i].removeAttribute("hidden");
													} else {
															options[i].hidden = "hidden";
															if (options[i].selected) {
																	changeSelected = true;
																	options[i].selected = undefined;
															}
													}
											}
									}
									if (changeSelected) {
											options[firstIdx].selected = "selected";
											var old = { ...conf
											};
											var field = reporting.fieldSection.scEditor.sourceFields.find(f => f.cId === options[firstIdx].value);
											if (!!field) {
													conf.field = field.cId;
													conf.type = field.Type;
													conf.Merged = field.Merged;
													conf.FilterField = field.FilterField;
													conf.Values = field.Values;
													conf.table = field.TableName;
													conf.UseCountryMapping = field.UseCountryMapping;
											}
											var det = holder.querySelector('#condition-details-' + conf.guid);
											det.style.visibility = conf.FilterField ? "hidden" : "visible";
											proceesFieldChange(old, conf);
									}

							});
							holder.querySelector("#condition-operator-" + conf.guid).addEventListener('change', (e) => {
									reporting.changed = true;
									conf.operator = e.target.value;
									conf.range = '';
									var dr = holder.querySelector("#condition-daterange-" + conf.guid);
									dr.value = '';
							});
							holder.querySelector("#condition-daterange-" + conf.guid).addEventListener('change', (e) => {
									reporting.changed = true;
									conf.range = e.target.value;
									conf.operator = "gte";
									conf.value = filterSection.getDateRangeValue(conf.range);
									this.reload();
							});
							holder.querySelector("#condition-select-value-" + conf.guid).addEventListener('change', (e) => {
									reporting.changed = true;
									conf.value = e.target.value;
							});
							holder.querySelector("#condition-value-" + conf.guid).addEventListener('input', (e) => {
									// validate
									var reg = /[#$%^&*()+=\[\]{};''`:"\\|.<>\/?~@!]/;
									if ([
													"NOR_Data_Converted$Email",
													"NOR_Data_Converted$Requestor_Email",
													"NOR_Data_Converted$Reseller_Contact_Email",
													"NOR_Data_Converted$SoldTo_Contact_Email",
													"NOR_Data_Converted$ShipTo_Contact_Email",
													"NOR_Data_Converted$EndCx_Contact_Email",
													"NOR_Data_Converted$Payer_Contact_Email",
													"NOR_Data_Converted$BillTo_Contact_Email",
													"NOR_Data_Converted$EntPrty_Contact_Email",
													"NOR_Data_Converted$EndCx_SysMng_Email",
													"NOR_Data_Converted$Notification_CC",
													"NOR_Data_Converted$OnBehalf_CreatedBy",
													"NOR_Data_Converted$OnBehalf_SubmittedBy",
											].includes(conf.field)) {
											reg = /[#$%^&*()=\[\]{};''`:"\\|<>\/?~]/;
									}
									var err = false;
									if (e.target.type == "text" && reg.test(e.target.value)) {
											mo.fn.modal.show({
													ctaLabel: "Close",
													class: "query-error-window",
													title: "Error",
													content: "<div>Incorrect character entered</div>",
											});
											err = true;
									}
									if (err) {
											holder.querySelector("#condition-value-" + conf.guid).value = conf.value;
									} else {
											reporting.changed = true;
											conf.value = e.target.value;
											conf.range = '';
											var dr = holder.querySelector("#condition-daterange-" + conf.guid);
											dr.value = '';
									}
							});
							holder.querySelector("#condition-value-" + conf.guid).addEventListener('paste', (e) => {
									e.preventDefault();
									var pastedText = '';
									if (e.clipboardData && e.clipboardData.getData) { // Standards Compliant FIRST!
											pastedText = e.clipboardData.getData('text/plain');
									} else if (window.clipboardData && window.clipboardData.getData) { // IE
											pastedText = window.clipboardData.getData('Text');
									}
									// validate
									var reg = /[#$%^&*()+=\[\]{};''`:"\\|.<>\/?~@!]/;
									if ([
													"NOR_Data_Converted$Email",
													"NOR_Data_Converted$Requestor_Email",
													"NOR_Data_Converted$Reseller_Contact_Email",
													"NOR_Data_Converted$SoldTo_Contact_Email",
													"NOR_Data_Converted$ShipTo_Contact_Email",
													"NOR_Data_Converted$EndCx_Contact_Email",
													"NOR_Data_Converted$Payer_Contact_Email",
													"NOR_Data_Converted$BillTo_Contact_Email",
													"NOR_Data_Converted$EntPrty_Contact_Email",
													"NOR_Data_Converted$EndCx_SysMng_Email",
													"NOR_Data_Converted$Notification_CC",
													"NOR_Data_Converted$OnBehalf_CreatedBy",
													"NOR_Data_Converted$OnBehalf_SubmittedBy",
											].includes(conf.field)) {
											reg = /[#$%^&*()=\[\]{};''`:"\\|<>\/?~]/;
									}
									if (e.target.type == "text" && reg.test(pastedText)) {
											mo.fn.modal.show({
													ctaLabel: "Close",
													class: "query-error-window",
													title: "Error",
													content: "<div>Incorrect character entered</div>",
											});
											return;
									}
									this.value = pastedText.trim();
									reporting.changed = true;
									conf.value = this.value;
									conf.range = '';
									var dr = holder.querySelector("#condition-daterange-" + conf.guid);
									dr.value = '';
									this.reload();
							});
							holder.querySelector("#condition-value-" + conf.guid).addEventListener('dragstart', (e) => {
									e.preventDefault();
									e.stopPropagation();
									return false;
							});
							holder.querySelector("#condition-remove-" + conf.guid).addEventListener('click', (e) => {
									reporting.changed = true;
									var newConf = this.removeNode(conf.guid, this.config);
									this.config = { ...newConf
									};
									this.reload();
							});
							holder.querySelector("#condition-remove-" + conf.guid).addEventListener('mousedown', (e) => {
									e.preventDefault();
									e.stopPropagation();
									return false;
							});
							holder.querySelector("#condition-details-" + conf.guid).addEventListener('click', (e) => {
									detailsSection.init("Filter value", {
											"Value": conf.value
									});
							});
							holder.querySelector("#condition-details-" + conf.guid).addEventListener('mousedown', (e) => {
									e.preventDefault();
									e.stopPropagation();
									return false;
							});
					}
					if (!!conf.conditions && !!conf.conditions.length) {
							conf.conditions.map(el => {
									this.addEventListeners(holder, el);
							});
					}
			},
			getItm: function(target) {
					try {
							while (target.className != 'query-filter-condition' && target.className != 'query-filter-group' && target.data('root') != true) {
									target = target.parentNode;
							}
							if (target.nodeName.toLowerCase() == 'body') {
									return false;
							} else {
									return target;
							}
					} catch (e) {
							return false;
					}
			},
			addDragNDropListeners: function(node, config) {
					node.addEventListener('dragstart', function(event) {
							var target = filterSection.getItm(event.target);
							reporting.dragging = target;
							event.dataTransfer.setData('text/plain', null);
							event.dataTransfer.setDragImage(reporting.dragging, 0, 0);
					});

					node.addEventListener('dragover', function(event) {
							event.preventDefault();
							var target = filterSection.getItm(event.target);
							console.log(target);
							if (target) {
									var bounding = target.getBoundingClientRect();
									var offset = bounding.y + (bounding.height / 2);
									if (target.className == 'query-filter-group') {
											if (event.clientY - bounding.top <= 8) {
													target.style['border-top'] = 'solid 4px blue';
													target.style['border-bottom'] = '';
													target.style['background-color'] = '';
													target.style['opacity'] = '1';
											} else if (bounding.bottom - event.clientY <= 8) {
													target.style['border-bottom'] = 'solid 4px blue';
													target.style['border-top'] = '';
													target.style['background-color'] = '';
													target.style['opacity'] = '1';
											} else {
													target.style['background-color'] = 'lightblue';
													target.style['opacity'] = '0.7';
													target.style['border-top'] = '';
													target.style['border-bottom'] = '';
											}
									} else {
											if (event.clientY - offset > 0) {
													target.style['border-bottom'] = 'solid 4px blue';
													target.style['border-top'] = '';
											} else {
													target.style['border-top'] = 'solid 4px blue';
													target.style['border-bottom'] = '';
											}
											while (true) {
													if (target.className == 'query-filter-group') {
															target.style['background-color'] = 'lightblue';
															target.style['opacity'] = '0.7';
															break;
													}
													if (!target.parentNode) {
															break;
													}
													target = target.parentNode;
											}
									}
							}
					});

					node.addEventListener('dragleave', function(event) {
							var target = filterSection.getItm(event.target);
							target.style['border-bottom'] = '';
							target.style['border-top'] = '';
							target.style['background-color'] = '';
							target.style['opacity'] = '1';
					});

					node.addEventListener('drop', function(event) {
							event.preventDefault();
							if (reporting.dragging == null) {
									return;
							}
							var target = filterSection.getItm(event.target);
							var sourceId = reporting.dragging.id.replace("query-condition-", "").replace("group-", "");
							var targetId = target.id.replace("query-condition-", "").replace("group-", "");
							var after = false;
							var lastEl = false;
							var inGroup = false;
							var parentId = target.parentNode.id.replace("query-condition-", "").replace("group-", "").replace("query-filter-conditions-", "");
							var sourceParentId = reporting.dragging.parentNode.id.replace("query-condition-", "").replace("group-", "").replace("query-filter-conditions-", "");
							var currType = reporting.dragging.dataset.type;
							if (target.dataset.type !== reporting.dragging.dataset.type) {
									reporting.dragging = null;
									target.style['border-bottom'] = '';
									target.style['border-top'] = '';
									target.style['background-color'] = '';
									target.style['opacity'] = '1';
									return;
							}
							if (target.style['background-color'] !== '') {
									target.style['background-color'] = '';
									target.style['opacity'] = '1';
									target.appendChild(reporting.dragging);
									inGroup = true;
							} else if (target.style['border-bottom'] !== '') {
									after = true;
									lastEl = !!!event.target.nextSibling;
									target.style['border-bottom'] = '';
									target.style['background-color'] = '';
									target.style['opacity'] = '1';
									target.parentNode.insertBefore(reporting.dragging, event.target.nextSibling);
							} else {
									target.style['border-top'] = '';
									target.style['background-color'] = '';
									target.style['opacity'] = '1';
									target.parentNode.insertBefore(reporting.dragging, event.target);
							}
							while (true) {
									if (target.className == 'query-filter-group-root') {
											break;
									}
									target.style['border-bottom'] = '';
									target.style['border-top'] = '';
									target.style['background-color'] = '';
									target.style['opacity'] = '1';
									target = target.parentNode;
							}
							filterSection.moveFilter(sourceParentId, sourceId, parentId, targetId, after, lastEl, inGroup, config);
					});
			},
			popNode: function(parentId, id, conf) {
					var node = null;
					if (conf.isGroup && conf.guid === parentId) {
							var idx = conf.conditions.findIndex(c => c.guid === id);
							if (idx > -1) {
									var arr = conf.conditions.splice(idx, 1);
									return arr[0];
							}
					} else if (!!conf.conditions && !!conf.conditions.length) {
							conf.conditions.map(c => {
									if (c.isGroup) {
											var res = this.popNode(parentId, id, c);
											if (node == null && res !== null) {
													node = res;
											}
									}
							});
					}
					return node;
			},
			insertNode: function(node, parentId, targetId, after, lastEl, inGroup, conf) {
					if (conf.isGroup && conf.guid === parentId) {
							var idx = conf.conditions.findIndex(c => c.guid === targetId);
							if (idx > -1) {
									if (inGroup && conf.conditions[idx].isGroup) {
											conf.conditions[idx].conditions.push(node);
											return true;
									}
									if (!!lastEl) {
											conf.conditions.push(node);
											return true;
									} else {
											if (after) {
													idx++;
											}
											conf.conditions.splice(idx, 0, node);
											return true;
									}
							}
					} else if (!!conf.conditions && !!conf.conditions.length) {
							var res = false;
							conf.conditions.map(c => {
									if (!res && c.isGroup) {
											res = this.insertNode(node, parentId, targetId, after, lastEl, inGroup, c);
									}
							});
							return res;
					}
			},
			moveFilter: function(sourceParentId, sourceId, parentId, targetId, after, lastEl, inGroup, conf) {
					console.log("pre move", conf);
					var sourceNode = this.popNode(sourceParentId, sourceId, conf);
					if (sourceNode != null) {
							this.insertNode(sourceNode, parentId, targetId, after, lastEl, inGroup, conf);
							reporting.changed = true;
					}
					console.log("post move", conf);
					reporting.dragging = null;
			},
			dateRangeArray: [{
							option: 'Custom',
							value: ''
					},
					{
							option: 'Past Month',
							value: 'past1mon'
					},
					{
							option: 'Past 3 Months',
							value: 'past3mon'
					},
					{
							option: 'Past 6 Months',
							value: 'past6mon'
					},
					{
							option: 'Past 12 Months',
							value: 'past12mon'
					},
					{
							option: 'Month to Date',
							value: 'mtd'
					},
					{
							option: 'Quarter to Date',
							value: 'qtd'
					},
					{
							option: 'Year to Date',
							value: 'ytd'
					},
			],
			getDateRangeValue: function(val) {
					var pd = new Date();
					switch (val) {
							case 'past1mon':
									pd.setMonth(pd.getMonth() - 1);
									return pd.toISOString().split('T')[0];
							case 'past3mon':
									pd.setMonth(pd.getMonth() - 3);
									return pd.toISOString().split('T')[0];
							case 'past6mon':
									pd.setMonth(pd.getMonth() - 6);
									return pd.toISOString().split('T')[0];
							case 'past12mon':
									pd.setMonth(pd.getMonth() - 12);
									return pd.toISOString().split('T')[0];
							case 'mtd':
									var firstD;
									firstD = new Date(pd.getFullYear(), pd.getMonth(), 2);
									return firstD.toISOString().split('T')[0];
							case 'qtd':
									var quarter = Math.floor((pd.getMonth() / 3));
									var startDate = new Date(pd.getFullYear(), quarter * 3, 2);
									return startDate.toISOString().split('T')[0];
							case 'ytd':
									var firstD = new Date(pd.getFullYear(), 0, 2);
									return firstD.toISOString().split('T')[0];
							case 'custom':
									return new Date().toISOString().split('T')[0];
					}
			},
	};

	function getFilter() {
			return { ...filterSection
			};
	};
</script>
<!-- COMPONENT SEARCH -->
<script>
	const search = {
			ready: false,
			init: function() {
					if (search.ready == false) {
							var selector = document.querySelector("#icons li[icon-id=search] svg");
							var parent = document.querySelector("#icons li[icon-id=search]");
							selector.addEventListener("click", function(e) {
									if (parent.getAttribute("class") != null && parent.getAttribute("class") == "open") {
											var query = parent.querySelector("input").value;
											if (query.length > 0) {
													review._init(query, "search");
											} else if (query.length == 0) {
													parent.classList.remove("open");
											} else {
													mo.fn.modal.show({
															ctaLabel: "OK",
															title: "Invalid application query",
															content: "<p>Please provide a valid PO Number. Thank you!</p>"
													});
											}
									}
							});
							search.ready = true;
					}
			}
	}
</script>
<!-- TIER 2 COMPONENTS -->
<!-- COMPONENT PROFILE -->
<script>
	const profile = {
			ready: false,
			_init: function() {
					if (!profile.ready) {
							profile._personal();
							profile._roles();
							profile.ready = true;
					}
			},
			_personal: function() {
					var personal = document.querySelector("#profile .personal");
					personal.innerHTML += '<p style="display:none;">ID: ' + applet.user.EntryId + '</p>';
					personal.innerHTML += '<p>Name: ' + applet.user.Name + '</p>';
					personal.innerHTML += '<p>Email: ' + applet.user.Email + '</p>';
					personal.innerHTML += '<p>Logged in: ' + applet.user.LastLogin.split("T").join(", ") + '</p>';
			},
			_roles: function() {
					var selector = document.querySelector("#profile .roles ul");

					function regional(role) {
							var regions = [];
							var keys = Object.keys(applet.user.UserRole[role]);
							for (i = 0; i < keys.length; i++)
									if (applet.user.UserRole[role][keys[i]])
											regions.push(keys[i]);
							if (regions.length > 0) return regions.join(", ");
							else return false;
					}

					function insert(role, regions) {
							switch (role.toLowerCase()) {
									case "admin":
											return "Administrator";
											break;
									case "user":
											return "User manager";
											break;
									case "ops":
											return "Operations (" + regions + ")";
											break;
									case "srp":
											return "Sales rep (" + regions + ")";
											break;
									case "ca":
											return "Country Administrator";
											break;
									case "stat":
											return "Reporting";
											break;
									case "lang":
											return "Localization";
											break;
									default:
											return "Unrecognized";
											break;
							}
					}
					var keys = Object.keys(applet.user.UserRole).sort();
					for (j = 0; j < keys.length; j++) {
							if (applet.user.UserRole[keys[j]]) {
									if (typeof(applet.user.UserRole[keys[j]]) === "boolean")
											selector.innerHTML += '<li>' + insert(keys[j]) + '<span>âœ“</span></li>';
									else if (regional(keys[j]))
											selector.innerHTML += '<li>' + insert(keys[j], regional(keys[j])) + '<span>âœ“</span></li>';
							}
					}
					// ADD ADMIN UI SUPPORT FROM PROFILE
					if (typeof(applet.user.UserRole.ADMIN) === "boolean" && applet.user.UserRole.ADMIN) {
							document.querySelector("#profile .action").classList.add("dual");
							document.querySelector("#profile .admin").addEventListener("click", function(e) {
									ui.nav.reset();
									document.querySelector("#admin").classList.toggle("active");
									document.getElementById("profile").classList.remove("open");
									ui._component("admin");
							});
					}
			}
	}
</script>
<!-- COMPONENT LOCALIZATION -->
<script>
	const localization = {
			ready: false,
			data: {},
			_init: function() {
					if (!localization.ready) {
							mo.fn.overlay.show({
									loading: true,
									close: false
							});
							localization._ui();
							localization._getData(function() {
									localization.grid._load("#localization .grid", localization.data, localization.grid._config());
									localization.ready = true;
									mo.fn.overlay.hide();
							});
					}
			},
			_ui: function() {
					// TABS
					if (document.querySelector("#localization .tabs") == null)
							document.querySelector("#localization").innerHTML += '<section class="tabs"></div>';
					if (document.querySelector("#localization .container") == null)
							document.querySelector("#localization").innerHTML += '<section class="container"></div>';
					document.querySelector("#localization .tabs").innerHTML += '<span tab-id="translations" class="active">Translations</span>';
					document.querySelector("#localization .container").innerHTML += '<section tab-id="translations" class="active"><div class="grid"></div><div class="toolbar"><div class="k-header k-grid-toolbar"><a role="button" class="k-button k-button-icontext k-grid-add" href="#">Add key</a></div></div></section>';
					// ADD REFRESH
					document.querySelector("#localization").innerHTML += '<span class="refresh"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="refresh" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M20,8 C18.5974037,5.04031171 15.536972,3 12,3 C7.02943725,3 3,7.02943725 3,12 C3,16.9705627 7.02943725,21 12,21 L12,21 C16.9705627,21 21,16.9705627 21,12 M21,3 L21,9 L15,9"></path></svg></span>';
					document.querySelector("#localization span.refresh").addEventListener("click", localization._refresh);
			},
			_refresh: function() {
					var g = $("#localization .grid").data("kendoGrid");
					var s = g.dataSource.pageSize();
					var p = g.dataSource.page();
					document.querySelector("#localization").innerHTML = "";
					localization.ready = false;
					localization._init();
					g = $("#localization .grid").data("kendoGrid");
					g.dataSource.pageSize(s);
					g.dataSource.page(p);
			},
			_softRefresh: function() {
					var g = $("#localization .grid").data("kendoGrid");
					var s = g.dataSource.pageSize();
					var p = g.dataSource.page();
					document.querySelector("#localization").innerHTML = "";
					localization._ui();
					localization.grid._load("#localization .grid", localization.data, localization.grid._config());
					g = $("#localization .grid").data("kendoGrid");
					g.dataSource.pageSize(s);
					g.dataSource.page(p);
			},
			_getData: function(callback) {
					bigd.r.lng.all(function(d) {
							localization.data = d.Data;
							if (typeof(callback) === "function") callback();
					});
			},
			_modal: function(type, data) {
					if (type == "add") {
							var ctalabel = "CREATE";
							var modtitle = "Create language key";
					} else {
							var ctalabel = "SAVE";
							var modtitle = "Edit language key";
					}
					mo.fn.modal.show({
							ctaLabel: ctalabel,
							title: modtitle,
							content: '<div class="nbsf" style="overflow:hidden;padding-bottom:10px;max-width:100%"><div class="tabs"></div><div class="container"></div></div>',
							contentCallback: function() {
									var target = document.querySelector(".dxpModalContent .nbsf");
									var tabs = target.querySelector(".tabs");
									var container = target.querySelector(".container");

									// ADD TABS
									tabs.innerHTML += '<span tab-id="ids" class="active">IDs</span>';
									container.innerHTML += '<div tab-id="ids" class="active"></div>';
									tabs.innerHTML += '<span tab-id="ams">AMS</span>';
									container.innerHTML += '<div tab-id="ams"></div>';
									tabs.innerHTML += '<span tab-id="emea">EMEA</span>';
									container.innerHTML += '<div tab-id="emea"></div>';
									tabs.innerHTML += '<span tab-id="apj">APJ</span>';
									container.innerHTML += '<div tab-id="apj"></div>';

									// ADD FIELDSETS
									container.querySelector("div[tab-id=ids]").innerHTML = '<div class="row">' +
											'<fieldset>' +
											'<label class="wrapper text" style="display:block;">' +
											'<span class="name">Key ID</span><span class="required">*</span>' +
											'<div class="fmmcosmin">' +
											'<input type="text" value="" placeholder="Language key ID" data-name="StringKey">' +
											'</div>' +
											'</label>' +
											'<label class="wrapper text" style="display:block;">' +
											'<span class="name">Group ID</span><span class="required">*</span>' +
											'<div class="fmmcosmin">' +
											'<input type="text" value="" placeholder="Group key ID" data-name="GroupKeys">' +
											'</div>' +
											'</label>' +
											'</fieldset>' +
											'</div>';
									container.querySelector("div[tab-id=emea]").innerHTML = '<div class="row">' +
											'<fieldset>' +
											'<label class="wrapper text" style="display:block;">' +
											'<span class="name">German (Germany)</span><span class="required">*</span>' +
											'<div class="fmmcosmin">' +
											'<input type="text" value="" placeholder="German" data-name="de_DE">' +
											'</div>' +
											'</label>' +
											'<label class="wrapper text" style="display:block;">' +
											'<span class="name">French (France)</span><span class="required">*</span>' +
											'<div class="fmmcosmin">' +
											'<input type="text" value="" placeholder="French" data-name="fr_FR">' +
											'</div>' +
											'</label>' +
											'<label class="wrapper text" style="display:block;">' +
											'<span class="name">Italian (Italy)</span><span class="required">*</span>' +
											'<div class="fmmcosmin">' +
											'<input type="text" value="" placeholder="Spanish" data-name="it_IT">' +
											'</div>' +
											'</label>' +
											'<label class="wrapper text" style="display:block;">' +
											'<span class="name">Russian (Russia)</span><span class="required">*</span>' +
											'<div class="fmmcosmin">' +
											'<input type="text" value="" placeholder="Russian" data-name="ru_RU">' +
											'</div>' +
											'</label>' +
											'<label class="wrapper text" style="display:block;">' +
											'<span class="name">Spanish (Spain)</span><span class="required">*</span>' +
											'<div class="fmmcosmin">' +
											'<input type="text" value="" placeholder="Spanish" data-name="es_ES">' +
											'</div>' +
											'</label>' +
											'<label class="wrapper text" style="display:block;">' +
											'<span class="name">Turkish (Turkey)</span><span class="required">*</span>' +
											'<div class="fmmcosmin">' +
											'<input type="text" value="" placeholder="Turkish" data-name="tr_TR">' +
											'</div>' +
											'</label>' +
											'</fieldset>' +
											'</div>';
									container.querySelector("div[tab-id=apj]").innerHTML = '<div class="row">' +
											'<fieldset>' +
											'<label class="wrapper text" style="display:block;">' +
											'<span class="name">Indonesian (Indonesia)</span><span class="required">*</span>' +
											'<div class="fmmcosmin">' +
											'<input type="text" value="" placeholder="Indonesian" data-name="id_ID">' +
											'</div>' +
											'</label>' +
											'<label class="wrapper text" style="display:block;">' +
											'<span class="name">Japanese (Japan)</span><span class="required">*</span>' +
											'<div class="fmmcosmin">' +
											'<input type="text" value="" placeholder="Japanese" data-name="ja_JP">' +
											'</div>' +
											'</label>' +
											'<label class="wrapper text" style="display:block;">' +
											'<span class="name">Korean (South Korea)</span><span class="required">*</span>' +
											'<div class="fmmcosmin">' +
											'<input type="text" value="" placeholder="Korean" data-name="ko_KR">' +
											'</div>' +
											'</label>' +
											'<label class="wrapper text" style="display:block;">' +
											'<span class="name">Chinese (Simplified)</span><span class="required">*</span>' +
											'<div class="fmmcosmin">' +
											'<input type="text" value="" placeholder="Chinese (CN)" data-name="zh_CN">' +
											'</div>' +
											'</label>' +
											'<label class="wrapper text" style="display:block;">' +
											'<span class="name">Chinese (Traditional)</span><span class="required">*</span>' +
											'<div class="fmmcosmin">' +
											'<input type="text" value="" placeholder="Chinese (TW)" data-name="zh_TW">' +
											'</div>' +
											'</label>' +
											'</fieldset>' +
											'</div>';
									container.querySelector("div[tab-id=ams]").innerHTML = '<div class="row">' +
											'<fieldset>' +
											'<label class="wrapper text" style="display:block;">' +
											'<span class="name">English (US)</span><span class="required">*</span>' +
											'<div class="fmmcosmin">' +
											'<input type="text" value="" placeholder="English" data-name="en_US">' +
											'</div>' +
											'</label>' +
											'<label class="wrapper text" style="display:block;">' +
											'<span class="name">Protuguese (Brazil)</span><span class="required">*</span>' +
											'<div class="fmmcosmin">' +
											'<input type="text" value="" placeholder="Portuguese" data-name="pt_BR">' +
											'</div>' +
											'</label>' +
											'</fieldset>' +
											'</div>';

									if (type == "edit") {
											container.querySelector("input[data-name=StringKey]").disabled = true;
											container.querySelector("input[data-name=GroupKeys]").disabled = true;

											var inputs = container.querySelectorAll("input");
											for (i = 0; i < inputs.length; i++)
													inputs[i].value = data[inputs[i].getAttribute("data-name")]

											if (container.querySelector("input[data-name=GroupKeys]").value.length == 0)
													container.querySelector("input[data-name=GroupKeys]").value = "Global";
									}

									// ADD TABS FUNCTIONALITY
									var allt = tabs.querySelectorAll("span");
									var allc = container.querySelectorAll("div[tab-id]");

									function hideAll() {
											for (i = 0; i < allt.length; i++)
													allt[i].setAttribute("class", "");
											for (i = 0; i < allc.length; i++)
													allc[i].setAttribute("class", "");
									}
									for (i = 0; i < allt.length; i++) {
											allt[i].addEventListener("click", function(e) {
													var tabid = e.target.getAttribute("tab-id");
													hideAll();
													e.target.classList.add("active");
													container.querySelector("div[tab-id=" + tabid + "]").classList.add("active");
											});
									}
									// TOGGLES
									var alltog = container.querySelectorAll("div.toggle");
									for (i = 0; i < alltog.length; i++) {
											alltog[i].addEventListener("click", function(e) {
													var el = e.target.closest("label");
													el.classList.toggle("active");
													if (el.getAttribute("class") == "active") el.querySelector("input").value = "Y";
													else el.querySelector("input").value = "N";
											});
									}

									mo.fn.overlay.show({
											close: false
									})
							},
							ctaCallback: function() {
									// HELPERS
									var sel = document.querySelector(".dxpModalContent");
									var def = {
											StringKey: "",
											GroupKeys: "",
											en_US: "",
											pt_BR: "",
											de_DE: "",
											fr_FR: "",
											it_IT: "",
											ru_RU: "",
											es_ES: "",
											tr_TR: "",
											id_ID: "",
											ja_JP: "",
											ko_KR: "",
											zh_CN: "",
											zh_TW: ""
									};
									var cnt = 0;
									for (i = 0; i < Object.keys(def).length; i++) {
											var key = Object.keys(def)[i];
											var input = sel.querySelector("input[data-name=" + key + "]");
											def[key] = input.value;
											if (def[key].length == 0) cnt++;
									}

									// UPDATE DATABASE
									mo.fn.modal.lock();
									if (type == "add") {
											if (cnt > 0) {
													mo.fn.modal.msg("Please provide all the required information in the form", 3);
													mo.fn.modal.unlock();
											} else {
													crud.read("3374", "skey=" + def.StringKey, function(d) {
															try {
																	if (d.Rows.length > 0) {
																			mo.fn.modal.msg("A language key already exists with the key provided in the form; please provide a unique key or edit the existing key", 3);
																			mo.fn.modal.unlock();
																	} else {
																			crud.create("3377", def, function(d) {
																					try {
																							mo.fn.modal.msg("Language key was succesfully created (" + d.EntryId + ")", 1);
																							var inputs = sel.querySelectorAll("input");
																							for (i = 0; i < inputs.length; i++)
																									inputs[i].value = "";
																							// PUSH TO DATA
																							localization.data.push(d);
																							localization._softRefresh();
																							mo.fn.modal.unlock();
																					} catch (err) {
																							mo.fn.modal.msg("An error occurred writing to the database. Please try again later.", 3);
																							mo.fn.modal.unlock();
																					}
																			});
																	}
															} catch (err) {
																	console.error(err);
																	mo.fn.modal.msg("An error occurred when accessing the language database. Please try again later.", 3);
																	mo.fn.modal.unlock();
															}
													});
											}
									} else if (type == "edit") {
											var eid = data.EntryId;
											crud.update("3376", eid, def, function(d) {
													if (typeof(d.EntryId) !== "undefined") {
															mo.fn.modal.msg("Language key was updated successfully.", 1);
															// PUSH TO DATA AND REFRESH
															var g = $("#localization .grid").data("kendoGrid");
															var p = g.dataSource.page();
															for (i = 0; i < localization.data.length; i++) {
																	if (localization.data[i].EntryId == d.EntryId) {
																			localization.data[i] = d;
																			localization._softRefresh();
																			break;
																	}
															}
															mo.fn.modal.unlock();
													} else {
															mo.fn.modal.msg("An error occured when writing to the database. Please try again later.", 3);
															mo.fn.modal.unlock();
													}
											});
									}
							}
					});
			},
			grid: {
					_custom: function() {
							var cusConfig = [{
											field: "StringKey",
											title: "Key ID",
											hidden: false,
											locked: true,
											width: "300px"
									},
									{
											field: "GroupKeys",
											title: "Key groups",
											hidden: false,
											locked: true,
											width: "300px"
									},
									{
											field: "EntryId",
											hidden: true
									},
									{
											field: "Created",
											hidden: true
									},
									{
											field: "CreatedBy",
											hidden: true
									},
									{
											field: "Modified",
											hidden: true
									},
									{
											field: "ModifiedBy",
											hidden: true
									},
									{
											title: "",
											width: "40px",
											locked: true,
											attributes: {
													"class": "cta"
											},
											template: function(d) {
													var icons = '<a class="edit"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="copy"><path fill="none" stroke="#666" stroke-width="2" d="M14,4 L20,10 L14,4 Z M22.2942268,5.29422684 C22.6840146,5.68401459 22.6812861,6.3187139 22.2864907,6.71350932 L9,20 L2,22 L4,15 L17.2864907,1.71350932 C17.680551,1.319449 18.3127724,1.31277239 18.7057732,1.70577316 L22.2942268,5.29422684 Z M3,19 L5,21 M7,17 L15,9"></path></svg></a>';
													return icons;
											}
									}
							];
							return cusConfig;
					},
					_default: function() {
							var defConfig = [];
							for (i = 0; i < Object.keys(localization.data[0]).length; i++) {
									var key = Object.keys(localization.data[0])[i];
									var obj = {};
									obj.field = key;
									obj.title = key;
									obj.hidden = false;
									obj.filterable = true;
									obj.width = "150px";
									obj.attributes = {
											style: "overflow: hidden;text-overflow: ellipsis; white-space: nowrap;"
									};
									defConfig.push(obj);
							}
							return defConfig;
					},
					_config: function() {
							var cusConfig = localization.grid._custom();
							var defConfig = localization.grid._default();
							for (j = cusConfig.length - 1; j >= 0; j--) {
									for (i = 0; i < defConfig.length; i++) {
											if (defConfig[i].field == cusConfig[j].field) {
													defConfig.splice(i, 1);
													break;
											}
									}
							}
							for (i = cusConfig.length - 1; i >= 0; i--) {
									defConfig.unshift(cusConfig[i]);
							}
							return defConfig;
					},
					_load: function(selector, datasource, config) {
							$(selector).kendoGrid({
									toolbar: ["excel"],
									excel: {
											fileName: "NORLocalizationsExport.xlsx",
											allPages: true
									},
									dataSource: {
											data: datasource,
											sort: {
													field: "EntryId",
													dir: "asc"
											}
									},
									columns: config,
									dataBound: function(e) {},
									pageable: {
											buttonCount: 4,
											pageSize: 10,
											pageSizes: [10, 25, 50, 100],
											messages: {
													itemsPerPage: ""
											}
									},
									scrollable: true,
									sortable: true,
									filterable: true
							});
							$(selector).delegate(".edit", "click", function(e) {
									var grid = $(selector).data("kendoGrid");
									var row = grid.dataItem($(this).closest("tr"));
									localization._modal("edit", row);
							});
							document.querySelector("#localization .toolbar .k-grid-add").addEventListener("click", function(e) {
									localization._modal("add");
							});
					}
			}
	}
</script>
<!-- COMPONENT CACHING -->
<script>
	const caching = {
			ready: false,
			node: document.querySelector("#caching"),
			init: function() {
					if (!this.ready) {
							mo.fn.overlay.show({
									loading: true,
									close: false
							});
							this._ui();
							this._emdm._grid.load(this.node.querySelector("[tab-id=emdm] .grid"));
							this._icm._grid.load(this.node.querySelector("[tab-id=icm] .grid"));
							this.ready = true;
							mo.fn.overlay.hide();
					}
			},
			_ui: function() {
					hpe.ui.tabs({
							dom: this.node,
							tabs: [{
											id: "emdm",
											label: "EMDM",
											html: '<div class="grid"></div>',
											active: true
									},
									{
											id: "icm",
											label: "iCertis",
											html: '<div class="grid"></div>'
									}
							]
					}, function() {});
					/*this.node.innerHTML += '<section class="tabs"></div>';
					this.node.innerHTML += '<section class="container"></div>';
					this.node.querySelector(".tabs").innerHTML += '<span tab-id="emdm" class="active">EMDM</span><span tab-id="icm" class="">iCertis</span>';
					this.node.querySelector(".container").innerHTML += '<section tab-id="emdm" class="active"></section><section tab-id="icm" class=""><div class="grid"></div></section>';*/
			},
			_emdm: {
					_grid: {
							load: function(selector) {
									mo.fn.overlay.show({
											loading: true,
											close: false
									});
									// load grid
									$(selector).kendoGrid({
											dataSource: caching._emdm._grid.datasource(),
											pageable: {
													pageSize: 4,
													refresh: true
											},
											scrollable: true,
											filterable: true,
											sortable: true,
											columns: this.columns(),
											noRecords: {
													template: "<center style='padding: 20px;font-size: 25px;'>No data available</center>"
											},
											dataBound: function(e) {
													mo.fn.overlay.hide();
											}
									});

									this.events(selector);
							},
							datasource: function() {
									return new kendo.data.DataSource({
											type: "rfb-v2",
											transport: {
													read: {
															url: "/form/data-set-provider/v2/989/NOR_EMDM_Cache/kendo/data/search",
															type: "post"
													}
											},
											schema: {
													model: {
															id: "EntryId"
													}
											},
											serverPaging: true,
											pageSize: 15,
											serverFiltering: true,
											serverSorting: true
									});
							},
							columns: function() {
									return [{
													field: "EntryId",
													title: "ID",
													filterable: false,
													width: "60px"
											},
											{
													field: "PartyId",
													title: "PartyId",
													filterable: true,
													width: "120px"
											},
											{
													field: "JSON",
													title: "EMDM",
													filterable: false,
													hidden: true
											},
											{
													field: "EMDMName",
													title: "Name",
													filterable: false,
													template: function(d) {
															var json = JSON.parse(d.JSON);
															var name = json.party[0].organizationName;
															if (name)
																	return name;
															return "N/A";
													}
											},
											{
													field: "EMDMCountry",
													title: "Country",
													filterable: false,
													width: "100px",
													template: function(d) {
															var json = JSON.parse(d.JSON);
															var country = json.party[0].countryCode;
															if (country)
																	return country;
															return "N/A";
													}
											},
											{
													field: "EMDMStatus",
													title: "Status",
													filterable: false,
													width: "100px",
													template: function(d) {
															var json = JSON.parse(d.JSON);
															var status = json.party[0].partyStatus;
															if (status)
																	return status;
															return "N/A";
													}
											},
											{
													field: "EMDMRole",
													title: "Partner",
													filterable: false,
													width: "100px",
													template: function(d) {
															var json = JSON.parse(d.JSON);
															if (caching._emdm._hasPartnerRole(json.party[0].businessRelationship));
															return "Yes";
															return "No";
													}
											},
											{
													field: "EMDMUpdate",
													title: "Update",
													filterable: false,
													width: "100px",
													template: function(d) {
															var json = JSON.parse(d.JSON);
															var date = json.party[0].lastUpdateDate;
															if (date)
																	return date.split(" ")[0];
															return "N/A";
													}
											},
											{
													field: "Created",
													title: "Created",
													filterable: false,
													width: "100px",
													template: function(d) {
															return d.Created.split("T")[0];
													}
											},
											{
													field: "Modified",
													title: "Synced",
													filterable: false,
													width: "100px",
													template: function(d) {
															return d.Modified.split("T")[0];
													}
											},
											{
													field: "ModifiedBy",
													title: "Synced by",
													filterable: true
											},
											{
													field: "Action",
													title: " ",
													filterable: false,
													width: "40px",
													attributes: {
															"class": "cta"
													},
													template: function(d) {
															return '<a class="icon recache"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="refresh" width="20px" height="20px"><path fill="none" stroke="#666" stroke-width="2" d="M20,8 C18.5974037,5.04031171 15.536972,3 12,3 C7.02943725,3 3,7.02943725 3,12 C3,16.9705627 7.02943725,21 12,21 L12,21 C16.9705627,21 21,16.9705627 21,12 M21,3 L21,9 L15,9"></path></svg></a>';
													}
											}
									]
							},
							events: function(selector) {
									$(selector).delegate(".icon.recache", "click", function(e) {
											var grid = $(selector).data("kendoGrid");
											var html = $(this).closest("tr");
											var row = grid.dataItem(html);

											let pid = row.PartyId;
											let eid = row.EntryId

											mo.fn.overlay.show({
													loading: true,
													close: false
											});

											hpe.data.xref(pid, function(emdm) {
													try {
															// error cases
															if (!emdm || typeof(emdm) !== 'object' || !emdm.code)
																	return mo.fn.modal.show({
																			title: "Response error encountered",
																			content: "Critical failure reading response from either one of RFB/DXP/EMDM while fetching PartyId " + pid,
																			ctaLabel: "OK"
																	});
															if (emdm.code !== "EMS000")
																	return mo.fn.modal.show({
																			title: "EMDM error encountered - " + emdm.code,
																			content: "EMDM returned an error while looking up PartyId " + pid,
																			ctaLabel: "OK"
																	});
															if (emdm.party.length != 1)
																	return mo.fn.modal.show({
																			title: "EMDM error encountered - results",
																			content: "EMDM returned either no result or multiple results",
																			ctaLabel: "OK"
																	});
															if (emdm.party[0].partyStatus != 'ACTIVE')
																	return mo.fn.modal.show({
																			title: "EMDM error encountered - party is " + emdm.party[0].partyStatus,
																			content: "EMDM status for fetched active is not 'Active'; this will result in issues in the application; cache record update is cancelled.",
																			ctaLabel: "OK"
																	});
															if (!caching._emdm._hasPartnerRole(emdm.party[0].businessRelationship))
																	return mo.fn.modal.show({
																			title: "EMDM error encountered - partner role",
																			content: "EMDM either is missing the Partner role on the Party, or the role is not in 'Active' status",
																			ctaLabel: "OK"
																	});
															if (pid != emdm.party[0].currentPartyID)
																	return mo.fn.modal.show({
																			title: "EMDM error encountered - party merge",
																			content: "Original PartyId " + pid + " has undergone a merge operation in EMDM; as a result, a new PartyId has been created to replace it (" + emdm.party[0].currentPartyid + "); a new cached record will be created once the user allocation is also updated to the new PartyId.",
																			ctaLabel: "OK"
																	});

															// update case
															crud.update("4606", eid, {
																	JSON: JSON.stringify(emdm)
															}, function(d) {
																	if (!d || !d.EntryId)
																			return mo.fn.modal.show({
																					title: "RFB error encountered",
																					content: "Failed to update cache record for PartyId " + pid + "; please try again later. If the issue persists, please raise a support ticket.",
																					ctaLabel: "OK"
																			});
																	caching._emdm._updateGridRow(grid, row, html, d);
																	return mo.fn.overlay.hide();
															});
													} catch (err) {
															console.error(err);
															return mo.fn.modal.show({
																	title: "Error encountered",
																	content: "An error encountered while retrieving and/or processing EMDM data. Please try again later or raise a ticket if issue continues.",
																	ctaLabel: "OK"
															});
													}
											});
									});
							}
					},
					_hasPartnerRole: function(roles) {
							for (let i = 0; i < roles.length; i++)
									if (roles[i].businessRelationshipCode == "PTNR" && roles[i].status == 'ACTIVE')
											return true;
							return false;
					},
					_updateGridRow: function(grid, row, html, data) {
							for (let i = 0; i < Object.keys(data).length; i++)
									row[Object.keys(data)[i]] = data[Object.keys(data)[i]];
							let newRow = grid.rowTemplate(row);
							html.replaceWith(newRow);
					}
			},
			_icm: {
					_grid: {
							load: function(selector) {
									mo.fn.overlay.show({
											loading: true,
											close: false
									});
									// load grid
									$(selector).kendoGrid({
											dataSource: caching._icm._grid.datasource(),
											pageable: {
													pageSize: 4,
													refresh: true
											},
											scrollable: true,
											filterable: true,
											sortable: true,
											columns: this.columns(),
											noRecords: {
													template: "<center style='padding: 20px;font-size: 25px;'>No data available</center>"
											},
											detailInit: this.details,
											dataBound: function(e) {
													mo.fn.overlay.hide();
											}
									});

									this.events(selector);
							},
							datasource: function() {
									return new kendo.data.DataSource({
											type: "rfb-v2",
											transport: {
													read: {
															url: "/form/data-set-provider/v2/1582/NOR_ICM_Cache/kendo/data/search",
															type: "post"
													}
											},
											schema: {
													model: {
															id: "EntryId"
													}
											},
											serverPaging: true,
											pageSize: 15,
											serverFiltering: true,
											serverSorting: true
									});
							},
							columns: function() {
									return [{
													field: "EntryId",
													title: "ID",
													filterable: false,
													width: "60px"
											},
											{
													field: "PartyId",
													title: "PartyId",
													filterable: true,
													width: "160px"
											},
											{
													field: "CountryEntity",
													title: "CountryEntity",
													filterable: true,
													width: "160px"
											},
											{
													field: "GlobalEntity",
													title: "GlobalEntity",
													filterable: true,
													width: "160px"
											},
											{
													field: "BRT",
													title: "BRT",
													filterable: true,
													width: "120px"
											},
											{
													field: "PAs",
													title: "PAs",
													filterable: false,
													template: function(d) {
															var json = JSON.parse(d.JSON);
															var list = '';
															json.forEach(function(agr, idx) {
																	list += agr.iCMPANumber;
																	if (idx < json.length)
																			list += '; ';
															});
															return list;
													}
											},
											{
													field: "JSON",
													title: "EMDM",
													filterable: false,
													hidden: true
											},
											/*{
												field: "EMDMUpdate",
												title: "Update",
												filterable: false,
												width: "100px",
												template: function(d) {
													var json = JSON.parse(d.JSON);
													var date = json.party[0].lastUpdateDate;
													if(date)
														return date.split(" ")[0];
													return "N/A";
												}
											},*/
											{
													field: "Created",
													title: "Created",
													filterable: false,
													width: "100px",
													template: function(d) {
															return d.Created.split("T")[0];
													}
											},
											{
													field: "Modified",
													title: "Synced",
													filterable: false,
													width: "100px",
													template: function(d) {
															return d.Modified.split("T")[0];
													}
											},
											{
													field: "ModifiedBy",
													title: "Synced by",
													filterable: true
											},
											{
													field: "Action",
													title: " ",
													filterable: false,
													width: "40px",
													attributes: {
															"class": "cta"
													},
													template: function(d) {
															return '<a class="icon recache"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="refresh" width="20px" height="20px"><path fill="none" stroke="#666" stroke-width="2" d="M20,8 C18.5974037,5.04031171 15.536972,3 12,3 C7.02943725,3 3,7.02943725 3,12 C3,16.9705627 7.02943725,21 12,21 L12,21 C16.9705627,21 21,16.9705627 21,12 M21,3 L21,9 L15,9"></path></svg></a>';
													}
											}
									]
							},
							events: function(selector) {
									$(selector).delegate(".icon.recache", "click", function(e) {
											var grid = $(selector).data("kendoGrid");
											var html = $(this).closest("tr");
											var row = grid.dataItem(html);

											caching._icm._sync(grid, row, html);
									});
							},
							details: function(e) {
									$("<div/>").appendTo(e.detailCell).kendoGrid({
											dataSource: JSON.parse(e.data.JSON),
											scrollable: false,
											sortable: false,
											pageable: false,
											columns: [{
															field: "iCMPANumber",
															title: "PA",
															width: "80px"
													},
													{
															field: "iCMPartyID",
															title: "Signed by",
															width: "120px"
													},
													{
															field: "Participation",
															title: "Participating",
															template: function(d) {
																	let str = '';
																	str = '<strong>Party</strong>: ' + d.iCMParticipatingParties;
																	if (d.iCMParticipatingCEs)
																			str += '<br><strong>CE</strong>: ' + d.iCMParticipatingCEs;
																	if (d.iCMParticipatingGEs)
																			str += '<br><strong>GE</strong>: ' + d.iCMParticipatingGEs;
																	return str;
															}
													},
													{
															field: "entityName",
															title: "Channel",
															width: "200px"
													},
													{
															field: "status",
															title: "Status",
															width: "120px"
													},
													{
															field: "iCMS4Status",
															title: "S4",
															width: "120px"
													}
											]
									});
							}
					},
					_modal: function(grid, row, html) {
							console.log(row);

							let config = this._config(grid, row, html);

							mo.fn.modal.show({
									title: "Refresh iCertis data",
									content: "<div id='icm-nbsf'></div>",
									contentCallback: function() {
											config.dom = document.querySelector('#icm-nbsf');
											nbsf.init(config, 0);
									},
									ctaLabel: "OK",
									class: "minimal",
									width: 540
							})
					},
					_config: function(grid, row, html) {
							return {
									dataset: row,
									pages: [{
											"nav": true,
											"structure": [{
													"group": [
															[{
																			label: "PartyId",
																			type: "text",
																			disabled: true,
																			data: "PartyId"
																	},
																	{
																			label: "BRT",
																			type: "text",
																			disabled: true,
																			data: "BRT"
																	},
																	{
																			label: "Channel",
																			type: "text",
																			disabled: false,
																			data: "Channel"
																	}
															],
															[{
																			label: "Country Entity",
																			type: "text",
																			disabled: false,
																			data: "CountryEntity"
																	},
																	{
																			label: "Global Entity",
																			type: "text",
																			disabled: false,
																			data: "GlobalEntity"
																	}
															]
													]
											}]
									}],
									onSubmit: function() {
											mo.fn.modal.lock();
											let dataset = this.dataset;
											console.log(dataset);
											if (
													(dataset.CountryEntity && [0, 9].indexOf(dataset.CountryEntity.length) == -1) ||
													(dataset.GlobalEntity && [0, 9].indexOf(dataset.GlobalEntity.length) == -1)
											) {
													mo.fn.modal.unlock();
													return mo.fn.modal.msg('Parent groupings are formatted incorrectly; please check the data and try again', 3);
											}

											caching._icm._search(dataset, function(json) {
													if (!json) {
															mo.fn.modal.unlock();
															return mo.fn.modal.msg('An error was encountered while searching data in iCertis; Either execution has failed or no data has been found', 3);
													}
													crud.update('4688', dataset.EntryId, {
																	CountryEntity: dataset.CountryEntity,
																	GlobalEntity: dataset.GlobalEntity,
																	JSON: json
															},
															function(u) {
																	mo.fn.modal.unlock();
																	if (u.EntryId) {
																			caching._icm._updateGridRow(grid, row, html, u);
																			return mo.fn.modal.msg('Cached record successfully refreshed', 1);
																	}
																	return mo.fn.modal.msg('Failed to update cached record after fetching iCertis data');
															});
											});
									}
							};
					},
					_sync: function(grid, row, html) {
							mo.fn.overlay.show({
									loading: true,
									close: false
							});

							let self = this;
							this._emdmh(row.PartyId, function(d) {
									let json = false;

									try {
											json = JSON.parse(JSON.parse(d).Response);
									} catch (err) {
											return mo.fn.modal.show({
													title: "EMDMH unexpected error",
													content: "An unexpected error was encountered when trying to read EMDMH response",
													ctaLabel: "Ok"
											})
									}

									if (!self._isEMDMHhealthy(row.BRT, json)) {
											return mo.fn.modal.show({
													title: "EMDMH data quality error",
													content: "We encountered an error when trying to match EMDMH response data to action requirements",
													ctaLabel: "Ok"
											})
									}

									row = self._updateRowData(row, json)
									let payload = self._payload(row);

									self._search(payload, function(r) {
											let icm = false;

											try {
													icm = JSON.parse(r);
											} catch (err) {
													return mo.fn.modal.show({
															title: "iCertis unexpected error",
															content: "An unexpected error was encountered when trying to read iCertis response",
															ctaLabel: "Ok"
													})
											}

											if (!self._isICMhealthy(icm)) {
													return mo.fn.modal.show({
															title: "iCertis data quality error",
															content: "We encountered an error when trying to match iCertis response data to action requirements.",
															ctaLabel: "Ok"
													})
											}

											self._updateTableData(row, icm, function(d) {
													if (!self._isRFBhealthy(d)) {
															return mo.fn.modal.show({
																	title: "RFB unexpected error",
																	content: "Fail to update cached data, please try again later.",
																	ctaLabel: "Ok"
															})
													}
													mo.fn.modal.show({
															title: "iCertis cache updated successfully",
															content: "iCertis cached data in RFB has been updated successfully.",
															ctaLabel: "Ok"
													});
													return self._updateGridRow(grid, row, html, d);
											});
									})
							})
					},
					_emdmh: function(pid, cb) {
							var xhr = new XMLHttpRequest();
							xhr.withCredentials = true;
							xhr.addEventListener("readystatechange", function() {
									if (this.readyState === 4) {
											cb(this.responseText);
									}
							});
							xhr.open("POST", "https://hpe-rfb.it.hpe.com/resources/rs/custom/php/dxp/partnerSearch.php");
							xhr.setRequestHeader("Content-Type", "text/plain");
							xhr.send(JSON.stringify({
									"scope": 2,
									"partyId": pid
							}));
					},
					_search: function(payload, callback) {
							// request ICM
							var xhr = new XMLHttpRequest();
							xhr.addEventListener("readystatechange", function() {
									if (this.readyState === 4) {
											callback(this.responseText);
									}
							});
							xhr.open("POST", "https://hpe-rfb.it.hpe.com/resources/rs/custom/php/xaas/search.php");
							xhr.setRequestHeader("Content-Type", "application/json");
							xhr.send(JSON.stringify(payload));
					},
					_payload: function(data) {
							// payload
							let payload = {
									"partyId": data.PartyId,
									"countryEntity": data.CountryEntity,
									"globalEntity": data.GlobalEntity,
									"config": {
											"type": JSON.parse(data.Channel),
											"brt": [data.BRT],
											"status": {
													"draft": false,
													"pending": false,
													"inactive": false,
													"active": true,
													"cancelled": false
											},
											"columns": [
													"ICMParticipatingParties",
													"ICMParticipatingCEs",
													"ICMParticipatingGEs",
													"ICMCountry",
													"ICMPartyID",
													"ICMS4Status",
													"ICMPANumber",
													"ICMBusinessRelationshipCode",
													"ICMBusinessRelationshipDescription",
													"status"
											],
											"coe": false,
											"amendment": false,
											"participating": true
									},
									"debug": true,
									"page": 1,
									"pageSize": 100
							};

							if (data.CountryEntity)
									payload.countryEntity = data.CountryEntity;

							if (data.GlobalEntity)
									payload.globalEntity = data.globalEntity;

							return payload;
					},
					_updateGridRow: function(grid, row, html, data) {
							for (let i = 0; i < Object.keys(data).length; i++)
									row[Object.keys(data)[i]] = data[Object.keys(data)[i]];
							let newRow = grid.rowTemplate(row);
							html.replaceWith(newRow);
					},
					_updateRowData: function(row, emdmh) {
							row.CountryEntity = this._findCountryEntity(emdmh);
							row.GlobalEntity = this._findGlobalEntity(emdmh);
							return row;
					},
					_updateTableData: function(row, icm, cb) {
							crud.update('4688', row.EntryId, {
									CountryEntity: row.CountryEntity,
									GlobalEntity: row.GlobalEntity,
									JSON: JSON.stringify(icm.Response.data)
							}, function(d) {
									cb(d);
							})
					},
					_findCountryEntity: function(emdmh) {
							let arr = emdmh.searchPartnerEmdmh.searchList[0].companyGrouping;
							for (var i = 0; i < arr.length; i++) {
									if (arr[i].countryGroupId) {
											return arr[i].countryGroupId
									}
							}
							return false;
					},
					_findGlobalEntity: function(emdmh) {
							let arr = emdmh.searchPartnerEmdmh.searchList[0].companyGrouping;
							for (var i = 0; i < arr.length; i++) {
									if (arr[i].globalGroupId) {
											return arr[i].globalGroupId
									}
							}
							return false;
					},
					_isBRTavailable: function(code, emdmh) {
							let brtName = this._findBRTname(code);
							let arr = emdmh.searchPartnerEmdmh.searchList[0].businessRelationGroup;
							for (var i = 0; i < arr.length; i++) {
									if (arr[i].busRelTypeName == brtName) {
											return true;
									}
							}
							return false;
					},
					_findBRTname: function(code) {
							let brts = [{
											"code": "RS1",
											"name": "T1 Solution Provider",
											"channel": [
													"ICMChannelT1"
											],
											"pas": [
													"YEZA1",
													"X3ZYB"
											]
									},
									{
											"code": "DT1",
											"name": "Distributor",
											"channel": [
													"ICMChannelT1",
													"ICMChannelDistributor"
											]
									},
									{
											"code": "ODP",
											"name": "OEM Distributor",
											"channel": [
													"ICMOEM"
											]
									},
									{
											"code": "SI1",
											"name": "System Integrator",
											"channel": [
													"ICMChannelGeneral"
											]
									},
									{
											"code": "MAP",
											"name": "Master Area Partner",
											"channel": [
													"ICMChannelT1"
											]
									}
							];
							for (var i = 0; i < brts.length; i++) {
									if (brts[i].code == code) {
											return brts[i].name;
									}
							}
							return false;
					},
					_findGroupIds: function(emdmh) {
							if (!this._findCountryEntity(emdmh) || !this._findGlobalEntity(emdmh)) return false;
							return true;
					},
					_isEMDMHhealthy: function(brt, json) {
							if (!this._isBRTavailable(brt, json)) return false;
							if (!this._findGroupIds(json)) return false;
							return true;
					},
					_isICMhealthy: function(icm) {
							if (!icm.Code || !icm.Code == 'XAAS-00' || !icm.Response || !icm.Response.data) return false;
							return true;
					},
					_isRFBhealthy: function(data) {
							if (data && data.EntryId) return true;
							return false;
					}
			}
	}
</script>
<!-- COMPONENT DEMO ACCOUNTS -->
<script>
	let demoAccounts = {
			ready: false,
			node: document.querySelector("#demo"),
			init: function() {
					this.node.innerHTML = '<div class="grid"></div>';
					this.grid.init(this.node.querySelector(".grid"));
					this.ready = true;
			},
			grid: {
					init: function(selector) {
							mo.fn.overlay.show({
									loading: true,
									close: false
							});

							// start grid
							$(selector).kendoGrid({
									dataSource: this.datasource(),
									toolbar: [{
											name: "create"
									}],
									pageable: {
											pageSize: 4,
											refresh: true
									},
									scrollable: true,
									filterable: true,
									sortable: true,
									columns: this.columns(),
									noRecords: {
											template: "<center style='padding: 20px;font-size: 25px;'>No data available</center>"
									},
									dataBound: function(e) {
											mo.fn.overlay.hide();
									}
							});

							// move toolbar
							$(selector).find(".k-grid-toolbar").insertAfter(selector.querySelector(".k-pager-wrap"));

							// apply grid events
							this.events(selector);
					},
					datasource: function() {
							return new kendo.data.DataSource({
									type: "rfb-v2",
									transport: {
											read: {
													url: "/form/data-set-provider/v2/1585/Reference_DemoAccounts/kendo/data/search",
													type: "post"
											}
									},
									schema: {
											model: {
													id: "EntryId"
											}
									},
									serverPaging: true,
									pageSize: 15,
									serverFiltering: true,
									serverSorting: true
							});
					},
					columns: function() {
							return [{
											field: "Name",
											title: "Name",
											filterable: true,
											width: "150px"
									},
									{
											field: "PartyId",
											title: "PartyId",
											filterable: true,
											width: "120px"
									},
									{
											field: "CountryEntity",
											title: "CountryEntity",
											filterable: true,
											width: "120px"
									},
									{
											field: "GlobalEntity",
											title: "GlobalEntity",
											filterable: true,
											width: "120px"
									},
									{
											field: "BRT",
											title: "BRT",
											filterable: true,
											width: "150px"
									},
									{
											field: "Action",
											title: " ",
											filterable: false,
											width: "40px",
											attributes: {
													"class": "cta"
											},
											template: function(d) {
													return '<a class="icon view"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="view" width="20px" height="20px"><path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path></svg></a>';
											}
									}
							];
					},
					events: function(selector) {
							let self = this;
							selector.querySelector(".k-button.k-grid-add").addEventListener("click", function(e) {
									self.modal(false);
							});

							$(selector).delegate(".icon.view", "click", function(e) {
									mo.fn.overlay.show({
											loading: true,
											close: false
									});

									// grid objects
									var grid = $(selector).data("kendoGrid");
									var html = $(this).closest("tr");
									var row = grid.dataItem(html);

									// fetch data an render modal
									self.fetch(row.EntryId, function(d) {
											self.modal(d);
									});
							});
					},
					fetch: function(entry, callback) {
							crud.read("4713", "eid=" + entry, function(d) {
									if (d && d.Rows && d.Rows.length == 1)
											return callback(d.Rows[0]);
									return callback(false);
							});
					},
					modal: function(dataset) {
							if (!dataset)
									dataset = {};

							let title = "Create new reference demo/test account";
							let cta = "Create";

							if (Object.keys(dataset).length > 0) {
									title = "Edit reference demo/test account #" + dataset.EntryId;
									cta = "Save";
							}

							let nbsfConfig = this.nbsf(dataset);

							mo.fn.modal.show({
									title: title,
									content: '<div id="demo-modal"></div>',
									contentCallback: function() {
											nbsfConfig.dom = document.querySelector("#demo-modal");
											nbsf.init(nbsfConfig, 0);
									},
									ctaLabel: cta,
									ctaCallback: function() {
											nbsfConfig.onSubmit();
									}
							});
							return;
					},
					nbsf: function(dataset) {
							return {
									dataset: dataset,
									pages: [{
											"nav": false,
											"structure": [{
													"group": [
															[{
																	label: "Name",
																	type: "text",
																	data: "Name",
																	required: true,
																	validation: ["minLen|5", "maxLen|255"],
																	typing: "kpDefault"
															}, ],
															[{
																			label: "PartyId",
																			type: "text",
																			data: "PartyId",
																			required: true,
																			validation: ["minLen|10", "maxLen|10", "isInteger"],
																			typing: "isInteger"
																	},
																	{
																			label: "CountryEntity",
																			type: "text",
																			data: "CountryEntity",
																			required: false,
																			validation: ["minLen|9", "maxLen|9", "isInteger"],
																			typing: "isInteger"
																	},
																	{
																			label: "GlobalEntity",
																			type: "text",
																			data: "GlobalEntity",
																			required: false,
																			validation: ["minLen|9", "maxLen|9", "isInteger"],
																			typing: "isInteger"
																	},
															],
															[{
																	label: "BRT",
																	type: "select",
																	required: false,
																	data: "BRT",
																	values: ["Distributor", "T1 Solution Provider", "OEM Distributor", "System Integrator"]
															}]
													]
											}]
									}],
									onSubmit: function() {
											let ds = this.dataset;
											mo.fn.modal.lock();
											// update
											if (ds.EntryId) {
													crud.update("4713", ds.EntryId, ds, function(d) {
															if (d && d.EntryId)
																	mo.fn.modal.msg("Record #" + d.EntryId + " updated successfully", 1);
															else
																	mo.fn.modal.msg("Failed to update record #" + d.EntryId, 3);
															return mo.fn.modal.unlock();
													});
											}
											// create
											else {
													crud.create("4712", ds, function(d) {
															if (d && d.EntryId)
																	mo.fn.modal.msg("Record #" + d.EntryId + " create successfully", 1);
															else
																	mo.fn.modal.msg("Failed to create record", 3);
															return mo.fn.modal.unlock();
													});
											}
									}
							};
					}
			}
	}
</script>
<!-- COMPONENT USERS -->
<script>
	const users = {
			ready: false,
			data: {},
			_init: function() {
					if (!users.ready) {
							mo.fn.overlay.show({
									loading: true,
									close: false
							});
							users._ui();

							function processed(r, d) {
									try {
											var roles = JSON.parse(d.UserRole);
											var arr = [];
											if (roles[r].EMEA) arr.push("EMEA");
											if (roles[r].AMS) arr.push("AMS");
											if (roles[r].APJ) arr.push("APJ");
											if (arr.length == 0) return "N/A";
											else if (arr.length == 3) return "WW";
											else return arr.join(",");
									} catch (err) {
											return "ERR";
									}
							}
							bigd.r.usr.all(function(d) {
									//users.data = d.Data;
									users.data = d.Data.filter(function(item) {
											return item.UserData != 'Inactive';
									});
									users.data.forEach((item) => {
											if (JSON.parse(item.UserRole).ADMIN) item.ADMIN = 'Y';
											else item.ADMIN = 'N';
											if (JSON.parse(item.UserRole).STAT) item.STAT = 'Y';
											else item.STAT = 'N';
											if (JSON.parse(item.UserRole).LANG) item.LANG = 'Y';
											else item.LANG = 'N';
											if (JSON.parse(item.UserRole).USER) item.USER = 'Y';
											else item.USER = 'N';
											item.SRP = processed("SRP", item);
											item.OPS = processed("OPS", item);
									});
									users.grid._load("#users section[tab-id=users] .grid", users.data, users.grid._config());
									users.ready = true;
									mo.fn.overlay.hide();
							});
					}
			},
			_ui: function() {
					// TABS
					if (document.querySelector("#users .tabs") == null)
							document.querySelector("#users").innerHTML += '<section class="tabs"></div>';
					if (document.querySelector("#users .container") == null)
							document.querySelector("#users").innerHTML += '<section class="container"></div>';
					document.querySelector("#users .tabs").innerHTML += '<span tab-id="users" class="active">Users</span>';
					document.querySelector("#users .container").innerHTML += '<section tab-id="users" class="active"><div class="grid"></div><div class="toolbar"><div class="k-header k-grid-toolbar"><a role="button" class="k-button k-button-icontext k-grid-add" href="#">Add user</a></div></div></section>';
					// ADD REFRESH
					document.querySelector("#users").innerHTML += '<span class="refresh"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="refresh" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M20,8 C18.5974037,5.04031171 15.536972,3 12,3 C7.02943725,3 3,7.02943725 3,12 C3,16.9705627 7.02943725,21 12,21 L12,21 C16.9705627,21 21,16.9705627 21,12 M21,3 L21,9 L15,9"></path></svg></span>';
					document.querySelector("#users span.refresh").addEventListener("click", users._refresh);
			},
			_refresh: function() {
					mo.fn.overlay.show({
							loading: true,
							close: false
					});
					document.querySelector("#users .toolbar").innerHTML = "";
					bigd.r.usr.all(function(d) {
							//users.data = d.Data;
							users.data = d.Data.filter(function(item) {
									return item.UserData != 'Inactive';
							});

							function processed(r, d) {
									try {
											var roles = JSON.parse(d.UserRole);
											var arr = [];
											if (roles[r].EMEA) arr.push("EMEA");
											if (roles[r].AMS) arr.push("AMS");
											if (roles[r].APJ) arr.push("APJ");
											if (arr.length == 0) return "N/A";
											else if (arr.length == 3) return "WW";
											else return arr.join(",");
									} catch (err) {
											return "ERR";
									}
							}
							users.data.forEach((item) => {
									if (JSON.parse(item.UserRole).ADMIN) item.ADMIN = 'Y';
									else item.ADMIN = 'N';
									if (JSON.parse(item.UserRole).STAT) item.STAT = 'Y';
									else item.STAT = 'N';
									if (JSON.parse(item.UserRole).LANG) item.LANG = 'Y';
									else item.LANG = 'N';
									if (JSON.parse(item.UserRole).USER) item.USER = 'Y';
									else item.USER = 'N';
									item.SRP = processed("SRP", item);
									item.OPS = processed("OPS", item);
							});
							users.grid._load("#users section[tab-id=users] .grid", users.data, users.grid._config());
							$('section[tab-id="users"] .toolbar div:last-child').remove();
							mo.fn.overlay.hide();
					});
			},
			_refreshNoCloseOverlay: function() {
					document.querySelector("#users .toolbar").innerHTML = "";
					bigd.r.usr.all(function(d) {
							//users.data = d.Data;
							users.data = d.Data.filter(function(item) {
									return item.UserData != 'Inactive';
							});

							function processed(r, d) {
									try {
											var roles = JSON.parse(d.UserRole);
											var arr = [];
											if (roles[r].EMEA) arr.push("EMEA");
											if (roles[r].AMS) arr.push("AMS");
											if (roles[r].APJ) arr.push("APJ");
											if (arr.length == 0) return "N/A";
											else if (arr.length == 3) return "WW";
											else return arr.join(",");
									} catch (err) {
											return "ERR";
									}
							}
							users.data.forEach((item) => {
									if (JSON.parse(item.UserRole).ADMIN) item.ADMIN = 'Y';
									else item.ADMIN = 'N';
									if (JSON.parse(item.UserRole).STAT) item.STAT = 'Y';
									else item.STAT = 'N';
									if (JSON.parse(item.UserRole).LANG) item.LANG = 'Y';
									else item.LANG = 'N';
									if (JSON.parse(item.UserRole).USER) item.USER = 'Y';
									else item.USER = 'N';
									item.SRP = processed("SRP", item);
									item.OPS = processed("OPS", item);
							});
							users.grid._load("#users section[tab-id=users] .grid", users.data, users.grid._config());
					});
			},
			grid: {
					_custom: function() {
							function processed(r, d) {
									try {
											var roles = JSON.parse(d.UserRole);
											var arr = [];
											if (roles[r].EMEA) arr.push("EMEA");
											if (roles[r].AMS) arr.push("AMS");
											if (roles[r].APJ) arr.push("APJ");
											if (arr.length == 0) return "N/A";
											else if (arr.length == 3) return "WW";
											else return arr.join(",");
									} catch (err) {
											return "ERR";
									}
							}

							function basic(r, d) {
									try {
											var roles = JSON.parse(d.UserRole);
											if (roles[r]) return "Y";
											else return "N";
									} catch (err) {
											return "ERR";
									}
							}
							var cusConfig = [{
											field: "Email",
											title: "Email",
											hidden: false,
											filterable: true,
											width: 200
									},
									{
											field: "OPS",
											title: "OPS",
											hidden: false,
											filterable: true,
											template: function(d) {
													return processed("OPS", d);
											},
											headerTemplate: '<span title="Operational role - can review and update cases">OPS</span>'
									},
									{
											field: "SRP",
											title: "SRP",
											hidden: false,
											filterable: true,
											template: function(d) {
													return processed("SRP", d);
											},
											headerTemplate: '<span title="Sales Representative role - can add order requests">SRP</span>'
									},
									{
											field: "USER",
											title: "USER",
											hidden: false,
											filterable: true,
											template: function(d) {
													return basic("USER", d);
											},
											headerTemplate: '<span title="User manager - Can add/update update user access">USER</span>'
									},
									{
											field: "LANG",
											title: "LANG",
											hidden: false,
											filterable: true,
											template: function(d) {
													return basic("LANG", d);
											},
											headerTemplate: '<span title="Localization manager - Can add/update keys used in the application">LANG</span>'
									},
									{
											field: "STAT",
											title: "STAT",
											hidden: false,
											filterable: true,
											template: function(d) {
													return basic("STAT", d);
											},
											headerTemplate: '<span title="Reporting role - can view and extract all records from the database">STAT</span>'
									},
									{
											field: "ADMIN",
											title: "ADMIN",
											hidden: false,
											filterable: true,
											template: function(d) {
													return basic("ADMIN", d);
											},
											headerTemplate: '<span title="Administrator, duh">ADMIN</span>'
									},
									{
											title: "",
											width: "40px",
											attributes: {
													"class": "cta"
											},
											template: function(d) {
													try {
															if ((JSON.parse(d.UserRole).ADMIN && applet.user.UserRole.ADMIN) || !JSON.parse(d.UserRole).ADMIN) {
																	var icons = '<a class="edit" title="Edit user"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="copy"><path fill="none" stroke="#666" stroke-width="2" d="M14,4 L20,10 L14,4 Z M22.2942268,5.29422684 C22.6840146,5.68401459 22.6812861,6.3187139 22.2864907,6.71350932 L9,20 L2,22 L4,15 L17.2864907,1.71350932 C17.680551,1.319449 18.3127724,1.31277239 18.7057732,1.70577316 L22.2942268,5.29422684 Z M3,19 L5,21 M7,17 L15,9"></path>' +
																			'</svg></a>' +
																			'<a class="delete" title="Inactivate user"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="form-trash" width="30px" height="30px"> <path fill="none" stroke="#666" stroke-width="2" d="M7.5,9 L16.5,9 L16.5,19 L7.5,19 L7.5,9 Z M5,9 L19,9 M9.36363636,6 L14.3636364,6 L14.3636364,9 L9.36363636,9 L9.36363636,6 Z M10.5455,11 L10.5455,17 M13.5455,11 L13.5455,17"> </path> </svg></a>';
																	return icons;
															} else return "";
													} catch (err) {
															return "";
													}
											}
									}
							];
							return cusConfig;
					},
					_default: function() {
							var defConfig = [];
							for (i = 0; i < Object.keys(users.data[0]).length; i++) {
									var key = Object.keys(users.data[0])[i];
									var obj = {};
									obj.field = key;
									obj.title = key;
									obj.hidden = true;
									defConfig.push(obj);
							}
							return defConfig;
					},
					_config: function() {
							var cusConfig = users.grid._custom();
							var defConfig = users.grid._default();
							for (j = cusConfig.length - 1; j >= 0; j--) {
									for (i = 0; i < defConfig.length; i++) {
											if (defConfig[i].field == cusConfig[j].field) {
													defConfig.splice(i, 1);
													break;
											}
									}
							}
							for (i = cusConfig.length - 1; i >= 0; i--) {
									defConfig.unshift(cusConfig[i]);
							}
							return defConfig;
					},
					_modal: function(type, row) {
							if (type == "add") {
									var ctalabel = "CREATE";
									var modtitle = "Create user profile";
							} else if (type == "edit") {
									var ctalabel = "SAVE";
									var modtitle = "Edit user profile";
							} else {
									var ctalabel = "YES";
									var modtitle = "Inactivate user";
							}
							mo.fn.modal.show({
									ctaLabel: ctalabel,
									title: modtitle,
									content: '<div class="nbsf" style="overflow:hidden;padding-bottom:10px;max-width:100%"><div class="tabs"></div><div class="container"></div></div>',
									contentCallback: function() {
											var target = document.querySelector(".dxpModalContent .nbsf");
											var tabs = target.querySelector(".tabs");
											var container = target.querySelector(".container");
											// ADD TABS
											tabs.innerHTML = '<span tab-id="personal" class="active">Personal details</span>';
											container.innerHTML = '<div tab-id="personal" class="active"></div>';
											if (applet.user.UserRole.ADMIN || applet.user.UserRole.USER) {
													tabs.innerHTML += '<span tab-id="ops">Standard roles</span>';
													container.innerHTML += '<div tab-id="ops"></div>';
											}
											if (applet.user.UserRole.ADMIN) {
													tabs.innerHTML += '<span tab-id="admin">Administration</span>';
													container.innerHTML += '<div tab-id="admin"></div>';
											}

											// ADD FIELDSETS
											if (type == "add") {
													container.querySelector("div[tab-id=personal]").innerHTML = '<div class="row">' +
															'<fieldset>' +
															'<label class="wrapper text" style="display:block;">' +
															'<span class="name">Email address</span><span class="required">*</span>' +
															'<div class="fmmcosmin">' +
															'<input type="text" value="" placeholder="Internal user email address" data-name="Email">' +
															'</div>' +
															'</label>' +
															'<label class="wrapper text" style="display:block;">' +
															'<span class="name">First name</span>' +
															'<div class="fmmcosmin">' +
															'<input type="text" value="" placeholder="Internal user first name" data-name="FirstName">' +
															'</div>' +
															'</label>' +
															'<label class="wrapper text" style="display:block;">' +
															'<span class="name">Last name</span>' +
															'<div class="fmmcosmin">' +
															'<input type="text" value="" placeholder="Internal user last name" data-name="LastName">' +
															'</div>' +
															'</label>' +
															'</fieldset>' +
															'</div>';
											} else if (type == "edit") {
													container.querySelector("div[tab-id=personal]").innerHTML = '<div class="row">' +
															'<fieldset>' +
															'<label class="wrapper text" style="display:block;">' +
															'<span class="name">Email address</span><span class="required">*</span>' +
															'<div class="fmmcosmin">' +
															'<input type="text" value=' + row.Email + ' disabled>' +
															'</div>' +
															'</label>' +
															'<label class="wrapper text" style="display:block;">' +
															'<span class="name">First name</span><span class="required">*</span>' +
															'<div class="fmmcosmin">' +
															'<input type="text" value=' + row.FirstName + ' disabled>' +
															'</div>' +
															'</label>' +
															'<label class="wrapper text" style="display:block;">' +
															'<span class="name">Last name</span><span class="required">*</span>' +
															'<div class="fmmcosmin">' +
															'<input type="text" value=' + row.LastName + ' disabled>' +
															'</div>' +
															'</label>' +
															'</fieldset>' +
															'</div>';
											}

											if (applet.user.UserRole.ADMIN || applet.user.UserRole.USER) {
													container.querySelector("div[tab-id=ops]").innerHTML += '<div class="row">' +
															'<fieldset>' +
															'<label class="wrapper text" style="display:block;">' +
															'<span class="name">Operations</span>' +
															'<div class="fmmcosmin">' +
															'<select style="height:64px;margin-top:5px;margin-left:2px" multiple="" name="OPS" data-name="OPS" data-type="multiselect">' +
															'<option value="EMEA">EMEA</option>' +
															'<option value="AMS">AMS</option>' +
															'<option value="APJ">APJ</option>' +
															'</select>' +
															'</div>' +
															'</label>' +
															'<label class="wrapper text" style="display:block;">' +
															'<span class="name">Sales Representatives</span>' +
															'<div class="fmmcosmin">' +
															'<select style="height:64px;margin-top:5px;margin-left:2px" multiple="" name="SRP" data-name="SRP" data-type="multiselect">' +
															'<option value="EMEA">EMEA</option>' +
															'<option value="AMS">AMS</option>' +
															'<option value="APJ">APJ</option>' +
															'</select>' +
															'</div>' +
															'</label>' +
															'<label class="wrapper toggle" style="display:block;margin-top:40px">' +
															'<span class="name">User admin</span>' +
															'<div class="fmmcosmin">' +
															'<label for="USER">' +
															'<input name="USER" data-name="USER" type="hidden" value="N">' +
															'<div class="toggle" data-values="N,Y"><span></span></div>' +
															'</label>' +
															'</div>' +
															'</label>' +
															'</fieldset>' +
															'</div>';
											}
											if (applet.user.UserRole.ADMIN) {
													container.querySelector("div[tab-id=admin]").innerHTML += '<div class="row" style="padding-bottom:10px">' +
															'<label class="wrapper toggle" style="display:block;">' +
															'<span class="name">Reporting</span>' +
															'<div class="fmmcosmin">' +
															'<label for="STAT">' +
															'<input name="STAT" data-name="STAT" type="hidden" value="N">' +
															'<div class="toggle" data-values="N,Y"><span></span></div>' +
															'</label>' +
															'</div>' +
															'</label>' +
															'<label class="wrapper toggle" style="display:block;">' +
															'<span class="name">Localization</span>' +
															'<div class="fmmcosmin">' +
															'<label for="LANG">' +
															'<input name="LANG" data-name="LANG" type="hidden" value="N">' +
															'<div class="toggle" data-values="N,Y"><span></span></div>' +
															'</label>' +
															'</div>' +
															'</label>' +
															'<label class="wrapper toggle" style="display:block;">' +
															'<span class="name">Countries</span>' +
															'<div class="fmmcosmin">' +
															'<label for="CNT">' +
															'<input name="CNT" data-name="CNT" type="hidden" value="N">' +
															'<div class="toggle" data-values="N,Y"><span></span></div>' +
															'</label>' +
															'</div>' +
															'</label>' +
															'<label class="wrapper toggle" style="display:block;">' +
															'<span class="name">Tibco Error</span>' +
															'<div class="fmmcosmin">' +
															'<label for="TIBCOERROR">' +
															'<input name="TIBCOERROR" data-name="TIBCOERROR" type="hidden" value="N">' +
															'<div class="toggle" data-values="N,Y"><span></span></div>' +
															'</label>' +
															'</div>' +
															'</label>' +
								'<label class="wrapper toggle" style="display:block;">' +
															'<span class="name">Account View</span>' +
															'<div class="fmmcosmin">' +
															'<label for="ACCOUNTVIEW">' +
															'<input name="ACCOUNTVIEW" data-name="ACCOUNTVIEW" type="hidden" value="N">' +
															'<div class="toggle" data-values="N,Y"><span></span></div>' +
															'</label>' +
															'</div>' +
															'</label>' +
															'<label class="wrapper toggle" style="display:block;">' +
															'<span class="name">Administrator</span>' +
															'<div class="fmmcosmin">' +
															'<label for="ADMIN">' +
															'<input name="ADMIN" data-name="ADMIN" type="hidden" value="N">' +
															'<div class="toggle" data-values="N,Y"><span></span></div>' +
															'</label>' +
															'</div>' +
															'</label>' +
															'</div>';
											}

											// ADD TABS FUNCTIONALITY
											var allt = tabs.querySelectorAll("span");
											var allc = container.querySelectorAll("div[tab-id]");

											function hideAll() {
													for (i = 0; i < allt.length; i++)
															allt[i].setAttribute("class", "");
													for (i = 0; i < allc.length; i++)
															allc[i].setAttribute("class", "");
											}
											for (i = 0; i < allt.length; i++) {
													allt[i].addEventListener("click", function(e) {
															var tabid = e.target.getAttribute("tab-id");
															hideAll();
															e.target.classList.add("active");
															container.querySelector("div[tab-id=" + tabid + "]").classList.add("active");
													});
											}
											// TOGGLES
											var alltog = container.querySelectorAll("div.toggle");
											for (i = 0; i < alltog.length; i++) {
													alltog[i].addEventListener("click", function(e) {
															var el = e.target.closest("label");
															el.classList.toggle("active");
															if (el.getAttribute("class") == "active") el.querySelector("input").value = "Y";
															else el.querySelector("input").value = "N";
													});
											}
											// SET EXISTING VALUES
											if (type == "edit") {
													var roles = JSON.parse(row.UserRole);
													for (i = 0; i < Object.keys(roles).length; i++) {
															var key = Object.keys(roles)[i];
															var input = target.querySelector("*[data-name=" + key + "]");
															if (input != null) {
																	if (input.tagName == "SELECT") {
																			if (roles[key].EMEA) input.querySelector("option[value=EMEA]").selected = true;
																			if (roles[key].APJ) input.querySelector("option[value=APJ]").selected = true;
																			if (roles[key].AMS) input.querySelector("option[value=AMS]").selected = true;
																	} else if (roles[key]) {
																			input.closest("label").setAttribute("class", "active");
																			input.value = "Y";
																	}
															}
													}
											}

											if (type == "delete") {
													document.querySelector(".dxpModalContent").innerHTML = "Are you sure you want to inactivate this user?";
											}
											mo.fn.overlay.show({
													close: false
											})
									},
									ctaCallback: function() {
											// HELPERS
											var sel = document.querySelector(".dxpModalContent");
											var roles = {
													ADMIN: false,
													OPS: {
															EMEA: false,
															AMS: false,
															APJ: false
													},
													SRP: {
															EMEA: false,
															AMS: false,
															APJ: false
													},
													LANG: false,
													STAT: false,
													USER: false,
													CNT: false,
													TIBCOERROR: false,
							ACCOUNTVIEW: false,
											};

											// UPDATE ROLES OBJECT
											/* if (document.querySelector("input[data-name=ADMIN]") != null && document.querySelector("input[data-name=ADMIN]").value == "Y")
													 roles = {
															 ADMIN: true,
															 OPS: {
																	 EMEA: true,
																	 AMS: true,
																	 APJ: true
															 },
															 SRP: {
																	 EMEA: true,
																	 AMS: true,
																	 APJ: true
															 },
															 LANG: true,
															 STAT: true,
															 USER: true,
															 CNT: true
													 };
											 else*/
											for (i = 0; i < Object.keys(roles).length; i++) {
													var key = Object.keys(roles)[i];
													console.log('key', key);
													var input = sel.querySelector("*[data-name=" + key + "]");
													if (input != null && input.tagName == "SELECT") {
															var opt = input.querySelectorAll("option:checked");
															var arr = [];
															for (k = 0; k < opt.length; k++) arr.push(opt[k].value);
															for (k = 0; k < Object.keys(roles[key]).length; k++) {
																	if (arr.indexOf(Object.keys(roles[key])[k]) > -1) roles[key][Object.keys(roles[key])[k]] = true;
																	else roles[key][Object.keys(roles[key])[k]] = false;
															}
													} else if (input != null && input.tagName == "INPUT") {
															if (input.value == "Y") roles[key] = true;
															else roles[key] = false;
													}
											}

											// UPDATE DATABASE
											mo.fn.modal.lock();
											if (type == "add") {
													var email = sel.querySelector("input[data-name=Email]");
													if (email.value.length < 9 || email.value.indexOf("@hpe.com") == -1) {
															mo.fn.modal.msg("Please provide a valid employee email address", 3);
															mo.fn.modal.unlock();
													} else {
															crud.read("2493", "Email=" + email.value + "&Source=NOR", function(d) {
																	try {
																			if (d.Rows.length > 0) {
																					mo.fn.modal.msg("A user already exists with this email address", 3);
																					mo.fn.modal.unlock();
																			} else {
																					crud.create("2495", {
																							Email: email.value,
																							FirstName: sel.querySelector("input[data-name=FirstName]").value,
																							LastName: sel.querySelector("input[data-name=LastName]").value,
																							Source: "NOR",
																							UserRole: JSON.stringify(roles)
																					}, function(d) {
																							try {
																									mo.fn.modal.msg("User successfully created (" + d.EntryId + ")", 1);
																									sel.querySelector("input[data-name=FirstName]").value = "";
																									mo.fn.modal.unlock();
																							} catch (err) {
																									mo.fn.modal.msg("An error occurred writing to the database. Please try again later.", 3);
																									mo.fn.modal.unlock();
																							}
																					});
																			}
																	} catch (err) {
																			console.error(err);
																			mo.fn.modal.msg("An error occurred when accessing the user database. Please try again later.", 3);
																			mo.fn.modal.unlock();
																	}
															});
													}
											} else if (type == "edit") {
													var eid = row.EntryId;
													crud.update("3255", eid, {
															UserRole: JSON.stringify(roles)
													}, function(d) {
															if (typeof(d.EntryId) !== "undefined") {
																	mo.fn.modal.msg("User profile was saved successfully.", 1);
																	mo.fn.modal.unlock();
															} else {
																	mo.fn.modal.msg("An error occured when writing to the database. Please try again later.", 3);
																	mo.fn.modal.unlock();
															}
													});
											} else {
													var eid = row.EntryId;
													crud.update("3255", eid, {
															UserData: "Inactive"
													}, function(d) {
															if (typeof(d.EntryId) !== "undefined") {
																	mo.fn.modal.msg("User profile was inactivated successfully.", 1);
																	mo.fn.modal.unlock();
															} else {
																	mo.fn.modal.msg("An error occured when writing to the database. Please try again later.", 3);
																	mo.fn.modal.unlock();
															}
															users._refreshNoCloseOverlay();
													});
											}
											//console.log(roles);
									}
							});
					},
					_load: function(selector, datasource, config) {
							$(selector).kendoGrid({
									toolbar: ["excel"],
									excel: {
											fileName: "NORUsersExport.xlsx",
											allPages: true
									},
									dataSource: {
											data: datasource,
											sort: {
													field: "EntryId",
													dir: "asc"
											}
									},
									columns: config,
									dataBound: function(e) {},
									pageable: {
											buttonCount: 4,
											pageSize: 10,
											pageSizes: [10, 25, 50, 100],
											messages: {
													itemsPerPage: ""
											}
									},
									scrollable: false,
									sortable: true,
									filterable: true
							});
							$(selector).delegate(".edit", "click", function(e) {
									var grid = $(selector).data("kendoGrid");
									var row = grid.dataItem($(this).closest("tr"));
									users.grid._modal("edit", row);
							});
							$(selector).delegate(".delete", "click", function(e) {
									var grid = $(selector).data("kendoGrid");
									var row = grid.dataItem($(this).closest("tr"));
									users.grid._modal("delete", row);
							});
							$(selector + ' .k-grid-toolbar').appendTo('#users section[tab-id=users] .toolbar');
							document.querySelector("#users .toolbar .k-grid-add").addEventListener("click", function(e) {
									users.grid._modal("add");
							});
					}
			}
	}
</script>
<!-- COMPONENT TIBCO ERROR -->
<script>
	const tibcoErrors = {
			ready: false,
			data: {},
			node: document.querySelector("#tibcoErrors"),
			_auth: function() {
					var arr = ["ADMIN", "TIBCOERROR"];
					for (i = 0; i < arr.length; i++) {
							if (applet._getAuth(arr[i])) {
									return true;
									break;
							} else if (i == arr.length - 1) return false;
					}
			},
			init: function() {
					// if (!this.ready) {
					this.node.innerHTML = '';
					if (tibcoErrors._auth()) {
							mo.fn.overlay.show({
									loading: true,
									close: false
							});
							this.ui(function() {
									tibcoErrors.grid.load(tibcoErrors.node.querySelector("[tab-id=tibcoErrors] .grid"));
									tibcoErrors.ready = true;
									//	  mo.fn.overlay.hide();
							});
					} else {
							//	ui.message.open("You do not have permission to access this section. Please request additional access if required or reach out to someone that has access to this functionality.", 3, 1000);

							mo.fn.modal.show({
									ctaLabel: 'Close',
									close: false,
									title: 'Access Error',
									content: 'You do not have permission to access this section. Please request additional access if required or reach out to someone that has access to this functionality.',
									ctaCallback: function() {
											ui._dashboard();
											mo.fn.events.closeAll();
									}
							});
					}
					// }
			},
			ui: function(cb) {
					hpe.ui.tabs({
							dom: this.node,
							tabs: [{
									id: "tibcoErrors",
									label: "TIBCO Errors",
									html: '<div class="grid"></div><div class="toolbar"></div>',
									active: true
							}, ]
					}, function() {
							cb();
					});
			},
			modal: function(data) {
					mo.fn.overlay.show({
							loading: true,
							close: false
					});

					var ctalabel = "OK";
					var modtitle = "Viewing Onboarding request #" + data.EntryId;
					mo.fn.modal.show({
							ctaLabel: ctalabel,
							title: modtitle,
							content: '<div class="nbsf" style="overflow:hidden;padding-bottom:10px;max-width:100%"><div class="tabs"></div><div class="container"></div></div>',
							contentCallback: function() {
									var target = document.querySelector(".dxpModalContent .nbsf");
									var tabs = target.querySelector(".tabs");
									var container = target.querySelector(".container");
									container.innerHTML += '<iframe></iframe>';
									container.innerHTML += '<style>html .dxpModal {height: 100vh;box-sizing: border-box;width: 1200px!important;max-width: none!important;}.dxpModal .dxpModalFooter {display:none!important;}.dxpModal iframe {width:100%;height:100%;border:0;}html .dxpModal .dxpModalContainer,html .dxpModal .dxpModalContainer .dxpModalContent, html .dxpModal .dxpModalContainer .dxpModalContent .nbsf {height:100%;margin-bottom:0;padding-bottom:0;}</style>';
									container.querySelector("iframe").setAttribute("src", "https://hpe-rfb.it.hpe.com/form/681/072267d4-1434-420c-b241-1f366816ddcf?EntryId=" + data.EntryId);

									//// FUNCTIONALITY
									// TABS
									var allt = tabs.querySelectorAll("span");
									var allc = container.querySelectorAll("div[tab-id]");

									function hideAll() {
											for (i = 0; i < allt.length; i++)
													allt[i].setAttribute("class", "");
											for (i = 0; i < allc.length; i++)
													allc[i].setAttribute("class", "");
									}
									for (i = 0; i < allt.length; i++) {
											allt[i].addEventListener("click", function(e) {
													var tabid = e.target.getAttribute("tab-id");
													hideAll();
													e.target.classList.add("active");
													container.querySelector("div[tab-id=" + tabid + "]").classList.add("active");
											});
									}
									// TOGGLES
									var alltog = container.querySelectorAll("div.toggle");
									for (i = 0; i < alltog.length; i++) {
											alltog[i].addEventListener("click", function(e) {
													var el = e.target.closest("label");
													el.classList.toggle("active");
													if (el.getAttribute("class") == "active") el.querySelector("input").value = "Y";
													else el.querySelector("input").value = "N";
											});
									}

									//// CLOSE MODAL
									mo.fn.overlay.show({
											close: false
									})
							},
							ctaCallback: function() {
									// HELPERS
									var sel = document.querySelector(".dxpModalContent");
							}
					});
			},
			download: {
					init: function(selector) {
							$(selector).find('.k-grid-toolbar').appendTo($(selector).parent().find('.toolbar'));
					},
			},
			retrigger: {
					init: function(selector) {
							const btn = document.createElement('a');
							btn.setAttribute('id', 'retrigger-cases');
							btn.className = 'k-button k-button-icontext';
							btn.innerHTML = 'Retrigger SFDC cases';
							btn.addEventListener('click', function(event) {
									event.preventDefault();

									const grid = $(selector).data("kendoGrid");
									const view = grid.dataSource.view();
									const number = view.length;

									// message to confirm the retrigger
									mo.fn.modal.show({
											ctaLabel: 'Yes',
											close: true,
											title: 'Batch SFDC',
											content: `You are going to re-trigger ${number} cases and send ${number} SFDC requests. Continue?`,
											ctaCallback: function() {
													mo.fn.events.closeAll();

													mo.fn.overlay.show({
															loading: true,
															close: false
													});

													const retriggerCase = function(eid, cb) {
															/*  setTimeout(() => {
																console.log('eid', eid);
																cb();
																}, 2000);*/

															crud.update('3158', eid, {
																	Workflow: "1"
															}, function(d) {
																	cb();
															});
													};

													let requests = view.map((item) => {
															const eid = item.EntryId;
															return new Promise((resolve) => {
																	retriggerCase(eid, resolve);
															});
													})

													Promise.all(requests).then(() => {
															console.log('retrigger done');
															mo.fn.overlay.hide();
															mo.fn.modal.show({
																	ctaLabel: 'Close',
																	close: true,
																	title: 'Success',
																	content: `You successfully re-triggered ${number} cases. You can check their status by clicking on the ticket icon in the case row or refresh the table.`,
															});
													});
											}
									});

							});

							selector.parentNode.querySelector('.k-grid-toolbar').append(btn);
					},
			},
			grid: {
					load: function(selector) {
							mo.fn.overlay.show({
									loading: true,
									close: false
							});

							// load grid
							$(selector).kendoGrid({
									toolbar: [{
											name: "excel",
											text: "Download"
									}],
									excel: {
											fileName: "Onboarding_TIBCO_Errors_" + new Date().getTime() + ".xlsx",
											filterable: true,
											allPages: true
									},
									dataSource: this.datasource(),
									pageable: {
											pageSize: 4,
											refresh: true
									},
									scrollable: true,
									filterable: true,
									sortable: true,
									resizable: true,
									columns: this.columns(),
									noRecords: {
											template: "<center style='padding: 20px;font-size: 25px;'>No data available</center>"
									},
									dataBound: function(e) {
											mo.fn.overlay.hide();
									}
							});

							this.events(selector);
							tibcoErrors.download.init(selector);
							tibcoErrors.retrigger.init(selector);
					},
					columns: function() {
							return [{
											field: "EntryId",
											title: "ID",
											filterable: true,
											width: 85,
											locked: true,
									},
									{
											field: "PO_BackgroundGroup",
											title: "BG",
											filterable: true,
											width: 90,
									},
									{
											field: "Region",
											title: "Region",
											filterable: true,
											width: 115,
									},
									{
											field: "Geo",
											title: "Geo",
											filterable: true,
											width: 115,
									},
									{
											field: "SoldTo_Address_Country",
											title: "Country",
											filterable: true,
											width: 130,
									},
									{
											field: "SoldTo_CompanyName",
											title: "SoldTo CompanyName",
											filterable: true,
											width: 215,
									},
									{
											field: "PartyId",
											title: "PartyId",
											filterable: true,
											width: 130,
									},
									{
											field: "PO_Number",
											title: "PO",
											filterable: true,
											width: 130,
									},
									{
											field: "SubmittedTimestamp",
											title: "Date",
											filterable: false,
											width: 100,
											template: function(d) {
													try {
															return d.SubmittedTimestamp.split("T")[0];
													} catch (err) {
															return d.SubmittedTimestamp;
													}
											}
									},
									{
											field: "SFDC_Status",
											title: "Tibco Status",
											filterable: false,
											width: 140,
									},
									{
											field: "SendingAttempts",
											title: "Attempts",
											filterable: true,
											width: 130,
									},
									{
											field: "SFDC_CreatedAt",
											title: "Created Time",
											filterable: true,
											width: 160,
											template: function(d) {
													const date = d.SFDC_CreatedAt;
													if (date) {
															let formatedDate = date.getFullYear() + '-' + ("00" + (date.getMonth() + 1)).slice(-2) + '-' + ("00" + date.getDate()).slice(-2);
															let h = ("00" + date.getHours()).slice(-2);
															let m = ("00" + date.getMinutes()).slice(-2);
															let timeOfDay = [h, m].join(':');

															return `${formatedDate} ${timeOfDay}`;
													}
													return '';
											},
									},
									{
											field: "SFDC_CompletedAt",
											title: "Completed Time",
											filterable: true,
											width: 170,
											template: function(d) {
													const date = d.SFDC_CompletedAt;
													if (date) {
															let formatedDate = date.getFullYear() + '-' + ("00" + (date.getMonth() + 1)).slice(-2) + '-' + ("00" + date.getDate()).slice(-2);
															let h = ("00" + date.getHours()).slice(-2);
															let m = ("00" + date.getMinutes()).slice(-2);
															let timeOfDay = [h, m].join(':');

															return `${formatedDate} ${timeOfDay}`;
													}
													return '';
											},
									},
									{
											field: "Response",
											title: "Response",
											filterable: true,
											width: 350,
									},
									{
											field: "SFDC_CaseNumber",
											title: "Case Number",
											filterable: true,
											width: 155,
									},
									{
											title: "",
											width: "80px",
											locked: true,
											attributes: {
													"class": "cta"
											},
											template: function(d) {
													var icons = `<a class="sfdc">
							<svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="ticket" width="24px" height="24px">
								<path fill="none" stroke="#666" stroke-width="2" d="M7,16 L17,16 L17,8 L7,8 L7,16 Z M20,12 C20,14 21,15 23,15 L23,20 L1,20 L1,15 C3,15 4,14 4,12 C4,10 3,9 1,9 L1,4 L23,4 L23,9 C21,9 20,10 20,12 Z">
								</path>
							</svg>
						</a>
						<a class="view"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path></a>`;
													return icons;
											}
									}
							];
					},
					datasource: function() {
							return new kendo.data.DataSource({
									type: "rfb-v2",
									transport: {
											read: {
													url: "/form/data-set-provider/v2/989/NOR_Data_List/kendo/data",
											}
									},
									schema: {
											model: {
													id: "EntryId",
													fields: {
															SFDC_CreatedAt: {
																	type: "date"
															},
															SFDC_CompletedAt: {
																	type: "date"
															},
													}
											}
									},
									filter: {
											logic: "and",
											filters: [{
															field: "Submitted",
															operator: "eq",
															value: "Y"
													},
													{
															field: "SFDC_Status",
															operator: "eq",
															value: "ERROR"
													},
													{
															logic: "or",
															filters: [{
																			field: "Status",
																			operator: "eq",
																			value: "1"
																	},
																	{
																			field: "Status",
																			operator: "eq",
																			value: "2"
																	},
																	{
																			field: "Status",
																			operator: "eq",
																			value: "4"
																	}
															]
													}
											]
									},
									serverPaging: true,
									pageSize: 10,
									serverFiltering: true,
									serverSorting: true,
							});
					},
					events: function(selector) {
							$(selector).delegate(".view", "click", function(e) {
									var grid = $(selector).data("kendoGrid");
									var row = grid.dataItem($(this).closest("tr"));
									review._init(row.EntryId);
							});
							$(selector).delegate(".sfdc", "click", function(e) {
									var grid = $(selector).data("kendoGrid");
									var row = grid.dataItem($(this).closest("tr"));
									sfdc.init(row.EntryId, 'tibcoErrors');
							});
					},
			}
	}
</script>
<!-- COMPONENT ADMIN -->
<script>
	const admin = {
			_init: function() {
					document.querySelector("#profile .action").classList.add("dual");
					document.querySelector("#profile .admin").addEventListener("click", function(e) {
							ui.nav.reset();
							ui._component("admin");
					});
					//TODO Add function to enable Admin functionality on Admin CTA
					//console.log("admin");
			}
	}
</script>
<!-- COMPONENT DRAFTS -->
<script>
const drafts = {
	ready: false,
	data: {},
	_auth: function() {
			const operationsRole = '{"EMEA":true,"AMS":true,"APJ":true}';
			return (operationsRole === JSON.stringify(applet?.user?.UserRole?.OPS));
	},
	_init: function() {
			if(drafts._auth()) {
					if (!drafts.ready) {
							mo.fn.overlay.show({
									loading: true,
									close: false
							});
							let self = this
							crud.read("3180", "eid=5415", function(d) {
									self.sample = d.Rows[0];
									drafts.ui();
									drafts._loadGrids();
									drafts.ready = true;
									mo.fn.overlay.hide();
							});
	
					}
			} else {
					mo.fn.modal.show({
							ctaLabel: 'Close',
							close: false,
							title: 'Access Error',
							content: 'You do not have permission to access this section. Please request additional access if required or reach out to someone that has access to this functionality.',
							ctaCallback: function() {
									ui._dashboard();
									mo.fn.events.closeAll();
							}
					});
			}        
	},
	ui: function(cb) {
			if (document.querySelector("#drafts .tabs") == null)
					document.querySelector("#drafts").innerHTML += '<section class="tabs"></div>';
			if (document.querySelector("#drafts .container") == null)
					document.querySelector("#drafts").innerHTML += '<section class="container"></div>';

			document.querySelector("#drafts .tabs").innerHTML += '<span tab-id="ops">Drafts (<em>0</em>)</span>';
			document.querySelector("#drafts .container").innerHTML += '<section tab-id="ops"><div class="grid"></div><div class="toolbar"></div></section>';
			// ADD REFRESH
			document.querySelector("#drafts").innerHTML += '<span class="refresh"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="refresh" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M20,8 C18.5974037,5.04031171 15.536972,3 12,3 C7.02943725,3 3,7.02943725 3,12 C3,16.9705627 7.02943725,21 12,21 L12,21 C16.9705627,21 21,16.9705627 21,12 M21,3 L21,9 L15,9"></path></svg></span>';
			// ADD TAB ON CLICK
			var tabs = document.querySelectorAll("#drafts .tabs span");
			var sections = document.querySelectorAll("#drafts .container section");
			for (i = 0; i < tabs.length; i++) {
					tabs[i].addEventListener("click", function(e) {
							// RESET ALL TABS
							for (i = 0; i < tabs.length; i++)
									tabs[i].setAttribute("class", "");
							// RESET ALL SECTIONS
							for (i = 0; i < sections.length; i++)
									sections[i].setAttribute("class", "");
							// ENABLE REQUESTED SECTION
							var cid = e.target.getAttribute("tab-id") || e.target.closest("span").getAttribute("tab-id");
							document.querySelector("#drafts span[tab-id=" + cid + "]").classList.add("active");
							document.querySelector("#drafts section[tab-id=" + cid + "]").classList.add("active");
							var activeSection = document.querySelector("#drafts section[tab-id=" + cid + "]");
							var kendoGrids = activeSection.querySelectorAll(".k-grid");

							kendoGrids.forEach(function(gridElement) {
									var kendoGridInstance = $(gridElement).data("kendoGrid");

									if (kendoGridInstance) {
											kendoGridInstance.resize();
									}
							});

					});
			}
			// DEFAULT TO FIRST TAB
			document.querySelector("#drafts .tabs span").click();
			// ADD REFRESH EVENT
			document.querySelector("#drafts span.refresh").addEventListener("click", drafts._refresh);
			// CALLBACK
			if (typeof(cb) === "function") return cb();
			else return true;
	},
	_getCount: function() {
			var pend = drafts.grid._datasource({
					logic: "and",
					filters: [{
									field: "Submitted",
									operator: "neq",
									value: "Y"
							}
					]
			});
			pend.fetch(function() {
					document.querySelector("#drafts .tabs span[tab-id=ops] em").innerText = pend.total();
			});
	},
	_refresh: function() {
			mo.fn.overlay.show({
					loading: true,
					close: false
			});
			var grids = document.querySelectorAll("#drafts .grid , #drafts .toolbar");
			for (i = 0; i < grids.length; i++)
					grids[i].innerHTML = "";
			let self = this
			crud.read("3180", "eid=5415", function(d) {
					self.sample = d.Rows[0];
					drafts._loadGrids();
					drafts.ready = true;
					mo.fn.overlay.hide();
			});
	},
	_loadGrids: function() {
			// KENDO GRID HAS SOME ITERATION IN IT AND IT CONFLICTS WITH I,J,K AS INDEX VARIABLE; USE INDEX AS VARIABLE
			drafts.grid._load("#drafts section[tab-id=ops] .grid", drafts.grid._datasource({
					logic: "and",
					filters: [{
									field: "Submitted",
									operator: "neq",
									value: "Y"
							},
					]
			}));
	},
	_modal: function(data) {
			mo.fn.overlay.show({
					loading: true,
					close: false
			});

			var ctalabel = "OK";
			var modtitle = "Viewing Onboarding request #" + data.EntryId;
			mo.fn.modal.show({
					ctaLabel: ctalabel,
					title: modtitle,
					content: '<div class="nbsf" style="overflow:hidden;padding-bottom:10px;max-width:100%"><div class="tabs"></div><div class="container"></div></div>',
					contentCallback: function() {
							var target = document.querySelector(".dxpModalContent .nbsf");
							var tabs = target.querySelector(".tabs");
							var container = target.querySelector(".container");
							container.innerHTML += '<iframe></iframe>';
							container.innerHTML += '<style>html .dxpModal {height: 100vh;box-sizing: border-box;width: 1200px!important;max-width: none!important;}.dxpModal .dxpModalFooter {display:none!important;}.dxpModal iframe {width:100%;height:100%;border:0;}html .dxpModal .dxpModalContainer,html .dxpModal .dxpModalContainer .dxpModalContent, html .dxpModal .dxpModalContainer .dxpModalContent .nbsf {height:100%;margin-bottom:0;padding-bottom:0;}</style>';
							container.querySelector("iframe").setAttribute("src", "https://hpe-rfb.it.hpe.com/form/681/072267d4-1434-420c-b241-1f366816ddcf?EntryId=" + data.EntryId);

							//// FUNCTIONALITY
							// TABS
							var allt = tabs.querySelectorAll("span");
							var allc = container.querySelectorAll("div[tab-id]");

							function hideAll() {
									for (i = 0; i < allt.length; i++)
											allt[i].setAttribute("class", "");
									for (i = 0; i < allc.length; i++)
											allc[i].setAttribute("class", "");
							}
							for (i = 0; i < allt.length; i++) {
									allt[i].addEventListener("click", function(e) {
											var tabid = e.target.getAttribute("tab-id");
											hideAll();
											e.target.classList.add("active");
											container.querySelector("div[tab-id=" + tabid + "]").classList.add("active");
									});
							}
							// TOGGLES
							var alltog = container.querySelectorAll("div.toggle");
							for (i = 0; i < alltog.length; i++) {
									alltog[i].addEventListener("click", function(e) {
											var el = e.target.closest("label");
											el.classList.toggle("active");
											if (el.getAttribute("class") == "active") el.querySelector("input").value = "Y";
											else el.querySelector("input").value = "N";
									});
							}

							//// CLOSE MODAL
							mo.fn.overlay.show({
									close: false
							})
					},
					ctaCallback: function() {
							// HELPERS
							var sel = document.querySelector(".dxpModalContent");
					}
			});
	},
	grid: {
			_custom: function() {
					var cusConfig = [{
									field: "EntryId",
									title: "ID",
									filterable: true,
									width: "85px",
									locked: true
							},
							{
									field: "PO_BackgroundGroup",
									title: "BG",
									filterable: true,
									width: 90,
									locked: false
							},
							{
									field: "Region",
									title: "Region",
									filterable: true,
									width: 115,
									locked: false
							},
							{
									field: "Geo",
									title: "Geo",
									filterable: true,
									width: 115,
							},
							{
									field: "SoldTo_Address_Country",
									title: "Country",
									filterable: true,
									width: 125,
							},
							{
									field: "SoldTo_CompanyName",
									title: "SoldTo CompanyName",
									filterable: true,
									width: 215,
							},
							{
									field: "PartyId",
									title: "PartyId",
									filterable: true,
									width: 115,


							},
							{
									field: "PO_Number",
									title: "PO",
									filterable: true,
									width: 115,
							},
							// {
							//     field: "SubmittedTimestamp",
							//     title: "Date",
							//     filterable: false,
							//     width: 100,
							//     template: function(d) {
							//         try {
							//             return d.SubmittedTimestamp.split("T")[0];
							//         } catch (err) {
							//             return d.SubmittedTimestamp;
							//         }
							//     }
							// },
							{
									field: "SubmitterEmail",
									title: "Submitter",
									filterable: true,
									width: 255
							},
							// {
							//     field: "CaseNumber",
							//     title: "Case Number",
							//     filterable: true,
							//     width: 155,
							// },
					];
					return cusConfig;
			},
			_default: function() {
					var defConfig = [];
					if (drafts.data.length > 0)
							for (i = 0; i < Object.keys(drafts.data[0]).length; i++) {
									var key = Object.keys(drafts.data[0])[i];
									var obj = {};
									obj.field = key;
									obj.title = key;
									obj.hidden = true;
									defConfig.push(obj);
							}
					return defConfig;
			},
			_config: function() {
					var cusConfig = drafts.grid._custom();
					var defConfig = drafts.grid._default();
					for (j = cusConfig.length - 1; j >= 0; j--) {
							for (i = 0; i < defConfig.length; i++) {
									if (defConfig[i].field == cusConfig[j].field) {
											defConfig.splice(i, 1);
											break;
									}
							}
					}
					for (i = cusConfig.length - 1; i >= 0; i--) {
							defConfig.unshift(cusConfig[i]);
					}
					return defConfig;
			},
			_load: function(selector, datasource) {
					var parent = document.querySelector(selector.split(" .grid")[0]);
					let config = this._config();
					$(selector).kendoGrid({
							toolbar: [{
									name: "excel",
									text: "Download"
							}],
							excel: {
									fileName: "Onboarding_Drafts_" + parent.getAttribute("tab-id") + "_" + new Date().getTime() + ".xlsx",
									filterable: true,
									allPages: true
							},
							dataSource: datasource,
							columns: config,
							dataBound: function(e) {
									document.querySelector("#drafts .tabs span[tab-id=" + parent.getAttribute("tab-id") + "] em").innerText = this.dataSource.total();
							},
							pageable: {
									buttonCount: 4,
									pageSize: 10,
									pageSizes: [10, 25, 50, 100],
									messages: {
											itemsPerPage: ""
									}
							},
							scrollable: true,
							sortable: true,
							filterable: true
					});
					$(selector + ' .k-grid-toolbar').appendTo(selector.split(" .grid")[0] + ' .toolbar');
					var exportFlag = false;
					$(selector).data("kendoGrid").bind("excelExport", function(e) {
							if (!exportFlag) {
									e.preventDefault();
									exportFlag = true;
									mo.fn.overlay.show({
											loading: true,
											close: false
									});
									setTimeout(function() {
											e.sender.saveAsExcel();
									}, 1500);
							} else {
									exportFlag = false;
									setTimeout(function() {
											mo.fn.overlay.hide();
									}, 500);
							}
					});
			},
			_datasource: function(filter) {
					return new kendo.data.DataSource({
							type: "rfb-v2",
							transport: {
									read: {
											url: "/form/data-set-provider/v2/989/NOR_Data_List/kendo/data"
									}
							},
							schema: {
									model: {
											id: "EntryId",
									}
							},
							filter: filter,
							serverPaging: true,
							pageSize: 10,
							serverFiltering: true,
							serverSorting: true,
					});
			}
	}
}
</script>

<script>
function getStatus(statusCode) {
	const statusMap = {
			'0': 'Draft',
			'1': 'Sent',
			'2': 'In progress',
			'3': 'Completed',
			'4': 'Fallout',
			'5': 'Cancelled',
			'6': 'Closed',
	};

	return statusMap[statusCode] ? statusMap[statusCode] : '';
}
</script>

<!-- COMPONENT ACCOUNT VIEW-->
<script>

</script>

<!-- COMPONENT IN PROGRESS -->
<script>
const inProgress = {
	ready: false,
	data: {},
	_init: function() {
			if (!inProgress.ready) {
					mo.fn.overlay.show({
							loading: true,
							close: false
					});
					let self = this
					crud.read("3180", "eid=5415", function(d) {
							self.sample = d.Rows[0];
							inProgress.ui();
							inProgress._loadGrids();
							inProgress.ready = true;
							mo.fn.overlay.hide();
					});

			}
	},
	ui: function(cb) {
			if (document.querySelector("#inProgress .tabs") == null)
					document.querySelector("#inProgress").innerHTML += '<section class="tabs"></div>';
			if (document.querySelector("#inProgress .container") == null)
					document.querySelector("#inProgress").innerHTML += '<section class="container"></div>';

			document.querySelector("#inProgress .tabs").innerHTML += '<span tab-id="ops">In progress (<em>0</em>)</span>';
			document.querySelector("#inProgress .container").innerHTML += '<section tab-id="ops"><div class="grid"></div><div class="toolbar"></div></section>';
			// ADD REFRESH
			document.querySelector("#inProgress").innerHTML += '<span class="refresh"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="refresh" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M20,8 C18.5974037,5.04031171 15.536972,3 12,3 C7.02943725,3 3,7.02943725 3,12 C3,16.9705627 7.02943725,21 12,21 L12,21 C16.9705627,21 21,16.9705627 21,12 M21,3 L21,9 L15,9"></path></svg></span>';
			// ADD TAB ON CLICK
			var tabs = document.querySelectorAll("#inProgress .tabs span");
			var sections = document.querySelectorAll("#inProgress .container section");
			for (i = 0; i < tabs.length; i++) {
					tabs[i].addEventListener("click", function(e) {
							// RESET ALL TABS
							for (i = 0; i < tabs.length; i++)
									tabs[i].setAttribute("class", "");
							// RESET ALL SECTIONS
							for (i = 0; i < sections.length; i++)
									sections[i].setAttribute("class", "");
							// ENABLE REQUESTED SECTION
							var cid = e.target.getAttribute("tab-id") || e.target.closest("span").getAttribute("tab-id");
							document.querySelector("#inProgress span[tab-id=" + cid + "]").classList.add("active");
							document.querySelector("#inProgress section[tab-id=" + cid + "]").classList.add("active");
							var activeSection = document.querySelector("#inProgress section[tab-id=" + cid + "]");
							var kendoGrids = activeSection.querySelectorAll(".k-grid");

							kendoGrids.forEach(function(gridElement) {
									var kendoGridInstance = $(gridElement).data("kendoGrid");

									if (kendoGridInstance) {
											kendoGridInstance.resize();
									}
							});

					});
			}
			// DEFAULT TO FIRST TAB
			document.querySelector("#inProgress .tabs span").click();
			// ADD REFRESH EVENT
			document.querySelector("#inProgress span.refresh").addEventListener("click", inProgress._refresh);
			// CALLBACK
			if (typeof(cb) === "function") return cb();
			else return true;
	},
	_getCount: function() {
			var pend = inProgress.grid._datasource({
					logic: "and",
					filters: [{
									field: "Submitted",
									operator: "eq",
									value: "Y"
							},
							{
									logic: "or",
									filters: [{
													field: "SFDC_Status",
													operator: "neq",
													value: "ERROR"
											},
											{
													field: "SFDC_Status",
													operator: "isempty",
													value: ""
											}
									]
							},
							{
									logic: "or",
									filters: [{
													field: "Status",
													operator: "eq",
													value: "1"
											},
											{
													field: "Status",
													operator: "eq",
													value: "2"
											}
									]
							}
					]
			});
			pend.fetch(function() {
					document.querySelector("#inProgress .tabs span[tab-id=ops] em").innerText = pend.total();
			});
	},
	_refresh: function() {
			mo.fn.overlay.show({
					loading: true,
					close: false
			});
			var grids = document.querySelectorAll("#inProgress .grid , #inProgress .toolbar");
			for (i = 0; i < grids.length; i++)
					grids[i].innerHTML = "";
			let self = this
			crud.read("3180", "eid=5415", function(d) {
					self.sample = d.Rows[0];
					inProgress._loadGrids();
					inProgress.ready = true;
					mo.fn.overlay.hide();
			});
	},
	_loadGrids: function() {
			// KENDO GRID HAS SOME ITERATION IN IT AND IT CONFLICTS WITH I,J,K AS INDEX VARIABLE; USE INDEX AS VARIABLE
			inProgress.grid._load("#inProgress section[tab-id=ops] .grid", inProgress.grid._datasource({
					logic: "and",
					filters: [{
									field: "Submitted",
									operator: "eq",
									value: "Y"
							},
							{
									logic: "or",
									filters: [{
													field: "SFDC_Status",
													operator: "neq",
													value: "ERROR"
											},
											{
													field: "SFDC_Status",
													operator: "isempty",
													value: ""
											}
									]
							},
							{
									logic: "or",
									filters: [{
													field: "Status",
													operator: "eq",
													value: "1"
											},
											{
													field: "Status",
													operator: "eq",
													value: "2"
											}
									]
							}
					]
			}));
	},
	_modal: function(data) {
			mo.fn.overlay.show({
					loading: true,
					close: false
			});

			var ctalabel = "OK";
			var modtitle = "Viewing Onboarding request #" + data.EntryId;
			mo.fn.modal.show({
					ctaLabel: ctalabel,
					title: modtitle,
					content: '<div class="nbsf" style="overflow:hidden;padding-bottom:10px;max-width:100%"><div class="tabs"></div><div class="container"></div></div>',
					contentCallback: function() {
							var target = document.querySelector(".dxpModalContent .nbsf");
							var tabs = target.querySelector(".tabs");
							var container = target.querySelector(".container");
							container.innerHTML += '<iframe></iframe>';
							container.innerHTML += '<style>html .dxpModal {height: 100vh;box-sizing: border-box;width: 1200px!important;max-width: none!important;}.dxpModal .dxpModalFooter {display:none!important;}.dxpModal iframe {width:100%;height:100%;border:0;}html .dxpModal .dxpModalContainer,html .dxpModal .dxpModalContainer .dxpModalContent, html .dxpModal .dxpModalContainer .dxpModalContent .nbsf {height:100%;margin-bottom:0;padding-bottom:0;}</style>';
							container.querySelector("iframe").setAttribute("src", "https://hpe-rfb.it.hpe.com/form/681/072267d4-1434-420c-b241-1f366816ddcf?EntryId=" + data.EntryId);

							//// FUNCTIONALITY
							// TABS
							var allt = tabs.querySelectorAll("span");
							var allc = container.querySelectorAll("div[tab-id]");

							function hideAll() {
									for (i = 0; i < allt.length; i++)
											allt[i].setAttribute("class", "");
									for (i = 0; i < allc.length; i++)
											allc[i].setAttribute("class", "");
							}
							for (i = 0; i < allt.length; i++) {
									allt[i].addEventListener("click", function(e) {
											var tabid = e.target.getAttribute("tab-id");
											hideAll();
											e.target.classList.add("active");
											container.querySelector("div[tab-id=" + tabid + "]").classList.add("active");
									});
							}
							// TOGGLES
							var alltog = container.querySelectorAll("div.toggle");
							for (i = 0; i < alltog.length; i++) {
									alltog[i].addEventListener("click", function(e) {
											var el = e.target.closest("label");
											el.classList.toggle("active");
											if (el.getAttribute("class") == "active") el.querySelector("input").value = "Y";
											else el.querySelector("input").value = "N";
									});
							}

							//// CLOSE MODAL
							mo.fn.overlay.show({
									close: false
							})
					},
					ctaCallback: function() {
							// HELPERS
							var sel = document.querySelector(".dxpModalContent");
					}
			});
	},
	grid: {
			_custom: function() {
					var cusConfig = [
							{
									field: "EntryId",
									title: "ID",
									filterable: true,
									width: "85px",
									locked: true
							},
			/*
							{
									field: "Status",
									title: "Status",
									filterable: true,
									width: "85px",
									template: function(obj) {
										 return getStatus(obj.Status);
									}
							},
			*/
							{
									field: "PO_BackgroundGroup",
									title: "BG",
									filterable: true,
									width: 90,
									locked: false
							},
							{
									field: "Region",
									title: "Region",
									filterable: true,
									width: 115,
									locked: false
							},
							{
									field: "Geo",
									title: "Geo",
									filterable: true,
									width: 115,
							},
							{
									field: "SoldTo_Address_Country",
									title: "Country",
									filterable: true,
									width: 125,
							},
							{
									field: "SoldTo_CompanyName",
									title: "SoldTo CompanyName",
									filterable: true,
									width: 215,
							},
							{
									field: "PartyId",
									title: "PartyId",
									filterable: true,
									width: 115,


							},
							{
									field: "PO_Number",
									title: "PO",
									filterable: true,
									width: 115,
							},
							{
									field: "SubmittedTimestamp",
									title: "Date",
									filterable: false,
									width: 100,
									template: function(d) {
											try {
													return d.SubmittedTimestamp.split("T")[0];
											} catch (err) {
													return d.SubmittedTimestamp;
											}
									}
							},
							{
									field: "SubmitterEmail",
									title: "Submitter",
									filterable: true,
									width: 255
							},
							{
									field: "CaseNumber",
									title: "Case Number",
									filterable: true,
									width: 155,
							},
					];
					return cusConfig;
			},
			_default: function() {
					var defConfig = [];
					if (inProgress.data.length > 0)
							for (i = 0; i < Object.keys(inProgress.data[0]).length; i++) {
									var key = Object.keys(inProgress.data[0])[i];
									var obj = {};
									obj.field = key;
									obj.title = key;
									obj.hidden = true;
									defConfig.push(obj);
							}
					return defConfig;
			},
			_config: function() {
					var cusConfig = inProgress.grid._custom();
					var defConfig = inProgress.grid._default();
					for (j = cusConfig.length - 1; j >= 0; j--) {
							for (i = 0; i < defConfig.length; i++) {
									if (defConfig[i].field == cusConfig[j].field) {
											defConfig.splice(i, 1);
											break;
									}
							}
					}
					for (i = cusConfig.length - 1; i >= 0; i--) {
							defConfig.unshift(cusConfig[i]);
					}
					return defConfig;
			},
			_load: function(selector, datasource) {
					var parent = document.querySelector(selector.split(" .grid")[0]);
					let config = this._config();
					$(selector).kendoGrid({
							toolbar: [{
									name: "excel",
									text: "Download"
							}],
							excel: {
									fileName: "Onboarding_InProgress_" + parent.getAttribute("tab-id") + "_" + new Date().getTime() + ".xlsx",
									filterable: true,
									allPages: true
							},
							dataSource: datasource,
							columns: config,
							dataBound: function(e) {
									document.querySelector("#inProgress .tabs span[tab-id=" + parent.getAttribute("tab-id") + "] em").innerText = this.dataSource.total();
							},
							pageable: {
									buttonCount: 4,
									pageSize: 10,
									pageSizes: [10, 25, 50, 100],
									messages: {
											itemsPerPage: ""
									}
							},
							scrollable: true,
							sortable: true,
							filterable: true
					});
					$(selector + ' .k-grid-toolbar').appendTo(selector.split(" .grid")[0] + ' .toolbar');
					var exportFlag = false;
					$(selector).data("kendoGrid").bind("excelExport", function(e) {
							if (!exportFlag) {
									e.preventDefault();
									exportFlag = true;
									mo.fn.overlay.show({
											loading: true,
											close: false
									});
									setTimeout(function() {
											e.sender.saveAsExcel();
									}, 1500);
							} else {
									exportFlag = false;
									setTimeout(function() {
											mo.fn.overlay.hide();
									}, 500);
							}
					});
			},
			_datasource: function(filter) {
					return new kendo.data.DataSource({
							type: "rfb-v2",
							transport: {
									read: {
											url: "/form/data-set-provider/v2/989/NOR_Data_List/kendo/data"
									}
							},
							schema: {
									model: {
											id: "EntryId",
									}
							},
							filter: filter,
							serverPaging: true,
							pageSize: 10,
							serverFiltering: true,
							serverSorting: true,
					});
			}
	}
}  
</script> 

<!-- COMPONENT COMPLETED -->
<script>
const completed = {
	ready: false,
	data: {},
	_init: function() {
			if (!completed.ready) {
					mo.fn.overlay.show({
							loading: true,
							close: false
					});
					let self = this
					crud.read("3180", "eid=5415", function(d) {
							self.sample = d.Rows[0];
							completed.ui();
							completed._loadGrids();
							completed.ready = true;
							mo.fn.overlay.hide();
					});

			}
	},
	ui: function(cb) {
			if (document.querySelector("#completed .tabs") == null)
					document.querySelector("#completed").innerHTML += '<section class="tabs"></div>';
			if (document.querySelector("#completed .container") == null)
					document.querySelector("#completed").innerHTML += '<section class="container"></div>';

			document.querySelector("#completed .tabs").innerHTML += '<span tab-id="ops">Completed(<em>0</em>)</span>';
			document.querySelector("#completed .container").innerHTML += '<section tab-id="ops"><div class="grid"></div><div class="toolbar"></div></section>';
			// ADD REFRESH
			document.querySelector("#completed").innerHTML += '<span class="refresh"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="refresh" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M20,8 C18.5974037,5.04031171 15.536972,3 12,3 C7.02943725,3 3,7.02943725 3,12 C3,16.9705627 7.02943725,21 12,21 L12,21 C16.9705627,21 21,16.9705627 21,12 M21,3 L21,9 L15,9"></path></svg></span>';
			// ADD TAB ON CLICK
			var tabs = document.querySelectorAll("#completed .tabs span");
			var sections = document.querySelectorAll("#completed .container section");
			for (i = 0; i < tabs.length; i++) {
					tabs[i].addEventListener("click", function(e) {
							// RESET ALL TABS
							for (i = 0; i < tabs.length; i++)
									tabs[i].setAttribute("class", "");
							// RESET ALL SECTIONS
							for (i = 0; i < sections.length; i++)
									sections[i].setAttribute("class", "");
							// ENABLE REQUESTED SECTION
							var cid = e.target.getAttribute("tab-id") || e.target.closest("span").getAttribute("tab-id");
							document.querySelector("#completed span[tab-id=" + cid + "]").classList.add("active");
							document.querySelector("#completed section[tab-id=" + cid + "]").classList.add("active");
							var activeSection = document.querySelector("#completed section[tab-id=" + cid + "]");
							var kendoGrids = activeSection.querySelectorAll(".k-grid");

							kendoGrids.forEach(function(gridElement) {
									var kendoGridInstance = $(gridElement).data("kendoGrid");

									if (kendoGridInstance) {
											kendoGridInstance.resize();
									}
							});

					});
			}
			// DEFAULT TO FIRST TAB
			document.querySelector("#completed .tabs span").click();
			// ADD REFRESH EVENT
			document.querySelector("#completed span.refresh").addEventListener("click", completed._refresh);
			// CALLBACK
			if (typeof(cb) === "function") return cb();
			else return true;
	},
	_getCount: function() {
			var pend = completed.grid._datasource({
					logic: "and",
					filters: [
							{
									field: "Submitted",
									operator: "eq",
									value: "Y"
							},
							{
									logic: "or",
									filters: [{
													field: "SFDC_Status",
													operator: "neq",
													value: "ERROR"
											},
											{
													field: "SFDC_Status",
													operator: "isempty",
													value: ""
											}
									]
							},
							{
									field: "Status",
									operator: "eq",
									value: "3"
							},
					]
			});
			pend.fetch(function() {
					document.querySelector("#completed .tabs span[tab-id=ops] em").innerText = pend.total();
			});
	},
	_refresh: function() {
			mo.fn.overlay.show({
					loading: true,
					close: false
			});
			var grids = document.querySelectorAll("#completed .grid , #completed .toolbar");
			for (i = 0; i < grids.length; i++)
					grids[i].innerHTML = "";
			let self = this
			crud.read("3180", "eid=5415", function(d) {
					self.sample = d.Rows[0];
					completed._loadGrids();
					completed.ready = true;
					mo.fn.overlay.hide();
			});
	},
	_loadGrids: function() {
			// KENDO GRID HAS SOME ITERATION IN IT AND IT CONFLICTS WITH I,J,K AS INDEX VARIABLE; USE INDEX AS VARIABLE
			completed.grid._load("#completed section[tab-id=ops] .grid", completed.grid._datasource({
					logic: "and",
					filters: [{
									field: "Submitted",
									operator: "eq",
									value: "Y"
							},
							{
									logic: "or",
									filters: [{
													field: "SFDC_Status",
													operator: "neq",
													value: "ERROR"
											},
											{
													field: "SFDC_Status",
													operator: "isempty",
													value: ""
											}
									]
							},
							{
									field: "Status",
									operator: "eq",
									value: "3"
							},
					]
			}));
	},
	_modal: function(data) {
			mo.fn.overlay.show({
					loading: true,
					close: false
			});

			var ctalabel = "OK";
			var modtitle = "Viewing Onboarding request #" + data.EntryId;
			mo.fn.modal.show({
					ctaLabel: ctalabel,
					title: modtitle,
					content: '<div class="nbsf" style="overflow:hidden;padding-bottom:10px;max-width:100%"><div class="tabs"></div><div class="container"></div></div>',
					contentCallback: function() {
							var target = document.querySelector(".dxpModalContent .nbsf");
							var tabs = target.querySelector(".tabs");
							var container = target.querySelector(".container");
							container.innerHTML += '<iframe></iframe>';
							container.innerHTML += '<style>html .dxpModal {height: 100vh;box-sizing: border-box;width: 1200px!important;max-width: none!important;}.dxpModal .dxpModalFooter {display:none!important;}.dxpModal iframe {width:100%;height:100%;border:0;}html .dxpModal .dxpModalContainer,html .dxpModal .dxpModalContainer .dxpModalContent, html .dxpModal .dxpModalContainer .dxpModalContent .nbsf {height:100%;margin-bottom:0;padding-bottom:0;}</style>';
							container.querySelector("iframe").setAttribute("src", "https://hpe-rfb.it.hpe.com/form/681/072267d4-1434-420c-b241-1f366816ddcf?EntryId=" + data.EntryId);

							//// FUNCTIONALITY
							// TABS
							var allt = tabs.querySelectorAll("span");
							var allc = container.querySelectorAll("div[tab-id]");

							function hideAll() {
									for (i = 0; i < allt.length; i++)
											allt[i].setAttribute("class", "");
									for (i = 0; i < allc.length; i++)
											allc[i].setAttribute("class", "");
							}
							for (i = 0; i < allt.length; i++) {
									allt[i].addEventListener("click", function(e) {
											var tabid = e.target.getAttribute("tab-id");
											hideAll();
											e.target.classList.add("active");
											container.querySelector("div[tab-id=" + tabid + "]").classList.add("active");
									});
							}
							// TOGGLES
							var alltog = container.querySelectorAll("div.toggle");
							for (i = 0; i < alltog.length; i++) {
									alltog[i].addEventListener("click", function(e) {
											var el = e.target.closest("label");
											el.classList.toggle("active");
											if (el.getAttribute("class") == "active") el.querySelector("input").value = "Y";
											else el.querySelector("input").value = "N";
									});
							}

							//// CLOSE MODAL
							mo.fn.overlay.show({
									close: false
							})
					},
					ctaCallback: function() {
							// HELPERS
							var sel = document.querySelector(".dxpModalContent");
					}
			});
	},
	grid: {
			_custom: function() {
					var cusConfig = [
							{
									field: "EntryId",
									title: "ID",
									filterable: true,
									width: "85px",
									locked: true
							},
			/*
				{
									field: "Status",
									title: "Status",
									filterable: true,
									width: "85px",
									template: function(obj) {
										 return getStatus(obj.Status);
									}
							},
			*/
							{
									field: "PO_BackgroundGroup",
									title: "BG",
									filterable: true,
									width: 90,
									locked: false
							},
							{
									field: "Region",
									title: "Region",
									filterable: true,
									width: 115,
									locked: false
							},
							{
									field: "Geo",
									title: "Geo",
									filterable: true,
									width: 115,
							},
							{
									field: "SoldTo_Address_Country",
									title: "Country",
									filterable: true,
									width: 125,
							},
							{
									field: "SoldTo_CompanyName",
									title: "SoldTo CompanyName",
									filterable: true,
									width: 215,
							},
							{
									field: "PartyId",
									title: "PartyId",
									filterable: true,
									width: 115,


							},
							{
									field: "PO_Number",
									title: "PO",
									filterable: true,
									width: 115,
							},
							{
									field: "SubmittedTimestamp",
									title: "Date",
									filterable: false,
									width: 100,
									template: function(d) {
											try {
													return d.SubmittedTimestamp.split("T")[0];
											} catch (err) {
													return d.SubmittedTimestamp;
											}
									}
							},
							{
									field: "SubmitterEmail",
									title: "Submitter",
									filterable: true,
									width: 255
							},
							{
									field: "CaseNumber",
									title: "Case Number",
									filterable: true,
									width: 155,
							},
					];
					return cusConfig;
			},
			_default: function() {
					var defConfig = [];
					if (completed.data.length > 0)
							for (i = 0; i < Object.keys(completed.data[0]).length; i++) {
									var key = Object.keys(completed.data[0])[i];
									var obj = {};
									obj.field = key;
									obj.title = key;
									obj.hidden = true;
									defConfig.push(obj);
							}
					return defConfig;
			},
			_config: function() {
					var cusConfig = completed.grid._custom();
					var defConfig = completed.grid._default();
					for (j = cusConfig.length - 1; j >= 0; j--) {
							for (i = 0; i < defConfig.length; i++) {
									if (defConfig[i].field == cusConfig[j].field) {
											defConfig.splice(i, 1);
											break;
									}
							}
					}
					for (i = cusConfig.length - 1; i >= 0; i--) {
							defConfig.unshift(cusConfig[i]);
					}
					return defConfig;
			},
			_load: function(selector, datasource) {
					var parent = document.querySelector(selector.split(" .grid")[0]);
					let config = this._config();
					$(selector).kendoGrid({
							toolbar: [{
									name: "excel",
									text: "Download"
							}],
							excel: {
									fileName: "Onboarding_Completed_" + parent.getAttribute("tab-id") + "_" + new Date().getTime() + ".xlsx",
									filterable: true,
									allPages: true
							},
							dataSource: datasource,
							columns: config,
							dataBound: function(e) {
									document.querySelector("#completed .tabs span[tab-id=" + parent.getAttribute("tab-id") + "] em").innerText = this.dataSource.total();
							},
							pageable: {
									buttonCount: 4,
									pageSize: 10,
									pageSizes: [10, 25, 50, 100],
									messages: {
											itemsPerPage: ""
									}
							},
							scrollable: true,
							sortable: true,
							filterable: true
					});
					$(selector + ' .k-grid-toolbar').appendTo(selector.split(" .grid")[0] + ' .toolbar');
					var exportFlag = false;
					$(selector).data("kendoGrid").bind("excelExport", function(e) {
							if (!exportFlag) {
									e.preventDefault();
									exportFlag = true;
									mo.fn.overlay.show({
											loading: true,
											close: false
									});
									setTimeout(function() {
											e.sender.saveAsExcel();
									}, 1500);
							} else {
									exportFlag = false;
									setTimeout(function() {
											mo.fn.overlay.hide();
									}, 500);
							}
					});
			},
			_datasource: function(filter) {
					return new kendo.data.DataSource({
							type: "rfb-v2",
							transport: {
									read: {
											url: "/form/data-set-provider/v2/989/NOR_Data_List/kendo/data"
									}
							},
							schema: {
									model: {
											id: "EntryId",
									}
							},
							filter: filter,
							serverPaging: true,
							pageSize: 10,
							serverFiltering: true,
							serverSorting: true,
					});
			}
	}
}
</script>

<!-- COMPONENT CANCELLED -->
<script>
const cancelled = {
	ready: false,
	data: {},
	_init: function() {
			if (!cancelled.ready) {
					mo.fn.overlay.show({
							loading: true,
							close: false
					});
					let self = this
					crud.read("3180", "eid=5415", function(d) {
							self.sample = d.Rows[0];
							cancelled.ui();
							cancelled._loadGrids();
							cancelled.ready = true;
							mo.fn.overlay.hide();
					});

			}
	},
	ui: function(cb) {
			if (document.querySelector("#cancelled .tabs") == null)
					document.querySelector("#cancelled").innerHTML += '<section class="tabs"></div>';
			if (document.querySelector("#cancelled .container") == null)
					document.querySelector("#cancelled").innerHTML += '<section class="container"></div>';

			document.querySelector("#cancelled .tabs").innerHTML += '<span tab-id="ops">Cancelled (<em>0</em>)</span>';
			document.querySelector("#cancelled .container").innerHTML += '<section tab-id="ops"><div class="grid"></div><div class="toolbar"></div></section>';
			// ADD REFRESH
			document.querySelector("#cancelled").innerHTML += '<span class="refresh"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="refresh" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M20,8 C18.5974037,5.04031171 15.536972,3 12,3 C7.02943725,3 3,7.02943725 3,12 C3,16.9705627 7.02943725,21 12,21 L12,21 C16.9705627,21 21,16.9705627 21,12 M21,3 L21,9 L15,9"></path></svg></span>';
			// ADD TAB ON CLICK
			var tabs = document.querySelectorAll("#cancelled .tabs span");
			var sections = document.querySelectorAll("#cancelled .container section");
			for (i = 0; i < tabs.length; i++) {
					tabs[i].addEventListener("click", function(e) {
							// RESET ALL TABS
							for (i = 0; i < tabs.length; i++)
									tabs[i].setAttribute("class", "");
							// RESET ALL SECTIONS
							for (i = 0; i < sections.length; i++)
									sections[i].setAttribute("class", "");
							// ENABLE REQUESTED SECTION
							var cid = e.target.getAttribute("tab-id") || e.target.closest("span").getAttribute("tab-id");
							document.querySelector("#cancelled span[tab-id=" + cid + "]").classList.add("active");
							document.querySelector("#cancelled section[tab-id=" + cid + "]").classList.add("active");
							var activeSection = document.querySelector("#cancelled section[tab-id=" + cid + "]");
							var kendoGrids = activeSection.querySelectorAll(".k-grid");

							kendoGrids.forEach(function(gridElement) {
									var kendoGridInstance = $(gridElement).data("kendoGrid");

									if (kendoGridInstance) {
											kendoGridInstance.resize();
									}
							});

					});
			}
			// DEFAULT TO FIRST TAB
			document.querySelector("#cancelled .tabs span").click();
			// ADD REFRESH EVENT
			document.querySelector("#cancelled span.refresh").addEventListener("click", cancelled._refresh);
			// CALLBACK
			if (typeof(cb) === "function") return cb();
			else return true;
	},
	_getCount: function() {
			var pend = cancelled.grid._datasource({
					logic: "and",
					filters: [{
									field: "Submitted",
									operator: "eq",
									value: "Y"
							},
							{
									logic: "or",
									filters: [{
													field: "SFDC_Status",
													operator: "neq",
													value: "ERROR"
											},
											{
													field: "SFDC_Status",
													operator: "isempty",
													value: ""
											}
									]
							},
							{
									field: "Status",
									operator: "eq",
									value: "5"
							},
					]
			});
			pend.fetch(function() {
					document.querySelector("#cancelled .tabs span[tab-id=ops] em").innerText = pend.total();
			});
	},
	_refresh: function() {
			mo.fn.overlay.show({
					loading: true,
					close: false
			});
			var grids = document.querySelectorAll("#cancelled .grid , #cancelled .toolbar");
			for (i = 0; i < grids.length; i++)
					grids[i].innerHTML = "";
			let self = this
			crud.read("3180", "eid=5415", function(d) {
					self.sample = d.Rows[0];
					cancelled._loadGrids();
					cancelled.ready = true;
					mo.fn.overlay.hide();
			});
	},
	_loadGrids: function() {
			// KENDO GRID HAS SOME ITERATION IN IT AND IT CONFLICTS WITH I,J,K AS INDEX VARIABLE; USE INDEX AS VARIABLE
			cancelled.grid._load("#cancelled section[tab-id=ops] .grid", cancelled.grid._datasource({
					logic: "and",
					filters: [{
									field: "Submitted",
									operator: "eq",
									value: "Y"
							},
							{
									logic: "or",
									filters: [{
													field: "SFDC_Status",
													operator: "neq",
													value: "ERROR"
											},
											{
													field: "SFDC_Status",
													operator: "isempty",
													value: ""
											}
									]
							},
							{
									field: "Status",
									operator: "eq",
									value: "5"
							},
					]
			}));
	},
	_modal: function(data) {
			mo.fn.overlay.show({
					loading: true,
					close: false
			});

			var ctalabel = "OK";
			var modtitle = "Viewing Onboarding request #" + data.EntryId;
			mo.fn.modal.show({
					ctaLabel: ctalabel,
					title: modtitle,
					content: '<div class="nbsf" style="overflow:hidden;padding-bottom:10px;max-width:100%"><div class="tabs"></div><div class="container"></div></div>',
					contentCallback: function() {
							var target = document.querySelector(".dxpModalContent .nbsf");
							var tabs = target.querySelector(".tabs");
							var container = target.querySelector(".container");
							container.innerHTML += '<iframe></iframe>';
							container.innerHTML += '<style>html .dxpModal {height: 100vh;box-sizing: border-box;width: 1200px!important;max-width: none!important;}.dxpModal .dxpModalFooter {display:none!important;}.dxpModal iframe {width:100%;height:100%;border:0;}html .dxpModal .dxpModalContainer,html .dxpModal .dxpModalContainer .dxpModalContent, html .dxpModal .dxpModalContainer .dxpModalContent .nbsf {height:100%;margin-bottom:0;padding-bottom:0;}</style>';
							container.querySelector("iframe").setAttribute("src", "https://hpe-rfb.it.hpe.com/form/681/072267d4-1434-420c-b241-1f366816ddcf?EntryId=" + data.EntryId);

							//// FUNCTIONALITY
							// TABS
							var allt = tabs.querySelectorAll("span");
							var allc = container.querySelectorAll("div[tab-id]");

							function hideAll() {
									for (i = 0; i < allt.length; i++)
											allt[i].setAttribute("class", "");
									for (i = 0; i < allc.length; i++)
											allc[i].setAttribute("class", "");
							}
							for (i = 0; i < allt.length; i++) {
									allt[i].addEventListener("click", function(e) {
											var tabid = e.target.getAttribute("tab-id");
											hideAll();
											e.target.classList.add("active");
											container.querySelector("div[tab-id=" + tabid + "]").classList.add("active");
									});
							}
							// TOGGLES
							var alltog = container.querySelectorAll("div.toggle");
							for (i = 0; i < alltog.length; i++) {
									alltog[i].addEventListener("click", function(e) {
											var el = e.target.closest("label");
											el.classList.toggle("active");
											if (el.getAttribute("class") == "active") el.querySelector("input").value = "Y";
											else el.querySelector("input").value = "N";
									});
							}

							//// CLOSE MODAL
							mo.fn.overlay.show({
									close: false
							})
					},
					ctaCallback: function() {
							// HELPERS
							var sel = document.querySelector(".dxpModalContent");
					}
			});
	},
	grid: {
			_custom: function() {
					var cusConfig = [
							{
									field: "EntryId",
									title: "ID",
									filterable: true,
									width: "85px",
									locked: true
							},
			/*
							{
									field: "Status",
									title: "Status",
									filterable: true,
									width: "85px",
									template: function(obj) {
										 return getStatus(obj.Status);
									}
							},
			*/
							{
									field: "PO_BackgroundGroup",
									title: "BG",
									filterable: true,
									width: 90,
									locked: false
							},
							{
									field: "Region",
									title: "Region",
									filterable: true,
									width: 115,
									locked: false
							},
							{
									field: "Geo",
									title: "Geo",
									filterable: true,
									width: 115,
							},
							{
									field: "SoldTo_Address_Country",
									title: "Country",
									filterable: true,
									width: 125,
							},
							{
									field: "SoldTo_CompanyName",
									title: "SoldTo CompanyName",
									filterable: true,
									width: 215,
							},
							{
									field: "PartyId",
									title: "PartyId",
									filterable: true,
									width: 115,


							},
							{
									field: "PO_Number",
									title: "PO",
									filterable: true,
									width: 115,
							},
							{
									field: "SubmittedTimestamp",
									title: "Date",
									filterable: false,
									width: 100,
									template: function(d) {
											try {
													return d.SubmittedTimestamp.split("T")[0];
											} catch (err) {
													return d.SubmittedTimestamp;
											}
									}
							},
							{
									field: "SubmitterEmail",
									title: "Submitter",
									filterable: true,
									width: 255
							},
							{
									field: "CaseNumber",
									title: "Case Number",
									filterable: true,
									width: 155,
							},
					];
					return cusConfig;
			},
			_default: function() {
					var defConfig = [];
					if (cancelled.data.length > 0)
							for (i = 0; i < Object.keys(cancelled.data[0]).length; i++) {
									var key = Object.keys(cancelled.data[0])[i];
									var obj = {};
									obj.field = key;
									obj.title = key;
									obj.hidden = true;
									defConfig.push(obj);
							}
					return defConfig;
			},
			_config: function() {
					var cusConfig = cancelled.grid._custom();
					var defConfig = cancelled.grid._default();
					for (j = cusConfig.length - 1; j >= 0; j--) {
							for (i = 0; i < defConfig.length; i++) {
									if (defConfig[i].field == cusConfig[j].field) {
											defConfig.splice(i, 1);
											break;
									}
							}
					}
					for (i = cusConfig.length - 1; i >= 0; i--) {
							defConfig.unshift(cusConfig[i]);
					}
					return defConfig;
			},
			_load: function(selector, datasource) {
					var parent = document.querySelector(selector.split(" .grid")[0]);
					let config = this._config();
					$(selector).kendoGrid({
							toolbar: [{
									name: "excel",
									text: "Download"
							}],
							excel: {
									fileName: "Onboarding_cancelled_" + parent.getAttribute("tab-id") + "_" + new Date().getTime() + ".xlsx",
									filterable: true,
									allPages: true
							},
							dataSource: datasource,
							columns: config,
							dataBound: function(e) {
									document.querySelector("#cancelled .tabs span[tab-id=" + parent.getAttribute("tab-id") + "] em").innerText = this.dataSource.total();
							},
							pageable: {
									buttonCount: 4,
									pageSize: 10,
									pageSizes: [10, 25, 50, 100],
									messages: {
											itemsPerPage: ""
									}
							},
							scrollable: true,
							sortable: true,
							filterable: true
					});
					$(selector + ' .k-grid-toolbar').appendTo(selector.split(" .grid")[0] + ' .toolbar');
					var exportFlag = false;
					$(selector).data("kendoGrid").bind("excelExport", function(e) {
							if (!exportFlag) {
									e.preventDefault();
									exportFlag = true;
									mo.fn.overlay.show({
											loading: true,
											close: false
									});
									setTimeout(function() {
											e.sender.saveAsExcel();
									}, 1500);
							} else {
									exportFlag = false;
									setTimeout(function() {
											mo.fn.overlay.hide();
									}, 500);
							}
					});
			},
			_datasource: function(filter) {
					return new kendo.data.DataSource({
							type: "rfb-v2",
							transport: {
									read: {
											url: "/form/data-set-provider/v2/989/NOR_Data_List/kendo/data"
									}
							},
							schema: {
									model: {
											id: "EntryId",
									}
							},
							filter: filter,
							serverPaging: true,
							pageSize: 10,
							serverFiltering: true,
							serverSorting: true,
					});
			}
	}
}

</script>


<!-- LOAD PAGE -->
<script>
	hpe.supplies.crud();
	hpe.supplies.mojs();
	hpe.supplies.ckie();
	hpe.supplies.mail();
	//hpe.supplies.nbsf();
	hpe.supplies.q.end(function() {
			$('body').hide();
			mo.init();
			applet._init(function() {
					ui.burger.init();
					ui.nav.init();
					ui.icons.init();
					ui._logo();
					// DOCUMENT LEVEL EVENTS
					document.addEventListener("click", function(e) {
							ui.burger.escape(e);
							ui.icons.escape(e);
							ui.message.escape(e);
					});
					// ADD JIRA COLLECTOR FOR BUGS
					$('section#nav #icons ul li[icon-id="bugs"] a').click(function(event) {
							event.preventDefault();
							document.querySelector('.atlwdg-trigger.atlwdg-SUBTLE').click();
					});
					//ui._overview();
					crud.q.stop(function() {
							// CHECK EXISTING QUERY
							if (document.querySelector("input[type=hidden][name=q]").value.length > 0) {
									document.querySelector("#search").value = document.querySelector("input[type=hidden][name=q]").value;
									review._init(document.querySelector("#search").value);
							} else mo.fn.overlay.hide();
					});
			});
			$('body').show();
			document.querySelector("select[id=searchoptions]").addEventListener("change", function() {
					document.querySelector("#search").value = "";
					if (document.querySelector("select[id=searchoptions]").value == "AppID") {
							document.querySelector("#search").placeholder = "Search for any AppID";
					} else {
							document.querySelector("#search").placeholder = "Search for any PO";
					}
			});
	});
</script>