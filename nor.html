<!-- Load and read SSO data '[SSOData.Locale]' -->
<script>
  let PO_CompleteDeliveryLogicCheck = false;
  let QODCheck = false;

  function elog(r) {
	errorLog = {
	  app: config.dataset,
	  sso: global.data,
	  xrf: reference.xref
	};
	if (typeof(r) !== "undefined" && r != null)
	  errorLog.r = r;
	crud.create("3592", {
	  LOG: JSON.stringify(errorLog)
	}, function(d) {
	  console.info("Error log created successfully");
	})
  } // create error log

  function locationAddress(currentVal, type, hasNationalID) {
	mo.fn.overlay.show({
	  progressText: hpe.fn.lang("FormCFI011", config.locale, config.localizations),
	  progressPercent: 40,
	  close: false
	});
	const xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function() {
	  if (xhr.readyState == 4) {
		if (xhr.status == 200) {
		  const response = JSON.parse(xhr.responseText);
		  console.log('[locationAddress] response:', response);
		  if (response && response.status === 'SUCCESS' && response.searchList && response.searchList.length) {
			mo.fn.overlay.show({
			  progressText: hpe.fn.lang("FormCFI012", config.locale, config.localizations),
			  progressPercent: 80,
			  close: false
			});
			const locationRes = response.searchList[0];
			let loc_country;
			if (locationRes.countryCode && reference.countriesData && reference.countriesData.length) {
			  const locCounty = reference.countriesData.find(el => el.ISO2 == locationRes.countryCode);
			  loc_country = locCounty.Name || '';
			}
			config.dataset[`${type}_Address_Country`] = loc_country;

			config.dataset[`${type}_PartyId`] = locationRes.locationId || currentVal;
			$(`input[data-name="${type}_PartyId"]`).val(config.dataset[`${type}_PartyId`]);

			config.dataset[`${type}_CompanyName`] = locationRes.name || "";
			config.dataset[`${type}_Address_City`] = locationRes.city || "";
			config.dataset[`${type}_Address_Postal`] = locationRes.postalcode || "";
			config.dataset[`${type}_Address_Street`] = locationRes.addressLine1 || ""
			config.dataset[`${type}_Address_Street2`] = locationRes.addressLine2 || "";
			config.dataset[`${type}_Address_State`] = locationRes.stateName || "";
			config.dataset[`${type}_NationalID`] = '';

			if (hasNationalID) {
			  // add 
			}
			nbsf.init(config, config.page);
			if (document.querySelector(`*[data-name="${type}_Address_Country"]`))
			  $(`*[data-name="${type}_Address_Country"]`).val(loc_country || '');
			if (document.querySelector(`*[data-name="${type}_CompanyName"]`))
			  $(`*[data-name="${type}_CompanyName"]`).val(locationRes.name || "");
			if (document.querySelector(`*[data-name="${type}_Address_State"]`))
			  $(`*[data-name="${type}_Address_State"]`).val(locationRes.stateName || "");
			if (document.querySelector(`*[data-name="${type}_Address_City"]`))
			  $(`*[data-name="${type}_Address_City"]`).val(locationRes.city || "");
			if (document.querySelector(`*[data-name="${type}_Address_Postal"]`))
			  $(`*[data-name="${type}_Address_Postal"]`).val(locationRes.postalcode || "");
			if (document.querySelector(`*[data-name="${type}_Address_Street"]`))
			  $(`*[data-name="${type}_Address_Street"]`).val(locationRes.addressLine1 || "");
			if (document.querySelector(`*[data-name="${type}_Address_Street2"]`))
			  $(`*[data-name="${type}_Address_Street2"]`).val(locationRes.addressLine2 || "");
			if (document.querySelector(`*[data-name="${type}_NationalID"]`))
			  $(`*[data-name="${type}_NationalID"]`).val('');
			
			setTimeout(function() {
			  mo.fn.overlay.hide();
			  mo.fn.events.closeAll();
			}, 1000);
		  } 
		  else {
			setTimeout(function() {
			  mo.fn.overlay.show({
				progressText: hpe.fn.lang("FormCFI013", config.locale, config.localizations),
				progressPercent: 100,
				close: false
			  });

			  config.clearData({
				fields: config.sectionAddressFields[type],
				clearInput: true
			  });

			  nbsf.init(config, config.page);
			  mo.fn.modal.show({
				ctaLabel: hpe.fn.lang('OK', config.locale, config.localizations),
				title: hpe.fn.lang('ErrorGeneric2', config.locale, config.localizations),
				content: d.message + ".",
				ctaCallback: function() {
				  mo.fn.events.closeAll();
				},
				contentCallback: function() {}
			  });
			}, 1000);

		  }
		} else {
		  console.log('error of locationId');
		  mo.fn.overlay.hide();
		  mo.fn.events.closeAll();
		}
	  }
	}
	xhr.open(
	  'GET',
	  `https://hpe-rfb.itcs.hpe.com/resources/rs/custom/php/nor/location/location-prod.php?id=${currentVal}`
	);
	xhr.timeout = 80000;
	const errorHandler = function() {
	  setTimeout(function() {
		mo.fn.overlay.show({
		  progressText: hpe.fn.lang("FormCFI013", config.locale, config.localizations),
		  progressPercent: 100,
		  close: false
		});

		config.clearData({
		  fields: config.sectionAddressFields[type],
		  clearInput: true
		});

		nbsf.init(config, config.page);
		mo.fn.modal.show({
		  ctaLabel: hpe.fn.lang('OK', config.locale, config.localizations),
		  title: hpe.fn.lang('ErrorGeneric2', config.locale, config.localizations),
		  content: d.message + ".",
		  ctaCallback: function() {
			mo.fn.events.closeAll();
		  },
		  contentCallback: function() {}
		});
	  }, 1000);
	}
	xhr.onerror = errorHandler;
	xhr.onabort = errorHandler;
	xhr.ontimeout = errorHandler;
	xhr.send(null);
  }

  function EMDMAddress(currentVal, type, hasNationalID) {
	hpe.data.xref(currentVal, function(d) {
	  console.log('EMDMAddress', d)
	  mo.fn.overlay.show({
		progressText: hpe.fn.lang("FormCFI011", config.locale, config.localizations),
		progressPercent: 40,
		close: false
	  })

	  if (d.status == 'SUCCESS') {
		config.dataset.xrefFail = 'No';
		mo.fn.overlay.show({
		  progressText: hpe.fn.lang("FormCFI012", config.locale, config.localizations),
		  progressPercent: 80,
		  close: false
		})
		// HIDDEN INPUT: SOLDTO
		config.dataset[`${type}_Address_Country`] = d.party[0].countryName;
		config.dataset[`${type}_PartyId`] = d.party[0].currentPartyID || d.party[0].submittedPartyID || currentVal;
		$(`input[data-name="${type}_PartyId"]`).val(config.dataset[`${type}_PartyId`]);

		let alternateName = '';
		if (d.party[0].organizationAlternateName && d.party[0].organizationAlternateName.length > 0) {
		  d.party[0].organizationAlternateName.forEach(function(item) {
			if (
			  item.internalOverWriteFlag === 'Y' &&
			  item.status === 'ACTIVE' &&
			  item.characterScript === 'LATN' &&
			  item.type === 'TRADESTYLE'
			) {
			  alternateName = item.organizationAlternateName;
			}
		  });
		}
		config.dataset[`${type}_CompanyName`] = alternateName ? alternateName : d.party[0].organizationName;

		let addressMatched = null;
		if (d.party[0].address && d.party[0].address.length > 0) {
		  addressMatched = d.party[0].address.find(item => {
			return item.internalOverWriteFlag == "Y" && item.status == "ACTIVE" && item.addressType == "PHY" && item.countryLanguageCode.includes('-LATN');
		  });

		  if (!addressMatched) {
			addressMatched = d.party[0].address.find(item => {
			  return item.status == "ACTIVE" && item.addressType == "PHY" && item.countryLanguageCode.includes('-LATN');
			});
		  }

		  if (!addressMatched) {
			addressMatched = d.party[0].address.find(item => {
			  return item.status == "ACTIVE" && item.addressType == "PHY";
			});
		  }

		  if (addressMatched) {
			if (["Australia", "New Zealand", "India", "Malaysia", "Argentina", "Brazil", "Chile", "Colombia", "Mexico", "Peru", "Puerto Rico"].indexOf(d.party[0].countryName) > -1)
			  config.dataset[`${type}_Address_State`] = addressMatched.stateProvince;

			let address1 = addressMatched.addressLine1;
			let address2 = addressMatched.addressLine2;
			if (!addressMatched.addressLine2 && addressMatched.addressLine1.length > 55) {
			  const separator = addressMatched.addressLine1.substr(0, 55).lastIndexOf(' ');
			  address1 = addressMatched.addressLine1.substr(0, separator);
			  address2 = addressMatched.addressLine1.substr(separator + 1);
			}

			config.dataset[`${type}_Address_City`] = addressMatched.cityName;
			config.dataset[`${type}_Address_Postal`] = addressMatched.postalCode;
			config.dataset[`${type}_Address_Street`] = address1;
			config.dataset[`${type}_Address_Street2`] = address2;
		  }
		}

		if (hasNationalID) {
		  if (["Argentina", "Brazil", "Chile", "Colombia", "Mexico", "Peru", "Puerto Rico"].indexOf(d.party[0].countryName) > -1) {
			var externalidentifier = d.party[0].externalIdentifier;
			for (i = 0; i < externalidentifier.length; i++) {
			  if (externalidentifier[i].status == "ACTIVE" && ["Tax Number 1"].indexOf(externalidentifier[i].externalIdentifierName) > -1) {
				config.dataset[`${type}_NationalID`] = externalidentifier[i].identifierValue;
				break;
			  }
			}
		  }
		}
		nbsf.init(config, config.page);
		setTimeout(function() {
		  mo.fn.overlay.hide()
		}, 1000);
	  } else if (d.status == 'FAIL' && d.code == "EMS005") {
		config.dataset.xrefFail = 'No';
		setTimeout(function() {
		  mo.fn.overlay.show({
			progressText: hpe.fn.lang("FormCFI013", config.locale, config.localizations),
			progressPercent: 100,
			close: false
		  });

		  config.clearData({
			fields: config.sectionAddressFields[type],
			clearInput: true
		  });

		  nbsf.init(config, config.page);
		  mo.fn.modal.show({
			ctaLabel: hpe.fn.lang('OK', config.locale, config.localizations),
			title: hpe.fn.lang('ErrorGeneric2', config.locale, config.localizations),
			content: d.message + ".",
			ctaCallback: function() {
			  mo.fn.events.closeAll();
			},
			contentCallback: function() {}
		  });
		}, 1000);
	  } else {
		config.dataset.xrefFail = 'Yes';

		config.clearData({
		  fields: config.sectionAddressFields[type],
		  clearInput: true
		});

		nbsf.init(config, config.page);
		mo.fn.modal.show({
		  ctaLabel: hpe.fn.lang('OK', config.locale, config.localizations),
		  title: hpe.fn.lang('ErrorGeneric2', config.locale, config.localizations),
		  content: hpe.fn.lang("FormCFI014", config.locale, config.localizations),
		  ctaCallback: function() {
			mo.fn.events.closeAll();
		  },
		  contentCallback: function() {}
		});
	  }
	  // Reflect dataset's data in reviewDataset
	  if (Object.keys(config.reviewDataset)) {
		[`${type}_Address_Country`, `${type}_CompanyName`, `${type}_Address_State`, `${type}_Address_City`,
		 `${type}_Address_Postal`, `${type}_Address_Street`, `${type}_Address_Street2`, `${type}_NationalID`
		].forEach(key => config.reviewDataset[key] = config.dataset[key]);
	  };
	  
	});
  }

  const assigntoteamValues = [{
	teamName: "Aruba AAS",
	region: "WW",
	PO_BackgroundGroup: "Edge"
  },
							  {
								teamName: "Aruba-HPEN Request Only",
								region: "AMS",
								PO_BackgroundGroup: "Edge"
							  },
							  {
								teamName: "OTC WW ComputeStorage EAAS",
								region: "WW",
								PO_BackgroundGroup: "Hybrid IT"
							  },
							  {
								teamName: "OTC EMEA Aruba Orders",
								region: "EMEA",
								PO_BackgroundGroup: "Edge"
							  },
							  {
								teamName: "Global OP Indirect Manual",
								region: "EMEA",
								PO_BackgroundGroup: "Hybrid IT"
							  },
							  {
								teamName: "Global OP Indirect Manual",
								region: "APJ, India",
								PO_BackgroundGroup: "Hybrid IT"
							  },
							  {
								teamName: "OTC AMS OP Brazil",
								region: "AMS, Latin America, North America, Brazil",
								PO_BackgroundGroup: "Hybrid IT"
							  },
							  {
								teamName: "OTC AMS OP MEX/MCA",
								region: "AMS, Latin America, North America",
								PO_BackgroundGroup: "Hybrid IT"
							  },
							  {
								teamName: "OTC APJ OP HK & TW",
								region: "APJ, Hong Kong, Taiwan",
								PO_BackgroundGroup: "Hybrid IT"
							  },
							  {
								teamName: "Global OP Indirect Manual",
								region: "APJ, Australia, New Zealand",
								PO_BackgroundGroup: "Hybrid IT"
							  },
							  {
								teamName: "OTC APJ OP Korea",
								region: "APJ, Korea",
								PO_BackgroundGroup: "Hybrid IT"
							  },
							  {
								teamName: "Global OP Indirect Manual",
								region: "APJ",
								PO_BackgroundGroup: "Hybrid IT"
							  },
							  {
								teamName: "OTC APJ OP Japan",
								region: "APJ, Japan",
								PO_BackgroundGroup: "Hybrid IT"
							  },
							  {
								teamName: "OTC APJ OP China",
								region: "APJ, China",
								PO_BackgroundGroup: "Hybrid IT"
							  },
							  {
								teamName: "None",
								region: "APJ",
								PO_BackgroundGroup: "Edge"
							  }
							 ];
  let global = {
	ready: false,
	nonPoModelCountries: ["JP", "KR", "CN", "TH", "VN", "BD", "KH", "MN", "LK", "LA", "NP", "PK", "ID", "VN", "BN", "BT", "MV", "AF", "MM", "HK", "TW", "AU", "NZ", "MO"],
	data: {
	  brt: {
		code: null,
		name: null,
		channel: null,
		pas: null
	  },
	  userPreferences:{}, // Map PANumber:UserPreferences
	  company: {
		party: null,
		country: null,
		global: null,
		brt: null,
		PreferredBusinessRelationship: null,
		name: null
	  },
	  geo: {
		//name: "India", //CFI
		//code: "IN" //CFI
		name: null,
		code: null
	  },
	  user: {
		email: null,
		fname: null,
		lname: null,
		hpp: "[SSOData.HPPUserId]",
		locale: "en_US",
		language: null,
		planguage: null
	  },
	  brts: [
		{
		  code: "OEV",
		  name: "Virtual OEM",
		  channel: ["ICMOEM", "ICMChannelGeneral"]
		},
		{
		  code: "RS1",
		  name: "T1 Solution Provider",
		  channel: ["ICMChannelT1", "ICMChannelGeneral"]
		},
		{
		  code: "DT1",
		  name: "Distributor",
		  channel: ["ICMChannelT1", "ICMChannelDistributor", "ICMChannelGeneral"]
		},
		{
		  code: "ODP",
		  name: "OEM Distributor",
		  channel: ["ICMOEM", "ICMChannelGeneral"]
		},
		{
		  code: "SI1",
		  name: "System Integrator",
		  channel: ["ICMChannelGeneral"]
		},
		{
		  code: "MAP",
		  name: "Master Area Partner",
		  channel: ["ICMChannelT1", "ICMChannelGeneral"]
		},
		{
		  code: "DS1",
		  name: "Supplies Distributor",
		  channel: ["ICMChannelGeneral"]
		},
		{
		  code: "RF1",
		  name: "Federal Reseller",
		  channel: ["ICMChannelGeneral"]
		},
		{
		  code: "SP1",
		  name: "T1 Service Provider",
		  channel: ["ICMChannelT1", "ICMChannelGeneral"]
		},
		{
		  code: "DR1",
		  name: "Remarketing Distributor",
		  channel: ["ICMChannelGeneral"]
		}
	  ],
	  partyData: null, 
	},
	init: function(cb) {
	  let self = this;

	  global.data.user.internal = false;
	  if ("[SSOData.Email]".indexOf('@hpe.com') > -1)
		global.data.user.internal = true;

	  if (!global.data.user.internal) {
		this.sso();
		this.sor(function() {
		  self.ready = true;
		  // set channel data; required for iCertis;
		  for (let i = 0; i < global.data.brts.length; i++)
			if (self.data.brt.code.toLowerCase() == self.data.brts[i].code.toLowerCase())
			  self.data.brt.channel = self.data.brts[i].channel;
		  // execute callback when all said and done
		  if (typeof(cb) === 'function')
			cb(self);
		});
	  }
	},
	sso: function() {
	  global.data.brt.code = JSON.parse(String.raw`[SSOData.PreferredBusinessRelationship]`).businessRelationshipTypeCode;
	  global.data.brt.name = JSON.parse(String.raw`[SSOData.PreferredBusinessRelationship]`).businessRelationshipTypeName;
	  //global.data.brt.channel = [];
	  // SETTING THE CHANNEL IS IMPORTANT
	  // IT NEEDS TO BE AVAILABLE FOR THE iCERTIS CALL
	  for (let i = 0; i < global.data.brts.length; i++) {
		if (global.data.brt.code.toLowerCase() == global.data.brts[i].code.toLowerCase())
		  global.data.brt.channel = global.data.brts[i].channel;
	  }
	  global.data.brt.pas = [];

	  global.data.company.party = "[SSOData.PartyId]";
	  global.data.company.country = "[SSOData.CountryEntityId]";
	  global.data.company.global = "[SSOData.GlobalEntityId]";
	  global.data.company.brt = JSON.parse(String.raw`[SSOData.PreferredBusinessRelationship]`).businessRelationshipTypeName;
	  global.data.company.PreferredBusinessRelationship = JSON.parse(String.raw`[SSOData.PreferredBusinessRelationship]`);
	  global.data.company.name = "[SSOData.PartnerName]";

	  global.data.geo.name = "[SSOData.PhysCountry]"; //CFI
	  global.data.geo.code = "[SSOData.CountryCode]"; //CFI

	  //global.data.geo.name = "India";
	  //global.data.geo.code = "IN";

	  global.data.user.email = "[SSOData.Email]";
	  global.data.user.fname = "[SSOData.FirstName]";
	  global.data.user.lname = "[SSOData.LastName]";
	  global.data.user.hpp = "[SSOData.HPPUserId]";
	  global.data.user.locale = "[SSOData.Locale]";
	  global.data.user.language = "[SSOData.PreferredLanguageCode]";
	  global.data.user.planguage = "[SSOData.Language]";
	},
	sor: function(cb) {
	  profile.get({
		email: '[SSOData.Email]',
		relationship: true,
		company: true,
		geography: true,
		business: true
	  }, function(d) {
		if (d.success) {
		  global.data.company.country = d.business.GroupId;
		  global.data.company.global = d.business.GroupId;
		  global.data.company.name = d.company.Name;
		  global.data.geo.name = d.geography.Name; //CFI
		  global.data.geo.code = d.geography.ISO2; //CFI
		  //global.data.geo.name = "India";
		  //global.data.geo.code = "IN";
		  global.data.geo.geography = d.geography.GEO;
		  global.data.geo.region = d.geography.Region;
		  global.data.geo.subregion = d.geography.SubRegion;
		  global.data.user.hpp = d.user.HPPId;
		  global.data.user.locale = d.user.Locale;
		  global.data.user.language = d.user.PreferredLanguage;
		  global.data.user.planguage = d.user.PreferredLanguage;
		  hpe.api.dataset({
			form: "989",
			dataset: "SOR_BRT_SIM_Extended",
			payload: {
			  filter: {
				logic: "and",
				filters: [{
				  logic: "or",
				  filters: [{
					field: 'parent_entity',
					operator: 'eq',
					value: d.business.GroupId
				  },
							{
							  field: 'party_id',
							  operator: 'eq',
							  value: d.company.PartyId
							}
						   ]
				},
						  {
							field: 'relationship',
							operator: 'eq',
							value: d.relationship.BRType
						  },
						  {
							field: 'status',
							operator: 'eq',
							value: 'ACTIVE'
						  }
						 ]
			  },
			  pageSize: 1000
			}
		  }, function(dataset) {
			global.data.sim = [...new Set(dataset.Data.map(item => item.SIM_ISO2))];
		  });
		  let brtCode = global.data.brts.filter(function(item) {
			return (item.name.toLowerCase() == global.data.brt.name.toLowerCase())
		  });
		  global.data.brt.code = brtCode[0].code;
		}
	  });
	}
  }


  if ("[SSOData.Email]".indexOf('@hpe.com') > -1) global.data.user.internal = true;
  else global.data.user.internal = false;

  if (!global.data.user.internal) {
	global.data.brt.code = JSON.parse(String.raw`[SSOData.PreferredBusinessRelationship]`).businessRelationshipTypeCode;
	global.data.brt.name = JSON.parse(String.raw`[SSOData.PreferredBusinessRelationship]`).businessRelationshipTypeName;
	//global.data.brt.channel = [];
	// SETTING THE CHANNEL IS IMPORTANT
	// IT NEEDS TO BE AVAILABLE FOR THE iCERTIS CALL
	for (let i = 0; i < global.data.brts.length; i++) {
	  if (global.data.brt.code.toLowerCase() == global.data.brts[i].code.toLowerCase())
		global.data.brt.channel = global.data.brts[i].channel;
	}
	global.data.brt.pas = [];

	global.data.company.party = "[SSOData.PartyId]";
	global.data.company.country = "[SSOData.CountryEntityId]";
	global.data.company.global = "[SSOData.GlobalEntityId]";
	global.data.company.brt = JSON.parse(String.raw`[SSOData.PreferredBusinessRelationship]`).businessRelationshipTypeName;
	global.data.company.PreferredBusinessRelationship = JSON.parse(String.raw`[SSOData.PreferredBusinessRelationship]`);
	global.data.company.name = "[SSOData.PartnerName]";

	global.data.geo.name = "[SSOData.PhysCountry]"; //CFI
	global.data.geo.code = "[SSOData.CountryCode]"; //CFI

	//global.data.geo.name = "India";
	//global.data.geo.code = "IN";

	global.data.user.email = "[SSOData.Email]";
	global.data.user.fname = "[SSOData.FirstName]";
	global.data.user.lname = "[SSOData.LastName]";
	global.data.user.hpp = "[SSOData.HPPUserId]";
	global.data.user.locale = "[SSOData.Locale]";
	global.data.user.language = "[SSOData.PreferredLanguageCode]";
	global.data.user.planguage = "[SSOData.Language]";
	
	if (!global.data.company.party)
	  global.error = 'FormNoParty';

	profile.get({
	  email: '[SSOData.Email]',
	  relationship: true,
	  company: true,
	  geography: true,
	  business: true
	},
				function(d) {
	  if (d.success) {
		global.data.company.country = d.business.GroupId;
		global.data.company.global = d.business.GroupId;
		global.data.company.name = d.company.Name;
		global.data.geo.name = d.geography.Name; //CFI
		global.data.geo.code = d.geography.ISO2; //CFI
		//global.data.geo.name = "India";
		//global.data.geo.code = "IN";
		global.data.geo.geography = d.geography.GEO;
		global.data.geo.region = d.geography.Region;
		global.data.geo.subregion = d.geography.SubRegion;
		global.data.user.hpp = d.user.HPPId;
		global.data.user.locale = d.user.Locale;
		global.data.user.language = d.user.PreferredLanguage;
		global.data.user.planguage = d.user.PreferredLanguage;
		hpe.api.dataset({
		  form: "989",
		  dataset: "SOR_BRT_SIM_Extended",
		  payload: {
			filter: {
			  logic: "and",
			  filters: [{
				logic: "or",
				filters: [{
				  field: 'parent_entity',
				  operator: 'eq',
				  value: d.business.GroupId
				},
						  {
							field: 'party_id',
							operator: 'eq',
							value: d.company.PartyId
						  }
						 ]
			  },
						{
						  field: 'relationship',
						  operator: 'eq',
						  value: d.relationship.BRType
						},
						{
						  field: 'status',
						  operator: 'eq',
						  value: 'ACTIVE'
						}
					   ]
			},
			pageSize: 1000
		  }
		}, function(dataset) {
		  global.data.sim = [...new Set(dataset.Data.map(item => item.SIM_ISO2))];
		});
		let brtCode = global.data.brts.filter(function(item) {
		  return (item.name.toLowerCase() == global.data.brt.name.toLowerCase())
		});
		global.data.brt.code = brtCode[0].code;
		global.ready = true;
	  }
	});
  }
</script>

<!-- Load reference data based on SSO data standard object
<script src="https://hpe-rfb.it.hpe.com/resources/rs/custom/nor/reference-data.js">-->
<script>
  const reference = {
	xref: '',
	countriesInLA: [],
	countriesArray: [],
	countriesData: [],
	agreements: [],
	currencies: [],
	sim: [],
	countriesRequest: function() {
	  hpe.api.dataset({
		form: '989',
		dataset: 'NOR_COUNTRIES',
		payload: {
		  pageSize: '1000'
		}
	  }, function(d) {
		if (typeof(d) === 'object' && d.Success) {
		  reference.countriesData = d.Data;
		  for (let i = 0; i < reference.countriesData.length; i++) {
			if (reference.countriesData[i].Name == global.data.geo.name) {
			  global.data.geo.geography = reference.countriesData[i].GEO;
			  global.data.geo.region = reference.countriesData[i].Region;
			  global.data.geo.subregion = reference.countriesData[i].SubRegion;
			}
		  }
		  let LAcountriesRAW = reference.countriesData.filter(function(item) {
			return (item.GEO == "Latin America" || item.GEO == "North America")
		  });
		  reference.currencies = reference.countriesData.filter(function(item) {
			return (item.ISO2 == global.data.geo.code)
		  });
		  if (reference.currencies.length == 1 && reference.currencies[0].Country_Currencies)
			reference.currencies = reference.currencies[0].Country_Currencies.split(',');
		  else reference.currencies = ['USD']

		  reference.countriesInLA = LAcountriesRAW.map(function(item) {
			return item.Name
		  });
		  reference.countriesArray = reference.countriesData.map(function(item) {
			return item.Name
		  }).sort();
		}
	  })
	}
  }
</script>

<!-- Load and read agreements from ICM data
<script src="https://hpe-rfb.it.hpe.com/resources/rs/custom/nor/icm-agreements.js"> -->
<script>
  const request = {
	// ICM Agreement data
	agreements: function(profile, callback) {
	  let cacheLog = [];
	  cacheLog.push('ICM Cache: Attempting to fetch cached ICM data');
	  crud.read('4688', 'pid=' + profile.company.party + '&brt=' + profile.brt.code, function(d) {
		let cachedICM = false;
		let sourceICM = false;

		if (typeof(d) !== 'object')
		  cacheLog.push('ICM Cache: Failed fetching cached ICM data');
		else if (d.Rows.length == 0)
		  cacheLog.push('ICM Cache: No cached ICM data available');
		else {
		  cachedICM = d.Rows[0];
		  let threshold = 30 * 24 * 60 * 60 * 1000;
		  let delta = new Date().getTime() - new Date(cachedICM.Modified).getTime();
		  if (delta > threshold)
			cacheLog.push('ICM Cache: Expired cached ICM response found');
		  else {
			cacheLog.push('ICM Cache: Cached ICM response found');
			console.log(cacheLog);
			return callback(JSON.parse(cachedICM.JSON));
		  }
		}

		// attempt to fetch directly from EMDM
		cacheLog.push('ICM Cache: Attempting to fetch ICM data directly');

		// payload
		let payload = {
		  "partyId": profile.company.party,
		  "config": {
			"type": profile.brt.channel,
			"brt": [profile.brt.code],
			"status": {
			  "draft": false,
			  "pending": false,
			  "inactive": false,
			  "active": true,
			  "cancelled": false
			},
			"columns": [
			  "ICMParticipatingParties",
			  "ICMParticipatingCEs",
			  "ICMParticipatingGEs",
			  "ICMCountry",
			  "ICMPartyID",
			  "ICMS4Status",
			  "ICMPANumber",
			  "ICMBusinessRelationshipCode",
			  "ICMBusinessRelationshipDescription",
			  "status"
			],
			"coe": false,
			"amendment": false,
			"participating": true
		  },
		  "debug": true,
		  "page": 1,
		  "pageSize": 100
		};
		// add CE
		if (profile.company.country)
		  payload.countryEntity = profile.company.country;

		// add GE
		if (profile.company.global)
		  payload.globalEntity = profile.company.global;

		// request ICM
		var xhr = new XMLHttpRequest();
		xhr.addEventListener("readystatechange", function() {
		  if (this.readyState === 4) {
			try {
			  let icm = JSON.parse(this.responseText);
			  if (
				typeof(icm) === 'object' &&
				icm.Code && icm.Code == 'XAAS-00' &&
				icm.Response && icm.Response.data
			  ) {
				// Filtering out the inactive agreements
				icm.Response.data = icm.Response.data.filter(agr => agr.logical == 'Active');

				cacheLog.push('ICM Cache: Valid ICM data fetched successfully, attempting to create cached response');
				if (cachedICM) {
				  crud.update('4688', cachedICM.EntryId, {
					PartyId: profile.company.party,
					CountryEntity: profile.company.country,
					GlobalEntity: profile.company.global,
					BRT: profile.brt.code,
					//Channel: profile.brt.channel,
					Channel: JSON.stringify(profile.brt.channel),
					JSON: JSON.stringify(icm.Response.data)
				  }, function(d) {
					if (d.EntryId) cacheLog.push('ICM Cache: Cached ICM response updated successfully');
					else cacheLog.push('Cache: Failed to update ICM cache');
				  });
				} else {
				  crud.create('4689', {
					PartyId: profile.company.party,
					CountryEntity: profile.company.country,
					GlobalEntity: profile.company.global,
					BRT: profile.brt.code,
					//Channel: profile.brt.channel,
					Channel: JSON.stringify(profile.brt.channel),
					JSON: JSON.stringify(icm.Response.data)
				  }, function(d) {
					if (d.EntryId) cacheLog.push('ICM Cache: Cached ICM response created successfully');
					else cacheLog.push('ICM Cache: Failed to create ICM cache');
				  });
				}
				sourceICM = icm.Response.data;
			  }
			} catch (e) {
			  console.error(e);
			  cacheLog.push('ICM Cache: Critical failure parsing ICM response for cache management');
			}

			console.log(cacheLog);
			// absolute failed case
			if (!sourceICM && !cachedICM)
			  return callback(false);
			// success or partial success
			else if (sourceICM)
			  return callback(sourceICM);
			return callback(JSON.parse(cachedICM.JSON));
		  }
		});
		xhr.open("POST", "https://hpe-rfb.it.hpe.com/resources/rs/custom/php/xaas/search.php");
		xhr.setRequestHeader("Content-Type", "application/json");
		xhr.send(JSON.stringify(payload));
	  });
	},
	partyAgreements: function(profile, callback) {
	  // payload
	  let payload = {
		"partyId": profile.company.party,
		"config": {
		  "type": (profile.partyData && profile.partyData.channels) || profile.brt.channel,
		  "brt": (profile.partyData && profile.partyData.codes) || [profile.brt.code],
		  "status": {
			"draft": false,
			"pending": false,
			"inactive": false,
			"active": true,
			"cancelled": false
		  },
		  "columns": [
			"ICMParticipatingParties",
			"ICMParticipatingCEs",
			"ICMParticipatingGEs",
			"ICMCountry",
			"ICMPartyID",
			"ICMS4Status",
			"ICMPANumber",
			"ICMBusinessRelationshipCode",
			"ICMBusinessRelationshipDescription",
			"status"
		  ],
		  "coe": false,
		  "amendment": false,
		  "participating": true
		},
		"debug": true,
		"page": 1,
		"pageSize": 100
	  };
	  let sourceICM;
	  // add CE
	  if (profile.company.country)
		payload.countryEntity = profile.company.country;

	  // add GE
	  if (profile.company.global)
		payload.globalEntity = profile.company.global;

	  // request ICM
	  var xhr = new XMLHttpRequest();
	  xhr.addEventListener("readystatechange", function() {
		if (this.readyState === 4) {
		  try {
			let icm = JSON.parse(this.responseText);
			if (
			  typeof(icm) === 'object' &&
			  icm.Code && icm.Code == 'XAAS-00' &&
			  icm.Response && icm.Response.data
			) {
			  // Filtering out the inactive agreements
			  icm.Response.data = icm.Response.data.filter(agr => agr.logical == 'Active');
			  sourceICM = icm.Response.data;
			}
		  } catch (e) {
			console.error(e);
			callback(false);
		  }
		  if (!sourceICM)
			return callback(false);
		  // success or partial success
		  else
			return callback(sourceICM);
		}
	  });
	  xhr.open("POST", "https://hpe-rfb.it.hpe.com/resources/rs/custom/php/xaas/search.php");
	  xhr.setRequestHeader("Content-Type", "application/json");
	  xhr.send(JSON.stringify(payload));
	},
	// CENTRAL TIMESTAMP
	timestamp: function(callback) {
	  var response = null;
	  var xhr = new XMLHttpRequest();
	  xhr.timeout = 2000;
	  xhr.addEventListener("readystatechange", function() {
		if (this.readyState === 4) {
		  if (new Date(this.responseText) == 'Invalid Date')
			return callback(new Date().toISOString().split('.')[0]);
		  return callback(this.responseText);
		}
	  });
	  xhr.open("GET", "https://hpe-rfb.it.hpe.com/resources/rs/custom/onb/timestamp.php");
	  xhr.send(response);
	}
  }
</script>

<!-- NBSF Config
<script src="https://hpe-rfb.it.hpe.com/resources/rs/custom/nor/config.js"> -->
<script>
  // INTERNALS
  const pageFirst = {
	title: "Form001",
	subtitle: "Form00200",
	description: "Form003",
	internal: true,
	nav: true,
	selectone: "SelectOne",
	continue: "Continue",
	submit: "Submit",
	back: "Back",
	no: "No",
	poformat: "POFormat",
	savedraft: "Form208",
	showOnReview: false,
	structure: [{
	  header: "FormCFI01",
	  description: "FormCFI02",
	  group: [
		[{
		  label: "Form533",
		  data: "OnBehalf_Type",
		  required: true,
		  type: "select",
		  options: ["Form533_Option1", "Form533_Option2"],
		  values: ["User", "Company"]
		}]
	  ]
	}, {
	  group: [
		[{
		  label: "Form086",
		  data: "OnBehalf_PartyId",
		  required: true,
		  type: "text",
		  validation: ["kpDefault", "minLen|2", "maxLen|10", "noBlanksv2"],
		  typing: "kpDefault"
		}],
	  ]
	},
				{
				  group: [
					[{
					  label: "Email",
					  data: "OnBehalf_CreatedBy",
					  required: true,
					  type: "text",
					  tooltip: true,
					  minLen: 6,
					  maxLen: 256,
					  minVal: 6,
					  maxVal: 23,
					  decimals: 4,
					  placeholder: "",
					  validation: ["isEmail", "minLen|6", "maxLen|256", "noBlanksv2"],
					  typing: "kpDefault"
					}],
				  ]
				}
			   ],
	callback: function() {
	  callbacks.pageFirst();
	},
	validation: function() {
	  var result = {
		fail: [],
		pass: []
	  };
	  return result;
	}
  };
  let languages = [];
  const page0 = {
	title: "Form001",
	subtitle: "Form00200",
	description: "Form003",
	selectone: "SelectOne",
	continue: "Continue",
	submit: "Submit",
	back: "Back",
	no: "No",
	poformat: "POFormat",
	savedraft: "Form208",
	internal: true,
	nav: true,
	showOnReview: false,
	structure: [
	  {
	  header: "FormCFI01",
	  description: "FormCFI02",
	  group: [
		  [
			{
		  label: "Email",
		  data: "OnBehalf_CreatedBy",
		  required: true,
		  type: "text",
		  tooltip: true,
		  disabled: true,
		  minLen: 6,
		  maxLen: 256,
		  minVal: 6,
		  maxVal: 23,
		  decimals: 4,
		  placeholder: "",
		  validation: ["isEmail", "minLen|6", "maxLen|256", "noBlanksv2"],
		  typing: "kpDefault"
		},
		 {
		   label: "FirstName",
		   data: "FirstName",
		   required: false,
		   disabled: true,
		   type: "text",
		   placeholder: ""
		 },
		 {
		   label: "LastName",
		   data: "LastName",
		   required: true,
		   disabled: true,
		   type: "text",
		   placeholder: ""
		 },
		 {
		   label: "FormCFI05",
		   data: "Language",
		   required: false,
		   disabled: true,
		   type: "select",
		   placeholder: "",
		   options: [],
		   values: []
		 }
		]
	  ]
	},
				{
		filter: {
		  field: "OnBehalf_Type",
		  operator: "eq",
		  value: "Company"
		},
				  header: "FormCFI03",
				  description: "FormCFI04",
				  group: [
		  [
			{
			  label: "Country Entity",
			  data: "CountryEntity",
			  required: false,
			  disabled: true,
			  type: "text",
			  placeholder: "",
			  validation: ["partnerIds", "minLen|1", "maxLen|50"],
			  typing: "partnerIds"
			},
			{
			  label: "PartyId",
			  data: "PartyId",
			  required: false,
			  disabled: true,
			  type: "text",
			  placeholder: "",
			  validation: ["partnerIds", "minLen|1", "maxLen|50"],
			  typing: "partnerIds"
			},
			{
			  label: "Business Relationship Type",
			  data: "PartnerBRT",
			  required: false,
			  disabled: false,
			  type: "select",
			  values: function() {
				return global.data.partyData.brts || [];
			  }
			},
			{
			  label: "Partner name",
			  data: "PartnerName",
			  required: false,
			  disabled: true,
			  type: "text",
			  placeholder: ""
			},
			{
			  label: "Country",
			  data: "Country",
			  required: false,
			  disabled: true,
			  type: "text",
			  placeholder: ""
			},
			{
			  label: "Region",
			  data: "Region",
			  required: false,
			  disabled: true,
			  type: "text",
			  placeholder: ""
			},
			{
			  label: "GEO",
			  data: "Geo",
			  required: false,
			  disabled: true,
			  type: "text",
			  placeholder: ""
			}
		  ]
		]
	  },
	  {
		filter: {
		  field: "OnBehalf_Type",
		  operator: "neq",
		  value: "Company"
		},
		header: "FormCFI03",
		description: "FormCFI04",
		group: [
		  [
			{
					  label: "Country Entity",
					  data: "CountryEntity",
					  required: false,
					  disabled: true,
					  type: "text",
					  placeholder: "",
					  validation: ["partnerIds", "minLen|1", "maxLen|50"],
					  typing: "partnerIds"
					},
					 {
					   label: "PartyId",
					   data: "PartyId",
					   required: false,
					   disabled: true,
					   type: "text",
					   placeholder: "",
					   validation: ["partnerIds", "minLen|1", "maxLen|50"],
					   typing: "partnerIds"
					 },
					 {
					   label: "Business Relationship Type",
					   data: "PartnerBRT",
					   required: false,
					   disabled: true,
					   type: "text",
					   placeholder: ""
					 },
					 {
					   label: "Partner name",
					   data: "PartnerName",
					   required: false,
					   disabled: true,
					   type: "text",
					   placeholder: ""
					 },
					 {
					   label: "Country",
					   data: "Country",
					   required: false,
					   disabled: true,
					   type: "text",
					   placeholder: ""
					 },
					 {
					   label: "Region",
					   data: "Region",
					   required: false,
					   disabled: true,
					   type: "text",
					   placeholder: ""
					 },
					 {
					   label: "GEO",
					   data: "Geo",
					   required: false,
					   disabled: true,
					   type: "text",
					   placeholder: ""
					 }
					]
				  ]
				}
			   ],
	callback: function() {
	  callbacks.page0();
	},
	validation: function() {
	  var result = {
		fail: [],
		pass: []
	  };
	  return result;
	}
  };

  // SSO, PO, QOD, PA, PT
  const page1 = {
	title: "Form001",
	subtitle: "Form002",
	description: "Form003",
	selectone: "SelectOne",
	continue: "Continue",
	submit: "Submit",
	back: "Back",
	no: "No",
	poformat: "POFormat",
	savedraft: "Form208",
	ready: false,
	goExternal: true,
	isValidQuote: true,
	nav: true,
	showOnReview: false,
	structure: [
	  // HIDDEN INPUTS
	  {
		hidden: true,
		group: [
		  [{
			data: "Email",
			type: "hidden"
		  },
		   {
			 data: "xrefFail",
			 type: "hidden",
			 value: "No"
		   },
		   {
			 data: "FirstName",
			 type: "hidden"
		   },
		   {
			 data: "LastName",
			 type: "hidden"
		   },
		   {
			 data: "HPPUserId",
			 type: "hidden"
		   },
		   {
			 data: "PreferredLanguageCode",
			 type: "hidden"
		   },
		   {
			 data: "Language",
			 type: "hidden"
		   },
		   {
			 data: "PartyId",
			 type: "hidden"
		   },
		   {
			 data: "CountryEntity",
			 type: "hidden"
		   },
		   {
			 data: "GlobalEntity",
			 type: "hidden"
		   },
		   {
			 data: "PartnerBRT",
			 type: "hidden"
		   },
		   {
			 data: "Region",
			 type: "hidden"
		   },
		   {
			 data: "SubRegion",
			 type: "hidden"
		   },
		   {
			 data: "Geo",
			 type: "hidden"
		   },
		   // SFDC
		   {
			 data: "CaseReason",
			 type: "hidden",
			 value: "Manual Order Submission"
		   },
		   {
			 data: "CaseScenario",
			 type: "hidden",
			 value: "Order Receipt"
		   },
		   {
			 data: "InternalScenario",
			 type: "hidden",
			 value: "Order Cleansing/Acceptance"
		   },
		   {
			 data: "AssignToTeam",
			 type: "hidden"
		   },
		   {
			 data: "CaseTitle_aaS",
			 type: "hidden"
		   }
		  ]
		]
	  },

	  // QOD filter
	  {
		filter: {
		  field: "Geo",
		  operator: "eq",
		  value: "North America"
		},
		header: "Form075",
		group: [
		  [{
			/*       label: "Form530",
                               data: "Config_aaS",
                               filtered: "true",
                               required: true,
                               type: "toggle",
                               values: ["N", "Y"],
                               options: ["No", "Yes"]
                           }, {*/
			label: "Form230",
			data: "Config_Quote",
			required: true,
			type: "toggle",
			value: "Y",
			values: ["N", "Y"],
			options: ["No", "Yes"]
		  }]
		]
	  },
	  {
		filter: {
		  field: "Geo",
		  operator: "neq",
		  value: "North America"
		},
		header: "Form075",
		group: [
		  [{
			label: "Form230",
			data: "Config_Quote",
			required: true,
			type: "toggle",
			value: "Y",
			values: ["N", "Y"],
			options: ["No", "Yes"]
		  }]
		]
	  },
	  // QOD filter - Requestor_PO_Quote_ID
	  {
		filter: {
		  field: "Config_Quote",
		  operator: "eq",
		  value: "Y"
		},
		header: "",
		group: [
		  [{
			label: "Form019",
			data: "Requestor_PO_Quote_ID",
			required: true,
			type: "text",
			filtered: "true",
			placeholder: "Form020",
			validation: ["kpDefault", "minLen|13", "maxLen|13", "noBlanksv2"],
			typing: "kpDefault"
		  }]
		]
	  },
	  {
		filter: {
		  logic: "and",
		  filters: [
			{
			  field: "Region",
			  operator: "neq",
			  value: "AMS"
			},
			/*		{
					  field: "PartnerBRT",
					  operator: "neq",
					  value: "Master Area Partner"
					},
					{
					  field: "CountryCode",
					  operator: "neq",
					  value: "TR"
					}*/
		  ]
		},
		header: "",
		group: [
		  [{
			label: "Form021",
			data: "Requestor_PO_Deal_ID",
			required: false,
			type: "text",
			placeholder: "Form022",
			validation: ["isIntegerAndComma", "minLen|8", "noBlanksv2"],
			typing: "isIntegerAndComma"
		  }]
		]
	  },

	  //  END CUSTOMER COUNTRY - QUOTE
	  {
		header: "FormCFI016",
		filter: {
		  field: "hideQECC",
		  operator: "neq",
		  value: 'Y'
		},
		group: [
		  [{
			label: "FormCFI017",
			data: "QECC_Country",
			required: false,
			disabled: true,
			type: "text",
			validation: ["kpDefault"],
			typing: "kpDefault"
		  }]
		]
	  },
	  // SELL INTO MARKET
	  {
		header: "FormCFI016",
		filter: {
		  field: "hideSIM",
		  operator: "neq",
		  value: 'Y'
		},
		group: [
		  [{
			label: "FormCFI017",
			data: "SIM_Country",
			required: true,
			type: "select",
			values: function() {
			  var simz = [];
			  var allowedCty = global.data.sim;
			  var uniqueAllowedCty = [...new Set(allowedCty)];
			  uniqueAllowedCty.forEach(function(sim) {
				let simOne = reference.countriesData.filter(function(item) {
				  return (item.ISO2 == sim)
				})
				if (simOne[0])
				  simz.push(simOne[0]);
			  });
			  let finalC = simz.map(function(item) {
				return item.Name
			  });
			  return finalC;
			}
		  }]
		]
	  },
	  // PO INFORMATION
	  {
		header: "Form004",
		group: [
		  [
			// CONFIRMED VALIDATION
			{
			  label: "Form462",
			  data: "PO_BackgroundGroup",
			  required: true,
			  type: "select",
			  options: ["Form463", "Form464", "Form509", "Form510"],
			  values: ["Edge", "Hybrid IT", "Pointnext", "Hybrid IT"],
			  validation: ["inArray"],
			  change: ["inArray"]
			}
		  ]
		]
	  },
	  {
		filter: {
		  field: "CountryCode",
		  operator: "in",
		  value: ["CZ", "PL", "HU", "TR", "RO", "KZ"]
		},
		header: "",
		group: [
		  [{
			label: "Form514",
			data: "PO_HPEEntity",
			required: true,
			filtered: "true",
			type: "select",
			options: ["Form515", "Form516"],
			values: ["HPE BV (NL60)", "HPE Local"],
			validation: ["inArray"],
			change: ["inArray"]
		  }]
		]
	  },
	  {
		filter: {
		  field: "Region",
		  operator: "eq",
		  value: "AMS"
		},
		header: "",
		group: [
		  [{
			label: "Form465",
			data: "PO_BusinessModel",
			required: true,
			filtered: "true",
			type: "select",
			options: ["Form466", "Form467", "Form468", "Form469", "Form470", "Form471"],
			values: ["Trade", "Agent Model", "HPFS", "HPFS & Agent Model", "3rd Party Leasing", "Non Stop"],
			validation: ["inArray"],
			change: ["inArray"]
		  }]
		]
	  },
	  {
		header: "",
		group: [
		  [{
			label: "Form005",
			data: "PO_Number",
			required: true,
			type: "text",
			placeholder: "Form006",
			validation: ["ascii", "minLen|1", "maxLen|30"],
			typing: "ascii"
		  }]
		]
	  },
	  {
		filter: {
		  logic: "and",
		  filters: [{
			field: "CountryCode",
			operator: "eq",
			value: "IN"
		  },
					{
					  logic: "or",
					  filters: [{
						field: "Region",
						operator: "neq",
						value: "AMS"
					  },
								{
								  field: "PO_BusinessModel",
								  operator: "eq",
								  value: "Trade"
								},
							   ]
					},
				   ]
		},
		header: "",
		group: [
		  [
			// CONFIRMED VALIDATION
			{
			  label: "Form010",
			  data: "PO_Category",
			  required: true,
			  type: "select",
			  options: ["Form012", "Form013"],
			  values: ["Stock", "Stage"],
			  validation: ["inArray"],
			  change: ["inArray"]
			}
		  ]
		]
	  },
	  {
		filter: {
		  logic: "and",
		  filters: [{
			field: "CountryCode",
			operator: "eq",
			value: "IN"
		  },
					{
					  field: "Region",
					  operator: "eq",
					  value: "AMS"
					},
					{
					  field: "PO_BusinessModel",
					  operator: "neq",
					  value: "Trade"
					},
				   ]
		},
		header: "",
		group: [
		  [
			// CONFIRMED VALIDATION
			{
			  label: "Form010",
			  data: "PO_Category",
			  required: true,
			  type: "select",
			  options: ["Form013"],
			  values: ["Stage"],
			  validation: ["inArray"],
			  change: ["inArray"]
			}
		  ]
		]
	  },
	  {
		filter: {
		  logic: "and",
		  filters: [{
			field: "CountryCode",
			operator: "neq",
			value: "IN"
		  },
					{
					  field: "Region",
					  operator: "eq",
					  value: "AMS"
					},
					{
					  field: "PO_BusinessModel",
					  operator: "neq",
					  value: "Trade"
					},
				   ]
		},
		header: "",
		group: [
		  [
			// CONFIRMED VALIDATION
			{
			  label: "Form010",
			  data: "PO_Category",
			  required: true,
			  type: "select",
			  options: ["Form011", "Form013"],
			  values: ["Drop", "Stage"],
			  validation: ["inArray"],
			  change: ["inArray"]
			}
		  ]
		]
	  },
	  {
		filter: {
		  logic: "and",
		  filters: [{
			field: "CountryCode",
			operator: "neq",
			value: "IN"
		  },
					{
					  logic: "or",
					  filters: [{
						field: "Region",
						operator: "neq",
						value: "AMS"
					  },
								{
								  field: "PO_BusinessModel",
								  operator: "eq",
								  value: "Trade"
								},
							   ]
					},
				   ]
		},
		header: "",
		group: [
		  [
			// CONFIRMED VALIDATION
			{
			  label: "Form010",
			  data: "PO_Category",
			  required: true,
			  type: "select",
			  options: ["Form011", "Form012", "Form013"],
			  values: ["Drop", "Stock", "Stage"],
			  validation: ["inArray"],
			  change: ["inArray"]
			}
		  ]
		]
	  },
	  {
		filter: {
		  logic: "or",
		  filters: [{
			field: "CountryCode",
			operator: "in",
			value: global.nonPoModelCountries
		  },
					{
					  logic: "and",
					  filters: [{
						field: "Region",
						operator: "neq",
						value: "APJ"
					  },
								{
								  field: "SubRegion",
								  operator: "neq",
								  value: "UKI"
								},
								{
								  field: "Geo",
								  operator: "nin",
								  value: ["DACH", "Europe South", "North West Europe"]
								}
							   ]
					}
				   ]
		},
		header: "",
		group: [
		  [
			// CONFIRMED VALIDATION
			{
			  label: "Form008",
			  data: "PO_Value",
			  required: true,
			  type: "text",
			  placeholder: "Form009",
			  validation: ["povalue", "minLen|1", "maxLen|15", "noBlanksv2"],
			  typing: "povaluetyping"
			},
		  ]
		]
	  },
	  // Tax Amount & Purchase order amount (With Tax) with quote
	  {
		filter: {
		  logic: "and",
		  filters: [
			{
			  logic: "and",
			  filters: [
				{
				  field: "Config_Quote",
				  operator: "eq",
				  value: "Y"
				},
				/*{
				  field: "Requestor_PO_Quote_ID",
				  operator: "isnotempty",
				  value: "1",
				}*/
			  ]
			},
			{
			  field: "CountryCode",
			  operator: "eq",
			  value: "BR"
			},
		  ]
		},
		header: "",
		group: [
		  [{
			label: "Form535",
			data: "TaxAmount",
			required: true,
			disabled: true,
			type: "text",
			placeholder: "Tax Amount",
			validation: ["povalue", "minLen|1", "maxLen|15", "noBlanksv2"],
			typing: "povaluetyping"
		  },
		   {
			 label: "Form536",
			 data: "PO_Value_Tax",
			 required: true,
			 type: "text",
			 placeholder: "Purchase order amount (With Tax)",
			 validation: ["povalue", "minLen|1", "maxLen|15", "noBlanksv2"],
			 typing: "povaluetyping"
		   },
		  ]
		]
	  },
	  // Tax Amount & Purchase order amount (With Tax) without quote
	  {
		filter: {
		  logic: "and",
		  filters: [
			{
			  logic: "and",
			  filters: [
				{
				  field: "Config_Quote",
				  operator: "neq",
				  value: "Y"
				}
			  ]
			},
			{
			  field: "CountryCode",
			  operator: "eq",
			  value: "BR"
			},
		  ]
		},
		header: "",
		group: [
		  [{
			label: "Form535",
			data: "TaxAmount",
			required: true,
			disabled: false,
			type: "text",
			placeholder: "Tax Amount",
			validation: ["povalue", "minLen|1", "maxLen|15", "noBlanksv2"],
			typing: "povaluetyping"
		  },
		   {
			 label: "Form536",
			 data: "PO_Value_Tax",
			 required: true,
			 disabled: true,
			 type: "text",
			 placeholder: "Purchase order amount (With Tax)",
			 validation: ["povalue", "minLen|1", "maxLen|15", "noBlanksv2"],
			 typing: "povaluetyping"
		   },
		  ]
		]
	  },
	  // Currency
	  {
		filter: {
		  logic: "or",
		  filters: [{
			field: "CountryCode",
			operator: "in",
			value: global.nonPoModelCountries
		  },
					{
					  logic: "and",
					  filters: [{
						field: "Region",
						operator: "neq",
						value: "APJ"
					  },
								{
								  field: "SubRegion",
								  operator: "neq",
								  value: "UKI"
								},
								{
								  field: "Geo",
								  operator: "nin",
								  value: ["DACH", "Europe South", "North West Europe"]
								}
							   ]
					}
				   ]
		},
		header: "",
		group: [
		  [
			// PENDING CURRENCY TO COUNTRY MAPPING
			{
			  label: "Form007",
			  data: "PO_Currency",
			  required: true,
			  filtered: "true",
			  type: "select",
			  values: function() {
				return reference.currencies
			  },
			  validation: ["inArray"],
			  change: ["inArray"]
			}
		  ]
		]
	  },

	  {
		filter: {
		  logic: "and",
		  filters: [{
			field: "BRT",
			operator: "neq",
			value: "T1 Solution Provider"
		  },
					{
					  field: "PO_Category",
					  operator: "in",
					  value: ["Stage", "Drop"]
					}
				   ]
		},
		header: "",
		group: [
		  [
			// CONFIRMED VALIDATION
			{
			  label: "Form014",
			  data: "Rs_PO_Number",
			  required: false,
			  filtered: "true",
			  type: "text",
			  placeholder: "Form015",
			  validation: ["ascii", "minLen|1", "maxLen|70"],
			  typing: "ascii"
			}
		  ]
		]
	  },
	  {
		filter: {
		  logic: "or",
		  filters: [{
			field: "PO_Category",
			operator: "eq",
			value: "Drop"
		  },
					{
					  field: "PO_Category",
					  operator: "eq",
					  value: "Stage"
					}
				   ]
		},
		header: "",
		group: [
		  [
			// CONFIRMED VALIDATION
			{
			  label: "Form016",
			  data: "Cx_PO_Number",
			  required: false,
			  type: "text",
			  placeholder: "Form017",
			  validation: ["ascii", "minLen|1", "maxLen|70"],
			  typing: "ascii"
			}
		  ]
		]
	  },
	  // PA & PT
	  {
		filter: {
		  field: "aggrVal",
		  operator: "eq",
		  value: "0"
		},
		header: "Form023",
		group: [
		  [{
			label: "Form024",
			data: "PA_Number",
			required: true,
			type: "text",
			filtered: "true",
			placeholder: "Form025",
			validation: ["alphanumeric", "minLen|5", "maxLen|5", "noBlanksv2"],
			typing: "alphanumeric"
		  },
		   {
			 label: "Form026",
			 data: "Payment_Terms",
			 required: true,
			 type: "text",
			 placeholder: "Form478",
			 validation: ["ascii", "minLen|1", "maxLen|60"],
			 typing: "ascii"
		   }
		  ]
		]
	  },
	  {
		filter: {
		  logic: "and",
		  filters: [{
			field: "aggrVal",
			operator: "eq",
			value: "1"
		  },
					{
					  logic: "or",
					  filters: [{
						field: "Region",
						operator: "eq",
						value: "AMS"
					  },
								{
								  field: "Geo",
								  operator: "eq",
								  value: "Central Europe"
								},
								{
								  field: "SubRegion",
								  operator: "eq",
								  value: "MESA"
								},
								{
								  field: "Geo",
								  operator: "eq",
								  value: "CERTA"
								}
							   ]
					}
				   ]
		},
		header: "Form023",
		group: [
		  [{
			label: "Form024",
			data: "PA_Number",
			filtered: "true",
			required: true,
			type: "select",
			values: function() {
			  return global.data.brt.pas;
			}
		  }]
		]
	  },
	  {
		filter: {
		  logic: "and",
		  filters: [{
			field: "aggrVal",
			operator: "eq",
			value: "1"
		  },
					{
					  logic: "or",
					  filters: [{
						field: "Region",
						operator: "eq",
						value: "AMS"
					  },
								{
								  field: "Geo",
								  operator: "eq",
								  value: "Central Europe"
								},
								{
								  field: "SubRegion",
								  operator: "eq",
								  value: "MESA"
								},
								{
								  field: "Geo",
								  operator: "eq",
								  value: "CERTA"
								},
								{
								  field: "CountryCode",
								  operator: "in",
								  value: global.nonPoModelCountries
								},
							   ]
					}
				   ]
		},
		header: "",
		group: [
		  [{
			data: "Payment_TermsPlaceholder",
			type: "hidden"
		  },
		   {
			 label: "Form026",
			 data: "Payment_Terms",
			 required: true,
			 type: "text",
			 placeholder: "Form478",
			 validation: ["ascii", "minLen|1", "maxLen|60"],
			 typing: "ascii"
		   }
		  ]
		]
	  },
	  {
		filter: {
		  logic: "and",
		  filters: [{
			field: "Region",
			operator: "neq",
			value: "AMS"
		  },
					{
					  field: "aggrVal",
					  operator: "eq",
					  value: "1"
					},
					{
					  field: "Geo",
					  operator: "nin",
					  value: ["CERTA"]
					},
					{
					  field: "SubRegion",
					  operator: "nin",
					  value: ["Central Europe", "MESA"]
					}
				   ]
		},
		header: "",
		group: [
		  [{
			data: "PA_NumberPlaceholder",
			type: "hidden"
		  },
		   {
			 label: "Form024",
			 data: "PA_Number",
			 filtered: "true",
			 required: true,
			 type: "select",
			 values: function() {
			   return global.data.brt.pas
			 }
		   }
		  ]
		]
	  },

	  // QOD with filter no ams / UCID-CONFIG NO
	  {
		filter: {
		  logic: "and",
		  filters: [
			{
			  field: "Region",
			  operator: "neq",
			  value: "AMS"
			},
			{
			  field: "CountryCode",
			  operator: "neq",
			  value: "JP"
			}
		  ]
		},
		header: "", //"Form258",
		group: [
		  [{
			label: "Form262",
			data: "Config_PartialOrder",
			required: false,
			type: "toggle",
			value: "N",
			values: ["N", "Y"],
			options: ["No", "Yes"]
		  }]
		]
	  },
	  {
		filter: {
		  logic: "and",
		  filters: [
			{
			  field: "Region",
			  operator: "neq",
			  value: "AMS"
			},
			/*		{
					  field: "PartnerBRT",
					  operator: "neq",
					  value: "Master Area Partner"
					},
					{
					  field: "CountryCode",
					  operator: "neq",
					  value: "TR"
					},*/
			{
			  field: "Config_PartialOrder",
			  operator: "eq",
			  value: "Y"
			},
			{field: "Config_PartialOrder", operator: "eq", value: "N"}, // Dummy condition to completely hide this group. NOR-785
			{
			  field: "Config_Quote",
			  operator: "neq",
			  value: "Y"
			}
		  ]
		},
		header: "",
		group: [
		  [{
			label: "Form456",
			data: "Config_UCID",
			required: false,
			type: "text",
			placeholder: "Form457",
			validation: ["IsUCID", "minLen|1", "noBlanksv2"],
			typing: "IsUCID"
		  },
		   {
			 label: "Form458",
			 data: "Config_UCIDQ",
			 required: false,
			 type: "text",
			 placeholder: "Form459",
			 validation: ["IsUCIDQ", "minLen|1", "noBlanksv2"],
			 typing: "IsUCIDQ"
		   },
		   {
			 label: "Form460",
			 data: "Config_ConfigId",
			 required: false,
			 type: "text",
			 placeholder: "Form461",
			 validation: ["isIntegerAndComma", "minLen|1", "noBlanksv2"],
			 typing: "isIntegerAndComma"
		   },
		  ]
		]
	  },
	/*  {
		filter: {
		  logic: "and",
		  filters: [{
			field: "Region",
			operator: "neq",
			value: "AMS"
		  },
					{
					  field: "PartnerBRT",
					  operator: "neq",
					  value: "Master Area Partner"
					},
					{
					  field: "CountryCode",
					  operator: "neq",
					  value: "TR"
					}
				   ]
		},
		header: "",
		group: [
		  [{
			label: "Form021",
			data: "Requestor_PO_Deal_ID",
			required: false,
			type: "text",
			placeholder: "Form022",
			validation: ["isIntegerAndComma", "minLen|8", "noBlanksv2"],
			typing: "isIntegerAndComma"
		  }]
		]
	  },*/

	  // QOD with filter no ams / UCID-CONFIG YES
	/*  {
		filter: {
		  logic: "and",
		  filters: [{
			field: "Region",
			operator: "neq",
			value: "AMS"
		  },
					{
					  logic: "or",
					  filters: [{
						field: "PartnerBRT",
						operator: "eq",
						value: "Master Area Partner"
					  },
								{
								  field: "CountryCode",
								  operator: "eq",
								  value: "TR"
								}
							   ]
					}
				   ]
		},
		header: "", //"Form258",
		group: [
		  [{
			label: "Form262",
			data: "Config_PartialOrder",
			required: false,
			type: "toggle",
			value: "N",
			values: ["N", "Y"],
			options: ["No", "Yes"]
		  }]
		]
	  },
	  {
		filter: {
		  logic: "and",
		  filters: [{
			field: "Region",
			operator: "neq",
			value: "AMS"
		  },
					{
					  logic: "or",
					  filters: [{
						field: "PartnerBRT",
						operator: "eq",
						value: "Master Area Partner"
					  },
								{
								  field: "CountryCode",
								  operator: "eq",
								  value: "TR"
								}
							   ]
					},
					{
					  field: "Config_PartialOrder",
					  operator: "eq",
					  value: "Y"
					}
				   ]
		},
		header: "",
		group: [
		  [{
			label: "Form456",
			data: "Config_UCID",
			required: false,
			type: "text",
			placeholder: "Form457",
			validation: ["IsUCID", "minLen|1", "noBlanksv2"],
			typing: "IsUCID"
		  },
		   {
			 label: "Form458",
			 data: "Config_UCIDQ",
			 required: false,
			 type: "text",
			 placeholder: "Form459",
			 validation: ["IsUCIDQ", "minLen|1", "noBlanksv2"],
			 typing: "IsUCIDQ"
		   },
		   {
			 label: "Form460",
			 data: "Config_ConfigId",
			 required: false,
			 type: "text",
			 placeholder: "Form461",
			 validation: ["isIntegerAndComma", "minLen|1", "noBlanksv2"],
			 typing: "isIntegerAndComma"
		   }
		  ]
		]
	  },*/
	/*  {
		filter: {
		  logic: "and",
		  filters: [{
			field: "Region",
			operator: "neq",
			value: "AMS"
		  },
					{
					  logic: "or",
					  filters: [{
						field: "PartnerBRT",
						operator: "eq",
						value: "Master Area Partner"
					  },
								{
								  field: "CountryCode",
								  operator: "eq",
								  value: "TR"
								}
							   ]
					}
				   ]
		},
		header: "",
		group: [
		  [{
			label: "Form021",
			data: "Requestor_PO_Deal_ID",
			required: false,
			type: "text",
			placeholder: "Form022",
			validation: ["isIntegerAndComma", "minLen|8", "noBlanksv2"],
			typing: "isIntegerAndComma"
		  }]
		]
	  },*/

	  // QOD with filter JAPAN / Requestor_PO_Opp_ID
	  {
		filter: {
		  logic: "and",
		  filters: [{
		    field: "CountryCode",
		    operator: "in",
		    value: ["JP", "KR"]
		  }]
		},
		header: "",
		group: [
		  [{
			label: "Form479",
			data: "Requestor_PO_Opp_ID",
			filtered: "true",
			required: false,
			type: "text",
			value: "OPE-",
			placeholder: "Form480",
			validation: ["ascii", "maxLen|14", "IsOpportunityID"],
			typing: "ascii"
		  }]
		]
	  },

	  // Delivery
	  {
		filter: {
		  field: "Region",
		  operator: "neq",
		  value: "AMS"
		},
		header: "Form472",
		group: [
		  [{
			label: "Form039",
			placeholder: "Form040",
			data: "PO_DeliveryDate",
			required: false,
			type: "date",
			placeholder: "DD/MM/YYYY",
			dtp: {
			  format: 'd/m/Y',
			  formatDate: 'd/m/Y',
			  timepicker: false,
			  scrollInput: false,
			  minDate: 0,
			  maxDate: new Date(new Date().setDate(new Date().getDate() + 90)).toLocaleDateString('en-GB'),
			  onChangeDateTime: function(dp, $input) {

			  }
			}
		  }]
		]
	  },
	  {
		filter: {
		  field: "Region",
		  operator: "eq",
		  value: "AMS"
		},
		header: "Form472",
		group: [
		  [{
			label: "Form039",
			placeholder: "Form040",
			data: "PO_DeliveryDate",
			required: false,
			type: "date",
			placeholder: "DD/MM/YYYY",
			dtp: {
			  format: 'd/m/Y',
			  formatDate: 'd/m/Y',
			  timepicker: false,
			  scrollInput: false,
			  minDate: 0,
			  maxDate: new Date(new Date().setDate(new Date().getDate() + 90)).toLocaleDateString('en-GB'),
			  onChangeDateTime: function(dp, $input) {

			  }
			}
		  },
		   {
			 label: "Form476",
			 data: "PO_DeliveryIncoterms",
			 required: true,
			 type: "select",
			 filtered: "true",
			 options: ["Form473", "Form474", "Form475"],
			 values: ["DDP", "EXW", "FCA"]
		   }

		  ]
		]
	  },
	  {
		filter: {
		  logic: "or",
		  filters: [{
			field: "Region",
			operator: "eq",
			value: "APJ"
		  },
					{
					  field: "Geo",
					  operator: "in",
					  value: ["Latin America", "North America"]
					}
				   ]
		},
		header: "",
		group: [
		  [{
			label: "Form477",
			data: "PO_CompleteDelivery",
			filtered: "true",
			required: false,
			type: "toggle",
			values: ["N", "Y"],
			options: ["No", "Yes"]
		  }]
		]
	  },
	  // Invoice Details
	  {
		filter: {
		  field: "CountryCode",
		  operator: "eq",
		  value: "JP"
		},
		header: "Form248",
		group: [
		  [{
			label: "Form249",
			data: "Invoice_Format",
			required: true,
			type: "select",
			filtered: "true",
			values: ["HPE Form - No individual instructions to CSM",
					 "HPE Form - With individual instructions to CSM (individual instruction content input required)",
					 "Monthly Invoice",
					 "Customer Form",
					 "Customer System"
					],
			options: ["Form251", "Form252", "Form253", "Form254", "Form255"]
		  }]
		]
	  },
	  {
		filter: {
		  field: "CountryCode",
		  operator: "eq",
		  value: "JP"
		},
		header: "",
		group: [
		  [{
			label: "Form250",
			data: "Invoice_SendEmail",
			required: false,
			type: "toggle",
			values: ["N", "Y"],
			options: ["No", "Yes"]
		  }]
		]
	  },
	  // Notification
	  {
		header: "Form031",
		description: 'Form032',
		group: [
		  [{
			label: "Form215",
			data: "Notification_CC",
			required: false,
			type: "text",
			placeholder: "Form033",
			validation: ["kpDefault", "maxLen|255"],
			typing: "kpDefault"
		  }]
		]
	  }
	],
	callback: function() {
	  let inputField = document.querySelector('[data-name="Requestor_PO_Quote_ID"]');

	  if (inputField) {
		inputField.addEventListener('input', function(e) {
		  let value = this.value.toUpperCase();
		  this.value = value;

		  // ensure that first two characters are 'NQ' or 'DQ' or '30'
		  if (this.value.length <= 2 && !/^(N|D|NQ|DQ|3|30|NI)?$/.test(this.value)) {
			this.value = this.value.slice(0, -1);
		  }

		  // allow only digits after 'NQ' or 'DQ' and limit them to 8 or 300000
		  if (this.value.length > 2 && this.value.length <= 10 && /^(NQ|DQ|NI)/.test(this.value) && !/^(NQ|DQ|NI)\d*$/.test(this.value)) {
			this.value = this.value.slice(0, -1);
		  }

		  // allow only 00000 after '3' - 300000XXXXX 
		  if (this.value.length > 2 && this.value.length <= 6 && /^30/.test(this.value) && !/^3[0]{2,5}$/.test(this.value)) {
			this.value = this.value.slice(0, -1);
		  }

		  // allow only digits after '300000' - 300000XXXXX 
		  if (this.value.length > 6 && this.value.length <= 11 && /^30/.test(this.value) && !/^300000\d*$/.test(this.value)) {
			this.value = this.value.slice(0, -1);
		  }

		  // 300000XXXXX 
		  if (this.value.length > 11 && /^30/.test(this.value) && !/^300000\d{5}$/.test(this.value)) {
			this.value = this.value.slice(0, -1);
		  }

		  // automatically append hyphen after 8 digits
		  if (this.value.length === 10 && /^(NQ|DQ|D2)/.test(this.value)) {
			this.value += "-";
		  }

		  // allow '01', '02', '03' after the hyphen (example - DQXXXXXXXX-XX)
		  if (this.value.length > 11 && /^(NQ|DQ|NI)/.test(this.value) && !/^([0-9]|[0-9][0-9])?$/.test(this.value.slice(11))) {
			this.value = this.value.slice(0, -1);
		  }

		  // read quote 
		  if (this.value) {
			// const quotePattern = /(^(NQ|DQ)\d{8}-([0-9][0-9]))|^(300000)\d{5}$/;
			// for testing
			const quotePattern = /(^(NQ|DQ|N2|NI)\d{8}-([0-9][0-9]))|^(300000)\d{5}$/;
			if (quotePattern.test(this.value)) {
			  mo.fn.overlay.show({
				loading: true,
				close: false,
			  });
			  quoteHelper.readQuote(this.value, function(quote) {
				mo.fn.overlay.hide();
				mo.fn.events.closeAll();
				const {
				  valid,
				  text
				} = quoteHelper.validateQuote(quote);
				page1.isValidQuote = valid;
				// call validation
				$("input[data-name=Requestor_PO_Quote_ID]").trigger("changeQuoteId", !valid);
				if (!valid) {
				  mo.fn.modal.show({
					id: 'invalidQuoteModal',
					close: false,
					ctaLabel: hpe.fn.lang('OK', config.locale, config.localizations),
					title: hpe.fn.lang(text, config.locale, config.localizations),
					content: '',
					ctaCallback: function() {
					  mo.fn.overlay.hide();
					  mo.fn.events.closeAll();
					}
				  });
				}
			  }, config);
			}
		  }
		});

		// modify backspace behavior
		inputField.addEventListener('keydown', function(e) {
		  if (e.key === "Backspace" && this.value.length === 11) {
			e.preventDefault();
			this.value = this.value.slice(0, -2);
		  }
		});
	  }
	  if (["TH", "HK", "KR", "MO"].indexOf(config.dataset.CountryCode) >= 0) {
		let sbt = config.dom.querySelector(".header .subtitle");
		if (sbt) sbt.innerHTML += "<br><br>" + hpe.fn.lang("ProvideThailandDesc", config.locale, config.localizations);
	  }
	  callbacks.page1();
	},
	validation: function() {
	  var result = {
		fail: [],
		pass: []
	  };
	  var Notification_CC = document.querySelector('input[data-name=Notification_CC]');
	  if (Notification_CC) {
		if (Notification_CC.value && (!nbsf.vld.isCarbonCC(Notification_CC.value) || !nbsf.vld.maxLen(Notification_CC.value, 255))) {
		  result.fail.push(Notification_CC.closest('label'));
		}
	  }

	  // check if quote ID respects the format
	  var quoteID = document.querySelector('input[data-name=Requestor_PO_Quote_ID]');

	  if (quoteID) {
		// const quotePattern = /(^(NQ|DQ)\d{8}-([0-9][0-9]))|^(300000)\d{5}$/;
		// for testing
		const quotePattern = /(^(NQ|DQ|NI)\d{8}-([0-9][0-9]))|^(300000)\d{5}$/;

		if (!quotePattern.test(quoteID.value) || !page1.isValidQuote) {
		  // add  the error only if the value is the right length and wrong format, for a smaller length, nbsf built in min length
		  result.fail.push(quoteID.closest('label'));
		} else {
		  result.pass.push(quoteID.closest('label'));
		}
	  }

	  return result;
	}
  };

  // QUOTE PREVIEW FOR AMS GEO - MESA / CERTA or MEA / CETA
  const pageQuotePreview = {
	title: "Form001",
	subtitle: "Form259",
	description: "Form260",
	selectone: "SelectOne",
	continue: "Continue",
	submit: "Submit",
	back: "Back",
	no: "No",
	poformat: "POFormat",
	savedraft: "Form208",
	ready: false,
	nav: true,
	review: {
		editable: true,
		layout: "spa",
		collapsible: true,
		collapsed: true,
	},
	quotePreview: true,    
	filter: {
		logic: "or",
		filters: [
			{
			field: "Geo",
			operator: "in",
			value: ["CERTA", "CETA", "Latin America", "North America"]
			},
				{
					field: "SubRegion",
					operator: "eq",
					value: "MESA"
				},
				{
					field: "internalUser",
					operator: "eq",
					value: true
				},
				{
					field: "CountryCode",
					operator: "in",
					value: global.nonPoModelCountries
				},
				]
	},  
	structure: [{
		hidden: false,
		group: []
	}],
	callback: function() {
	  callbacks.quotePreview();
	  quoteHelper.checkResellerAddressData(config);
	  quoteHelper.buildQuotePreviewPage(config);
	  // NOR-800: expand Reseller Page when Reseller Party Id differs from SoldTo Party Id
	  let resellerInputEl = document.querySelector("[data-name='Reseller_PartyId']");
	  if (resellerInputEl) {
		let collapseEl = resellerInputEl.closest(".row").querySelector(".collapse");
		if (collapseEl.getAttribute("aria-label") == "up") {
		  $(collapseEl).click();
		}
	  }
	}
  };

  // PO, RESERVATION, CONFIGURATION
  const page2 = {
	title: "Form001",
	subtitle: "Form037",
	description: "Form003",
	selectone: "SelectOne",
	continue: "Continue",
	submit: "Submit",
	back: "Back",
	no: "No",
	poformat: "POFormat",
	savedraft: "Form208",
	ready: false,
	nav: true,
	showOnReview: false,
	filter: {
	  logic: "and",
	  filters: [{
		field: "Geo",
		operator: "nin",
		value: ["CERTA", "CETA", "Latin America", "North America"]
	  },
				{
				  field: "internalUser",
				  operator: "neq",
				  value: true
				},
				{
				  field: "SubRegion",
				  operator: "neq",
				  value: "MESA"
				},
				{
				  field: "CountryCode",
				  operator: "nin",
				  value: global.nonPoModelCountries
				},
			   ]
	},
	structure: [
	  // UPLOAD PO
	  {
		header: "Form261", 
		group: [
		  [{
			label: "FormCFI06",
			data: "PO_Attachment",
			type: "kUpload",
			required: true,
			uploadConfig: {
			  formId: 989,
			  extensions: [".pdf", ".zip", ".xlxs", ".xlsx", ".xls", ".doc", ".docx"],
			  maxFileSize: 4
			}
		  }],
		]
	  },
	  {
		header: "Form081",
		group: [
		  [{
			// TODO: On MTP change the localization instead
			label: "Form041",
			//	label: "Is your Sold to information available on the attached purchase order?",
			data: "Config_SoldToDetails",
			value: "N",
			required: true,
			type: "toggle",
			values: ["N", "Y"],
			options: ["No", "Yes"]
		  },
		   /*   {
               label: "Form042",
               data: "Config_SoldToDetails_Contact",
               value: "N",
               required: true,
               type: "toggle",
               values: ["N", "Y"],
               options: ["No", "Yes"]
             },*/
		   {
			 label: "Form043",
			 data: "Config_PayerDetails",
			 value: "N",
			 required: true,
			 type: "toggle",
			 values: ["N", "Y"],
			 options: ["No", "Yes"]
		   },
		   {
			 label: "Form044",
			 data: "Config_BillToDetails",
			 value: "N",
			 required: true,
			 type: "toggle",
			 values: ["N", "Y"],
			 options: ["No", "Yes"]
		   }
		  ]
		]
	  },
	  {
		filter: {
		  field: "PO_Category",
		  operator: "eq",
		  value: "Stock"
		},
		header: "Form045",
		description: "Form046",
		group: [
		  [{
			label: "Form047",
			data: "Config_ShipToDetails",
			value: "N",
			required: true,
			type: "toggle",
			values: ["N", "Y"],
			options: ["No", "Yes"]
		  },
		   {
			 label: "Form048",
			 data: "Config_ShipToDetails_Contact",
			 value: "N",
			 required: false,
			 type: "toggle",
			 values: ["N", "Y"],
			 options: ["No", "Yes"]
		   }
		  ]
		]
	  },
	  {
		filter: {
		  logic: "and",
		  filters: [{
			field: "PartnerBRT",
			operator: "nin",
			value: ["Distributor", "OEM Distributor", "System Integrator"]
		  },
					{
					  field: "PO_Category",
					  operator: "neq",
					  value: "Stock"
					}
				   ]
		},
		header: "Form049",
		description: "Form050",
		group: [
		  [{
			label: "Form047",
			data: "Config_ShipToDetails",
			value: "N",
			required: true,
			type: "toggle",
			values: ["N", "Y"],
			options: ["No", "Yes"]
		  },
		   {
			 label: "Form048",
			 data: "Config_ShipToDetails_Contact",
			 value: "N",
			 required: false,
			 type: "toggle",
			 values: ["N", "Y"],
			 options: ["No", "Yes"]
		   },
		   {
			 label: "Form084",
			 data: "Config_EndCxDetails",
			 value: "N",
			 required: true,
			 type: "toggle",
			 values: ["N", "Y"],
			 options: ["No", "Yes"]
		   },
		   {
			 label: "Form085",
			 data: "Config_EndCxDetails_Contact",
			 value: "N",
			 required: true,
			 type: "toggle",
			 values: ["N", "Y"],
			 options: ["No", "Yes"]
		   }
		  ]
		]
	  },
	  {
		filter: {
		  logic: "and",
		  filters: [{
			field: "PartnerBRT",
			operator: "in",
			value: ["Distributor", "OEM Distributor", "System Integrator"]
		  },
					{
					  field: "PO_BusinessModel",
					  operator: "nin",
					  value: ["Agent Model", "HPFS & Agent Model"]
					},
					{
					  field: "PO_Category",
					  operator: "neq",
					  value: "Stock"
					}
				   ]
		},
		header: "Form049",
		description: "Form050",
		group: [
		  [{
			label: "Form047",
			data: "Config_ShipToDetails",
			value: "N",
			required: true,
			type: "toggle",
			values: ["N", "Y"],
			options: ["No", "Yes"]
		  },
		   {
			 label: "Form048",
			 data: "Config_ShipToDetails_Contact",
			 value: "N",
			 required: false,
			 type: "toggle",
			 values: ["N", "Y"],
			 options: ["No", "Yes"]
		   },
		   {
			 label: "Form084",
			 data: "Config_EndCxDetails",
			 value: "N",
			 required: true,
			 type: "toggle",
			 values: ["N", "Y"],
			 options: ["No", "Yes"]
		   },
		   {
			 label: "Form085",
			 data: "Config_EndCxDetails_Contact",
			 value: "N",
			 required: true,
			 type: "toggle",
			 values: ["N", "Y"],
			 options: ["No", "Yes"]
		   },
		   {
			 label: "Form082",
			 data: "Config_ResellerDetails",
			 value: "N",
			 required: true,
			 type: "toggle",
			 values: ["N", "Y"],
			 options: ["No", "Yes"]
		   },
		   {
			 label: "Form083",
			 data: "Config_ResellerDetails_Contact",
			 value: "N",
			 required: true,
			 type: "toggle",
			 values: ["N", "Y"],
			 options: ["No", "Yes"]
		   },
		  ]
		]
	  },
	  {
		filter: {
		  field: "CountryCode",
		  operator: "eq",
		  value: "IN"
		},
		header: "Form521",
		group: [
		  [{
			label: "Form522",
			data: "Config_Tier1",
			value: "Y",
			required: true,
			type: "toggle",
			values: ["N", "Y"],
			options: ["No", "Yes"]
		  }]
		]
	  },
	  {
		filter: {
		  logic: "and",
		  filters: [{
			field: "CountryCode",
			operator: "eq",
			value: "IN"
		  },
					{
					  field: "Config_Tier1",
					  operator: "neq",
					  value: "Y"
					}
				   ]
		},
		header: "",
		group: [
		  [{
			label: "Form523",
			data: "Config_Business_Justification",
			required: true,
			type: "text",
			placeholder: "Form524",
			validation: ["minLen|1"],
			typing: "ascii"
		  }]
		]
	  },
	  {
		filter: {
		  field: "CountryCode",
		  operator: "eq",
		  value: "IN"
		},
		header: "",
		group: [
		  [{
			label: "Form525",
			data: "Config_Tier2",
			value: "Y",
			required: true,
			type: "toggle",
			values: ["N", "Y"],
			options: ["No", "Yes"]
		  },
		   {
			 label: "Form526",
			 data: "Config_Shipment_India",
			 value: "Y",
			 required: true,
			 type: "toggle",
			 values: ["N", "Y"],
			 options: ["No", "Yes"]
		   }
		  ]
		]
	  },
	  {
		filter: {
		  logic: "and",
		  filters: [{
			field: "CountryCode",
			operator: "eq",
			value: "IN"
		  },
					{
					  field: "Config_Shipment_India",
					  operator: "neq",
					  value: "Y"
					}
				   ]
		},
		header: "",
		group: [
		  [{
			label: "Form527",
			data: "Config_OEM",
			value: "N",
			required: true,
			type: "toggle",
			values: ["N", "Y"],
			options: ["No", "Yes"]
		  }]
		]
	  },
	],
	callback: function() {
	  callbacks.page2();
	  // NOR-800: Force value of Config_ResellerDetails to N when Reseller Party Id differs from SoldTo Party Id
	  let resellerEl = document.querySelector("[data-name='Config_ResellerDetails']");
	  let ds = config.dataset;
	  if (resellerEl && ds.Requestor_PO_Quote_ID && ds.Reseller_PartyId && ds.SoldTo_PartyId && ds.Reseller_PartyId != ds.SoldTo_PartyId) {
		resellerEl.setAttribute("value", "N");
		resellerEl.parentNode.classList.remove("active");
		ds.Config_ResellerDetails = "N";
	  }
	}
  };

  // SOLD TO PAGE
  const page3 = {
	title: "Form054",
	subtitle: "Form055",
	description: "Form003",
	selectone: "SelectOne",
	continue: "Continue",
	submit: "Submit",
	back: "Back",
	no: "No",
	poformat: "POFormat",
	savedraft: "Form208",
	ready: false,
	nav: true,
	showOnReview: true,
	hideIfOnReview: true,
	addressPage: 'soldto',
	filter: {
	  logic: "and",
	  filters: [
		{
		  field: "Config_SoldToDetails",
		  operator: "neq",
		  value: "Y"
		},
	  ]
	},
	structure: [
	  {
	  //header: "Form056",
	  header: "Address",
	  filter: {
		logic: "and",
		filters: [{
		  field: "Config_SoldToDetails",
		  operator: "neq",
		  value: "Y"
		},
				  {
					field: "xrefFail",
					operator: "eq",
					value: "No"
				  },
				  {
					field: "CountryCode",
					operator: "nin",
					value: ["HK", "MO"]
				  },
				 ]
	  },
	  group: [
		[{
		  label: "Form086",
		  data: "SoldTo_PartyId",
		  required: false,
		  type: "text",
		  //placeholder: "Form057",
		  validation: ["kpDefault", "minLen|2", "maxLen|10", "noBlanksv2"],
		  typing: "kpDefault"
		}],
		[{
		  label: "Form058",
		  data: "SoldTo_CompanyName",
		  required: true,
		  type: "text",
		  //placeholder: "Form059",
		  validation: ["kpDefault", "minLen|2", "maxLen|140"],
		  typing: "kpDefault"
		},
		 {
		   label: "Address",
		   data: "SoldTo_Address_Street",
		   required: true,
		   type: "text",
		   //placeholder: "Form216",
		   validation: ["kpDefault", "minLen|2", "maxLen|65"],
		   typing: "kpDefault"
		 },
		 {
		   label: "AddressLineOptional",
		   data: "SoldTo_Address_Street2",
		   required: false,
		   type: "text",
		   //placeholder: "Form061",
		   validation: ["kpDefault", "minLen|2", "maxLen|40"],
		   typing: "kpDefault"
		 },
		 {
		   label: "City",
		   data: "SoldTo_Address_City",
		   required: true,
		   type: "text",
		   //placeholder: "Form062",
		   validation: ["kpDefault", "minLen|2", "maxLen|35"],
		   typing: "kpDefault"
		 },
		 {
		   label: "StateProvince",
		   data: "SoldTo_Address_State",
		   required: false,
		   type: "text",
		   //placeholder: "Form063",
		   validation: ["kpDefault", "minLen|2"],
		   typing: "kpDefault"
		 },
		 {
		   label: "Postal code",
		   data: "SoldTo_Address_Postal",
		   required: true,
		   type: "text",
		   //placeholder: "Form087",
		   validation: ["kpDefault", "minLen|2", "maxLen|10"],
		   typing: "kpDefault"
		 },
		 {
		   label: "Country",
		   data: "SoldTo_Address_Country",
		   disabled: true,
		   required: true,
		   type: "select",
		   class: "review-address-country",
		   values: function() {
			 return reference.countriesArray
		   }
		 }
		]
	  ]
	},
	  {
		//header: "Form056",
		header: "Address",
		filter: {
		  logic: "and",
		  filters: [{
			field: "Config_SoldToDetails",
			operator: "neq",
			value: "Y"
		  },
					{
					  field: "xrefFail",
					  operator: "eq",
					  value: "No"
					},
					{
					  field: "CountryCode",
					  operator: "in",
					  value: ["HK", "MO"]
					},
				   ]
		},
		group: [
		  [{
			label: "Form086",
			data: "SoldTo_PartyId",
			required: false,
			type: "text",
			//placeholder: "Form057",
			validation: ["kpDefault", "minLen|2", "maxLen|10", "noBlanksv2"],
			typing: "kpDefault"
		  }],
		  [{
			label: "Form058",
			data: "SoldTo_CompanyName",
			required: true,
			type: "text",
			//placeholder: "Form059",
			validation: ["kpDefault", "minLen|2", "maxLen|140"],
			typing: "kpDefault"
		  },
		   {
			 label: "Address",
			 data: "SoldTo_Address_Street",
			 required: true,
			 type: "text",
			 //placeholder: "Form216",
			 validation: ["kpDefault", "minLen|2", "maxLen|65"],
			 typing: "kpDefault"
		   },
		   {
			 label: "AddressLineOptional",
			 data: "SoldTo_Address_Street2",
			 required: false,
			 type: "text",
			 //placeholder: "Form061",
			 validation: ["kpDefault", "minLen|2", "maxLen|40"],
			 typing: "kpDefault"
		   },
		   {
			 label: "City",
			 data: "SoldTo_Address_City",
			 required: true,
			 type: "text",
			 //placeholder: "Form062",
			 validation: ["kpDefault", "minLen|2", "maxLen|35"],
			 typing: "kpDefault"
		   },
		   {
			 label: "StateProvince",
			 data: "SoldTo_Address_State",
			 required: false,
			 type: "text",
			 //placeholder: "Form063",
			 validation: ["kpDefault", "minLen|2"],
			 typing: "kpDefault"
		   },
		   {
			 label: "Postal code",
			 data: "SoldTo_Address_Postal",
			 required: false,
			 type: "text",
			 //placeholder: "Form087",
			 validation: ["kpDefault", "minLen|2", "maxLen|10"],
			 typing: "kpDefault"
		   },
		   {
			 label: "Country",
			 data: "SoldTo_Address_Country",
			 disabled: true,
			 required: true,
			 type: "select",
			 class: "review-address-country",
			 values: function() {
			   return reference.countriesArray
			 }
		   }
		  ]
		]
	  },
	  {
		header: "",
		filter: {
		  logic: "and",
		  filters: [
			{
			  field: "Config_SoldToDetails",
			  operator: "neq",
			  value: "Y"
			}, 
			{
			  field: "xrefFail",
			  operator: "eq",
			  value: "No"
			},
			{
			  field: "SoldTo_Address_Country",
			  operator: "in",
			  value: ["Argentina", "Brazil", "Chile", "Colombia", "Mexico", "Peru", "Puerto Rico"]
			}]
		},
		group: [
		  [{
			label: "Form495",
			data: "SoldTo_NationalID",
			required: true,
			type: "text",
			validation: ["nationalID", "minLen|1", "maxLen|14"],
			typing: "nationalID",
			class: "review-address-taxid"
		  }]
		]
	  },
	  {
		header: "",
		filter: {
		  logic: "and",
		  filters: [
			{
			  field: "Config_SoldToDetails",
			  operator: "neq",
			  value: "Y"
			}, 
			{
			  field: "xrefFail",
			  operator: "eq",
			  value: "No"
			},
			{
			  field: "SoldTo_Address_Country",
			  operator: "nin",
			  value: ["Argentina", "Brazil", "Chile", "Colombia", "Mexico", "Peru", "Puerto Rico"]
			}]
		},
		group: [
		  [{
			label: "Form495",
			data: "SoldTo_NationalID",
			required: false,
			type: "text",
			validation: ["nationalID", "minLen|1", "maxLen|14"],
			typing: "nationalID",
			class: "review-address-taxid"
		  }]
		]
	  },
	  
	  {
		//header: "Form056",
		header: "Address",
		filter: {
		  logic: "and",
		  filters: [{
			field: "Config_SoldToDetails",
			operator: "neq",
			value: "Y"
		  },
					{
					  field: "xrefFail",
					  operator: "eq",
					  value: "Yes"
					}
				   ]
		},
		group: [
		  [{
			label: "Form086",
			data: "SoldTo_PartyId",
			required: false,
			type: "text",
			//placeholder: "Form057",
			validation: ["kpDefault", "minLen|2", "maxLen|10", "noBlanksv2"],
			typing: "kpDefault"
		  }]
		]
	  },
	  {
		header: "Contact",
		filter: {
		  field: "Config_SoldToDetails",
		  operator: "neq",
		  value: "Y"
		},
		group: [
		  [{
			label: "FirstName",
			data: "SoldTo_Contact_FirstName",
			required: false,
			type: "text",
			//placeholder: "Form065",
			validation: ["kpDefault", "minLen|1"],
			typing: "kpDefault",
			class: "review-contact-firstname",
		  },
		   {
			 label: "Surname",
			 data: "SoldTo_Contact_LastName",
			 required: true,
			 type: "text",
			 //placeholder: "Form066",
			 validation: ["kpDefault", "minLen|1", "maxLen|60"],
			 typing: "kpDefault"
		   },
		   {
			 label: "Telephone",
			 data: "SoldTo_Contact_Phone",
			 required: false,
			 type: "text",
			 //placeholder: "1-888-666-5555",
			 validation: ["typePhone", "minLen|8", "maxLen|18"],
			 typing: "typePhone"
		   },
		   {
			 label: "Email",
			 data: "SoldTo_Contact_Email",
			 required: true,
			 type: "text",
			 //placeholder: "Form067",
			 validation: ["isEmail", "maxLen|96"],
			 typing: "typeEmail"
		   },
		   {
			 label: "CountryOfResidence",
			 data: "SoldTo_Contact_Country",
			 required: true,
			 type: "select",
			 values: function() {
			   return reference.countriesArray
			 }
		   }
		  ]
		]
	  },
	],
	callback: function() {
	  callbacks.page3();
	}
  };

  // PAYER INFORMATION [Config_PayerDetails != "Y"]
  const page4 = {
	title: "Form068",
	subtitle: "Form088",
	description: "Form003",
	selectone: "SelectOne",
	continue: "Continue",
	submit: "Submit",
	back: "Back",
	no: "No",
	poformat: "POFormat",
	savedraft: "Form208",
	ready: false,
	nav: true,
	showOnReview: true,
	hideIfOnReview: true,
	addressPage: 'payer',
	filter: {
	  logic: "and",
	  filters: [
		{
		  field: "Config_PayerDetails",
		  operator: "neq",
		  value: "Y"
		},
	  ]
	},
	structure: [{
	  header: "Address",
	  filter: {
		logic: "and",
		filters: [{
		  field: "CountryCode",
		  operator: "nin",
		  value: ["HK", "MO"]
		}, ]
	  },
	  group: [
		[{
		  label: "Form086",
		  data: "Payer_PartyId",
		  required: false,
		  type: "text",
		  validation: ["kpDefault", "minLen|2", "maxLen|10", "noBlanksv2"],
		  //placeholder: "Form090",
		  typing: "kpDefault"
		}],
		[{
		  label: "Form058",
		  data: "Payer_CompanyName",
		  required: true,
		  type: "text",
		  //placeholder: "Form091",
		  validation: ["kpDefault", "minLen|2", "maxLen|140"],
		  typing: "kpDefault"
		},
		 {
		   label: "Address",
		   data: "Payer_Address_Street",
		   required: true,
		   type: "text",
		   //placeholder: "Form092",
		   validation: ["kpDefault", "minLen|2", "maxLen|65"],
		   typing: "kpDefault"
		 },
		 {
		   label: "AddressLineOptional",
		   data: "Payer_Address_Street2",
		   required: false,
		   type: "text",
		   //placeholder: "Form093",
		   validation: ["kpDefault", "minLen|2", "maxLen|40"],
		   typing: "kpDefault"
		 },
		 {
		   label: "City",
		   data: "Payer_Address_City",
		   required: true,
		   type: "text",
		   //placeholder: "Form094",
		   validation: ["kpDefault", "minLen|2", "maxLen|35"],
		   typing: "kpDefault"
		 },
		 {
		   label: "StateProvince",
		   data: "Payer_Address_State",
		   required: false,
		   type: "text",
		   //placeholder: "Form095",
		   validation: ["kpDefault", "minLen|2"],
		   typing: "kpDefault"
		 },
		 {
		   label: "Postal code",
		   data: "Payer_Address_Postal",
		   required: true,
		   type: "text",
		   //placeholder: "Form096",
		   validation: ["kpDefault", "minLen|2", "maxLen|10"],
		   typing: "kpDefault"
		 },
		 {
		   label: "Country",
		   data: "Payer_Address_Country",
		   required: true,
		   disabled: true,
		   type: "select",
		   class: "review-address-country",
		   values: function() {
			 return reference.countriesArray
		   }
		 }
		]
	  ]
	},
				{
				  header: "Address",
				  filter: {
					logic: "and",
					filters: [{
					  field: "CountryCode",
					  operator: "in",
					  value: ["HK", "MO"]
					}, ]
				  },
				  group: [
					[{
					  label: "Form086",
					  data: "Payer_PartyId",
					  required: false,
					  type: "text",
					  validation: ["kpDefault", "minLen|2", "maxLen|10", "noBlanksv2"],
					  //placeholder: "Form090",
					  typing: "kpDefault"
					}],
					[{
					  label: "Form058",
					  data: "Payer_CompanyName",
					  required: true,
					  type: "text",
					  //placeholder: "Form091",
					  validation: ["kpDefault", "minLen|2", "maxLen|140"],
					  typing: "kpDefault"
					},
					 {
					   label: "Address",
					   data: "Payer_Address_Street",
					   required: true,
					   type: "text",
					   //placeholder: "Form092",
					   validation: ["kpDefault", "minLen|2", "maxLen|65"],
					   typing: "kpDefault"
					 },
					 {
					   label: "AddressLineOptional",
					   data: "Payer_Address_Street2",
					   required: false,
					   type: "text",
					   //placeholder: "Form093",
					   validation: ["kpDefault", "minLen|2", "maxLen|40"],
					   typing: "kpDefault"
					 },
					 {
					   label: "City",
					   data: "Payer_Address_City",
					   required: true,
					   type: "text",
					   //placeholder: "Form094",
					   validation: ["kpDefault", "minLen|2", "maxLen|35"],
					   typing: "kpDefault"
					 },
					 {
					   label: "StateProvince",
					   data: "Payer_Address_State",
					   required: false,
					   type: "text",
					   //placeholder: "Form095",
					   validation: ["kpDefault", "minLen|2"],
					   typing: "kpDefault"
					 },
					 {
					   label: "Postal code",
					   data: "Payer_Address_Postal",
					   required: false,
					   type: "text",
					   //placeholder: "Form096",
					   validation: ["kpDefault", "minLen|2", "maxLen|10"],
					   typing: "kpDefault"
					 },
					 {
					   label: "Country",
					   data: "Payer_Address_Country",
					   required: true,
					   type: "select",
					   class: "review-address-country",
					   values: function() {
						 return reference.countriesArray
					   }
					 }
					]
				  ]
				},
				{
				  header: "Contact",
				  group: [
					[{
					  label: "FirstName",
					  data: "Payer_Contact_FirstName",
					  required: false,
					  type: "text",
					  //placeholder: "Form098",
					  validation: ["kpDefault", "minLen|1"],
					  typing: "kpDefault",
					  class: "review-contact-firstname",
					},
					 {
					   label: "Surname",
					   data: "Payer_Contact_LastName",
					   required: false,
					   type: "text",
					   //placeholder: "Form099",
					   validation: ["kpDefault", "minLen|1", "maxLen|60"],
					   typing: "kpDefault"
					 },
					 {
					   label: "Telephone",
					   data: "Payer_Contact_Phone",
					   required: false,
					   type: "text",
					   //placeholder: "1-888-666-5555",
					   validation: ["typePhone", "minLen|8", "maxLen|18"],
					   typing: "typePhone"
					 },
					 {
					   label: "Email",
					   data: "Payer_Contact_Email",
					   required: false,
					   type: "text",
					   //placeholder: "Form100",
					   validation: ["isEmail", "maxLen|96"],
					   typing: "typeEmail"
					 },
					 {
					   label: "CountryOfResidence",
					   data: "Payer_Contact_Country",
					   required: false,
					   type: "select",
					   values: function() {
						 return reference.countriesArray
					   }
					 }
					]
				  ]
				}
			   ],
	callback: function() {
	  callbacks.page4();
	}
  };

  // BILL INFORMATION [Config_BillToDetails != "Y"]
  const page5 = {
	title: "Form101",
	subtitle: "Form102",
	description: "Form003",
	selectone: "SelectOne",
	continue: "Continue",
	submit: "Submit",
	back: "Back",
	no: "No",
	poformat: "POFormat",
	savedraft: "Form208",
	ready: false,
	nav: true,
	showOnReview: true,
	hideIfOnReview: true,
	addressPage: 'billto',
    filter: {
      logic: "and",
      filters: [
        {
          field: "Config_BillToDetails",
          operator: "neq",
          value: "Y"
        },
      ]
    },
	structure: [{
	  header: "Address",
	  group: [
		[{
		  label: "Form086",
		  data: "BillTo_PartyId",
		  required: false,
		  type: "text",
		  //placeholder: "Form104",
		  validation: ["kpDefault", "minLen|2", "maxLen|10", "noBlanksv2"],
		  typing: "kpDefault"
		}],
		[{
		  label: "Form058",
		  data: "BillTo_CompanyName",
		  required: false,
		  type: "text",
		  //placeholder: "Form105",
		  validation: ["kpDefault", "minLen|2", "maxLen|140"],
		  typing: "kpDefault"
		},
		 {
		   label: "Address",
		   data: "BillTo_Address_Street",
		   required: false,
		   type: "text",
		   //placeholder: "Form106",
		   validation: ["kpDefault", "minLen|2", "maxLen|65"],
		   typing: "kpDefault"
		 },
		 {
		   label: "AddressLineOptional",
		   data: "BillTo_Address_Street2",
		   required: false,
		   type: "text",
		   //placeholder: "Form107",
		   validation: ["kpDefault", "minLen|2", "maxLen|40"],
		   typing: "kpDefault"
		 },
		 {
		   label: "City",
		   data: "BillTo_Address_City",
		   required: false,
		   type: "text",
		   //placeholder: "Form108",
		   validation: ["kpDefault", "minLen|2", "maxLen|35"],
		   typing: "kpDefault"
		 },
		 {
		   label: "StateProvince",
		   data: "BillTo_Address_State",
		   required: false,
		   type: "text",
		   //placeholder: "Form109",
		   validation: ["kpDefault", "minLen|2"],
		   typing: "kpDefault"
		 },
		 {
		   label: "Postal code",
		   data: "BillTo_Address_Postal",
		   required: false,
		   type: "text",
		   //placeholder: "Form110",
		   validation: ["kpDefault", "minLen|2", "maxLen|10"],
		   typing: "kpDefault"
		 },
		 {
		   label: "Country",
		   data: "BillTo_Address_Country",
		   required: false,
		   type: "select",
		   class: "review-address-country",
		   values: function() {
			 return reference.countriesArray
		   }
		 }
		]
	  ]
	},
				{
				  header: "Contact",
				  group: [
					[{
					  label: "FirstName",
					  data: "BillTo_Contact_FirstName",
					  required: false,
					  type: "text",
					  //placeholder: "Form111",
					  validation: ["kpDefault", "minLen|1"],
					  typing: "kpDefault",
					  class: "review-contact-firstname",
					},
					 {
					   label: "Surname",
					   data: "BillTo_Contact_LastName",
					   required: false,
					   type: "text",
					   //placeholder: "Form112",
					   validation: ["kpDefault", "minLen|1", "maxLen|60"],
					   typing: "kpDefault"
					 },
					 {
					   label: "Telephone",
					   data: "BillTo_Contact_Phone",
					   required: false,
					   type: "text",
					   //placeholder: "1-888-666-5555",
					   validation: ["typePhone", "minLen|8", "maxLen|18"],
					   typing: "typePhone"
					 },
					 {
					   label: "Email",
					   data: "BillTo_Contact_Email",
					   required: false,
					   type: "text",
					   //placeholder: "Form113",
					   validation: ["isEmail", "maxLen|96"],
					   typing: "typeEmail"
					 },
					 {
					   label: "CountryOfResidence",
					   data: "BillTo_Contact_Country",
					   required: false,
					   type: "select",
					   values: function() {
						 return reference.countriesArray
					   }

					 }
					]
				  ]
				}
			   ],
	callback: function() {
	  callbacks.page5();
	}
  };

  // SHIP TO INFORMATION
  const page6 = {
	title: "Form114",
	subtitle: "Form115",
	description: "Form003",
	selectone: "SelectOne",
	continue: "Continue",
	submit: "Submit",
	back: "Back",
	no: "No",
	poformat: "POFormat",
	savedraft: "Form208",
	ready: false,
	nav: true,
	showOnReview: true,
	hideIfOnReview: true,
	addressPage: 'shipping',
	filter: {
	  logic: "and",
	  filters: [
		{
		  logic: "or",
		  filters: [
			{
			  field: "Config_ShipToDetails",
			  operator: "neq",
			  value: "Y"
			},
			{
			  field: "Config_ShipToDetails_Contact",
			  operator: "neq",
			  value: "Y"
			}
		  ]
		},
	  ]
	},
	structure: [{
	  header: "Address",
	  filter: {
		logic: "and",
		filters: [{
		  field: "Config_ShipToDetails",
		  operator: "neq",
		  value: "Y"
		},
				  {
					field: "CountryCode",
					operator: "nin",
					value: ["HK", "MO"]
				  },
				  {
					logic: "or",
					filters: [{
					  field: "ShipTo_PartyId",
					  operator: "doesnotstartwith",
					  value: "2"
					},
							  {
								field: "ShipTo_PartyId",
								operator: "isnull",
								value: "2"
							  },
							 ]
				  }
				 ]
	  },
	  group: [
		[{
		  label: "Form086",
		  data: "ShipTo_PartyId",
		  required: false,
		  type: "text",
		  //placeholder: "Form057",
		  validation: ["kpDefault", "minLen|2", "maxLen|10", "noBlanksv2"],
		  typing: "kpDefault",
		}],
		[{
		  label: "Form058",
		  data: "ShipTo_CompanyName",
		  required: true,
		  type: "text",
		  //placeholder: "Form117",
		  validation: ["kpDefault", "minLen|2", "maxLen|140"],
		  typing: "kpDefault"
		},
		 {
		   label: "Address",
		   data: "ShipTo_Address_Street",
		   required: true,
		   type: "text",
		   //placeholder: "Form118",
		   validation: ["kpDefault", "minLen|2", "maxLen|65"],
		   typing: "kpDefault"
		 },
		 {
		   label: "AddressLineOptional",
		   data: "ShipTo_Address_Street2",
		   required: false,
		   type: "text",
		   //placeholder: "Form119",
		   validation: ["kpDefault", "minLen|2", "maxLen|40"],
		   typing: "kpDefault"
		 },
		 {
		   label: "City",
		   data: "ShipTo_Address_City",
		   required: true,
		   type: "text",
		   //placeholder: "Form120",
		   validation: ["kpDefault", "minLen|2", "maxLen|35"],
		   typing: "kpDefault"
		 },
		 {
		   label: "StateProvince",
		   data: "ShipTo_Address_State",
		   required: false,
		   type: "text",
		   //placeholder: "Form121",
		   validation: ["kpDefault", "minLen|2"],
		   typing: "kpDefault"
		 },
		 {
		   label: "Postal code",
		   data: "ShipTo_Address_Postal",
		   required: true,
		   type: "text",
		   //placeholder: "Form122",
		   validation: ["kpDefault", "minLen|2", "maxLen|10"],
		   typing: "kpDefault"
		 },
		 {
		   label: "Country",
		   data: "ShipTo_Address_Country",
		   required: true,
		   type: "select",
		   class: "review-address-country",
		   values: function() {
			 return reference.countriesArray
		   }
		 }
		]
	  ]
	},
				{
				  header: "Address",
				  filter: {
					logic: "and",
					filters: [{
					  field: "Config_ShipToDetails",
					  operator: "neq",
					  value: "Y"
					},
							  {
								field: "ShipTo_PartyId",
								operator: "startswith",
								value: "2"
							  }
							 ]
				  },
				  group: [
					[{
					  label: "Form086",
					  data: "ShipTo_PartyId",
					  required: false,
					  type: "text",
					  //placeholder: "Form057",
					  validation: ["kpDefault", "minLen|2", "maxLen|10", "noBlanksv2"],
					  typing: "kpDefault",
					}],
					[{
					  label: "Form058",
					  data: "ShipTo_CompanyName",
					  required: false,
					  type: "text",
					  //placeholder: "Form117",
					  validation: ["kpDefault", "minLen|2", "maxLen|140"],
					  typing: "kpDefault"
					},
					 {
					   label: "Address",
					   data: "ShipTo_Address_Street",
					   required: false,
					   type: "text",
					   //placeholder: "Form118",
					   validation: ["kpDefault", "minLen|2", "maxLen|65"],
					   typing: "kpDefault"
					 },
					 {
					   label: "AddressLineOptional",
					   data: "ShipTo_Address_Street2",
					   required: false,
					   type: "text",
					   //placeholder: "Form119",
					   validation: ["kpDefault", "minLen|2", "maxLen|40"],
					   typing: "kpDefault"
					 },
					 {
					   label: "City",
					   data: "ShipTo_Address_City",
					   required: false,
					   type: "text",
					   //placeholder: "Form120",
					   validation: ["kpDefault", "minLen|2", "maxLen|35"],
					   typing: "kpDefault"
					 },
					 {
					   label: "StateProvince",
					   data: "ShipTo_Address_State",
					   required: false,
					   type: "text",
					   //placeholder: "Form121",
					   validation: ["kpDefault", "minLen|2"],
					   typing: "kpDefault"
					 },
					 {
					   label: "Postal code",
					   data: "ShipTo_Address_Postal",
					   required: false,
					   type: "text",
					   //placeholder: "Form122",
					   validation: ["kpDefault", "minLen|2", "maxLen|10"],
					   typing: "kpDefault"
					 },
					 {
					   label: "Country",
					   data: "ShipTo_Address_Country",
					   required: false,
					   type: "select",
					   class: "review-address-country",
					   values: function() {
						 return reference.countriesArray
					   }
					 }
					]
				  ]
				},


				{
				  header: "Address",
				  filter: {
					logic: "and",
					filters: [{
					  field: "Config_ShipToDetails",
					  operator: "neq",
					  value: "Y"
					},
							  {
								field: "CountryCode",
								operator: "in",
								value: ["HK", "MO"]
							  },
							  {
								logic: "or",
								filters: [{
								  field: "ShipTo_PartyId",
								  operator: "doesnotstartwith",
								  value: "2"
								},
										  {
											field: "ShipTo_PartyId",
											operator: "isnull",
											value: "2"
										  },
										 ]
							  }
							 ]
				  },
				  group: [
					[{
					  label: "Form086",
					  data: "ShipTo_PartyId",
					  required: false,
					  type: "text",
					  //placeholder: "Form057",
					  validation: ["kpDefault", "minLen|2", "maxLen|10", "noBlanksv2"],
					  typing: "kpDefault",
					}],
					[{
					  label: "Form058",
					  data: "ShipTo_CompanyName",
					  required: true,
					  type: "text",
					  //placeholder: "Form117",
					  validation: ["kpDefault", "minLen|2", "maxLen|140"],
					  typing: "kpDefault"
					},
					 {
					   label: "Address",
					   data: "ShipTo_Address_Street",
					   required: true,
					   type: "text",
					   //placeholder: "Form118",
					   validation: ["kpDefault", "minLen|2", "maxLen|65"],
					   typing: "kpDefault"
					 },
					 {
					   label: "AddressLineOptional",
					   data: "ShipTo_Address_Street2",
					   required: false,
					   type: "text",
					   //placeholder: "Form119",
					   validation: ["kpDefault", "minLen|2", "maxLen|40"],
					   typing: "kpDefault"
					 },
					 {
					   label: "City",
					   data: "ShipTo_Address_City",
					   required: true,
					   type: "text",
					   //placeholder: "Form120",
					   validation: ["kpDefault", "minLen|2", "maxLen|35"],
					   typing: "kpDefault"
					 },
					 {
					   label: "StateProvince",
					   data: "ShipTo_Address_State",
					   required: false,
					   type: "text",
					   //placeholder: "Form121",
					   validation: ["kpDefault", "minLen|2"],
					   typing: "kpDefault"
					 },
					 {
					   label: "Postal code",
					   data: "ShipTo_Address_Postal",
					   required: false,
					   type: "text",
					   //placeholder: "Form122",
					   validation: ["kpDefault", "minLen|2", "maxLen|10"],
					   typing: "kpDefault"
					 },
					 {
					   label: "Country",
					   data: "ShipTo_Address_Country",
					   required: true,
					   type: "select",
					   class: "review-address-country",
					   values: function() {
						 return reference.countriesArray
					   }
					 }
					]
				  ]
				},


				{
				  header: "",
				  filter: {
					logic: "and",
					filters: [{
					  field: "Config_ShipToDetails",
					  operator: "neq",
					  value: "Y"
					}, {
					  field: "ShipTo_Address_Country",
					  operator: "in",
					  value: ["Mexico", "Turkey"]
					}]
				  },
				  group: [
					[{
					  label: "Form495",
					  data: "ShipTo_NationalID",
					  required: true,
					  type: "text",
					  validation: ["nationalID", "minLen|1", "maxLen|14"],
					  typing: "nationalID",
					  class: "review-address-taxid",
					}]
				  ]
				},
				{
				  header: "",
				  filter: {
					logic: "and",
					filters: [{
					  field: "Config_ShipToDetails",
					  operator: "neq",
					  value: "Y"
					}, {
					  field: "ShipTo_Address_Country",
					  operator: "nin",
					  value: ["Mexico", "Turkey"]
					}]
				  },
				  group: [
					[{
					  label: "Form495",
					  data: "ShipTo_NationalID",
					  required: false,
					  type: "text",
					  validation: ["nationalID", "minLen|1", "maxLen|14"],
					  typing: "nationalID",
					  class: "review-address-taxid"
					}]
				  ]
				},
				{
				  header: "Contact",
				  filter: {
					logic: "and",
					filters: [{
					  field: "Config_ShipToDetails_Contact",
					  operator: "neq",
					  value: "Y"
					}, {
					  field: "SoldTo_Address_Country",
					  operator: "neq",
					  value: "Korea (Rep.)"
					}]
				  },
				  group: [
					[{
					  label: "FirstName",
					  data: "ShipTo_Contact_FirstName",
					  required: false,
					  type: "text",
					  //placeholder: "Form124",
					  validation: ["kpDefault", "minLen|1"],
					  typing: "kpDefault",
					  class: "review-contact-firstname",
					},
					 {
					   label: "Surname",
					   data: "ShipTo_Contact_LastName",
					   required: false,
					   type: "text",
					   //placeholder: "Form125",
					   validation: ["kpDefault", "minLen|1", "maxLen|60"],
					   typing: "kpDefault"
					 },
					 {
					   label: "Telephone",
					   data: "ShipTo_Contact_Phone",
					   required: false,
					   type: "text",
					   //placeholder: "1-888-666-5555",
					   validation: ["typePhone", "minLen|8", "maxLen|18"],
					   typing: "typePhone"
					 },
					 {
					   label: "Email",
					   data: "ShipTo_Contact_Email",
					   required: false,
					   type: "text",
					   //placeholder: "Form218",
					   validation: ["isEmail", "maxLen|96"],
					   typing: "typeEmail"
					 },
					 {
					   label: "CountryOfResidence",
					   data: "ShipTo_Contact_Country",
					   required: false,
					   type: "select",
					   values: function() {
						 return reference.countriesArray
					   }
					 }
					]
				  ]
				},
				{
				  header: "Contact",
				  filter: {
					logic: "and",
					filters: [{
					  field: "Config_ShipToDetails_Contact",
					  operator: "neq",
					  value: "Y"
					}, {
					  field: "SoldTo_Address_Country",
					  operator: "eq",
					  value: "Korea (Rep.)"
					}]
				  },
				  group: [
					[{
					  label: "FirstName",
					  data: "ShipTo_Contact_FirstName",
					  required: false,
					  type: "text",
					  //placeholder: "Form124",
					  validation: ["kpDefault", "minLen|1"],
					  typing: "kpDefault",
					  class: "review-contact-firstname",
					},
					 {
					   label: "Surname",
					   data: "ShipTo_Contact_LastName",
					   required: true,
					   type: "text",
					   //placeholder: "Form125",
					   validation: ["kpDefault", "minLen|1", "maxLen|60"],
					   typing: "kpDefault"
					 },
					 {
					   label: "Telephone",
					   data: "ShipTo_Contact_Phone",
					   required: true,
					   type: "text",
					   //placeholder: "1-888-666-5555",
					   validation: ["typePhone", "minLen|8", "maxLen|18"],
					   typing: "typePhone"
					 },
					 {
					   label: "Email",
					   data: "ShipTo_Contact_Email",
					   required: true,
					   type: "text",
					   //placeholder: "Form218",
					   validation: ["isEmail", "maxLen|96"],
					   typing: "typeEmail"
					 },
					 {
					   label: "CountryOfResidence",
					   data: "ShipTo_Contact_Country",
					   required: false,
					   type: "select",
					   values: function() {
						 return reference.countriesArray
					   }
					 }
					]
				  ]
				}
			   ],
	callback: function() {
	  callbacks.page6();
	}
  };

  // END CX INFORMATION
  const page7 = {
	title: "Form138",
	subtitle: "Form139",
	description: "Form003",
	selectone: "SelectOne",
	continue: "Continue",
	submit: "Submit",
	back: "Back",
	no: "No",
	poformat: "POFormat",
	savedraft: "Form208",
	ready: false,
	nav: true,
	showOnReview: true,
	hideIfOnReview: true,
	addressPage: 'endcx',
	filter: {
	  logic: "and",
	  filters: [
		{
		  logic: "or",
		  filters: [
			{
			  field: "Config_EndCxDetails",
			  operator: "neq",
			  value: "Y"
			},
			{
			  field: "Config_EndCxDetails_Contact",
			  operator: "neq",
			  value: "Y"
			}
		  ]
		},
	  ]
	},
	structure: [{
	  header: "Address",
	  filter: {
		logic: "and",
		filters: [{
		  field: "Config_EndCxDetails",
		  operator: "neq",
		  value: "Y"
		},
				  {
					field: "CountryCode",
					operator: "nin",
					value: ["HK", "MO"]
				  },
				 ]
	  },
	  group: [
		[{
		  label: "Form086",
		  data: "EndCx_PartyId",
		  required: false,
		  type: "text",
		  //placeholder: "Form057",
		  validation: ["kpDefault", "minLen|2", "maxLen|10", "noBlanksv2"],
		  typing: "kpDefault",
		}],
		[{
		  label: "Form058",
		  data: "EndCx_CompanyName",
		  required: true,
		  type: "text",
		  //placeholder: "Form141",
		  validation: ["kpDefault", "minLen|2", "maxLen|140"],
		  typing: "kpDefault"
		},
		 {
		   label: "Address",
		   data: "EndCx_Address_Street",
		   required: true,
		   type: "text",
		   //placeholder: "Form142",
		   validation: ["kpDefault", "minLen|2", "maxLen|65"],
		   typing: "kpDefault"
		 },
		 {
		   label: "AddressLineOptional",
		   data: "EndCx_Address_Street2",
		   required: false,
		   type: "text",
		   //placeholder: "Form143",
		   validation: ["kpDefault", "minLen|2", "maxLen|40"],
		   typing: "kpDefault"
		 },
		 {
		   label: "City",
		   data: "EndCx_Address_City",
		   required: true,
		   type: "text",
		   //placeholder: "Form144",
		   validation: ["kpDefault", "minLen|2", "maxLen|35"],
		   typing: "kpDefault"
		 },
		 {
		   label: "StateProvince",
		   data: "EndCx_Address_State",
		   required: false,
		   type: "text",
		   //placeholder: "Form145",
		   validation: ["kpDefault", "minLen|2"],
		   typing: "kpDefault"
		 },
		 {
		   label: "Postal code",
		   data: "EndCx_Address_Postal",
		   required: true,
		   type: "text",
		   //placeholder: "Form146",
		   validation: ["kpDefault", "minLen|2", "maxLen|10"],
		   typing: "kpDefault"
		 },
		 {
		   label: "Form219",
		   data: "EndCx_Address_Country",
		   required: true,
		   type: "select",
		   class: "review-address-country",
		   values: function() {
			 return reference.countriesArray
		   }
		 }
		]
	  ]
	},

				{
				  header: "Address",
				  filter: {
					logic: "and",
					filters: [{
					  field: "Config_EndCxDetails",
					  operator: "neq",
					  value: "Y"
					},
							  {
								field: "CountryCode",
								operator: "in",
								value: ["HK", "MO"]
							  },
							 ]
				  },
				  group: [
					[{
					  label: "Form086",
					  data: "EndCx_PartyId",
					  required: false,
					  type: "text",
					  //placeholder: "Form057",
					  validation: ["kpDefault", "minLen|2", "maxLen|10", "noBlanksv2"],
					  typing: "kpDefault",
					}],
					[{
					  label: "Form058",
					  data: "EndCx_CompanyName",
					  required: true,
					  type: "text",
					  //placeholder: "Form141",
					  validation: ["kpDefault", "minLen|2", "maxLen|140"],
					  typing: "kpDefault"
					},
					 {
					   label: "Address",
					   data: "EndCx_Address_Street",
					   required: true,
					   type: "text",
					   //placeholder: "Form142",
					   validation: ["kpDefault", "minLen|2", "maxLen|65"],
					   typing: "kpDefault"
					 },
					 {
					   label: "AddressLineOptional",
					   data: "EndCx_Address_Street2",
					   required: false,
					   type: "text",
					   //placeholder: "Form143",
					   validation: ["kpDefault", "minLen|2", "maxLen|40"],
					   typing: "kpDefault"
					 },
					 {
					   label: "City",
					   data: "EndCx_Address_City",
					   required: true,
					   type: "text",
					   //placeholder: "Form144",
					   validation: ["kpDefault", "minLen|2", "maxLen|35"],
					   typing: "kpDefault"
					 },
					 {
					   label: "StateProvince",
					   data: "EndCx_Address_State",
					   required: false,
					   type: "text",
					   //placeholder: "Form145",
					   validation: ["kpDefault", "minLen|2"],
					   typing: "kpDefault"
					 },
					 {
					   label: "Postal code",
					   data: "EndCx_Address_Postal",
					   required: false,
					   type: "text",
					   //placeholder: "Form146",
					   validation: ["kpDefault", "minLen|2", "maxLen|10"],
					   typing: "kpDefault"
					 },
					 {
					   label: "Form219",
					   data: "EndCx_Address_Country",
					   required: true,
					   type: "select",
					   class: "review-address-country",
					   values: function() {
						 return reference.countriesArray
					   }
					 }
					]
				  ]
				},


				{
				  header: "",
				  filter: {
					logic: "and",
					filters: [{
					  field: "Config_EndCxDetails",
					  operator: "neq",
					  value: "Y"
					}, {
					  field: "EndCx_Address_Country",
					  operator: "in",
					  value: ["Argentina", "Brazil", "Chile", "Colombia", "Mexico", "Peru", "Turkey", "Puerto Rico"]
					}]
				  },
				  group: [
					[{
					  label: "Form495",
					  data: "EndCx_NationalID",
					  required: true,
					  type: "text",
					  validation: ["nationalID", "minLen|1", "maxLen|14"],
					  typing: "nationalID",
					  class: "review-address-taxid"
					}]
				  ]
				},
				{
				  header: "",
				  filter: {
					logic: "and",
					filters: [{
					  field: "Config_EndCxDetails",
					  operator: "neq",
					  value: "Y"
					}, {
					  field: "EndCx_Address_Country",
					  operator: "nin",
					  value: ["Argentina", "Brazil", "Chile", "Colombia", "Mexico", "Peru", "Turkey", "Puerto Rico"]
					}]
				  },
				  group: [
					[{
					  label: "Form495",
					  data: "EndCx_NationalID",
					  required: false,
					  type: "text",
					  validation: ["nationalID", "minLen|1", "maxLen|14"],
					  typing: "nationalID",
					  class: "review-address-taxid"
					}]
				  ]
				},
				{
				  header: "Contact",
				  filter: {
					field: "Config_EndCxDetails_Contact",
					operator: "neq",
					value: "Y"
				  },
				  group: [
					[{
					  label: "FirstName",
					  data: "EndCx_Contact_FirstName",
					  required: false,
					  type: "text",
					  //placeholder: "Form149",
					  validation: ["kpDefault", "minLen|1"],
					  typing: "kpDefault",
					  class: "review-contact-firstname",
					},
					 {
					   label: "Surname",
					   data: "EndCx_Contact_LastName",
					   required: true,
					   type: "text",
					   //placeholder: "Form150",
					   validation: ["kpDefault", "minLen|1", "maxLen|60"],
					   typing: "kpDefault"
					 },
					 {
					   label: "Telephone",
					   data: "EndCx_Contact_Phone",
					   required: true,
					   type: "text",
					   //placeholder: "1-888-666-5555",
					   validation: ["typePhone", "minLen|8", "maxLen|18"],
					   typing: "typePhone"
					 },
					 {
					   label: "Email",
					   data: "EndCx_Contact_Email",
					   required: true,
					   type: "text",
					   //placeholder: "Form151",
					   validation: ["isEmail", "maxLen|96"],
					   typing: "typeEmail"
					 },
					 {
					   label: "CountryOfResidence",
					   data: "EndCx_Contact_Country",
					   required: true,
					   type: "select",
					   values: function() {
						 return reference.countriesArray
					   }
					 }
					]
				  ]
				}
			   ],
	callback: function() {
	  callbacks.page7();
	}
  };

  // RESELLER INFORMATION
  const page8 = {
	title: "Form126",
	subtitle: "Form127",
	description: "Form003",
	selectone: "SelectOne",
	continue: "Continue",
	submit: "Submit",
	back: "Back",
	no: "No",
	poformat: "POFormat",
	savedraft: "Form208",
	ready: false,
	nav: true,
	showOnReview: true,
	hideIfOnReview: true,
	addressPage: 'reseller',
	filter: {
	  logic: 'or',
	  filters: [
		{
		  logic: "and",
		  filters: [
			{
			  field: "PartnerBRT",
			  operator: "in",
			  value: ["Distributor", "OEM Distributor", "System Integrator"]
			},
			{
			  logic: "and",
			  filters: [
				{
				  logic: "or",
				  filters: [
					{
					  field: "Config_ResellerDetails",
					  operator: "neq",
					  value: "Y"
					},
					{
					  field: "Config_ResellerDetails_Contact",
					  operator: "neq",
					  value: "Y"
					}
				  ]
				},
			  ]
			},
			{
			  field: "PO_BusinessModel",
			  operator: "nin",
			  value: ["Agent Model", "HPFS & Agent Model"]
			},
			{
			  field: "PO_Category",
			  operator: "neq",
			  value: "Stock"
			}
		  ]
		},
		{
		  logic: "and",
		  filters: [
			{
			  field: "PartnerBRT",
			  operator: "eq",
			  value: "T1 Solution Provider"
			},
			{
			  field: "CountryCode",
			  operator: "eq",
			  value: "KR"
			},
			{
			  field: "PO_Category",
			  operator: "neq",
			  value: "Stock"
			}
		  ]
		}
	  ]
	},
	structure: [{
	  header: "Address",
	  filter: {
		logic: "and",
		filters: [{
		  field: "Config_ResellerDetails",
		  operator: "neq",
		  value: "Y"
		},
				  {
					field: "CountryCode",
					operator: "nin",
					value: ["HK", "MO"]
				  },
				 ]
	  },
	  group: [
		[{
		  label: "Form086",
		  data: "Reseller_PartyId",
		  required: false,
		  type: "text",
		  //placeholder: "Form057",
		  validation: ["kpDefault", "minLen|2", "maxLen|10", "noBlanksv2"],
		  typing: "kpDefault"
		}],
		[

		  {
			label: "Form058",
			data: "Reseller_CompanyName",
			required: true,
			type: "text",
			//placeholder: "Form129",
			validation: ["kpDefault", "minLen|2", "maxLen|140"],
			typing: "kpDefault"
		  },
		  {
			label: "Address",
			data: "Reseller_Address_Street",
			required: true,
			type: "text",
			//placeholder: "Form130",
			validation: ["kpDefault", "minLen|2", "maxLen|65"],
			typing: "kpDefault"
		  },
		  {
			label: "AddressLineOptional",
			data: "Reseller_Address_Street2",
			required: false,
			type: "text",
			//placeholder: "Form131",
			validation: ["kpDefault", "minLen|2", "maxLen|40"],
			typing: "kpDefault"
		  },
		  {
			label: "City",
			data: "Reseller_Address_City",
			required: true,
			type: "text",
			//placeholder: "Form132",
			validation: ["kpDefault", "minLen|2", "maxLen|35"],
			typing: "kpDefault"
		  },
		  {
			label: "StateProvince",
			data: "Reseller_Address_State",
			required: false,
			type: "text",
			//placeholder: "Form133",
			validation: ["kpDefault", "minLen|2"],
			typing: "kpDefault"
		  },
		  {
			label: "Postal code",
			data: "Reseller_Address_Postal",
			required: true,
			type: "text",
			//placeholder: "Form134",
			validation: ["kpDefault", "minLen|2", "maxLen|10"],
			typing: "kpDefault"
		  },
		  {
			label: "Country",
			data: "Reseller_Address_Country",
			required: true,
			type: "select",
			class: "review-address-country",
			values: function() {
			  return reference.countriesArray
			}
		  },
		]
	  ]
	},

				{
				  header: "Address",
				  filter: {
					logic: "and",
					filters: [{
					  field: "Config_ResellerDetails",
					  operator: "neq",
					  value: "Y"
					},
							  {
								field: "CountryCode",
								operator: "in",
								value: ["HK", "MO"]
							  },
							 ]
				  },
				  group: [
					[{
					  label: "Form086",
					  data: "Reseller_PartyId",
					  required: false,
					  type: "text",
					  //placeholder: "Form057",
					  validation: ["kpDefault", "minLen|2", "maxLen|10", "noBlanksv2"],
					  typing: "kpDefault"
					}],
					[

					  {
						label: "Form058",
						data: "Reseller_CompanyName",
						required: true,
						type: "text",
						//placeholder: "Form129",
						validation: ["kpDefault", "minLen|2", "maxLen|140"],
						typing: "kpDefault"
					  },
					  {
						label: "Address",
						data: "Reseller_Address_Street",
						required: true,
						type: "text",
						//placeholder: "Form130",
						validation: ["kpDefault", "minLen|2", "maxLen|65"],
						typing: "kpDefault"
					  },
					  {
						label: "AddressLineOptional",
						data: "Reseller_Address_Street2",
						required: false,
						type: "text",
						//placeholder: "Form131",
						validation: ["kpDefault", "minLen|2", "maxLen|40"],
						typing: "kpDefault"
					  },
					  {
						label: "City",
						data: "Reseller_Address_City",
						required: true,
						type: "text",
						//placeholder: "Form132",
						validation: ["kpDefault", "minLen|2", "maxLen|35"],
						typing: "kpDefault"
					  },
					  {
						label: "StateProvince",
						data: "Reseller_Address_State",
						required: false,
						type: "text",
						//placeholder: "Form133",
						validation: ["kpDefault", "minLen|2"],
						typing: "kpDefault"
					  },
					  {
						label: "Postal code",
						data: "Reseller_Address_Postal",
						required: false,
						type: "text",
						//placeholder: "Form134",
						validation: ["kpDefault", "minLen|2", "maxLen|10"],
						typing: "kpDefault"
					  },
					  {
						label: "Country",
						data: "Reseller_Address_Country",
						required: true,
						type: "select",
						class: "review-address-country",
						values: function() {
						  return reference.countriesArray
						}
					  },
					]
				  ]
				},


				{
				  header: "Contact",
				  filter: {
					field: "Config_ResellerDetails_Contact",
					operator: "neq",
					value: "Y"
				  },
				  group: [
					[{
					  label: "FirstName",
					  data: "Reseller_Contact_FirstName",
					  required: false,
					  type: "text",
					  //placeholder: "Form135",
					  validation: ["kpDefault", "minLen|1"],
					  typing: "kpDefault",
					  class: "review-contact-firstname",
					},
					 {
					   label: "Surname",
					   data: "Reseller_Contact_LastName",
					   required: true,
					   type: "text",
					   //placeholder: "Form136",
					   validation: ["kpDefault", "minLen|1", "maxLen|60"],
					   typing: "kpDefault"
					 },
					 {
					   label: "Telephone",
					   data: "Reseller_Contact_Phone",
					   required: false,
					   type: "text",
					   //placeholder: "1-888-666-5555",
					   validation: ["typePhone", "minLen|8", "maxLen|18"],
					   typing: "typePhone"
					 },
					 {
					   label: "Email",
					   data: "Reseller_Contact_Email",
					   required: true,
					   type: "text",
					   //placeholder: "Form137",
					   validation: ["isEmail", "maxLen|96"],
					   typing: "typeEmail"
					 },
					 {
					   label: "CountryOfResidence",
					   data: "Reseller_Contact_Country",
					   required: true,
					   type: "select",
					   values: function() {
						 return reference.countriesArray
					   }
					 }
					]
				  ]
				}
			   ],
	callback: function() {
	  callbacks.page8();
	}
  };

  // CUSTOM SHIP TO PARTY INFORMATION
  const page9 = {
	title: "Form486",
	subtitle: "Form487",
	description: "Form003",
	selectone: "SelectOne",
	continue: "Continue",
	submit: "Submit",
	back: "Back",
	no: "No",
	poformat: "POFormat",
	savedraft: "Form208",
	ready: false,
	nav: true,
	showOnReview: true,
	hideIfOnReview: true,
	filter: {
	  logic: "or",
	  filters: [{
		logic: "and",
		filters: [{
		  field: "SubRegion",
		  operator: "eq",
		  value: "Latin America"
		},
				  {
					field: "PO_DeliveryIncoterms",
					operator: "neq",
					value: "DDP"
				  }
				 ]
	  },
				{
				  logic: "and",
				  filters: [{
					field: "SubRegion",
					operator: "eq",
					value: "North America"
				  },
							{
							  field: "PO_DeliveryIncoterms",
							  operator: "neq",
							  value: "DDP"
							}
						   ]
				}
			   ]
	},
	structure: [{
	  header: "Address",
	  filter: {
		logic: "and",
		filters: [{
		  field: "CountryCode",
			operator: "nin",
			value: ["HK", "MO"]
		}, ]
	  },
	  group: [
		[{
		  label: "Form086",
		  data: "CustomShipTo_PartyId",
		  required: false,
		  type: "text",
		  //placeholder: "Form057",
		  validation: ["kpDefault", "minLen|2", "maxLen|10", "noBlanksv2"],
		  typing: "kpDefault"
		}],
		[{
		  label: "Form058",
		  data: "CustomShipTo_CompanyName",
		  required: true,
		  type: "text",
		  //placeholder: "Form489",
		  validation: ["kpDefault", "minLen|2", "maxLen|140"],
		  typing: "kpDefault"
		},
		 {
		   label: "Address",
		   data: "CustomShipTo_Address",
		   required: true,
		   type: "text",
		   //placeholder: "Form490",
		   validation: ["kpDefault", "minLen|2", "maxLen|65"],
		   typing: "kpDefault"
		 },
		 {
		   label: "AddressLineOptional",
		   data: "CustomShipTo_Address_Street2",
		   required: false,
		   type: "text",
		   //placeholder: "Form491",
		   validation: ["kpDefault", "minLen|2", "maxLen|40"],
		   typing: "kpDefault"
		 },
		 {
		   label: "City",
		   data: "CustomShipTo_Address_City",
		   required: true,
		   type: "text",
		   //placeholder: "Form492",
		   validation: ["kpDefault", "minLen|2", "maxLen|35"],
		   typing: "kpDefault"
		 },
		 {
		   label: "StateProvince",
		   data: "CustomShipTo_Address_State",
		   required: false,
		   type: "text",
		   //placeholder: "Form493",
		   validation: ["kpDefault", "minLen|2"],
		   typing: "kpDefault"
		 },
		 {
		   label: "Postal code",
		   data: "CustomShipTo_Address_Postal",
		   required: true,
		   type: "text",
		   //placeholder: "Form494",
		   validation: ["kpDefault", "minLen|2", "maxLen|10"],
		   typing: "kpDefault"
		 },
		 {
		   label: "Country",
		   data: "CustomShipTo_Address_Country",
		   required: true,
		   type: "select",
		   values: function() {
			 return reference.countriesArray
		   }
		 }
		]
	  ]
	}, {
	  header: "Address",
	  filter: {
		logic: "and",
		filters: [{
		  field: "CountryCode",
		  operator: "in",
		  value: ["HK", "MO"]
		}, ]
	  },
	  group: [
		[{
		  label: "Form086",
		  data: "CustomShipTo_PartyId",
		  required: false,
		  type: "text",
		  //placeholder: "Form057",
		  validation: ["kpDefault", "minLen|2", "maxLen|10", "noBlanksv2"],
		  typing: "kpDefault"
		}],
		[{
		  label: "Form058",
		  data: "CustomShipTo_CompanyName",
		  required: true,
		  type: "text",
		  //placeholder: "Form489",
		  validation: ["kpDefault", "minLen|2", "maxLen|140"],
		  typing: "kpDefault"
		},
		 {
		   label: "Address",
		   data: "CustomShipTo_Address",
		   required: true,
		   type: "text",
		   //placeholder: "Form490",
		   validation: ["kpDefault", "minLen|2", "maxLen|65"],
		   typing: "kpDefault"
		 },
		 {
		   label: "AddressLineOptional",
		   data: "CustomShipTo_Address_Street2",
		   required: false,
		   type: "text",
		   //placeholder: "Form491",
		   validation: ["kpDefault", "minLen|2", "maxLen|40"],
		   typing: "kpDefault"
		 },
		 {
		   label: "City",
		   data: "CustomShipTo_Address_City",
		   required: true,
		   type: "text",
		   //placeholder: "Form492",
		   validation: ["kpDefault", "minLen|2", "maxLen|35"],
		   typing: "kpDefault"
		 },
		 {
		   label: "StateProvince",
		   data: "CustomShipTo_Address_State",
		   required: false,
		   type: "text",
		   //placeholder: "Form493",
		   validation: ["kpDefault", "minLen|2"],
		   typing: "kpDefault"
		 },
		 {
		   label: "Postal code",
		   data: "CustomShipTo_Address_Postal",
		   required: false,
		   type: "text",
		   //placeholder: "Form494",
		   validation: ["kpDefault", "minLen|2", "maxLen|10"],
		   typing: "kpDefault"
		 },
		 {
		   label: "Country",
		   data: "CustomShipTo_Address_Country",
		   required: true,
		   type: "select",
		   values: function() {
			 return reference.countriesArray
		   }
		 }
		]
	  ]
	}],
	callback: function() {
	  callbacks.page9();
	}
  };

  // AGENT PROGRAM INFORMATION
  const page10 = {
	title: "Form500",
	subtitle: "Form501",
	description: "Form003",
	selectone: "SelectOne",
	continue: "Continue",
	submit: "Submit",
	back: "Back",
	no: "No",
	poformat: "POFormat",
	savedraft: "Form208",
	ready: false,
	nav: true,
	showOnReview: true,
	hideIfOnReview: true,
	filter: {
	  logic: "and",
	  filters: [{
		logic: "or",
		filters: [{
		  field: "PartnerBRT",
		  operator: "eq",
		  value: "Distributor"
		},
				  {
					field: "PartnerBRT",
					operator: "eq",
					value: "OEM Distributor"
				  },
				  {
					field: "PartnerBRT",
					operator: "eq",
					value: "System Integrator"
				  }
				 ]
	  },
				{
				  logic: "or",
				  filters: [{
					field: "PO_BusinessModel",
					operator: "eq",
					value: "Agent Model"
				  },
							{
							  field: "PO_BusinessModel",
							  operator: "eq",
							  value: "HPFS & Agent Model"
							}
						   ]
				}
			   ]
	},
	structure: [{
	  header: "Address",
	  filter: {
		logic: "and",
		filters: [{
		  field: "CountryCode",
		  operator: "nin",
		  value: ["HK", "MO"]
		}, ]
	  },
	  group: [
		[{
		  label: "Form086",
		  data: "AgentProgram_PartyId",
		  required: false,
		  type: "text",
		  //placeholder: "Form057",
		  validation: ["kpDefault", "minLen|2", "maxLen|10", "noBlanksv2"],
		  typing: "kpDefault"
		}],
		[{
		  label: "Form058",
		  data: "AgentProgram_CompanyName",
		  required: true,
		  type: "text",
		  //placeholder: "Form503",
		  validation: ["kpDefault", "minLen|2", "maxLen|140"],
		  typing: "kpDefault"
		},
		 {
		   label: "Address",
		   data: "AgentProgram_Address",
		   required: true,
		   type: "text",
		   //placeholder: "Form504",
		   validation: ["kpDefault", "minLen|2", "maxLen|65"],
		   typing: "kpDefault"
		 },
		 {
		   label: "AddressLineOptional",
		   data: "AgentProgram_Address_Street2",
		   required: false,
		   type: "text",
		   //placeholder: "Form505",
		   validation: ["kpDefault", "minLen|2", "maxLen|40"],
		   typing: "kpDefault"
		 },
		 {
		   label: "City",
		   data: "AgentProgram_Address_City",
		   required: true,
		   type: "text",
		   //placeholder: "Form506",
		   validation: ["kpDefault", "minLen|2", "maxLen|35"],
		   typing: "kpDefault"
		 },
		 {
		   label: "StateProvince",
		   data: "AgentProgram_Address_State",
		   required: false,
		   type: "text",
		   //placeholder: "Form507",
		   validation: ["kpDefault", "minLen|2"],
		   typing: "kpDefault"
		 },
		 {
		   label: "Postal code",
		   data: "AgentProgram_Address_Postal",
		   required: true,
		   type: "text",
		   //placeholder: "Form508",
		   validation: ["kpDefault", "minLen|2", "maxLen|10"],
		   typing: "kpDefault"
		 },
		 {
		   label: "Country",
		   data: "AgentProgram_Address_Country",
		   required: true,
		   type: "select",
		   values: function() {
			 return reference.countriesArray
		   }
		 }
		]
	  ]
	}, {
	  header: "Address",
	  filter: {
		logic: "and",
		filters: [{
		  field: "CountryCode",
		  operator: "in",
		  value: ["HK", "MO"]
		}, ]
	  },
	  group: [
		[{
		  label: "Form086",
		  data: "AgentProgram_PartyId",
		  required: false,
		  type: "text",
		  //placeholder: "Form057",
		  validation: ["kpDefault", "minLen|2", "maxLen|10", "noBlanksv2"],
		  typing: "kpDefault"
		}],
		[{
		  label: "Form058",
		  data: "AgentProgram_CompanyName",
		  required: true,
		  type: "text",
		  //placeholder: "Form503",
		  validation: ["kpDefault", "minLen|2", "maxLen|140"],
		  typing: "kpDefault"
		},
		 {
		   label: "Address",
		   data: "AgentProgram_Address",
		   required: true,
		   type: "text",
		   //placeholder: "Form504",
		   validation: ["kpDefault", "minLen|2", "maxLen|65"],
		   typing: "kpDefault"
		 },
		 {
		   label: "AddressLineOptional",
		   data: "AgentProgram_Address_Street2",
		   required: false,
		   type: "text",
		   //placeholder: "Form505",
		   validation: ["kpDefault", "minLen|2", "maxLen|40"],
		   typing: "kpDefault"
		 },
		 {
		   label: "City",
		   data: "AgentProgram_Address_City",
		   required: true,
		   type: "text",
		   //placeholder: "Form506",
		   validation: ["kpDefault", "minLen|2", "maxLen|35"],
		   typing: "kpDefault"
		 },
		 {
		   label: "StateProvince",
		   data: "AgentProgram_Address_State",
		   required: false,
		   type: "text",
		   //placeholder: "Form507",
		   validation: ["kpDefault", "minLen|2"],
		   typing: "kpDefault"
		 },
		 {
		   label: "Postal code",
		   data: "AgentProgram_Address_Postal",
		   required: false,
		   type: "text",
		   //placeholder: "Form508",
		   validation: ["kpDefault", "minLen|2", "maxLen|10"],
		   typing: "kpDefault"
		 },
		 {
		   label: "Country",
		   data: "AgentProgram_Address_Country",
		   required: true,
		   type: "select",
		   values: function() {
			 return reference.countriesArray
		   }
		 }
		]
	  ]
	}],
	callback: function() {
	  callbacks.page10();
	}
  };

  // ASSET LOCATION & ENTITLED PARTY & SYSTEM MANAGER
  const page11 = {
	title: "Form152",
	subtitle: "Form153",
	description: "Form003",
	selectone: "SelectOne",
	continue: "Continue",
	submit: "Submit",
	back: "Back",
	no: "No",
	poformat: "POFormat",
  poformatjp: "POFormatJP",
	savedraft: "Form208",
	ready: false,
	nav: true,
	showOnReview: false,
	structure: [
	  // optional attachment
	  {
		header: "FormCFI08",
    filter: {
      logic: "and",
      filters: [{
        field: "CountryCode",
        operator: "neq",
        value: "JP"
      }],
    },  
		group: [
		  [{
			label: "FormCFI06",
			data: "Optional_Attachment",
			type: "kUpload",
			required: false,
			uploadConfig: {
			  formId: 989,
			  extensions: [".pdf", ".zip", ".xlxs", ".xls", ".xlsx", ".xlsm", ".doc", ".docx", ".msg"],
			  maxFileSize: 4
			}
		  }],
		]
	  },
    // optional attachment Japan
    {
      header: "FormCFI08",
      filter: {
        logic: "and",
        filters: [{
          field: "CountryCode",
          operator: "eq",
          value: "JP"
        }],
      },
      group: [
        [{
          label: "FormCFI06",
          data: "Optional_Attachment",
          type: "kUpload",
          required: false,
          uploadConfig: {
            formId: 989,
            extensions: [".pdf", ".zip", ".xlxs", ".xlsx", ".xls", ".doc", ".docx"],
            maxFileSize: 18
          }
        }],
      ]
    },
	  /*  {
          filter: {
            field: "PO_Category",
            operator: "neq",
            value: "Stock"
          },
          header: "FormCFI07",
          group: [
            [{
              label: "Form052",
              data: "Config_LocationDetails",
              value: "Y",
              required: false,
              type: "toggle",
              values: ["N", "Y"],
              options: ["No", "Yes"]
            },
             {
               label: "Form053",
               data: "Config_EntitledDetails",
               value: "Y",
               required: false,
               type: "toggle",
               values: ["N", "Y"],
               options: ["No", "Yes"]
             },
             {
               label: "Form528",
               data: "Config_PSP",
               required: false,
               type: "toggle",
               values: ["N", "Y"],
               options: ["No", "Yes"]
             }
            ]
          ]
        }*/
	  // INVOICE, RESERVATION, LOID, PLEDGING
	  {
		header: "Form154",
		description: "Form155",
		group: [
		  [{
			label: "Form156",
			data: "Config_PI",
			required: false,
			type: "toggle",
			values: ["N", "Y"],
			options: ["No", "Yes"]
		  }]
		]

	  },
	  {
		filter: {
		  field: "Config_PI",
		  operator: "eq",
		  value: "Y"
		},
		group: [
		  [{
			label: "Form157",
			data: "Config_SystemManager",
			required: false,
			type: "toggle",
			values: ["N", "Y"],
			options: ["No", "Yes"]
		  }]
		]

	  },
	  // SYSTEM MANAGER
	  {
		header: "Form158",
		filter: {
		  field: "Config_SystemManager",
		  operator: "eq",
		  value: "Y"
		},
		//description: "Form159",
		group: [
		  [{
			label: "FirstName",
			data: "EndCx_SysMng_FirstName",
			required: false,
			type: "text",
			//placeholder: "Form160",
			validation: ["kpDefault", "minLen|1"],
			typing: "kpDefault"
		  },
		   {
			 label: "LastName",
			 data: "EndCx_SysMng_LastName",
			 required: true,
			 type: "text",
			 //placeholder: "Form161",
			 validation: ["kpDefault", "minLen|1", "maxLen|60"],
			 typing: "kpDefault"
		   },
		   {
			 label: "Telephone",
			 data: "EndCx_SysMng_Phone",
			 required: true,
			 type: "text",
			 //placeholder: "1-888-666-5555",
			 validation: ["typePhone", "minLen|8", "maxLen|18"],
			 typing: "typePhone"
		   },
		   {
			 label: "Email",
			 data: "EndCx_SysMng_Email",
			 required: true,
			 type: "text",
			 //placeholder: "Form162",
			 validation: ["isEmail", "maxLen|96"],
			 typing: "typeEmail"
		   },
		   {
			 label: "CountryOfResidence",
			 data: "EndCx_SysMng_Country",
			 required: false,
			 type: "select",
			 values: function() {
			   return reference.countriesArray
			 }
		   }
		  ]
		]
	  },
	  // REMARKETING DETAILS
	  {
		/*header: "Remarketing details",
                  description: "Provide additional information, if available, for orders containing remarketing products",*/
		group: [
		  [{
			label: "Form163",
			data: "Config_ResId",
			required: false,
			type: "text",
			placeholder: "Form164",
			validation: ["alphanumeric", "minLen|1", "maxLen|30", "noBlanksv2"],
			typing: "alphanumeric"
		  },
		   {
			 label: "Form165",
			 data: "Config_LOID",
			 required: false,
			 type: "text",
			 placeholder: "Form166",
			 validation: ["alphanumeric", "minLen|1", "maxLen|30", "noBlanksv2"],
			 typing: "alphanumeric"
		   }
		  ]
		]
	  },
	  {
		/*header: "Remarketing details",
                  description: "Provide additional information, if available, for orders containing remarketing products",*/
		filter: {
		  field: "Region",
		  operator: "eq",
		  value: "EMEA"
		},
		group: [
		  [{
			label: "Form454",
			data: "Config_LogCode",
			required: false,
			type: "multiselect",
			values: ["AI", "AX", "BX", "CX", "I2", "L5", "PZ", "S5", "S7", "SH", "SW", "SY", "XA", "XP", "YX", "ZX"],
			options: ["Form454_Option1", "Form454_Option2", "Form454_Option3", "Form454_Option4", "Form454_Option5", "Form454_Option6", "Form454_Option7", "Form454_Option8", "Form454_Option9", "Form454_Option10", "Form454_Option11", "Form454_Option12", "Form454_Option13", "Form454_Option14", "Form454_Option15", "Form454_Option16"]
		  }]
		]
	  },
	  {
		group: [
		  [{
			label: "Form481",
			data: "Config_PublicSectionPartner",
			required: false,
			type: "toggle",
			values: ["N", "Y"],
			options: ["No", "Yes"]
		  }]
		]
	  },
	  {
		filter: {
		  logic: "and",
		  filters: [{
			field: "CountryCode",
			operator: "eq",
			value: "IT"
		  },
					{
					  field: "Config_PublicSectionPartner",
					  operator: "eq",
					  value: "Y"
					}
				   ]
		},
		group: [
		  [{
			label: "Form482",
			data: "Config_CIG",
			required: true,
			type: "text",
			placeholder: "Form483",
			validation: ["kpDefault", "minLen|1", "maxLen|40"],
			typing: "kpDefault"
		  },
		   {
			 label: "Form484",
			 data: "Config_CUP",
			 required: true,
			 type: "text",
			 placeholder: "Form485",
			 validation: ["kpDefault", "minLen|1", "maxLen|40"],
			 typing: "kpDefault"
		   }
		  ]
		]
	  },
	  // ASSET LOCATION
	  {
		/*	filter: {
            logic: "and",
            filters: [{
              logic: "or",
              filters: [{
                field: "Geo",
                operator: "in",
                value: ["CERTA", "CETA", "MESA", "Latin America", "North America"]
              },
                        {
                          field: "CountryCode",
                          operator: "in",
                          value: ["IL", "GR"]
                        }
                       ]
            }]
          },*/
		header: "FormCFI07",
		description: "",
		group: [
		  [{
			label: "Form052",
			data: "Config_LocationDetails",
			value: "Y",
			required: false,
			type: "toggle",
			values: ["N", "Y"],
			options: ["No", "Yes"]
		  }]
		]
	  },
	  {
		header: "",
		description: "",
		header: "Form167",
		description: "Form168",
		filter: {
		  logic: "and",
		  filters: [{
			logic: "or",
			filters: [{
			  field: "Geo",
			  operator: "in",
			  value: ["CERTA", "CETA", "MESA", "Latin America", "North America"]
			},
					  {
						field: "CountryCode",
						operator: "in",
						value: ["IL", "GR"]
					  }
					 ]
		  },
					{
					  field: "Config_LocationDetails",
					  operator: "neq",
					  value: "Y"
					}
				   ]
		},
		group: [
		  [{
			label: "Form086",
			data: "AssLoc_PartyId",
			required: false,
			type: "text",
			//placeholder: "Form057",
			validation: ["kpDefault", "minLen|2", "maxLen|10", "noBlanksv2"],
			typing: "kpDefault"
		  }],
		  [{
			label: "Form058",
			data: "AssLoc_CompanyName",
			required: false,
			type: "text",
			//placeholder: "Form169",
			validation: ["kpDefault", "minLen|2", "maxLen|140"],
			typing: "kpDefault"
		  },
		   {
			 label: "Address",
			 data: "AssLoc_Address_Street",
			 required: false,
			 type: "text",
			 //placeholder: "Form170",
			 validation: ["kpDefault", "minLen|2", "maxLen|65"],
			 typing: "kpDefault"
		   },
		   {
			 label: "AddressLineOptional",
			 data: "AssLoc_Address_Street2",
			 required: false,
			 type: "text",
			 //placeholder: "Form171",
			 validation: ["kpDefault", "minLen|2", "maxLen|40"],
			 typing: "kpDefault"
		   },
		   {
			 label: "City",
			 data: "AssLoc_Address_City",
			 required: false,
			 type: "text",
			 //placeholder: "Form172",
			 validation: ["kpDefault", "minLen|2", "maxLen|35"],
			 typing: "kpDefault"
		   },
		   {
			 label: "StateProvince",
			 data: "AssLoc_Address_State",
			 required: false,
			 type: "text",
			 //placeholder: "Form173",
			 validation: ["kpDefault", "minLen|2"],
			 typing: "kpDefault"
		   },
		   {
			 label: "Postal code",
			 data: "AssLoc_Address_Postal",
			 required: false,
			 type: "text",
			 //placeholder: "Form174",
			 validation: ["kpDefault", "minLen|2", "maxLen|10"],
			 typing: "kpDefault"
		   },
		   {
			 label: "Country",
			 data: "AssLoc_Address_Country",
			 required: false,
			 type: "select",
			 values: function() {
			   return reference.countriesArray
			 }
		   }
		  ]
		]
	  },
	  {
		header: "Form167",
		description: "Form168",
		filter: {
		  logic: "and",
		  filters: [{
			field: "Geo",
			operator: "nin",
			value: ["CERTA", "CETA", "MESA", "Latin America", "North America"]
		  },
					{
					  field: "CountryCode",
					  operator: "nin",
					  value: ["IL", "GR"]
					},
					{
					  field: "Config_LocationDetails",
					  operator: "neq",
					  value: "Y"
					}
				   ]
		},
		group: [
		  [{
			label: "Form086",
			data: "AssLoc_PartyId",
			required: false,
			type: "text",
			//placeholder: "Form057",
			validation: ["kpDefault", "minLen|2", "maxLen|10", "noBlanksv2"],
			typing: "kpDefault"
		  }],
		  [{
			label: "Form058",
			data: "AssLoc_CompanyName",
			required: false,
			type: "text",
			//placeholder: "Form169",
			validation: ["kpDefault", "minLen|2", "maxLen|140"],
			typing: "kpDefault"
		  },
		   {
			 label: "Address",
			 data: "AssLoc_Address_Street",
			 required: false,
			 type: "text",
			 //placeholder: "Form170",
			 validation: ["kpDefault", "minLen|2", "maxLen|65"],
			 typing: "kpDefault"
		   },
		   {
			 label: "AddressLineOptional",
			 data: "AssLoc_Address_Street2",
			 required: false,
			 type: "text",
			 //placeholder: "Form171",
			 validation: ["kpDefault", "minLen|2", "maxLen|40"],
			 typing: "kpDefault"
		   },
		   {
			 label: "City",
			 data: "AssLoc_Address_City",
			 required: false,
			 type: "text",
			 //placeholder: "Form172",
			 validation: ["kpDefault", "minLen|2", "maxLen|35"],
			 typing: "kpDefault"
		   },
		   {
			 label: "StateProvince",
			 data: "AssLoc_Address_State",
			 required: false,
			 type: "text",
			 //placeholder: "Form173",
			 validation: ["kpDefault", "minLen|2"],
			 typing: "kpDefault"
		   },
		   {
			 label: "Postal code",
			 data: "AssLoc_Address_Postal",
			 required: false,
			 type: "text",
			 //placeholder: "Form174",
			 validation: ["kpDefault", "minLen|2", "maxLen|10"],
			 typing: "kpDefault"
		   },
		   {
			 label: "Country",
			 data: "AssLoc_Address_Country",
			 required: false,
			 type: "select",
			 values: function() {
			   return reference.countriesArray
			 }
		   }
		  ]
		]
	  },
	  // ENTITLED PARTY
	  {
		/*	filter: {
            logic: "and",
            filters: [{
              logic: "or",
              filters: [{
                field: "Geo",
                operator: "in",
                value: ["CERTA", "CETA", "MESA", "Latin America", "North America"]
              },
                        {
                          field: "CountryCode",
                          operator: "in",
                          value: ["IL", "GR"]
                        }
                       ]
            }]
          },*/
		header: "",
		description: "",
		group: [
		  [{
			label: "Form053",
			data: "Config_EntitledDetails",
			value: "Y",
			required: false,
			type: "toggle",
			values: ["N", "Y"],
			options: ["No", "Yes"]
		  }]
		]
	  },
	  {
		header: "Form175",
		description: "Form176",
		filter: {
		  logic: "and",
		  filters: [{
			logic: "or",
			filters: [{
			  field: "Geo",
			  operator: "in",
			  value: ["CERTA", "CETA", "MESA", "Latin America", "North America"]
			},
					  {
						field: "CountryCode",
						operator: "in",
						value: ["IL", "GR"]
					  }
					 ]
		  },
					{
					  field: "Config_EntitledDetails",
					  operator: "neq",
					  value: "Y"
					}
				   ]
		},
		group: [
		  [{
			label: "Form086",
			data: "EntPrty_PartyId",
			required: false,
			type: "text",
			//placeholder: "Form057",
			validation: ["kpDefault", "minLen|2", "maxLen|10", "noBlanksv2"],
			typing: "kpDefault"
		  }],
		  [{
			label: "Form058",
			data: "EntPrty_CompanyName",
			required: false,
			type: "text",
			//placeholder: "Form177",
			validation: ["kpDefault", "minLen|2", "maxLen|140"],
			typing: "kpDefault"
		  },
		   {
			 label: "Address",
			 data: "EntPrty_Address_Street",
			 required: false,
			 type: "text",
			 //placeholder: "Form175",
			 validation: ["kpDefault", "minLen|2", "maxLen|65"],
			 typing: "kpDefault"
		   },
		   {
			 label: "AddressLineOptional",
			 data: "EntPrty_Address_Street2",
			 required: false,
			 type: "text",
			 //placeholder: "Form178",
			 validation: ["kpDefault", "minLen|2", "maxLen|40"],
			 typing: "kpDefault"
		   },
		   {
			 label: "City",
			 data: "EntPrty_Address_City",
			 required: false,
			 type: "text",
			 //placeholder: "Form179",
			 validation: ["kpDefault", "minLen|2", "maxLen|35"],
			 typing: "kpDefault"
		   },
		   {
			 label: "StateProvince",
			 data: "EntPrty_Address_State",
			 required: false,
			 type: "text",
			 //placeholder: "Form180",
			 validation: ["kpDefault", "minLen|2"],
			 typing: "kpDefault"
		   },
		   {
			 label: "Postal code",
			 data: "EntPrty_Address_Postal",
			 required: false,
			 type: "text",
			 //placeholder: "Form181",
			 validation: ["kpDefault", "minLen|2", "maxLen|10"],
			 typing: "kpDefault"
		   },
		   {
			 label: "Country",
			 data: "EntPrty_Address_Country",
			 required: false,
			 type: "select",
			 values: function() {
			   return reference.countriesArray
			 }
		   }
		  ]
		]
	  },
	  {
		header: "Form175",
		description: "Form176",
		filter: {
		  logic: "and",
		  filters: [{
			field: "Geo",
			operator: "nin",
			value: ["CERTA", "CETA", "MESA", "Latin America", "North America"]
		  },
					{
					  field: "CountryCode",
					  operator: "nin",
					  value: ["IL", "GR"]
					},
					{
					  field: "Config_EntitledDetails",
					  operator: "neq",
					  value: "Y"
					}
				   ]
		},
		group: [
		  [{
			label: "Form086",
			data: "EntPrty_PartyId",
			required: false,
			type: "text",
			//placeholder: "Form057",
			validation: ["kpDefault", "minLen|2", "maxLen|10", "noBlanksv2"],
			typing: "kpDefault"
		  }],
		  [{
			label: "Form058",
			data: "EntPrty_CompanyName",
			required: false,
			type: "text",
			//placeholder: "Form177",
			validation: ["kpDefault", "minLen|2", "maxLen|140"],
			typing: "kpDefault"
		  },
		   {
			 label: "Address",
			 data: "EntPrty_Address_Street",
			 required: false,
			 type: "text",
			 //placeholder: "Form175",
			 validation: ["kpDefault", "minLen|2", "maxLen|65"],
			 typing: "kpDefault"
		   },
		   {
			 label: "AddressLineOptional",
			 data: "EntPrty_Address_Street2",
			 required: false,
			 type: "text",
			 //placeholder: "Form178",
			 validation: ["kpDefault", "minLen|2", "maxLen|40"],
			 typing: "kpDefault"
		   },
		   {
			 label: "City",
			 data: "EntPrty_Address_City",
			 required: false,
			 type: "text",
			 //placeholder: "Form179",
			 validation: ["kpDefault", "minLen|2", "maxLen|35"],
			 typing: "kpDefault"
		   },
		   {
			 label: "StateProvince",
			 data: "EntPrty_Address_State",
			 required: false,
			 type: "text",
			 //placeholder: "Form180",
			 validation: ["kpDefault", "minLen|2"],
			 typing: "kpDefault"
		   },
		   {
			 label: "Postal code",
			 data: "EntPrty_Address_Postal",
			 required: false,
			 type: "text",
			 //placeholder: "Form181",
			 validation: ["kpDefault", "minLen|2", "maxLen|10"],
			 typing: "kpDefault"
		   },
		   {
			 label: "Country",
			 data: "EntPrty_Address_Country",
			 required: false,
			 type: "select",
			 values: function() {
			   return reference.countriesArray
			 }
		   }
		  ]
		]
	  },
	  {
		header: "Form182",
		filter: {
		  logic: "and",
		  filters: [{
			field: "Config_EntitledDetails",
			operator: "neq",
			value: "Y"
		  }]
		},
		group: [
		  [{
			label: "FirstName",
			data: "EntPrty_Contact_FirstName",
			required: false,
			type: "text",
			//placeholder: "Form183",
			validation: ["kpDefault", "minLen|1"],
			typing: "kpDefault"
		  },
		   {
			 label: "Surname",
			 data: "EntPrty_Contact_LastName",
			 required: false,
			 type: "text",
			 //placeholder: "Form184",
			 validation: ["kpDefault", "minLen|1", "maxLen|60"],
			 typing: "kpDefault"
		   },
		   {
			 label: "Telephone",
			 data: "EntPrty_Contact_Phone",
			 required: false,
			 type: "text",
			 //placeholder: "1-888-666-5555",
			 validation: ["typePhone", "minLen|8", "maxLen|18"],
			 typing: "typePhone"
		   },
		   {
			 label: "Email",
			 data: "EntPrty_Contact_Email",
			 required: false,
			 type: "text",
			 //placeholder: "Form185",
			 validation: ["isEmail", "maxLen|96"],
			 typing: "typeEmail"
		   },
		   {
			 label: "CountryOfResidence",
			 data: "EntPrty_Contact_Country",
			 required: false,
			 type: "select",
			 values: function() {
			   return reference.countriesArray
			 }
		   }
		  ]
		]
	  },
	  {
		header: "",
		description: "",
		/*	filter: {
            logic: "and",
            filters: [{
              logic: "or",
              filters: [{
                field: "Geo",
                operator: "in",
                value: ["CERTA", "CETA", "MESA", "Latin America", "North America"]
              },
                        {
                          field: "CountryCode",
                          operator: "in",
                          value: ["IL", "GR"]
                        }
                       ]
            }]
          },*/
		group: [
		  [{
			label: "Form528",
			data: "Config_PSP",
			required: false,
			type: "toggle",
			values: ["N", "Y"],
			options: ["No", "Yes"]
		  }]
		]
	  },
	  {
		//header: "Form167",
		//description: "Form168",
		header: "Form529",
		description: "FormCFI09",
		filter: {
		  logic: "and",
		  filters: [{
			logic: "or",
			filters: [{
			  field: "Geo",
			  operator: "in",
			  value: ["CERTA", "CETA", "MESA", "Latin America", "North America"]
			},
					  {
						field: "CountryCode",
						operator: "in",
						value: ["IL", "GR"]
					  }
					 ]
		  },
					{
					  field: "Config_PSP",
					  operator: "eq",
					  value: "Y"
					}
				   ]
		},
		group: [
		  [{
			label: "Form086",
			data: "PSP_PartyId",
			required: false,
			type: "text",
			//placeholder: "Form057",
			validation: ["kpDefault", "minLen|2", "maxLen|10", "noBlanksv2"],
			typing: "kpDefault"
		  }],
		  [{
			label: "Form058",
			data: "PSP_CompanyName",
			required: false,
			type: "text",
			//placeholder: "Form169",
			validation: ["kpDefault", "minLen|2", "maxLen|140"],
			typing: "kpDefault"
		  },
		   {
			 label: "Address",
			 data: "PSP_Address_Street",
			 required: false,
			 type: "text",
			 //placeholder: "Form170",
			 validation: ["kpDefault", "minLen|2", "maxLen|65"],
			 typing: "kpDefault"
		   },
		   {
			 label: "AddressLineOptional",
			 data: "PSP_Address_Street2",
			 required: false,
			 type: "text",
			 //placeholder: "Form171",
			 validation: ["kpDefault", "minLen|2", "maxLen|40"],
			 typing: "kpDefault"
		   },
		   {
			 label: "City",
			 data: "PSP_Address_City",
			 required: false,
			 type: "text",
			 //placeholder: "Form172",
			 validation: ["kpDefault", "minLen|2", "maxLen|35"],
			 typing: "kpDefault"
		   },
		   {
			 label: "StateProvince",
			 data: "PSP_Address_State",
			 required: false,
			 type: "text",
			 //placeholder: "Form173",
			 validation: ["kpDefault", "minLen|2"],
			 typing: "kpDefault"
		   },
		   {
			 label: "Postal code",
			 data: "PSP_Address_Postal",
			 required: false,
			 type: "text",
			 //placeholder: "Form174",
			 validation: ["kpDefault", "minLen|2", "maxLen|10"],
			 typing: "kpDefault"
		   },
		   {
			 label: "Country",
			 data: "PSP_Address_Country",
			 required: false,
			 type: "select",
			 values: function() {
			   return reference.countriesArray
			 }
		   }
		  ]
		]
	  },
	  {
		header: "Form529",
		description: "FormCFI09",
		filter: {
		  logic: "and",
		  filters: [{
			field: "Geo",
			operator: "nin",
			value: ["CERTA", "CETA", "MESA", "Latin America", "North America"]
		  },
					{
					  field: "CountryCode",
					  operator: "nin",
					  value: ["IL", "GR"]
					},
					{
					  field: "Config_PSP",
					  operator: "eq",
					  value: "Y"
					}
				   ]
		},
		group: [
		  [{
			label: "Form086",
			data: "PSP_PartyId",
			required: false,
			type: "text",
			//placeholder: "Form057",
			validation: ["kpDefault", "minLen|2", "maxLen|10", "noBlanksv2"],
			typing: "kpDefault"
		  }],
		  [{
			label: "Form058",
			data: "PSP_CompanyName",
			required: false,
			type: "text",
			//placeholder: "Form169",
			validation: ["kpDefault", "minLen|2", "maxLen|140"],
			typing: "kpDefault"
		  },
		   {
			 label: "Address",
			 data: "PSP_Address_Street",
			 required: false,
			 type: "text",
			 //placeholder: "Form170",
			 validation: ["kpDefault", "minLen|2", "maxLen|65"],
			 typing: "kpDefault"
		   },
		   {
			 label: "AddressLineOptional",
			 data: "PSP_Address_Street2",
			 required: false,
			 type: "text",
			 //placeholder: "Form171",
			 validation: ["kpDefault", "minLen|2", "maxLen|40"],
			 typing: "kpDefault"
		   },
		   {
			 label: "City",
			 data: "PSP_Address_City",
			 required: false,
			 type: "text",
			 //placeholder: "Form172",
			 validation: ["kpDefault", "minLen|2", "maxLen|35"],
			 typing: "kpDefault"
		   },
		   {
			 label: "StateProvince",
			 data: "PSP_Address_State",
			 required: false,
			 type: "text",
			 //placeholder: "Form173",
			 validation: ["kpDefault", "minLen|2"],
			 typing: "kpDefault"
		   },
		   {
			 label: "Postal code",
			 data: "PSP_Address_Postal",
			 required: false,
			 type: "text",
			 //placeholder: "Form174",
			 validation: ["kpDefault", "minLen|2", "maxLen|10"],
			 typing: "kpDefault"
		   },
		   {
			 label: "Country",
			 data: "PSP_Address_Country",
			 required: false,
			 type: "select",
			 values: function() {
			   return reference.countriesArray
			 }
		   }
		  ]
		]
	  },
	  {
		header: "",
		description: "",
		filter: {
		  field: "CountryCode",
		  operator: "eq",
		  value: "JP",
		},
		group: [
		  [{
			label: "Form240",
			data: "Config_ALI",
			required: false,
			type: "toggle",
			values: ["N", "Y"],
			options: ["No", "Yes"]
		  }]
		]
	  },
	  {
		header: "Form241",
		description: "",
		filter: {
		  logic: "and",
		  filters: [{
			field: "CountryCode",
			operator: "eq",
			value: "JP"
		  },
					{
					  field: "Config_ALI",
					  operator: "eq",
					  value: "Y"
					}
				   ]
		},
		group: [
		  [{
			label: "Form086",
			data: "ALI_PartyId",
			required: false,
			type: "text",
			validation: ["kpDefault", "minLen|2", "maxLen|10", "noBlanksv2"],
			typing: "kpDefault"
		  }],
		  [{
			label: "Form058",
			data: "ALI_CompanyName",
			required: false,
			type: "text",
			validation: ["kpDefault", "minLen|2", "maxLen|140"],
			typing: "kpDefault"
		  },
		   {
			 label: "Address",
			 data: "ALI_Address_Street",
			 required: false,
			 type: "text",
			 validation: ["kpDefault", "minLen|2", "maxLen|65"],
			 typing: "kpDefault"
		   },
		   {
			 label: "AddressLineOptional",
			 data: "ALI_Address_Street2",
			 required: false,
			 type: "text",
			 validation: ["kpDefault", "minLen|2", "maxLen|40"],
			 typing: "kpDefault"
		   },
		   {
			 label: "City",
			 data: "ALI_Address_City",
			 required: false,
			 type: "text",
			 validation: ["kpDefault", "minLen|2", "maxLen|35"],
			 typing: "kpDefault"
		   },
		   {
			 label: "StateProvince",
			 data: "ALI_Address_State",
			 required: false,
			 type: "text",
			 validation: ["kpDefault", "minLen|2"],
			 typing: "kpDefault"
		   },
		   {
			 label: "Postal code",
			 data: "ALI_Address_Postal",
			 required: false,
			 type: "text",
			 validation: ["kpDefault", "minLen|2", "maxLen|10"],
			 typing: "kpDefault"
		   },
		   {
			 label: "Country",
			 data: "ALI_Address_Country",
			 required: false,
			 type: "select",
			 values: function() {
			   return reference.countriesArray
			 }
		   }
		  ],
		  [{
			label: "FirstName",
			data: "ALI_Contact_FirstName",
			required: false,
			type: "text",
			validation: ["kpDefault", "minLen|1"],
			typing: "kpDefault"
		  },
		   {
			 label: "Surname",
			 data: "ALI_Contact_LastName",
			 required: false,
			 type: "text",
			 validation: ["kpDefault", "minLen|1", "maxLen|60"],
			 typing: "kpDefault"
		   },
		   {
			 label: "Telephone",
			 data: "ALI_Contact_Phone",
			 required: false,
			 type: "text",
			 validation: ["typePhone", "minLen|8", "maxLen|18"],
			 typing: "typePhone"
		   },
		   {
			 label: "Email",
			 data: "ALI_Contact_Email",
			 required: false,
			 type: "text",
			 validation: ["isEmail", "maxLen|96"],
			 typing: "typeEmail"
		   },
		   {
			 label: "CountryOfResidence",
			 data: "ALI_Contact_Country",
			 required: false,
			 type: "select",
			 values: function() {
			   return reference.countriesArray
			 }
		   }
		  ]
		]
	  },
	  {
		header: "Form243",
		description: "",
		filter: {
		  field: "CountryCode",
		  operator: "eq",
		  value: "JP"
		},
		group: [
		  [{
			label: "Form242",
			data: "Config_CombinedOrder",
			required: false,
			type: "toggle",
			values: ["N", "Y"],
			options: ["No", "Yes"]
		  }]
		]
	  },
	  {
		header: "",
		description: "",
		filter: {
		  logic: "and",
		  filters: [{
			field: "CountryCode",
			operator: "eq",
			value: "JP"
		  },
					{
					  field: "Config_CombinedOrder",
					  operator: "eq",
					  value: "Y"
					}
				   ]
		},
		group: [
		  [{
			label: "Form244",
			data: "CombinedOrder_Team",
			required: true,
			type: "text",
			validation: ["kpDefault", "minLen|1", "maxLen|140"],
			typing: "kpDefault"
		  },
		   {
			 label: "Form245",
			 data: "CombinedOrder_Total",
			 required: true,
			 type: "text",
			 validation: ["kpDefault", "minLen|1", "maxLen|140"],
			 typing: "kpDefault"
		   },
		   {
			 label: "Form246",
			 data: "CombinedOrder_SharePointID",
			 required: true,
			 type: "text",
			 validation: ["kpDefault", "minLen|1", "maxLen|140"],
			 typing: "kpDefault"
		   },
		   {
			 label: "Form247",
			 data: "CombinedOrder_Owner",
			 required: true,
			 type: "text",
			 validation: ["kpDefault", "minLen|2", "maxLen|140"],
			 typing: "kpDefault"
		   },
		  ],
		]
	  },
	],
	callback: function() {
	  callbacks.page11();
	},
	validation: function() {
	  var result = {
		fail: [],
		pass: []
	  };
	  var Optional_Attachment = document.querySelector('input[data-name=Optional_Attachment]');
	  if (Optional_Attachment && Optional_Attachment.value) result.pass.push(Optional_Attachment);
	  return result;
	}
  };

  // COMMENTS
  const page12 = {
	title: "Form186",
	subtitle: "Form187",
	description: "Form003",
	selectone: "SelectOne",
	continue: "Continue",
	submit: "Submit",
	back: "Back",
	no: "No",
	poformat: "POFormat",
	savedraft: "Form208",
	ready: false,
	nav: true,
	showOnReview: false,
	structure: [
	  // COMMENTS
	  {
		header: "Form186",
		description: "Form188",
		group: [
		  [{
			label: "Form189",
			data: "Comment_Tax",
			required: false,
			type: "textarea",
			placeholder: "Form190",
			validation: ["kpDefault"],
			typing: "kpDefault"
		  },
		   {
			 label: "Form191",
			 data: "Comment_Invoice",
			 required: false,
			 type: "textarea",
			 placeholder: "Form192",
			 validation: ["kpDefault"],
			 typing: "kpDefault"
		   },
		   {
			 label: "Form193",
			 data: "Comment_Delivery",
			 required: false,
			 type: "textarea",
			 placeholder: "Form220",
			 validation: ["kpDefault"],
			 typing: "kpDefault"
		   },
		   {
			 label: "Form195",
			 data: "Comment_Packing",
			 required: false,
			 type: "textarea",
			 placeholder: "Form196",
			 validation: ["kpDefault"],
			 typing: "kpDefault"
		   },
		   {
			 label: "Form197",
			 data: "Comment_Extra",
			 required: false,
			 type: "textarea",
			 placeholder: "Form198",
			 validation: ["kpDefault"],
			 typing: "kpDefault"
		   }
		  ]
		]
	  }
	],
	callback: function() {
	  callbacks.page12();
	}
  };

  // PRODUCT AND SERVICES FILE UPLOADING
  const page13 = {
	id: "PS",
	title: "FormPSTitle",
	filter: {
	  logic: "and",
	  filters: [{
		field: "Config_PartialOrder",
		operator: "eq",
		value: "Y"
	  },]
	},
	subtitle: "",
	description: "",  
	selectone: "SelectOne",
	continue: "Continue",
	submit: "Submit",
	back: "Back",
	no: "No",    
	nav: true,
	showOnReview: false,
	poformat: "The documents need to be sent in  .xls, .xlsx, .xlsm, .csv format of a maximum of 4 MB.",
	structure: [
	  {
		header: "Product and services attachment",  
		filter: {
		  logic: "and",
		  filters: [{
			field: "Config_Quote",
			operator: "eq",
			value: "N"
		  }],
		},
		description: "",
		group: [
		  [
			{
			  label: "FormCFI06",
			  data: "ProductServices_Attachment",
			  required: false,
			  type: "kUpload",
			  uploadConfig: {
				formId: 989,
				extensions: [".xlxs", ".xls", ".xlsx", ".xlsm"],
				maxFileSize: 1
			  }
			},              
		  ],
		]
	  },
	  {
		header: "",
		description: "",
		id: "form-table",
		group: [
		  [
			{
			  data: "Selected_All",
			  type: "checkbox",
			  required: false,
			  values: ["Y",],
			  class: "title-cell-checkbox",
			},
			{
			  label: "FormHPN",
			  data: "HPE_Product_Nub",
			  value: "HPE Part Number*",
			  required: true,
			  type: "text",
			  validation: ['minLen|1'],
			  class: "title-cell",
			},
			{
			  label: "FormHPQ",
			  value: "HPE Part Quantity*",
			  data: "Quantity",
			  required: true,
			  type: "text",
			  validation: ['minLen|1'],
			  class: "title-cell",
			},
			{
			  label: "FormDealId",
			  value: "Deal ID",
			  data: "Deal_Id",
			  required: false,
			  type: "text",
			  validation: ['minLen|1'],
			  class: "title-cell",
			},

			{
			  label: "FormBIID",
			  value: "bundle ID / Icon ID",
			  data: "Test",
			  required: false,
			  type: "text",
			  validation: ['minLen|1'],
			  class: "title-cell",
			},
			{
			  label: "FormUP",
			  value: "Unit Price*",
			  data: "UnitPrice",
			  required: true,
			  type: "text",
			  validation: ['minLen|1'],
			  class: "title-cell",
			},
			{
			  label: "FormENP",
			  value: "Extended Net Price*",
			  data: "ExtendedNetPrice",
			  required: true,
			  type: "text",
			  validation: ['minLen|1'],
			  class: "title-cell",
			},
		  ],
		],
	  },  
	  {
		filter: {
		  logic: "or",
		  filters: [
			{
			  field: "CountryCode",
			  operator: "in",
			  value: global.nonPoModelCountries
			},
			{
			  logic: "and",
			  filters: [
				{
				  field: "Region",
				  operator: "neq",
				  value: "APJ"
				},
				{
				  field: "SubRegion",
				  operator: "neq",
				  value: "UKI"
				},
				{
				  field: "Geo",
				  operator: "nin",
				  value: ["DACH", "Europe South", "North West Europe"]
				}
			  ]
			}
		  ]
		},
		header: "",
		group: [
		  [
			{
			  label: "Form008",
			  data: "PO_Value",
			  required: false,
			  disabled: true,
			  type: "text",
			  placeholder: "Form009",
			  validation: ["povalue", "minLen|1", "maxLen|15", "noBlanksv2"],
			  typing: "povaluetyping"
			},
		  ]
		]
	  },
	],      
	callback: function() {  
	  const PS_Att = document.querySelector('[data-name="ProductServices_Attachment"]');
	  if (PS_Att) {
		const kendoOptAtt = $(PS_Att).data('kendoUpload');
		kendoOptAtt.bind("upload", function(e) {            
		  if (e.files && e.files.length) {
			quoteHelper.ucids = [];
			quoteHelper.maxQuantity = null;
			helper.parseUcidsDataFromExcel(config, e.files[0].rawFile, (data) => { 
			  if (data.success && data.data && data.data.length) {
				config.dataset.ProductServicesRepeater = null;
				config.dataset.Config_Quote_PartialOrder = null;
				config.dataset.ProductServices_Attachment =
				  new DOMParser().parseFromString(e.files[0].name, "text/html").documentElement.textContent;
				// build product and services page
				quoteHelper.buildProductAndServices(config, config.pages[config.page]);
				nbsf.init(config, config.page);
			  }
			});
		  }
		});
		
		const row = PS_Att.closest('.row');
		const heading = $(row).find('.heading');
		if (heading) {
		  $(heading).append(`<a href='https://hpe-rfb.it.hpe.com/builder/rs/forms/989/images/HPE%20NOR%20Template%20for%20Products%20and%20Services%20V4.xlsx'>Download the template</a>`);
		}
	  }
	  
	  if (config.dataset.Config_Quote === "Y") {
		quoteHelper.onInitQuoteCarepackProductAndServices(config);
	  }

	  callbacks.page13();  
	},
	validation: function() {
	  var result = {
		fail: [],
		pass: [],
		tooltips: {},
	  };
	  // if selected check the required field 
	  // ProductServices_Attachment
	  if (config.dataset.ProductServices_Attachment) {
		return result;
	  }
	  if (quoteHelper.ucids.length) {
		var isOneSelected = false;
		quoteHelper.ucids.forEach(item => {
		  const carepack = document.querySelector(`input[data-name=Carepack_${item.ID}]`);
		  const snp = document.querySelector(`textarea[data-name=SerialNumberOfProducts_${item.ID}]`);
		  const count = document.querySelector(`input[data-name=Count_${item.ID}]`);
		  const checkbox = document.querySelector(`input[data-name=Selected_${item.ID}]`);
		  const maxQuantity = quoteHelper.maxQuantity && quoteHelper.maxQuantity.get(item.ProductID) || 0;
		  const consumedQuantity = item.Quantity - maxQuantity;
		  if (checkbox) {
			if (checkbox.checked) {
			  isOneSelected = true;
			  // SerialNumberOfProducts
			  if (snp && carepack && carepack.value == "Y") {
				if (snp.value) {
				  result.pass.push(snp.closest('label'));
				  snp.closest('label').setAttribute("data-state", "");
				} else {
				  result.fail.push(snp.closest('label'));
				  snp.closest('label').setAttribute("data-state", "error");
				}
			  }
			  // Count - Quantity
			  if (count) {
				const val = count.value && Number(count.value) || 0;
				if (val && val <= maxQuantity && val > 0) {
				  result.pass.push(count.closest('label'));
				  count.closest('label').setAttribute("data-state", "");
				} else {
				  result.fail.push(count.closest('label'));
				  if (val > 0) {
					result.tooltips[`Count_${item.ID}`] = consumedQuantity == 0 ? ['Max Quantity is ' + item.Quantity] : [consumedQuantity + ' Quantities already consumed'];
				  }
				  count.closest('label').setAttribute("data-state", "error");
				}
			  }
			} else {
			  if (snp) {
				result.pass.push(snp.closest('label'));
				snp.closest('label').setAttribute("data-state", "");
			  }
			  result.pass.push(count.closest('label'));
			  count.closest('label').setAttribute("data-state", "");
			}
		  }
		});
		// At least one checkbox must be selected
		if (!isOneSelected) {
		  const checkbox = document.querySelector(`input[data-name=Selected_${quoteHelper.ucids[0].ID}]`);
		  if (checkbox) {
			result.fail.push(checkbox.closest('label'));
		  }
		}
	  }
	  else if (!config.dataset.ProductServices_Attachment && config.dataset.Config_Quote !== 'Y') {
		$('*[data-rname="ProductServicesRepeater"]').each(function(i, elem) {
		  if ($(elem).find('*[data-name="Carepack"]') && $(elem).find('*[data-name="Carepack"]').val() != 'N') {
			let snp = $(elem).find('*[data-name="SerialNumberOfProducts"]');
			if (snp && snp.val()) {
			  result.pass.push(snp.closest('label')[0]);
			  snp.closest('label').attr("data-state", "");
			} else {
			  result.fail.push(snp.closest('label')[0]);
			  snp.closest('label').attr("data-state", "error");
			}
		  }
		});
		quoteHelper.saveProductAndServicesConfig(config);
	  }
	  return result;
	},
  };
 
  // OVERVIEW PAGE
  const overviewPage = {
	title: "Form221",
	subtitle: "Form222",
	selectone: "SelectOne",
	continue: "Continue",
	submit: "Submit",
	back: "Back",
	no: "No",
	poformat: "POFormat",
	savedraft: "Form208",
	ready: false,
	nav: true,
  structure: [{
    hidden: false,
    group: []
  }],
	callback: function() {
	  // POPULATE ORID
	  var orid = document.querySelectorAll(".header .ORID");
	  for (i = 0; i < orid.length; i++) orid[i].innerText = config.dataset.EntryId;

	  //empty ship to if the config is toggled yes but the quote still has info
	  if (config.dataset.Config_ShipToDetails == 'Y') {
		config.dataset.ShipTo_Address_City = null;
		config.dataset.ShipTo_Address_Country = null;
		config.dataset.ShipTo_Address_Postal = null;
		config.dataset.ShipTo_Address_State = null;
		config.dataset.ShipTo_Address_Street = null;
		config.dataset.ShipTo_Address_Street2 = null;
		config.dataset.ShipTo_CompanyName = null;
		config.dataset.ShipTo_NationalID = null;
		config.dataset.ShipTo_PartyId = null;
	  }

	  if (config.dataset.Config_ShipToDetails_Contact == 'Y') {
		config.dataset.ShipTo_Contact_Country = null;
		config.dataset.ShipTo_Contact_Email = null;
		config.dataset.ShipTo_Contact_FirstName = null;
		config.dataset.ShipTo_Contact_LastName = null;
		config.dataset.ShipTo_Contact_Phone = null;
	  }
	  // CONFIGURATION FOR DATA REVIEW UI
	  var reviewSetup = {
		request: {
		  title: hpe.fn.lang('Form201', config.locale, config.localizations),
		  fieldset: [
			[hpe.fn.lang('Form443', config.locale, config.localizations), "EntryId"],
			[hpe.fn.lang('Form444', config.locale, config.localizations), "SubmittedTimestamp"],
			[hpe.fn.lang('Form445', config.locale, config.localizations), "Status"],
			[hpe.fn.lang('Form446', config.locale, config.localizations), "PO_Order_ID"],
			[hpe.fn.lang('Form44x', config.locale, config.localizations), "SuccessResult"],
			[hpe.fn.lang('Form447', config.locale, config.localizations), "Email"],
			[hpe.fn.lang('Form086', config.locale, config.localizations), "PartyId"]
		  ]
		},
		po: {
		  title: hpe.fn.lang("Form202", config.locale, config.localizations),
		  fieldset: [
			[hpe.fn.lang("Form462", config.locale, config.localizations), "PO_BackgroundGroup"],
			[hpe.fn.lang("Form514", config.locale, config.localizations), "PO_HPEEntity"],
			[hpe.fn.lang("Form465", config.locale, config.localizations), "PO_BusinessModel"],
			[hpe.fn.lang("Form005", config.locale, config.localizations), "PO_Number"],
			config.dataset.PO_Attachment ? "" : [hpe.fn.lang("Form007", config.locale, config.localizations), "PO_Currency"],
			[hpe.fn.lang("Form335", config.locale, config.localizations), "PO_Value"],
			[hpe.fn.lang("Form535", config.locale, config.localizations), "TaxAmount"],
			[hpe.fn.lang("Form536", config.locale, config.localizations), "PO_Value_Tax"],
			[hpe.fn.lang("Form334", config.locale, config.localizations), "PO_Category"],
			[hpe.fn.lang("Form014", config.locale, config.localizations), "Rs_PO_Number"],
			[hpe.fn.lang("Form016", config.locale, config.localizations), "Cx_PO_Number"],
			[hpe.fn.lang("Form024", config.locale, config.localizations), "PA_Number"],
			[hpe.fn.lang("Form026", config.locale, config.localizations), "Payment_Terms"],
			[hpe.fn.lang("Form530", config.locale, config.localizations), "Config_aaS"],
			[hpe.fn.lang("Form337", config.locale, config.localizations), "Requestor_PO_Quote_ID"],
			[hpe.fn.lang("FormCFI017", config.locale, config.localizations),
			 config.dataset.hideQECC === "N" ? "QECC_Country" : (config.dataset.hideSIM === "N" ? "SIM_Country" : "Country")
			],
			[hpe.fn.lang("Form456", config.locale, config.localizations), "Config_UCID"],
			[hpe.fn.lang("Form458", config.locale, config.localizations), "Config_UCIDQ"],
			[hpe.fn.lang("Form460", config.locale, config.localizations), "Config_ConfigId"],
			[hpe.fn.lang("Form021", config.locale, config.localizations), "Requestor_PO_Deal_ID"],
			[hpe.fn.lang("Form479", config.locale, config.localizations), "Requestor_PO_Opp_ID"],
			[hpe.fn.lang("Form039", config.locale, config.localizations), "PO_DeliveryDate"],
			[hpe.fn.lang("Form477", config.locale, config.localizations), "PO_CompleteDelivery"],
			[hpe.fn.lang("Form476", config.locale, config.localizations), "PO_DeliveryIncoterms"],
			[hpe.fn.lang("Form249", config.locale, config.localizations), "Invoice_Format"],
			[hpe.fn.lang("Form250", config.locale, config.localizations), "Invoice_SendEmail"],
			/*[hpe.fn.lang("Form215", config.locale, config.localizations), "Notification_CC"],*/
			[hpe.fn.lang("Form336", config.locale, config.localizations), "PO_Attachment"],
			/*[hpe.fn.lang("Form041", config.locale, config.localizations), "Config_SoldToDetails"],
                          [hpe.fn.lang("Form042", config.locale, config.localizations), "Config_SoldToDetails_Contact"],
                          [hpe.fn.lang("Form043", config.locale, config.localizations), "Config_PayerDetails"],
                          [hpe.fn.lang("Form044", config.locale, config.localizations), "Config_BillToDetails"],
                          [hpe.fn.lang("Form047", config.locale, config.localizations), "Config_ShipToDetails"],
                          [hpe.fn.lang("Form048", config.locale, config.localizations), "Config_ShipToDetails_Contact"],*/
			//[hpe.fn.lang("Form522", config.locale, config.localizations), "Config_Tier1"],
			[hpe.fn.lang("Form523", config.locale, config.localizations), "Config_Business_Justification"],
			/*[hpe.fn.lang("Form525", config.locale, config.localizations), "Config_Tier2"],
                          [hpe.fn.lang("Form526", config.locale, config.localizations), "Config_Shipment_India"],
                          [hpe.fn.lang("Form527", config.locale, config.localizations), "Config_OEM"],
                          [hpe.fn.lang("Form052", config.locale, config.localizations), "Config_LocationDetails"],
                          [hpe.fn.lang("Form053", config.locale, config.localizations), "Config_EntitledDetails"]*/



		  ]
		},
		soldto: {
		  title: hpe.fn.lang("Form054", config.locale, config.localizations),
		  filter: {
			field: "Config_SoldToDetails",
			operator: "neq",
			value: "Y"
		  },
		  /*  filter: {
              logic: "or",
              filters: [{
                field: "Config_SoldToDetails",
                operator: "neq",
                value: "Y"
              },
                        {
                          field: "Config_SoldToDetails_Contact",
                          operator: "neq",
                          value: "Y"
                        }
                       ]
            },*/
		  fieldset: [
			[hpe.fn.lang("Form086", config.locale, config.localizations), "SoldTo_PartyId"],
			[hpe.fn.lang("Form440", config.locale, config.localizations), "SoldTo_CompanyName"],
			[hpe.fn.lang("Address", config.locale, config.localizations), "SoldTo_Address_Street"],
			[hpe.fn.lang("AddressLineOptional", config.locale, config.localizations), "SoldTo_Address_Street2"],
			[hpe.fn.lang("City", config.locale, config.localizations), "SoldTo_Address_City"],
			[hpe.fn.lang("StateProvince", config.locale, config.localizations), "SoldTo_Address_State"],
			[hpe.fn.lang("Postal code", config.locale, config.localizations), "SoldTo_Address_Postal"],
			[hpe.fn.lang("Country", config.locale, config.localizations), "SoldTo_Address_Country"],
			[hpe.fn.lang("Form495", config.locale, config.localizations), "SoldTo_NationalID"],
			[hpe.fn.lang("FirstName", config.locale, config.localizations), "SoldTo_Contact_FirstName"],
			[hpe.fn.lang("Surname", config.locale, config.localizations), "SoldTo_Contact_LastName"],
			[hpe.fn.lang("Telephone", config.locale, config.localizations), "SoldTo_Contact_Phone"],
			[hpe.fn.lang("Form441", config.locale, config.localizations), "SoldTo_Contact_Email"],
			[hpe.fn.lang("CountryOfResidence", config.locale, config.localizations), "SoldTo_Contact_Country"]
		  ]
		},
		payer: {
		  title: hpe.fn.lang("Form206", config.locale, config.localizations),
		  filter: {
			field: "Config_PayerDetails",
			operator: "neq",
			value: "Y"
		  },
		  fieldset: [
			[hpe.fn.lang("Form086", config.locale, config.localizations), "Payer_PartyId"],
			[hpe.fn.lang("Form440", config.locale, config.localizations), "Payer_CompanyName"],
			[hpe.fn.lang("Address", config.locale, config.localizations), "Payer_Address_Street"],
			[hpe.fn.lang("AddressLineOptional", config.locale, config.localizations), "Payer_Address_Street2"],
			[hpe.fn.lang("City", config.locale, config.localizations), "Payer_Address_City"],
			[hpe.fn.lang("StateProvince", config.locale, config.localizations), "Payer_Address_State"],
			[hpe.fn.lang("Postal code", config.locale, config.localizations), "Payer_Address_Postal"],
			[hpe.fn.lang("Country", config.locale, config.localizations), "Payer_Address_Country"],
			[hpe.fn.lang("FirstName", config.locale, config.localizations), "Payer_Contact_FirstName"],
			[hpe.fn.lang("Surname", config.locale, config.localizations), "Payer_Contact_LastName"],
			[hpe.fn.lang("Telephone", config.locale, config.localizations), "Payer_Contact_Phone"],
			[hpe.fn.lang("Form441", config.locale, config.localizations), "Payer_Contact_Email"],
			[hpe.fn.lang("CountryOfResidence", config.locale, config.localizations), "Payer_Contact_Country"]
		  ]
		},
		billto: {
		  title: hpe.fn.lang("Form204", config.locale, config.localizations),
		  filter: {
			field: "Config_BillToDetails",
			operator: "neq",
			value: "Y"
		  },
		  fieldset: [
			[hpe.fn.lang("Form086", config.locale, config.localizations), "BillTo_PartyId"],
			[hpe.fn.lang("Form440", config.locale, config.localizations), "BillTo_CompanyName"],
			[hpe.fn.lang("Address", config.locale, config.localizations), "BillTo_Address_Street"],
			[hpe.fn.lang("AddressLineOptional", config.locale, config.localizations), "BillTo_Address_Street2"],
			[hpe.fn.lang("City", config.locale, config.localizations), "BillTo_Address_City"],
			[hpe.fn.lang("StateProvince", config.locale, config.localizations), "BillTo_Address_State"],
			[hpe.fn.lang("Postal code", config.locale, config.localizations), "BillTo_Address_Postal"],
			[hpe.fn.lang("Country", config.locale, config.localizations), "BillTo_Address_Country"],
			[hpe.fn.lang("FirstName", config.locale, config.localizations), "BillTo_Contact_FirstName"],
			[hpe.fn.lang("Surname", config.locale, config.localizations), "BillTo_Contact_LastName"],
			[hpe.fn.lang("Telephone", config.locale, config.localizations), "BillTo_Contact_Phone"],
			[hpe.fn.lang("Form441", config.locale, config.localizations), "BillTo_Contact_Email"],
			[hpe.fn.lang("CountryOfResidence", config.locale, config.localizations), "BillTo_Contact_Country"]
		  ]
		},
		shipping: {
		  title: hpe.fn.lang("Form205", config.locale, config.localizations),
		  filter: {
			logic: "or",
			filters: [{
			  field: "Config_ShipToDetails",
			  operator: "neq",
			  value: "Y"
			},
					  {
						field: "Config_ShipToDetails_Contact",
						operator: "neq",
						value: "Y"
					  }
					 ]
		  },
		  fieldset: [
			[hpe.fn.lang("Form086", config.locale, config.localizations), "ShipTo_PartyId"],
			[hpe.fn.lang("Form440", config.locale, config.localizations), "ShipTo_CompanyName"],
			[hpe.fn.lang("Address", config.locale, config.localizations), "ShipTo_Address_Street"],
			[hpe.fn.lang("AddressLineOptional", config.locale, config.localizations), "ShipTo_Address_Street2"],
			[hpe.fn.lang("City", config.locale, config.localizations), "ShipTo_Address_City"],
			[hpe.fn.lang("StateProvince", config.locale, config.localizations), "ShipTo_Address_State"],
			[hpe.fn.lang("Postal code", config.locale, config.localizations), "ShipTo_Address_Postal"],
			[hpe.fn.lang("Country", config.locale, config.localizations), "ShipTo_Address_Country"],
			[hpe.fn.lang("Form495", config.locale, config.localizations), "ShipTo_NationalID"],
			[hpe.fn.lang("FirstName", config.locale, config.localizations), "ShipTo_Contact_FirstName"],
			[hpe.fn.lang("Surname", config.locale, config.localizations), "ShipTo_Contact_LastName"],
			[hpe.fn.lang("Telephone", config.locale, config.localizations), "ShipTo_Contact_Phone"],
			[hpe.fn.lang("Form441", config.locale, config.localizations), "ShipTo_Contact_Email"],
			[hpe.fn.lang("CountryOfResidence", config.locale, config.localizations), "ShipTo_Contact_Country"]
		  ]
		},
		reseller: {
		  title: hpe.fn.lang("Form126", config.locale, config.localizations),
		  filter: {
			logic: "or",
			filters: [{
			  field: "Config_ResellerDetails",
			  operator: "neq",
			  value: "Y"
			},
					  {
						field: "Config_ResellerDetails_Contact",
						operator: "neq",
						value: "Y"
					  }
					 ]
		  },
		  fieldset: [
			[hpe.fn.lang("Form086", config.locale, config.localizations), "Reseller_PartyId"],
			[hpe.fn.lang("Form058", config.locale, config.localizations), "Reseller_CompanyName"],
			[hpe.fn.lang("Address", config.locale, config.localizations), "Reseller_Address_Street"],
			[hpe.fn.lang("AddressLineOptional", config.locale, config.localizations), "Reseller_Address_Street2"],
			[hpe.fn.lang("City", config.locale, config.localizations), "Reseller_Address_City"],
			[hpe.fn.lang("StateProvince", config.locale, config.localizations), "Reseller_Address_State"],
			[hpe.fn.lang("Postal code", config.locale, config.localizations), "Reseller_Address_Postal"],
			[hpe.fn.lang("Country", config.locale, config.localizations), "Reseller_Address_Country"],
			[hpe.fn.lang("Form495", config.locale, config.localizations), "Reseller_NationalID"],
			[hpe.fn.lang("FirstName", config.locale, config.localizations), "Reseller_Contact_FirstName"],
			[hpe.fn.lang("Surname", config.locale, config.localizations), "Reseller_Contact_LastName"],
			[hpe.fn.lang("Telephone", config.locale, config.localizations), "Reseller_Contact_Phone"],
			[hpe.fn.lang("Form441", config.locale, config.localizations), "Reseller_Contact_Email"],
			[hpe.fn.lang("CountryOfResidence", config.locale, config.localizations), "Reseller_Contact_Country"]
		  ]
		},
		endcx: {
		  title: hpe.fn.lang("Form138", config.locale, config.localizations),
		  filter: {
			logic: "or",
			filters: [{
			  field: "Config_EndCxDetails",
			  operator: "neq",
			  value: "Y"
			},
					  {
						field: "Config_EndCxDetails_Contact",
						operator: "neq",
						value: "Y"
					  }
					 ]
		  },
		  fieldset: [
			[hpe.fn.lang("Form086", config.locale, config.localizations), "EndCx_PartyId"],
			[hpe.fn.lang("Form058", config.locale, config.localizations), "EndCx_CompanyName"],
			[hpe.fn.lang("Address", config.locale, config.localizations), "EndCx_Address_Street"],
			[hpe.fn.lang("AddressLineOptional", config.locale, config.localizations), "EndCx_Address_Street2"],
			[hpe.fn.lang("City", config.locale, config.localizations), "EndCx_Address_City"],
			[hpe.fn.lang("StateProvince", config.locale, config.localizations), "EndCx_Address_State"],
			[hpe.fn.lang("Postal code", config.locale, config.localizations), "EndCx_Address_Postal"],
			[hpe.fn.lang("Country", config.locale, config.localizations), "EndCx_Address_Country"],
			[hpe.fn.lang("Form495", config.locale, config.localizations), "EndCx_NationalID"],
			[hpe.fn.lang("FirstName", config.locale, config.localizations), "EndCx_Contact_FirstName"],
			[hpe.fn.lang("Surname", config.locale, config.localizations), "EndCx_Contact_LastName"],
			[hpe.fn.lang("Telephone", config.locale, config.localizations), "EndCx_Contact_Phone"],
			[hpe.fn.lang("Form441", config.locale, config.localizations), "EndCx_Contact_Email"],
			[hpe.fn.lang("CountryOfResidence", config.locale, config.localizations), "EndCx_Contact_Country"]
		  ]
		},
		customershipto: {
		  title: hpe.fn.lang("Form486", config.locale, config.localizations),
		  fieldset: [
			[hpe.fn.lang("Form086", config.locale, config.localizations), "CustomShipTo_PartyId"],
			[hpe.fn.lang("Form058", config.locale, config.localizations), "CustomShipTo_CompanyName"],
			[hpe.fn.lang("Address", config.locale, config.localizations), "CustomShipTo_Address"],
			[hpe.fn.lang("AddressLineOptional", config.locale, config.localizations), "CustomShipTo_Address_Street2"],
			[hpe.fn.lang("City", config.locale, config.localizations), "CustomShipTo_Address_City"],
			[hpe.fn.lang("StateProvince", config.locale, config.localizations), "CustomShipTo_Address_State"],
			[hpe.fn.lang("Postal code", config.locale, config.localizations), "CustomShipTo_Address_Postal"],
			[hpe.fn.lang("Country", config.locale, config.localizations), "CustomShipTo_Address_Country"]
		  ]
		},
		agentprogram: {
		  title: hpe.fn.lang("Form500", config.locale, config.localizations),
		  fieldset: [
			[hpe.fn.lang("Form086", config.locale, config.localizations), "AgentProgram_PartyId"],
			[hpe.fn.lang("Form058", config.locale, config.localizations), "AgentProgram_CompanyName"],
			[hpe.fn.lang("Address", config.locale, config.localizations), "AgentProgram_Address"],
			[hpe.fn.lang("AddressLineOptional", config.locale, config.localizations), "AgentProgram_Address_Street2"],
			[hpe.fn.lang("City", config.locale, config.localizations), "AgentProgram_Address_City"],
			[hpe.fn.lang("StateProvince", config.locale, config.localizations), "AgentProgram_Address_State"],
			[hpe.fn.lang("Postal code", config.locale, config.localizations), "AgentProgram_Address_Postal"],
			[hpe.fn.lang("Country", config.locale, config.localizations), "AgentProgram_Address_Country"]
		  ]
		},
		additionalinfo: {
		  title: hpe.fn.lang("Form152", config.locale, config.localizations),
		  fieldset: [
			[hpe.fn.lang("FormCFI08", config.locale, config.localizations), "Optional_Attachment"],
			[hpe.fn.lang("FirstName", config.locale, config.localizations), "EndCx_SysMng_FirstName"],
			[hpe.fn.lang("Surname", config.locale, config.localizations), "EndCx_SysMng_LastName"],
			[hpe.fn.lang("Telephone", config.locale, config.localizations), "EndCx_SysMng_Phone"],
			[hpe.fn.lang("Email", config.locale, config.localizations), "EndCx_SysMng_Email"],
			[hpe.fn.lang("CountryOfResidence", config.locale, config.localizations), "EndCx_SysMng_Country"],
			[hpe.fn.lang("Form086", config.locale, config.localizations), "PSP_PartyId"],
			[hpe.fn.lang("Form058", config.locale, config.localizations), "PSP_CompanyName"],
			[hpe.fn.lang("Address", config.locale, config.localizations), "PSP_Address_Street"],
			[hpe.fn.lang("AddressLineOptional", config.locale, config.localizations), "PSP_Address_Street2"],
			[hpe.fn.lang("City", config.locale, config.localizations), "PSP_Address_City"],
			[hpe.fn.lang("StateProvince", config.locale, config.localizations), "PSP_Address_State"],
			[hpe.fn.lang("Postal code", config.locale, config.localizations), "PSP_Address_Postal"],
			[hpe.fn.lang("Country", config.locale, config.localizations), "PSP_Address_Country"],
			[hpe.fn.lang("Form163", config.locale, config.localizations), "Config_ResId"],
			[hpe.fn.lang("Form165", config.locale, config.localizations), "Config_LOID"],
			[hpe.fn.lang("Form454", config.locale, config.localizations), "Config_LogCode"],
			[hpe.fn.lang("Form482", config.locale, config.localizations), "Config_CIG"],
			[hpe.fn.lang("Form484", config.locale, config.localizations), "Config_CUP"],
			[hpe.fn.lang("Form086", config.locale, config.localizations), "AssLoc_PartyId"],
			[hpe.fn.lang("Form058", config.locale, config.localizations), "AssLoc_CompanyName"],
			[hpe.fn.lang("Address", config.locale, config.localizations), "AssLoc_Address_Street"],
			[hpe.fn.lang("AddressLineOptional", config.locale, config.localizations), "AssLoc_Address_Street2"],
			[hpe.fn.lang("City", config.locale, config.localizations), "AssLoc_Address_City"],
			[hpe.fn.lang("StateProvince", config.locale, config.localizations), "AssLoc_Address_State"],
			[hpe.fn.lang("Postal code", config.locale, config.localizations), "AssLoc_Address_Postal"],
			[hpe.fn.lang("Country", config.locale, config.localizations), "AssLoc_Address_Country"],
			[hpe.fn.lang("Form086", config.locale, config.localizations), "EntPrty_PartyId"],
			[hpe.fn.lang("Form058", config.locale, config.localizations), "EntPrty_CompanyName"],
			[hpe.fn.lang("Address", config.locale, config.localizations), "EntPrty_Address_Street"],
			[hpe.fn.lang("AddressLineOptional", config.locale, config.localizations), "EntPrty_Address_Street2"],
			[hpe.fn.lang("City", config.locale, config.localizations), "EntPrty_Address_City"],
			[hpe.fn.lang("StateProvince", config.locale, config.localizations), "EntPrty_Address_State"],
			[hpe.fn.lang("Postal code", config.locale, config.localizations), "EntPrty_Address_Postal"],
			[hpe.fn.lang("Country", config.locale, config.localizations), "EntPrty_Address_Country"],
			[hpe.fn.lang("FirstName", config.locale, config.localizations), "EntPrty_Contact_FirstName"],
			[hpe.fn.lang("Surname", config.locale, config.localizations), "EntPrty_Contact_LastName"],
			[hpe.fn.lang("Telephone", config.locale, config.localizations), "EntPrty_Contact_Phone"],
			[hpe.fn.lang("Email", config.locale, config.localizations), "EntPrty_Contact_Email"],
			[hpe.fn.lang("CountryOfResidence", config.locale, config.localizations), "EntPrty_Contact_Country"],
		  ]
		},
		additionalinfo_ali: {
		  title: hpe.fn.lang("Form241", config.locale, config.localizations),
		  filter: {
			logic: "and",
			filters: [{
			  field: "CountryCode",
			  operator: "eq",
			  value: "JP"
			},
					  {
						field: "Config_ALI",
						operator: "eq",
						value: "Y"
					  }
					 ]
		  },
		  fieldset: [
			[hpe.fn.lang("Form086", config.locale, config.localizations), "ALI_PartyId"],
			[hpe.fn.lang("Form058", config.locale, config.localizations), "ALI_CompanyName"],
			[hpe.fn.lang("Address", config.locale, config.localizations), "ALI_Address_Street"],
			[hpe.fn.lang("AddressLineOptional", config.locale, config.localizations), "ALI_Address_Street2"],
			[hpe.fn.lang("City", config.locale, config.localizations), "ALI_Address_City"],
			[hpe.fn.lang("StateProvince", config.locale, config.localizations), "ALI_Address_State"],
			[hpe.fn.lang("Postal code", config.locale, config.localizations), "ALI_Address_Postal"],
			[hpe.fn.lang("Country", config.locale, config.localizations), "ALI_Address_Country"],
			[hpe.fn.lang("FirstName", config.locale, config.localizations), "ALI_Contact_FirstName"],
			[hpe.fn.lang("Surname", config.locale, config.localizations), "ALI_Contact_LastName"],
			[hpe.fn.lang("Telephone", config.locale, config.localizations), "ALI_Contact_Phone"],
			[hpe.fn.lang("Form441", config.locale, config.localizations), "ALI_Contact_Email"],
			[hpe.fn.lang("CountryOfResidence", config.locale, config.localizations), "ALI_Contact_Country"]
		  ]
		},
		additionalinfo_combinedOrder: {
		  title: hpe.fn.lang("Form243", config.locale, config.localizations),
		  filter: {
			logic: "and",
			filters: [{
			  field: "CountryCode",
			  operator: "eq",
			  value: "JP"
			},
					  {
						field: "Config_CombinedOrder",
						operator: "eq",
						value: "Y"
					  }
					 ]
		  },
		  fieldset: [
			[hpe.fn.lang("Form244", config.locale, config.localizations), "CombinedOrder_Team"],
			[hpe.fn.lang("Form245", config.locale, config.localizations), "CombinedOrder_Total"],
			[hpe.fn.lang("Form246", config.locale, config.localizations), "CombinedOrder_SharePointID"],
			[hpe.fn.lang("Form247", config.locale, config.localizations), "CombinedOrder_Owner"],
		  ]
		},
		comments: {
		  title: hpe.fn.lang("Form207", config.locale, config.localizations),
		  fieldset: [
			[hpe.fn.lang("Form442", config.locale, config.localizations), "Comment_Tax"],
			[hpe.fn.lang("Form191", config.locale, config.localizations), "Comment_Invoice"],
			[hpe.fn.lang("Form193", config.locale, config.localizations), "Comment_Delivery"],
			[hpe.fn.lang("Form195", config.locale, config.localizations), "Comment_Packing"],
			[hpe.fn.lang("Form197", config.locale, config.localizations), "Comment_Extra"]
		  ]
		},
		PS: {
		  title: "Products and Services",
		  fieldset: [],
		  filter: {
			logic: "and",
			filters: [{
			  field: "Config_Quote_PartialOrder",
			  operator: "isnotempty",
			  value: "?"
			}]
		  }
		}
	  };
	  
	  var app = document.querySelector(".nbsf .row");
	  const geo = config.dataset.Geo || global.data.geo.geography;
	  /*
	  var app = document.querySelector(".nbsf-review-page");
	  
	  const geo = config.dataset.Geo || global.data.geo.geography;
	  document.querySelector(".output").innerHTML += '<div id="msg" class="active nfo"><p>' + hpe.fn.lang("InfoCurrent", config.locale, config.localizations) + '</p><span>' +
		`<svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="close" width="16px" height="16px">
<path fill="none" stroke="#666" stroke-width="2" d="M3,3 L21,21 M3,21 L21,3">
  </path>
  </svg>` +
		'</span></div>';
	  $('#msg.nfo').show();*/

	  let objK = Object.keys(reviewSetup);
	  for (i = 0; i < objK.length; i++) {
		let key = objK[i];
		if (key == "customershipto") {
		  var main = reviewSetup[key];
		  var filterobj = {};
		  if (["Latin America", "North America"].indexOf(geo) == -1) {
			filterobj = {
			  "field": "SubRegion",
			  "operator": "eq",
			  "value": config.dataset.SubRegion
			};
		  } else {
			filterobj = {
			  "field": "PO_DeliveryIncoterms",
			  "operator": "neq",
			  "value": "DDP"
			};
		  }
		  var mergeobj = Object.assign(main, {
			"filter": filterobj
		  });
		  reviewSetup[key] = mergeobj;
		} else if (key == "agentprogram") {
		  var main = reviewSetup[key];
		  if (["Latin America", "North America"].indexOf(geo) == -1) {
			var subRegionFilterObj = {
			  "field": "SubRegion",
			  "operator": "eq",
			  "value": global.data.geo.subregion
			};
			var mergeobj = Object.assign(main, {
			  "filter": subRegionFilterObj
			});
			reviewSetup[key] = mergeobj;
		  } else {
			if (global.data.brt.name == "Distributor") {
			  var businessModelFilterObj = [{
				"field": "PO_BusinessModel",
				"operator": "eq",
				"value": "Agent Model"
			  },
											{
											  "field": "PO_BusinessModel",
											  "operator": "eq",
											  "value": "HPFS & Agent Model"
											}
										   ];
			  var filters = {
				logic: "or",
				filters: businessModelFilterObj
			  }
			  var mergeobj = Object.assign(main, {
				"filter": filters
			  });
			  reviewSetup[key] = mergeobj;
			} else {
			  var partnerBRTFilterObj = {
				"field": "PartnerBRT",
				"operator": "eq",
				"value": "Distributor"
			  };
			  var mergeobj = Object.assign(main, {
				"filter": partnerBRTFilterObj
			  });
			  reviewSetup[key] = mergeobj;
			}
		  }
		} else if (key == "endcx") {
		  var POOptionalValidArray = ["Latin America", "Central Europe", "UKIMESA", "CERTA", "MESA", "North America"];
		  if (POOptionalValidArray.indexOf(geo) > -1) {
			var main = reviewSetup[key];
			var FilterObj = {
			  "field": "PO_Category",
			  "operator": "neq",
			  "value": "Stock"
			};
			var mergeobj = Object.assign(main, {
			  "filter": FilterObj
			});
			reviewSetup[key] = mergeobj;
		  }
		} else if (key == "reseller") {
		  var POOptionalValidArray = ["Latin America", "Central Europe", "UKIMESA", "CERTA", "MESA", "North America"];
		  if (POOptionalValidArray.indexOf(geo) > -1) {
			if (global.BRT != "Distributor") {
			  var main = reviewSetup[key];
			  var FilterObj = {
				"field": "PartnerBRT",
				"operator": "eq",
				"value": "Distributor"
			  };

			  var mergeobj = Object.assign(main, {
				"filter": FilterObj
			  });
			  reviewSetup[key] = mergeobj;
			} else {
			  var main = reviewSetup[key];
			  var FilterObj = [{
				"field": "PO_BusinessModel",
				"operator": "notcontains",
				"value": "Agent Model"
			  },
							   {
								 "field": "PO_Category",
								 "operator": "neq",
								 "value": "Stock"
							   }
							  ];
			  var filters = {
				logic: "and",
				filters: FilterObj
			  }
			  var mergeobj = Object.assign(main, {
				"filter": filters
			  });
			  reviewSetup[key] = mergeobj;
			}
		  }
		}
		var filter = true;
		if (typeof(reviewSetup[key].filter) === "object") filter = nbsf.fn.filter(config.dataset, reviewSetup[key].filter);
		if (reviewSetup[key].fieldset.length > 0 && filter) {
		  console.log('reviewSetup[key]', reviewSetup[key]);
		  if (app.querySelector(".row[review-id=" + key + "]") == null)
			app.innerHTML += '<div class="row" review-id="' + key + '"><h4>' + reviewSetup[key].title + '</h4></div>';
		  var row = app.querySelector(".row[review-id=" + key + "]");
		  var headerchk = false;
		  for (j = 0; j < reviewSetup[key].fieldset.length; j++) {
			var item = reviewSetup[key].fieldset[j];
			var label = item[0];
			var value = config.dataset[item[1]];

			if (typeof(value) === "undefined" || value == null || value == "" || value == "OPE-") value = "N/A";

			// VALUE EXCEPTIONS
			if (item[1] == "Status")
			  switch (config.dataset[item[1]]) {
				case "0":
				  value = "Incomplete";
				  break;
				case "1":
				  value = "Processing";
				  break;
				case "2":
				  value = "Processing";
				  break;
				case "3":
				  value = "Completed";
				  break;
				case "4":
				  value = "You will be contacted by an HPE representative";
				  break;
				default:
				  value = "Unknown";
			  }
			else if (
			  item[1] == "PO_Order_ID" && (
				typeof(config.dataset[item[1]]) !== "string" || config.dataset[item[1]] == null ||
				(typeof(config.dataset[item[1]]) === "string" && config.dataset[item[1]].length < 4)
			  )
			) value = "Pending";
			else if (item[1] == "PO_Number" && config.dataset[item[1]] && config.dataset.SubmittedTimestamp && config.dataset.PDF) {
			  let pdfUrl = `https://hpe-rfb.it.hpe.com/form/989/attachments/${config.dataset.EntryId}/PDF?downloadFileName=${encodeURIComponent(config.dataset.PO_Number)}.pdf`;
			  value = `<a style="color: blue;text-decoration: underline;" href="${pdfUrl}" target="_blank">${config.dataset.PO_Number}</a>`;

			} else if (item[1] == "SuccessResult" && config.dataset[item[1]] != null) {
			  value = JSON.parse(config.dataset[item[1]]).CaseNumber;
			} else if (item[1] == "SuccessResult" && config.dataset[item[1]] == null) {
			  value = "N/A";
			} else if (item[1] == "PO_Order_ID" && config.dataset.Status == "4")
			  value = "N/A";

			else if (
			  (item[1] == "PO_Attachment" && typeof(config.dataset[item[1]]) === "string" && config.dataset[item[1]].length > 3)
			)
			  value = '<a href="https://hpe-rfb.it.hpe.com/form/989/attachments/' + config.dataset.EntryId + '/' + item[1] + '?name=' + value + '">' + hpe.fn.lang('Form332', config.locale, config.localizations) + '</a>';

			else if (
			  (item[1] == "Optional_Attachment" && typeof(config.dataset[item[1]]) === "string" && config.dataset[item[1]].length > 3)
			)
			  value = '<a href="https://hpe-rfb.it.hpe.com/form/989/attachments/' + config.dataset.EntryId + '/' + item[1] + '?name=' + value + '">' + hpe.fn.lang('Form517', config.locale, config.localizations) + '</a>';

			else if (item[1] == "SubmittedTimestamp" && config.dataset[item[1]] != null && config.dataset[item[1]].indexOf("T") > -1)
			  value = config.dataset[item[1]].split("T")[0];

			if (["N/A", "NA", hpe.fn.lang('SelectOne', config.locale, config.localizations), "+1000000000", "NA@IGNOREME.COM", " "].indexOf(value) == -1) {
			  var type = "";
			  var optiondata = "";
			  var valuesdata = "";
			  for (a = 0; a < config.pages.length; a++) {
				for (b = 0; b < config.pages[a].structure.length; b++) {
				  for (l = 0; l < config.pages[a].structure[b].group.length; l++) {
					for (k = 0; k < config.pages[a].structure[b].group[l].length; k++) {
					  if (config.pages[a].structure[b].group[l][k].data == item[1]) {
						type = config.pages[a].structure[b].group[l][k].type;
						if (type == "select") {
						  if (config.pages[a].structure[b].group[l][k].options != null)
							optiondata = config.pages[a].structure[b].group[l][k].options;

						  valuesdata = config.pages[a].structure[b].group[l][k].values;
						}
						break;
					  }
					}
				  }
				}
			  }
			  if (type == "select") {
				if (optiondata == "")
				  row.innerHTML += '<div class="item"><strong>' + label + '</strong><p>' + value + '</p></div>';
				else {
				  if (["PO_BackgroundGroup"].indexOf(item[1]) > -1) {
					var indexval = 0;
					if (optiondata.length >= 4 || valuesdata.length >= 4) {
					  if (["EMEA", "APJ", "AMS"].indexOf(global.data.geo.region) > -1) {
						valuesdata.splice(1, 1);
						valuesdata.splice(1, 1);
						optiondata.splice(1, 1);
						optiondata.splice(1, 1);
					  } else {
						valuesdata.splice(3, 1);
						valuesdata.splice(2, 1);
						optiondata.splice(3, 1);
						optiondata.splice(2, 1);
					  }
					}
					for (g = 0; g < valuesdata.length; g++) {
					  if (valuesdata[g] == value)
						indexval = g;
					}
					row.innerHTML += '<div class="item"><strong>' + label + '</strong><p>' + hpe.fn.lang(optiondata[indexval], config.locale, config.localizations) + '</p></div>';
				  } else {
					var indexval = 0;
					for (g = 0; g < valuesdata.length; g++) {
					  if (valuesdata[g] == value)
						indexval = g;
					}
					row.innerHTML += '<div class="item"><strong>' + label + '</strong><p>' + hpe.fn.lang(optiondata[indexval], config.locale, config.localizations) + '</p></div>';
				  }
				}
			  } else if (type == "toggle") {
				row.innerHTML += '<div class="item"><strong>' + label + '</strong><p>' + (value == 'N' ? 'No' : 'Yes') + '</p></div>';
			  } else
				row.innerHTML += '<div class="item"><strong>' + label + '</strong><p>' + value + '</p></div>';

			  headerchk = true;
			}

			if (j == reviewSetup[key].fieldset.length - 1) {
			  config.summary[key] = headerchk;
			  if (headerchk)
				row.innerHTML += '<div class="cfix"></div>';
			  else
				row.innerHTML = "";
			}
		  }
		}
		if (key == "PS" && filter) {
		  console.log('reviewSetup: PS', reviewSetup[key]);
		  let PSData = null;
		  try {
			PSData = JSON.parse(config.dataset.Config_Quote_PartialOrder);
			if (!Array.isArray(PSData)) PSData = null;
			PSData = PSData.filter((item) => item.Selected == "Y");
		  } catch(e) {
			console.error("Could not parse PS", config.dataset.Config_Quote_PartialOrder);
		  }

		  if (PSData) {
			if (app.querySelector(".row[review-id=" + key + "]") == null) {
			  app.innerHTML += '<div class="row" review-id="' + key + '"><h4>' + reviewSetup[key].title + '</h4></div>';
			}
			const psRow = app.querySelector(".row[review-id=" + key + "]");
			const prevProdExists = PSData.some(item => !!item.PreviouslyPurchasedProductDetails || !!item.SerialNumberOfProducts || !!item.ProductPurchasedDate);
			let PSTable = "<table class='ps-table'>" +
				"<thead><tr><th>" + hpe.fn.lang('FormHPN', config.locale, config.localizations) + "</th>" +
				"<th>" + hpe.fn.lang('FormHPQ', config.locale, config.localizations) + "</th>" +
				"<th>" + hpe.fn.lang('FormDealId', config.locale, config.localizations) + "</th>" +
				"<th>" + hpe.fn.lang('FormBIID', config.locale, config.localizations) + "</th>" +
				"<th>" + hpe.fn.lang('FormUP', config.locale, config.localizations) + "</th>" +
				"<th>" + hpe.fn.lang('FormENP', config.locale, config.localizations) + "</th>";
			if (prevProdExists) {
			  PSTable = PSTable + "<th>" + hpe.fn.lang('FormPPPD', config.locale, config.localizations) + "</th>" + 
				"<th>" + hpe.fn.lang('FormSNP', config.locale, config.localizations) + "</th>" +
				"<th>" + hpe.fn.lang('FormPPD', config.locale, config.localizations) + "</th>";
			}
			PSTable = PSTable + "</tr></thead>" + PSData.map(item => {
			  return `<tr>
<td>${item.ProductID  || ''}</td>
<td>${item.Count  || ''}</td>
<td>${item.DealId  || ''}</td>
<td>${item.BundleID  || ''}</td>
<td>${item.UnitNetAmount  || ''}</td>
<td>${item.ExtendedNetAmount  || ''}</td>` +
				(prevProdExists ?
`<td style=>${item.PreviouslyPurchasedProductDetails || ''}</td>
<td style=>${item.SerialNumberOfProducts  || ''}</td>
<td style=>${item.ProductPurchasedDate  || ''}</td>`
			    : "") + "</tr>";
			}).join("");
			psRow.innerHTML += PSTable + "</table>";
		  }
		}
	  }
	  // Buttons logic
  	  $('#msg.nfo span').click(function() {
		$('#msg.nfo').hide();
	  });
	  $('.nbsf .buttons .back').after($('<div class="btn draft">' + hpe.fn.lang('Form208', config.locale, config.localizations) + '</div>'));
	  config.dataset.isDraft = false;
	  $(".nbsf .buttons .draft").click(function() {
		config.dataset.isDraft = true;
		config.onSubmit();
	  });
	  if (config.dataset.Status == '1') $('.buttons').hide();

	  const link = document.querySelector('a[href]');

	  link.addEventListener('click', async(e) => {
		e.preventDefault();

		try {
		  let response = await fetch(link.href, {
			method: 'GET'
		  });

		  if (response.ok) {
			window.location = link.href;
		  } else {
			console.error('Error fetching the link:', response.statusText);
			//window.location = "fallbackURL"; /
		  }
		} catch (error) {
		  console.error("Error fetching the link:", error);
		  //window.location = "fallbackURL"; 
		}
	  });
	}
  };
  
</script>
<script>
  // MAIN CONFIG
  const paNumberChanged = function(newVal) {
	let prefs = global.data.userPreferences[newVal === undefined ? config.dataset.PA_Number : newVal];
	if (!prefs) return;
	
	Object.entries(prefs).forEach(([fieldName, fieldValue]) => {
	  config.dataset[fieldName] = fieldValue;
	  $(`[data-name='${fieldName}']`).val(fieldValue);
	});
  }

  const loadPreferences = function() {
      // Load preferences for all PA in global.data.brt.pas
      return new Promise((resolve, reject) => {
		  const ds = new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: "/form/data-set-provider/v2/989/Partner_Preferences/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  model: {
				id: "EntryId",
				fields: {
				}
			  }
			},
			serverFiltering: true,
			filter: {
			  logic: "or",
			  filters: global.data.brt.pas.map((pa) => ({field: "PANumber", operator: "eq", value: pa}))
			},
			serverSorting: true,
			sort: {
			  field: "EntryId",
			  dir: "desc"
			},
			serverPaging: true,
			pageSize: 1000
		  });
		  ds.read().then(() => {
			const data = ds.view();
			const prefs = {}
			data.forEach((row) => {
				try {
				  if (row.Preferences) prefs[row.PANumber] = JSON.parse(row.Preferences);
				} catch(e) {
				  // The string with wrong preferences is not the reason to fall
				  console.log("Error parsing preferences", row);
				}
			});
			global.data.brt.pas.forEach((pa) => {
			  if (!prefs[pa]) prefs[pa] = {};
			  if (!prefs[pa].Payment_Terms) prefs[pa].Payment_Terms = "NT30 - Within 30 days due net";
			});
			global.data.userPreferences = prefs;
			resolve();
		  }, (errArg) => {
			console.log("User Preferences loading error", errArg);
			reject(errArg);
		  });
	  });
  }

  const config = {
	dom: null,
	locale: global.data.user.locale,
	localizations: {},
	dataset: {
	  currentEmail: '[SSOData.Email]',
	  xrefFail: 'No'
	},
	addressField: ["Address_Country", "CompanyName", "Address_State", "Address_City", "Address_Postal", "Address_Street", "Address_Street2", "NationalID", "Address"],
	contactField: ["Contact_FirstName", "Contact_LastName", "Contact_Phone", "Contact_Email", "Contact_Country"],
	sectionName: ["SoldTo", "Payer", "BillTo", "ShipTo", "Reseller", "EndCustomer", "CustomShipTo", "AgentProgram"],
	sectionAddressFields: {}, // Mapping sectionName:fieldname[] with address fields. Filled in init().
	sectionContactFields: {}, // Mapping sectionName:fieldname[] with contact fields. Filled in init().
	sectionFields: {}, // Mapping sectionName:fieldname[] with address and contact fields. Filled in init().
	helper: true,
	summary: {},
	pages: [page1, page13, page2, pageQuotePreview, page3, page4, page5, page6, page7, page8, page9, page10, page11, page12, overviewPage],
	onNext: function() {
	  if (config.dataset.xrefFail == 'Yes') config.dataset.xrefFail = 'No';
	  
	  config.dataset.PO_Attachment_Flag = config.dataset.PO_Attachment ? 'Y' : 'N';
	  config.dataset.Optional_Attachment_Flag = config.dataset.Optional_Attachment ? 'Y' : 'N';

	  if (config.pages[config.page + 1].id == "PS") {
		quoteHelper.configureProductAndServices(config, config.pages[config.page + 1]);
	  }
	  if (config.pages[config.page].id == "PS") {
		quoteHelper.parseProductAndServicesRepeater(config);
		quoteHelper.saveProductAndServicesConfig(config);
	  }

	  function doNext() {
		mo.fn.overlay.show({
		  loading: true,
		  close: false
		});

		let vl = config.dataset.PO_BackgroundGroup;
		result = assigntoteamValues.filter(x => (x.region.indexOf(config.dataset.Region) > -1 && x.PO_BackgroundGroup == vl));
		if (config.dataset.Region == "EMEA") {
		  config.dataset.AssignToTeam = result[0].teamName;
		} else if (config.dataset.Region == "AMS") {
		  if (vl == "Edge") config.dataset.AssignToTeam = result[0].teamName;
		  else {
			if (config.dataset.CountryCode != "BR") config.dataset.AssignToTeam = result[1].teamName;
			else config.dataset.AssignToTeam = result[0].teamName;
		  }
		} else if (config.dataset.Region == "APJ") {
		  if (vl == "Edge") config.dataset.AssignToTeam = result[0].teamName;
		  else {
			if (config.dataset.CountryCode == "IN") config.dataset.AssignToTeam = result[0].teamName;
			else if (config.dataset.CountryCode == "JP") config.dataset.AssignToTeam = result[5].teamName;
			else if (config.dataset.CountryCode == "KR") config.dataset.AssignToTeam = result[3].teamName;
			else if (config.dataset.CountryCode == "AU" || config.dataset.CountryCode == "NZ") config.dataset.AssignToTeam = result[2].teamName;
			else if (config.dataset.CountryCode == "HK" || config.dataset.CountryCode == "TW") config.dataset.AssignToTeam = result[1].teamName;
			else if (config.dataset.CountryCode == "CN") config.dataset.AssignToTeam = result[6].teamName;
			else config.dataset.AssignToTeam = result[4].teamName;
		  }
		} else config.dataset.AssignToTeam = "OTC WW ComputeStorage EAAS";


		// 1.1 PREVENT DUPLICATE PURCHASE ORDER
		// 1.1.1 SET REQUEST ARGUEMENTS
		var params = "pon=" + config.dataset.PO_Number + "&pid=" + config.dataset.PartyId;
		var view = "3179";
		// 1.1.2 REQUEST REFERENCE DATA TO CHECK FOR EXISTING PURCHASE ORDER
		crud.read(view, params, function(data) {
		  // 1.1.3 EXISTING RECORD IDENTIFIED
		  if (data.Rows.length > 0) {
			if (!config.dataset.EntryId) {
			  var template = hpe.fn.lang("Form449", config.locale, config.localizations);
			  // Content template
			  if (data.Rows.length > 1)
				template = template + '<br>' + '<span id="viewExisting" style="text-decoration:underline;cursor:pointer">' + hpe.fn.lang("Form451", config.locale, config.localizations) + '</span>';
			  else
				template = template + '<br>' + '<span id="viewExisting" style="text-decoration:underline;cursor:pointer">' + hpe.fn.lang("Form452", config.locale, config.localizations) + ' ' + data.Rows[0].PO_Number + '</span>';

			  mo.fn.modal.show({
				ctaLabel: hpe.fn.lang("OK", config.locale, config.localizations),
				content: template,
				contentCallback: function() {
				  document.querySelector("#viewExisting").addEventListener("click", function(e) {
					config.dataset = data.Rows[0];
					mo.fn.modal.hide();
					mo.fn.overlay.show({
					  loading: true,
					  close: false
					});
					nbsf.init(config, 0);
					nbsf.init(config, 0);
					mo.fn.events.closeAll();
					mo.fn.overlay.hide();
				  });
				},
				title: hpe.fn.lang('Form450', config.locale, config.localizations),
				closeLabel: hpe.fn.lang("CLOSE", config.locale, config.localizations),
				ctaCallback: function() {
				  if (config.dataset.Config_Quote == 'Y' && quoteHelper.quote) {
					config.dataset.QuoteResponse = JSON.stringify(quoteHelper.quote);
				  }
				  crud.create(3158, config.dataset, function(data) {
					if (typeof(data.EntryId) === "number") {
					  // UPDATE REFERENCE APPLICATION WITH RESPONSE
					  config.dataset = data;
					  config.dataset.internalUser = global.data.user.internal;
					  nbsf.init(config, config.page + 1);
					  mo.fn.events.closeAll();
					  mo.fn.overlay.hide();
					} else {
					  mo.fn.overlay.hide();
					  mo.fn.modal.show({
						ctaLabel: hpe.fn.lang('OK', config.locale, config.localizations),
						title: hpe.fn.lang("ErrorGeneric2", config.locale, config.localizations),
						content: '<p>' + hpe.fn.lang("ErrorSubmit", config.locale, config.localizations) + '</p>'
					  });
					}
				  });
				}
			  })
			} else {
			  //config.dataset.aggrVal = JSON.stringify(global.data.brt.pas);
			  config.dataset.aggrVal = "0";
			  if (global.data.brt.pas.length > 0) {
				config.dataset.aggrVal = "1";
			  }

			  config.dataset.Status = '0';
			  var OptAtt = document.querySelector('[data-name="Optional_Attachment"]');
			  if (
				config.dataset.Optional_Attachment &&
				OptAtt &&
				$(OptAtt).data('kendoUpload') &&
				$(OptAtt).data('kendoUpload').getFiles() &&
				$(OptAtt).data('kendoUpload').getFiles().length > 0
			  ) {
				config.dataset.Optional_Attachment =
				  new DOMParser().parseFromString($(OptAtt).data('kendoUpload').getFiles()[0].name, "text/html").documentElement.textContent;
			  }
			  if (config.dataset.Config_Quote == 'Y' && quoteHelper.quote) {
				config.dataset.QuoteResponse = JSON.stringify(quoteHelper.quote);
			  }
			  crud.update("3163", config.dataset.EntryId, config.dataset, function(data) {
				if (typeof(data.EntryId) === "number") {
				  // UPDATE REFERENCE APPLICATION WITH RESPONSE
				  config.dataset = data;
				  config.dataset.internalUser = global.data.user.internal;
				  nbsf.init(config, config.page + 1);
				  mo.fn.overlay.hide();
				} else {
				  mo.fn.overlay.hide();
				  mo.fn.modal.show({
					ctaLabel: hpe.fn.lang('OK', config.locale, config.localizations),
					title: hpe.fn.lang("ErrorGeneric2", config.locale, config.localizations),
					content: '<p>' + hpe.fn.lang("ErrorSubmit", config.locale, config.localizations) + '</p>'
				  });
				}
			  });
			}
		  } else {
			//config.dataset.aggrVal = JSON.stringify(global.data.brt.pas);
			config.dataset.aggrVal = "0";
			if (global.data.brt.pas.length > 0)
			  config.dataset.aggrVal = "1";
			config.dataset.Status = '0';
			if (config.dataset.EntryId) {
			  if (config.dataset.Config_Quote == 'Y' && quoteHelper.quote) {
				config.dataset.QuoteResponse = JSON.stringify(quoteHelper.quote);
			  }
			  crud.update("3163", config.dataset.EntryId, config.dataset, function(data) {
				if (typeof(data.EntryId) === "number") {
				  // UPDATE REFERENCE APPLICATION WITH RESPONSE
				  config.dataset = data;
				  config.dataset.internalUser = global.data.user.internal;
				  nbsf.init(config, config.page + 1);
				  mo.fn.overlay.hide();
				} else {
				  mo.fn.overlay.hide();
				  mo.fn.modal.show({
					ctaLabel: hpe.fn.lang('OK', config.locale, config.localizations),
					title: hpe.fn.lang("ErrorGeneric2", config.locale, config.localizations),
					content: '<p>' + hpe.fn.lang("ErrorSubmit", config.locale, config.localizations) + '</p>'
				  });
				}
			  });
			} else {
			  //config.dataset.OnBehalf_CreatedBy = '[SSOData.Email]';
			  if (config.dataset.Config_Quote == 'Y' && quoteHelper.quote) {
				config.dataset.QuoteResponse = JSON.stringify(quoteHelper.quote);
			  }
			  crud.create(3158, config.dataset, function(data) {
				if (typeof(data.EntryId) === "number") {
				  // UPDATE REFERENCE APPLICATION WITH RESPONSE
				  config.dataset = data;
				  config.dataset.internalUser = global.data.user.internal;
				  nbsf.init(config, config.page + 1);
				  mo.fn.overlay.hide();
				} else {
				  elog('Failed to create record in RFB');
				  mo.fn.overlay.hide();
				  mo.fn.modal.show({
					ctaLabel: hpe.fn.lang('OK', config.locale, config.localizations),
					title: hpe.fn.lang("ErrorGeneric2", config.locale, config.localizations),
					content: '<p>' + hpe.fn.lang("ErrorSubmit", config.locale, config.localizations) + '</p>'
				  });
				}
			  });
			}
		  }
		});

		window.scrollTo({
		  top: 0,
		  behavior: 'smooth'
		});
		window.parent.postMessage(JSON.stringify({
		  "top": true
		}), "*");
	  }

	  function optionalInfoModal() {
		mo.fn.modal.show({
		  ctaLabel: hpe.fn.lang("Yes", config.locale, config.localizations),
		  title: hpe.fn.lang("OptionalInformation", config.locale, config.localizations),
		  content: '<p>' + hpe.fn.lang("ModalOptMSG", config.locale, config.localizations) + '</p>',
		  close: true,
		  closeLabel: hpe.fn.lang("No", config.locale, config.localizations),
		  contentCallback: function() {
			setTimeout(function() {
			  var modal = document.querySelector('.dxpModal');
			  var modalPosition = modal.getBoundingClientRect();
			  var message = {
				type: 'MODAL_OPENED',
				top: modalPosition.top
			  };
			  window.parent.postMessage(JSON.stringify(message), '*');
			  mo.fn.overlay.show({
				close: false
			  });
			}, 100);

			function closeAndGo() {
			  nbsf.init(config, config.pages.length - 1);
			  document.querySelector(".dxpModalFooter .modalCloseButton").removeEventListener("click", closeAndGo);
			}
			document.querySelector(".dxpModalFooter .modalCloseButton").addEventListener("click", closeAndGo);
		  },
		  ctaCallback: function() {
			console.log("config.pages", config.pages)
			nbsf.init(config, config.pages.length - 3);
			mo.fn.events.closeAll();
		  }
		});
	  }

	  function delivery(value) {
		if (typeof(value) === "undefined" || value == null || value.indexOf("/") == -1) return true;
		else {
		  var ddate = value.split("/");
		  var unix = new Date(ddate[2], parseInt(ddate[1]) - 1, parseInt(ddate[0]) + 1, 0, 0, 0, 0).getTime();
		  var delta = unix - new Date().getTime();
		  if (delta < 7862400000 && delta > 0) return true;
		  else return false;
		}
	  }
	  
	  function emailAddressValidation(value) {
		const addressPage = config.pages[config.page].addressPage;
		const pageMapping = {
		  billto: 'BillTo_Contact_Email',
		  payer: 'Payer_Contact_Email',
		  shipping: 'ShipTo_Contact_Email',
		};
		if (addressPage && pageMapping[addressPage]) {
		  const value = config.dataset[pageMapping[addressPage]];
		  if (value && !nbsf.vld.isEmail(value)) {
			return false;
		  }
		}
		return true;
	  }

	  //if PartnerBRT is one of the Distributor, OEM Distributor, System Integrator and the PO_BusinessModel is Agent Model" or HPFS & Agent Model, open the optional info modal
	  if (
		["Distributor", "OEM Distributor", "System Integrator"].includes(config.dataset.PartnerBRT) && ["Agent Model", "HPFS & Agent Model"].includes(config.dataset.PO_BusinessModel) &&
		(document.querySelector("input[data-name=AgentProgram_CompanyName]"))
	  ) {
		optionalInfoModal();
	  }
	  //if the page is Custom Ship To Party Information and the PO_DeliveryIncoterms is not DDP (for Americas), open the optional info modal
	  else if (
		(
		  (config.dataset.SubRegion == "Latin America" && config.dataset.PO_DeliveryIncoterms != "DDP") ||
		  (config.dataset.SubRegion == "North America" && config.dataset.PO_DeliveryIncoterms != "DDP")
		) &&
		(!["Distributor", "OEM Distributor", "System Integrator"].includes(config.dataset.PartnerBRT) ||
		 !["Agent Model", "HPFS & Agent Model"].includes(config.dataset.PO_BusinessModel)
		) &&
		(document.querySelector("input[data-name=CustomShipTo_CompanyName]"))
	  ) {
		optionalInfoModal();
	  }
	  //if the page is ship to information and the PO category is stocking, open the optional info modal
	  else if (
		(
		  (config.dataset.SubRegion != "Latin America" || config.dataset.PO_DeliveryIncoterms == "DDP") &&
		  (config.dataset.SubRegion != "North America" || config.dataset.PO_DeliveryIncoterms == "DDP")
		) &&
		config.dataset.PO_Category == "Stock" &&
		(document.querySelector("input[data-name=ShipTo_PartyId]") || document.querySelector("input[data-name=ShipTo_Contact_FirstName]"))
	  ) {
		optionalInfoModal();
	  }
	  //else for the PO category staging or drop shipment
	  else if (["Stage", "Drop"].includes(config.dataset.PO_Category) &&
			   (
		(document.querySelector("input[data-name=EndCx_PartyId]") || document.querySelector("input[data-name=EndCx_Contact_FirstName]")) ||
		(document.querySelector("input[data-name=Reseller_PartyId]") || document.querySelector("input[data-name=Reseller_Contact_FirstName]")) ||
		(document.querySelector("input[data-name=ShipTo_PartyId]") || document.querySelector("input[data-name=ShipTo_Contact_FirstName]"))
	  )) {
		//opens the modal on the end customer or reseller page, depending the switches
		if ((document.querySelector("input[data-name=EndCx_PartyId]") || document.querySelector("input[data-name=EndCx_Contact_FirstName]")) &&
			!["Distributor", "OEM Distributor", "System Integrator"].includes(config.dataset.PartnerBRT)) {
		  optionalInfoModal();
		} else if (!["Distributor", "OEM Distributor", "System Integrator"].includes(config.dataset.PartnerBRT) &&
				   config.dataset.Config_EndCxDetails == 'Y' && config.dataset.Config_EndCxDetails_Contact == 'Y' &&
				   (document.querySelector("input[data-name=ShipTo_PartyId]") || document.querySelector("input[data-name=ShipTo_Contact_FirstName]"))) {
		  optionalInfoModal();
		} else if (["Distributor", "OEM Distributor", "System Integrator"].includes(config.dataset.PartnerBRT) &&
				   config.dataset.Config_ResellerDetails == 'Y' && config.dataset.Config_ResellerDetails_Contact == 'Y' &&
				   config.dataset.Config_EndCxDetails == 'Y' && config.dataset.Config_EndCxDetails_Contact == 'Y' &&
				   (document.querySelector("input[data-name=ShipTo_PartyId]") || document.querySelector("input[data-name=ShipTo_Contact_FirstName]"))) {
		  optionalInfoModal();
		} else if (config.dataset.Config_ResellerDetails == 'Y' && config.dataset.Config_ResellerDetails_Contact == 'Y' &&
				   (document.querySelector("input[data-name=EndCx_PartyId]") || document.querySelector("input[data-name=EndCx_Contact_FirstName]"))) {
		  optionalInfoModal();
		} else if (
		  (
			(config.dataset.SubRegion != "Latin America" || config.dataset.PO_DeliveryIncoterms == "DDP") &&
			(config.dataset.SubRegion != "North America" || config.dataset.PO_DeliveryIncoterms == "DDP")
		  ) &&
		  (!["Distributor", "OEM Distributor", "System Integrator"].includes(config.dataset.PartnerBRT) ||
		   !["Agent Model", "HPFS & Agent Model"].includes(config.dataset.PO_BusinessModel)
		  ) &&
		  (document.querySelector("input[data-name=Reseller_PartyId]") || document.querySelector("input[data-name=Reseller_Contact_FirstName]"))
		) {
		  optionalInfoModal();
		} else if (!emailAddressValidation()) {
		  $('.nbsf .continue').addClass('disabled');
		} else doNext();
	  } else if (document.querySelector("input[data-name=Config_SoldToDetails]")) {
		if (
		  document.querySelector("input[data-name=Config_SoldToDetails]").value == "Y" &&
		  // document.querySelector("input[data-name=Config_SoldToDetails_Contact]").value == "Y" &&
		  document.querySelector("input[data-name=Config_PayerDetails]").value == "Y" &&
		  document.querySelector("input[data-name=Config_BillToDetails]").value == "Y" &&
		  (!document.querySelector("input[data-name=Config_ShipToDetails]") || document.querySelector("input[data-name=Config_ShipToDetails]").value == "Y") &&
		  (!document.querySelector("input[data-name=Config_ResellerDetails]") || document.querySelector("input[data-name=Config_ResellerDetails]").value == "Y") &&
		  (!document.querySelector("input[data-name=Config_ResellerDetails_Contact]") || document.querySelector("input[data-name=Config_ResellerDetails_Contact]").value == "Y") &&
		  (!document.querySelector("input[data-name=Config_EndCxDetails]") || document.querySelector("input[data-name=Config_EndCxDetails]").value == "Y") &&
		  (!document.querySelector("input[data-name=Config_EndCxDetails_Contact]") || document.querySelector("input[data-name=Config_EndCxDetails_Contact]").value == "Y")
		) {
		  optionalInfoModal();
		} else if (!emailAddressValidation()) {
		  $('.nbsf .continue').addClass('disabled');
		} else doNext();
	  } else if (document.querySelector("input[data-name=Config_PPC_SoldTo]")) {
		if (
		  document.querySelector("input[data-name=Config_PPC_SoldTo]").value == "Y" &&
		  document.querySelector("input[data-name=Config_PPC_Payer]").value == "Y" &&
		  document.querySelector("input[data-name=Config_PPC_BillTo]").value == "Y" &&
		  document.querySelector("input[data-name=Config_PPC_ShipTo]").value == "Y" &&
		  (!document.querySelector("input[data-name=Config_PPC_Reseller]") || document.querySelector("input[data-name=Config_PPC_Reseller]").value == "Y") &&
		  (!document.querySelector("input[data-name=Config_PPC_EndCx]") || document.querySelector("input[data-name=Config_PPC_EndCx]").value == "Y")
		) {
		  optionalInfoModal();
		} else if (!emailAddressValidation()) {
		  $('.nbsf .continue').addClass('disabled');
		} else doNext();
	  } else if (config.page == 0 && global.data.user.internal) {
		mo.fn.overlay.show({
		  loading: true,
		  close: false
		});

		if (document.querySelector("select[data-name=OnBehalf_Type]").value == 'Company') {

		  const PartySearch = new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: "https://hpe-rfb.it.hpe.com/form/data-set-provider/v2/989/NOR_EMDM_PartyData/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  model: {
				id: "EntryId",
				fields: {}
			  }
			},
			serverFiltering: true,
			filter: {
			  field: 'party_id',
			  operator: 'eq',
			  value: document.querySelector("input[data-name=OnBehalf_PartyId]").value
			},
			serverPaging: true,
			pageSize: 1000,
			serverSorting: true,
		  });
		  PartySearch.read().then(function() {
			const view = PartySearch.view();
			console.log('PartySearch view', view);

			if (!view || !view.length) {
			  console.log('Party data not found');
			  mo.fn.modal.show({
				ctaLabel: hpe.fn.lang("OK", config.locale, config.localizations),
				title: hpe.fn.lang("ErrorGeneric", config.locale, config.localizations),
				content: '<p>' + hpe.fn.lang("ErrorPID", config.locale, config.localizations) + '</p>',
			  });
			} else {

			  const partyData = view.find(item => global.data.brts.find(brt => brt.name === item.BRT));
			  console.log('partyData', partyData);
			  if (partyData) {
				global.data.company.country = partyData.CountryEntity;
				global.data.company.global = partyData.CountryEntity;
				global.data.company.party = partyData.party_id;
				global.data.company.name = partyData.PartyName;
				global.data.geo.name = partyData.CountryName;
				global.data.geo.code = partyData.country_code;
				global.data.geo.geography = partyData.GEO;
				global.data.geo.region = partyData.Region;
				global.data.geo.subregion = partyData.SubRegion;

				global.data.brt.name = partyData.BRT;
				let brtCode = global.data.brts.filter(function(item) {
				  return (item.name == global.data.brt.name)
				});
				global.data.brt.code = brtCode[0].code;
				
				// new 
				let brts = view.filter(item => global.data.brts.find(brt => brt.name === item.BRT));
				const brts_names = brts.map(item => item.BRT);
				brts = global.data.brts.filter(item => brts_names.includes(item.name));
				let channels = [];
				let brt_codes = [];
				brts.forEach(item => {
				  channels = [...channels, ...item.channel];
				  brt_codes = [...brt_codes, item.code];
				});
				global.data.partyData = {
				  brts: brts_names || [],
				  channels,
				  codes: brt_codes
				}

				//  config.locale = global.data.user.locale;
				//  config.dom = document.querySelector('div[tab-id="oob"]');
				config.dataset.CountryEntity = global.data.company.country;
				config.dataset.PartyId = document.querySelector("input[data-name=OnBehalf_PartyId]").value;
				if (!config.dataset.PartnerBRT) {
				config.dataset.PartnerBRT = partyData.BRT;
				}
				config.dataset.PartnerName = partyData.PartyName;
				config.dataset.Country = partyData.CountryName;
				config.dataset.Region = global.data.geo.region;
				config.dataset.Geo = global.data.geo.geography;							 

				if (!global.data.brt.channel) {
				  // IT NEEDS TO BE AVAILABLE FOR THE iCERTIS CALL
				  for (let i = 0; i < global.data.brts.length; i++) {
					if (global.data.brt.code.toLowerCase() == global.data.brts[i].code.toLowerCase())
					  global.data.brt.channel = global.data.brts[i].channel;
				  }
				}

				// GET AGREEMENTS FROM ICM
				request.partyAgreements(global.data, function(data) {
				  console.log('request.agreements data', data);
				  if (data) {
					reference.agreements = data;
				  } else {
					// check if exception/demo account
					hpe.api.dataset({
					  form: '1585',
					  dataset: 'Reference_DemoAccounts',
					  payload: {
						filter: {
						  logic: "and",
						  filters: [{
							field: 'PartyId',
							operator: 'eq',
							value: global.data.company.party
						  },
									{
									  field: 'BRT',
									  operator: 'eq',
									  value: global.data.brt.name
									}
								   ]
						},
						skip: '0',
						pageSize: '1',
						take: '1'
					  }
					}, function(d) {
					  if (typeof(d) === 'object' && d.Success && d.Data.length == 1) {
						reference.agreements = [];
					  }
					  return mo.fn.overlay.hide();
					})
				  }
				  global.data.brt.pas = [];
				  reference.agreements.forEach(function(agreement) {
					global.data.brt.pas.push(agreement.iCMPANumber);
				  });
				  let chnls = global.data.brts.filter(function(item) {
					return (item.code == global.data.brt.code && item.name == global.data.brt.name)
				  });
				  chnls = chnls[0].channel;
				  global.data.brt.channel = chnls;

				  config.dataset.aggrVal = "0";
				  if (global.data.brt.pas.length > 0)
					config.dataset.aggrVal = "1";
				  reference.countriesRequest();
				  otherFunctions.lang();

				  loadPreferences().then(() => {
					crud.q.stop(function() {
					  hpe.data.xref(global.data.company.party, function(d) {
						global.data.company.party = d.party[0].currentPartyID || d.party[0].submittedPartyID;
						reference.xref = d;
						config.locale = global.data.user.locale;
						config.dom = document.querySelector('div[tab-id="oob"]');
						nbsf.init(config, config.page + 1);
						nbsf.init(config, config.page);
						mo.fn.events.closeAll();
						mo.fn.overlay.hide();
					  });
					});
				  })
				});

			  } else {
				console.log('No correct BRT');
				mo.fn.modal.show({
				  ctaLabel: hpe.fn.lang("OK", config.locale, config.localizations),
				  title: hpe.fn.lang("ErrorGeneric", config.locale, config.localizations),
				  content: '<p>' + hpe.fn.lang("ErrorPID04", config.locale, config.localizations) + '</p>',
				});
			  }
			}
		  });

		} else if (document.querySelector("select[data-name=OnBehalf_Type]").value == 'User') {
		  profile.get({
			email: document.querySelector('input[data-name="OnBehalf_CreatedBy"]').value,
			relationship: true,
			company: true,
			geography: true,
			business: true
		  }, function(d) {
			if (d.success) {
			  global.data.company.country = d.business.GroupId;
			  global.data.company.global = d.business.GroupId;
			  global.data.company.party = d.company.PartyId;
			  global.data.company.name = d.company.Name;
			  global.data.geo.name = d.geography.Name;
			  global.data.geo.code = d.geography.ISO2;
			  global.data.geo.geography = d.geography.GEO;
			  global.data.geo.region = d.geography.Region;
			  global.data.geo.subregion = d.geography.SubRegion;
			  global.data.user.hpp = d.user.HPPId;
			  //global.data.company.brt.brTypeName = d.relationship.BRType;
			  global.data.brt.name = d.relationship.BRType;
			  hpe.api.dataset({
				form: "989",
				dataset: "SOR_BRT_SIM_Extended",
				payload: {
				  filter: {
					logic: "and",
					filters: [{
					  logic: "or",
					  filters: [{
						field: 'parent_entity',
						operator: 'eq',
						value: d.business.GroupId
					  },
								{
								  field: 'party_id',
								  operator: 'eq',
								  value: d.company.PartyId
								}
							   ]
					},
							  {
								field: 'relationship',
								operator: 'eq',
								value: d.relationship.BRType
							  },
							  {
								field: 'status',
								operator: 'eq',
								value: 'ACTIVE'
							  }
							 ]
				  },
				  pageSize: 1000
				}
			  }, function(dataset) {
				global.data.sim = [...new Set(dataset.Data.map(item => item.SIM_ISO2))];
			  });
			  let brtCode = global.data.brts.filter(function(item) {
				return (item.name == global.data.brt.name)
			  });
			  global.data.brt.code = brtCode[0].code;

			  config.dataset.FirstName = d.user.FirstName;
			  config.dataset.LastName = d.user.LastName;
			  config.dataset.Language = 'en_US';
			  config.dataset.CountryEntity = global.data.company.country;
			  config.dataset.PartyId = d.company.PartyId;
			  config.dataset.PartnerBRT = global.data.brt.name;
			  config.dataset.PartnerName = global.data.company.name;
			  config.dataset.Country = global.data.geo.name;
			  config.dataset.Region = global.data.geo.region;
			  config.dataset.Geo = global.data.geo.geography;

			  if (!global.data.brt.channel) {
				// IT NEEDS TO BE AVAILABLE FOR THE iCERTIS CALL
				for (let i = 0; i < global.data.brts.length; i++) {
				  if (global.data.brt.code.toLowerCase() == global.data.brts[i].code.toLowerCase())
					global.data.brt.channel = global.data.brts[i].channel;
				}
			  }

			  // GET AGREEMENTS FROM ICM
			  request.agreements(global.data, function(data) {
				console.log('111')
				if (data) {
				  reference.agreements = data;
				} else {
				  // check if exception/demo account
				  hpe.api.dataset({
					form: '1585',
					dataset: 'Reference_DemoAccounts',
					payload: {
					  filter: {
						logic: "and",
						filters: [{
						  field: 'PartyId',
						  operator: 'eq',
						  value: global.data.company.party
						},
								  {
									field: 'BRT',
									operator: 'eq',
									value: global.data.brt.name
								  }
								 ]
					  },
					  skip: '0',
					  pageSize: '1',
					  take: '1'
					}
				  }, function(d) {
					if (typeof(d) === 'object' && d.Success && d.Data.length == 1) {
					  reference.agreements = [];
					}
					return mo.fn.overlay.hide();
				  })
				}
				global.data.brt.pas = [];
				reference.agreements.forEach(function(agreement) {
				  global.data.brt.pas.push(agreement.iCMPANumber);
				});
				let chnls = global.data.brts.filter(function(item) {
				  return (item.code == global.data.brt.code && item.name == global.data.brt.name)
				});
				chnls = chnls[0].channel;
				global.data.brt.channel = chnls;
				//config.dataset.aggrVal = JSON.stringify(global.data.brt.pas);
				config.dataset.aggrVal = "0";
				if (global.data.brt.pas.length > 0)
				  config.dataset.aggrVal = "1";
				reference.countriesRequest();
				otherFunctions.lang();

				loadPreferences().then(() => {
				  crud.q.stop(function() {
					hpe.data.xref(global.data.company.party, function(d) {
					  global.data.company.party = d.party[0].currentPartyID || d.party[0].submittedPartyID;
					  reference.xref = d;
					  config.locale = global.data.user.locale;
					  config.dom = document.querySelector('div[tab-id="oob"]');
					  nbsf.init(config, config.page + 1);
					  nbsf.init(config, config.page);
					  mo.fn.events.closeAll();
					  mo.fn.overlay.hide();
					});
				  });
				});
			  });
			} else {
			  mo.fn.modal.show({
				ctaLabel: hpe.fn.lang("OK", config.locale, config.localizations),
				title: hpe.fn.lang("ErrorGeneric", config.locale, config.localizations),
				content: '<p>' + hpe.fn.lang("ErrorPID03", config.locale, config.localizations) + '</p>',
			  });
			}
		  })
		}
	  } else if (config.pages[config.page].id == "PS") {
		doNext();
	  } else if (config.page == 1) {
		nbsf.init(config, config.page + 1);
		nbsf.init(config, config.page);
	  } else {
		if (!delivery(config.dataset.PO_DeliveryDate)) {
		  $('.nbsf .continue').addClass('disabled');
		  mo.fn.modal.show({
			ctaLabel: hpe.fn.lang("OK", config.locale, config.localizations),
			title: hpe.fn.lang("ModalDeliveryDate", config.locale, config.localizations),
			content: '<p>' + hpe.fn.lang("ModalDeliveryDateMSG", config.locale, config.localizations) + '</p>',
		  });
		} else if (!emailAddressValidation()) {
		  $('.nbsf .continue').addClass('disabled');
		} else {
		  doNext();
		}
	  }
	},
	onPrev: function() {
	  mo.fn.overlay.show({
		loading: true,
		close: false
	  });
	  const currentPage = global.data.user.internal ? config.pages[config.page - 2] : config.pages[config.page - 1];
	  if (config.page > 1 && currentPage.id == "PS") {
		quoteHelper.configureProductAndServices(config, currentPage, function() {
		  console.log("CONFIG:", this);
		  console.log("CURRENT:", this.page);
		  console.log("PREV:", this.page - 1);
		  console.log("DATA:", this.dataset);
		  nbsf.init(config, config.page - 1);
		  nbsf.init(config, config.page);
		  mo.fn.overlay.hide();

		  window.scrollTo({
			top: 0,
			behavior: 'smooth'
		  });
		  window.parent.postMessage(JSON.stringify({
			"top": true
		  }), "*");
		});
	  } else {
		console.log("CONFIG:", this);
		console.log("CURRENT:", this.page);
		console.log("PREV:", this.page - 1);
		console.log("DATA:", this.dataset);
		nbsf.init(config, config.page - 1);
		nbsf.init(config, config.page);
		mo.fn.overlay.hide();

		window.scrollTo({
		  top: 0,
		  behavior: 'smooth'
		});
		window.parent.postMessage(JSON.stringify({
		  "top": true
		}), "*");
	  }
	},
	onSubmit: function() {
	  mo.fn.overlay.show({
		loading: true,
		close: false
	  });
	  request.timestamp(function(t) {
		// SET SUBMISSION INFO
		config.dataset.OnBehalf_SubmittedBy = '[SSOData.Email]';
		config.dataset.Requestor_Email = '[SSOData.Email]';
		
		

		// Don't override user's data if exist for case description
		if (!(config.dataset.OnBehalf_CreatedBy && config.dataset.LastName)) {
		  config.dataset.FirstName = '[SSOData.FirstName]';
		  config.dataset.LastName = '[SSOData.LastName]';
		}
		
		// Don't use empty value for Requestor_PO_Opp_ID
		if (config.dataset.Requestor_PO_Opp_ID == 'OPE-') {
		  config.dataset.Requestor_PO_Opp_ID = null;
		}

		// Get rid of 'Select one' values in xxx_Country
		const selectOneValue = config.pages[1].selectone;
		Object.keys(config.dataset).forEach((key) => {
		  if (key.endsWith("_Country") && config.dataset[key] == selectOneValue) {
			config.dataset[key] = null;
		  }
		})

		// Removed due to a request here https://hpheroes.atlassian.net/browse/NOR-664?focusedCommentId=57475
		//quoteHelper.clearPOData(config);
		
		config.dataset.RequestorRole = 'Partner';
		if (global.data.user.internal) config.dataset.RequestorRole = 'HPE Internal';
		let isDraft = config.dataset.isDraft;
		
		if (config.dataset.PO_Category == "Stock") {
		  quoteHelper.clearAddressData(config, 'EndCustomer');
		}
		
		// BUILD SFDC CASE DESCRIPTION
		var pairs = [];
		if (global.data.user.internal) {
		  for (i = 0; i < config.pages.length; i++) {
			var cPage = config.pages[i];
			var cStructure = cPage.structure;
			var cFilter = true;
			if (typeof(cPage.filter) === "object") cFilter = nbsf.fn.filter(config.dataset, cPage.filter);
			if (cPage.quotePreview || cPage.review) cFilter = false;

			if (
			  config.dataset.Config_Quote == 'Y' &&
			  config.dataset.Quote_Error != 'Y' &&
			  //  quoteHelper.quote &&
			  (
				["CERTA", "CETA", "Latin America", "North America"].includes(config.dataset.Geo) ||
				config.dataset.SubRegion === "MESA" ||
				config.dataset.internalUser || global.nonPoModelCountries.includes(config.dataset.CountryCode)
			  )
			) {
			  console.log('config.summary', config.summary);
			  if (cPage.addressPage && config.summary[cPage.addressPage]) cFilter = true;
			}

			if (cFilter) {
			  var hdr = {
				ttl: "page-" + i,
				val: hpe.fn.lang(cPage.title, config.locale, config.localizations)
			  };
			  if (cPage.id == "PS") {
				pairs.push(hdr);
				let PSTable = ''; 
				if (config.dataset.Config_Quote_PartialOrder) {
					try {
					  let PSData = JSON.parse(config.dataset.Config_Quote_PartialOrder);
					  PSData = PSData.filter(item => item.Selected == "Y");
					  if (PSData.length) {
						// headers
						const stylePS = "text-align: left;vertical-align: top;font-weight: 400;border-bottom: 1px solid #eee;padding: 8px 10px";
						const prevProdExists = PSData.some(item => !!item.PreviouslyPurchasedProductDetails || !!item.SerialNumberOfProducts || !!item.ProductPurchasedDate);
						PSTable = `<table cellspacing="0" style="border-collapse: collapse;border-spacing: 0">
<tr>
    <th style="${stylePS}">HPE Part Number</th>
    <th style="${stylePS}">HPE Part Quantity</th>
    <th style="${stylePS}">Deal ID</th>
    <th style="${stylePS}">bundle ID / Icon ID</th>
    <th style="${stylePS}">Unit Price</th>
    <th style="${stylePS}">Extended Net Price</th>`;
						if (prevProdExists) {
						  PSTable = PSTable +
`   <th style="${stylePS}">Previously Purchased Product Details</th>
    <th style="${stylePS}">Serial number of the products</th>
    <th style="${stylePS}">Product Purchased Date</th>`;
						}
						PSTable = PSTable + "</tr>";

						PSData.forEach(item => {
						  PSTable = PSTable + `<tr>
	<td style="${stylePS}">${item.ProductID  || ''}</td>
	<td style="${stylePS}">${item.Count  || ''}</td>
	<td style="${stylePS}">${item.DealId  || ''}</td>
	<td style="${stylePS}">${item.BundleID  || ''}</td>
	<td style="${stylePS}">${item.UnitNetAmount  || ''}</td>
	<td style="${stylePS}">${item.ExtendedNetAmount  || ''}</td>`
						  if (prevProdExists) {
							PSTable = PSTable +
`	<td style="${stylePS}">${item.PreviouslyPurchasedProductDetails || ''}</td>
	<td style="${stylePS}">${item.SerialNumberOfProducts  || ''}</td>
	<td style="${stylePS}">${item.ProductPurchasedDate  || ''}</td>`
						  }
						  PSTable = PSTable + "</tr>";
						});
						PSTable = PSTable + `</table>`;
					  }
					} catch(e) {}
				  var obj = {
					ttl: "",
					val: PSTable,
					data: "ProductAndServices",
					id: cPage.id,
				  };
				  pairs.push(obj);
				}
				
			  } else {
				if (global.data.user.internal) {
				  if (hdr.ttl != "page-0")
					pairs.push(hdr);
				} else pairs.push(hdr);

				for (j = 0; j < cStructure.length; j++) {
				  var cFilter = true;
				  if (typeof(cStructure[j].filter) === "object") cFilter = nbsf.fn.filter(config.dataset, cStructure[j].filter);
				  if (cFilter) {
					for (k = 0; k < cStructure[j].group.length; k++) {
					  var cGroup = cStructure[j].group[k];
					  for (l = 0; l < cGroup.length; l++) {
						var cInput = cGroup[l];
						if (cInput.type != "hidden") {
						  var obj = {
							ttl: "N/A",
							val: "N/A",
							data: "N/A"
						  }
						  if (typeof(cInput.label) !== "undefined" && cInput.label.length > 0) obj.ttl = hpe.fn.lang(cInput.label, config.locale, config.localizations);
						  else if (typeof(cInput.data) !== "undefined" && cInput.data.length > 0) obj.ttl = cInput.data;
						  if (
							typeof(cInput.data) !== "undefined" &&
							typeof(config.dataset[cInput.data]) !== "undefined" &&
							config.dataset[cInput.data] != null &&
							config.dataset[cInput.data].length > 0 && ["NA@IGNOREME.COM", "Select one", "+1000000000"].indexOf(config.dataset[cInput.data]) == -1
						  ) {
							if (config.dataset[cInput.data] == "Y") obj.val = hpe.fn.lang("Yes", config.locale, config.localizations);
							else if (config.dataset[cInput.data] == "N") obj.val = hpe.fn.lang("No", config.locale, config.localizations);
							else if (config.dataset[cInput.data] == "NA") obj.val = "N/A";
							else if (cInput.data == "PO_Attachment") obj.val = '<a href="https://hpe-rfb.it.hpe.com/form/989/attachments/' + config.dataset.EntryId + '/PO_Attachment?name=' + config.dataset[cInput.data] + '">' + config.dataset[cInput.data] + '</a>';
							else obj.val = config.dataset[cInput.data];
						  }
						  if (obj.val != "N/A") {
							obj.data = cInput.data;
							pairs.push(obj);
						  }
						}
					  }
					}
				  }
				}
				var obj = pairs[pairs.length - 1];
				//  console.log("obj", obj);
				if (obj.ttl.indexOf("page-") > -1) {
				  pairs.pop();
				}
				if (obj.data == "OnBehalf_CreatedBy") {
				  // Delete the first pairs - 'On behalf of' and either 'Email' or 'Party ID'
				  pairs.shift();
				  const secondPair = pairs.shift();
				  if (secondPair.data == "OnBehalf_PartyId") {
					pairs.shift();
				  }
				}
			  }
			}
		  }
		  //  console.log("pairs", pairs);
		  var caseDescription = "";
		  for (i = 0; i < pairs.length; i++) {
				let pairVal = pairs[i].val;
				if (pairVal) pairVal = pairVal.trim();
			if (pairs[i].id === "PS") {
			  caseDescription = caseDescription + "<br><br>";
			  caseDescription = caseDescription + "<strong>" + "Stand alone products and services" + "</strong><br>";
			  caseDescription = caseDescription + pairVal + "<br>";
			  
			} else if (pairs[i].ttl != null && pairs[i].ttl.indexOf("page-") > -1) {
			  caseDescription = caseDescription + "<br><br>";
			  if (i == 0) {
				caseDescription = caseDescription + "<strong>" + hpe.fn.lang("FormCFI018", config.locale, config.localizations) + "</strong><br>";
			  } else {
				if (pairs[i].ttl == "page-2") {
				  caseDescription = caseDescription + "<strong>" + hpe.fn.lang("Form518", config.locale, config.localizations) + "</strong><br>";
				//  const po_n = config.dataset.PO_Number && config.dataset.PO_Number.replace(/\s/g, "_") || "nor";
				  let pdfUrl = `https://hpe-rfb.it.hpe.com/form/989/attachments/${config.dataset.EntryId}/PDF?downloadFileName=${encodeURIComponent(config.dataset.PO_Number)}.pdf`;
				  caseDescription = caseDescription +  `<a href="${pdfUrl}" target="_blank">` + hpe.fn.lang("POPDFLink", config.locale, config.localizations) + '</a><br>';
				}
				else if (pairs[i].ttl == "page-3")
				  caseDescription = caseDescription + "<strong>" + hpe.fn.lang("FormCFI019", config.locale, config.localizations) + "</strong><br>";
				else
				  caseDescription = caseDescription + "<strong>" + pairVal + "</strong><br>";
			  }
			}
			else {
			  if (["PA_Number"].indexOf(pairs[i].data) > -1) {
				caseDescription = caseDescription + "<br><br>";
				caseDescription = caseDescription + "<strong>" + hpe.fn.lang("Form023", config.locale, config.localizations) + "</strong><br>";
				caseDescription = caseDescription + pairs[i].ttl + ": " + pairVal + "<br>";
			  } else if (["Config_Quote", "Config_aaS"].indexOf(pairs[i].data) > -1) {
				if (["North America"].indexOf(global.data.geo.geography) > -1) {
				  /*  if (pairs[i].data == "Config_aaS") {
                                          caseDescription = caseDescription + "<br><br>";
                                          caseDescription = caseDescription + "<strong>" + hpe.fn.lang("Form075", config.locale, config.localizations) + "</strong><br>";
                                          caseDescription = caseDescription + pairs[i].ttl + ": " + pairVal + "<br>";
                                      } else */
				  if (pairs[i].data == "Config_Quote") {
					caseDescription = caseDescription + pairs[i].ttl + ": " + pairVal + "<br>";
				  }
				} else {
				  caseDescription = caseDescription + "<br><br>";
				  caseDescription = caseDescription + "<strong>" + hpe.fn.lang("Form075", config.locale, config.localizations) + "</strong><br>";
				  caseDescription = caseDescription + pairs[i].ttl + ": " + pairVal + "<br>";
				}

			  } else if (["PO_DeliveryDate"].indexOf(pairs[i].data) > -1) {
				caseDescription = caseDescription + "<br><br>";
				caseDescription = caseDescription + "<strong>" + hpe.fn.lang("Form472", config.locale, config.localizations) + "</strong><br>";
				caseDescription = caseDescription + pairs[i].ttl + ": " + pairVal + " (DD/MM/YYYY)<br>";
			  } else if (["AssLoc_PartyId", "AssLoc_CompanyName", "AssLoc_Address_Street", "AssLoc_Address_Street2", "AssLoc_Address_City", "AssLoc_Address_State", "AssLoc_Address_Postal", "AssLoc_Address_Country"].indexOf(pairs[i].data) > -1) {
				if (caseDescription.indexOf(hpe.fn.lang("Form519", config.locale, config.localizations)) == -1) {
				  caseDescription = caseDescription + "<br><br>";
				  caseDescription = caseDescription + "<strong>" + hpe.fn.lang("Form519", config.locale, config.localizations) + "</strong><br>";
				}
				caseDescription = caseDescription + pairs[i].ttl + ": " + pairVal + "<br>";
			  } else if (["EntPrty_PartyId", "EntPrty_CompanyName", "EntPrty_Address_Street", "EntPrty_Address_Street2", "EntPrty_Address_City", "EntPrty_Address_State", "EntPrty_Address_Postal", "EntPrty_Address_Country", "EntPrty_Contact_FirstName", "EntPrty_Contact_LastName", "EntPrty_Contact_Phone", "EntPrty_Contact_Email", "EntPrty_Contact_Country"].indexOf(pairs[i].data) > -1) {
				if (caseDescription.indexOf(hpe.fn.lang("Form520", config.locale, config.localizations)) == -1) {
				  caseDescription = caseDescription + "<br><br>";
				  caseDescription = caseDescription + "<strong>" + hpe.fn.lang("Form520", config.locale, config.localizations) + "</strong><br>";
				}
				caseDescription = caseDescription + pairs[i].ttl + ": " + pairVal + "<br>";
			  } else if (["PSP_PartyId", "PSP_CompanyName", "PSP_Address_Street", "PSP_Address_Street2", "PSP_Address_City", "PSP_Address_State", "PSP_Address_Postal", "PSP_Address_Country"].indexOf(pairs[i].data) > -1) {
				if (caseDescription.indexOf(hpe.fn.lang("Form529", config.locale, config.localizations)) == -1) {
				  caseDescription = caseDescription + "<br><br>";
				  caseDescription = caseDescription + "<strong>" + hpe.fn.lang("Form529", config.locale, config.localizations) + "</strong><br>";
				}
				caseDescription = caseDescription + pairs[i].ttl + ": " + pairVal + "<br>";
			  } else {
				if (["NA", "N/A", " ", "", "OPE-", "Select one"].indexOf(pairVal) == -1)
				  caseDescription = caseDescription + pairs[i].ttl + ": " + pairVal + "<br>";
			  }
			}
		  }
		  config.dataset.CaseDescription = caseDescription;
		  //  console.log("CaseDescription: " + config.dataset.CaseDescription);
		} else {
		  for (i = 0; i < config.pages.length; i++) {
			var cPage = config.pages[i];
			var cStructure = cPage.structure;
			var cFilter = true;
			if (typeof(cPage.filter) === "object") cFilter = nbsf.fn.filter(config.dataset, cPage.filter);
			if (cPage.quotePreview) cFilter = false;

			if (
			  config.dataset.Config_Quote == 'Y' &&
			  config.dataset.Quote_Error != 'Y' &&
			  //  quoteHelper.quote &&
			  (
				["CERTA", "CETA", "Latin America", "North America"].includes(config.dataset.Geo) ||
				config.dataset.SubRegion === "MESA" ||
				config.dataset.internalUser || global.nonPoModelCountries.includes(config.dataset.CountryCode)
			  )
			) {
			  console.log('config.summary', config.summary);
			  if (cPage.addressPage && config.summary[cPage.addressPage]) cFilter = true;
			}

			if (cFilter) {
			  var hdr = {
				ttl: "page-" + i,
				val: hpe.fn.lang(cPage.title, config.locale, config.localizations)
			  };
			  
			  if (cPage.id == "PS") {
				pairs.push(hdr);
				let PSTable = ''; 
				if (config.dataset.Config_Quote_PartialOrder) {
				  try {
					let PSData = JSON.parse(config.dataset.Config_Quote_PartialOrder);
					PSData = PSData.filter(item => item.Selected == "Y");
					if (PSData.length) {
					  // headers
					  const stylePS = "text-align: left;vertical-align: top;font-weight: 400;border-bottom: 1px solid #eee;padding: 8px 10px";
					  const prevProdExists = PSData.some(item => !!item.PreviouslyPurchasedProductDetails || !!item.SerialNumberOfProducts || !!item.ProductPurchasedDate);
					  PSTable = `<table cellspacing="0" style="border-collapse: collapse;border-spacing: 0">
<tr>
<th style="${stylePS}">HPE Part Number</th>
<th style="${stylePS}">HPE Part Quantity</th>
<th style="${stylePS}">Deal ID</th>
<th style="${stylePS}">bundle ID / Icon ID</th>
<th style="${stylePS}">Unit Price</th>
<th style="${stylePS}">Extended Net Price</th>`;
					  if (prevProdExists) {
						PSTable = PSTable +
`<th style="${stylePS}">Previously Purchased Product Details</th>
<th style="${stylePS}">Serial number of the products</th>
<th style="${stylePS}">Product Purchased Date</th>`;
					  }
					  PSTable = PSTable + "</tr>";

					  PSData.forEach(item => {
						PSTable = PSTable + `<tr>
<td style="${stylePS}">${item.ProductID  || ''}</td>
<td style="${stylePS}">${item.Count  || ''}</td>
<td style="${stylePS}">${item.DealId  || ''}</td>
<td style="${stylePS}">${item.BundleID  || ''}</td>
<td style="${stylePS}">${item.UnitNetAmount  || ''}</td>
<td style="${stylePS}">${item.ExtendedNetAmount  || ''}</td>`
						if (prevProdExists) {
						  PSTable = PSTable +
`<td style="${stylePS}">${item.PreviouslyPurchasedProductDetails || ''}</td>
<td style="${stylePS}">${item.SerialNumberOfProducts  || ''}</td>
<td style="${stylePS}">${item.ProductPurchasedDate  || ''}</td>`
						}
						PSTable = PSTable + "</tr>";
					  });
					  PSTable = PSTable + `</table>`;
					}
				  } catch(e) {}
				  var obj = {
					ttl: "",
					val: PSTable,
					data: "ProductAndServices",
					id: cPage.id,
				  };
				  pairs.push(obj);
				}
			  } else {
				pairs.push(hdr);
				for (j = 0; j < cStructure.length; j++) {
				  var cFilter = true;
				  if (typeof(cStructure[j].filter) === "object") cFilter = nbsf.fn.filter(config.dataset, cStructure[j].filter);
				  if (cFilter) {
					for (k = 0; k < cStructure[j].group.length; k++) {
					  var cGroup = cStructure[j].group[k];
					  for (l = 0; l < cGroup.length; l++) {
						var cInput = cGroup[l];
						if (cInput.type != "hidden") {
						  var obj = {
							ttl: "N/A",
							val: "N/A",
							data: "N/A"
						  }
						  if (typeof(cInput.label) !== "undefined" && cInput.label.length > 0) obj.ttl = hpe.fn.lang(cInput.label, config.locale, config.localizations);
						  else if (typeof(cInput.data) !== "undefined" && cInput.data.length > 0) obj.ttl = cInput.data;
						  if (
							typeof(cInput.data) !== "undefined" &&
							typeof(config.dataset[cInput.data]) !== "undefined" &&
							config.dataset[cInput.data] != null &&
							config.dataset[cInput.data].length > 0 && ["NA@IGNOREME.COM", "Select one", "+1000000000"].indexOf(config.dataset[cInput.data]) == -1
						  ) {
							if (config.dataset[cInput.data] == "Y") obj.val = hpe.fn.lang("Yes", config.locale, config.localizations);
							else if (config.dataset[cInput.data] == "N") obj.val = hpe.fn.lang("No", config.locale, config.localizations);
							else if (config.dataset[cInput.data] == "NA") obj.val = "N/A";
							else if (cInput.data == "PO_Attachment") obj.val = '<a href="https://hpe-rfb.it.hpe.com/form/989/attachments/' + config.dataset.EntryId + '/PO_Attachment?name=' + config.dataset[cInput.data] + '">' + config.dataset[cInput.data] + '</a>';
							else obj.val = config.dataset[cInput.data];
						  }
						  if (obj.val != "N/A") {
							obj.data = cInput.data;
							pairs.push(obj);
						  }
						}
					  }
					}
				  }
				}
				var obj = pairs[pairs.length - 1];
				//console.log("obj", obj);
				if (obj.ttl.indexOf("page-") > -1) {
				  pairs.pop();
				}
			  }
			}
		  }
		  //  console.log("pairs", pairs);
		  var caseDescription = "";
		  for (i = 0; i < pairs.length; i++) {
			let pairVal = pairs[i].val;
			if (pairVal) pairVal = pairVal.trim();

			if (pairs[i].id === "PS") {
			  caseDescription = caseDescription + "<br><br>";
			  caseDescription = caseDescription + "<strong>" + "Stand alone products and services" + "</strong><br>";
			  caseDescription = caseDescription + pairVal + "<br>";
			} else if (pairs[i].ttl != null && pairs[i].ttl.indexOf("page-") > -1) {
			  caseDescription = caseDescription + "<br><br>";
			  if (i == 0) {
				caseDescription = caseDescription + "<strong>" + hpe.fn.lang("Form518", config.locale, config.localizations) + "</strong><br>";
				let pdfUrl = `https://hpe-rfb.it.hpe.com/form/989/attachments/${config.dataset.EntryId}/PDF?downloadFileName=${encodeURIComponent(config.dataset.PO_Number)}.pdf`;
				caseDescription = caseDescription +  `<a href="${pdfUrl}" target="_blank">` + hpe.fn.lang("POPDFLink", config.locale, config.localizations) + '</a><br>';
			  } else
				caseDescription = caseDescription + "<strong>" + pairVal + "</strong><br>";
			} else {
			  if (["PA_Number"].indexOf(pairs[i].data) > -1) {
				caseDescription = caseDescription + "<br><br>";
				caseDescription = caseDescription + "<strong>" + hpe.fn.lang("Form023", config.locale, config.localizations) + "</strong><br>";
				caseDescription = caseDescription + pairs[i].ttl + ": " + pairVal + "<br>";
			  } else if (["Config_Quote", "Config_aaS"].indexOf(pairs[i].data) > -1) {
				if (["North America"].indexOf(global.data.geo.geography) > -1) {
				  /*   if (pairs[i].data == "Config_aaS") {
                                           caseDescription = caseDescription + "<br><br>";
                                           caseDescription = caseDescription + "<strong>" + hpe.fn.lang("Form075", config.locale, config.localizations) + "</strong><br>";
                                           caseDescription = caseDescription + pairs[i].ttl + ": " + pairVal + "<br>";
                                       } else */
				  if (pairs[i].data == "Config_Quote") {
					caseDescription = caseDescription + pairs[i].ttl + ": " + pairVal + "<br>";
				  }
				} else {
				  caseDescription = caseDescription + "<br><br>";
				  caseDescription = caseDescription + "<strong>" + hpe.fn.lang("Form075", config.locale, config.localizations) + "</strong><br>";
				  caseDescription = caseDescription + pairs[i].ttl + ": " + pairVal + "<br>";
				}

			  } else if (["PO_DeliveryDate"].indexOf(pairs[i].data) > -1) {
				caseDescription = caseDescription + "<br><br>";
				caseDescription = caseDescription + "<strong>" + hpe.fn.lang("Form472", config.locale, config.localizations) + "</strong><br>";
				caseDescription = caseDescription + pairs[i].ttl + ": " + pairVal + " (DD/MM/YYYY)<br>";
			  } else if (["AssLoc_PartyId", "AssLoc_CompanyName", "AssLoc_Address_Street", "AssLoc_Address_Street2", "AssLoc_Address_City", "AssLoc_Address_State", "AssLoc_Address_Postal", "AssLoc_Address_Country"].indexOf(pairs[i].data) > -1) {
				if (caseDescription.indexOf(hpe.fn.lang("Form519", config.locale, config.localizations)) == -1) {
				  caseDescription = caseDescription + "<br><br>";
				  caseDescription = caseDescription + "<strong>" + hpe.fn.lang("Form519", config.locale, config.localizations) + "</strong><br>";
				}
				caseDescription = caseDescription + pairs[i].ttl + ": " + pairVal + "<br>";
			  } else if (["EntPrty_PartyId", "EntPrty_CompanyName", "EntPrty_Address_Street", "EntPrty_Address_Street2", "EntPrty_Address_City", "EntPrty_Address_State", "EntPrty_Address_Postal", "EntPrty_Address_Country", "EntPrty_Contact_FirstName", "EntPrty_Contact_LastName", "EntPrty_Contact_Phone", "EntPrty_Contact_Email", "EntPrty_Contact_Country"].indexOf(pairs[i].data) > -1) {
				if (caseDescription.indexOf(hpe.fn.lang("Form520", config.locale, config.localizations)) == -1) {
				  caseDescription = caseDescription + "<br><br>";
				  caseDescription = caseDescription + "<strong>" + hpe.fn.lang("Form520", config.locale, config.localizations) + "</strong><br>";
				}
				caseDescription = caseDescription + pairs[i].ttl + ": " + pairVal + "<br>";
			  } else if (["PSP_PartyId", "PSP_CompanyName", "PSP_Address_Street", "PSP_Address_Street2", "PSP_Address_City", "PSP_Address_State", "PSP_Address_Postal", "PSP_Address_Country"].indexOf(pairs[i].data) > -1) {
				if (caseDescription.indexOf(hpe.fn.lang("Form529", config.locale, config.localizations)) == -1) {
				  caseDescription = caseDescription + "<br><br>";
				  caseDescription = caseDescription + "<strong>" + hpe.fn.lang("Form529", config.locale, config.localizations) + "</strong><br>";
				}
				caseDescription = caseDescription + pairs[i].ttl + ": " + pairVal + "<br>";
			  } else {
				if (["NA", "N/A", " ", "", "OPE-", "Select one"].indexOf(pairVal) == -1)
				  caseDescription = caseDescription + pairs[i].ttl + ": " + pairVal + "<br>";
			  }
			}
		  }
		  config.dataset.CaseDescription = caseDescription;
		  //  console.log("CaseDescription: " + config.dataset.CaseDescription);
		}
		
		// product and services
		quoteHelper.parseProductAndServicesRepeater(config);

		if (config.dataset.Config_Quote == 'Y' && quoteHelper.quote) {
		  config.dataset.QuoteResponse = JSON.stringify(quoteHelper.quote);
		}
		
		var subject = (config.dataset.CaseTitle_aaS ? config.dataset.CaseTitle_aaS : '') +
			' ' +
			(config.dataset.CaseReason ? config.dataset.CaseReason : 'N/A') +
			' / ' +
			(config.dataset.PO_Number ? config.dataset.PO_Number : 'N/A') +
			' / NORID ' +
			(config.dataset.EntryId ? config.dataset.EntryId : 'N/A');

		if (config.dataset.CountryCode == 'JP' || config.dataset.CountryCode == 'KR') {
		  subject += '/ ' + (config.dataset.Requestor_PO_Opp_ID ? config.dataset.Requestor_PO_Opp_ID : 'N/A');
		}

		if (config.dataset.PO_Category != "Stock") {
		  subject += ' / End Customer ' +
			(config.dataset.EndCx_CompanyName ? config.dataset.EndCx_CompanyName : 'N/A');
		}

		config.dataset.Subject = subject.length > 255 ? subject.substring(0, 255) : subject;
		config.dataset.Environment = appSettings.environment;
		
		config.dataset.FirstName = '[SSOData.FirstName]';
		config.dataset.LastName = '[SSOData.LastName]';
		
		const errorHandler = function() {
		  elog('Failed to update record in RFB');
		  mo.fn.overlay.hide();
		  mo.fn.modal.show({
			ctaLabel: hpe.fn.lang('OK', config.locale, config.localizations),
			title: hpe.fn.lang("ErrorGeneric2", config.locale, config.localizations),
			content: '<p>' + hpe.fn.lang("ErrorSubmit", config.locale, config.localizations) + '</p>'
		  });
		}

		PDF.createPdf();

		// UPDATE RECORD
		crud.update("3163", config.dataset.EntryId, config.dataset, function(data) {
		  if (typeof(data.EntryId) === "number") {
			const notDraftHandler = function() {
			  mo.fn.modal.show({
				ctaLabel: hpe.fn.lang("OK", config.locale, config.localizations),
				title: hpe.fn.lang('Form226', config.locale, config.localizations),
				content: '<p>' + hpe.fn.lang('Form227', config.locale, config.localizations) + '</p>',
				contentCallback: function() {
				  var modal = document.querySelector('.dxpModal')
				  var modalPosition = modal.getBoundingClientRect();
				  var message = {
					type: 'MODAL_OPENED',
					top: modalPosition.top
				  };
				  window.parent.postMessage(JSON.stringify(message), '*');
				},
				ctaCallback: function() {
				  $('span[tab-id="requests"]').click()
				  $('.refresh').click()
				  mo.fn.events.closeAll();
				}
			  });
			}
			const draftHandler = function() {
			  mo.fn.modal.show({
				ctaLabel: hpe.fn.lang("OK", config.locale, config.localizations),
				title: hpe.fn.lang('Form228', config.locale, config.localizations) + " #" + config.dataset.EntryId,
				content: '<p>' + hpe.fn.lang('Form229', config.locale, config.localizations).replace("{{OrderId}}", config.dataset.EntryId) + '</p>',
				contentCallback: function() {
				  var modal = document.querySelector('.dxpModal')
				  var modalPosition = modal.getBoundingClientRect();
				  var message = {
					type: 'MODAL_OPENED',
					top: modalPosition.top
				  };
				  window.parent.postMessage(JSON.stringify(message), '*');
				},
				ctaCallback: function() {
				  $('span[tab-id="requests"]').click()
				  $('.refresh').click()
				  mo.fn.events.closeAll();
				}
			  });
			}
			
			if (isDraft) {
			  // UPDATE REFERENCE APPLICATION WITH RESPONSE
			  config.dataset = data;
			  nbsf.init(config, config.page);
			  mo.fn.overlay.hide();
			  draftHandler();
			} else {
			  quoteHelper.saveProductAndServices(config, function() {
				// set Worflow after creating product and services
				config.dataset.Status = '1';
				config.dataset.Submitted = 'Y';
				config.dataset.Workflow = '1';
				config.dataset.SubmittedTimestamp = t;
				crud.update("3163", config.dataset.EntryId, config.dataset, function(data) {
				  if (typeof(data.EntryId) === "number") {
					// UPDATE REFERENCE APPLICATION WITH RESPONSE
					config.dataset = data;
					nbsf.init(config, config.page);
					mo.fn.overlay.hide();
					notDraftHandler();
				  } else {
					errorHandler();
				  }
				});
			  }, errorHandler, true);
			}
		  } else {
			errorHandler();
		  }
		});
	  });
	},
	onClone: function(donor, clone) {
	  quoteHelper.onCloneProductAndServices(config, clone);
	},
	onDeClone: function(donor, clone) {
	  quoteHelper.onDeCloneProductAndServices(config, clone);
	},
	clearData: function(cfg) {
	  cfg.fields.forEach((fld) => {
		config.dataset[fld] = null;
		if (cfg.clearInput) {
		  let el = document.querySelector(`*[data-name="${fld}"]`);
		  if (el) $(el).val = "";
		}
	  });
	},
	init: function() {
	  config.sectionName.forEach((sect) => {
		let sectFields = []
		config.sectionFields[sect] = sectFields;
		config.sectionAddressFields[sect] = [];
		config.sectionContactFields[sect] = [];
		config.addressField.forEach((fld) => {
		  sectFields.push(sect + "_" + fld);
		  config.sectionAddressFields[sect].push(sect + "_" + fld);
		});
		config.contactField.forEach((fld) => {
		  sectFields.push(sect + "_" + fld);
		  config.sectionContactFields[sect].push(sect + "_" + fld);
		});
	  });
	},
  };

  if (global.data.user.internal) {
	config.pages.unshift(page0);
	config.pages.unshift(pageFirst);
  }
  // PAGE CALLBACKS
  const callbacks = {
	pageFirst: function() {
	  console.log('pageFirst');
	  if (config.dataset.OnBehalf_CreatedBy && config.dataset.OnBehalf_Type == 'User') {
		$('input[data-name="OnBehalf_CreatedBy"]').parent().parent().addClass('wrapper-disabled');
		$('input[data-name="OnBehalf_CreatedBy"]').attr("disabled", 'disabled');
		document.querySelector('select[data-name="OnBehalf_Type"]').disabled = true;
		$('select[data-name="OnBehalf_Type"]').parent().parent().addClass('wrapper-disabled');
		$('input[data-name="OnBehalf_PartyId"]').closest('fieldset').hide();
		document.querySelector('input[data-name="OnBehalf_PartyId"]').setAttribute("ignore-validation", true);
		nbsf.ev.global(config, false);
	  } else if (config.dataset.OnBehalf_CreatedBy && !config.dataset.OnBehalf_Type) {
		$('input[data-name="OnBehalf_CreatedBy"]').parent().parent().addClass('wrapper-disabled');
		$('input[data-name="OnBehalf_CreatedBy"]').attr("disabled", 'disabled');
		document.querySelector('select[data-name="OnBehalf_Type"]').disabled = true;
		document.querySelector('select[data-name="OnBehalf_Type"]').value = 'User';
		$('select[data-name="OnBehalf_Type"]').parent().parent().addClass('wrapper-disabled');
		$('input[data-name="OnBehalf_PartyId"]').closest('fieldset').hide();
		document.querySelector('input[data-name="OnBehalf_PartyId"]').setAttribute("ignore-validation", true);
		nbsf.ev.global(config, false);
	  } else if (config.dataset.PartyId && config.dataset.OnBehalf_Type == 'Company') {
		$('input[data-name="OnBehalf_CreatedBy"]').closest('fieldset').hide();
		$('input[data-name="OnBehalf_PartyId"]').parent().parent().addClass('wrapper-disabled');
		$('input[data-name="OnBehalf_PartyId"]').attr("disabled", 'disabled');
		$('select[data-name="OnBehalf_Type"]').parent().parent().addClass('wrapper-disabled');
		document.querySelector('input[data-name="OnBehalf_PartyId"]').value = config.dataset.PartyId;
		document.querySelector('select[data-name="OnBehalf_Type"]').disabled = true;
		document.querySelector('input[data-name="OnBehalf_CreatedBy"]').setAttribute("ignore-validation", true);
		nbsf.ev.global(config, false);
	  } else {
		$('input[data-name="OnBehalf_CreatedBy"]').closest('fieldset').hide();
		$('input[data-name="OnBehalf_PartyId"]').closest('fieldset').hide();
	  }
	  $('select[data-name="OnBehalf_Type"]').change(() => {
		var fieldUser = $('select[data-name="OnBehalf_Type"]').val() == "User";
		var fieldCompany = $('select[data-name="OnBehalf_Type"]').val() == "Company";
		if (fieldUser) {
		  console.log("user");
		  $('input[data-name="OnBehalf_PartyId"]').closest('fieldset').hide();
		  $('input[data-name="OnBehalf_CreatedBy"]').closest('fieldset').show();
		  document.querySelector('input[data-name="OnBehalf_PartyId"]').setAttribute("ignore-validation", fieldUser);
		  document.querySelector('input[data-name="OnBehalf_CreatedBy"]').setAttribute("ignore-validation", fieldCompany);
		} else if (fieldCompany) {
		  console.log("company");
		  $('input[data-name="OnBehalf_CreatedBy"]').closest('fieldset').hide();
		  $('input[data-name="OnBehalf_PartyId"]').closest('fieldset').show();
		  document.querySelector('input[data-name="OnBehalf_CreatedBy"]').setAttribute("ignore-validation", fieldCompany);
		  document.querySelector('input[data-name="OnBehalf_PartyId"]').setAttribute("ignore-validation", fieldUser);
		}
		nbsf.ev.global(config, false);
	  });
	},
	page0: function() {
	  console.log('page0');
	  var languages = []
	  const langDS = new kendo.data.DataSource({
		type: "rfb-v2",
		transport: {
		  read: {
			url: "https://hpe-rfb.it.hpe.com/form/data-set-provider/v2/1476/LanguagesList/kendo/data/search",
			type: 'POST'
		  },
		},
		schema: {
		  model: {
			id: "EntryId",
			fields: {}
		  }
		},
		serverFiltering: true,
		// filter: [],
		serverPaging: true,
		pageSize: 1000,
		serverSorting: true,
	  });
	  langDS.read().then(function() {
		const view = langDS.view();
		console.log('langDS', view);
		view.forEach(item => {
		  $('select[data-name="Language"]').append($('<option></option>').val(item.LanguageCode).html(item.LanguageName));
		});
		//	document.querySelector('select[data-name="Language"').value = 'en_US';
	  });

	  if (config.dataset.OnBehalf_Type == 'Company') {
		$('input[data-name="OnBehalf_CreatedBy"]').parent().parent().removeClass('wrapper-disabled');
		$('input[data-name="OnBehalf_CreatedBy"]').attr("disabled", false);
		$('input[data-name="FirstName"]').parent().parent().removeClass('wrapper-disabled');
		$('input[data-name="FirstName"]').attr("disabled", false);
		$('input[data-name="LastName"]').parent().parent().removeClass('wrapper-disabled');
		$('input[data-name="LastName"]').attr("disabled", false);
		$('select[data-name="Language"]').parent().parent().removeClass('wrapper-disabled');
		$('select[data-name="Language"]').attr("disabled", false);
	  }
	  $('select[data-name="Language"]').parent().parent().hide();
	},
	page1: function() {
	  //mo.fn.overlay.hide();
	  console.log('page1');
	  // HIDDEN INPUT: SSO
	  let hiddenInputs = [{
		name: "Email",
		group: "user",
		value: "email"
	  },
						  /*{
                      name: "FirstName",
                      group: "user",
                      value: "fname"
                  },
                  {
                      name: "LastName",
                      group: "user",
                      value: "lname"
                  },*/
						  {
							name: "HPPUserId",
							group: "user",
							value: "hpp"
						  },
						  {
							name: "PreferredLanguageCode",
							group: "user",
							value: "locale"
						  },
						  {
							name: "Language",
							group: "user",
							value: "language"
						  },
						  {
							name: "PartyId",
							group: "company",
							value: "party"
						  },
						  {
							name: "CountryEntity",
							group: "company",
							value: "country"
						  },
						  {
							name: "GlobalEntity",
							group: "company",
							value: "global"
						  },
						  {
							name: "PartnerBRT",
							group: "brt",
							value: "name"
						  },
						  {
							name: "Region",
							group: "geo",
							value: "region"
						  },
						  {
							name: "SubRegion",
							group: "geo",
							value: "subregion"
						  },
						  {
							name: "Geo",
							group: "geo",
							value: "geography"
						  },
						 ];
	  if (!global.data.user.internal) {
		hiddenInputs.forEach(function(input) {
		  config.dataset[input.name] = global.data[input.group][input.value];
		  document.querySelector("input[type=hidden][data-name=" + input.name + "]").value = global.data[input.group][input.value];
		});
	  }
	  config.dataset.internalUser = global.data.user.internal;
	  config.dataset.Email = '[SSOData.Email]';
	  config.dataset.Requestor_Email = '[SSOData.Email]';
	  // config.dataset.CountryCode = global.data.geo.code;
	  quoteHelper.initCountry(config, false, false);

	  // ADDRESS MAPPIMG FOR SOLD_TO, PAYER, BILL_TO FROM PO - ONLY FOR NEW REQUESTS
	  if (config.dataset.Config_Quote !== "Y") {
		quoteHelper.initDefaultPOData(config);
	  }

	  // REGION AMS REMOVE STANDALONE SERVICE OPTION FROM PO_BACKGROUNDGROUP
	  if (document.querySelector("select[data-name=PO_BackgroundGroup]") != null) {
		if (document.querySelector("select[data-name=PO_BackgroundGroup]").options.length > 4) {
		  if (["EMEA", "APJ", "AMS"].indexOf(global.data.geo.region) > -1) {
			document.querySelector("select[data-name=PO_BackgroundGroup]").options[2] = null;
			document.querySelector("select[data-name=PO_BackgroundGroup]").options[2] = null;
		  } else {
			document.querySelector("select[data-name=PO_BackgroundGroup]").options[4] = null;
			document.querySelector("select[data-name=PO_BackgroundGroup]").options[3] = null;
		  }
		  if (config.dataset.PO_BackgroundGroup == "" || config.dataset.PO_BackgroundGroup == null)
			document.querySelector("select[data-name=PO_BackgroundGroup]").options[0].selected = true;
		  else
			document.querySelector("select[data-name=PO_BackgroundGroup]").value = config.dataset.PO_BackgroundGroup;
		}
	  }
	  config.dataset.aggrVal = "0";
	  if (global.data.brt.pas.length > 0)
		config.dataset.aggrVal = "1";
	  $('label[for="Config_Quote"]').click(function() {
		$('input[name="Config_Quote"]').trigger("change");
	  });
	  $('input[name="Config_Quote"]').change(function() {
		let completedData = document.querySelectorAll('*[data-name]');
		for (let i = 0; i < completedData.length; i++) {
		  config.dataset[completedData[i].getAttribute('data-name')] = completedData[i].value;
		}

		config.dataset.Config_Quote = $(this).val();
		if (config.dataset.Config_Quote == 'N') {
		  config.dataset.Requestor_PO_Quote_ID = null;
		  config.dataset.Config_Quote_PartialOrder = null;
		  quoteHelper.ucids = [];
		  quoteHelper.maxQuantity = null;
		  config.dataset.Config_UCID = null;
		  config.dataset.Config_UCIDQ = null;
		  config.dataset.Config_ConfigId = null;

		  quoteHelper.initCountry(config);
		  nbsf.init(config, config.page);

		  // Clear quote data
		  quoteHelper.initDefaultPOData(config, true);
		  quoteHelper.clearHeaderQuoteData(config);
			paNumberChanged();
		} else {
		  config.dataset.ProductServices_Attachment = null;
		  config.dataset.ProductServicesRepeater = null;
		}
		nbsf.init(config, config.page);
	  });
	  if (document.querySelector('input[data-name="Config_PartialOrder"]')) {
		$('label[for="Config_PartialOrder"]').click(function() {
		  $('input[name="Config_PartialOrder"]').trigger("change");
		});
		$('input[name="Config_PartialOrder"]').change(function() {
		  let completedData = document.querySelectorAll('*[data-name]');
		  for (let i = 0; i < completedData.length; i++) {
			config.dataset[completedData[i].getAttribute('data-name')] = completedData[i].value;
		  }
		  config.dataset.Config_PartialOrder = $(this).val();
		//  config.dataset.PO_Value = null;
		  nbsf.init(config, config.page);
		  
		  if (config.dataset.Config_PartialOrder === "Y") {
			config.dataset.Config_Quote_PartialOrder = null;
		  } else {
			quoteHelper.ucids = [];
			quoteHelper.maxQuantity = null;
			config.dataset.Config_Quote_PartialOrder = null;
			config.dataset.ProductServices_Attachment = null;
			config.dataset.ProductServicesRepeater = null;
		  }
		});
	  }

	  // Change SIM Country
	  if (document.querySelector('select[data-name="SIM_Country"]')) {
		$('select[data-name="SIM_Country"] option').click(function() {
		  $('select[data-name="SIM_Country"]').trigger("change");
		});
		$('select[data-name="SIM_Country"]').change(function() {
		  mo.fn.modal.show({
			close: false,
			ctaLabel: hpe.fn.lang('OK', config.locale, config.localizations),
			title: hpe.fn.lang("Form263", config.locale, config.localizations),
			content: '',
			ctaCallback: function() {
			  let completedData = document.querySelectorAll('*[data-name]');
			  for (let i = 0; i < completedData.length; i++) {
				config.dataset[completedData[i].getAttribute('data-name')] = completedData[i].value;
			  }
			  config.dataset.SIM_Country = $('select[data-name="SIM_Country"]').val();
			  quoteHelper.initCountry(config);
			  paNumberChanged();
			  nbsf.init(config, config.page);

			  mo.fn.overlay.hide();
			  mo.fn.events.closeAll();
			}
		  });
		});
	  }

	  // Populate data from QuoteId 
	  if (document.querySelector('input[data-name="Requestor_PO_Quote_ID"]')) {
		$("input[data-name=Requestor_PO_Quote_ID]").on("changeQuoteId", async function(event, invalid) {
		  let completedData = document.querySelectorAll('*[data-name]');
		  for (let i = 0; i < completedData.length; i++) {
			config.dataset[completedData[i].getAttribute('data-name')] = completedData[i].value;
		  }
		  config.dataset.Requestor_PO_Quote_ID = $(this).val();
		  quoteHelper.initCountry(config, invalid);
		  nbsf.init(config, config.page);
		  if (!invalid) {
			quoteHelper.initHeaderQuoteData(config);
			await quoteHelper.initAddressQuoteData(config);
			quoteHelper.ucids = [];
			quoteHelper.maxQuantity = null;
			config.dataset.Config_Quote_PartialOrder = null;
			paNumberChanged();
			nbsf.init(config, config.page);
		  }

		  // After all disable/undisable some header quote fields if quote is exist
		  quoteHelper.disableHeaderQuote(config);
		});
	  }

	  // Disable some header quote fields if quote is exist
	  quoteHelper.disableHeaderQuote(config);

	  let addCustomCssNBSF = ['PO_BackgroundGroup', 'PO_Number', 'Config_Quote', 'PO_BusinessModel', 'PO_HPEEntity'];

	  for (let i = 0; i < addCustomCssNBSF.length; i++) {
		if (document.querySelector('*[data-name="' + addCustomCssNBSF[i] + '"]'))
		  document.querySelector('*[data-name="' + addCustomCssNBSF[i] + '"]').closest('.row').classList.add("filteredClass");
	  }

	  if (document.querySelector('*[data-name="PO_Value"]'))
		document.querySelector('*[data-name="PO_Value"]').closest('.row').classList.add("customFilteredClass");
	  if (document.querySelector('*[data-name="PO_Currency"]'))
          document.querySelector('*[data-name="PO_Currency"]').closest('.row').classList.add("customFilteredClass");
	  if (document.querySelector('*[data-name="PA_NumberPlaceholder"]'))
		document.querySelector('*[data-name="PA_NumberPlaceholder"]').closest('.row').classList.add("customFilteredClass");
	  if (document.querySelector('*[data-name="Rs_PO_Number"]'))
		document.querySelector('*[data-name="Rs_PO_Number"]').closest('.row').classList.add("customFilteredClass");
	  if (document.querySelector('*[data-name="Config_Quote"]'))
		document.querySelector('*[data-name="Config_Quote"]').closest('.row').classList.add("customFilteredClassToggle3");
	  if (document.querySelector('*[data-name="PO_CompleteDelivery"]'))
		document.querySelector('*[data-name="PO_CompleteDelivery"]').closest('.row').classList.add("customFilteredClassToggle13");
	  if (document.querySelector('*[data-name="Cx_PO_Number"]'))
		document.querySelector('*[data-name="Cx_PO_Number"]').closest('.row').classList.add("customFilteredClass");
	  if (document.querySelector('*[data-name="Invoice_SendEmail"]'))
		document.querySelector('*[data-name="Invoice_SendEmail"]').closest('.row').classList.add("customFilteredClassToggle13");
	  if (document.querySelector('*[data-name="Requestor_PO_Quote_ID"]')) {
		document.querySelector('*[data-name="Requestor_PO_Quote_ID"]').closest('.row').classList.add("customFilteredClassToggle");
		if (document.querySelector('*[data-name="Requestor_PO_Deal_ID"]')) {
		  document.querySelector('*[data-name="Requestor_PO_Quote_ID"]').closest('.row').classList.add("filteredClass");
		}
	  }
	  if (document.querySelector('*[data-name="Config_PartialOrder"]')) {
		document.querySelector('*[data-name="Config_PartialOrder"]').closest('.row').classList.add("customFilteredClassToggle5");
	  }
	//  if (document.querySelector('*[data-name="Config_UCID"]'))
	//	document.querySelector('*[data-name="Config_UCID"]').closest('.row').classList.add("filteredClass");
	  if (document.querySelector('*[data-name="Requestor_PO_Opp_ID"]'))
		document.querySelector('*[data-name="Requestor_PO_Opp_ID"]').closest('.row').classList.add("customFilteredClass");
	  if (document.querySelector('*[data-name="Payment_TermsPlaceholder"]'))
		document.querySelector('*[data-name="Payment_TermsPlaceholder"]').closest('.row').classList.add("customFilteredClass");
	  if (document.querySelector('*[data-name="TaxAmount"]'))
          document.querySelector('*[data-name="TaxAmount"]').closest('.row').classList.add("customFilteredClass");


	  if (document.querySelector('input[data-name="PO_Value"]')) {
		$('input[data-name="PO_Value"]').change(function() {
		  if (config.dataset.Config_Quote !== 'Y' && config.dataset.CountryCode == 'BR') {
			config.dataset.PO_Value = $(this).val();
			config.dataset.PO_Value_Tax = (Math.round((config.dataset.TaxAmount || 0) * 10000) + Math.round((config.dataset.PO_Value || 0) * 10000)) / 10000;
			nbsf.init(config, config.page);
		  }
		});
	  }
	  if (document.querySelector('input[data-name="TaxAmount"]')) {
		$('input[data-name="TaxAmount"]').change(function() {
		  if (config.dataset.Config_Quote !== 'Y' && config.dataset.CountryCode == 'BR') {
			config.dataset.TaxAmount = $(this).val();
			config.dataset.PO_Value_Tax = (Math.round((config.dataset.TaxAmount || 0) * 10000) + Math.round((config.dataset.PO_Value || 0) * 10000)) / 10000;
			nbsf.init(config, config.page);
		  }
		});
	  }

	  if (document.querySelector('select[data-name="PO_Category"]')) {
		$('select[data-name="PO_Category"] option').click(function() {
		  $('select[data-name="PO_Category"]').trigger("change");
		});
		$('select[data-name="PO_Category"]').change(async function() {
		  let completedData = document.querySelectorAll('*[data-name]');
		  for (let i = 0; i < completedData.length; i++) {
			config.dataset[completedData[i].getAttribute('data-name')] = completedData[i].value;
		  }

		  config.dataset.PO_Category = $(this).val();
		  if (config.dataset.PO_Category == "Stock") {
			config.dataset.Config_ResellerDetails = "Y";
			config.dataset.Config_ResellerDetails_Contact = "Y";
			config.dataset.Config_EndCxDetails = "Y";
			config.dataset.Config_EndCxDetails_Contact = "Y";
			quoteHelper.clearAddressData(config, 'EndCustomer');
		  } else {
			config.dataset.Config_ResellerDetails = "N";
			config.dataset.Config_ResellerDetails_Contact = "N";
			config.dataset.Config_EndCxDetails = "N";
			config.dataset.Config_EndCxDetails_Contact = "N";
		  }
		  if (config.dataset.PO_Category == 'Stage' && config.dataset.Requestor_PO_Quote_ID) {
			// NOR-874: Ship to address to be left Blank
			// config.dataset.ShipTo_PartyId = config.dataset.SoldTo_PartyId
			// config.dataset.ShipTo_Address_City = config.dataset.SoldTo_Address_City;
			// config.dataset.ShipTo_Address_Country = config.dataset.SoldTo_Address_Country;
			// config.dataset.ShipTo_CompanyName = config.dataset.SoldTo_CompanyName;
			// config.dataset.ShipTo_Address_State = config.dataset.SoldTo_Address_State;
			// config.dataset.ShipTo_Address_City = config.dataset.SoldTo_Address_City;
			// config.dataset.ShipTo_Address_Postal = config.dataset.SoldTo_Address_Postal;
			// config.dataset.ShipTo_Address_Street = config.dataset.SoldTo_Address_Street;
			// config.dataset.ShipTo_Address_Street2 = config.dataset.SoldTo_Address_Street2;
			// config.dataset.ShipTo_NationalID = config.dataset.SoldTo_NationalID;
			//nbsf.init(config, config.page);
		  } else if ((config.dataset.PO_Category == 'Stock' || config.dataset.PO_Category == 'Drop') && config.dataset.Requestor_PO_Quote_ID) {
			await quoteHelper.initAddressQuoteData(config);
			paNumberChanged();
		  }


		  nbsf.init(config, config.page);
		});
	  }

	  function delivery(value) {
		if (typeof(value) === "undefined" || value == null || value.indexOf("/") == -1) return true;
		else {
		  var ddate = value.split("/");
		  var unix = new Date(ddate[2], parseInt(ddate[1]) - 1, parseInt(ddate[0]) + 1, 0, 0, 0, 0).getTime();
		  var delta = unix - new Date().getTime();
		  if (delta < 7862400000 && delta > 0) return true;
		  else return false;
		}
	  }
	  if (document.querySelector("[data-name=PO_DeliveryDate]")) {
		if (!delivery(document.querySelector("[data-name=PO_DeliveryDate]").value)) {
		  $('.nbsf .continue').addClass('disabled');
		  mo.fn.modal.show({
			ctaLabel: hpe.fn.lang("OK", config.locale, config.localizations),
			title: hpe.fn.lang("ModalDeliveryDate", config.locale, config.localizations),
			content: '<p>' + hpe.fn.lang("ModalDeliveryDateMSG", config.locale, config.localizations) + '</p>',
		  });
		}

		$("[data-name=PO_DeliveryDate]").change(function() {
		  if (!delivery(document.querySelector("[data-name=PO_DeliveryDate]").value)) {
			$('.nbsf .continue').addClass('disabled');
			mo.fn.modal.show({
			  ctaLabel: hpe.fn.lang("OK", config.locale, config.localizations),
			  title: hpe.fn.lang("ModalDeliveryDate", config.locale, config.localizations),
			  content: '<p>' + hpe.fn.lang("ModalDeliveryDateMSG", config.locale, config.localizations) + '</p>',
			});
		  } else {
			// $('.nbsf .continue').removeClass('disabled');
			nbsf.ev.global(config);
		  }
		});
	  }


	  let result = []
	  $('select[data-name="PO_BackgroundGroup"]').change(function() {
		let vl = $(this).val();
		result = assigntoteamValues.filter(x => (x.region.indexOf(config.dataset.Region) > -1 && x.PO_BackgroundGroup == vl));
		if (config.dataset.Region == "EMEA") {
		  config.dataset.AssignToTeam = result[0].teamName;
		} else if (config.dataset.Region == "AMS") {
		  if (vl == "Edge") config.dataset.AssignToTeam = result[0].teamName;
		  else {
			if (config.dataset.Country != "Brazil") config.dataset.AssignToTeam = result[1].teamName;
			else config.dataset.AssignToTeam = result[0].teamName;
		  }
		} else if (config.dataset.Region == "APJ") {
		  if (vl == "Edge") config.dataset.AssignToTeam = result[0].teamName;
		  else {
			if (config.dataset.CountryCode == "IN") config.dataset.AssignToTeam = result[0].teamName;
			else if (config.dataset.CountryCode == "JP") config.dataset.AssignToTeam = result[5].teamName;
			else if (config.dataset.CountryCode == "KR") config.dataset.AssignToTeam = result[3].teamName;
			else if (config.dataset.CountryCode == "AU" || config.dataset.CountryCode == "NZ") config.dataset.AssignToTeam = result[2].teamName;
			else if (config.dataset.CountryCode == "HK" || config.dataset.CountryCode == "TW") config.dataset.AssignToTeam = result[1].teamName;
			else config.dataset.AssignToTeam = result[4].teamName;
		  }
		} else config.dataset.AssignToTeam = "OTC WW ComputeStorage EAAS";
	  });
	  $("input[data-name=Config_UCIDQ]").focusout(function() {
		let vl = $(this).val();
		if (vl != '')
		  if (vl.slice(-1) != ';')
			vl = vl + ';'
		$(this).val(vl)
	  });
	  $("input[data-name=Config_UCID]").focusout(function() {
		let vl = $(this).val();
		if (vl != '')
		  if (vl.slice(-1) != ';')
			vl = vl + ';'
		$(this).val(vl)
	  });

	  if (document.querySelector('select[data-name="PO_Currency"]') && document.querySelector('select[data-name="PO_Currency"]').value == config.pages[1].selectone) {
		if ($('select[data-name="PO_Currency"] option').length > 1) {
		  $('select[data-name="PO_Currency"]').val($('select[data-name="PO_Currency"] option')[1].innerText).trigger('change');
		}
	  }

	  if (document.querySelector('select[data-name="PA_Number"]') && global.data.brt.pas.length == 1 && document.querySelector('select[data-name="PA_Number"]').value == config.pages[1].selectone) {
		const paOpts = $('select[data-name="PA_Number"] option');
		if (paOpts.length > 1) {
		  const paValue = paOpts[1].innerText;
		  $('select[data-name="PA_Number"]').val(paValue).trigger('change');
		  paNumberChanged(paValue); // For some reason events triggered by jQuery do not bubble up to vanilla JS' handlers
		}
	  }
	  
	  if (document.querySelector('select[data-name="PO_BusinessModel"]') && document.querySelector('select[data-name="PO_BusinessModel"]').value == config.pages[1].selectone) {
		$('select[data-name="PO_BusinessModel"]').val($('select[data-name="PO_BusinessModel"] option')[1].innerText).trigger('change');
		if ($('select[data-name="PO_Category"]'))  {
		  $('select[data-name="PO_Category"]').trigger('change');
		}
	  }

	  //PO_CompleteDelivery LOGIC FOR KR
	  if (document.querySelector('input[data-name="PO_CompleteDelivery"]') && !PO_CompleteDeliveryLogicCheck && (config.dataset.PO_CompleteDelivery == null || config.dataset.PO_CompleteDelivery == '' || config.dataset.PO_CompleteDelivery == 'N')) {
		if (config.dataset.CountryCode == 'KR') {
		  config.dataset.PO_CompleteDelivery = 'Y';
		  PO_CompleteDeliveryLogicCheck = true;
		  nbsf.init(config, config.page);
		}
	  }

	  // Remove the "Stock" option from "Purchase order category" whenever PO_BusinessModel is not equal to "Trade"
	  if (document.querySelector('select[data-name="PO_BusinessModel"]')) {
		document.querySelector('select[data-name="PO_BusinessModel"]').addEventListener('change', function() {
		  let completedData = document.querySelectorAll('*[data-name]');
		  for (let i = 0; i < completedData.length; i++) {
			config.dataset[completedData[i].getAttribute('data-name')] = completedData[i].value;
		  }

		  config.dataset.PO_BusinessModel = $(this).val();
		  nbsf.init(config, config.page);
		});
	  }

	  //QOD logic for not turkey and MAP 
	  if (!QODCheck) {
		QODCheck = true;
		var config_QuoteToggle = document.querySelector('input[data-name="Config_Quote"]');
		var countryInfo = reference.countriesData.find(x => x.ISO2 == config.dataset.CountryCode);
		if (config.dataset.CountryCode == 'TR' || countryInfo && countryInfo.MAP == "Y") {
		  config.dataset.Config_Quote = "N";
		  nbsf.init(config, config.page);
		}
	  }

	},
	page2: function() {
	  console.log('page2');
    
	  quoteHelper.checkResellerAddressData(config);
	  if (document.querySelector('label[for="Config_Tier1"]')) {
		$('label[for="Config_Tier1"]').click(function() {
		  $('input[name="Config_Tier1"]').trigger("change");
		});
		$('input[name="Config_Tier1"]').change(function() {
		  config.dataset.Config_Tier1 = $(this).val();
		  nbsf.init(config, config.page);
		});
		$('label[for="Config_Shipment_India"]').click(function() {
		  $('input[name="Config_Shipment_India"]').trigger("change");
		});
		$('input[name="Config_Shipment_India"]').change(function() {
		  config.dataset.Config_Shipment_India = $(this).val();
		  nbsf.init(config, config.page);
		});

		if (document.querySelector('*[data-name="Config_Business_Justification"]'))
		  document.querySelector('*[data-name="Config_Business_Justification"]').closest('.row').classList.add("customFilteredClassToggle9");

		if (document.querySelector('*[data-name="Config_Tier2"]'))
		  document.querySelector('*[data-name="Config_Tier2"]').closest('.row').classList.add("customFilteredClassToggle10");

		if (document.querySelector('*[data-name="Config_OEM"]'))
		  document.querySelector('*[data-name="Config_OEM"]').closest('.row').classList.add("customFilteredClassToggle11");

		if (document.querySelector('*[data-name="Config_Tier1"][value="Y"]'))
		  document.querySelector('*[data-name="Config_Tier1"]').closest('.row').classList.add("customFilteredClassToggle111");
	  }

	  if (document.querySelector('input[data-name="PO_Attachment"]')) {
		const POAtt = document.querySelector('[data-name="PO_Attachment"]');
		const kendoAtt = $(POAtt).data('kendoUpload');
		kendoAtt.bind("upload", function(e) {
		  if (e.files && e.files.length) {
			config.dataset.PO_Attachment_Flag = 'Y';
		  }
		});

		$('input[data-name="PO_Attachment"]').live('change', function() {
		  if (document.querySelector('.k-upload .k-upload-files .k-file-validation-message')) {
			mo.fn.modal.show({
			  ctaLabel: hpe.fn.lang('OK', config.locale, config.localizations),
			  title: hpe.fn.lang('ErrorGeneric2', config.locale, config.localizations),
			  content: hpe.fn.lang("FormACR001", config.locale, config.localizations),
			  ctaCallback: function() {
				mo.fn.events.closeAll();
			  },
			  contentCallback: function() {
				config.dataset.PO_Attachment = null;
				$('.k-upload .k-upload-files .k-upload-status .k-icon[title="Remove"]').click();
			  }
			});
			config.dataset.PO_Attachment_Flag = 'N';
		  }
		});
	  }
	},
	page3: function() {
	  console.log('page3');
	  if (document.querySelector('input[data-name="SoldTo_NationalID"]'))
            $('*[data-name="SoldTo_NationalID"]').parent().parent().parent().parent().addClass('fixNationalID');
	  $('input[data-name="SoldTo_PartyId"]').keyup(function() {
		let currentVal = $(this).val();
		if (currentVal.length == 10) {
		  mo.fn.overlay.show({
			progressText: hpe.fn.lang("FormCFI010", config.locale, config.localizations),
			progressPercent: 10,
			close: false
		  })
		  config.dataset.SoldTo_PartyId = currentVal;
		  EMDMAddress(currentVal, 'SoldTo', true);
		}
	  });

	  $(`*[data-name*="SoldTo_"]`).change(function() {
		if ($(this)[0].getAttribute("data-name") != 'SoldTo_PartyId' && $(this)[0].getAttribute("data-name").indexOf('SoldTo_Contact') == -1)
		  $('*[data-name="SoldTo_PartyId"]').val('');
	  });
	  $('*[data-name*="SoldTo_"]').keyup(function() {
		if ($(this)[0].getAttribute("data-name") != 'SoldTo_PartyId' && $(this)[0].getAttribute("data-name").indexOf('SoldTo_Contact') == -1)
		  $('*[data-name="SoldTo_PartyId"]').val('');
	  });

	  // Disable some fields if quote is exist
	  quoteHelper.disableAddressQuoteData(config);
	  helper.buildFastClearAddressButton('SoldTo');

	  if (config.dataset.SoldTo_Address_Country) {
		$(`[data-name="SoldTo_Contact_Country"]`).val(config.dataset.SoldTo_Address_Country);
	  }
	  $(`[data-name="SoldTo_PartyId"]`).change(function() {
		$(`[data-name="SoldTo_Contact_Country"]`).val(config.dataset.SoldTo_Address_Country);
	  });
	  $(`[data-name="SoldTo_Address_Country"]`).change(function() {
		$(`[data-name="SoldTo_Contact_Country"]`).val($(this).val());
	  });
	},
	page4: function() {
	  console.log('page4');
	  $('input[data-name="Payer_PartyId"]').keyup(function() {
		let currentVal = $(this).val();
		if (currentVal.length == 10) {
		  mo.fn.overlay.show({
			progressText: hpe.fn.lang("FormCFI010", config.locale, config.localizations),
			progressPercent: 10,
			close: false
		  })
		  config.dataset.Payer_PartyId = currentVal;
		  EMDMAddress(currentVal, 'Payer', false);
		}
	  });

	  $('*[data-name*="Payer_"]').change(function() {
		if ($(this)[0].getAttribute("data-name") != 'Payer_PartyId' && $(this)[0].getAttribute("data-name").indexOf('Payer_Contact') == -1)
		  $('*[data-name="Payer_PartyId"]').val('');
	  });
	  $('*[data-name*="Payer_"]').keyup(function() {
		if ($(this)[0].getAttribute("data-name") != 'Payer_PartyId' && $(this)[0].getAttribute("data-name").indexOf('Payer_Contact') == -1)
		  $('*[data-name="Payer_PartyId"]').val('');
	  });

	  // Disable some fields if quote is exist
	  quoteHelper.disableAddressQuoteData(config);
	  helper.buildFastClearAddressButton('Payer');
	},
	page5: function() {
	  console.log('page5');
	  $('input[data-name="BillTo_PartyId"]').keyup(function() {
		let currentVal = $(this).val();
		if (currentVal.length == 10 && currentVal[0] == "1") {
		  mo.fn.overlay.show({
			progressText: hpe.fn.lang("FormCFI010", config.locale, config.localizations),
			progressPercent: 10,
			close: false
		  })
		  EMDMAddress(currentVal, 'BillTo', false);
		} else if (currentVal.length == 10 && currentVal[0] == "2") {
		  locationAddress(currentVal, 'BillTo', false);
		}
	  });

	  $('*[data-name*="BillTo_"]').change(function() {
		if ($(this)[0].getAttribute("data-name") != 'BillTo_PartyId' && $(this)[0].getAttribute("data-name").indexOf('BillTo_Contact') == -1)
		  $('*[data-name="BillTo_PartyId"]').val('');
	  });
	  $('*[data-name*="BillTo_"]').keyup(function() {
		if ($(this)[0].getAttribute("data-name") != 'BillTo_PartyId' && $(this)[0].getAttribute("data-name").indexOf('BillTo_Contact') == -1)
		  $('*[data-name="BillTo_PartyId"]').val('');
	  });
	  helper.buildFastClearAddressButton('BillTo');
	},
	page6: function() {
	  console.log('page6');
	  if (document.querySelector('input[data-name="ShipTo_NationalID"]'))
		$('*[data-name="ShipTo_NationalID"]').parent().parent().parent().parent().addClass('fixNationalID');
	  $('select[data-name="ShipTo_Address_Country"] option').click(function() {
		$('select[data-name="ShipTo_Address_Country"]').trigger("change");
	  });
	  $('select[data-name="ShipTo_Address_Country"]').change(function() {
		let completedData = document.querySelectorAll('*[data-name]');
		for (let i = 0; i < completedData.length; i++) {
		  config.dataset[completedData[i].getAttribute('data-name')] = completedData[i].value;
		}
		config.dataset.ShipTo_Address_Country = $(this).val();
		nbsf.init(config, config.page);
	  });

	  $('input[data-name="ShipTo_PartyId"]').keyup(function() {
		let currentVal = $(this).val();
		if (currentVal.length == 10 && currentVal[0] == "1") {
		  config.dataset.ShipTo_PartyId = currentVal;
		  nbsf.init(config, config.page);
		  mo.fn.overlay.show({
			progressText: hpe.fn.lang("FormCFI010", config.locale, config.localizations),
			progressPercent: 10,
			close: false
		  })
		  EMDMAddress(currentVal, 'ShipTo', true);
		} else if (currentVal.length == 10 && currentVal[0] == "2") {
		  locationAddress(currentVal, 'ShipTo', false);
		}
	  });

	  $('*[data-name*="ShipTo_"]').change(function() {
		if ($(this)[0].getAttribute("data-name") != 'ShipTo_PartyId' && $(this)[0].getAttribute("data-name").indexOf('ShipTo_Contact') == -1)
		  $('*[data-name="ShipTo_PartyId"]').val('');
	  });
	  $('*[data-name*="ShipTo_"]').keyup(function() {
		if ($(this)[0].getAttribute("data-name") != 'ShipTo_PartyId' && $(this)[0].getAttribute("data-name").indexOf('ShipTo_Contact') == -1)
		  $('*[data-name="ShipTo_PartyId"]').val('');
	  });
	  helper.buildFastClearAddressButton('ShipTo');
	},
	page7: function() {
	  console.log('page7');
	  if (document.querySelector('input[data-name="EndCx_NationalID"]'))
		$('*[data-name="EndCx_NationalID"]').parent().parent().parent().parent().addClass('fixNationalID');
	  $('select[data-name="EndCx_Address_Country"] option').click(function() {
		console.log('click');
		$('select[data-name="EndCx_Address_Country"]').trigger("change");
	  });
	  $('select[data-name="EndCx_Address_Country"]').change(function() {
		let completedData = document.querySelectorAll('*[data-name]');
		for (let i = 0; i < completedData.length; i++) {
		  config.dataset[completedData[i].getAttribute('data-name')] = completedData[i].value;
		}
		config.dataset.EndCx_Address_Country = $(this).val();
		nbsf.init(config, config.page);
	  });

	  $('input[data-name="EndCx_PartyId"]').keyup(function() {
		let currentVal = $(this).val();
		if (currentVal.length == 10) {
		  mo.fn.overlay.show({
			progressText: hpe.fn.lang("FormCFI010", config.locale, config.localizations),
			progressPercent: 10,
			close: false
		  })
		  config.dataset.EndCx_PartyId = currentVal;
		  EMDMAddress(currentVal, 'EndCx', true);
		}
	  });

	  $('*[data-name*="EndCx_"]').change(function() {
		if ($(this)[0].getAttribute("data-name") != 'EndCx_PartyId' && $(this)[0].getAttribute("data-name").indexOf('EndCx_Contact') == -1)
		  $('*[data-name="EndCx_PartyId"]').val('');
	  });
	  $('*[data-name*="EndCx_"]').keyup(function() {
		if ($(this)[0].getAttribute("data-name") != 'EndCx_PartyId' && $(this)[0].getAttribute("data-name").indexOf('EndCx_Contact') == -1)
		  $('*[data-name="EndCx_PartyId"]').val('');
	  });

	  // Disable some fields if quote is exist
	  quoteHelper.disableAddressQuoteData(config);
	  helper.buildFastClearAddressButton('EndCx');

	  if (config.dataset.EndCx_Address_Country) {
		$(`[data-name="EndCx_Contact_Country"]`).val(config.dataset.EndCx_Address_Country);
	  }
	  $(`[data-name="EndCx_Address_Country"]`).change(function() {
		$(`[data-name="EndCx_Contact_Country"]`).val($(this).val());
	  });

	},
	page8: function() {
	  console.log('page8');
	  if (document.querySelector('input[data-name="Reseller_NationalID"]'))
		$('*[data-name="Reseller_NationalID"]').parent().parent().parent().parent().addClass('fixNationalID');
	  $('select[data-name="Reseller_Address_Country"] option').click(function() {
		console.log('click');
		$('select[data-name="Reseller_Address_Country"]').trigger("change");
	  });
	  $('select[data-name="Reseller_Address_Country"]').change(function() {
		let completedData = document.querySelectorAll('*[data-name]');
		for (let i = 0; i < completedData.length; i++) {
		  config.dataset[completedData[i].getAttribute('data-name')] = completedData[i].value;
		}
		config.dataset.Reseller_Address_Country = $(this).val();
		nbsf.init(config, config.page);
	  });

	  $('input[data-name="Reseller_PartyId"]').keyup(function() {
		let currentVal = $(this).val();
		if (currentVal.length == 10) {
		  mo.fn.overlay.show({
			progressText: hpe.fn.lang("FormCFI010", config.locale, config.localizations),
			progressPercent: 10,
			close: false
		  })
		  config.dataset.Reseller_PartyId = currentVal;
		  EMDMAddress(currentVal, 'Reseller', false);
		}
	  });

	  $('*[data-name*="Reseller_"]').change(function() {
		if ($(this)[0].getAttribute("data-name") != 'Reseller_PartyId' && $(this)[0].getAttribute("data-name").indexOf('Reseller_Contact') == -1)
		  $('*[data-name="Reseller_PartyId"]').val('');
	  });
	  $('*[data-name*="Reseller_"]').keyup(function() {
		if ($(this)[0].getAttribute("data-name") != 'Reseller_PartyId' && $(this)[0].getAttribute("data-name").indexOf('Reseller_Contact') == -1)
		  $('*[data-name="Reseller_PartyId"]').val('');
	  });
	  helper.buildFastClearAddressButton('Reseller');

	  if (config.dataset.Reseller_Address_Country) {
		$(`[data-name="Reseller_Contact_Country"]`).val(config.dataset.Reseller_Address_Country);
	  }
	  $(`[data-name="Reseller_Address_Country"]`).change(function() {
		$(`[data-name="Reseller_Contact_Country"]`).val($(this).val());
	  });
	},
	page9: function() {
	  console.log('page9');
	  $('input[data-name="CustomShipTo_PartyId"]').keyup(function() {
		let currentVal = $(this).val();
		if (currentVal.length == 10) {
		  mo.fn.overlay.show({
			progressText: hpe.fn.lang("FormCFI010", config.locale, config.localizations),
			progressPercent: 10,
			close: false
		  })
		  config.dataset.CustomShipTo_PartyId = currentVal;
		  EMDMAddress(currentVal, 'CustomShipTo', false);
		}
	  });

	  $('*[data-name*="CustomShipTo_"]').change(function() {
		if ($(this)[0].getAttribute("data-name") != 'CustomShipTo_PartyId' && $(this)[0].getAttribute("data-name").indexOf('CustomShipTo_Contact') == -1)
		  $('*[data-name="CustomShipTo_PartyId"]').val('');
	  });
	  $('*[data-name*="CustomShipTo_"]').keyup(function() {
		if ($(this)[0].getAttribute("data-name") != 'CustomShipTo_PartyId' && $(this)[0].getAttribute("data-name").indexOf('CustomShipTo_Contact') == -1)
		  $('*[data-name="CustomShipTo_PartyId"]').val('');
	  });
	  helper.buildFastClearAddressButton('CustomShipTo');
	},
	page10: function() {
	  console.log('page10');
	  helper.buildFastClearAddressButton('AgentProgram');
	},
	page11: function() {
	  console.log('page11');
    if (config.dataset.CountryCode === 'JP') {
      const el = $('.kUpload .fmmcosmin .k-header').next('span');
      $(el).text('');
      $(el).text(hpe.fn.lang(page11.poformatjp, config.locale, config.localizations));
    }
    
	  var tempSaveAttachment;
	  if (document.querySelector('input[data-name="Optional_Attachment"]')) {
		const OptAtt = document.querySelector('[data-name="Optional_Attachment"]');
		const kendoOptAtt = $(OptAtt).data('kendoUpload');
		kendoOptAtt.bind("upload", function(e) {
		  if (e.files && e.files.length) {
			config.dataset.Optional_Attachment_Flag = 'Y';
		  }
		});

		$('input[data-name="Optional_Attachment"]').live('change', function() {
		  if (document.querySelector('.k-upload .k-upload-files .k-file-validation-message')) {
			mo.fn.modal.show({
			  ctaLabel: hpe.fn.lang('OK', config.locale, config.localizations),
			  title: hpe.fn.lang('ErrorGeneric2', config.locale, config.localizations),
			  content: hpe.fn.lang("FormACR001", config.locale, config.localizations),
			  ctaCallback: function() {
				mo.fn.events.closeAll();
			  },
			  contentCallback: function() {
				config.dataset.Optional_Attachment = null;
				$('.k-upload .k-upload-files .k-upload-status .k-icon[title="Remove"]').click();
			  }
			});
			config.dataset.Optional_Attachment_Flag = 'N';
		  }
		});
	  }

	  if (document.querySelector('label[for="Config_PublicSectionPartner"]')) {
		$('label[for="Config_PublicSectionPartner"]').click(function() {
		  $('input[name="Config_PublicSectionPartner"]').trigger("change");
		});
		$('input[name="Config_PublicSectionPartner"]').change(function() {
		  config.dataset.Config_PublicSectionPartner = $(this).val();
		  //tempSaveAttachment = config.dataset.Optional_Attachment;
		  //config.dataset.Optional_Attachment = tempSaveAttachment;
		  nbsf.init(config, config.page);

		});
	  }
	  $('label[for="Config_SystemManager"]').click(function() {
		$('input[name="Config_SystemManager"]').trigger("change");
	  });
	  $('input[name="Config_SystemManager"]').change(function() {
		let completedData = document.querySelectorAll('*[data-name]');
		tempSaveAttachment = config.dataset.Optional_Attachment;
		for (let i = 0; i < completedData.length; i++) {
		  config.dataset[completedData[i].getAttribute('data-name')] = completedData[i].value;
		}
		config.dataset.Config_SystemManager = $(this).val();
		config.dataset.Optional_Attachment = tempSaveAttachment;
		nbsf.init(config, config.page);
	  });

	  $('label[for="Config_EntitledDetails"]').click(function() {
		$('input[name="Config_EntitledDetails"]').trigger("change");
	  });
	  $('input[name="Config_EntitledDetails"]').change(function() {
		let completedData = document.querySelectorAll('*[data-name]');
		tempSaveAttachment = config.dataset.Optional_Attachment;
		for (let i = 0; i < completedData.length; i++) {
		  config.dataset[completedData[i].getAttribute('data-name')] = completedData[i].value;
		}
		config.dataset.Config_EntitledDetails = $(this).val();
		config.dataset.Optional_Attachment = tempSaveAttachment;
		nbsf.init(config, config.page);
	  });

	  $('label[for="Config_LocationDetails"]').click(function() {
		$('input[name="Config_LocationDetails"]').trigger("change");
	  });
	  $('input[name="Config_LocationDetails"]').change(function() {
		let completedData = document.querySelectorAll('*[data-name]');
		tempSaveAttachment = config.dataset.Optional_Attachment;
		for (let i = 0; i < completedData.length; i++) {
		  config.dataset[completedData[i].getAttribute('data-name')] = completedData[i].value;
		}
		config.dataset.Config_LocationDetails = $(this).val();
		config.dataset.Optional_Attachment = tempSaveAttachment;
		nbsf.init(config, config.page);
	  });


	  let addCustomCssNBSF = ['Config_PI', 'Config_SystemManager', 'EndCx_SysMng_FirstName'];

	  for (let i = 0; i < addCustomCssNBSF.length; i++) {
		if (document.querySelector('*[data-name="' + addCustomCssNBSF[i] + '"]'))
		  document.querySelector('*[data-name="' + addCustomCssNBSF[i] + '"]').closest('.row').classList.add("filteredClass");
	  }
	  if (document.querySelector('*[data-name="EndCx_SysMng_FirstName"]'))
		document.querySelector('*[data-name="EndCx_SysMng_FirstName"]').closest('.row').classList.add("customFilteredClassToggle3");

	  if (document.querySelector('*[data-name="Config_PublicSectionPartner"]'))
		document.querySelector('*[data-name="Config_PublicSectionPartner"]').closest('.row .wrapper.toggle').classList.add("customFilteredClassToggle4");

	  if (document.querySelector('*[data-name="Config_ResId"]'))
		document.querySelector('*[data-name="Config_ResId"]').closest('.row').classList.add("customFilteredClassToggle5");

	  if (document.querySelector('*[data-name="Config_LocationDetails"]'))
		document.querySelector('*[data-name="Config_LocationDetails"]').closest('.row').classList.add("customFilteredClassToggle8");

	  if (document.querySelector('*[data-name="Config_EntitledDetails"]'))
		document.querySelector('*[data-name="Config_EntitledDetails"]').closest('.row').classList.add("customFilteredClassToggle6");

	  if (document.querySelector('*[data-name="Config_PSP"]'))
		document.querySelector('*[data-name="Config_PSP"]').closest('.row').classList.add("customFilteredClassToggle7");

	  if (document.querySelector('*[data-name="Config_ALI"]'))
		document.querySelector('*[data-name="Config_ALI"]').closest('.row').classList.add("customFilteredClassToggle7");

	  if (document.querySelector('*[data-name="Config_CombinedOrder"]'))
		document.querySelector('*[data-name="Config_CombinedOrder"]').closest('.row').classList.add("customFilteredClassToggle8");


	  $('label[for="Config_PSP"]').click(function() {
		$('input[name="Config_PSP"]').trigger("change");
	  });
	  $('input[name="Config_PSP"]').change(function() {
		let completedData = document.querySelectorAll('*[data-name]');
		tempSaveAttachment = config.dataset.Optional_Attachment;
		for (let i = 0; i < completedData.length; i++) {
		  config.dataset[completedData[i].getAttribute('data-name')] = completedData[i].value;
		}
		config.dataset.Config_PSP = $(this).val();

		config.dataset.Optional_Attachment = tempSaveAttachment;
		nbsf.init(config, config.page);
	  });

	  $('label[for="Config_ALI"]').click(function() {
		$('input[name="Config_ALI"]').trigger("change");
	  });
	  $('input[name="Config_ALI"]').change(function() {
		let completedData = document.querySelectorAll('*[data-name]');
		tempSaveAttachment = config.dataset.Optional_Attachment;
		for (let i = 0; i < completedData.length; i++) {
		  config.dataset[completedData[i].getAttribute('data-name')] = completedData[i].value;
		}
		config.dataset.Config_ALI = $(this).val();

		nbsf.init(config, config.page);
		config.dataset.Optional_Attachment = tempSaveAttachment;
	  });

	  $('label[for="Config_CombinedOrder"]').click(function() {
		$('input[name="Config_CombinedOrder"]').trigger("change");
	  });
	  $('input[name="Config_CombinedOrder"]').change(function() {
		let completedData = document.querySelectorAll('*[data-name]');
		tempSaveAttachment = config.dataset.Optional_Attachment;
		for (let i = 0; i < completedData.length; i++) {
		  config.dataset[completedData[i].getAttribute('data-name')] = completedData[i].value;
		}
		config.dataset.Config_CombinedOrder = $(this).val();
		config.dataset.Optional_Attachment = tempSaveAttachment;
		nbsf.init(config, config.page);

	  });

	  $('label[for="Config_PI"]').click(function() {
		$('input[name="Config_PI"]').trigger("change");
	  });
	  $('input[name="Config_PI"]').change(function() {
		let completedData = document.querySelectorAll('*[data-name]');
		tempSaveAttachment = config.dataset.Optional_Attachment;
		for (let i = 0; i < completedData.length; i++) {
		  config.dataset[completedData[i].getAttribute('data-name')] = completedData[i].value;
		}
		config.dataset.Config_PI = $(this).val();
		config.dataset.Optional_Attachment = tempSaveAttachment;
		nbsf.init(config, config.page);
	  });
	},
	page12: function() {
	  console.log('page12');
	},
	page13: function() {
        console.log('page13');
        if (document.querySelector('input[data-name="ProductServices_Attachment"]')) {
          const OptAtt = document.querySelector('[data-name="ProductServices_Attachment"]');
          const kendoOptAtt = $(OptAtt).data('kendoUpload');
          kendoOptAtt.bind("upload", function(e) {
            if (e.files && e.files.length) {
              // config.dataset.ProductServices_Attachment_Flag = 'Y';
            }
          });
  
          $('input[data-name="ProductServices_Attachment"]').live('change', function() {
            if (document.querySelector('.k-upload .k-upload-files .k-file-validation-message')) {
              mo.fn.modal.show({
                ctaLabel: hpe.fn.lang('OK', config.locale, config.localizations),
                title: hpe.fn.lang('ErrorGeneric2', config.locale, config.localizations),
                content: hpe.fn.lang("FormACR001", config.locale, config.localizations),
                ctaCallback: function() {
                  mo.fn.events.closeAll();
                },
                contentCallback: function() {
                  config.dataset.ProductServices_Attachment = null;
                  $('.k-upload .k-upload-files .k-upload-status .k-icon[title="Remove"]').click();
                }
              });
              // config.dataset.ProductServices_Attachment_Flag = 'N';
            }
          });
        }
	  
	  const changableInputs = document.querySelectorAll('input[data-name*="Count"], input[data-name*="Selected"]');
	  if (changableInputs.length) {
		for (let i = 0; i < changableInputs.length; i++) {
		  changableInputs[i].addEventListener('change', function(e) {
			const check = nbsf.ev.global(config);
			if (!check.total.fail) {
			  quoteHelper.saveProductAndServicesConfig(config);
			}
		  });
		}
	  }
	  
	  if (!config.dataset.ProductServices_Attachment && config.dataset.Config_Quote !== 'Y') {
		 quoteHelper.onInitProductAndServices(config);
	//	quoteHelper.onCloneProductAndServices(config, document);
	  }

	  const selectedAllEl = document.querySelector("input[data-name='Selected_All']");
	  if (selectedAllEl) {
		if (document.querySelector("input[data-name='ProductServices_Attachment']")) {
		  selectedAllEl.closest(".fmmcosmin").style.visibility = "hidden";
		} else {
		  selectedAllEl.addEventListener("change", (e) => {
			const selAllChecked = e.target.checked;
			const paramValue = selAllChecked ? "Y" : null;
			config.dom.querySelectorAll("input[type='checkbox'][data-name^='Selected_']").forEach((cbEl) => {
			  const paramName = cbEl.getAttribute("data-name");
			  if (paramName != "Selected_All") {
				cbEl.checked = selAllChecked;
				config.dataset[paramName] = paramValue;
			  }
			});
			nbsf.ev.global(config);
		  });
		}
	  }
	},
	quotePreview: function() {
	  console.log('%c Quote Preview page ', 'background: #222; color: #bada55');    
	  const disableAddressQuoteList = ['SoldTo', 'Payer', 'ShipTo', 'EndCx'];
	  const currentValLengthOnPages = ['BillTo'];

	  // ** PartyId
	  const partyIds = $('input[data-name$="_PartyId"]');
	  $(partyIds).each(function() {
		const partyIdName = $(this).attr('data-name');
		const partyIdNamePrefix = partyIdName.split('_')[0];

		$(this).keyup(function() {
		  let currentVal = $(this).val();
		  
		  const isLocation = (partyIdNamePrefix == 'ShipTo' || partyIdNamePrefix == 'BillTo') && currentVal.length == 10 && currentVal[0] == "2";
		  
		  if (isLocation) {
			locationAddress(currentVal, partyIdNamePrefix, false);
		  } else if ( 
			(currentVal.length === 10 && !currentValLengthOnPages.includes(partyIdNamePrefix))
			|| (currentVal.length === 10 && currentValLengthOnPages.includes(partyIdNamePrefix) && currentVal[0] == "1")
		  ) {
			mo.fn.overlay.show({
			  progressText: hpe.fn.lang("FormCFI010", config.locale, config.localizations),
			  progressPercent: 10,
			  close: false
			})
			config.dataset.SoldTo_PartyId = currentVal;
			EMDMAddress(currentVal, partyIdNamePrefix, false);
		  }
		});

		$(`*[data-name*="${partyIdNamePrefix}_"]`).change(function() {
		  if ($(this)[0].getAttribute("data-name") != partyIdName && $(this)[0].getAttribute("data-name").indexOf(`${partyIdNamePrefix}_Contact`) == -1) {
			$(`*[data-name="${partyIdName}"]`).val('');
			config.dataset[partyIdName] = null;
			if (config.reviewDataset && Object.keys(config.reviewDataset).length) config.reviewDataset[partyIdName] = null;
		  }
		});
		$(`*[data-name*="${partyIdNamePrefix}_"]`).keyup(function() {
		  if ($(this)[0].getAttribute("data-name") != partyIdName && $(this)[0].getAttribute("data-name").indexOf(`${partyIdNamePrefix}_Contact`) == -1) {
			$(`*[data-name="${partyIdName}"]`).val('');
			config.dataset[partyIdName] = null;
			if (config.reviewDataset && Object.keys(config.reviewDataset).length) config.reviewDataset[partyIdName] = null;
		  }
		});

		// Disable some fields if quote is exist
		if (disableAddressQuoteList.includes(partyIdNamePrefix)) {
		  quoteHelper.disableAddressQuoteData(config);  
		}      
		helper.buildFastClearAddressButton(partyIdNamePrefix, true);
	  });   
	  // ** -- -- -- --

	  /*
    // ** NationalID
    const nationalIds = $('input[data-name$="_NationalID"]');
    $(nationalIds).each(function() {
      const nationalIdName = $(this).attr('data-name');
      const nationalIdNamePrefix = nationalIdName.split('_')[0];
      $(`*[data-name="${nationalIdNamePrefix}_NationalID"]`).parent().parent().parent().parent().addClass('fixNationalID');
    });
    // ** -- -- -- --
    */    

	  // ** AddressCountry    
	  const addressCountries = $('select[data-name$="_Address_Country"]');    
	  $(addressCountries).each(function() {
		const addressCountryName = $(this).attr('data-name');   
		const options = $(this).find('option');
		options.each(function() {
		  $(this).click(function() {
			$(`select[data-name="${addressCountryName}"]`).trigger("change");
		  });
		});

		$(`select[data-name="${addressCountryName}"]`).change(function() {
		  let completedData = document.querySelectorAll('*[data-name]');
		  for (let i = 0; i < completedData.length; i++) {
			config.dataset[completedData[i].getAttribute('data-name')] = completedData[i].value;
		  }
		  config.dataset[`${addressCountryName}`] = $(this).val();
		  if (config.reviewDataset && Object.keys(config.reviewDataset).length) config.reviewDataset[`${addressCountryName}`] = $(this).val();
		  nbsf.init(config, config.page);
		});
	  });
	  
	  // SoldTo
	  if (config.dataset.SoldTo_Address_Country && !config.dataset.SoldTo_Contact_Country) {
		$(`[data-name="SoldTo_Contact_Country"]`).val(config.dataset.SoldTo_Address_Country);
	  }
	  $(`[data-name="SoldTo_PartyId"]`).change(function() {
		$(`[data-name="SoldTo_Contact_Country"]`).val(config.dataset.SoldTo_Address_Country);
	  });
	  $(`[data-name="SoldTo_Address_Country"]`).change(function() {
		$(`[data-name="SoldTo_Contact_Country"]`).val($(this).val());
	  });
	  
	  // End Customer
	  if (config.dataset.EndCx_Address_Country && !config.dataset.EndCx_Contact_Country) {
		$(`[data-name="EndCx_Contact_Country"]`).val(config.dataset.EndCx_Address_Country);
	  }
	  $(`[data-name="EndCx_PartyId"]`).change(function() {
		$(`[data-name="EndCx_Contact_Country"]`).val(config.dataset.EndCx_Address_Country);
	  });
	  $(`[data-name="EndCx_Address_Country"]`).change(function() {
		$(`[data-name="EndCx_Contact_Country"]`).val($(this).val());
	  });
	  
	  // Reseller
	  if (config.dataset.Reseller_Address_Country && !config.dataset.Reseller_Contact_Country) {
		$(`[data-name="Reseller_Contact_Country"]`).val(config.dataset.Reseller_Address_Country);
	  }
	  $(`[data-name="Reseller_PartyId"]`).change(function() {
		$(`[data-name="Reseller_Contact_Country"]`).val(config.dataset.Reseller_Address_Country);
	  });
	  $(`[data-name="Reseller_Address_Country"]`).change(function() {
		$(`[data-name="Reseller_Contact_Country"]`).val($(this).val());
	  });
	  nbsf.ev.global(config, true);
	  
	  // ** -- -- -- --

	  $('input[data-name="ShipTo_PartyId"]').keyup(function() {
		let currentVal = $(this).val();
		if (currentVal.length == 10 && currentVal[0] == "1") {
		  config.dataset.ShipTo_PartyId = currentVal;
		  nbsf.init(config, config.page);
		  mo.fn.overlay.show({
			progressText: hpe.fn.lang("FormCFI010", config.locale, config.localizations),
			progressPercent: 10,
			close: false
		  })
		  EMDMAddress(currentVal, 'ShipTo', true);
		} else if (currentVal.length == 10 && currentVal[0] == "2") {
		  config.dataset.ShipTo_PartyId = currentVal;
		  locationAddress(currentVal, 'ShipTo', false);
		}
	  });
	  
	  /*
	  // BillTo
	  $('input[data-name="BillTo_PartyId"]').keyup(function() {
		let currentVal = $(this).val();
		if (currentVal.length == 10 && currentVal[0] == "1") {
		  config.dataset.BillTo_PartyId = currentVal;
		  nbsf.init(config, config.page);
		  mo.fn.overlay.show({
			progressText: hpe.fn.lang("FormCFI010", config.locale, config.localizations),
			progressPercent: 10,
			close: false
		  })
		  EMDMAddress(currentVal, 'BillTo', true);
		} else if (currentVal.length == 10 && currentVal[0] == "2") {
		  config.dataset.BillTo_PartyId = currentVal;
		  locationAddress(currentVal, 'BillTo', false);
		}
	  });*/
	  
	  // NOR-989 hotfix. Reflect values of non-required fields in dataset immediately
	  $("input[data-name]").on("input", (e) => {
		let inputEl = e.target;
		if (!!inputEl.parentNode.parentNode.querySelector(".name .required")) return;
		config.dataset[inputEl.getAttribute("data-name")] = inputEl.value;
	  });

	  helper.buildFastClearAddressButton('AgentProgram');    
	},
  };

  // CONFIG FORM TRANSLATIONS
  const otherFunctions = {
	lang: function() {
	  crud.read('3202', '', function(d) {
		if (typeof(d) !== 'object')
		  console.log('throw generic error');
		else {
		  let dataset = d.Rows;
		  for (let i = 0; i < dataset.length; i++)
			config.localizations[dataset[i].StringKey] = dataset[i];

		  config.locale = global.data.user.locale;
		  //if (global.data.user.email == 'demo_emea_distributor@pproap.com') config.locale = 'en_US';
		  for (let i = 0; i < config.pages.length; i++) {
			if (config.pages[i].title) config.pages[i].title = hpe.fn.lang(config.pages[i].title, config.locale, config.localizations);
			if (config.pages[i].subtitle) config.pages[i].subtitle = hpe.fn.lang(config.pages[i].subtitle, config.locale, config.localizations);
			if (config.pages[i].description) config.pages[i].description = hpe.fn.lang(config.pages[i].description, config.locale, config.localizations);
			if (config.pages[i].selectone) config.pages[i].selectone = hpe.fn.lang(config.pages[i].selectone, config.locale, config.localizations);
			if (config.pages[i].continue) config.pages[i].continue = hpe.fn.lang(config.pages[i].continue, config.locale, config.localizations);
			if (config.pages[i].back) config.pages[i].back = hpe.fn.lang(config.pages[i].back, config.locale, config.localizations);
			if (config.pages[i].submit) config.pages[i].submit = hpe.fn.lang(config.pages[i].submit, config.locale, config.localizations);
			if (config.pages[i].no) config.pages[i].no = hpe.fn.lang(config.pages[i].no, config.locale, config.localizations);
			if (config.pages[i].ok) config.pages[i].ok = hpe.fn.lang(config.pages[i].ok, config.locale, config.localizations);
			if (config.pages[i].poformat) config.pages[i].poformat = hpe.fn.lang(config.pages[i].poformat, config.locale, config.localizations);
			if (config.pages[i].savedraft) config.pages[i].savedraft = hpe.fn.lang(config.pages[i].savedraft, config.locale, config.localizations);

			for (let j = 0; j < config.pages[i].structure.length; j++) {
			  if (config.pages[i].structure[j].header) config.pages[i].structure[j].header = hpe.fn.lang(config.pages[i].structure[j].header, config.locale, config.localizations);
			  if (config.pages[i].structure[j].description) config.pages[i].structure[j].description = hpe.fn.lang(config.pages[i].structure[j].description, config.locale, config.localizations);

			  for (let k = 0; k < config.pages[i].structure[j].group.length; k++) {

				for (let l = 0; l < config.pages[i].structure[j].group[k].length; l++) {
				  if (config.pages[i].structure[j].group[k][l].label) config.pages[i].structure[j].group[k][l].label = hpe.fn.lang(config.pages[i].structure[j].group[k][l].label, config.locale, config.localizations);
				  if (config.pages[i].structure[j].group[k][l].placeholder) config.pages[i].structure[j].group[k][l].placeholder = hpe.fn.lang(config.pages[i].structure[j].group[k][l].placeholder, config.locale, config.localizations);

				  if (config.pages[i].structure[j].group[k][l].options) {

					for (let m = 0; m < config.pages[i].structure[j].group[k][l].options.length; m++) {
					  config.pages[i].structure[j].group[k][l].options[m] = hpe.fn.lang(config.pages[i].structure[j].group[k][l].options[m], config.locale, config.localizations);
					}
				  }
				}
			  }
			}
		  }
		}
	  });
	}
  };

  // QUOTE HELPER
  const quoteHelper = {
	quote: null,
	ucids: [],
	maxQuantity: null,
	quotePA: [],
	addressArr: [],
	country: null,
	readQuote: function(qid, callback, config) {
	  const xhr = new XMLHttpRequest();
	  xhr.onreadystatechange = function() {
		if (xhr.readyState == 4) {
		  if (xhr.status == 200) {
			config.dataset.Quote_Error = null;
			const response = JSON.parse(xhr.responseText);
			console.log('[readQuote] response:', response);
			if (response && response.status === 'SUCCESS') {
			  return callback ? callback(response.hpQuote) : response.hpQuote;
			}
			return callback ? callback(null) : null;
		  } else {
			console.log('error of readQuote');
		  }
		}
	  }
	  xhr.open(
		'GET',
		`https://hpe-rfb.it.hpe.com/resources/rs/custom/php/qids/readquote.php?qid=${qid}`
	  );
	  // for testing: 
	  // xhr.timeout = qid === 'NI01062833-01' ? 1000 : 10000;
	  xhr.timeout = 80000;
	  const errorHandler = function() {
		mo.fn.modal.show({
		  close: false,
		  ctaLabel: hpe.fn.lang('OK', config.locale, config.localizations),
		  title: hpe.fn.lang('Form264', config.locale, config.localizations),
		  content: '',
		  ctaCallback: function() {
			quoteHelper.quote = null;
			quoteHelper.country = null;
			quoteHelper.quotePA = [];
			config.dataset.Quote_Error = "Y";
			quoteHelper.initDefaultPOData(config, true);
			quoteHelper.clearHeaderQuoteData(config);
			quoteHelper.initCountry(config, true);
			nbsf.init(config, config.page);
			quoteHelper.disableAddressQuoteData(config);
			quoteHelper.disableHeaderQuote(config);
			mo.fn.overlay.hide();
			mo.fn.events.closeAll();
		  }
		});
	  }
	  xhr.onerror = errorHandler;
	  xhr.onabort = errorHandler;
	  xhr.ontimeout = errorHandler;
	  xhr.send(null);
	},
	validateQuote: function(quote) {
	  if (!quote || !quote.quoteHeader) {
		return {
		  valid: false,
		  text: hpe.fn.lang("Form231", config.locale, config.localizations)
		};
	  }

	  const {
		QuoteEndDate,
		QuoteStatus,
		Type,
		GoToMarketRoute
	  } = quote.quoteHeader;

	  let isExpired = true;
	  if (QuoteEndDate) {
		const currentDate = new Date();
		const endDate = new Date(QuoteEndDate);
		const wtCurrentDate = new Date(currentDate.getTime());
		const wtEndDate = new Date(endDate.getTime());
		wtCurrentDate.setUTCHours(0, 0, 0, 0);
		wtEndDate.setUTCHours(0, 0, 0, 0);

		isExpired = wtCurrentDate.getTime() > wtEndDate.getTime();
	  }

	  if (isExpired) {
		const formatDate = new Date(QuoteEndDate).toJSON().slice(0, 10);
		return {
		  valid: false,
		  text: `${hpe.fn.lang("Form232", config.locale, config.localizations)} <br> ${formatDate}`
		};
	  }

	  if (QuoteStatus !== 'Orderable' && QuoteStatus !== 'Quote Complete') {
		return {
		  valid: false,
		  text: `${hpe.fn.lang("Form233", config.locale, config.localizations)} ${QuoteStatus}`
		};
	  }

	  const serpFlag = quote.QuoteFlagsList.QuoteFlags.find((flag) => flag.FlagType === 'serpFlag');
	  const serpValue = serpFlag && serpFlag.FlagValue === "true";
	  if (!serpValue) {
		return {
		  valid: false,
		  text: hpe.fn.lang("Form235", config.locale, config.localizations)
		};
	  }

	  if (Type !== 'Legal Quote') {
		return {
		  valid: false,
		  text: `${hpe.fn.lang("Form234", config.locale, config.localizations)} ${Type}`
		};
	  }

	  if (!['Indirect', 'SI'].includes(GoToMarketRoute)) {
		return {
		  valid: false,
		  text: hpe.fn.lang("Form236", config.locale, config.localizations)
		};
	  }

	  // agreements - PANumbers
	  const iCMPANumbers = global.data.brt.pas || [];
	  const items = quote.hpQuoteLineItemList.HpQuoteLineItems || [];
	  var PANumbers = [];
	  if (Array.isArray(items)) {
		PANumbers = items.filter(item => item.PANumber).map(item => item.PANumber);
	  } else if (items && items.PANumber) {
		PANumbers.push(items.PANumber);
	  }
	  quoteHelper.quotePA = [];
	  if (iCMPANumbers.length && PANumbers.length) {
		quoteHelper.quotePA = iCMPANumbers.filter(value => PANumbers.includes(value));
		quoteHelper.quotePA = [...new Set(quoteHelper.quotePA)];
	  }
	  else if(iCMPANumbers.length && !PANumbers.length){
		quoteHelper.quotePA = [...new Set(iCMPANumbers)].sort();

	  }

	  if (!quoteHelper.quotePA.length) {
		PANumbers = [...new Set(PANumbers)];
		PANumbers.join(', ');
		// comment for testing - todo: add a setting
		// return { valid: false, text: hpe.fn.lang("Form237", config.locale, config.localizations).replace('[PANumber]', PANumbers) };
	  }
	  
	  const HpQuoteLineItems = quote.hpQuoteLineItemList.HpQuoteLineItems;
	  if (HpQuoteLineItems) {
		// check that HpQuoteLineItems is a non-empty array
		if (Array.isArray(HpQuoteLineItems) && HpQuoteLineItems.length) {
		  const lightHpQuoteLineItems = [];
		  HpQuoteLineItems.forEach(el => {
			if (el.LineType === "Config" || (el.LineType == "Product" && !el.UCID)) {
			  lightHpQuoteLineItems.push(el);
			}
			else if (el.PANumber) {
			  lightHpQuoteLineItems.push({PANumber: el.PANumber});
			}
		  });
		  quote.hpQuoteLineItemList.HpQuoteLineItems = lightHpQuoteLineItems;
		}
	  }

	  // save quote to reference
	  quoteHelper.quote = quote;
	  // quote is valid
	  return {
		valid: true,
		text: ''
	  };
	},
	initHeaderQuoteData: function(config) {
	  if (quoteHelper.quote && quoteHelper.quote.quoteHeader && !config.dataset.Quote_Error) {
		const iCMPANumbers = global.data.brt.pas || [];
		const PANumber = quoteHelper.quotePA && quoteHelper.quotePA.length && quoteHelper.quotePA[0];
		const {
		  CurrencyIsoCode,
		  PriceListType,
		  OpportunityId,
		  GrandTotal,
		  TotalNetPricewithBenefits,
		  PaymentTermDescription,
		  SalesOrg,
		  TotalTax,
		  BusinessGroup
		} = quoteHelper.quote.quoteHeader;
		const totalValue = Number(TotalNetPricewithBenefits) == 0 ? GrandTotal : TotalNetPricewithBenefits;
		const po_value = config.dataset.CountryCode == 'BR' ? ((Math.round(totalValue * 100) - Math.round(TotalTax * 100)) / 100) : totalValue;

		const filterConfig = {
		  PO_Currency: {
			filter: {
			  logic: "or",
			  filters: [{
				field: "CountryCode",
				operator: "in",
				value: global.nonPoModelCountries
			  },
						{
						  logic: "and",
						  filters: [{
							field: "Region",
							operator: "neq",
							value: "APJ"
						  },
									{
									  field: "SubRegion",
									  operator: "neq",
									  value: "UKI"
									},
									{
									  field: "Geo",
									  operator: "nin",
									  value: ["DACH", "Europe South", "North West Europe"]
									}
								   ]
						}
					   ]
			},
			value: CurrencyIsoCode,
		  },
		  PO_DeliveryIncoterms: {
			filter: {
			  field: "Region",
			  operator: "eq",
			  value: "AMS"
			},
			value: PriceListType,
		  },
		  Requestor_PO_Opp_ID: {
			filter: {
			  field: "Region",
			  operator: "eq",
			  value: "AMS"
			},
			value: OpportunityId,
		  },
		  PO_Value: {
			filter: {
			  logic: "or",
			  filters: [{
				field: "CountryCode",
				operator: "in",
				value: global.nonPoModelCountries
			  },
						{
						  logic: "and",
						  filters: [{
							field: "Region",
							operator: "neq",
							value: "APJ"
						  },
									{
									  field: "SubRegion",
									  operator: "neq",
									  value: "UKI"
									},
									{
									  field: "Geo",
									  operator: "nin",
									  value: ["DACH", "Europe South", "North West Europe"]
									}
								   ]
						}
					   ]
			},
			value: po_value,
		  },
		  Payment_Terms: {
			filter: {
			  logic: "or",
			  filters: [{
				field: "aggrVal",
				operator: "eq",
				value: "0"
			  },
						{
						  logic: "and",
						  filters: [{
							field: "aggrVal",
							operator: "eq",
							value: "1"
						  },
									{
									  logic: "or",
									  filters: [{
										field: "Region",
										operator: "eq",
										value: "AMS"
									  },
												{
												  field: "Geo",
												  operator: "eq",
												  value: "Central Europe"
												},
												{
												  field: "SubRegion",
												  operator: "eq",
												  value: "MESA"
												},
												{
												  field: "Geo",
												  operator: "eq",
												  value: "CERTA"
												}
											   ]
									}
								   ]
						}
					   ]
			},
			value: PaymentTermDescription,
		  },
		  PO_HPEEntity: {
			filter: {
			  field: "CountryCode",
			  operator: "in",
			  value: ["CZ", "PL", "HU", "TR", "RO", "KZ"]
			},
			value: SalesOrg === "HPE BV (NL60)" ? "HPE BV (NL60)" : "HPE Local",
		  },
		  PA_Number: {
			filter: {
			  logic: "or",
			  filters: [{
				field: "aggrVal",
				operator: "eq",
				value: "0"
			  },
						{
						  logic: "and",
						  filters: [{
							field: "aggrVal",
							operator: "eq",
							value: "1"
						  },
									{
									  logic: "or",
									  filters: [{
										field: "Region",
										operator: "eq",
										value: "AMS"
									  },
												{
												  field: "Geo",
												  operator: "eq",
												  value: "Central Europe"
												},
												{
												  field: "SubRegion",
												  operator: "eq",
												  value: "MESA"
												},
												{
												  field: "Geo",
												  operator: "eq",
												  value: "CERTA"
												}
											   ]
									}
								   ]
						},
						{
						  logic: "and",
						  filters: [{
							field: "Region",
							operator: "neq",
							value: "AMS"
						  },
									{
									  field: "aggrVal",
									  operator: "eq",
									  value: "1"
									},
									{
									  field: "Geo",
									  operator: "nin",
									  value: ["CERTA"]
									},
									{
									  field: "SubRegion",
									  operator: "nin",
									  value: ["Central Europe", "MESA"]
									}
								   ]
						}
					   ]
			},
			value: PANumber || iCMPANumbers[0],
		  },
		  TaxAmount: {
			filter: {
			  field: "CountryCode",
			  operator: "eq",
			  value: ["BR"]
			},
			value: TotalTax || "",
		  },
		  PO_Value_Tax: {
			filter: {
			  field: "CountryCode",
			  operator: "eq",
			  value: ["BR"]
			},
			value: TotalNetPricewithBenefits || "",
		  },
		  PO_BackgroundGroup: {
			filter: {
			  logic: "and",
			  filters: []
			},
			value: BusinessGroup === 'Edge' ? 'Edge' : 'Hybrid IT',
		  }
		};

		for (key in filterConfig) {
		  const filter = nbsf.fn.filter(config.dataset, filterConfig[key].filter);
		  config.dataset[key] = filter ? filterConfig[key].value : null;
		}
	  }
	},
	clearHeaderQuoteData: function(config) {
	  config.dataset.PO_Currency = null;
	  config.dataset.PO_DeliveryIncoterms = null;
	  config.dataset.Requestor_PO_Opp_ID = null;
	  config.dataset.PO_Value = null;
	  config.dataset.Payment_Terms = null;
	  config.dataset.PO_HPEEntity = null;
	  config.dataset.TaxAmount = null;
	  config.dataset.PO_Value_Tax = null;
	  config.dataset.PO_BackgroundGroup = null;
	  quoteHelper.quotePA = [];
	},
	initCountry: function(config, invalidQuoteID, force = true) {
	  config.dataset.hideSIM = 'Y';
	  config.dataset.hideQECC = 'Y';
	  let countryData = reference.countriesData.find(x => x.ISO2 == global.data.geo.code);
	  let quoteCurrency = null;
	  let quoteCurrencies = null;

	  // if quote is exist 
	  const quote = quoteHelper.quote || (config.dataset.QuoteResponse ? JSON.parse(config.dataset.QuoteResponse) : null);
	  const isCurrentQuote = quote && quote.quoteHeader && !config.dataset.Quote_Error && quote.quoteHeader.OriginatingSystemQuoteAndVersionID === config.dataset.Requestor_PO_Quote_ID;
	  const quoteCountry = isCurrentQuote && quote.quoteHeader.EndCustomer && quote.quoteHeader.EndCustomer.Address && quote.quoteHeader.EndCustomer.Address.Country;

	  if (config.dataset.Config_Quote == 'Y' && config.dataset.Requestor_PO_Quote_ID && !invalidQuoteID && quote && quote.quoteHeader.CurrencyIsoCode) {
		quoteCurrency = quote.quoteHeader.CurrencyIsoCode;
		quoteCurrencies = [quoteCurrency];
	  }

	  if (config.dataset.Config_Quote == 'Y' && config.dataset.Requestor_PO_Quote_ID && !invalidQuoteID && quoteCountry) {
		const address = quote.quoteHeader.EndCustomer.Address;
		if (address && address.Country) {
		  countryData = reference.countriesData.find(x => x.ISO2 == address.Country);
		  if (countryData) {
			config.dataset.hideQECC = 'N';
			config.dataset.QECC_Country = countryData && countryData.Name;
		  }
		}
		// SIM
	  } else if (global.data.sim && global.data.sim.length) {
		config.dataset.hideSIM = 'N';
		if (!config.dataset.SIM_Country) {
		  countryData = reference.countriesData.find(x => x.ISO2 == global.data.sim[0]);
		  config.dataset.SIM_Country = countryData && countryData.Name;
		} else {
		  countryData = reference.countriesData.find(x => x.Name == config.dataset.SIM_Country);
		}
	  }

	  if (!countryData) {
		countryData = reference.countriesData.find(x => x.ISO2 == global.data.geo.code);
	  }

	  if (countryData) {
		config.dataset.CountryCode = countryData.ISO2;
		config.dataset.Country = countryData.Name;
		config.dataset.Region = countryData.Region;
		config.dataset.Geo = countryData.GEO;
		config.dataset.SubRegion = countryData.SubRegion;

		if (document.querySelector('*[data-name="CountryCode"]'))
		  $('*[data-name="CountryCode"]').val(config.dataset.CountryCode);
		if (document.querySelector('*[data-name="Country"]'))
		  $('*[data-name="Country"]').val(config.dataset.Country);
		if (document.querySelector('*[data-name="Region"]'))
		  $('*[data-name="Region"]').val(config.dataset.Region);
		if (document.querySelector('*[data-name="Geo"]'))
		  $('*[data-name="Geo"]').val(config.dataset.Geo);
		if (document.querySelector('*[data-name="SubRegion"]'))
		  $('*[data-name="SubRegion"]').val(config.dataset.SubRegion);


		// change currencies
		reference.currencies = quoteCurrencies || (countryData.Country_Currencies ? countryData.Country_Currencies.split(',') : ['USD']);
		config.dataset.PO_Currency = quoteCurrency || reference.currencies[0] || 'USD';

		/*if (config.dataset.Config_Quote !== 'Y') {
                    // change SoldTo country
                    config.dataset.SoldTo_Address_Country = countryData.Name;
                    config.dataset.SoldTo_Contact_Country = countryData.Name;
                }*/

		quoteHelper.country = countryData;

		if (force) {
		  quoteHelper.clearAddressConfigs(config);
		}
	  }
	},
	disableHeaderQuote: function(config) {
	  const quote = quoteHelper.quote || (config.dataset.QuoteResponse ? JSON.parse(config.dataset.QuoteResponse) : null);
	  const disabledFields = ['PO_Currency', 'PO_DeliveryIncoterms', 'Requestor_PO_Opp_ID'];
	  disabledFields.forEach((field) => {
		const node = document.querySelector(`*[data-name="${field}"]`);
		const selectOne = config.pages[1].selectone || 'Select one';
		let isValueExist = node && node.value && node.value !== selectOne && node.value !== 'OPE-';

		if (node) {
		  if (config.dataset.Config_Quote == 'N' || !config.dataset.Requestor_PO_Quote_ID || !isValueExist || config.dataset.Quote_Error === 'Y') {
			$(`*[data-name="${field}"]`).parent().parent().removeClass('wrapper-disabled');
			$(`*[data-name="${field}"]`).removeAttr("disabled");
		  } else if (field === 'PO_DeliveryIncoterms' && quote && quote.quoteHeader && quote.quoteHeader.PriceListType === 'FCA' && !config.dataset.Quote_Error) {
			$(`*[data-name="${field}"]`).parent().parent().removeClass('wrapper-disabled');
			$(`*[data-name="${field}"]`).removeAttr("disabled");
		  } else {
			$(`*[data-name="${field}"]`).parent().parent().addClass('wrapper-disabled');
			$(`*[data-name="${field}"]`).attr("disabled", 'disabled');
		  }
		}
	  })
	},
	disableAddressQuoteData: function(config) {
	  const disabledFields = [ //"SoldTo_PartyId",
		//"SoldTo_CompanyName",
		//"SoldTo_Address_Street",
		//"SoldTo_Address_City",
		//"SoldTo_Address_State",
		// "SoldTo_Address_Postal",
		 "SoldTo_Address_Country", // NOR-915 urgent fix: remove comment
		//"Payer_PartyId",
		//"Payer_CompanyName",
		//"Payer_Address_Street",
		//"Payer_Address_City",
		//"Payer_Address_State",
		//"Payer_Address_Postal",
		"Payer_Address_Country", // NOR-915 urgent fix: remove comment
		"EndCx_Address_Country",
	  ];
	  disabledFields.forEach((field) => {
		const node = document.querySelector(`*[data-name="${field}"]`);
		const selectOne = config.pages[1].selectone || 'Select one';
		let isValueExist = node && node.value && node.value !== selectOne && node.value !== 'OPE-';
		if (node) {
		  if (config.dataset.Config_Quote == 'N' || !config.dataset.Requestor_PO_Quote_ID || config.dataset.Quote_Error || !isValueExist) {
			$(`*[data-name="${field}"]`).parent().parent().removeClass('wrapper-disabled');
			$(`*[data-name="${field}"]`).removeAttr("disabled");
		  } else {
			$(`*[data-name="${field}"]`).parent().parent().addClass('wrapper-disabled');
			$(`*[data-name="${field}"]`).attr("disabled", 'disabled');
		  }
		}
	  })
	},
	initDefaultPOData: function(config, force, section = 'all') {
	  if (force) {
		quoteHelper.clearAddressData(config);
	  }

	  // ALTERNATE NAME
	  let alternateName = '';
	  if (reference.xref.party && reference.xref.party[0].organizationAlternateName && reference.xref.party[0].organizationAlternateName.length > 0) {
		reference.xref.party[0].organizationAlternateName.forEach(function(item) {
		  if (
			item.internalOverWriteFlag === 'Y' &&
			item.status === 'ACTIVE' &&
			item.characterScript === 'LATN' &&
			item.type === 'TRADESTYLE'
		  ) {
			alternateName = item.organizationAlternateName;
		  }
		});
	  }
	  alternateName = alternateName || (reference.xref.party && reference.xref.party[0].organizationName);

	  // ADDRESS
	  let addressMatched = null;
	  let address1 = '';
	  let address2 = '';
	  if (reference.xref.party && reference.xref.party[0].address && reference.xref.party[0].address.length > 0) {
		addressMatched = reference.xref.party[0].address.find(item => {
		  return item.internalOverWriteFlag == "Y" && item.status == "ACTIVE" && item.addressType == "PHY" && item.countryLanguageCode.includes('-LATN');
		});

		if (!addressMatched) {
		  addressMatched = reference.xref.party[0].address.find(item => {
			return item.status == "ACTIVE" && item.addressType == "PHY" && item.countryLanguageCode.includes('-LATN');
		  });
		}

		if (!addressMatched) {
		  addressMatched = reference.xref.party[0].address.find(item => {
			return item.status == "ACTIVE" && item.addressType == "PHY";
		  });
		}

		if (addressMatched) {
		  address1 = addressMatched.addressLine1;
		  address2 = addressMatched.addressLine2;
		  if (!addressMatched.addressLine2 && addressMatched.addressLine1.length > 55) {
			const separator = addressMatched.addressLine1.substr(0, 55).lastIndexOf(' ');
			address1 = addressMatched.addressLine1.substr(0, separator);
			address2 = addressMatched.addressLine1.substr(separator + 1);
		  }
		}
	  }

	  // COUNTRIES
	  const countries_address = ["Australia", "New Zealand", "India", "Malaysia", "Argentina", "Brazil", "Chile", "Colombia", "Mexico", "Peru", "Puerto Rico"];
	  const countries_nationalId = ["Argentina", "Brazil", "Chile", "Colombia", "Mexico", "Peru", "Puerto Rico"];

	  // NATIONAL ID
	  let nationalId = null;
	  let soldToNationalId = null;
	  if (reference.xref.party) {
		var externalidentifier = reference.xref.party[0].externalIdentifier;
		for (i = 0; i < externalidentifier.length; i++) {
		  if (externalidentifier[i].status == "ACTIVE" && ["Tax Number 1"].indexOf(externalidentifier[i].externalIdentifierName) > -1) {
			soldToNationalId = externalidentifier[i].identifierValue;
			break;
		  }
		}
	  }
	  
	  if (countries_nationalId.indexOf(reference.xref.party[0].countryName) > -1) {
		nationalId = soldToNationalId;
	  }


	  // HIDDEN INPUT: SOLDTO
	  if (config.dataset.SoldTo_CompanyName == null || config.dataset.SoldTo_CompanyName.length == 0) {
		config.dataset.SoldTo_PartyId = config.dataset.PartyId;
		if (config.dataset.Email.indexOf('@hpe.com') > -1)
		  config.dataset.SoldTo_Contact_Email = config.dataset.OnBehalf_CreatedBy;
		else
		  config.dataset.SoldTo_Contact_Email = config.dataset.Email;
		config.dataset.SoldTo_Contact_FirstName = config.dataset.FirstName;
		config.dataset.SoldTo_Contact_LastName = config.dataset.LastName;
		config.dataset.SoldTo_Contact_Country = reference.xref.party[0].countryName;
		config.dataset.SoldTo_Address_Country = reference.xref.party[0].countryName;

		config.dataset.BRT = global.data.brt.name;
		config.dataset.PartnerName = global.data.company.name;
		config.dataset.Country = global.data.geo.name;

		config.dataset.SoldTo_CompanyName = alternateName;

		if (addressMatched) {
		  if (countries_address.indexOf(reference.xref.party[0].countryName) > -1)
			config.dataset.SoldTo_Address_State = addressMatched.stateProvince;

		  config.dataset.SoldTo_Address_City = addressMatched.cityName;
		  config.dataset.SoldTo_Address_Postal = addressMatched.postalCode;
		  config.dataset.SoldTo_Address_Street = address1;
		  config.dataset.SoldTo_Address_Street2 = address2;
		}

		if (nationalId) {
		  config.dataset.SoldTo_NationalID = nationalId;
		}
	  }
	  // HIDDEN INPUT: PAYER
	  if (config.dataset.Payer_CompanyName == null || config.dataset.Payer_CompanyName.length == 0) {
		config.dataset.Payer_PartyId = config.dataset.PartyId;
		//config.dataset.Payer_Contact_Email = config.dataset.Email;
		//config.dataset.Payer_Contact_FirstName = config.dataset.FirstName;
		//config.dataset.Payer_Contact_LastName = config.dataset.LastName;
		//config.dataset.Payer_Contact_Country = reference.xref.party[0].countryName;
		config.dataset.Payer_Address_Country = reference.xref.party[0].countryName;

		config.dataset.Payer_CompanyName = alternateName;

		if (addressMatched) {
		  if (countries_address.indexOf(reference.xref.party[0].countryName) > -1)
			config.dataset.Payer_Address_State = addressMatched.stateProvince;

		  config.dataset.Payer_Address_City = addressMatched.cityName;
		  config.dataset.Payer_Address_Postal = addressMatched.postalCode;
		  config.dataset.Payer_Address_Street = address1;
		  config.dataset.Payer_Address_Street2 = address2;
		}
	  }
/*
	  // HIDDEN INPUT: BILLING
	  if (config.dataset.BillTo_CompanyName == null || config.dataset.BillTo_CompanyName.length == 0) {
		config.dataset.BillTo_PartyId = config.dataset.PartyId;
		//config.dataset.BillTo_Contact_Email = config.dataset.Email;
		//config.dataset.BillTo_Contact_FirstName = config.dataset.FirstName;
		//config.dataset.BillTo_Contact_LastName = config.dataset.LastName;
		//config.dataset.BillTo_Contact_Country = reference.xref.party[0].countryName;
		config.dataset.BillTo_Address_Country = reference.xref.party[0].countryName;

		config.dataset.BillTo_CompanyName = alternateName;

		if (addressMatched) {
		  if (countries_address.indexOf(reference.xref.party[0].countryName) > -1)
			config.dataset.BillTo_Address_State = addressMatched.stateProvince;

		  config.dataset.BillTo_Address_City = addressMatched.cityName;
		  config.dataset.BillTo_Address_Postal = addressMatched.postalCode;
		  config.dataset.BillTo_Address_Street = address1;
		  config.dataset.BillTo_Address_Street2 = address2;
		}
	  }
*/
	},

	initAddressQuoteData: async function(config, section = 'all') {
	  console.log('quoteHelper.addressArr', quoteHelper.addressArr);
	  // typeof section: all, SoldTo, Payer, BillTo, ShipTo, Reseller, EndCustomer
	  const quote = quoteHelper.quote || (config.dataset.QuoteResponse ? JSON.parse(config.dataset.QuoteResponse) : null);
	  quoteHelper.quote = quote;
	  if (quoteHelper.quote && quoteHelper.quote.quoteHeader && !config.dataset.Quote_Error) {
		quoteHelper.clearAddressData(config, section);

		const companyAssociations = {
		  Name: 'CompanyName',
		  PartyID: 'PartyId',
		};

		const addressAssociations = {
		  Address1: 'Address_Street',
		  Address2: 'Address_Street2',
		  City: 'Address_City',
		  State: 'Address_State',
		  PostalCode: 'Address_Postal',
		  Country: 'Address_Country',
		  TradeStyleName: 'Address_TBD',
		};

		const contactAssociations = {
		  FirstName: 'Contact_FirstName',
		  LastName: 'Contact_LastName',
		  PhoneNumber: 'Contact_Phone',
		  Email: 'Contact_Email',
		  Country: 'Contact_Country',
		};

		function hpeDataXrefAddressPromise(partyId) {
		  return new Promise((resolve, reject) => {
			hpe.data.xref(partyId, (d) => {
			  if (d && d.status == 'SUCCESS') {
				resolve(d);
			  } else {
				reject(new Error("Failed to fetch data."));
			  }
			});
		  });
		}

		async function processAddressAssociations(partyId, section, quoteSection) {
		  let existingEntry = quoteHelper.addressArr.find(entry => entry.PartyId === partyId);
		  console.log('existingEntry', existingEntry);
		  if (!existingEntry) {
			try {
			  let d = await hpeDataXrefAddressPromise(partyId);

			  if (d) {
				let addressObj = {
				  PartyId: d.party[0].currentPartyID || d.party[0].submittedPartyID || partyId,
				  Address_Country: d.party[0].countryName
				};
				let alternateName = '';
				if (d.party[0].organizationAlternateName && d.party[0].organizationAlternateName.length > 0) {
				  d.party[0].organizationAlternateName.forEach(function(item) {
					if (
					  item.internalOverWriteFlag === 'Y' &&
					  item.status === 'ACTIVE' &&
					  item.characterScript === 'LATN' &&
					  item.type === 'TRADESTYLE'
					) {
					  alternateName = item.organizationAlternateName;
					}
				  });
				}
				addressObj['CompanyName'] = alternateName ? alternateName : d.party[0].organizationName;

				let addressMatched = null;
				if (d.party[0].address && d.party[0].address.length > 0) {
				  addressMatched = d.party[0].address.find(item => {
					return item.internalOverWriteFlag == "Y" && item.status == "ACTIVE" && item.addressType == "PHY" && item.countryLanguageCode.includes('-LATN');
				  });

				  if (!addressMatched) {
					addressMatched = d.party[0].address.find(item => {
					  return item.status == "ACTIVE" && item.addressType == "PHY" && item.countryLanguageCode.includes('-LATN');
					});
				  }

				  if (!addressMatched) {
					addressMatched = d.party[0].address.find(item => {
					  return item.status == "ACTIVE" && item.addressType == "PHY";
					});
				  }

				  if (addressMatched) {
					if (["Australia", "New Zealand", "India", "Malaysia", "Argentina", "Brazil", "Chile", "Colombia", "Mexico", "Peru", "Puerto Rico"].indexOf(d.party[0].countryName) > -1)
					  config.dataset[`${section}_Address_State`] = addressMatched.stateProvince;

					let address1 = addressMatched.addressLine1;
					let address2 = addressMatched.addressLine2;
					if (!addressMatched.addressLine2 && addressMatched.addressLine1.length > 55) {
					  const separator = addressMatched.addressLine1.substr(0, 55).lastIndexOf(' ');
					  address1 = addressMatched.addressLine1.substr(0, separator);
					  address2 = addressMatched.addressLine1.substr(separator + 1);
					}

					addressObj['Address_City'] = addressMatched.cityName;
					addressObj['Address_Postal'] = addressMatched.postalCode;
					addressObj['Address_Street'] = address1;
					addressObj['Address_Street2'] = address2;

				  }
				}

				if (section == 'ShipTo' || section == 'EndCx') {
				  if (["Argentina", "Brazil", "Chile", "Colombia", "Mexico", "Peru", "Puerto Rico"].indexOf(d.party[0].countryName) > -1) {
					var externalidentifier = d.party[0].externalIdentifier;
					for (i = 0; i < externalidentifier.length; i++) {
					  if (externalidentifier[i].status == "ACTIVE" && ["Tax Number 1"].indexOf(externalidentifier[i].externalIdentifierName) > -1) {
						addressObj['NationalID'] = externalidentifier[i].identifierValue;
						config.dataset[`${section}_NationalID`] = externalidentifier[i].identifierValue;
						break;
					  }
					}
				  }
				}
				// SoldTo NationalID for all countries
				if (section == 'SoldTo') {
				  var externalidentifier = d.party[0].externalIdentifier;
				  for (i = 0; i < externalidentifier.length; i++) {
					if (externalidentifier[i].status == "ACTIVE" && ["Tax Number 1"].indexOf(externalidentifier[i].externalIdentifierName) > -1) {
					  addressObj['NationalID'] = externalidentifier[i].identifierValue;
					  config.dataset[`${section}_NationalID`] = externalidentifier[i].identifierValue;
					  break;
					}
				  }
				}

				quoteHelper.addressArr.push(addressObj);

				config.dataset[`${section}_PartyId`] = addressObj ? addressObj['PartyId'] : null;
				config.dataset[`${section}_CompanyName`] = addressObj ? addressObj['CompanyName'] : null;
				config.dataset[`${section}_Address_Country`] = addressObj ? addressObj['Address_Country'] : null;
				config.dataset[`${section}_Address_City`] = addressObj ? addressObj['Address_City'] : null;
				config.dataset[`${section}_Address_Postal`] = addressObj ? addressObj['Address_Postal'] : null;
				config.dataset[`${section}_Address_Street`] = addressObj ? addressObj['Address_Street'] : null;
				config.dataset[`${section}_Address_Street2`] = addressObj ? addressObj['Address_Street2'] : null;
				console.log('existingEntry second', addressObj);
			  }

			} catch (error) {
			  console.error('Error fetching data:', error);
			}
		  } else {
			config.dataset[`${section}_PartyId`] = existingEntry ? existingEntry['PartyId'] : null;
			config.dataset[`${section}_CompanyName`] = existingEntry ? existingEntry['CompanyName'] : null;
			config.dataset[`${section}_Address_Country`] = existingEntry['Address_Country'];
			config.dataset[`${section}_Address_City`] = existingEntry['Address_City'];
			config.dataset[`${section}_Address_Postal`] = existingEntry['Address_Postal'];
			config.dataset[`${section}_Address_Street`] = existingEntry['Address_Street'];
			config.dataset[`${section}_Address_Street2`] = existingEntry['Address_Street2'];
			if (section == 'ShipTo' || section == 'EndCx' || section == 'SoldTo') {
			  config.dataset[`${section}_NationalID`] = existingEntry['NationalID'];
			}
		  }
		  const isSoldToContactMissing = quoteSection === 'SoldTo' && (!quoteHelper.quote.quoteHeader[quoteSection].Contact.LastName || !quoteHelper.quote.quoteHeader[quoteSection].Contact.Email);
		  if (isSoldToContactMissing) {
			// get data from DXP
			config.dataset.SoldTo_Contact_Country = reference.xref.party[0].countryName;
			if (config.dataset.Email.indexOf('@hpe.com') > -1) {
			  config.dataset.SoldTo_Contact_Email = config.dataset.OnBehalf_CreatedBy;
			  config.dataset.SoldTo_Contact_FirstName = config.dataset.FirstName;
			  config.dataset.SoldTo_Contact_LastName = config.dataset.LastName;
			} else {
			  config.dataset.SoldTo_Contact_Email = config.dataset.Email;
			  config.dataset.SoldTo_Contact_FirstName = global.data.user.fname;
			  config.dataset.SoldTo_Contact_LastName = global.data.user.lname;
			}
		  } else {
			for (let key in contactAssociations) {
			  if (key === 'Country') {
				const country = reference.countriesData.find((item) => item.ISO2 === quoteHelper.quote.quoteHeader[quoteSection].Contact[key]);
				config.dataset[`${section}_${contactAssociations[key]}`] = country ? country.Name : null;
			  } else {
				config.dataset[`${section}_${contactAssociations[key]}`] = quoteHelper.quote.quoteHeader[quoteSection].Contact[key];
			  }
			}
		  }

		  // “TradeStyleName” to “Company name” wherever available if not use the name field 
		  //config.dataset[`${section}_CompanyName`] = (quoteHelper.quote.quoteHeader[quoteSection].Address && quoteHelper.quote.quoteHeader[quoteSection].Address.TradeStyleName) || quoteHelper.quote.quoteHeader[quoteSection].Company.Name;
		}

		const initDataset = async function(section, quoteSection) {
		  if (quoteHelper.quote.quoteHeader[quoteSection]) {
			let partyId;
			let distributorInfoPartyId =  (quoteHelper.quote.quoteHeader.DistributorInfo &&  quoteHelper.quote.quoteHeader.DistributorInfo.Company) ? quoteHelper.quote.quoteHeader.DistributorInfo.Company.PartyID : null;

			if (section == 'SoldTo') {
			  if (distributorInfoPartyId) {
				partyId = distributorInfoPartyId;
			  } else if (quoteHelper.quote.quoteHeader[quoteSection].Company.PartyID) {
				partyId = quoteHelper.quote.quoteHeader[quoteSection].Company.PartyID;
			  } else {
				partyId = global.data.company.party;
			  }
			  console.log('SoldTo id', partyId);
			} else if (section == 'Payer') {
			  if (quoteHelper.quote.quoteHeader[quoteSection].Company.PartyID) {
				partyId = quoteHelper.quote.quoteHeader[quoteSection].Company.PartyID;

			  } else {
				if (distributorInfoPartyId) {
				  partyId = distributorInfoPartyId;
				} else if (quoteHelper.quote.quoteHeader['SoldTo'].Company.PartyID) {
				  partyId = quoteHelper.quote.quoteHeader['SoldTo'].Company.PartyID;
				} else {
				  partyId = global.data.company.party;
				}
				console.log('Copied Sold To id', partyId);
			  }
			  console.log('Payer id', partyId);
			} else {
			  partyId = quoteHelper.quote.quoteHeader[quoteSection].Company.PartyID;
			}

			if (partyId) {
			  await processAddressAssociations(partyId, section, quoteSection);
			}

			//check if hpe email reseller
			const isHPEReseller = quoteSection === 'ResellerInfo' &&
				  quoteHelper.quote.quoteHeader[quoteSection].Contact &&
				  quoteHelper.quote.quoteHeader[quoteSection].Contact.Email &&
				  quoteHelper.quote.quoteHeader[quoteSection].Contact.Email.includes('@hpe.com');
			if (isHPEReseller) {
			  config.dataset.Reseller_Contact_Email = null;
			  config.dataset.Reseller_Contact_FirstName = null;
			  config.dataset.Reseller_Contact_LastName = null;
			  config.dataset.Reseller_Contact_Phone = null;
			  config.dataset.Reseller_Contact_Country = null;
			}

		  };
		};

		try {
		  mo.fn.overlay.show({
			loading: true,
			close: false
		  });

		  const sectionsToInitialize = [];

		  if (section === 'all') {
			sectionsToInitialize.push({
			  sectionName: 'SoldTo',
			  quoteSection: 'SoldTo'
			}, {
			  sectionName: 'Payer',
			  quoteSection: 'Payer'
			}, {
			  sectionName: 'BillTo',
			  quoteSection: 'BillTo'
			//}, { // NOR-874: Ship to address to be left Blank
			//  sectionName: 'ShipTo',
			//  quoteSection: 'ShipTo'
			}, {
			  sectionName: 'Reseller',
			  quoteSection: 'ResellerInfo'
			});
			
			if (config.dataset.PO_Category !== 'Stock') {
			  sectionsToInitialize.push({
				sectionName: 'EndCx',
				quoteSection: 'EndCustomer'
			  });
			}
			
		  } else {
			// Depending on the section specified, only push the relevant sections
			switch (section) {
			  case 'SoldTo':
				sectionsToInitialize.push({
				  sectionName: 'SoldTo',
				  quoteSection: 'SoldTo'
				});
				break;
			  case 'Payer':
				sectionsToInitialize.push({
				  sectionName: 'Payer',
				  quoteSection: 'Payer'
				});
				break;
			  case 'BillTo':
				sectionsToInitialize.push({
				  sectionName: 'BillTo',
				  quoteSection: 'BillTo'
				});
				break;
			  case 'ShipTo': // NOR-874: Ship to address to be left Blank
				//sectionsToInitialize.push({
				//  sectionName: 'ShipTo',
				//  quoteSection: 'ShipTo'
				//});
				break;
			  case 'Reseller':
				sectionsToInitialize.push({
				  sectionName: 'Reseller',
				  quoteSection: 'ResellerInfo'
				});
				break;
			  case 'EndCustomer':
				sectionsToInitialize.push({
				  sectionName: 'EndCx',
				  quoteSection: 'EndCustomer'
				});
				break;
				// If there are more sections, they can be added similarly
			}
		  }

		  for (let s of sectionsToInitialize) {
			await initDataset(s.sectionName, s.quoteSection);
		  }

		} catch (error) {
		  console.error("Error in initDataset operations:", error);
		} finally {
		  mo.fn.overlay.hide();
		}
	  }
	},
	clearAddressConfigs: function(config) {
	  // APJ / APAC  NWE;UKI;DACH;ESOU
	  config.dataset.Config_SoldToDetails = 'N';
	  config.dataset.Config_SoldToDetails_Contact = 'N';
	  config.dataset.Config_PayerDetails = 'N';
	  config.dataset.Config_BillToDetails = 'N';
	  config.dataset.Config_ShipToDetails = 'N';
	  config.dataset.Config_ShipToDetails_Contact = 'N';
	  config.dataset.Config_ResellerDetails = 'N';
	  config.dataset.Config_ResellerDetails_Contact = 'N';
	  config.dataset.Config_EndCxDetails = 'N';
	  config.dataset.Config_EndCxDetails_Contact = 'N';

	  // AMS GEO - MESA / CERTA or MEA / CETA
	  const isCase2 = config.dataset.Config_Quote === 'Y' && !config.dataset.Quote_Error &&
			(["CERTA", "CETA", "Latin America", "North America"].includes(config.dataset.Geo) ||
			 config.dataset.SubRegion === "MESA" || config.dataset.internalUser);
	  const defaultConfigCase2 = isCase2 ? 'Y' : 'N';
	  config.dataset.Config_PPC_SoldTo = defaultConfigCase2;
	  config.dataset.Config_PPC_Payer = defaultConfigCase2;
	  config.dataset.Config_PPC_BillTo = defaultConfigCase2;
	  config.dataset.Config_PPC_ShipTo = defaultConfigCase2;
	  config.dataset.Config_PPC_Reseller = defaultConfigCase2;
	  config.dataset.Config_PPC_EndCx = defaultConfigCase2;

	  // FIX?
	  const fields = ["PO_BusinessModel",
					  "PO_Category",
					  "Requestor_PO_Deal_ID",
					  "Requestor_PO_Opp_ID",
					  "Config_UCID",
					  "Config_UCIDQ",
					  "Config_ConfigId",
					  // "PO_CompleteDelivery",
					  "Invoice_Format",
					  "Invoice_SendEmail",
					  "PO_Number",
					  "PO_Attachment",
					  "PO_HPEEntity",
					 ];
	  if (config.dataset.CountryCode !== 'KR') {
		fields.push("PO_CompleteDelivery");
	  }
	  fields.forEach((field) => config.dataset[field] = null);

	  if (document.querySelector('*[data-name="Config_SoldToDetails"]'))
		$('*[data-name="Config_SoldToDetails"]').val(config.dataset.Config_SoldToDetails);
	  if (document.querySelector('*[data-name="Config_SoldToDetails_Contact"]'))
		$('*[data-name="Config_SoldToDetails_Contact"]').val(config.dataset.Config_SoldToDetails_Contact);
	  if (document.querySelector('*[data-name="Config_PayerDetails"]'))
		$('*[data-name="Config_PayerDetails"]').val(config.dataset.Config_PayerDetails);
	  if (document.querySelector('*[data-name="Config_BillToDetails"]'))
		$('*[data-name="Config_BillToDetails"]').val(config.dataset.Config_BillToDetails);
	  if (document.querySelector('*[data-name="Config_ShipToDetails"]'))
		$('*[data-name="Config_ShipToDetails"]').val(config.dataset.Config_ShipToDetails);
	  if (document.querySelector('*[data-name="Config_ShipToDetails_Contact"]'))
		$('*[data-name="Config_ShipToDetails_Contact"]').val(config.dataset.Config_ShipToDetails_Contact);
	  if (document.querySelector('*[data-name="Config_ResellerDetails"]'))
		$('*[data-name="Config_ResellerDetails"]').val(config.dataset.Config_ResellerDetails);
	  if (document.querySelector('*[data-name="Config_ResellerDetails_Contact"]'))
		$('*[data-name="Config_ResellerDetails_Contact"]').val(config.dataset.Config_ResellerDetails_Contact);
	  if (document.querySelector('*[data-name="Config_EndCxDetails"]'))
		$('*[data-name="Config_EndCxDetails"]').val(config.dataset.Config_EndCxDetails);
	  if (document.querySelector('*[data-name="Config_EndCxDetails_Contact"]'))
		$('*[data-name="Config_EndCxDetails_Contact"]').val(config.dataset.Config_EndCxDetails_Contact);

	  if (document.querySelector('*[data-name="Config_PPC_SoldTo"]'))
		$('*[data-name="Config_PPC_SoldTo"]').val(config.dataset.Config_PPC_SoldTo);
	  if (document.querySelector('*[data-name="Config_PPC_Payer"]'))
		$('*[data-name="Config_PPC_Payer"]').val(config.dataset.Config_PPC_Payer);
	  if (document.querySelector('*[data-name="Config_PPC_BillTo"]'))
		$('*[data-name="Config_PPC_BillTo"]').val(config.dataset.Config_PPC_BillTo);
	  if (document.querySelector('*[data-name="Config_PPC_ShipTo"]'))
		$('*[data-name="Config_PPC_ShipTo"]').val(config.dataset.Config_PPC_ShipTo);
	  if (document.querySelector('*[data-name="Config_PPC_Reseller"]'))
		$('*[data-name="Config_PPC_Reseller"]').val(config.dataset.Config_PPC_Reseller);
	  if (document.querySelector('*[data-name="Config_PPC_EndCx"]'))
		$('*[data-name="Config_PPC_EndCx"]').val(config.dataset.Config_PPC_EndCx);
	},
	clearAddressData: function(cfg, section = 'all') {
	  // section: "all" or one of config.sectionName
	  config.sectionName.filter(sect => section === "all" || sect == section).forEach((sect) => {
		config.clearData({
		  fields: config.sectionFields[sect]
		});
	  });
	},
	buildQuotePreviewPage: function(config) {
	  // CONFIGURATION FOR DATA REVIEW UI
	  var reviewSetup = {
		soldto: {
		  id: 'PPC_SoldTo',
		  title: hpe.fn.lang("Form054", config.locale, config.localizations),
		  fieldset: [
			[hpe.fn.lang("Form086", config.locale, config.localizations), "SoldTo_PartyId"],
			[hpe.fn.lang("Form058", config.locale, config.localizations), "SoldTo_CompanyName"],
			[hpe.fn.lang("Address", config.locale, config.localizations), "SoldTo_Address_Street"],
			[hpe.fn.lang("AddressLineOptional", config.locale, config.localizations), "SoldTo_Address_Street2"],
			[hpe.fn.lang("City", config.locale, config.localizations), "SoldTo_Address_City"],
			[hpe.fn.lang("StateProvince", config.locale, config.localizations), "SoldTo_Address_State"],
			[hpe.fn.lang("Postal code", config.locale, config.localizations), "SoldTo_Address_Postal"],
			[hpe.fn.lang("Country", config.locale, config.localizations), "SoldTo_Address_Country"],
			[hpe.fn.lang("Form495", config.locale, config.localizations), "SoldTo_NationalID"],
			// [hpe.fn.lang("Form495", config.locale, config.localizations), "SoldTo_NationalID"],
			// ['', 'blank'],
			[hpe.fn.lang("FirstName", config.locale, config.localizations), "SoldTo_Contact_FirstName"],
			[hpe.fn.lang("Surname", config.locale, config.localizations), "SoldTo_Contact_LastName"],
			[hpe.fn.lang("Telephone", config.locale, config.localizations), "SoldTo_Contact_Phone"],
			[hpe.fn.lang("Email", config.locale, config.localizations), "SoldTo_Contact_Email"],
			[hpe.fn.lang("CountryOfResidence", config.locale, config.localizations), "SoldTo_Contact_Country"]
		  ]
		},
		payer: {
		  id: 'PPC_Payer',
		  title: hpe.fn.lang("Form206", config.locale, config.localizations),
		  fieldset: [
			[hpe.fn.lang("Form086", config.locale, config.localizations), "Payer_PartyId"],
			[hpe.fn.lang("Form058", config.locale, config.localizations), "Payer_CompanyName"],
			[hpe.fn.lang("Address", config.locale, config.localizations), "Payer_Address_Street"],
			[hpe.fn.lang("AddressLineOptional", config.locale, config.localizations), "Payer_Address_Street2"],
			[hpe.fn.lang("City", config.locale, config.localizations), "Payer_Address_City"],
			[hpe.fn.lang("StateProvince", config.locale, config.localizations), "Payer_Address_State"],
			[hpe.fn.lang("Postal code", config.locale, config.localizations), "Payer_Address_Postal"],
			[hpe.fn.lang("Country", config.locale, config.localizations), "Payer_Address_Country"],
			['', 'blank'],
			[hpe.fn.lang("FirstName", config.locale, config.localizations), "Payer_Contact_FirstName"],
			[hpe.fn.lang("Surname", config.locale, config.localizations), "Payer_Contact_LastName"],
			[hpe.fn.lang("Telephone", config.locale, config.localizations), "Payer_Contact_Phone"],
			[hpe.fn.lang("Email", config.locale, config.localizations), "Payer_Contact_Email"],
			[hpe.fn.lang("CountryOfResidence", config.locale, config.localizations), "Payer_Contact_Country"]
		  ]
		},
		billto: {
		  id: 'PPC_BillTo',
		  title: hpe.fn.lang("Form204", config.locale, config.localizations),
		  fieldset: [
			[hpe.fn.lang("Form086", config.locale, config.localizations), "BillTo_PartyId"],
			[hpe.fn.lang("Form058", config.locale, config.localizations), "BillTo_CompanyName"],
			[hpe.fn.lang("Address", config.locale, config.localizations), "BillTo_Address_Street"],
			[hpe.fn.lang("AddressLineOptional", config.locale, config.localizations), "BillTo_Address_Street2"],
			[hpe.fn.lang("City", config.locale, config.localizations), "BillTo_Address_City"],
			[hpe.fn.lang("StateProvince", config.locale, config.localizations), "BillTo_Address_State"],
			[hpe.fn.lang("Postal code", config.locale, config.localizations), "BillTo_Address_Postal"],
			[hpe.fn.lang("Country", config.locale, config.localizations), "BillTo_Address_Country"],
			['', 'blank'],
			[hpe.fn.lang("FirstName", config.locale, config.localizations), "BillTo_Contact_FirstName"],
			[hpe.fn.lang("Surname", config.locale, config.localizations), "BillTo_Contact_LastName"],
			[hpe.fn.lang("Telephone", config.locale, config.localizations), "BillTo_Contact_Phone"],
			[hpe.fn.lang("Email", config.locale, config.localizations), "BillTo_Contact_Email"],
			[hpe.fn.lang("CountryOfResidence", config.locale, config.localizations), "BillTo_Contact_Country"]
		  ]
		},
		shipping: {
		  id: 'PPC_ShipTo',
		  title: hpe.fn.lang("Form205", config.locale, config.localizations),
		  fieldset: [
			[hpe.fn.lang("Form086", config.locale, config.localizations), "ShipTo_PartyId"],
			[hpe.fn.lang("Form058", config.locale, config.localizations), "ShipTo_CompanyName"],
			[hpe.fn.lang("Address", config.locale, config.localizations), "ShipTo_Address_Street"],
			[hpe.fn.lang("AddressLineOptional", config.locale, config.localizations), "ShipTo_Address_Street2"],
			[hpe.fn.lang("City", config.locale, config.localizations), "ShipTo_Address_City"],
			[hpe.fn.lang("StateProvince", config.locale, config.localizations), "ShipTo_Address_State"],
			[hpe.fn.lang("Postal code", config.locale, config.localizations), "ShipTo_Address_Postal"],
			[hpe.fn.lang("Country", config.locale, config.localizations), "ShipTo_Address_Country"],
			[hpe.fn.lang("Form495", config.locale, config.localizations), "ShipTo_NationalID"],
			[hpe.fn.lang("FirstName", config.locale, config.localizations), "ShipTo_Contact_FirstName"],
			[hpe.fn.lang("Surname", config.locale, config.localizations), "ShipTo_Contact_LastName"],
			[hpe.fn.lang("Telephone", config.locale, config.localizations), "ShipTo_Contact_Phone"],
			[hpe.fn.lang("Email", config.locale, config.localizations), "ShipTo_Contact_Email"],
			[hpe.fn.lang("CountryOfResidence", config.locale, config.localizations), "ShipTo_Contact_Country"]
		  ]
		},
		reseller: {
		  id: 'PPC_Reseller',
		  title: hpe.fn.lang("Form126", config.locale, config.localizations),
		  filter: {
			logic: "or",
			filters: [{
			  logic: "and",
			  filters: [{
				field: "PartnerBRT",
				operator: "in",
				value: ["Distributor", "OEM Distributor", "System Integrator"]
			  },
						{
						  field: "PO_BusinessModel",
						  operator: "nin",
						  value: ["Agent Model", "HPFS & Agent Model"]
						},
						{
						  field: "PO_Category",
						  operator: "neq",
						  value: "Stock"
						}
					   ]
			},
					  {
						logic: "and",
						filters: [{
						  field: "PartnerBRT",
						  operator: "eq",
						  value: "T1 Solution Provider"
						},
								  {
									field: "CountryCode",
									operator: "eq",
									value: "KR"
								  },
								  {
									field: "PO_Category",
									operator: "neq",
									value: "Stock"
								  }
								 ]
					  }
					 ]
		  },
		  fieldset: [
			[hpe.fn.lang("Form086", config.locale, config.localizations), "Reseller_PartyId"],
			[hpe.fn.lang("Form058", config.locale, config.localizations), "Reseller_CompanyName"],
			[hpe.fn.lang("Address", config.locale, config.localizations), "Reseller_Address_Street"],
			[hpe.fn.lang("AddressLineOptional", config.locale, config.localizations), "Reseller_Address_Street2"],
			[hpe.fn.lang("City", config.locale, config.localizations), "Reseller_Address_City"],
			[hpe.fn.lang("StateProvince", config.locale, config.localizations), "Reseller_Address_State"],
			[hpe.fn.lang("Postal code", config.locale, config.localizations), "Reseller_Address_Postal"],
			[hpe.fn.lang("Country", config.locale, config.localizations), "Reseller_Address_Country"],
			//	[hpe.fn.lang("Postal code", config.locale, config.localizations), "Reseller_NationalID"],
			['', 'blank'],
			[hpe.fn.lang("FirstName", config.locale, config.localizations), "Reseller_Contact_FirstName"],
			[hpe.fn.lang("Surname", config.locale, config.localizations), "Reseller_Contact_LastName"],
			[hpe.fn.lang("Telephone", config.locale, config.localizations), "Reseller_Contact_Phone"],
			[hpe.fn.lang("Email", config.locale, config.localizations), "Reseller_Contact_Email"],
			[hpe.fn.lang("CountryOfResidence", config.locale, config.localizations), "Reseller_Contact_Country"]
		  ]
		},
		endcx: {
		  id: 'PPC_EndCx',
		  title: hpe.fn.lang("Form138", config.locale, config.localizations),
		  filter: {
			field: "PO_Category",
			operator: "neq",
			value: "Stock"
		  },
		  fieldset: [
			[hpe.fn.lang("Form086", config.locale, config.localizations), "EndCx_PartyId"],
			[hpe.fn.lang("Form058", config.locale, config.localizations), "EndCx_CompanyName"],
			[hpe.fn.lang("Address", config.locale, config.localizations), "EndCx_Address_Street"],
			[hpe.fn.lang("AddressLineOptional", config.locale, config.localizations), "EndCx_Address_Street2"],
			[hpe.fn.lang("City", config.locale, config.localizations), "EndCx_Address_City"],
			[hpe.fn.lang("StateProvince", config.locale, config.localizations), "EndCx_Address_State"],
			[hpe.fn.lang("Postal code", config.locale, config.localizations), "EndCx_Address_Postal"],
			[hpe.fn.lang("Country", config.locale, config.localizations), "EndCx_Address_Country"],
			[hpe.fn.lang("Form495", config.locale, config.localizations), "EndCx_NationalID"],
			[hpe.fn.lang("FirstName", config.locale, config.localizations), "EndCx_Contact_FirstName"],
			[hpe.fn.lang("Surname", config.locale, config.localizations), "EndCx_Contact_LastName"],
			[hpe.fn.lang("Telephone", config.locale, config.localizations), "EndCx_Contact_Phone"],
			[hpe.fn.lang("Email", config.locale, config.localizations), "EndCx_Contact_Email"],
			[hpe.fn.lang("CountryOfResidence", config.locale, config.localizations), "EndCx_Contact_Country"]
		  ]
		},
	  }
	  let objK = Object.keys(reviewSetup);
	  for (i = 0; i < objK.length; i++) {
		let key = objK[i];
		const id = reviewSetup[key].id;
		if (!document.querySelector(`input[data-name=${id}]`)) {
		  continue;
		}
		document.querySelector(`input[data-name=${id}]`).parentElement.parentElement.parentElement.parentElement.classList.add('PPC', `${id}_output`);
		var app = document.querySelector(`.${id}_output`);
		// move config toggle to the right 
		$(app).prev().addClass('PPC PPC_toggle');
		const geo = config.dataset.Geo || global.data.geo.geography;

		var {
		  valid,
		  validationConfig,
		  hidebill
		} = quoteHelper.validateAddressData(config, key);
		// Disable toggle and open page 
		const toggleId = `Config_${id}`;
		if (!valid) {
		  if (document.querySelector(`*[data-name="${toggleId}"]`)) {
			config.dataset[toggleId] = "N";
			$(`*[data-name="${toggleId}"]`).val("N");
			$(`*[data-name="${toggleId}"]`).parent().addClass("active");
			$(`*[data-name="${toggleId}"]`).parent().parent().parent().addClass('wrapper-disabled');
		  }
		} else {
		  if (document.querySelector(`*[data-name="${toggleId}"]`)) {
			config.dataset[toggleId] = "Y";
			$(`*[data-name="${toggleId}"]`).val("Y");
			$(`*[data-name="${toggleId}"]`).parent().removeClass("active");
			$(`*[data-name="${toggleId}"]`).parent().parent().parent().removeClass('wrapper-disabled');
		  }
		}

		if (key == "endcx") {
		  var POOptionalValidArray = ["Latin America", "Central Europe", "UKIMESA", "CERTA", "MESA", "North America"];
		  if (POOptionalValidArray.indexOf(geo) > -1) {
			var main = reviewSetup[key];
			var FilterObj = {
			  "field": "PO_Category",
			  "operator": "neq",
			  "value": "Stock"
			};
			var mergeobj = Object.assign(main, {
			  "filter": FilterObj
			});
			reviewSetup[key] = mergeobj;
		  }
		} /*else if (key == "reseller") {
                    var POOptionalValidArray = ["Latin America", "Central Europe", "UKIMESA", "CERTA", "MESA", "North America"];
                    if (POOptionalValidArray.indexOf(geo) > -1) {
                        if (global.BRT != "Distributor") {
                            var main = reviewSetup[key];
                            var FilterObj = {
                                "field": "PartnerBRT",
                                "operator": "eq",
                                "value": "Distributor"
                            };

                            var mergeobj = Object.assign(main, {
                                "filter": FilterObj
                            });
                            reviewSetup[key] = mergeobj;
                        } else {
                            var main = reviewSetup[key];
                            var FilterObj = [{
                                    "field": "PO_BusinessModel",
                                    "operator": "notcontains",
                                    "value": "Agent Model"
                                },
                                {
                                    "field": "PO_Category",
                                    "operator": "neq",
                                    "value": "Stock"
                                }
                            ];
                            var filters = {
                                logic: "and",
                                filters: FilterObj
                            }
                            var mergeobj = Object.assign(main, {
                                "filter": filters
                            });
                            reviewSetup[key] = mergeobj;
                        }
                    }
                }
			*/
		var filter = true;

		if (typeof(reviewSetup[key].filter) === "object") {
		  // Filter fields
		  filter = nbsf.fn.filter(config.dataset, reviewSetup[key].filter);
		  // Filter toggles
		  if (!filter || !reviewSetup[key].fieldset.length) {
			$(app).prev().remove();
		  }
		}
		if (reviewSetup[key].fieldset.length > 0 && filter) {
		  // Set default SVG for caret up
		  var svgAttributes = {
			ariaLabel: "down",
			points: "7.086 3.174 17.086 13.174 7.086 23.174",
			transform: "scale(1 -1) rotate(-89 -1.32 0)"
		  };


		  if (key === 'billto' && hidebill == true) {
			svgAttributes = {

			  ariaLabel: "up",
			  points: "7.086 1.174 17.086 11.174 7.086 21.174",
			  transform: "rotate(-89 12.086 11.174)"
			};
		  }
		  app.innerHTML += '<div class="row" review-id="' + key + '">' +
			'<svg class="collapse" review-id="' + key + '" style="position: absolute; top: 15px; cursor: pointer" version="1.1" viewBox="0 0 24 24" role="img" aria-label="' + svgAttributes.ariaLabel + '" width="24px" height="24px">' +
			'<polyline fill="none" stroke="#666" stroke-width="2" points="' + svgAttributes.points + '"' + (svgAttributes.transform ? ' transform="' + svgAttributes.transform + '"' : '') + '></polyline>' +
			'</svg><h4>' + reviewSetup[key].title + '</h4><div class="container" review-id="' + key + '"></div></div>';

		  var row = app.querySelector(".container[review-id=" + key + "]");
		  if (key === 'billto' && hidebill == true) {
			$(row).hide();
		  }
		  var headerchk = false;
		  for (j = 0; j < reviewSetup[key].fieldset.length; j++) {
			var item = reviewSetup[key].fieldset[j];
			var isMandatory = validationConfig[key] && validationConfig[key].includes(item[1]);
			var label = `${item[0]}${isMandatory ? ' <span class="mandatory-asterisk">*</span>' : ''}`;
			var value = config.dataset[item[1]];

			if (typeof(value) === "undefined" || value == null || value == "" || value == "OPE-") value = "N/A";
			if (item[1] === 'blank') value = '';

			// ["N/A", "NA", "Select one", "+1000000000", "NA@IGNOREME.COM", " "
			if (["NA@IGNOREME.COM"].indexOf(value) == -1) {
			  var type = "";
			  var optiondata = "";
			  var valuesdata = "";
			  for (a = 0; a < config.pages.length; a++) {
				for (b = 0; b < config.pages[a].structure.length; b++) {
				  for (l = 0; l < config.pages[a].structure[b].group.length; l++) {
					for (k = 0; k < config.pages[a].structure[b].group[l].length; k++) {
					  if (config.pages[a].structure[b].group[l][k].data == item[1]) {
						type = config.pages[a].structure[b].group[l][k].type;
						if (type == "select") {
						  if (config.pages[a].structure[b].group[l][k].options != null)
							optiondata = config.pages[a].structure[b].group[l][k].options;

						  valuesdata = config.pages[a].structure[b].group[l][k].values;
						}
						break;
					  }
					}
				  }
				}
			  }
			  if (type == "select") {
				if (optiondata == "")
				  row.innerHTML += '<div class="item"><strong>' + label + '</strong><p>' + value + '</p></div>';
				else {
				  if (["PO_BackgroundGroup"].indexOf(item[1]) > -1) {
					var indexval = 0;
					if (optiondata.length >= 4 || valuesdata.length >= 4) {
					  if (["EMEA", "APJ", "AMS"].indexOf(global.data.geo.region) > -1) {
						valuesdata.splice(1, 1);
						valuesdata.splice(1, 1);
						optiondata.splice(1, 1);
						optiondata.splice(1, 1);
					  } else {
						valuesdata.splice(3, 1);
						valuesdata.splice(2, 1);
						optiondata.splice(3, 1);
						optiondata.splice(2, 1);
					  }
					}
					for (g = 0; g < valuesdata.length; g++) {
					  if (valuesdata[g] == value)
						indexval = g;
					}
					row.innerHTML += '<div class="item"><strong>' + label + '</strong><p>' + hpe.fn.lang(optiondata[indexval], config.locale, config.localizations) + '</p></div>';
				  } else {
					var indexval = 0;
					for (g = 0; g < valuesdata.length; g++) {
					  if (valuesdata[g] == value)
						indexval = g;
					}
					row.innerHTML += '<div class="item"><strong>' + label + '</strong><p>' + hpe.fn.lang(optiondata[indexval], config.locale, config.localizations) + '</p></div>';
				  }
				}
			  } else
				row.innerHTML += '<div class="item"><strong>' + label + '</strong><p>' + value + '</p></div>';

			  headerchk = true;
			}


			if (j == reviewSetup[key].fieldset.length - 1) {
			  if (headerchk)
				row.innerHTML += '<div class="cfix"></div>';
			  else
				row.innerHTML = "";
			}
		  }
		}
	  }
    /* @TODO Delete draft logic
	  $('.nbsf .buttons .back').after($('<div class="btn draft">' + hpe.fn.lang('Form208', config.locale, config.localizations) + '</div>'));	  
     */
	},
	validateAddressData: function(config, section = 'soldto') {
	  const validationConfig = {
		soldto: ["SoldTo_CompanyName", "SoldTo_Address_Street", "SoldTo_Address_City", "SoldTo_Address_Country", "SoldTo_Contact_LastName", "SoldTo_Contact_Email"],
		payer: ["Payer_CompanyName", "Payer_Address_Street", "Payer_Address_City", "Payer_Address_Country"],
		billto: [],
		shipping: ["ShipTo_CompanyName", "ShipTo_Address_Street", "ShipTo_Address_City", "ShipTo_Address_Country"],
		endcx: ["EndCx_CompanyName", "EndCx_Address_Street", "EndCx_Address_City", "EndCx_Address_Country", "EndCx_Contact_LastName", "EndCx_Contact_Phone", "EndCx_Contact_Email"],
		reseller: ["Reseller_CompanyName", "Reseller_Address_Street", "Reseller_Address_City", "Reseller_Address_Country", "Reseller_Contact_LastName", "Reseller_Contact_Email"],
	  };
	  if (config.dataset.CountryCode != 'HK') {
		validationConfig.soldto.push("SoldTo_Address_Postal");
		validationConfig.payer.push("Payer_Address_Postal");
		validationConfig.shipping.push("ShipTo_Address_Postal");
		validationConfig.endcx.push("EndCx_Address_Postal");
		validationConfig.reseller.push("Reseller_Address_Postal");
	  }
	  
	  if (["Argentina", "Brazil", "Chile", "Colombia", "Mexico", "Peru", "Puerto Rico"].includes(config.dataset.SoldTo_Address_Country)) {
		validationConfig.shipping.push("SoldTo_NationalID");
	  }
	  
	  if (["Mexico", "Turkey"].includes(config.dataset.ShipTo_Address_Country)) {
		validationConfig.shipping.push("ShipTo_NationalID");
	  }
	  if (["Argentina", "Brazil", "Chile", "Colombia", "Mexico", "Peru", "Turkey", "Puerto Rico"].includes(config.dataset.EndCx_Address_Country)) {
		validationConfig.endcx.push("EndCx_NationalID");
	  }
	  if (config.dataset.SoldTo_Address_Country == 'Korea (Rep.)') {
		validationConfig.shipping.push("ShipTo_Contact_LastName");
		validationConfig.shipping.push("ShipTo_Contact_Phone");
		validationConfig.shipping.push("ShipTo_Contact_Email");
	  }
	  const billToFields = ["BillTo_PartyId", "BillTo_CompanyName", "BillTo_Address_Street", "BillTo_Address_Street2", "BillTo_Address_City", "BillTo_Address_State", "BillTo_Address_Postal", "BillTo_Address_Country", "BillTo_Contact_FirstName", "BillTo_Contact_LastName", "BillTo_Contact_Phone", "BillTo_Contact_Email", "BillTo_Contact_Country"];
	  let valid = true;
	  let hidebill = true;

	  if (section != 'billto') {
		for (let i = 0; i < validationConfig[section].length; i++) {
		  let field = validationConfig[section][i];
		  if (!config.dataset[field]) {
			valid = false;
			break;
		  }
		}
	  } else {
		const selectOne = config.pages[1].selectone || 'Select one';
		for (let i = 0; i < billToFields.length; i++) {
		  let field = billToFields[i];
		  if (config.dataset[field] && config.dataset[field] != selectOne) {
			hidebill = false;
			break;
		  }
		}
	  }
	  return {
		valid,
		validationConfig,
		hidebill
	  };
	},
	checkResellerAddressData: function(config) {
	  const useReseller = (
		(
		  ["Distributor", "OEM Distributor", "System Integrator"].includes(config.dataset.PartnerBRT) &&
		  !["Agent Model", "HPFS & Agent Model"].includes(config.dataset.PO_BusinessModel) &&
		  config.dataset.PO_Category !== "Stock"
		) ||
		(
		  config.dataset.PartnerBRT == 'T1 Solution Provider' &&
		  config.dataset.CountryCode == 'KR' &&
		  config.dataset.PO_Category !== "Stock"
		)
	  );
	  const useEndCustomer = config.dataset.PO_Category !== "Stock";

	  if (config.dataset.Config_Quote === 'Y' && !config.dataset.Quote_Error) {
		if (useReseller) {
		  if (config.dataset.Reseller_CompanyName === null) {
			quoteHelper.initAddressQuoteData(config, 'Reseller');
		  }
		} else {
		  // clear data
		  quoteHelper.clearAddressData(config, 'Reseller');
		}
		if (useEndCustomer) {
		  if (config.dataset.EndCx_CompanyName === null) {
			quoteHelper.initAddressQuoteData(config, 'EndCustomer');
		  }
		} else {
		  // clear data
		  quoteHelper.clearAddressData(config, 'EndCustomer');
		}
	  }
	},
	configureProductAndServices: function(config, page, callback) {
	  if (config.dataset.ProductServices_Attachment && config.dataset.Config_Quote !== "Y" && config.dataset.Config_PartialOrder == "Y") {
		const currentUcids = config.dataset.Config_Quote_PartialOrder ? JSON.parse(config.dataset.Config_Quote_PartialOrder) : [];  
		if (currentUcids && currentUcids.length) {
		  quoteHelper.ucids = currentUcids;
		  quoteHelper.buildProductAndServices(config, page);
		  if (callback) {
			callback();
		  }
		  return;
		}
	  }
	  
	  if (config.dataset.Config_Quote !== "Y" || config.dataset.Config_PartialOrder !== "Y" || !config.dataset.Requestor_PO_Quote_ID) {
		config.dataset.Config_Quote_PartialOrder = null;
		quoteHelper.ucids = [];
		quoteHelper.maxQuantity = null;
		if (config.dataset.Config_PartialOrder == "Y") {
		  quoteHelper.buildProductAndServices(config, page);
		}
		if (callback) {
		  callback();
		}
		return;
	  }
	  
	  if (config.dataset.Config_Quote == "Y" &&  config.dataset.Config_PartialOrder == "Y" && config.dataset.Requestor_PO_Quote_ID) {
		const currentUcids = config.dataset.Config_Quote_PartialOrder ? JSON.parse(config.dataset.Config_Quote_PartialOrder) : [];  
		if (currentUcids && currentUcids.length) {
		  quoteHelper.ucids = currentUcids;
		  quoteHelper.getMaxQuantity(config, currentUcids, function() {
			// filter by max quantity and build page with new config
			quoteHelper.ucids = quoteHelper.maxQuantity ? currentUcids.filter(ucid => quoteHelper.maxQuantity.get(ucid.ProductID) > 0) : currentUcids;
			const isSelected = quoteHelper.ucids.find(ucid => ucid.Selected);
			if (!isSelected && quoteHelper.ucids.length) {
			  quoteHelper.ucids[0].Selected = "Y";
			}
			config.dataset.Config_Quote_PartialOrder = JSON.stringify(quoteHelper.ucids);
			// build page
			quoteHelper.buildProductAndServices(config, page);
			if (callback) {
			  callback();
			}
		  });
		} else {
		  const quote = quoteHelper.quote || (config.dataset.QuoteResponse ? JSON.parse(config.dataset.QuoteResponse) : null);
		  if (quote && quote.hpQuoteLineItemList && !config.dataset.Quote_Error) {
			let items = quote.hpQuoteLineItemList.HpQuoteLineItems;
			const ucidConfig = [];
			const productIds = [];

			items = Array.isArray(items) ? items : [items];
			if (Array.isArray(items)) {
			  items.forEach((item) => {
				if (item.LineType === "Config" || (item.LineType === "Product" && !item.UCID)) {
				  if (!productIds.includes(item.ProductID)) {
					productIds.push(item.ProductID);
					const curUcid = currentUcids.find(el => el.ProductID === item.ProductID);
					const isTW = config.dataset.CountryCode == "TW" && (!item.NetPriceWithBenefits || item.NetPriceWithBenefits == "0" || item.NetPriceWithBenefits == "0.0");
					ucidConfig.push({
					  Request_Id: config.dataset.EntryId,
					  Requestor_PO_Quote_ID: config.dataset.Requestor_PO_Quote_ID,
					  UCID: item.UCID,
					  BundleID: item.BundleID,
					  DealId: item.DealId,
					  UnitNetAmount: isTW ? item.UnitNetAmount : item.NetPriceWithBenefits,
					  Count: curUcid ? curUcid.Count : 1,
					  ExtendedNetAmount: item.ExtendedNetAmount,
					  Quantity: item.Quantity,
					  CfgSystemId: item.CfgSystemId,
					  CfgSystemName: item.CfgSystemName,
					  Selected: curUcid ? curUcid.Selected : null,
					  ProductID: item.ProductID,
					  ProductClassificationCode: item.ProductClassificationCode,
					  LineType: item.LineType,
					  ID: item.ProductID && item.ProductID.replace(/[\-]/g, '_') || '',
					  PreviouslyPurchasedProductDetails: item.PreviouslyPurchasedProductDetails,
					  SerialNumberOfProducts: item.SerialNumberOfProducts,
					  ProductPurchasedDate: item.ProductPurchasedDate,
					  Carepack: item.Carepack || null,
					});
				  }
				}
			  })
			}
			quoteHelper.ucids = ucidConfig;

			// filter by max quantity and build page with new config
			quoteHelper.getMaxQuantity(config, ucidConfig, function() {
			  quoteHelper.ucids = quoteHelper.maxQuantity ? ucidConfig.filter(ucid => quoteHelper.maxQuantity.get(ucid.ProductID) > 0) : ucidConfig;
			  const isSelected = quoteHelper.ucids.find(ucid => ucid.Selected);
			  if (!isSelected && quoteHelper.ucids.length) {
				quoteHelper.ucids[0].Selected = "Y";
			  }
			  quoteHelper.ucids.forEach(item => {
				item.Count = quoteHelper.maxQuantity && quoteHelper.maxQuantity.get(item.ProductID) || item.Count;
				item.ExtendedNetAmount = Math.round(item.Count * item.UnitNetAmount * 100) / 100 || 0;
			  });
			  config.dataset.Config_Quote_PartialOrder = JSON.stringify(quoteHelper.ucids);
			  // build page
			  quoteHelper.buildProductAndServices(config, page);
			  if (callback) {
				callback();
			  }
			  return;
			});		
		  } else {
			console.error('no quote data');
			config.dataset.Config_Quote_PartialOrder = null;
			quoteHelper.ucids = [];
			quoteHelper.maxQuantity = null;
			if (callback) {
			  callback();
			}
			return;
		  }
		} 
	  }
	},
	getMaxQuantity: function(config, ucids, callback) {
	  const quoteId = config.dataset.Requestor_PO_Quote_ID;
	  const entryId = config.dataset.EntryId;
	  const map = new Map();
	  ucids.forEach(ucid => map.set(ucid.ProductID, ucid.Quantity ? Number(ucid.Quantity) : 0));
	  quoteHelper.maxQuantity = map;
	  if (callback) {
		callback();
	  }
/*
	  crud.read("6018", "Requestor_PO_Quote_ID=" +  quoteId, function(data) {
		if (data.Rows.length > 0) {
		  data.Rows.forEach(ucid => {
			if (ucid.Request_Id !== entryId && ucid.Selected == "Y") {
			  const curQ = map.get(ucid.ProductID);
			  map.set(ucid.ProductID, curQ - ucid.Count);
			}
		  });
		}
		quoteHelper.maxQuantity = map;
		if (callback) {
		  callback();
		}
	  });
*/
	},
	buildProductAndServices: function(config, page) {
	  // clear repeater node 
	  const sumRepeat = page.structure.reduce((accumulator, currentValue) => {
		if (currentValue.id == "form-table-repeat") {
		  return accumulator + 1;
		}
		return accumulator;
	  }, 0);
	  page.structure.splice(2, sumRepeat);
	  
	  if (quoteHelper.ucids) {
		const fields = [
		  "UCID",
		  "BundleID",
		  "DealId",
		  "UnitNetAmount",
		  "ExtendedNetAmount",
		  "Quantity",
		  "CfgSystemId",
		  "CfgSystemName",
		  "Selected",
		  "Count",
		  "ProductID",
		  "ProductClassificationCode",
		  "LineType",
		  "ID",
		  "PreviouslyPurchasedProductDetails",
		  "SerialNumberOfProducts",
		  "ProductPurchasedDate",
		  "HPEPartDescription",
		  "ITEM",
		  "Carepack",
		];
		const isDisabled = config.dataset.Config_Quote !== "Y";
		fields.forEach(field => {
		  quoteHelper.ucids.forEach(item => {
			config.dataset[`${field}_${item.ID}`] = item[field];
		  });
		});
		if (page.structure[1].group[0][0]) {
		  const newClass = page.structure[1].group[0][0].class.replace(" ftr-checkbox-hidden", '')
		  page.structure[1].group[0][0].class = newClass;
		} 
		const formTable = page.structure.find(item => item.id == "form-table");
		const group = [];
		// header
		group.push(formTable.group[0]);
		if (quoteHelper.ucids && quoteHelper.ucids.length) {
		  quoteHelper.ucids.forEach(ucid => {
			console.log(ucid);
			isCarePack = ucid.LineType == "Product" && ucid.ProductClassificationCode == "ES" ||
			  (config.dataset.Config_Quote !== "Y" && (ucid.PreviouslyPurchasedProductDetails || ucid.SerialNumberOfProducts || ucid.ProductPurchasedDate));
			const item = [
			  {
				label: "Checkbox (type checkbox)",
				data: "Selected_" + ucid.ID,
				required: false,
				value: ucid.Selected,
				type: "checkbox",
				values: ["Y",],
				disabled: isDisabled,
			  },
			  {
				label: "FormHPN",
				data: "ProductID_" + ucid.ID,
				value: ucid.ProductID,
				required: false,
				disabled: true,
				type: "text",
				validation: ['minLen|1'],
			  },
			  {
				label: "FormHPQ",
				value: ucid.Count,
				data: "Count_" + ucid.ID,
				required: false,
				type: "text",
				validation: ['minLen|1', 'isInteger'],
				typing: "isInteger",
				class: "bordered-input",
				
				disabled: isDisabled,
			  },
			  {
				label: "FormDealId",
				value: ucid.DealId,
				disabled: true,
				data: "DealId_" + ucid.ID,
				required: false,
				type: "text",
				validation: ['minLen|1'],
			  },				
			  {
				label: "FormBIID",
				value: ucid.BundleID,
				disabled: true,
				data: "BundleID_" + ucid.ID,
				required: false,
				type: "text",
				validation: ['minLen|1'],
			  },
			  {
				label: "FormUP",
				value: ucid.UnitNetAmount,
				disabled: true,
				data: "UnitNetAmount_" + ucid.ID,
				required: false,
				type: "text",
				validation: ['minLen|1'],
			  },
			  {
				label: "FormENP",
				value: ucid.ExtendedNetAmount,
				data: "ExtendedNetAmount_" + ucid.ID,
				required: true,
				disabled: true,
				type: "text",
				validation: ['minLen|1'],
			  }];
			// add carepack config for quote
			if (config.dataset.ProductServices_Attachment) {
			  item.push({
				data: "Field",
				type: "hidden",
			  });
			} else {
			  item.push({
				label: "FormCP",
				data: "Carepack_" + ucid.ID,
				required: false,
				type: "toggle",
				value: ucid.Carepack || "N",
				values: ["N", "Y"],
				options: ["Carepack", "Carepack"],
				class: `ps-toggle carepack_toggle ID_${ucid.ID}`,
			  });
			}
			group.push(item);
			const PPPD = [
			  {
				data: "Field",
				type: "hidden",
				class: `Carepack_PPPD_${ucid.ID}`,
			  },
			  {
				label: "FormPPPD",
				value: "Previously Purchased Product Details:",
				data: "PPPD",
				required: false,
				type: "textarea",
				disabled: true,
				validation: ['minLen|1'],
				class: "bolder-label",
			  },
			  {
				label: "Previously Purchased Product Details",
				value: ucid.PreviouslyPurchasedProductDetails,
				data: "PreviouslyPurchasedProductDetails_" + ucid.ID,
				disabled: isDisabled,
				required: false,
				type: "textarea",
				validation: ['minLen|1'],
				class: "bordered-input",
			  },
			  {
				data: "Field",
				type: "hidden",
			  },
			  {
				data: "Field",
				type: "hidden",
			  },
			  {
				data: "Field",
				type: "hidden",
			  },
			  {
				data: "Field",
				type: "hidden",
			  },
			];
			const SNP = [
			  {
				data: "Field",
				type: "hidden",
				class: `Carepack_SNP_${ucid.ID}`,
			  },
			  {
				label: "SerialNumberProductsReq",
				value: "Serial number of the products*:",
				data: "SNP",
				required: false,
				type: "textarea",
				disabled: true,
				validation: ['minLen|1'],
				class: "bolder-label",
			  },
			  {
				label: "Serial number of the products:",
				value: ucid.SerialNumberOfProducts,
				data: "SerialNumberOfProducts_" + ucid.ID,
				disabled: isDisabled,
				required: false,
				type: "textarea",
				validation: ['minLen|1'],
				class: "bordered-input",
			  },
			  {
				data: "Field",
				type: "hidden",
			  },
			  {
				data: "Field",
				type: "hidden",
			  },
			  {
				data: "Field",
				type: "hidden",
			  },
			  {
				data: "Field",
				type: "hidden",
			  },
			];
			const PPD = [
			  {
				data: "Field",
				type: "hidden",
				class: `Carepack_PPD_${ucid.ID}`,
			  },
			  {
				label: "FormPPD",
				value: "Product Purchased Date:",
				data: "PPD",
				required: false,
				type: "textarea",
				disabled: true,
				validation: ['minLen|1'],
				class: "bolder-label",
			  },
			  {
				label: "Product Purchased Date:",
				placeholder: "Form040",
				placeholder: "DD/MM/YYYY",
				value: ucid.ProductPurchasedDate,
				data: "ProductPurchasedDate_" + ucid.ID,
				required: false,
				type: "date",
				disabled: isDisabled,
				class: "bordered-input",
				dtp: {
				  format: 'd/m/Y',
				  formatDate: 'd/m/Y',
				  timepicker: false,
				  scrollInput: false,
				  minDate: new Date(new Date().setFullYear( new Date().getFullYear() - 3 )).toLocaleDateString('en-GB'),
				  maxDate: new Date().toLocaleDateString('en-GB'),
				  onChangeDateTime: function(dp, $input) {

				  }
				}
			  },
			  {
				data: "Field",
				type: "hidden",
			  },
			  {
				data: "Field",
				type: "hidden",
			  },
			  {
				data: "Field",
				type: "hidden",
			  },
			  {
				data: "Field",
				type: "hidden",
			  },
			];
			// add carepack config
			if (!config.dataset.ProductServices_Attachment || isCarePack) {
			  group.push(PPPD, SNP, PPD);
			}

			group.forEach(subgroup => {
			  subgroup.forEach((item) => {
				if (item.label) {
				  item.label = hpe.fn.lang(item.label, config.locale, config.localizations) ? hpe.fn.lang(item.label, config.locale, config.localizations) : item.label;
				}
				if (item.placeholder) item.placeholder = hpe.fn.lang(item.placeholder, config.locale, config.localizations) || item.placeholder;
			  });
			});
		  });
		}
		
		// quoteless && no upload data 
		
		if (!config.dataset.ProductServices_Attachment && config.dataset.Config_Quote !== 'Y') {
		  // add repeater 
		  const PPPD = [
			{
			  label: "FormPPPD",
			  value: "Previously Purchased Product Details:",
			  data: "PPPD",
			  required: false,
			  type: "textarea",
			  disabled: true,
			  validation: ['minLen|1'],
			  class: "bolder-label",
			},
			{
			  label: "Previously Purchased Product Details",
			  data: "PreviouslyPurchasedProductDetails",
			  required: false,
			  type: "textarea",
			  validation: ['minLen|1'],
			  class: "bordered-input",
			},
			{
			  data: "Field",
			  type: "hidden",
			},
			{
			  data: "Field",
			  type: "hidden",
			},
			{
			  data: "Field",
			  type: "hidden",
			},
			{
			  data: "Field",
			  type: "hidden",
			},
			{
			  data: "Field",
			  type: "hidden",
			  class: "ps-toggle",
			},
		  ];
		  const SNP = [
			{
			  label: "SerialNumberProductsReq",
			  value: "Serial number of the products:",
			  data: "SNP",
			  required: false,
			  type: "textarea",
			  disabled: true,
			  validation: ['minLen|1'],
			  class: "bolder-label",
			},
			{
			  label: "Serial number of the products:*",
			  data: "SerialNumberOfProducts",
			  required: false,
			  type: "textarea",
			  validation: ['minLen|1'],
			  class: "bordered-input",
			},
			{
			  data: "Field",
			  type: "hidden",
			},
			{
			  data: "Field",
			  type: "hidden",
			},
			{
			  data: "Field",
			  type: "hidden",
			},
			{
			  data: "Field",
			  type: "hidden",
			},
			{
			  data: "Field",
			  type: "hidden",
			  class: "ps-toggle",
			},
		  ];
		  const PPD = [
			{
			  label: "FormPPD",
			  value: "Product Purchased Date:",
			  data: "PPD",
			  required: false,
			  type: "textarea",
			  disabled: true,
			  validation: ['minLen|1'],
			  class: "bolder-label",
			},
			{
			  label: "Product Purchased Date:",
			  placeholder: "Form040",
			  placeholder: "DD/MM/YYYY",
			  data: "ProductPurchasedDate",
			  required: false,
			  type: "date",
			  class: "bordered-input",
			  dtp: {
				format: 'd/m/Y',
				formatDate: 'd/m/Y',
				timepicker: false,
				scrollInput: false,
				minDate: new Date(new Date().setFullYear( new Date().getFullYear() - 3 )).toLocaleDateString('en-GB'),
				maxDate: new Date().toLocaleDateString('en-GB'),
				onChangeDateTime: function(dp, $input) {

				}
			  }
			},
			{
			  data: "Field",
			  type: "hidden",
			},
			{
			  data: "Field",
			  type: "hidden",
			},
			{
			  data: "Field",
			  type: "hidden",
			},
			{
			  data: "Field",
			  type: "hidden",
			},
			{
			  data: "Field",
			  type: "hidden",
			  class: "ps-toggle",
			},
		  ];
		  let repeaterItem = [
			{
			  label: "FormHPN",
			  data: "ProductID",
			  required: true,
			  type: "text",
			  class: "bordered-input",
			  validation: ['minLen|1'],
			},
			{
			  label: "FormHPQ",
			  data: "Count",
			  required: true,
			  type: "text",
			  validation: ['minLen|1', 'isInteger'],
			  typing: "isInteger",
			  class: "bordered-input",
			},
			{
			  label: "FormDealId",
			  data: "DealId",
			  required: false,
			  type: "text",
			  class: "bordered-input",
			  validation: ['minLen|1'],
			},				
			{
			  label: "FormBIID",
			  data: "BundleID" ,
			  required: false,
			  type: "text",
			  class: "bordered-input",
			  validation: ['minLen|1'],
			},
			{
			  label: "FormUP",
			  data: "UnitNetAmount",
			  required: true,
			  type: "text",
			  class: "bordered-input",
			  validation: ["povalue", "minLen|1", "maxLen|15", "noBlanksv2"],
			  typing: "povaluetyping"
			},
			{
			  label: "FormENP",
			  data: "ExtendedNetAmount",
			  required: true,
			  disabled: true,
			  type: "text",
			  validation: ["povalue", "minLen|1", "maxLen|15", "noBlanksv2"],
			  typing: "povaluetyping",
			  class: "bordered-input-disabled",
			},
			{
			  label: "FormCP",
			  data: "Carepack",
			  required: false,
			  type: "toggle",
			  values: ["N", "Y"],
			  options: ["Carepack", "Carepack"],
			  class: "ps-toggle",
			}];
		  repeaterItem = [...repeaterItem, ...PPPD, ...SNP, ...PPD];

		  repeaterItem.forEach(item => {
			if (item.label) {
			  item.label = hpe.fn.lang(item.label, config.locale, config.localizations) ?hpe.fn.lang(item.label, config.locale, config.localizations) + " :" : item.label;
			}
		  });

		  const sumRepeat = page.structure.reduce((accumulator, currentValue) => {
			if (currentValue.id == "form-table-repeat") {
			  return accumulator + 1;
			}
			return accumulator;
		  }, 0);
		  
		  page.structure[1].group[0][0].class += " ftr-checkbox-hidden"; 
		  page.structure[1].group[0][1].class += " ftr-cell"; 
		 
		  page.structure.splice(2, sumRepeat, {
			header: "",
			repeatable: "ProductServicesRepeater",
			repeatableLimit: 4,
			repeatableDirection: "bottom",
			group: [repeaterItem],
			id: "form-table-repeat",
		  });
		}
		
		formTable.group = group;
		quoteHelper.saveProductAndServicesConfig(config);
	  }
	},
	saveProductAndServicesConfig: function(config, deletedRepeater = null) { // fix deletedRepeaterID
	  const isPPAtt = config.dataset.ProductServices_Attachment && config.dataset.Config_Quote !== "Y" && config.dataset.Config_PartialOrder == "Y";
	  const isPPQuote = config.dataset.Config_Quote == "Y" && config.dataset.Config_PartialOrder == "Y";
	  const poValueFilter = {
		logic: "or",
		filters: [
		  {
			field: "CountryCode",
			operator: "in",
			value: global.nonPoModelCountries
		  },
		  {
			logic: "and",
			filters: [
			  {
				field: "Region",
				operator: "neq",
				value: "APJ"
			  },
			  {
				field: "SubRegion",
				operator: "neq",
				value: "UKI"
			  },
			  {
				field: "Geo",
				operator: "nin",
				value: ["DACH", "Europe South", "North West Europe"]
			  }
			]
		  }
		]
	  };
	  if ((isPPAtt || isPPQuote) && quoteHelper.ucids && quoteHelper.ucids.length) {
		let PO_Value = 0;
		quoteHelper.ucids.forEach(item => {
		  item.Count = config.dataset[`Count_${item.ID}`];
		  item.Selected = config.dataset[`Selected_${item.ID}`];
		  item.UnitNetAmount = config.dataset[`UnitNetAmount_${item.ID}`];
		  item.SerialNumberOfProducts = config.dataset[`SerialNumberOfProducts_${item.ID}`];
		  item.ProductPurchasedDate = config.dataset[`ProductPurchasedDate_${item.ID}`];
		  item.PreviouslyPurchasedProductDetails = config.dataset[`PreviouslyPurchasedProductDetails_${item.ID}`];
		  item.Carepack = config.dataset[`Carepack_${item.ID}`];
		  if (item.Selected) {
			PO_Value += Math.round(item.Count * item.UnitNetAmount * 100);
		  }
		  
		  item.ExtendedNetAmount = item.Count && item.UnitNetAmount ? (Math.round(item.Count * item.UnitNetAmount * 100) / 100) : 0;
		  config.dataset[`ExtendedNetAmount_${item.ID}`] = item.ExtendedNetAmount;
		  if ($(`*[data-name="ExtendedNetAmount_${item.ID}"]`)) {
			$(`*[data-name="ExtendedNetAmount_${item.ID}"]`).val(item.ExtendedNetAmount);
		  }	  
		});
		PO_Value /= 100;
		const filter = nbsf.fn.filter(config.dataset, poValueFilter);
		if (filter) {
		  config.dataset.PO_Value = PO_Value || 0;
		  $('*[data-name="PO_Value"]').val(config.dataset.PO_Value);
		}
		config.dataset.Config_Quote_PartialOrder = JSON.stringify(quoteHelper.ucids);
	  } else {
		// quoteless && no upload data 
		let res = 0;
		$('*[data-rname="ProductServicesRepeater"]').each(function(i, elem) {
		  if (!deletedRepeater || deletedRepeater && deletedRepeater !== elem) {
			let count = Number($(elem).find('*[data-name="Count"]').val() || 0);
			let amount = Number($(elem).find('*[data-name="UnitNetAmount"]').val() || 0);
			if (isNaN(amount)) {
			  amount = 0;
			}
			if (isNaN(count)) {
			  count = 0;
			}
			if ($(elem).find('*[data-name="ExtendedNetAmount"]')) {
			  $(elem).find('*[data-name="ExtendedNetAmount"]').val((Math.round(count * amount * 100) / 100));
			}	 
			res += Math.round(count * amount * 100);
		  }
		});
		res /= 100;
		const filter = nbsf.fn.filter(config.dataset, poValueFilter);
		if (filter) {
		  config.dataset.PO_Value = res || 0;
		  $('*[data-name="PO_Value"]').val(config.dataset.PO_Value);
		}
	  }
	},
	saveProductAndServices: function(config, callback, errorCallback, forceCallback) {
	  if (config.dataset.EntryId && config.dataset.Config_PartialOrder == 'Y' && config.dataset.Config_Quote_PartialOrder && quoteHelper.ucids.length) {
		const promises = quoteHelper.ucids.map(ucid => {
		  return new Promise((resolve, reject) => {
			ucid.Request_Id = config.dataset.EntryId;
			crud.create(6020, ucid, function(data) {
			  if (typeof(data.EntryId) === "number") {
				console.log('Successfully saved to UCID', data);
				resolve(data);
			  } else {
				elog('Failed to create record in UCID');
				reject('Failed to create record in UCID');
			  }
			});
		  });
		});
		Promise.all(promises).then((results) => {
		  console.log(results);
		  if (callback) {
			callback();
		  }
		}).catch((error) => {
		  elog('Failed to delete record in UCID');
		  if (errorCallback) {
			errorCallback();
		  }
		});
	  } else {
		if (forceCallback && callback) callback();
	  }
	},
	parseProductAndServicesRepeater: function (config, callback, errorCallback) {
	  if (!config.dataset.ProductServices_Attachment && config.dataset.Config_Quote !== 'Y' && config.dataset.ProductServicesRepeater) {
		try {
		  const ucids = [];
		  const data = JSON.parse(config.dataset.ProductServicesRepeater);
		  if (data && data.length) {
			data.forEach(item => {
			  if (item.Carepack !== 'Y') {
				item.PreviouslyPurchasedProductDetails = null;
				item.SerialNumberOfProducts = null;
				item.ProductPurchasedDate = null;
			  }
			  item.Selected = 'Y';
			  ucids.push({
				Request_Id: config.dataset.EntryId,
				Requestor_PO_Quote_ID: config.dataset.Requestor_PO_Quote_ID,
				ProductID: item.ProductID,
				BundleID: item.BundleID,
				Selected: item.Selected,
				DealId: item.DealId,	
				UCID: "",	
				UnitNetAmount: item.UnitNetAmount,
				ExtendedNetAmount: (item.Count || 0) * item.UnitNetAmount,
				Quantity: "",
				CfgSystemId: "",
				CfgSystemName: "",
				Count: item.Count,
				ProductClassificationCode: "",
				LineType: "Config",
				ID: item.ProductID && item.ProductID.replace(/[\-]/g, '_') || '',
				PreviouslyPurchasedProductDetails: item.PreviouslyPurchasedProductDetails,
				SerialNumberOfProducts: item.SerialNumberOfProducts,
				ProductPurchasedDate: item.ProductPurchasedDate,
			  });
			});
			quoteHelper.ucids = ucids;
			config.dataset.Config_Quote_PartialOrder = JSON.stringify(quoteHelper.ucids);
			config.dataset.ProductServicesRepeater = JSON.stringify(data);
		  }
		  if (callback) {
		  	callback(ucids);
		  }
		} catch(e) {
		  if (errorCallback) {
			errorCallback(e);
		  }
		}
	  }
	},
	onCloneProductAndServices: function(config, clone) {
	  if (clone.querySelectorAll("label.wrapper.toggle .toggle").length > 0) {
		var toggles = clone.querySelectorAll("label.wrapper.ps-toggle.toggle .toggle");
		const initCarepackConfig = function(node) {
		  var parent;
		  if (node.nodeName.toLowerCase() == "span")
			parent = node.parentNode.parentNode.parentNode.parentNode;
		  else
			parent = node.parentNode.parentNode.parentNode;

		  var values = parent.querySelector(".fmmcosmin .toggle").getAttribute("data-values").split(",");

		  var target = parent.querySelector(".fmmcosmin label");

		  var isInactive = target.getAttribute("class") == null || target.getAttribute("class") == "";
		  const fieldset = target.closest('fieldset');
		  const wrappers = fieldset.querySelectorAll('label.wrapper');
		  for (j = 0; j < wrappers.length; j++) {
			if (j > 6) {
			  if (isInactive) {
				$(wrappers[j]).addClass('ps-hidden');
			  } else {
				$(wrappers[j]).removeClass('ps-hidden');
			  }
			}
		  }
		}
		
		for (i = 0; i < toggles.length; i++) {
		  // initial state
		  initCarepackConfig( toggles[i]);

		  // click listener
		  toggles[i].addEventListener("click", function(e) {
			initCarepackConfig(e.target);
		  });
		}
	  }
	},
	onDeCloneProductAndServices: function(config, clone) {
	  // PRODUCT AND SERVICES MODULE
	  if (config.pages[config.page].id === 'PS') {
		quoteHelper.saveProductAndServicesConfig(config, clone);
	  }
	},
	onInitProductAndServices: function(config) {
	  if (document.querySelectorAll("label.wrapper.toggle .toggle").length > 0) {
		var toggles = document.querySelectorAll("label.wrapper.ps-toggle.toggle .toggle");
		for (i = 0; i < toggles.length; i++) {

		  const initCarepackConfig = function(node) {
			var parent;
			if (node.nodeName.toLowerCase() == "span")
			  parent = node.parentNode.parentNode.parentNode.parentNode;
			else
			  parent = node.parentNode.parentNode.parentNode;

			var values = parent.querySelector(".fmmcosmin .toggle").getAttribute("data-values").split(",");

			var target = parent.querySelector(".fmmcosmin label");

			var isInactive = target.getAttribute("class") == null || target.getAttribute("class") == "";
			const fieldset = target.closest('fieldset');
			const wrappers = fieldset.querySelectorAll('label.wrapper');
			for (j = 0; j < wrappers.length; j++) {
			  if (j > 6) {
				if (isInactive) {
				  $(wrappers[j]).addClass('ps-hidden');
				} else {
				  $(wrappers[j]).removeClass('ps-hidden');
				}
			  }
			}
		  }
				  
		  if (i == 0) {
			toggles[0].addEventListener("click", function(e) {
			  initCarepackConfig(e.target);
			});
		  }
		  
		  const fieldset = toggles[i].closest('fieldset');
		  const label = toggles[i].closest('label');
		  var isInactive = label.getAttribute("class") == null || label.getAttribute("class") == "";
		  const wrappers = fieldset.querySelectorAll('label.wrapper');
		  for (j = 0; j < wrappers.length; j++) {
			if (j > 6) {
			  if (isInactive) {
				$(wrappers[j]).addClass('ps-hidden');
			  } else {
				$(wrappers[j]).removeClass('ps-hidden');
			  }
			}
		  }
		}
	  }
	},
	onInitQuoteCarepackProductAndServices: function(config) {
	  if (config.dataset.Config_Quote == "Y" && quoteHelper.ucids) {
		quoteHelper.ucids.forEach(ucid => {
		  const toggle = document.querySelector(`#form-table .carepack_toggle.ID_${ucid.ID} .toggle`);
		  const label = toggle.closest('label');
		  const wrapper = toggle.closest('label.wrapper');
		  $(wrapper).attr('id', ucid.ID);
		  const isInactive = label.getAttribute("class") == null || label.getAttribute("class") == "";
		  const pppd = $(`#form-table .Carepack_PPPD_${ucid.ID}`).closest('fieldset');
		  const snp = $(`#form-table .Carepack_SNP_${ucid.ID}`).closest('fieldset');
		  const ppd = $(`#form-table .Carepack_PPD_${ucid.ID}`).closest('fieldset');
		  if (isInactive) {
			$(pppd).hide();
			$(snp).hide();
			$(ppd).hide();
		  }
		  $(toggle).on("click", function() {
			const wrapper = $(this).closest('label.wrapper');
			const id = $(wrapper).attr("id");
			const pppd = $(`#form-table .Carepack_PPPD_${id}`).closest('fieldset');
			const snp = $(`#form-table .Carepack_SNP_${id}`).closest('fieldset');
			const ppd = $(`#form-table .Carepack_PPD_${id}`).closest('fieldset');
			$(pppd).toggle();
			$(snp).toggle();
			$(ppd).toggle();
		  });
		});
	  }
	},
	clearPOData: function(config) {
	  const sections = ['SoldTo', 'Payer', 'BillTo', 'ShipTo', 'Reseller', 'EndCx'];
	  sections.forEach(section => {
		if (config.dataset[`Config_${section}Details`] == 'Y') {
		  quoteHelper.clearAddressData(config, section, 'address');
		}
		if (config.dataset[`Config_${section}Details_Contact`] == 'Y') {
		  quoteHelper.clearAddressData(config, section, 'contact');
		}
	  });
	},
  };

  const helper = {
	buildFastClearAddressButton: function(section = 'SoldTo', isReviewPage = false) {
	  const fastClearAddress = function() {
		const fields = ['CompanyName', 'PartyId', 'Address', 'Address_Street', 'Address_Street2', 'Address_City', 'Address_State', 'Address_Postal', 'Address_Country'];
		fields.forEach((field) => {
		  const node = document.querySelector('*[data-name="' + section + '_' + field + '"]');
		  if (node) {
			const isDisabled = $(node).attr('disabled');
			if (!isDisabled) {
			  $(node).val('');
			}
		  }
		});
		nbsf.ev.global(config, false);
	  };
	  const sectionPartyId = document.querySelector('input[data-name="' + section + '_PartyId"]');
	  if (sectionPartyId) {
		const row = document.querySelector('input[data-name="' + section + '_PartyId"]').closest('.row');
		const heading = $(row).find('.heading');
		if (heading && !isReviewPage) {
		  $(heading).append(`<svg class="${section} clear-option" viewBox="0 0 24 24" role="img" aria-label="trash" width="24px" height="24px">
<path fill="none" stroke="#666" stroke-width="2" d="M4,5 L20,5 L20,23 L4,23 L4,5 Z M1,5 L23,5 M9,1 L15,1 L15,5 L9,5 L9,1 Z M9,1 L15,1 L15,5 L9,5 L9,1 Z M15,9 L15,19 M9,9 L9,19">
  </path>
  </svg>`);
		}
		$(`.${section}.clear-option`).click(function() {
		  fastClearAddress();
		});
	  }
	},
	parseUcidsDataFromExcel: function(config, file, callback) {
	  var reader = new FileReader();
	  const res = {
		success: false,
		data: null,
	  };
	  reader.onload = function (e) {
		var data = e.target.result;
		var workbook = XLSX.read(data, {
		  type: 'binary',
		  cellDates: true,
		});

		const sheetName = workbook.SheetNames[0];
		const page = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[sheetName]);

		let rowsData = [];
		if (page.length >= 6) {
		  const header = page[5];
		  const headerMap = new Map();
		  Object.entries(header).forEach(([key, value], index) => {
			if (value.includes("HPE Part Number")) {
			  headerMap.set("ProductID", key);
			}
			if (value.includes("HPE Part Quantity")) {
			  headerMap.set("Count", key);
			}
			if (value.includes("Deal ID")) {
			  headerMap.set("DealId", key);
			}
			if (value.includes("Config ID")) {
			  headerMap.set("BundleID", key);
			}
			if (value.includes("Unit Price")) {
			  headerMap.set("UnitNetAmount", key);
			}
			if (value.includes("Extended Net Price")) {
			  headerMap.set("ExtendedNetAmount", key);
			}
			if (value.includes("Previously Purchased Product Details")) {
			  headerMap.set("PreviouslyPurchasedProductDetails", key);
			}
			if (value.includes("Serial number of the products")) {
			  headerMap.set("SerialNumberOfProducts", key);
			}
			if (value.includes("Product Purchased Date")) {
			  headerMap.set("ProductPurchasedDate", key);
			}
			if (value.includes("HPE Part Description")) {
			  headerMap.set("HPEPartDescription", key);
			}
		  });

		  for (let i = 6; i < page.length; i++) {
			const rowInfo = page[i];
			const productID = (headerMap.get("ProductID") && rowInfo[headerMap.get("ProductID")]) ?? "";
			const count = (headerMap.get("Count") && rowInfo[headerMap.get("Count")]) ?? "";
			const unitNetAmount = (headerMap.get("UnitNetAmount") && rowInfo[headerMap.get("UnitNetAmount")]) ?? "";
			// if ProductID or Quantity or UnitNetAmount doesn't exist
			if (productID === "" || count === "" || unitNetAmount === "") {
			  break;
			}
			let productPurchasedDate = null;
			const ppd = headerMap.get("ProductPurchasedDate") && rowInfo[headerMap.get("ProductPurchasedDate")] || null;
			if (ppd && ppd.toLocaleDateString) {
			  try {
				productPurchasedDate = ppd.toLocaleDateString('en-GB');
			  } catch (e) {
			  }
			} else {
			  productPurchasedDate = ppd;
			}
			const row = {
			  Request_Id: config.dataset.EntryId,
			  Requestor_PO_Quote_ID: config.dataset.Requestor_PO_Quote_ID,
			  UCID: "",
			  BundleID: headerMap.get("BundleID") && rowInfo[headerMap.get("BundleID")] || "", //Config ID
			  DealId: headerMap.get("DealId") && rowInfo[headerMap.get("DealId")] || "",
			  UnitNetAmount: unitNetAmount,
			  ExtendedNetAmount: headerMap.get("ExtendedNetAmount") && rowInfo[headerMap.get("ExtendedNetAmount")] || "",
			  Quantity: "",
			  CfgSystemId: "",
			  CfgSystemName: "",
			  Selected: "Y",
			  Count: count,
			  ProductID: productID,
			  ProductClassificationCode: "",
			  LineType: "Config",
			  ID: (productID + "").replace(/[\-]/g, '_'),
			  PreviouslyPurchasedProductDetails: headerMap.get("PreviouslyPurchasedProductDetails") && rowInfo[headerMap.get("PreviouslyPurchasedProductDetails")] || "",
			  SerialNumberOfProducts: headerMap.get("SerialNumberOfProducts") && rowInfo[headerMap.get("SerialNumberOfProducts")] || "",
			  ProductPurchasedDate: productPurchasedDate || "",
			  HPEPartDescription: headerMap.get("HPEPartDescription") && rowInfo[headerMap.get("HPEPartDescription")] || "",
			};
			rowsData.push(row);
		  }
		}

		res.success = true;
		res.data = rowsData;
		quoteHelper.ucids = rowsData;
		quoteHelper.maxQuantity = null;
		callback(res);
	  };
	  reader.onerror = function (ex) {
		res.data = ex;
		callback(res)
	  };
	  reader.readAsBinaryString(file);
	}, 
  }
</script>

<!-- Main application code
<script src="https://hpe-rfb.it.hpe.com/resources/rs/custom/nor/utils.js"> -->
<script>
  const oob = {
	init: function() {
	  mo.fn.overlay.show({
		loading: true,
		close: false
	  });
	  otherFunctions.lang();

	  function getAllLocalizations() {
		if (Object.keys(config.localizations).length > 0) {
		  
		  if (global.error) {
			mo.fn.modal.show({
			  ctaLabel: hpe.fn.lang('OK', config.locale, config.localizations),
			  title: hpe.fn.lang(global.error, config.locale, config.localizations),
			  content: '',
			  ctaCallback: function() {
				mo.fn.overlay.hide();
				mo.fn.events.closeAll();
			  }
			});
			clearInterval(localiz);
			return;
		  }

		  oob.ui();
		  // GET AGREEMENTS FROM ICM
		  config.dataset.currentUser = '[SSOData.Email]';
		  if (!global.data.user.internal) {
			mo.fn.overlay.show({
			  loading: true,
			  close: false
			});
			request.agreements(global.data, function(data) {
			  console.log('222');
			  if (data) {
				reference.agreements = data;
				mo.fn.overlay.hide();
			  } else {
				// check if exception/demo account
				hpe.api.dataset({
				  form: '1585',
				  dataset: 'Reference_DemoAccounts',
				  payload: {
					filter: {
					  logic: "and",
					  filters: [{
						field: 'PartyId',
						operator: 'eq',
						value: global.data.company.party
					  },
								{
								  field: 'BRT',
								  operator: 'eq',
								  value: global.data.company.brt.brTypeName
								}
							   ]
					},
					skip: '0',
					pageSize: '1',
					take: '1'
				  }
				}, function(d) {
				  if (typeof(d) === 'object' && d.Success && d.Data.length == 1) {
					reference.agreements = [];
				  }
				  return mo.fn.overlay.hide();
				})
			  }
			  global.data.brt.pas = [];
			  reference.agreements.forEach(function(agreement) {
				global.data.brt.pas.push(agreement.iCMPANumber);
			  });
			  let chnls = global.data.brts.filter(function(item) {
				return (item.code == global.data.brt.code && item.name == global.data.brt.name)
			  });
			  if (chnls.length > 0)
				chnls = chnls[0].channel;
			  global.data.brt.channel = chnls;
			  reference.countriesRequest();

			  loadPreferences().then(() => {
				crud.q.stop(function() {
				  if (global.data.company.party) {
					mo.fn.overlay.show({
					  loading: true,
					  close: false
					});
					hpe.data.xref(global.data.company.party, function(d) {
					  mo.fn.overlay.hide();
					  if (d.status == 'SUCCESS') {
						global.data.company.party = d.party[0].currentPartyID || d.party[0].submittedPartyID;
						//d.party[0].countryCode = 'IN'; //CFI
						//d.party[0].countryName = 'India'; //CFI
						reference.xref = d;
						config.locale = global.data.user.locale;
						config.dom = document.querySelector('div[tab-id="oob"]');
						nbsf.init(config, 0);
						nbsf.init(config, 0);
						//mo.fn.overlay.hide()
					  } else {
						//console.log('err');
						mo.fn.modal.show({
						  ctaLabel: hpe.fn.lang('OK', config.locale, config.localizations),
						  title: hpe.fn.lang("ErrorGeneric", config.locale, config.localizations),
						  content: '',
						  ctaCallback: function() {
							mo.fn.overlay.hide();
							mo.fn.events.closeAll();
						  }
						});
					  }
					})
				  } else {
					document.querySelector('span[tab-id="oob"]').innerText = hpe.fn.lang('Form069', config.locale, config.localizations)
					if (document.querySelector('span[tab-id="requests"]'))
					  document.querySelector('span[tab-id="requests"]').innerText = hpe.fn.lang('Form072', config.locale, config.localizations)
					config.dom = document.querySelector('div[tab-id="oob"]');
					nbsf.init(config, 0);
					nbsf.init(config, 0);
					//mo.fn.overlay.hide()
				  }
				});
			  });
			});
		  } else {
			crud.q.stop(function() {
			  config.locale = global.data.user.locale;
			  config.dom = document.querySelector('div[tab-id="oob"]');
			  nbsf.init(config, 0);
			  nbsf.init(config, 0);
			  //mo.fn.overlay.hide()
			});
		  }

		  clearInterval(localiz);
		}
	  }
	  const localiz = setInterval(getAllLocalizations, 1000);
	},
	//function that initiates UI
	ui: function() {
	  //generating the app tabs
	  crud.q.stop(function() {
		hpe.ui.tabs({
		  dom: document.querySelector("section.wrapper"),
		  tabs: [{
			label: hpe.fn.lang('Form069', config.locale, config.localizations),
			id: "oob"
		  },
				 {
				   label: hpe.fn.lang('Form072', config.locale, config.localizations),
				   id: "requests"
				 },
				 {
				   label: "",
				   id: "otherIcons"
				 }
				]
		},
					function(all) {
		  // define dom selectors for tabs
		  $('span[tab-id="otherIcons"]').append('<svg class="add" style="padding: 2px 10px;" version="1.1" viewBox="0 0 24 24" role="img" aria-label="add" width="20px" height="20px"><path fill="none" stroke="#111" stroke-width="2" d="M12,22 L12,2 M2,12 L22,12"></path></svg>' +
												'<svg class="refresh" style="padding: 0px 10px;" version="1.1" viewBox="0 0 24 24" role="img" aria-label="form-refresh" width="24px" height="24px"><path fill="none" stroke="#333" stroke-width="2" d="M17.3333333,9.33333333 C16.3982691,7.36020781 14.3579813,6 12,6 C8.6862915,6 6,8.6862915 6,12 C6,15.3137085 8.6862915,18 12,18 C15.3137085,18 18,15.3137085 18,12 M18.5,6 L18.5,10 L14.5,10"></path></svg>');

		  $('span[tab-id="otherIcons"] *').click(function() {
			return false;
		  });

		  function setTilesTabs() {
			document.querySelector('.tabs span[tab-id="oob"]').innerText = hpe.fn.lang('Form069', config.locale, config.localizations);
			document.querySelector('.tabs span[tab-id="requests"]').innerText = hpe.fn.lang('Form072', config.locale, config.localizations);

			if (Object.keys(config.localizations).length > 0) {
			  clearInterval(tabTiles);
			}
		  }
		  const tabTiles = setInterval(setTilesTabs, 1000);

		  /*if (config.dataset.currentUser.indexOf('@hpe.com') > -1) {
                              $('span[tab-id="requests"]').hide();
                              $('span[tab-id="oob"]').hide();
                          }*/
		  $('span[tab-id="otherIcons"] > svg.add').click(function() {
			config.dataset = {};
			nbsf.init(config, 0);
			nbsf.init(config, 0);
			$('.tabs span[tab-id="oob"]').click();
		  });
		  $('span[tab-id="otherIcons"] > svg.refresh').click(function() {
			config.dataset = {};
			nbsf.init(config, 0);
			nbsf.init(config, 0);
			$('[tab-id=requests] .grid').data('kendoGrid').dataSource.read();
		  });

		  $('span[tab-id="requests"]').click(function() {
			oob.grid.load();
		  });
		  crud.q.stop(function() {
			let placeholderTranslation = hpe.fn.lang('SearchOrder', config.locale, config.localizations);
			$('div[tab-id="requests"]').append('<div id="overview"></div>' +
											   '<div class="search"><input type="text" placeholder="' + placeholderTranslation + '"><span><img src="https://cdn1.prp-dxp.it.hpe.com/o/prp-theme/images/icons/search.svg"></span></div>' +
											   '<div class="grid"></div>');
			document.querySelector(".search input").addEventListener('input', oob.grid._events._search);
			oob.grid.load();
		  })
		  document.querySelector('div[tab-id="oob"]').addEventListener("change", (e) => {
			if (e.target.getAttribute("data-name") == "PA_Number") paNumberChanged(e.target.value);
		  });

		  function visitItems(cb) {
			for (let a=0; a<config.pages.length; a++) {
			  for (b = 0; b < config.pages[a].structure.length; b++) {
				for (l = 0; l < config.pages[a].structure[b].group.length; l++) {
				  for (k = 0; k < config.pages[a].structure[b].group[l].length; k++) {
					cb(config.pages[a].structure[b].group[l][k]);
				  }
				}
			  }
			}
		  }

		  // Change "required" property on Email, Last Name and Country when corresponding First Name changed
		  document.querySelector('div[tab-id="oob"]').addEventListener("change", (e) => {
			const fieldName = e.target.getAttribute("data-name");
			if (!["Payer_Contact_FirstName", "BillTo_Contact_FirstName", "ShipTo_Contact_FirstName"].includes(fieldName)) return;

			const currVal = e.target.value;
			const required = !!currVal;

			config.dataset[fieldName] = currVal;
			const fieldPrefix = fieldName.split("_")[0];
			const fieldsToSwitch = [fieldPrefix + "_Contact_Email", fieldPrefix + "_Contact_Country", fieldPrefix + "_Contact_LastName"];
			let prevRequired = null;

			visitItems((item) => {
			  if (fieldsToSwitch.includes(item.data)) {
				if (prevRequired === null) prevRequired = item.required;
				item.required = required;
			  }
			});

			if (prevRequired !== required) {
			  // Fill Contact Country from Address Country if it was empty and became mandatory
			  if (required) {
				const country = config.dataset[fieldPrefix + "_Address_Country"];
				const prevCountry = config.dataset[fieldPrefix + "_Contact_Country"];
				if (!prevCountry || prevCountry == config.pages[config.page].selectone) {
				  config.dataset[fieldPrefix + "_Contact_Country"] = country;
				  if (config.reviewDataset && Object.keys(config.reviewDataset).length) config.reviewDataset[fieldPrefix + "_Contact_Country"] = country;
				}
			  }
			  // for Review pages nbsf.init(config, config.page) is executed after this event
			  if (!config.pages[config.page].review) nbsf.init(config, config.page);
			}
		  }, true);
		});
	  });
	},
	//function that initiate kendo grid
	grid: {
	  filterValue: "User",
	  load: function() {
		mo.fn.overlay.show({
		  loading: true,
		  close: false
		});
		const grid = $('div[tab-id="requests"] .grid');
		if (grid && grid.data("kendoGrid")) {
		  grid.data("kendoGrid").destroy();
		}
		$('div[tab-id="requests"] .grid').kendoGrid({
		  dataSource: oob.grid._datasource(),
		  selectable: "row",
		  pageable: {
			pageSize: 10
		  },
		  filterable: true,
		  scrollable: false,
		  columns: oob.grid._columns(),
		  noRecords: {
			template: "<center style='padding: 20px;font-size: 25px;'>No <b>Order Request</b> submissions.</center>"
		  },
		  filter: function(e) {
			if (e.filter) {
			  const status = e.filter.filters.find((filter) => filter.field === 'Status');
			  oob.grid._appStats.status = status && status.value || "";

			  const submittedTimestampFilter = e.filter.filters.find((filter) => filter.field === "SubmittedTimestamp");
			  if (submittedTimestampFilter) {
				var date = new Date(submittedTimestampFilter.value);
				var timezoneOffsetInHours = date.getTimezoneOffset() / 60;
				date.setHours(date.getHours() - timezoneOffsetInHours);
				submittedTimestampFilter.value = date;
			  } else {
				// Handle the scenario where the SubmittedTimestamp filter is cleared
				this.dataSource.read();
			  }
			}
		  },
		  toolbar: [{
			template: '<div id="filter-type-dropdown" style="width: 200px;"></div>'
		  }],
		});

		oob.grid.initializeDropDown();

		// add grid events
		oob.grid._events.init('div[tab-id="requests"] .grid');
		oob.grid._overview();
	  },
	  initializeDropDown: function() {
		var isHpeEmail = '[SSOData.Email]'.indexOf('@hpe.com') > -1;
		$("#filter-type-dropdown").kendoDropDownList({
		  dataSource: ["User", "Company"],
		  value: oob.grid.filterValue,
		  enable: !isHpeEmail,
		  change: function() {
			oob.grid.filterValue = this.value();
			var grid = $('div[tab-id="requests"] .grid').data("kendoGrid");

			// Create filter logic based on dropdown selection
			var filter = {
			  logic: "and",
			  filters: [{
				field: "PartyId",
				operator: "eq",
				value: global.data.company.party
			  },
						{
						  field: "PartnerBRT",
						  operator: "eq",
						  value: global.data.brt.name
						},
						{
						  logic: "or",
						  filters: [{
							field: "Retired",
							operator: "neq",
							value: "Y"
						  },
									{
									  field: "Retired",
									  operator: "isnull",
									  value: ""
									}
								   ]
						}
					   ]
			};

			if (oob.grid.filterValue === "User") {
			  filter.filters.push({
				field: "Requestor_Email",
				operator: "eq",
				value: '[SSOData.Email]' // Replace with the actual email variable
			  });
			  // stats user
			  overview.querySelector(".incomplete strong").innerText = global.requests.userDraft;
			  overview.querySelector(".pending strong").innerText = global.requests.userInprogress;
			  overview.querySelector(".completed strong").innerText = global.requests.userCompleted;
			  overview.querySelector(".cancelled strong").innerText = global.requests.userCancelled;
			} else {
			  // stats company
			  overview.querySelector(".incomplete strong").innerText = global.requests.companyDraft;
			  overview.querySelector(".pending strong").innerText = global.requests.companyInprogress;
			  overview.querySelector(".completed strong").innerText = global.requests.companyCompleted;
			  overview.querySelector(".cancelled strong").innerText = global.requests.companyCancelled;
			}

			// Update the filterable property of columns
			var options = $.extend(true, {}, grid.getOptions());
			options.columns = options.columns.map(function(column) {
			  if (column.field === "Requestor_Email") {
				column.filterable = oob.grid.filterValue === "Company";
			  }
			  return column;
			});

			// Apply the updated options and filter to the grid
			grid.setOptions(options);
			grid.dataSource.filter(filter);

			// Refresh the grid to apply changes
			grid.dataSource.read();

			// Reinitialize the dropdown
			oob.grid.initializeDropDown();
		  }
		});
	  },
	  _datasource: function() {
		return new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: "/form/data-set-provider/v2/989/NOR_Overview/kendo/data/search", // todo: add a new setting
			  type: "POST"
			}
		  },
		  serverPaging: true,
		  page: 1,
		  pageSize: 10,
		  serverFiltering: true,
		  filter: oob.grid._filter(),
		  serverSorting: true,
		  sort: {
			field: "Modified",
			dir: "desc"
		  },
		  schema: {
			model: {
			  fields: {
				SubmittedTimestamp: {
				  type: "date"
				}
			  }
			}
		  },
		});
	  },
	  _columns: function() {
		// add default columns
		var all = [{
		  field: "EntryId",
		  title: hpe.fn.lang('ID', config.locale, config.localizations),
		  width: "60px",
		  filterable: false
		},

				   {
					 field: "PO_Number",
					 filterable: false,
					 title: hpe.fn.lang('PO', config.locale, config.localizations),
					 width: "100px",
					 template: function(d) {
					   const el = "";
					   if (d.SubmittedTimestamp && d.PDF && d.PO_Number) {
						 let pdfUrl = `https://hpe-rfb.it.hpe.com/form/989/attachments/${d.EntryId}/PDF?downloadFileName=${encodeURIComponent(d.PO_Number)}.pdf`;
						 const url = `<a style="color: blue;text-decoration: underline;" href="${pdfUrl}" target="_blank">` + d.PO_Number + '</a>';
						 return url;
					   }
					   return d.PO_Number;
					 },
				   },
				   {
					 field: "PartyId",
					 filterable: false,
					 hidden: true,
					 title: hpe.fn.lang('PartyId', config.locale, config.localizations),
					 width: "100px"
				   },
				   {
					 field: "PO_Order_ID",
					 title: hpe.fn.lang('HPEOrder', config.locale, config.localizations),
					 filterable: false,
					 template: function(d) {
					   var elem = '<div class="orderList" style="text-align: left">';
					   if (d.PO_Order_ID != "" && d.PO_Order_ID != "N/A" && d.PO_Order_ID != null) {
						 if (d.PO_Order_ID && d.PO_Order_ID.length > 10) {
						   let orderIds = d.PO_Order_ID.trim();
						//   console.log(orderIds);
						   if (orderIds.includes(';')) {
							 orderIds = orderIds.split(';');
						   } else {
							 orderIds = orderIds.split('  ');
						   }
						   //const orderIds = d.Operations.Order
						//   console.log(orderIds);
						   orderIds.forEach(orderId => {
						//	 elem += '<span class="orderItem" title="' + orderId + '"> ' + orderId + '</span>';
						//	 console.log(elem);
							 if (orderId) {
							   elem += '<a href="https://partner.hpe.com/group/prp/orders?p_p_id=OrderStatusWeb&status=All%20Orders&OrderStatus=All%20Orders&SearchText=' + orderId + '" target="_blank">' + orderId + '</a><br>';
							 }
						   });
						 } else {
						  // elem += '<span class="orderItem" title="' + d.PO_Order_ID.trim() + '"> ' + d.PO_Order_ID.trim() + '</span>';
						   elem += '<a href="https://partner.hpe.com/group/prp/orders?p_p_id=OrderStatusWeb&status=All%20Orders&OrderStatus=All%20Orders&SearchText=' + d.PO_Order_ID.trim() + '" target="_blank">' + d.PO_Order_ID.trim() + '</a><br>';
						 }
					   }
					   if (d.PO_AAS_ID != "" && d.PO_AAS_ID != "N/A" && d.PO_AAS_ID != null) {
						 if (d.PO_AAS_ID && d.PO_AAS_ID.length > 8) {
						   let aasIds = d.PO_AAS_ID.trim();
						   if (aasIds.includes(';')) {
							 aasIds = aasIds.split(';');
						   } else {
							 aasIds = aasIds.split('  ');
						   }
						//   console.log(aasIds);
						   aasIds.forEach(aasId => {
							// elem += '<span class="orderItem" title="' + aasId + '"> ' + aasId + '</span>';
						//	 console.log(elem);
							 if (aasId) {
							   elem += '<a href="https://partner.hpe.com/group/prp/orders?p_p_id=OrderStatusWeb&status=All%20Orders&OrderStatus=All%20Orders&SearchText=' + aasId + '" target="_blank">' + aasId + '</a><br>';
							 }
						   });
						 } else {
						 //  elem += '<span class="orderItem" title="' + d.PO_AAS_ID.trim() + '"> ' + d.PO_AAS_ID.trim() + '</span>';
						   elem += '<a href="https://partner.hpe.com/group/prp/orders?p_p_id=OrderStatusWeb&status=All%20Orders&OrderStatus=All%20Orders&SearchText=' + d.PO_AAS_ID.trim() + '" target="_blank">' + d.PO_AAS_ID.trim() + '</a>';
						 }
					   }
					   elem += '</div>';

					   if (elem == "") {
						 elem = "N/A";
					   }
					//   console.log(elem);
					   return elem;
					 },
					 width: "100px"
				   },
				/*   {
					 field: "Requestor_Email",
					 title: hpe.fn.lang('Submitter', config.locale, config.localizations),
					 width: "160px",
					 filterable: {
					   extra: false
					 },
					 filterable: false
				   },*/
				   {
					 field: "Requestor_Email",
					 title: hpe.fn.lang('Submitter', config.locale, config.localizations),
					 hidden: true,
					 filterable: false,
					 width: "80px",
					 template: function(d) {
					   try {
						 if (d.Requestor_Email.indexOf("@") > -1)
						   elem = '<div title="' + d.Requestor_Email + '"> <a href="mailto:' + d.Requestor_Email + '">email</a></div>';
						 else
						   elem = '<div title="' + d.Requestor_Email + '"> <a href="mailto:' + d.Requestor_Email + '">email</a></div>';
						 return elem;
					   } catch (err) {
						 console.error(err);
						 return "err";
					   }
					 }
				   },

				   {
					 field: "SuccessResult",
					 title: hpe.fn.lang('Form44x1', config.locale, config.localizations),
					 width: "100px",
					 filterable: false,
					 template: function(d) {
					   if (d.SuccessResult) {
						 try {
						   if (JSON.parse(d.SuccessResult).CaseNumber != undefined)
							 return JSON.parse(d.SuccessResult).CaseNumber
						   else return "N/A";
						 } catch (err) {
						   console.error(err);
						   return "N/A";
						 }
					   } else return "N/A";
					 }
				   },

				   {
					 field: "SubmittedTimestamp",
					 title: hpe.fn.lang('Form44x2', config.locale, config.localizations),
					 width: "100px",
					 filterable: {
					   cell: {
						 template: function(d) {
						   return util.getDateFormat(new Date(d.SubmittedTimestamp));
						 }
					   }
					 },
					 format: "{0:yyyy-MM-dd}",
					 filterable: true,
					 template: function(d) {
					   if (d.SubmittedTimestamp) {
						 //let tmstmp = d.SubmittedTimestamp.split('T')[0] + " " + d.SubmittedTimestamp.split('T')[1]
						 return kendo.toString(new Date(d.SubmittedTimestamp), 'yyyy-MM-dd');
						 //return tmstmp;
					   } else return hpe.fn.lang('Form44x3', config.locale, config.localizations);
					 }
				   },
				   {
					 field: "Status",
					 title: hpe.fn.lang('Status', config.locale, config.localizations),
					 width: "90px",
					 filterable: {
					   ui: function(element) {
						 const dataSourceConfig = {
						   dataSource: [{
							 text: hpe.fn.lang('Form211', config.locale, config.localizations),
							 value: "0"
						   },
										{
										  text: hpe.fn.lang('Form212', config.locale, config.localizations),
										  value: "1"
										},
										/*    {
                                                text: hpe.fn.lang('Pending', config.locale, config.localizations),
                                                value: "2"
                                            },*/
										{
										  text: hpe.fn.lang('Completed', config.locale, config.localizations),
										  value: "3"
										},
										/*     {
                                                 text: hpe.fn.lang('Failed', config.locale, config.localizations),
                                                 value: "4"
                                             },*/
										{
										  text: hpe.fn.lang('Form513', config.locale, config.localizations),
										  value: "5"
										},
									   ],
						   dataTextField: "text",
						   dataValueField: "value",
						   filter: [],
						 };
						 element.kendoComboBox({
						   ...dataSourceConfig,
						   filter: "contains",
						 });
					   }
					 },
					 template: function(d) {
					   if (d.Status == "1" || d.Status == "2") elem = '<div class="status" title="' + hpe.fn.lang('SubmittedPOProcessed01', config.locale, config.localizations) + '"> ' + hpe.fn.lang('Form212', config.locale, config.localizations) + '</div>';
					   else if (d.Status == "3") elem = '<div class="status" title="' + hpe.fn.lang('OrderCreated', config.locale, config.localizations) + '">' + hpe.fn.lang('Completed', config.locale, config.localizations) + '</div>';
					   else if (d.Status == "4") elem = '<div class="status" title="' + hpe.fn.lang('ReviewPO', config.locale, config.localizations) + '"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18px" height="16px" viewBox="0 0 22 20" version="1.1"><g id="Orders-v2" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Order-Home-7-Days" transform="translate(-783.000000, -528.000000)"><g id="Order-table" transform="translate(168.000000, 120.000000)"><g id="Table" transform="translate(24.000000, 202.000000)"><g id="Table-Rows" transform="translate(1.000000, 48.000000)"><g id="Row4" transform="translate(13.000000, 144.000000)"><g id="Table/Cell-Copy-17" transform="translate(564.000000, 0.000000)"><g id="Icon/Functional/Inactive" transform="translate(12.000000, 12.000000)"><g id="Status-Icon---Warning"><rect id="viewBox" x="0" y="0" width="24" height="24"/><polygon id="Shape" stroke="#FFE75E" stroke-width="2" fill="#FFE75E" stroke-linejoin="round" points="12 3 22 21 2 21"/><path d="M12,9 L12,15 M12,16 L12,18" id="!" stroke="#333333" stroke-width="2" stroke-linejoin="round"/></g></g></g></g></g></g></g></g></g></svg> ' + hpe.fn.lang('Form212', config.locale, config.localizations) + '</div>';
					   else if (d.Status == "5") elem = '<div class="status" title="' + hpe.fn.lang('Form513', config.locale, config.localizations) + '"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18px" height="16px" viewBox="0 0 22 20" version="1.1"><g id="Orders-v2" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Order-Home-7-Days" transform="translate(-783.000000, -528.000000)"><g id="Order-table" transform="translate(168.000000, 120.000000)"><g id="Table" transform="translate(24.000000, 202.000000)"><g id="Table-Rows" transform="translate(1.000000, 48.000000)"><g id="Row4" transform="translate(13.000000, 144.000000)"><g id="Table/Cell-Copy-17" transform="translate(564.000000, 0.000000)"><g id="Icon/Functional/Inactive" transform="translate(12.000000, 12.000000)"><g id="Status-Icon---Warning"><rect id="viewBox" x="0" y="0" width="24" height="24"/><polygon id="Shape" stroke="#FFE75E" stroke-width="2" fill="#FFE75E" stroke-linejoin="round" points="12 3 22 21 2 21"/><path d="M12,9 L12,15 M12,16 L12,18" id="!" stroke="#333333" stroke-width="2" stroke-linejoin="round"/></g></g></g></g></g></g></g></g></g></svg> ' + hpe.fn.lang('Form513', config.locale, config.localizations) + '</div>';
					   else if (d.Status == null || d.Status == "0") elem = '<div class="status" title="' + hpe.fn.lang('NoPOSubmitted', config.locale, config.localizations) + '">' + hpe.fn.lang('Form211', config.locale, config.localizations) + '</div>';
					   else elem = hpe.fn.lang('Unknown', config.locale, config.localizations);
					   return elem;
					 }
				   },
				   {
					 field: "EndCx_CompanyName",
					 title: hpe.fn.lang("FormEndCx", config.locale, config.localizations),
					 width: "200px",
			//		 hidden: true,
					 filterable: true,
					 template: function(d) {
					   if (d.EndCx_CompanyName) {
						 if (d.EndCx_CompanyName.length > 25)
						   return d.EndCx_CompanyName.substring(0, 25) + '...';
						 else
						   return d.EndCx_CompanyName;
					   } else {
						 return "N/A";
					   }
					 }
				   },
				  ];
		// add call to action

		all.push({
		  field: "AvailableActions",
		  title: " ",
		  width: 90,
		  filterable: false,
		  headerAttributes: {
			style: "text-align: right;"
		  },
		  template: function(d) {
			return oob.grid._process.action(d);
		  }
		});

		return all;
	  },
	  _events: {
		init: function(sel) {
		  this._icons(sel);
		},
		_icons: function(sel) {
		  var g = ".grid";
		  $(g).delegate(".view", "click", function(e) {
			var grid = $(g).data("kendoGrid");
			var row = grid.dataItem($(this).closest("tr"));
			mo.fn.overlay.show({
			  loading: true,
			  close: false
			});
			crud.read("3180", "eid=" + row.EntryId, function(d) {
			  mo.fn.overlay.hide();
			  oob.grid._events._view(d.Rows[0]);
			})
		  });
		  $(g).delegate(".edit", "click", function(e) {
			var grid = $(g).data("kendoGrid");
			var row = grid.dataItem($(this).closest("tr"));
			mo.fn.overlay.show({
			  loading: true,
			  close: false
			});
			crud.read("3180", "eid=" + row.EntryId, function(d) {
			  mo.fn.overlay.hide();
			  oob.grid._events._edit(d.Rows[0]);
			})
		  });
		  $(g).delegate(".deactivate", "click", function(e) {
			var grid = $(g).data("kendoGrid");
			var row = grid.dataItem($(this).closest("tr"));
			oob.grid._events._disable(row.EntryId);
		  });
		  $(g).delegate(".clone", "click", function(e) {
			var grid = $(g).data("kendoGrid");
			var row = grid.dataItem($(this).closest("tr"));
			mo.fn.overlay.show({
			  loading: true,
			  close: false
			});
			crud.read("3180", "eid=" + row.EntryId, function(d) {
			  mo.fn.overlay.hide();
			  oob.grid._events._clone(d.Rows[0]);
			})
		  });
		  $(g).delegate(".mailto", "click", function(e) {
			var grid = $(g).data("kendoGrid");
			var row = grid.dataItem($(this).closest("tr"));
			oob.grid._events._mailto(row.Requestor_Email);
		  });
		},
		_edit: function(data) {
		  config.dataset = data;
		  nbsf.init(config, 0);
		  nbsf.init(config, 0);
		  $('.tabs span[tab-id="oob"]').click();
		},
		_view: function(data) {
		  console.log('_view', data);
		  config.dataset = data;
		  nbsf.init(config, config.pages.length - 1);
		  nbsf.init(config, config.pages.length - 1);
		  $('.tabs span[tab-id="oob"]').click();
		},
		_disable: function(eid) {
		  //console.log('_disable', eid);
		  mo.fn.modal.show({
			title: hpe.fn.lang("Form511", config.locale, config.localizations),
			content: "<p>" + hpe.fn.lang("Form512", config.locale, config.localizations).replace('{0}', eid) + "</p>",
			ctaLabel: hpe.fn.lang("OK", config.locale, config.localizations),
			ctaCallback: function() {
			  var refapplication;
			  crud.read("3180", "eid=" + eid, function(data) {
				if (data.Rows.length > 0) {
				  if (data.Rows[0].Status == "0" || data.Rows[0].Status == null) {
					refapplication = data.Rows[0];
					refapplication.Retired = "Y";
					refapplication.Status = "5";
					mo.fn.overlay.show({
					  loading: true,
					  close: false
					});
					crud.update("3158", eid, refapplication, function(d) {
					  if (typeof(d.EntryId) === "number") {
						crud.c.i("Order record " + d.EntryId + " was successfully updated");
						crud.c.l(refapplication);
						elog('Record canceled in RFB');
					  }
					  oob.grid._overview();
					  $('[tab-id=requests] .grid').data('kendoGrid').dataSource.read();
					  mo.fn.overlay.hide();
					  mo.fn.events.closeAll();
					});
				  } else {
					$('[tab-id=requests] .grid').data('kendoGrid').dataSource.read();

					mo.fn.modal.show({
					  ctaLabel: hpe.fn.lang('OK', config.locale, config.localizations),
					  title: hpe.fn.lang("ErrorGeneric", config.locale, config.localizations),
					  content: '',
					  ctaCallback: function() {
						mo.fn.overlay.hide();
						mo.fn.events.closeAll();
					  }
					});
				  }
				}
			  });
			}

		  });
		},
		_clone: function(data) {
		  //console.log('_clone', data);
		  if (data.EndCx_SysMng_LastName == "NA") data.EndCx_SysMng_LastName = null;
		  if (data.EndCx_SysMng_Email == "NA@IGNOREME.COM") data.EndCx_SysMng_Email = null;

		  var parts = data["PO_DeliveryDate"].split("/");
		  var deliveryDateFormat =  new Date(parts[2], parts[1] - 1, parts[0]);
		  var today = new Date();

		  if(deliveryDateFormat < today){
			data["PO_DeliveryDate"] = null;
		  }
		  let clean = ["EntryId", "Created", "CreatedBy", "Modified", "ModifiedBy", "PO_Number", "PO_Attachment", "Optional_Attachment", "Submitted", "SubmittedTimestamp", "PO_Order_ID", "Operations", "CaseReason"];
		  for (i = 0; i < clean.length; i++)
			data[clean[i]] = null;

		  data.Status = 0;
		  data.Clone = true;
		  config.dataset = data;
		  nbsf.init(config, 0);
		  nbsf.init(config, 0);
		  $('.tabs span[tab-id="oob"]').click();
		},
		_mailto: function(Requestor_Email) {
		  console.log('_mailto', Requestor_Email);
		  window.location = "mailto:" + Requestor_Email + "";
		},
		_search: function() {
		  console.log('_search');
		  var search = document.querySelector(".search input");
		  var grid = $(".grid").data("kendoGrid");
		  var dataSource = grid.dataSource;
		  var defaultFilter = oob.grid._filter();
		  if (search.value.length == 0)
			dataSource.filter(defaultFilter);
		  else {
			defaultFilter.filters.push({
			  logic: "or",
			  filters: [{
				field: "EntryId",
				operator: "contains",
				value: search.value
			  },
						{
						  field: "Requestor_Email",
						  operator: "contains",
						  value: search.value
						},
						{
						  field: "PO_Number",
						  operator: "contains",
						  value: search.value
						},
						{
						  field: "PO_Order_ID",
						  operator: "contains",
						  value: search.value
						},
						{
						  field: "SuccessResult",
						  operator: "contains",
						  value: search.value
						},
						{
						  field: "SubmittedTimestamp",
						  operator: "contains",
						  value: search.value
						}
					   ]
			});
			dataSource.filter(defaultFilter);
		  }
		}
	  },
	  /*_filter: function() {
                  return {
                      logic: "and",
                      filters: [{
                              field: "CountryEntity",
                              operator: "eq",
                              value: global.data.company.country
                          }, 
                          {
                              field: "PartnerBRT",
                              operator: "eq",
                              value: global.data.brt.name
                          },
                          {
                              logic: "or",
                              filters: [{
                                      field: "Retired",
                                      operator: "neq",
                                      value: "Y"
                                  },
                                  {
                                      field: "Retired",
                                      operator: "isnull",
                                      value: ""
                                  }
                              ]
                          }
                      ]
                  }
              },*/
	  _filter: function(isCompany = false) {
		const filter = ('[SSOData.Email]'.indexOf('@hpe.com') > -1) ? {
		  logic: "and",
		  filters: [{
			field: "Email",
			operator: "eq",
			value: '[SSOData.Email]'
		  },
					{
					  logic: "or",
					  filters: [{
						field: "Retired",
						operator: "neq",
						value: "Y"
					  },
								{
								  field: "Retired",
								  operator: "isnull",
								  value: ""
								},
							   ]
					}
				   ]
		} : {
		  logic: "and",
		  filters: [
			{
			  logic: "and",
			  filters: [
				{
				  field: "PartyId",
				  operator: "eq",
				  value: global.data.company.party
				},
				{
				  field: "PartnerBRT",
				  operator: "eq",
				  value: global.data.brt.name
				},
			  ]
			},
			{
			  logic: "or",
			  filters: [{
				field: "Retired",
				operator: "neq",
				value: "Y"
			  },
						{
						  field: "Retired",
						  operator: "isnull",
						  value: ""
						}
					   ]
			}
		  ]
		};

		// rollback of NOR-460. Will be done in NOR-519
		/*	if (oob.grid._appStats.filterByOwnRequest) {
				  filter.filters.push({
                        field: "Email",
                        operator: "eq",
                        value: '[SSOData.Email]'
                    });
				}*/
		// add user/company filter
		
		const typeDropdown = $("#filter-type-dropdown");
		if ((!typeDropdown || typeDropdown.val() === "User") && !isCompany) {
		  filter.filters.push({
			field: "Requestor_Email",
			operator: "eq",
			value: '[SSOData.Email]'
		  });
		}

		if (oob.grid._appStats.status) {
		  filter.filters.push({
			field: "Status",
			operator: "eq",
			value: oob.grid._appStats.status,
		  }, {
			field: "Status",
			operator: "isnotnull",
			value: "",
		  });
		}
		return filter;
	  },
	  _refresh: function() {
		// refresh grid
		$('[tab-id=requests] .grid').data('kendoGrid').dataSource.read();
	  },
	  _process: {
		action: function(data) {
		  //mailto icon
		  var emailtitle = "";
		  if (data.EndCx_CompanyName != null) {
			if (data.EndCx_CompanyName != "")
			  emailtitle = hpe.fn.lang('Form141', config.locale, config.localizations) + ": " + data.EndCx_CompanyName + ", " + hpe.fn.lang('Email', config.locale, config.localizations) + ": " + data.Requestor_Email;
			else
			  emailtitle = hpe.fn.lang('Email', config.locale, config.localizations) + ": " + data.Requestor_Email;
		  } else
			emailtitle = hpe.fn.lang('Email', config.locale, config.localizations) + ": " + data.Requestor_Email;
		  var mailto = '<span title="' + emailtitle + '" style="margin-left: 15px; cursor: pointer" class="mailto" title="' + data.Requestor_Email + '"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="user" width="20px" height="20px"><path fill="none" stroke="#666" stroke-width="2" d="M8,24 L8,19 M16,24 L16,19 M3,24 L3,19 C3,14.0294373 7.02943725,11 12,11 C16.9705627,11 21,14.0294373 21,19 L21,24 M12,11 C14.7614237,11 17,8.76142375 17,6 C17,3.23857625 14.7614237,1 12,1 C9.23857625,1 7,3.23857625 7,6 C7,8.76142375 9.23857625,11 12,11 Z"></path></svg></span>';
		  // icon to use at status 0
		  var edit = '<span title="' + hpe.fn.lang('EditRequest', config.locale, config.localizations) + '" class="edit" style="margin-left: 15px; cursor: pointer"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="edit" width="20px" height="20px"><path fill="none" stroke="#666" stroke-width="2" d="M14,4 L20,10 L14,4 Z M22.2942268,5.29422684 C22.6840146,5.68401459 22.6812861,6.3187139 22.2864907,6.71350932 L9,20 L2,22 L4,15 L17.2864907,1.71350932 C17.680551,1.319449 18.3127724,1.31277239 18.7057732,1.70577316 L22.2942268,5.29422684 Z M3,19 L5,21 M7,17 L15,9"></path></svg></span>';
		  // icon to use to view record at the end of the process
		  var view = "<span title='" + hpe.fn.lang('ViewRequest', config.locale, config.localizations) + "' class='view' style='margin-left: 15px;cursor: pointer;'><svg style='pointer-events: none' version='1.1' viewBox='0 0 24 24' width='20px' height='20px' role='img' aria-label='edit'><path fill='none' stroke='#666' stroke-width='2' d='M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z'></path></svg></span>";
		  // icon to use to download at ?
		  var deactivate = '<span title="' + hpe.fn.lang('DeleteEntry', config.locale, config.localizations) + '" class="deactivate" style="margin-left: 15px; cursor: pointer;"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="trash" width="20px" height="20px"><path fill="none" stroke="#666" stroke-width="2" d="M4,5 L20,5 L20,23 L4,23 L4,5 Z M1,5 L23,5 M9,1 L15,1 L15,5 L9,5 L9,1 Z M9,1 L15,1 L15,5 L9,5 L9,1 Z M15,9 L15,19 M9,9 L9,19"></path></svg></span>';
		  var clone = '<span title="' + hpe.fn.lang('CloneRequest', config.locale, config.localizations) + '" class="clone" style="cursor: pointer;"><svg version="1.1" viewBox="0 0 24 24" width="20px" height="20px" role="img" aria-label="clone"><path fill="none" stroke="#666" stroke-width="2" d="M9,15 L17,15 L9,15 Z M9,11 L19,11 L9,11 Z M9,7 L13,7 L9,7 Z M16,1 L16,7 L22,7 M6,5 L2,5 L2,23 L18,23 L18,19 M22,19 L6,19 L6,1 L17,1 L22,6 L22,19 L22,19 Z"></path></svg></span>';
		  // tasks
		  var final = "";

		  var editView = '';

		  if (data.Status == 0 || data.Status == null) {
			editView = edit;
		  } else {
			editView = view;
			deactivate = '';
		  }

		  final = final + clone + editView + mailto + deactivate;

		  return "<div style='text-align: left'>" + final + "</div>";
		}
	  },
	  _overview: function() {
		// OVERVIEW
		var overview = document.querySelector("#overview");
		overview.innerHTML = '<div class="incomplete"><strong></strong><span>' + hpe.fn.lang('Form211', config.locale, config.localizations) + '</span><p>' + hpe.fn.lang('NoOrder', config.locale, config.localizations) + '</p></div>' +
		  '<div class="submitted" style="display:none"><strong></strong><span>' + hpe.fn.lang('Form213', config.locale, config.localizations) + '</span></div>' +
		  '<div class="pending"><strong></strong><span>' + hpe.fn.lang('Form212', config.locale, config.localizations) + '</span><p>' + hpe.fn.lang('SubmittedPOProcessed', config.locale, config.localizations) + '</p></div>' +
		  '<div class="completed"><strong></strong><span>' + hpe.fn.lang('Completed', config.locale, config.localizations) + '</span><p>' + hpe.fn.lang('OrderCreated', config.locale, config.localizations) + '</p></div>' +
		  '<div class="failed" style="display:none"><strong></strong><span>' + hpe.fn.lang('Form214', config.locale, config.localizations) + '</span></div>' +
		  '<div class="cancelled" style=""><strong></strong><span>' + hpe.fn.lang('Form513', config.locale, config.localizations) + '</span><p>' + hpe.fn.lang('OrderCancelledDescr', config.locale, config.localizations) + '</p></div>';

		const filterGrid = function(value) {
		  oob.grid._appStats.status = value;
		  const grid = $('div[tab-id="requests"] .grid').data("kendoGrid");
		  if (grid) {
			grid.dataSource.filter(oob.grid._filter());
		  }
		};

		oob.grid._initStats(function(d) {
		  global.requests = d;
		  // stats user
		  overview.querySelector(".incomplete strong").innerText = global.requests.userDraft;
		  overview.querySelector(".pending strong").innerText = global.requests.userInprogress;
		  overview.querySelector(".completed strong").innerText = global.requests.userCompleted;
		  overview.querySelector(".cancelled strong").innerText = global.requests.userCancelled;

		  document.querySelector('#overview .incomplete').onclick = function() {
			filterGrid("0");
		  };
		  document.querySelector('#overview .pending').onclick = function() {
			filterGrid("1");
		  };
		  document.querySelector('#overview .completed').onclick = function() {
			filterGrid("3");
		  };
		  document.querySelector('#overview .cancelled').onclick = function() {
			filterGrid("5");
		  };
		  mo.fn.overlay.hide();
		});
	  },
	  _appStats: {
		// delete
		incomplete: "",
		submitted: "",
		pending: "",
		completed: "",
		failed: "",
		deleted: "",
		status: "",
		
		userDraft: "",
		userInprogress: "",
		userCompleted: "",
		companyDraft: "",
		companyInprogress: "",
		companyCompleted: "",
	  },
	  _getStats: function(callback) {
		// Draft
		const draftOverview = function(resolve, reject, isCompany = false) {
		  const draftFilter = Object.assign({}, oob.grid._filter(isCompany));
		  draftFilter.filters.push({
			field: "Status",
			operator: "eq",
			value: 0
		  });
		  hpe.api.dataset({
			form: '989',
			dataset: 'NOR_Overview', // todo: add a new setting
			payload: {
			  pageSize: 3000,
			  filter: draftFilter,
			}
		  }, function(d) {
			try {
			  resolve(d.Total || 0);
			} catch (e) {
			  reject(e)
			}
		  });
		}
		const draftUserRequest = new Promise((resolve, reject) => {
		  draftOverview(resolve, reject);
		});
		const draftCompanyRequest = new Promise((resolve, reject) => {
		  draftOverview(resolve, reject, true);
		});
		// Completed
		const completedOverview  = function(resolve, reject, isCompany = false) {
		  const completedFilter = Object.assign({}, oob.grid._filter(isCompany));
		  completedFilter.filters.push({
			field: "Status",
			operator: "eq",
			value: 3
		  });
		  hpe.api.dataset({
			form: '989',
			dataset: 'NOR_Overview', // todo: add a new setting
			payload: {
			  pageSize: 3000,
			  filter: completedFilter,
			}
		  }, function(d) {
			try {
			  resolve(d.Total || 0);
			} catch (e) {
			  reject(e)
			}
		  });
		}
		const completedUserRequest = new Promise((resolve, reject) => {
		  completedOverview(resolve, reject);
		});
		const completedCompanyRequest = new Promise((resolve, reject) => {
		  completedOverview(resolve, reject, true);
		});
		// Inprogress
		const progressOverview  = function(resolve, reject, isCompany = false) {
		  const progressFilter = Object.assign({}, oob.grid._filter(isCompany));
		  progressFilter.filters.push({
			logic: "or",
			filters: [
			  {
				field: "Status",
				operator: "eq",
				value: 1 //submitted
			  },
			  {
				field: "Status",
				operator: "eq",
				value: 2 //pending
			  },
			  {
				field: "Status",
				operator: "eq",
				value: 4 //failed
			  }
			]
		  }
									 );
		  hpe.api.dataset({
			form: '989',
			dataset: 'NOR_Overview', // todo: add a new setting
			payload: {
			  pageSize: 3000,
			  filter: progressFilter,
			}
		  }, function(d) {
			try {
			  resolve(d.Total || 0);
			} catch (e) {
			  reject(e)
			}
		  });
		}
		const progressUserRequest = new Promise((resolve, reject) => {
		  progressOverview(resolve, reject);
		});
		const progressCompanyRequest = new Promise((resolve, reject) => {
		  progressOverview(resolve, reject, true);
		});
		// Cancelled
		const cancelledOverview  = function(resolve, reject, isCompany = false) {
		  const cancelledFilter = Object.assign({}, oob.grid._filter(isCompany));
		  cancelledFilter.filters.push({
			field: "Status",
			operator: "eq",
			value: 5
		  });
		  hpe.api.dataset({
			form: '989',
			dataset: 'NOR_Overview', // todo: add a new setting
			payload: {
			  pageSize: 3000,
			  filter: cancelledFilter,
			}
		  }, function(d) {
			try {
			  resolve(d.Total || 0);
			} catch (e) {
			  reject(e)
			}
		  });
		}
		const cancelledUserRequest = new Promise((resolve, reject) => {
		  cancelledOverview(resolve, reject);
		});
		const cancelledCompanyRequest = new Promise((resolve, reject) => {
		  cancelledOverview(resolve, reject, true);
		});
		Promise.all([draftUserRequest, draftCompanyRequest, completedUserRequest, completedCompanyRequest, progressUserRequest, progressCompanyRequest, cancelledUserRequest, cancelledCompanyRequest])
		  .then((values) => {
		  if (values && values.length) {
			const result = {
			  UserDraft: values[0],
			  CompanyDraft: values[1],
			  UserCompleted: values[2],
			  CompanyCompleted: values[3],
			  UserInprogress: values[4],
			  CompanyInprogress: values[5],
				UserCancelled: values[6],
			  CompanyCancelled: values[7],
			};
			callback(result);
		  } else {
			callback(false);
		  }
		})
		  .catch(function(err) {
		  console.log(err.message);
		  callback(false);
		});
	  },
	  _initStats: function(cb) {
		oob.grid._getStats(function(d) {
		  if (d) {
			oob.grid._appStats.userDraft = d.UserDraft;
			oob.grid._appStats.userInprogress = d.UserInprogress;
			oob.grid._appStats.userCompleted = d.UserCompleted;
			oob.grid._appStats.userCancelled = d.UserCancelled;
			oob.grid._appStats.companyDraft = d.CompanyDraft;
			oob.grid._appStats.companyInprogress = d.CompanyInprogress;
			oob.grid._appStats.companyCompleted = d.CompanyCompleted;
			oob.grid._appStats.companyCancelled = d.CompanyCancelled;
			
		  } else {
			oob.grid._appStats.userDraft = 0;
			oob.grid._appStats.userInprogress = 0;
			oob.grid._appStats.userCompleted = 0;
			oob.grid._appStats.userCancelled = 0;
			oob.grid._appStats.companyDraft = 0;
			oob.grid._appStats.companyInprogress = 0;
			oob.grid._appStats.companyCompleted = 0;
			oob.grid._appStats.companyCancelled = 0;
		  }
		  return cb(oob.grid._appStats);
		});
	  }
	}
  }
</script>

<script>
  const pdfDateRenderer = function(val) {
	if (!val || typeof(val) !== "string" || val.length < 10) return val;
	return val.substring(8, 10) + "/" + val.substring(5, 7) + "/" + val.substring(0, 4);
  }

  const pdfYesNoRenderer = function(val) {
	if (val == "Y") return "Yes";
	if (val == "N") return "No";
	return val || "";
  }

  const PDF = {
	l10nDebug: false, // set to TRUE to get template with localization keys. Development only.
	l10n: function(l10nKey) {
	  if (PDF.l10nDebug) return "[" + l10nKey + "]";
	  return hpe.fn.lang(l10nKey, config.locale, config.localizations) || l10nKey;
	},

	defaultCellRenderer: function(item) {
	  const hasData = !!item.items.filter((itemDescr) => {
		const val = config.dataset[itemDescr.key];
		return val !== "" && val !== null && val !== undefined;
	  }).length;

	  if (!hasData & !PDF.l10nDebug) return null;

	  const labelWidth = item.labelWidth == "auto" ? "" : " width='" + (item.labelWidth || "45%") + "'";
	  const valueWidth = item.valueWidth == "auto" ? "" : " width='" + (item.valueWidth || "55%") + "'";

	  let cell = item.items.filter((itemDescr) => {
		if (PDF.l10nDebug) return true;
		const val = config.dataset[itemDescr.key];
		return val !== "" && val !== null && val !== undefined;
	  }).map((itemDescr) => {
		let val = config.dataset[itemDescr.key];
		if (itemDescr.renderer) val = itemDescr.renderer(val);
		return "<tr><td" + labelWidth + " style='font-weight:bold;padding:4px;'>" + PDF.l10n(itemDescr.label) + "</td>" +
		  "<td" + valueWidth + " style='padding:4px;'>" + val + "</td></tr>"
	  });

	  const content = (item.row ? "<br>" : "") + "<table" + (item.row ? " width='100%'" : "") + ">" +
			"<tr><th colspan='2' style='padding:4px;background-color:#415463;color:#ffffff;'>" + PDF.l10n(item.header) + "</th></tr>" + 
			cell.join("\n") + "</table>";

	  return {
		newline: item.newline,
		row: item.row,
		content: content
	  }
	},

	structure: [
	  {
		header: "Purchase Order Information",
		items: [
		  {label: "Purchase order number:", key: "PO_Number"},
		  {label: "Submission Date:", key: "SubmittedTimestamp", renderer: pdfDateRenderer},
		  {label: "Purchase order category:", key: "PO_Category"},
		  {label: "Purchase order amount:", key: "PO_Value"},
		  {label: "Purchase order currency:", key: "PO_Currency"},
		  {label: "Reseller purchase order number:", key: "Rs_PO_Number"},
		  {label: "End customer purchase order number:", key: "Cx_PO_Number"},
		]
	  },
	  {
		header: "Submitter Information", // Submitter
		items: [
		  {label: "Company:", key: "PartnerName"},
		  {label: "First Name:", key: "FirstName"},
		  {label: "Last Name:", key: "LastName"},
		  {label: "Email:", key: "Email"},
		  {label: "Country:", key: "Country"},
		]
	  },
	  {
		header: "Quote details", // Form075
		items: [
		  {label: "Quote number:", key: "Requestor_PO_Quote_ID"},
		  {label: "Deal number:", key: "Requestor_PO_Deal_ID"},
		  {label: "Opportunity ID:", key: "Requestor_PO_Opp_ID"},
		  {label: "Purchase agreement number:", key: "PA_Number"},
		  {label: "HPE approved payment terms:", key: "Payment_Terms"},
		]
	  },
	  {
		header: "Delivery Information", // Form472
		items: [
		  {label: "Requested Delivery date:", key: "PO_DeliveryDate"},
		  {label: "Delivery Incoterms:", key: "PO_DeliveryIncoterms"},
		  {label: "Complete Delivery:", key: "PO_CompleteDelivery", renderer: pdfYesNoRenderer},
		  {label: "Business Model:", key: "PO_BusinessModel"},
		]
	  },
	  {
		header: "Sold to Information", // Form054
		items: [
		  {label: "Party ID:", key: "SoldTo_PartyId"},
		  {label: "Company name:", key: "SoldTo_CompanyName"},
		  {label: "Address 1:", key: "SoldTo_Address_Street"},
		  {label: "Address 2:", key: "SoldTo_Address_Street2"},
		  {label: "ZIP / Postal Code:", key: "SoldTo_Address_Postal"},
		  {label: "City:", key: "SoldTo_Address_City"},
		  {label: "State / Province:", key: "SoldTo_Address_State"},
		  {label: "Country:", key: "SoldTo_Address_Country"},
		  {label: "Tax ID:", key: "SoldTo_NationalId"},
		  {label: "First Name:", key: "SoldTo_Contact_FirstName"},
		  {label: "Last Name:", key: "SoldTo_Contact_LastName"},
		  {label: "Phone:", key: "SoldTo_Contact_Phone"},
		  {label: "Email:", key: "SoldTo_Contact_Email"},
		  {label: "Country of residence:", key: "SoldTo_Contact_Country"},
		]
	  },
	  {
		header: "Payer Information", // Form068
		items: [
		  {label: "Party ID:", key: "Payer_PartyId"},
		  {label: "Company name:", key: "Payer_CompanyName"},
		  {label: "Address 1:", key: "Payer_Address_Street"},
		  {label: "Address 2:", key: "Payer_Address_Street2"},
		  {label: "ZIP / Postal Code:", key: "Payer_Address_Postal"},
		  {label: "City:", key: "Payer_Address_City"},
		  {label: "State / Province:", key: "Payer_Address_State"},
		  {label: "Country:", key: "Payer_Address_Country"},
		  {label: "Tax ID:", key: "Payer_NationalId"},
		  {label: "First Name:", key: "Payer_Contact_FirstName"},
		  {label: "Last Name:", key: "Payer_Contact_LastName"},
		  {label: "Phone:", key: "Payer_Contact_Phone"},
		  {label: "Email:", key: "Payer_Contact_Email"},
		  {label: "Country of residence:", key: "Payer_Contact_Country"},
		]
	  },
	  {
		header: "Bill to Information", // Form101
		items: [
		  {label: "Party ID:", key: "BillTo_PartyId"},
		  {label: "Company name:", key: "BillTo_CompanyName"},
		  {label: "Address 1:", key: "BillTo_Address_Street"},
		  {label: "Address 2:", key: "BillTo_Address_Street2"},
		  {label: "ZIP / Postal Code:", key: "BillTo_Address_Postal"},
		  {label: "City:", key: "BillTo_Address_City"},
		  {label: "State / Province:", key: "BillTo_Address_State"},
		  {label: "Country:", key: "BillTo_Address_Country"},
		  {label: "Tax ID:", key: "BillTo_NationalId"},
		  {label: "First Name:", key: "BillTo_Contact_FirstName"},
		  {label: "Last Name:", key: "BillTo_Contact_LastName"},
		  {label: "Phone:", key: "BillTo_Contact_Phone"},
		  {label: "Email:", key: "BillTo_Contact_Email"},
		  {label: "Country of residence:", key: "BillTo_Contact_Country"},
		]
	  },
	  {
		header: "Shipping Information", // Form045
		items: [
		  {label: "Party ID:", key: "ShipTo_PartyId"},
		  {label: "Company name:", key: "ShipTo_CompanyName"},
		  {label: "Address 1:", key: "ShipTo_Address_Street"},
		  {label: "Address 2:", key: "ShipTo_Address_Street2"},
		  {label: "ZIP / Postal Code:", key: "ShipTo_Address_Postal"},
		  {label: "City:", key: "ShipTo_Address_City"},
		  {label: "State / Province:", key: "ShipTo_Address_State"},
		  {label: "Country:", key: "ShipTo_Address_Country"},
		  {label: "Tax ID:", key: "ShipTo_NationalId"},
		  {label: "First Name:", key: "ShipTo_Contact_FirstName"},
		  {label: "Last Name:", key: "ShipTo_Contact_LastName"},
		  {label: "Phone:", key: "ShipTo_Contact_Phone"},
		  {label: "Email:", key: "ShipTo_Contact_Email"},
		  {label: "Country of residence:", key: "ShipTo_Contact_Country"},
		]
	  },
	  {
		header: "End customer Information", // Form138
		items: [
		  {label: "Party ID:", key: "EndCx_PartyId"},
		  {label: "Company name:", key: "EndCx_CompanyName"},
		  {label: "Address 1:", key: "EndCx_Address_Street"},
		  {label: "Address 2:", key: "EndCx_Address_Street2"},
		  {label: "ZIP / Postal Code:", key: "EndCx_Address_Postal"},
		  {label: "City:", key: "EndCx_Address_City"},
		  {label: "State / Province:", key: "EndCx_Address_State"},
		  {label: "Country:", key: "EndCx_Address_Country"},
		  {label: "Tax ID:", key: "EndCx_NationalId"},
		  {label: "First Name:", key: "EndCx_Contact_FirstName"},
		  {label: "Last Name:", key: "EndCx_Contact_LastName"},
		  {label: "Phone:", key: "EndCx_Contact_Phone"},
		  {label: "Email:", key: "EndCx_Contact_Email"},
		  {label: "Country of residence:", key: "EndCx_Contact_Country"},
		]
	  },
	  {
		header: "Reseller Information", // Form126
		items: [
		  {label: "Party ID:", key: "Reseller_PartyId"},
		  {label: "Company name:", key: "Reseller_CompanyName"},
		  {label: "Address 1:", key: "Reseller_Address_Street"},
		  {label: "Address 2:", key: "Reseller_Address_Street2"},
		  {label: "ZIP / Postal Code:", key: "Reseller_Address_Postal"},
		  {label: "City:", key: "Reseller_Address_City"},
		  {label: "State / Province:", key: "Reseller_Address_State"},
		  {label: "Country:", key: "Reseller_Address_Country"},
		  {label: "Tax ID:", key: "Reseller_NationalId"},
		  {label: "First Name:", key: "Reseller_Contact_FirstName"},
		  {label: "Last Name:", key: "Reseller_Contact_LastName"},
		  {label: "Phone:", key: "Reseller_Contact_Phone"},
		  {label: "Email:", key: "Reseller_Contact_Email"},
		  {label: "Country of residence:", key: "Reseller_Contact_Country"},
		]
	  },
	  {
		header: "Custom Ship To Party Information", // Form486
		items: [
		  {label: "Party ID:", key: "CustomShipTo_PartyId"},
		  {label: "Company name:", key: "CustomShipTo_CompanyName"},
		  {label: "Address 1:", key: "CustomShipTo_Address"},
		  {label: "Address 2:", key: "CustomShipTo_Address_Street2"},
		  {label: "ZIP / Postal Code:", key: "CustomShipTo_Address_Postal"},
		  {label: "City:", key: "CustomShipTo_Address_City"},
		  {label: "State / Province:", key: "CustomShipTo_Address_State"},
		  {label: "Country:", key: "CustomShipTo_Address_Country"},
		]
	  },
	  { // Products and Services
		renderer: function() {
		  if (!config.dataset.Config_Quote_PartialOrder) return null;
		  let PSData = null;

		  try {
			PSData = JSON.parse(config.dataset.Config_Quote_PartialOrder).filter(item => item.Selected == "Y");
		  } catch(e) {}

		  if (!PSData || !PSData.length) return null;

		  const colVisible = PSData.reduce((acc, item) => {
			acc.pppd = acc.pppd || !!item.PreviouslyPurchasedProductDetails;
			acc.snp = acc.snp || !!item.SerialNumberOfProducts;
			acc.ppd = acc.ppd || !!item.ProductPurchasedDate;
			return acc;
		  }, {});

		  const poCurrency = config.dataset.PO_Currency;

		  const header = "<table><tr><th style='padding: 6px;' width='6%'>Item</td>" +
				"<th style='padding: 6px;' width='26%'>" + PDF.l10n("FormHPN") + "</th>" +
				"<th style='padding: 6px;' width='7%'>Qty</th>" +
				"<th style='padding: 6px;' width='15%'>" + PDF.l10n("FormBIID") + "</th>" +
				"<th style='padding: 6px;' width='15%'>" + PDF.l10n("FormDealId") + "</th>" +
				"<th style='padding: 6px;' width='15%'>" + PDF.l10n("FormUP") + " (" + poCurrency + ")</th>" +
				"<th style='padding: 6px;' width='15%'>" + PDF.l10n("FormENP") + " (" + poCurrency + ")</th>" +
				"</tr>";

		  const result = PSData.map((item, index) => {
			let extra = "";
			if (item.PreviouslyPurchasedProductDetails || item.SerialNumberOfProducts || item.ProductPurchasedDate) {
			  if (item.PreviouslyPurchasedProductDetails) {
				extra += "<tr><td></td><td colspan=6 style='padding-left:6px;padding-bottom:3px;'><b>" + PDF.l10n("FormPPPD") + "</b><br>" + (item.PreviouslyPurchasedProductDetails || "") + "</td></tr>";
			  }
			  if (item.SerialNumberOfProducts) {
				extra += "<tr><td></td><td colspan=6 style='padding-left:6px;padding-bottom:3px;'><b>" + PDF.l10n("FormSNP") + "</b><br>" + (item.SerialNumberOfProducts || "") + "</td></tr>";
			  }
			  if (item.ProductPurchasedDate) {
				extra += "<tr><td></td><td colspan=6 style='padding-left:6px;padding-bottom:3px;'><b>" + PDF.l10n("FormPPD") + "</b><br>" + (item.ProductPurchasedDate || "") + "</td></tr>";
			  }
/*
			  if (item.PreviouslyPurchasedProductDetails) {
				extra += "<tr><td></td><td colspan=6 style='padding-left:6px;padding-bottom:3px;'>" + (item.PreviouslyPurchasedProductDetails || "") + "</td></tr>";
			  }
			  if (item.SerialNumberOfProducts) {
				extra += "<tr><td></td><td colspan=6 style='padding-left:6px;padding-bottom:3px;'>" + (item.SerialNumberOfProducts || "") + "</td></tr>";
			  }
			  if (item.ProductPurchasedDate) {
				extra += "<tr><td></td><td colspan=6 style='padding-left:6px;padding-bottom:3px;'>" + (item.ProductPurchasedDate || "") + "</td></tr>";
			  }
*/
/*
			  extra = "<tr><td colspan='6' cellpadding='0'><table>" +
				(item.PreviouslyPurchasedProductDetails ? "<tr><td style='font-weight:bold;padding-right:6px;padding-left:6px;padding-bottom:3px;'>" + PDF.l10n("FormPPPD") + "</td><td>" + (item.PreviouslyPurchasedProductDetails || "") + "</td></tr>" : "") +
				(item.SerialNumberOfProducts ? "<tr><td style='font-weight:bold;padding-right:6px;padding-left:6px;padding-bottom:3px;'>" + PDF.l10n("FormSNP") + "</td><td>" + (item.SerialNumberOfProducts || "") + "</td></tr>" : "") +
				(item.ProductPurchasedDate ? "<tr><td style='font-weight:bold;padding-right:6px;padding-left:6px;padding-bottom:3px;'>" + PDF.l10n("FormPPD") + "</td><td>" + (item.ProductPurchasedDate || "") + "</td></tr>" : "") +
				"</table><td></tr>";
*/
			  /*
			  if (item.PreviouslyPurchasedProductDetails) {
				extra += "<tr><td colspan=3 style='font-weight:bold;padding-left:6px;padding-bottom:3px;text-align:right;'>" + PDF.l10n("FormPPPD") + "</td>" +
				  "<td colspan='4' style='padding-left:6px;padding-bottom:3px;'>" + (item.PreviouslyPurchasedProductDetails || "") + "</td></tr>";
			  }
			  if (item.SerialNumberOfProducts) {
				extra += "<tr><td colspan=3 style='font-weight:bold;padding-left:6px;padding-bottom:3px;text-align:right;'>" + PDF.l10n("FormSNP") + "</td>" +
				  "<td colspan='4' style='padding-left:6px;padding-bottom:3px;'>" + (item.SerialNumberOfProducts || "") + "</td></tr>";
			  }
			  if (item.ProductPurchasedDate) {
				extra += "<tr><td colspan=3 style='font-weight:bold;padding-left:6px;padding-bottom:3px;text-align:right;'>" + PDF.l10n("FormPPD") + "</td>" +
				  "<td colspan='4' style='padding-left:6px;padding-bottom:3px;'>" + (item.ProductPurchasedDate || "") + "</td></tr>";
			  }
*/
/*
			  if (item.PreviouslyPurchasedProductDetails) {
				extra += "<tr><td></td><td style='font-weight:bold;padding-left:6px;padding-bottom:3px;'>" + PDF.l10n("FormPPPD") + "</td>" +
				  "<td style='padding-left:6px;padding-bottom:3px;'>" + (item.PreviouslyPurchasedProductDetails || "") + "</td><td colspan='4'></td></tr>";
			  }
			  if (item.SerialNumberOfProducts) {
				extra += "<tr><td></td><td style='font-weight:bold;padding-left:6px;padding-bottom:3px;'>" + PDF.l10n("FormSNP") + "</td>" +
				  "<td style='padding-left:6px;padding-bottom:3px;'>" + (item.SerialNumberOfProducts || "") + "</td><td colspan='4'></td></tr>";
			  }
			  if (item.ProductPurchasedDate) {
				extra += "<tr><td></td><td style='font-weight:bold;padding-left:6px;padding-bottom:3px;'>" + PDF.l10n("FormPPD") + "</td>" +
				  "<td style='padding-left:6px;padding-bottom:3px;'>" + (item.ProductPurchasedDate || "") + "</td><td colspan='4'></td></tr>";
			  }
*/
			}
			// const configId = [item.ProductID == item.CfgSystemId ? null : item.ProductID, item.UCID, item.CfgSystemId].filter(i => !!i).join(" / ");
			const configId = [item.ProductID, item.UCID, item.CfgSystemId].filter(i => !!i).join(" / ");
			return `<tr><td style='padding: 6px;padding-bottom:3px;'>${index + 1}</td>
<td style='padding: 6px;padding-bottom:3px;'>${configId}</td>
<td style='padding: 6px;padding-bottom:3px;'>${item.Count}</td>
<td style='padding: 6px;padding-bottom:3px;'>${item.BundleID || ''}</td>
<td style='padding: 6px;padding-bottom:3px;'>${item.DealId || ''}</td>
<td style='padding: 6px;padding-bottom:3px;'>${item.UnitNetAmount}</td>
<td style='padding: 6px;padding-bottom:3px;'>${item.ExtendedNetAmount}</td></tr>${extra}`;
		  }).join("\n");

		  return {
			newline: true,
			row: true,
			content: header + result + "</table>"
		  }
		}
	  },
	  {
		header: "Asset location Information", // Form519
		items: [
		  {label: "Party ID:", key: "AssLoc_PartyId"},
		  {label: "Company name:", key: "AssLoc_CompanyName"},
		  {label: "Address 1:", key: "AssLoc_Address_Street"},
		  {label: "Address 2:", key: "AssLoc_Address_Street2"},
		  {label: "ZIP / Postal Code:", key: "AssLoc_Address_Postal"},
		  {label: "City:", key: "AssLoc_Address_City"},
		  {label: "State / Province:", key: "AssLoc_Address_State"},
		  {label: "Country:", key: "AssLoc_Address_Country"},
		]
	  },
	  {
		header: "Preferred Service Provider Information", // Form529
		items: [
		  {label: "Party ID:", key: "PSP_PartyId"},
		  {label: "Company name:", key: "PSP_CompanyName"},
		  {label: "Address 1:", key: "PSP_Address_Street"},
		  {label: "Address 2:", key: "PSP_Address_Street2"},
		  {label: "ZIP / Postal Code:", key: "PSP_Address_Postal"},
		  {label: "City:", key: "PSP_Address_City"},
		  {label: "State / Province:", key: "PSP_Address_State"},
		  {label: "Country:", key: "PSP_Address_Country"},
		]
	  },
	  {
		header: "Entitled party Information", // Form520
		items: [
		  {label: "Party ID:", key: "EntPrty_PartyId"},
		  {label: "Company name:", key: "EntPrty_CompanyName"},
		  {label: "Address 1:", key: "EntPrty_Address_Street"},
		  {label: "Address 2:", key: "EntPrty_Address_Street2"},
		  {label: "ZIP / Postal Code:", key: "EntPrty_Address_Postal"},
		  {label: "City:", key: "EntPrty_Address_City"},
		  {label: "State / Province:", key: "EntPrty_Address_State"},
		  {label: "Country:", key: "EntPrty_Address_Country"},
		  {label: "First Name:", key: "EntPrty_Contact_FirstName"},
		  {label: "Last Name:", key: "EntPrty_Contact_LastName"},
		  {label: "Phone:", key: "EntPrty_Contact_Phone"},
		  {label: "Email:", key: "EntPrty_Contact_Email"},
		]
	  },
	  {
		header: "Comments", // Form186
		items: [
		  {label:"Tax details (and any exemptions)", labelKey: "Form189", key: "Comment_Tax"},
		  {label:"Invoice comments", labelKey: "Form191", key: "Comment_Invoice"},
		  {label: "Delivery comments", labelKey: "Form193", key: "Comment_Delivery"},
		  {label: "Packing list comments", labelKey: "Form195", key: "Comment_Packing"},
		  {label: "Additional comments", labelKey: "Form197", key: "Comment_Extra"},
		]
	  },
	  {
		header: "Additional information", // Form152
		items: [
		  {label: "Select file", key: "Optional_Attachment"},
		  {label: "Are you ordering support / Installation services or Software licenses?", key: "Config_PI", renderer: pdfYesNoRenderer},
		  {label: "Do you have a system manager contact apart from the provided end customer contact?", key: "Config_SystemManager", renderer: pdfYesNoRenderer},
		  {label: "First name", key: "EndCx_SysMng_FirstName"},
		  {label: "Last name", key: "EndCx_SysMng_LastName"},
		  {label: "Phone", key: "EndCx_SysMng_Phone"},
		  {label: "Email", key: "EndCx_SysMng_Email"},
		  {label: "Country of residence", key: "EndCx_SysMng_Country"},
		  {label: "Reservation ID", key: "Config_ResId"},
		  {label: "Label order ID (LOID)", key: "Config_LOID"},
		  {label: "Non-chargeable special logistics services", key: "Config_LogCode"},
		  {label: "Do you belong to Public sector entity?", key: "Config_PublicSectionPartner", renderer: pdfYesNoRenderer},
		  {label: "CIG", key: "Config_CIG"},
		  {label: "CUP", key: "Config_CUP"},
		  {label: "Is the asset location address the same as the end customer address?", key: "Config_LocationDetails", renderer: pdfYesNoRenderer},
		  {label: "Is the entitled party information the same as the end customer information?", key: "Config_EntitledDetails", renderer: pdfYesNoRenderer},
		  {label: "Do you have a Preferred Service Provider (PSP)", key: "Config_PSP", renderer: pdfYesNoRenderer},
		  {label: "Do you have an acknowledgement Letter information?", key: "Config_ALI", renderer: pdfYesNoRenderer},
		  {label: "Are you ordering a combined order with other departments (PointNext/CMS/Parts Sales)?", key: "Config_CombinedOrder", renderer: pdfYesNoRenderer},
		  {label: "Which team is in charge of other product", key: "CombinedOrder_Team"},
		  {label: "The total value of other product", key: "CombinedOrder_Total"},
		  {label: "Combined Share point ID", key: "CombinedOrder_SharePointID"},
		  {label: "The owner of combined order", key: "CombinedOrder_Owner"},
		],
		newline: true,
		row: true,
		labelWidth: "auto",
		valueWidth: "auto"
	  },
	],

	recreatePdf: function(norId) {
	  crud.read("3180", "eid=" + norId, function(d) {
		console.log("Record loaded: " + norId);
		config.dataset = d.Rows[0];
		if (!config.dataset.EntryId) throw "No Entry Id in the record";
		PDF.createPdf();
		crud.update(3163, norId, config.dataset, function(data) {
		  console.log("Record saved: " + norId);
		  config.dataset = {};
		});
	  })
	},

	createPdf: function() {
	  let cells = PDF.structure.map((item) => {
		const cellfunc = item.renderer || PDF.defaultCellRenderer;
		return cellfunc(item);
	  }).filter(cell => !!cell);

	  let tableCells = cells.reduce((acc, cell, ndx, arr) => {
		let row = acc[acc.length - 1];
		if (row.length >= 2 || (ndx && arr[ndx-1].row)) {
		  row = [];
		  acc.push(row);
		}

		if (cell.newline && row.length == 1) {
		  row.push(null);
		  row = [];
		  acc.push(row);
		}

		row.push(cell);
		return acc;
	  }, [[]]).map((row) => {
		if (row.length == 1 && row[0].row) {
		  return "<br>" + row[0].content;
		}
		return "<table style='width:100%;'>" +
		  "<tr><td style='vertical-align: top;padding-top:10px;' width='50%'>" + row[0].content + "</td><td  style='width:10px;'>" +
		  "<td style='vertical-align: top;padding-top:10px;' width='50%'>" + (row[1] ? row[1].content : "") + "</td></tr></table>";
	  });
	  //config.dataset.PdfContent = "<h1 style='margin-top:10px;'>" + PDF.l10n("Form005") + " - <span>[PO_Number]</span></h1>" +  // Form005 = 'Purchase order number'
	  config.dataset.PdfContent = "<h1 style='margin-top:10px;'>Purchase Order - <span>[PO_Number]</span></h1>" +  // Form005 = 'Purchase order number'
		"<div style='font-weight:bold;'>THIS IS A COPY OF YOUR ELECTRONIC PURCHASE ORDER SUBMITTED WITH HPE</div>" +
		tableCells.join("\n") +
		"<br><p style='font-size:7pt'><i>The information provided above will be used for order creation and invoicing purpose.<br>Hewlett Packard Enterprise Confidential</i></p><br>" +
		"<table style='width: 100%;'><tr>" +
		"<td style='width:30%;vertical-align:bottom;'>" +
		"    <img src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFYAAAAZCAYAAACrWNlOAAAABlBMVEUAAAABqYLY1jZUAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAb0lEQVRoge3ZsQ3CQBAAQQ7Ro7txQDeu8mnAodcINBNedFpd8NLPHO/14HLPby/wr4SNCBsRNvI6G65tn7sX+WVnDwAXGxE2ImxE2IiwEWEjwkaEjQgbETYibETYiLARYSPjz6vhYiPCRoSNCBv5ACJhCIlJVOXyAAAAAElFTkSuQmCC'></td>" +
		"<td style='width:70%;border-top:3px solid black;font-size:7pt;'>"+
		"    <p>This is HPE Confidential and Proprietary Information. Do not share.</p>"+
		"    <p>Hewlett Packard Enterprise uses automatic data collection tools to personalize your experience. For more information regarding Hewlett Packard Enterprise's privacy policies and practices, please visit our"+
		"	    <a href='https://www.hpe.com/us/en/legal/privacy.html'>Privacy Statement</a> or <a href='https://www.hpe.com/us/en/about/legal/terms-of-use.html'>Terms of Use.</a> </p>" +
		"    <p>©Copyright 2024 Hewlett Packard Enterprise Development LP. The information contained herein is subject to change without notice.</p>" +
		"</td></tr></table>";
	}
  }

  config.init();
</script>

<!-- NOR application initialization -->
<script>
  //we call the functions from app object to initiate the landing page.
  //adding the crud dependency in the DOM
  hpe.supplies.crud();
  //adding the mo.js dependency in the DOM
  hpe.supplies.mojs();
  //hpe.supplies.profile();
  //function that is called after all dependencies were loaded
  hpe.supplies.q.end(function() {
	// temporary fix for rendering issue
	// remove after AR country code is not accounted for as Arabic
	//document.querySelector('body').classList = '';

	mo.init();
	mo.fn.overlay.show({
	  loading: true,
	  close: false
	});
	// load application
	crud.q.stop(function() {
	  if (!global.data.user.internal) {
		const myInterval = setInterval(myTimer, 1000);

		function myTimer() {
		  if (global.ready) {
			oob.init();
			myStopFunction()
		  }
		}

		function myStopFunction() {
		  clearInterval(myInterval);
		}
	  } else oob.init();
	})
  });
  hpe.fn.resizeable();
</script>